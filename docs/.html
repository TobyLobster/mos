<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Booklet Title</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>
		<nav role="navigation">
		
		</nav>
		<main role="main">
		
<!--Weave of '' generated by 7-->
<p class="inwebparagraph">Chapter 0
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 0: </span><span class="identifier">Introduction</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Constants</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; </span><span class="identifier">Introduction</span>
    <span class="plain">; ------------</span>
    <span class="plain">; </span><span class="identifier">An</span><span class="plain"> </span><span class="identifier">operating</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">initialises</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">keeps</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">computer</span><span class="plain"> </span><span class="identifier">running</span><span class="plain"> </span><span class="identifier">properly</span><span class="plain"> (</span><span class="identifier">including</span>
    <span class="plain">; </span><span class="identifier">servicing</span><span class="plain"> </span><span class="identifier">requests</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">timely</span><span class="plain"> </span><span class="identifier">manner</span><span class="plain">). </span><span class="identifier">An</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">also</span><span class="plain"> </span><span class="identifier">provides</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">of</span>
    <span class="plain">; </span><span class="identifier">standard</span><span class="plain"> </span><span class="identifier">useful</span><span class="plain"> </span><span class="identifier">functionality</span><span class="plain"> </span><span class="identifier">available</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">programs</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> 6502 </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">directly</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 64</span><span class="identifier">k</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain">, </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">broadly</span><span class="plain"> </span><span class="identifier">assigned</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">follows</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">; $0000-$7</span><span class="identifier">FFF</span><span class="plain"> = </span><span class="identifier">RAM</span><span class="plain">                                 (32</span><span class="identifier">k</span><span class="plain">)  (</span><span class="identifier">or</span><span class="plain"> $0000-$3</span><span class="identifier">FFF</span><span class="plain"> = </span><span class="identifier">RAM</span><span class="plain"> (16</span><span class="identifier">k</span><span class="plain">) </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">Model</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">computer</span><span class="plain">)</span>
    <span class="plain">; $8000-$</span><span class="identifier">BFFF</span><span class="plain"> = </span><span class="identifier">BASIC</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> (</span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">other</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">)   (16</span><span class="identifier">k</span><span class="plain">)</span>
    <span class="plain">; $</span><span class="identifier">C000</span><span class="plain">-$</span><span class="identifier">FFFF</span><span class="plain"> = </span><span class="identifier">Operating</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">                (16</span><span class="identifier">k</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Memory</span><span class="plain"> </span><span class="identifier">Mapped</span><span class="plain"> </span><span class="identifier">IO</span><span class="plain"> ($</span><span class="identifier">FC00</span><span class="plain">-$</span><span class="identifier">FEFF</span><span class="plain">)</span>
    <span class="plain">; ------------------------------</span>
    <span class="plain">; </span><span class="identifier">Addresses</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> $</span><span class="identifier">FC00</span><span class="plain">-$</span><span class="identifier">FEFF</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">mapped</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> (</span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">might</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">expected</span><span class="plain">),</span>
    <span class="plain">; </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">level</span><span class="plain"> </span><span class="identifier">connected</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">devices</span><span class="plain">. </span><span class="identifier">Consequently</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">CPU</span><span class="plain"> </span><span class="identifier">can</span>
    <span class="plain">; </span><span class="identifier">communicate</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">devices</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">reading</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">specific</span><span class="plain"> </span><span class="identifier">addresses</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">this</span>
    <span class="plain">; </span><span class="identifier">range</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; $</span><span class="identifier">FC00</span><span class="plain">-$</span><span class="identifier">FCFF</span><span class="plain">   - </span><span class="identifier">FRED</span><span class="plain">      - </span><span class="identifier">Addresses</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">assigned</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">external</span><span class="plain"> </span><span class="identifier">devices</span><span class="plain">:</span>
    <span class="plain">;                             </span><span class="identifier">Teletext</span><span class="plain"> / </span><span class="identifier">Prestel</span><span class="plain"> / </span><span class="identifier">IEEE488</span><span class="plain"> / </span><span class="identifier">Winchester</span><span class="plain"> </span><span class="identifier">Disc</span><span class="plain"> </span><span class="identifier">etc</span>
    <span class="plain">; $</span><span class="identifier">FD00</span><span class="plain">-$</span><span class="identifier">FDFF</span><span class="plain">   - </span><span class="identifier">JIM</span><span class="plain">       - </span><span class="identifier">Access</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> (</span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">page</span><span class="plain"> </span><span class="identifier">of</span><span class="plain">) </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">optional</span><span class="plain"> 64</span><span class="identifier">K</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain">.</span>
    <span class="plain">;                             </span><span class="identifier">Select</span><span class="plain"> </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">page</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">access</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $</span><span class="identifier">FCFF</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">the</span>
    <span class="plain">;                             </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">called</span><span class="plain"> </span><span class="character">'extended page number'</span><span class="plain">. </span><span class="identifier">Then</span><span class="plain"> </span><span class="identifier">read</span><span class="plain">/</span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">page</span>
    <span class="plain">;                             </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">JIM</span><span class="plain"> </span><span class="identifier">addresses</span><span class="plain">.</span>
    <span class="plain">; $</span><span class="identifier">FE00</span><span class="plain">-$</span><span class="identifier">FEFF</span><span class="plain">   - </span><span class="identifier">SHIELA</span><span class="plain">    - </span><span class="identifier">Read</span><span class="plain"> / </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">internal</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">BBC</span><span class="plain"> </span><span class="identifier">Micro</span><span class="plain">, </span><span class="identifier">e</span><span class="plain">.</span><span class="identifier">g</span><span class="plain">.</span>
    <span class="plain">;                             </span><span class="identifier">Video</span><span class="plain"> </span><span class="identifier">Controller</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> 6845; </span><span class="identifier">Video</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain">;</span>
    <span class="plain">;                             </span><span class="identifier">Serial</span><span class="plain"> </span><span class="identifier">Controller</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> 6850 (</span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain">);</span>
    <span class="plain">;                             </span><span class="identifier">Serial</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain">; </span><span class="identifier">ADC</span><span class="plain">; </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">Select</span><span class="plain">; </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain">; </span><span class="identifier">User</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain">; </span><span class="identifier">Keyboard</span><span class="plain">;</span>
    <span class="plain">;                             </span><span class="identifier">Sound</span><span class="plain">; </span><span class="identifier">Econet</span><span class="plain">; </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">etc</span><span class="plain">.</span>

    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Interrupts</span>
    <span class="plain">; ----------</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">BBC</span><span class="plain"> </span><span class="identifier">Micro</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">single</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain">, </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">threads</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">job</span><span class="plain"> </span><span class="identifier">queues</span><span class="plain">. </span><span class="identifier">It</span><span class="plain"> </span><span class="identifier">uses</span><span class="plain"> </span><span class="identifier">interrupts</span>
    <span class="plain">; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">run</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">concurrently</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">regular</span><span class="plain"> </span><span class="identifier">code</span><span class="plain">. </span><span class="identifier">Interrupt</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">must</span><span class="plain"> </span><span class="identifier">finish</span><span class="plain"> </span><span class="identifier">executing</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span>
    <span class="plain">; </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">amount</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">time</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="reserved">continue</span><span class="plain"> </span><span class="identifier">updating</span><span class="plain"> </span><span class="identifier">effectively</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">CPU</span><span class="plain"> </span><span class="identifier">receives</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">generated</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">devices</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">they</span><span class="plain"> </span><span class="identifier">need</span><span class="plain"> </span><span class="identifier">attention</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">There</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">three</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">types</span><span class="plain"> (</span><span class="identifier">NMI</span><span class="plain">; </span><span class="identifier">IRQ1</span><span class="plain">; </span><span class="identifier">IRQ2</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">NMI</span><span class="plain"> = </span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">maskable</span><span class="plain"> </span><span class="identifier">interrupts</span>
    <span class="plain">;   </span><span class="identifier">These</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">highest</span><span class="plain"> </span><span class="identifier">priority</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">. </span><span class="identifier">They</span><span class="plain"> </span><span class="identifier">cannot</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">. </span><span class="identifier">They</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">only</span>
    <span class="plain">;   </span><span class="identifier">produced</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">certain</span><span class="plain"> </span><span class="identifier">additional</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> (</span><span class="identifier">hard</span><span class="plain"> </span><span class="identifier">disk</span><span class="plain"> </span><span class="identifier">controllers</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Econet</span><span class="plain">).</span>
    <span class="plain">;   </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">NMI</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">generated</span><span class="plain">, </span><span class="identifier">the</span><span class="plain"> 6502 </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">normal</span><span class="plain"> </span><span class="identifier">operation</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">executes</span><span class="plain"> </span><span class="identifier">from</span>
    <span class="plain">;   </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">location</span><span class="plain"> </span><span class="identifier">given</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $</span><span class="identifier">FFFA</span><span class="plain">-</span><span class="identifier">B</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. $0</span><span class="identifier">D00</span><span class="plain"> = .</span><span class="identifier">nmiEntryPoint</span><span class="plain">). </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span>
    <span class="plain">;   </span><span class="identifier">NMI</span><span class="plain"> </span><span class="identifier">handling</span><span class="plain"> </span><span class="identifier">code</span><span class="plain">. </span><span class="identifier">By</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">just</span><span class="plain"> </span><span class="identifier">returns</span><span class="plain"> </span><span class="identifier">immediately</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">executing</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">RTI</span>
    <span class="plain">;   </span><span class="identifier">instruction</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">IRQ1</span><span class="plain"> = </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">request</span><span class="plain"> 1</span>
    <span class="plain">;   </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">occurs</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">generates</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain">, </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain"> </span><span class="identifier">occurs</span><span class="plain">. </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">uses</span>
    <span class="plain">;   </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain"> </span><span class="identifier">extensively</span><span class="plain">. </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain"> </span><span class="identifier">was</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">cause</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">BRKV</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">used</span>
    <span class="plain">;   </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> (</span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">uses</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">messages</span><span class="plain">). </span><span class="identifier">Otherwise</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">operating</span>
    <span class="plain">;   </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">checks</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="identifier">what</span><span class="plain"> </span><span class="identifier">needs</span><span class="plain"> </span><span class="identifier">attention</span><span class="plain">. </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">services</span><span class="plain"> </span><span class="identifier">the</span>
    <span class="plain">;   </span><span class="identifier">RS423</span><span class="plain">, </span><span class="identifier">cassette</span><span class="plain">, </span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain">, 100</span><span class="identifier">Hz</span><span class="plain"> </span><span class="identifier">timer</span><span class="plain">, </span><span class="identifier">interval</span><span class="plain"> </span><span class="identifier">timer</span><span class="plain">, </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> (</span><span class="identifier">e</span><span class="plain">.</span><span class="identifier">g</span><span class="plain">. </span><span class="identifier">used</span>
    <span class="plain">;   </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">analogue</span><span class="plain"> </span><span class="identifier">joysticks</span><span class="plain">), </span><span class="identifier">keyboard</span><span class="plain">, </span><span class="identifier">speech</span><span class="plain"> (</span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">present</span><span class="plain">), </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">printer</span>
    <span class="plain">;   </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain">. </span><span class="identifier">Based</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> 100</span><span class="identifier">Hz</span><span class="plain"> </span><span class="identifier">timers</span><span class="plain">, </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">also</span><span class="plain"> </span><span class="identifier">updates</span><span class="plain"> </span><span class="identifier">sounds</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">updates</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">flashing</span>
    <span class="plain">;   </span><span class="identifier">colours</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">Finally</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">unhandled</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">gets</span><span class="plain"> </span><span class="identifier">passed</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">IRQ2</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">IRQ2</span><span class="plain"> = </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">request</span><span class="plain"> 2</span>
    <span class="plain">;   </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">available</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">intercept</span><span class="plain"> </span><span class="identifier">unhandled</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain">. </span><span class="identifier">It</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">lowest</span>
    <span class="plain">;   </span><span class="identifier">priority</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Calls</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">IRQ1</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">IRQ2</span><span class="plain"> </span><span class="identifier">handlers</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">indirected</span><span class="plain"> </span><span class="identifier">through</span><span class="plain"> </span><span class="character">'vectors'</span><span class="plain"> (2 </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">addresses</span>
    <span class="plain">; </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $0200 </span><span class="identifier">upwards</span><span class="plain">), </span><span class="identifier">meaning</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">intercept</span><span class="plain"> </span><span class="identifier">them</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">their</span><span class="plain"> </span><span class="identifier">own</span>
    <span class="plain">; </span><span class="identifier">processing</span><span class="plain"> (</span><span class="identifier">often</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">passing</span><span class="plain"> </span><span class="identifier">through</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">unwanted</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">original</span>
    <span class="plain">; </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain">). </span><span class="identifier">NMIs</span><span class="plain"> </span><span class="identifier">cannot</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">redirected</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">BRK</span><span class="plain"> </span><span class="identifier">instruction</span>
    <span class="plain">; ---------------</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain"> </span><span class="identifier">pushes</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">program</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">onto</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> (</span><span class="identifier">including</span><span class="plain"> </span><span class="identifier">a</span>
    <span class="plain">; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">), </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">starts</span><span class="plain"> </span><span class="identifier">executing</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $</span><span class="identifier">FFFE</span><span class="plain">/</span><span class="identifier">F</span>
    <span class="plain">; (</span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> .</span><span class="identifier">mainIRQEntryPoint</span><span class="plain">).</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROMs</span>
    <span class="plain">; ----------</span>
    <span class="plain">; </span><span class="identifier">Functionality</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">BBC</span><span class="plain"> </span><span class="identifier">Micro</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">extended</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">use</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain">. </span><span class="identifier">These</span><span class="plain"> </span><span class="identifier">ROMs</span>
    <span class="plain">; </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="character">'paged in'</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">map</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> $8000-$</span><span class="identifier">BFFF</span><span class="plain">. </span><span class="identifier">Once</span><span class="plain"> </span><span class="identifier">finished</span>
    <span class="plain">; </span><span class="identifier">with</span><span class="plain">, </span><span class="identifier">they</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="character">'paged out'</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">reinstated</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">map</span><span class="plain"> (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span>
    <span class="plain">; </span><span class="identifier">usually</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">language</span><span class="plain">, </span><span class="identifier">often</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain">).</span>
    <span class="plain">; </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">implement</span><span class="plain"> </span><span class="identifier">programming</span><span class="plain"> </span><span class="identifier">languages</span><span class="plain">; </span><span class="identifier">act</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">Only</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">; </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">ROMFS</span><span class="plain">; </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">provide</span><span class="plain"> </span><span class="identifier">more</span><span class="plain"> </span><span class="identifier">commands</span><span class="plain"> (</span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">commands</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">user</span><span class="plain">.</span>
    <span class="plain">; </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">also</span><span class="plain"> </span><span class="identifier">supported</span><span class="plain">, </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="identifier">alongside</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">Phrase</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="character">'PHROM'</span><span class="plain"> </span><span class="identifier">that</span>
    <span class="plain">; </span><span class="identifier">provides</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">word</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">phoneme</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">generating</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">BBC</span><span class="plain"> </span><span class="identifier">Micro</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> 5 </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">sockets</span><span class="plain"> </span><span class="identifier">available</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> (</span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">use</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 16 </span><span class="identifier">with</span>
    <span class="plain">; </span><span class="identifier">some</span><span class="plain"> </span><span class="identifier">additional</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain">).</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Calling</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">Operating</span><span class="plain"> </span><span class="identifier">System</span>
    <span class="plain">; ----------------------------</span>
    <span class="plain">; </span><span class="identifier">There</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">specific</span><span class="plain"> </span><span class="identifier">addresses</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">access</span><span class="plain"> </span><span class="identifier">specific</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">routines</span>
    <span class="plain">; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">perform</span><span class="plain"> </span><span class="identifier">useful</span><span class="plain"> </span><span class="identifier">functions</span><span class="plain">. </span><span class="identifier">These</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">detailed</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSWRCH</span><span class="plain"> (</span><span class="identifier">For</span><span class="plain"> </span><span class="identifier">displaying</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain">)</span>
    <span class="plain">; -----------------------------------------</span>
    <span class="plain">; 37% </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">operating</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">relates</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">displaying</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> (</span><span class="identifier">Chapters</span><span class="plain"> 1-5).</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">BBC</span><span class="plain"> </span><span class="identifier">Micro</span><span class="plain"> </span><span class="identifier">defines</span><span class="plain"> 8 </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">modes</span><span class="plain"> (0-7), </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">different</span><span class="plain"> </span><span class="identifier">combinations</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">pixel</span>
    <span class="plain">; </span><span class="identifier">resolutions</span><span class="plain">, </span><span class="identifier">colours</span><span class="plain">, </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">vs</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">capability</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">usage</span><span class="plain">.</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">BBC</span><span class="plain"> </span><span class="identifier">Micro</span><span class="plain"> </span><span class="identifier">can</span><span class="plain">, </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">example</span><span class="plain"> </span><span class="identifier">draw</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain">, </span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">points</span><span class="plain">, </span><span class="identifier">lines</span><span class="plain">, </span><span class="identifier">filled</span>
    <span class="plain">; </span><span class="identifier">triangles</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">horizontal</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">fills</span><span class="plain">.</span>
    <span class="plain">; </span><span class="identifier">It</span><span class="plain"> </span><span class="identifier">uses</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">fixed</span><span class="plain"> </span><span class="identifier">coordinate</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">extending</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> (0,0) </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span>
    <span class="plain">; </span><span class="identifier">to</span><span class="plain"> (1280 </span><span class="identifier">x</span><span class="plain"> 1024) </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">right</span><span class="plain">. </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">coordinate</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> </span><span class="identifier">represents</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">entire</span><span class="plain"> </span><span class="identifier">screen</span>
    <span class="plain">; </span><span class="identifier">regardless</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">actual</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">pixels</span><span class="plain"> </span><span class="identifier">available</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">OSWRCH</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> (</span><span class="identifier">often</span><span class="plain"> </span><span class="identifier">multiple</span><span class="plain"> </span><span class="identifier">times</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">row</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">draw</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain">. </span><span class="identifier">This</span>
    <span class="plain">; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">equivalent</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="character">'VDU'</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSRDCH</span>
    <span class="plain">; ------</span>
    <span class="plain">; </span><span class="identifier">Reads</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> (</span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">other</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">source</span><span class="plain"> </span><span class="identifier">such</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">file</span><span class="plain">).</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> (*</span><span class="identifier">FX</span><span class="plain">)</span>
    <span class="plain">; ------------</span>
    <span class="plain">; </span><span class="identifier">Also</span><span class="plain"> </span><span class="identifier">known</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="character">'*FX'</span><span class="plain">, </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">equivalent</span><span class="plain"> </span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">command</span><span class="plain">.</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">registers</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain">. </span><span class="identifier">Register</span><span class="plain"> </span><span class="character">'A'</span><span class="plain"> </span><span class="identifier">determines</span>
    <span class="plain">; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">call</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSWORD</span>
    <span class="plain">; ------</span>
    <span class="plain">; </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">needs</span><span class="plain"> </span><span class="identifier">more</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">provide</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">OSWORD</span><span class="plain"> </span><span class="identifier">is</span>
    <span class="plain">; </span><span class="identifier">used</span><span class="plain">. </span><span class="identifier">Registers</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">together</span><span class="plain"> </span><span class="identifier">form</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">holds</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">data</span>
    <span class="plain">; </span><span class="identifier">specific</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">OSWORD</span><span class="plain"> </span><span class="identifier">given</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="character">'A'</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Filing</span><span class="plain"> </span><span class="identifier">System</span>
    <span class="plain">; -------------</span>
    <span class="plain">; </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">chosen</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">command</span><span class="plain">. </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">support</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> (*</span><span class="identifier">TAPE</span><span class="plain">) </span><span class="identifier">and</span>
    <span class="plain">; </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">systems</span><span class="plain"> (*</span><span class="identifier">ROM</span><span class="plain">). </span><span class="identifier">Support</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">other</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">systems</span><span class="plain"> (</span><span class="identifier">e</span><span class="plain">.</span><span class="identifier">g</span><span class="plain">. </span><span class="reserved">for</span><span class="plain"> *</span><span class="identifier">ADFS</span><span class="plain">) </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">be</span>
    <span class="plain">; </span><span class="identifier">added</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROMS</span><span class="plain">. </span><span class="identifier">There</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">calls</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">perform</span><span class="plain"> </span><span class="identifier">operations</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">the</span>
    <span class="plain">; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">;           .</span><span class="identifier">OSFIND</span><span class="plain"> / .</span><span class="identifier">OSGBPB</span><span class="plain"> / .</span><span class="identifier">OSBPUT</span><span class="plain"> / .</span><span class="identifier">OSBGET</span><span class="plain"> / .</span><span class="identifier">OSARGS</span><span class="plain"> / .</span><span class="identifier">OSFILE</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSCLI</span><span class="plain"> (</span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">commands</span><span class="plain">)</span>
    <span class="plain">; ---------------------</span>
    <span class="plain">; </span><span class="identifier">Executes</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="character">'star command'</span><span class="plain"> </span><span class="identifier">supplied</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">string</span><span class="plain">. </span><span class="identifier">There</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">standard</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">commands</span>
    <span class="plain">; </span><span class="identifier">listed</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">. </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">more</span><span class="plain"> </span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">commands</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; *</span><span class="identifier">BASIC</span><span class="plain">            </span><span class="identifier">Start</span><span class="plain"> </span><span class="identifier">BASIC</span>
    <span class="plain">; *</span><span class="identifier">CAT</span><span class="plain"> (</span><span class="identifier">aka</span><span class="plain"> *.)     </span><span class="identifier">Get</span><span class="plain"> </span><span class="identifier">catalogue</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">; *</span><span class="identifier">CODE</span><span class="plain">             </span><span class="identifier">Execute</span><span class="plain"> </span><span class="identifier">code</span>
    <span class="plain">; *</span><span class="identifier">EXEC</span><span class="plain">             </span><span class="identifier">Execute</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">script</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">; *</span><span class="identifier">FX</span><span class="plain">               </span><span class="identifier">Calls</span><span class="plain"> </span><span class="identifier">OSBYTE</span>
    <span class="plain">; *</span><span class="identifier">HELP</span><span class="plain">             </span><span class="identifier">Get</span><span class="plain"> </span><span class="identifier">help</span>
    <span class="plain">; *</span><span class="identifier">KEY</span><span class="plain">              </span><span class="identifier">Define</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">definition</span>
    <span class="plain">; *</span><span class="identifier">LINE</span><span class="plain">             </span><span class="identifier">Execute</span><span class="plain"> </span><span class="identifier">code</span>
    <span class="plain">; *</span><span class="identifier">LOAD</span><span class="plain">             </span><span class="identifier">Load</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">; *</span><span class="identifier">MOTOR</span><span class="plain">            </span><span class="identifier">Turn</span><span class="plain"> </span><span class="identifier">on</span><span class="plain">/</span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">motor</span>
    <span class="plain">; *</span><span class="identifier">OPT</span><span class="plain">              </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">options</span>
    <span class="plain">; *</span><span class="identifier">ROM</span><span class="plain">              </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">; *</span><span class="identifier">RUN</span><span class="plain">              </span><span class="identifier">Load</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">execute</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">; *</span><span class="identifier">SAVE</span><span class="plain">             </span><span class="identifier">Save</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">; *</span><span class="identifier">SPOOL</span><span class="plain">            </span><span class="identifier">Save</span><span class="plain"> </span><span class="identifier">keystrokes</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">; *</span><span class="identifier">TAPE</span><span class="plain">             </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">TAPE</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">; *</span><span class="identifier">TV</span><span class="plain">               </span><span class="identifier">Adjust</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">TV</span><span class="plain"> </span><span class="identifier">display</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Others</span>
    <span class="plain">; ------</span>
    <span class="plain">; </span><span class="identifier">OSRDRM</span><span class="plain">          - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">ROM</span>
    <span class="plain">; </span><span class="identifier">VDUCHR</span><span class="plain">          - </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">cut</span><span class="plain"> </span><span class="identifier">down</span><span class="plain"> </span><span class="identifier">form</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">OSWRCH</span>
    <span class="plain">; </span><span class="identifier">OSEVEN</span><span class="plain">          - </span><span class="identifier">generates</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">EVENT</span><span class="plain">, </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">managed</span><span class="plain"> </span><span class="identifier">interrupt</span>
    <span class="plain">; </span><span class="identifier">GSINIT</span><span class="plain"> / </span><span class="identifier">GSREAD</span><span class="plain"> - </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">reading</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">user</span>
    <span class="plain">; </span><span class="identifier">NVRDCH</span><span class="plain"> / </span><span class="identifier">NVWRCH</span><span class="plain"> - </span><span class="identifier">non</span><span class="plain"> </span><span class="identifier">vectored</span><span class="plain"> </span><span class="identifier">versions</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">OSRDCH</span><span class="plain"> / </span><span class="identifier">OSWRCH</span>
    <span class="plain">; </span><span class="identifier">OSASCI</span><span class="plain">          - </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">OSWRCH</span><span class="plain">, </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain">/</span><span class="identifier">LF</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain"> </span><span class="identifier">found</span>
    <span class="plain">; </span><span class="identifier">OSNEWL</span><span class="plain">          - </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain">/</span><span class="identifier">LF</span>
    <span class="plain">;</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Power</span><span class="plain"> </span><span class="identifier">On</span><span class="plain"> / </span><span class="identifier">Reset</span>
    <span class="plain">; ----------------</span>
    <span class="plain">; </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">powered</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> (</span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">key</span><span class="plain">) </span><span class="identifier">the</span><span class="plain"> 6502 </span><span class="identifier">executes</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span>
    <span class="plain">; </span><span class="identifier">retrieved</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> $</span><span class="identifier">FFFC</span><span class="plain">/</span><span class="identifier">D</span><span class="plain"> (</span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">resolves</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">resetEntryPoint</span><span class="plain">). </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">runs</span><span class="plain"> </span><span class="identifier">through</span><span class="plain"> </span><span class="identifier">a</span>
    <span class="plain">; </span><span class="identifier">list</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">steps</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">;     * </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">RTI</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $0</span><span class="identifier">D00</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">stop</span><span class="plain"> </span><span class="identifier">executing</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">more</span><span class="plain"> </span><span class="identifier">NMI</span><span class="plain"> </span><span class="identifier">routines</span><span class="plain">)</span>
    <span class="plain">;     * </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> (</span><span class="identifier">stop</span><span class="plain"> </span><span class="identifier">executing</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">more</span><span class="plain"> </span><span class="identifier">IRQs</span><span class="plain">)</span>
    <span class="plain">;     * </span><span class="identifier">Clear</span><span class="plain"> </span><span class="identifier">decimal</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> (</span><span class="identifier">decimal</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">never</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">assumed</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">routines</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">called</span><span class="plain">)</span>
    <span class="plain">;     * </span><span class="identifier">Reset</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> </span><span class="identifier">pointer</span>
    <span class="plain">;     * </span><span class="identifier">Clear</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain"> (</span><span class="identifier">also</span><span class="plain"> </span><span class="identifier">detect</span><span class="plain"> </span><span class="identifier">amount</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">present</span><span class="plain">, </span><span class="identifier">either</span><span class="plain"> 16</span><span class="identifier">k</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> 32</span><span class="identifier">k</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">record</span><span class="plain"> </span><span class="identifier">this</span><span class="plain">)</span>
    <span class="plain">;     * </span><span class="identifier">Initialise</span><span class="plain"> </span><span class="identifier">various</span><span class="plain"> </span><span class="identifier">hardware</span>
    <span class="plain">;     * </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">keyboard</span>
    <span class="plain">;     * </span><span class="identifier">Initialise</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">vectors</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> ($0200 </span><span class="identifier">upwards</span><span class="plain">, </span><span class="identifier">amount</span><span class="plain"> </span><span class="identifier">depending</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain">)</span>
    <span class="plain">;     * </span><span class="identifier">Initialise</span><span class="plain"> </span><span class="identifier">JIM</span><span class="plain"> (</span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">gives</span><span class="plain"> </span><span class="identifier">access</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">optional</span><span class="plain"> 64</span><span class="identifier">k</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">Memory</span><span class="plain">)</span>
    <span class="plain">;     * </span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">some</span><span class="plain"> </span><span class="identifier">interrupts</span>
    <span class="plain">;     * </span><span class="identifier">Clear</span><span class="plain"> </span><span class="identifier">sounds</span>
    <span class="plain">;     * </span><span class="identifier">Initialise</span><span class="plain"> </span><span class="identifier">ROMs</span>
    <span class="plain">;     * </span><span class="identifier">Initialise</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">present</span>
    <span class="plain">;     * </span><span class="identifier">Clear</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span>
    <span class="plain">;     * </span><span class="identifier">Insert</span><span class="plain"> </span><span class="identifier">F10</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain"> (</span><span class="identifier">implements</span><span class="plain"> </span><span class="identifier">effect</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> *</span><span class="identifier">KEY</span><span class="plain"> 10)</span>
    <span class="plain">;     * </span><span class="identifier">Execute</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">boot</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">present</span>
    <span class="plain">;     * </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">options</span>
    <span class="plain">;     * </span><span class="identifier">Initialise</span><span class="plain"> </span><span class="identifier">Tube</span>
    <span class="plain">;     * </span><span class="identifier">Initialise</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> (</span><span class="identifier">post</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">initialisation</span><span class="plain">)</span>
    <span class="plain">;     * </span><span class="identifier">Show</span><span class="plain"> </span><span class="character">'BBC Computer 32K'</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> (</span><span class="identifier">or</span><span class="plain"> </span><span class="string">"16K"</span><span class="plain">)</span>
    <span class="plain">;     * </span><span class="identifier">Initialise</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">LEDs</span>
    <span class="plain">;     * </span><span class="identifier">Select</span><span class="plain"> </span><span class="identifier">Filing</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">ROM</span>
    <span class="plain">;     * </span><span class="identifier">Execute</span><span class="plain"> !</span><span class="identifier">BOOT</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">needed</span>
    <span class="plain">;     * </span><span class="identifier">Find</span><span class="plain"> </span><span class="identifier">best</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">enter</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">enter</span><span class="plain"> </span><span class="identifier">it</span>
    <span class="plain">;</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Extended</span><span class="plain"> </span><span class="identifier">vectors</span>
    <span class="plain">; ----------------</span>
    <span class="plain">; </span><span class="identifier">Extended</span><span class="plain"> </span><span class="identifier">vectors</span><span class="plain"> </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">intercept</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">standard</span><span class="plain"> </span><span class="identifier">vectors</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $0200 </span><span class="identifier">upwards</span><span class="plain">,</span>
    <span class="plain">; </span><span class="identifier">effectively</span><span class="plain"> </span><span class="identifier">getting</span><span class="plain"> </span><span class="identifier">them</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> *</span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">specified</span><span class="plain"> </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">*.</span>
    <span class="plain">; </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $0</span><span class="identifier">D9F</span><span class="plain"> (.</span><span class="identifier">extendedVectorSpace</span><span class="plain">) </span><span class="identifier">with</span><span class="plain"> 3 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain">:</span>
    <span class="plain">;      </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">address</span>
    <span class="plain">;      </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">single</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">holding</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span>
    <span class="plain">; </span><span class="identifier">To</span><span class="plain"> </span><span class="identifier">use</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">extended</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain">, </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">appropriate</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">these</span><span class="plain"> </span><span class="identifier">locations</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">store</span>
    <span class="plain">; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="character">'$FF00+3*N'</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="character">'$0200+2*N'</span><span class="plain"> (</span><span class="identifier">remembering</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">at</span>
    <span class="plain">; $0200+2*</span><span class="identifier">N</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">required</span><span class="plain">).</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Memory</span><span class="plain"> </span><span class="identifier">Map</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">RAM</span>
    <span class="plain">; ------------------</span>
    <span class="plain">; $0000-$008</span><span class="identifier">F</span><span class="plain">   </span><span class="identifier">Current</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">workspace</span>
    <span class="plain">; $0090-$009</span><span class="identifier">F</span><span class="plain">   </span><span class="identifier">Econet</span><span class="plain"> </span><span class="identifier">workspace</span>
    <span class="plain">; $00</span><span class="identifier">A0</span><span class="plain">-$00</span><span class="identifier">A7</span><span class="plain">   </span><span class="identifier">NMI</span><span class="plain"> </span><span class="identifier">workspace</span>
    <span class="plain">; $00</span><span class="identifier">A8</span><span class="plain">-$00</span><span class="identifier">AF</span><span class="plain">   </span><span class="string">"OS temp workspace"</span><span class="plain"> (</span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">seems</span><span class="plain"> </span><span class="identifier">unused</span><span class="plain">?)</span>
    <span class="plain">; $00</span><span class="identifier">B0</span><span class="plain">-$00</span><span class="identifier">CF</span><span class="plain">   </span><span class="identifier">Filing</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">workspace</span>
    <span class="plain">; $00</span><span class="identifier">D0</span><span class="plain">-$00</span><span class="identifier">FF</span><span class="plain">   </span><span class="identifier">VDU</span><span class="plain">/</span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">workspace</span>
    <span class="plain">; $0100-$01</span><span class="identifier">FF</span><span class="plain">   6502 </span><span class="identifier">stack</span>
    <span class="plain">; $0200-$0235   </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">vectors</span>
    <span class="plain">; $0236-$02</span><span class="identifier">FF</span><span class="plain">   </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">variables</span>
    <span class="plain">; $0300-$037</span><span class="identifier">F</span><span class="plain">   </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">variables</span>
    <span class="plain">; $0380-$03</span><span class="identifier">DF</span><span class="plain">   </span><span class="identifier">Cassette</span><span class="plain"> </span><span class="identifier">Filing</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">workspace</span>
    <span class="plain">; $03</span><span class="identifier">E0</span><span class="plain">-$03</span><span class="identifier">FF</span><span class="plain">   </span><span class="identifier">Keyboard</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span>
    <span class="plain">; $0400-$07</span><span class="identifier">FF</span><span class="plain">   </span><span class="identifier">Workspace</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> (</span><span class="identifier">e</span><span class="plain">.</span><span class="identifier">g</span><span class="plain">. </span><span class="identifier">BASIC</span><span class="plain">)</span>
    <span class="plain">; $0800-$08</span><span class="identifier">FF</span><span class="plain">   </span><span class="identifier">Sound</span><span class="plain"> </span><span class="identifier">workspace</span><span class="plain">; </span><span class="identifier">Sound</span><span class="plain"> </span><span class="identifier">buffers</span><span class="plain">; </span><span class="identifier">Printer</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain">; </span><span class="identifier">Envelope</span><span class="plain"> </span><span class="identifier">storage</span>
    <span class="plain">; $0900-$09</span><span class="identifier">FF</span><span class="plain">   </span><span class="identifier">Envelope</span><span class="plain">/</span><span class="identifier">Speech</span><span class="plain">/</span><span class="identifier">Cassette</span><span class="plain"> </span><span class="identifier">buffers</span>
    <span class="plain">; $0</span><span class="identifier">A00</span><span class="plain">-$0</span><span class="identifier">AFF</span><span class="plain">   </span><span class="identifier">Cassette</span><span class="plain">/</span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span>
    <span class="plain">; $0</span><span class="identifier">B00</span><span class="plain">-$0</span><span class="identifier">BFF</span><span class="plain">   </span><span class="identifier">Soft</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">buffer</span>
    <span class="plain">; $0</span><span class="identifier">C00</span><span class="plain">-$0</span><span class="identifier">CFF</span><span class="plain">   </span><span class="identifier">Font</span><span class="plain"> </span><span class="identifier">definitions</span>
    <span class="plain">; $0</span><span class="identifier">D00</span><span class="plain">-$0</span><span class="identifier">D9E</span><span class="plain">   </span><span class="identifier">NMI</span><span class="plain"> </span><span class="identifier">routine</span>
    <span class="plain">; $0</span><span class="identifier">D9F</span><span class="plain">-$0</span><span class="identifier">DEF</span><span class="plain">   </span><span class="identifier">Expanded</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">set</span>
    <span class="plain">; $0</span><span class="identifier">DF0</span><span class="plain">-$0</span><span class="identifier">DFF</span><span class="plain">   </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">workspace</span><span class="plain"> </span><span class="identifier">storage</span><span class="plain"> </span><span class="identifier">locations</span>
    <span class="plain">; $0</span><span class="identifier">E00</span><span class="plain">-$7</span><span class="identifier">FFF</span><span class="plain">   </span><span class="identifier">Available</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> (</span><span class="identifier">although</span><span class="plain"> $0</span><span class="identifier">E00</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">raised</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">soft</span>
    <span class="plain">;               </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">explosions</span><span class="plain">. </span><span class="identifier">OSHWM</span><span class="plain"> </span><span class="identifier">gives</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">actual</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">start</span>
    <span class="plain">;               </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">ACME</span><span class="plain"> </span><span class="identifier">Assembler</span>
    <span class="plain">; ------------------</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">syntax</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ACME</span><span class="plain"> </span><span class="identifier">assembler</span><span class="plain"> (</span><span class="identifier">https</span><span class="plain">:</span>    <span class="comment">github.com/meonwax/acme)</span>
    <span class="plain">;</span>
    <span class="plain">;       </span><span class="identifier">acme</span><span class="plain"> -</span><span class="identifier">r</span><span class="plain"> </span><span class="identifier">os12_report</span><span class="plain">.</span><span class="identifier">txt</span><span class="plain"> -</span><span class="identifier">o</span><span class="plain"> </span><span class="identifier">os12</span><span class="plain">.</span><span class="identifier">bin</span><span class="plain"> </span><span class="identifier">os12_acme</span><span class="plain">.</span><span class="identifier">a</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">To</span><span class="plain"> </span><span class="identifier">explain</span><span class="plain"> </span><span class="identifier">some</span><span class="plain"> </span><span class="identifier">perhaps</span><span class="plain"> </span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">obvious</span><span class="plain"> </span><span class="identifier">points</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ACME</span><span class="plain"> </span><span class="identifier">assembler</span><span class="plain"> </span><span class="identifier">syntax</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">;     * </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">uses</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="character">'+'</span><span class="plain"> </span><span class="identifier">symbol</span><span class="plain">, </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">destination</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain">     </span><span class="character">'+'</span><span class="plain"> </span><span class="identifier">label</span><span class="plain">.</span>
    <span class="plain">;     * </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">uses</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="character">'-'</span><span class="plain"> </span><span class="identifier">symbol</span><span class="plain">, </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">destination</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="character">'-'</span><span class="plain"> </span><span class="identifier">label</span><span class="plain">.</span>
    <span class="plain">;     * </span><span class="identifier">Symbols</span><span class="plain"> </span><span class="character">'++'</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="character">'--'</span><span class="plain"> </span><span class="identifier">work</span><span class="plain"> </span><span class="identifier">similarly</span><span class="plain">.</span>
    <span class="plain">;     * !</span><span class="identifier">word</span><span class="plain"> </span><span class="identifier">outputs</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">little</span><span class="plain"> </span><span class="identifier">endian</span><span class="plain"> </span><span class="identifier">order</span>
    <span class="plain">;     * !</span><span class="identifier">be16</span><span class="plain"> </span><span class="identifier">outputs</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">big</span><span class="plain"> </span><span class="identifier">endian</span><span class="plain"> </span><span class="identifier">order</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">assembled</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ACME</span><span class="plain"> </span><span class="identifier">assembler</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">should</span><span class="plain"> </span><span class="identifier">produce</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">binary</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">identical</span><span class="plain"> </span><span class="identifier">to</span>
    <span class="plain">; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">OS1</span><span class="plain">.2 </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">image</span><span class="plain">. </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">MD5</span><span class="plain"> </span><span class="identifier">checksum</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">binary</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 0</span><span class="identifier">a59a5ba15fe8557b5f7fee32bbd393a</span>
    <span class="plain">;</span>

    <span class="plain">.</span><span class="identifier">charBELL</span><span class="plain">                                   = 7         ; (</span><span class="identifier">CTRL</span><span class="plain">-</span><span class="identifier">G</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">charRETURN</span><span class="plain">                                 = 13        ;</span>
    <span class="plain">.</span><span class="identifier">charDisableVDUOrDeleteLine</span><span class="plain">                 = 21        ; (</span><span class="identifier">CTRL</span><span class="plain">-</span><span class="identifier">U</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">charESCAPE</span><span class="plain">                                 = 27        ;</span>
    <span class="plain">.</span><span class="identifier">charSPACE</span><span class="plain">                                  = 32        ;</span>
    <span class="plain">.</span><span class="identifier">charEXCLAMATIONMARK</span><span class="plain">                        = 33        ; !</span>
    <span class="plain">.</span><span class="identifier">charDOUBLEQUOTE</span><span class="plain">                            = 34        ; </span><span class="string">"</span>
    <span class="string">.charSTAR                                   = 42        ; *</span>
    <span class="string">.charPLUS                                   = 43        ; +</span>
    <span class="string">.charCOMMA                                  = 44        ; ,</span>
    <span class="string">.charDOT                                    = 46        ; .</span>
    <span class="string">.charFORWARDSLASH                           = 47        ; /</span>
    <span class="string">.charZERO                                   = 48        ; 0</span>
    <span class="string">.charNINE                                   = 57        ; 9</span>
    <span class="string">.charCOLON                                  = 58        ; :</span>
    <span class="string">.charQUESTIONMARK                           = 63        ; ?</span>
    <span class="string">.charAT                                     = 64        ; @</span>
    <span class="string">.charA                                      = 65        ; A</span>
    <span class="string">.charF                                      = 70        ; F</span>
    <span class="string">.charZ                                      = 90        ; Z</span>
    <span class="string">.charUNDERSCORE                             = 95        ; _</span>
    <span class="string">.charPOUND                                  = 96        ; ?</span>
    <span class="string">.charBAR                                    = 124       ; |</span>
    <span class="string">.charDELETE                                 = 127       ;</span>
    <span class="string">.charCOPY                                   = $87       ; (character equivalent of the COPY key)</span>

    <span class="string">.internalKeyNumberSPACE                     = $62       ;</span>

    <span class="string">; Buffer numbers (See NAUG Section 9, Page 136)</span>
    <span class="string">.bufferNumberKeyboard                       = 0         ;</span>
    <span class="string">.bufferNumberRS423Input                     = 1         ;</span>
    <span class="string">.bufferNumberRS423Output                    = 2         ;</span>
    <span class="string">.bufferNumberPrinter                        = 3         ;</span>
    <span class="string">.bufferNumberSound0                         = 4         ;</span>
    <span class="string">.bufferNumberSound1                         = 5         ;</span>
    <span class="string">.bufferNumberSound2                         = 6         ;</span>
    <span class="string">.bufferNumberSound3                         = 7         ;</span>
    <span class="string">.bufferNumberSpeech                         = 8         ;</span>
    <span class="string">.bufferNumberHighest                        = 8         ;</span>

    <span class="string">; Buffer offsets. When we add the buffer length it just overflows the byte.</span>
    <span class="string">.keyboardInputBufferOffset                  = $E0       ; 32 bytes</span>
    <span class="string">.tapeOrRS423InputBufferOffset               = $00       ; 256 bytes</span>
    <span class="string">.rs423OutputBufferOffset                    = $40       ; 192 bytes</span>
    <span class="string">.printerBufferOffset                        = $C0       ; 64 bytes</span>
    <span class="string">.soundChannel0BufferOffset                  = $F0       ; 16 bytes</span>
    <span class="string">.soundChannel1BufferOffset                  = $F0       ; 16 bytes</span>
    <span class="string">.soundChannel2BufferOffset                  = $F0       ; 16 bytes</span>
    <span class="string">.soundChannel3BufferOffset                  = $F0       ; 16 bytes</span>
    <span class="string">.speechBufferOffset                         = $C0       ; 64 bytes</span>

    <span class="string">; Events (See NAUG Section 7, Page 119)</span>
    <span class="string">.eventOutputBufferBecomesEmpty              = 0         ;</span>
    <span class="string">.eventInputBufferBecomesFull                = 1         ;</span>
    <span class="string">.eventCharacterEnteringInputBuffer          = 2         ;</span>
    <span class="string">.eventADCConversionComplete                 = 3         ;</span>
    <span class="string">.eventStartOfVSync                          = 4         ;</span>
    <span class="string">.eventIntervalTimerCrossingZero             = 5         ;</span>
    <span class="string">.eventESCAPEConditionDetected               = 6         ;</span>
    <span class="string">.eventRS423ErrorDetected                    = 7         ;</span>
    <span class="string">.eventEconetEvent                           = 8         ;</span>
    <span class="string">.eventUserEvent                             = 9         ;</span>

    <span class="string">; CRTC registers (See NAUG Section 13.3.3, Page 190)</span>
    <span class="string">.crtcVerticalSyncPositionRegister           = 7         ;</span>
    <span class="string">.crtcInterlaceAndDelayRegister              = 8         ;</span>
    <span class="string">.crtcCursorStartRegister                    = 10        ;</span>
    <span class="string">.crtcCursorPositionHigh                     = 14        ;</span>
    <span class="string">.crtcCursorPositionLow                      = 15        ;</span>

    <span class="string">; Paged ROM service calls (See NAUG Section 17, Page 295)</span>
    <span class="string">.romServiceCallAbsoluteWorkspaceClaim       = $01       ;</span>
    <span class="string">.romServiceCallPrivateWorkspaceClaim        = $02       ;</span>
    <span class="string">.romServiceCallAutoBoot                     = $03       ;</span>
    <span class="string">.romServiceCallUnrecognisedCommand          = $04       ;</span>
    <span class="string">.romServiceCallUnrecognisedInterrupt        = $05       ;</span>
    <span class="string">.romServiceCallBreakInstruction             = $06       ;</span>
    <span class="string">.romServiceCallUnrecognisedOSBYTE           = $07       ;</span>
    <span class="string">.romServiceCallUnrecognisedOSWORD           = $08       ;</span>
    <span class="string">.romServiceCallHelp                         = $09       ;</span>
    <span class="string">.romServiceCallClaimStaticWorkspace         = $0A       ; (Issued from paged ROMs, not from the OS)</span>
    <span class="string">.romServiceCallNMIRelease                   = $0B       ; (Issued from paged ROMs, not from the OS)</span>
    <span class="string">.romServiceCallNMIClaim                     = $0C       ; (Issued from paged ROMs, not from the OS)</span>
    <span class="string">.romServiceCallROMFilingSystemInitialize    = $0D       ;</span>
    <span class="string">.romServiceCallROMFilingSystemByteGet       = $0E       ;</span>
    <span class="string">.romServiceCallVectorsClaimed               = $0F       ; (Used when a new filing system starts)</span>
    <span class="string">.romServiceCallSpoolExecClosureWarning      = $10       ;</span>
    <span class="string">.romServiceCallFontImplosionExplosionWarning= $11       ;</span>
    <span class="string">.romServiceCallInitialiseFilingSystem       = $12       ; (Issued from paged ROMs, not from the OS)</span>
    <span class="string">.romServiceCallTubeSystemPostInitialisation = $FE       ;</span>
    <span class="string">.romServiceCallTubeMainInitialisation       = $FF       ;</span>

    <span class="string">; Tube - (See NAUG Section 18.8, Page 338)</span>
    <span class="string">.tubeClaimReasonCode                        = $C0       ;</span>
    <span class="string">.tubeCallerIDCassetteFS                     = $00       ;</span>
    <span class="string">.tubeCallerIDDiscFS                         = $01       ;</span>
    <span class="string">.tubeCallerIDEconetLowLevelPrimitives       = $02       ;</span>
    <span class="string">.tubeCallerIDEconetHighLevelPrimitives      = $03       ;</span>

    <span class="string">; tape / ROM filing system synchronisation bytes</span>
    <span class="string">; See NAUG Section 16.3.1 Page 263 for tape header</span>
    <span class="string">; See NAUG Section 17.5.6 Page 317 for ROM header</span>
    <span class="string">.synchronisationByte                        = $2A       ; tape / ROM synchronisation byte</span>
    <span class="string">.middleBlockHeaderByte                      = $23       ; ROM filing system header byte</span>
    <span class="string">.finalBlockHeaderByte                       = $2B       ; ROM filing system header byte</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">; Memory addresses</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.loadAddressLow                             = $B0       ;</span>
    <span class="string">.loadAddressMid1                            = $B1       ;</span>
    <span class="string">.loadAddressMid2                            = $B2       ;</span>
    <span class="string">.loadAddressHigh                            = $B3       ;</span>

    <span class="string">.tapeCurrentBlockNumberLow                  = $B4       ;</span>
    <span class="string">.tapeCurrentBlockNumberHigh                 = $B5       ;</span>
    <span class="string">.tapeNextBlockNumberLow                     = $B6       ;</span>
    <span class="string">.tapeNextBlockNumberHigh                    = $B7       ;</span>

    <span class="string">.printSafeMessageAddressLow                 = $B8       ;</span>
    <span class="string">.printSafeMessageAddressHigh                = $B9       ;</span>

    <span class="string">.tapeCurrentBlockFlag                       = $BA       ;</span>
    <span class="string">.tapeCurrentOptionsByte                     = $BB       ; options byte for tape filing system</span>
                                                            <span class="string">;</span>
                                                            <span class="string">; Options are stored in top four bits</span>
                                                            <span class="string">;   bit 4 = Abort bit</span>
                                                            <span class="string">;   bit 5 = Retry bit</span>
                                                            <span class="string">;   bit 6 } Message type: 00 = no messages</span>
                                                            <span class="string">;   bit 7 }             : 10 = short messages</span>
                                                            <span class="string">;         }             : 11 = long messages</span>
                                                            <span class="string">;</span>
                                                            <span class="string">; 0000 0000    Ignore errors         no messages</span>
                                                            <span class="string">; 0001 0000    Abort if error        no messages</span>
                                                            <span class="string">; 0010 0000    Retry after error     no messages</span>
                                                            <span class="string">; 1000 0000    Ignore error          short messages</span>
                                                            <span class="string">; 1001 0000    Abort if error        short messages</span>
                                                            <span class="string">; 1010 0000    Retry after error     short messages</span>
                                                            <span class="string">; 1100 0000    Ignore error          long messages</span>
                                                            <span class="string">; 1101 0000    Abort if error        long messages</span>
                                                            <span class="string">; 1110 0000    Retry after error     long messages</span>

    <span class="string">.fsTempStorage                              = $BC       ;</span>
    <span class="string">.fsTempStorageBD                            = $BD       ;</span>
    <span class="string">.tapeChecksumA                              = $BE       ;</span>
    <span class="string">.tapeChecksumB                              = $BF       ;</span>
    <span class="string">.filingSystemBufferFlag                     = $C0       ;</span>
    <span class="string">.checksumResult                             = $C1       ;</span>
    <span class="string">.tapeProgressState                          = $C2       ;</span>
    <span class="string">.tapeCurrentFileHandle                      = $C3       ;</span>
    <span class="string">.tapeLastBputValue                          = $C4       ;</span>
    <span class="string">.tapeBaudRate                               = $C6       ; set current baud rate:</span>
                                                            <span class="string">; 5 for 1200 baud</span>
                                                            <span class="string">; 6 for 300 baud</span>
    <span class="string">.tapeInterBlockGapTEMP                      = $C7       ;</span>
    <span class="string">.osfileBlockAddressLow                      = $C8       ;</span>
    <span class="string">.osfileBlockAddressHigh                     = $C9       ;</span>
    <span class="string">.tapeSendingFlag                            = $CA       ; non-zero if sending to tape; zero otherwise</span>
    <span class="string">.tapeCRCBitCounter                          = $CB       ;</span>
    <span class="string">.tapeFileLengthLow                          = $CC       ;</span>
    <span class="string">.tapeFileLengthHigh                         = $CD       ;</span>

    <span class="string">; $CE = unused</span>
    <span class="string">; $CF = unused</span>

    <span class="string">.vduStatusByte                              = $D0       ; bit 0 = printer enable</span>
                                                            <span class="string">; bit 1 = scrolling disabled</span>
                                                            <span class="string">; bit 2 = paged scrolling selected</span>
                                                            <span class="string">; bit 3 = software scrolling (text window)</span>
                                                            <span class="string">; bit 4 = not used</span>
                                                            <span class="string">; bit 5 = graphics cursor enabled (VDU 5)</span>
                                                            <span class="string">; bit 6 = separated cursors</span>
                                                            <span class="string">; bit 7 = VDU disabled</span>
    <span class="string">.vduCurrentPlotByteMask                     = $D1       ;</span>
    <span class="string">.textColourByteOR                           = $D2       ;</span>
    <span class="string">.textColourByteEOR                          = $D3       ;</span>
    <span class="string">.graphicsColourByteOR                       = $D4       ;</span>
    <span class="string">.graphicsColourByteEOR                      = $D5       ;</span>
    <span class="string">.screenAddressOfGraphicsCursorCellLow       = $D6       ;</span>
    <span class="string">.screenAddressOfGraphicsCursorCellHigh      = $D7       ;</span>
    <span class="string">.vduWriteCursorScreenAddressLow             = $D8       ;</span>
    <span class="string">.vduWriteCursorScreenAddressHigh            = $D9       ;</span>
    <span class="string">.tempStoreDA                                = $DA       ;</span>
    <span class="string">.tempStoreDB                                = $DB       ;</span>
    <span class="string">.tempStoreDC                                = $DC       ;</span>
    <span class="string">.tempStoreDD                                = $DD       ;</span>
    <span class="string">.tempStoreDE                                = $DE       ;</span>
    <span class="string">.tempStoreDF                                = $DF       ;</span>
    <span class="string">.vduMultiplicationTableLow                  = $E0       ;</span>
    <span class="string">.vduMultiplicationTableHigh                 = $E1       ;</span>
    <span class="string">.tapeROMFSStatusByte                        = $E2       ; bit 0  input file open</span>
                                                            <span class="string">; bit 1  output file open</span>
                                                            <span class="string">; bit 2  not used</span>
                                                            <span class="string">; bit 3  current CATalogue status</span>
                                                            <span class="string">; bit 4  not used</span>
                                                            <span class="string">; bit 5  not used</span>
                                                            <span class="string">; bit 6  EOF reached</span>
                                                            <span class="string">; bit 7  EOF warning given</span>

    <span class="string">.tapeOptionsByte                            = $E3       ; options byte for tape filing system</span>
                                                            <span class="string">;</span>
                                                            <span class="string">; Options are stored in top four bits (for LOAD/SAVE) and</span>
                                                            <span class="string">; bottom four bits (for sequential access)</span>
                                                            <span class="string">;</span>
                                                            <span class="string">;   bit 0/4 = Abort bit</span>
                                                            <span class="string">;   bit 1/5 = Retry bit</span>
                                                            <span class="string">;   bit 2/6 } Message type: 00 = no messages</span>
                                                            <span class="string">;   bit 3/7 }             : 10 = short messages</span>
                                                            <span class="string">;           }             : 11 = long messages</span>
                                                            <span class="string">;</span>
                                                            <span class="string">; 0000     Ignore errors         no messages</span>
                                                            <span class="string">; 0001     Abort if error        no messages</span>
                                                            <span class="string">; 0010     Retry after error     no messages</span>
                                                            <span class="string">; 1000     Ignore error          short messages</span>
                                                            <span class="string">; 1001     Abort if error        short messages</span>
                                                            <span class="string">; 1010     Retry after error     short messages</span>
                                                            <span class="string">; 1100     Ignore error          long messages</span>
                                                            <span class="string">; 1101     Abort if error        long messages</span>
                                                            <span class="string">; 1110     Retry after error     long messages</span>

    <span class="string">.stringInputTempE4                          = $E4</span>
    <span class="string">.starCommandYParameter                      = $E4</span>
    <span class="string">.stringInputTempE5                          = $E5</span>
    <span class="string">.starCommandXParameter                      = $E5</span>
    <span class="string">.readCharacterTimedFlag                     = $E6       ; 0 means read key instantly; 255 means read key timed</span>
    <span class="string">.tempWorkspaceE6                            = $E6       ; general workspace</span>
    <span class="string">.currentStringPointer                       = $E6       ; offset within command string</span>

    <span class="string">.autorepeatCountdownTimer                   = $E7</span>
    <span class="string">.osword0BufferAddressLow                    = $E8       ; Reading line from input by OSWORD 0</span>
    <span class="string">.osword0BufferAddressHigh                   = $E9       ;</span>
    <span class="string">.rs423TimeoutCounter                        = $EA       ; 1 means the cassette filing system has control</span>
                                                            <span class="string">; 0 means RS423 has control, but has timed out</span>
                                                            <span class="string">; &lt;0 means RS423 has control, not yet timed out</span>
    <span class="string">.tapeCritical                               = $EB       ; bit 7 set while doing a BGET/BPUT (other bits ignored)</span>

    <span class="string">.keyPressedInternalTable                    = $EC       ; three byte table of keyboard keys</span>
    <span class="string">.lastKeyPressedInternal                     = $EC       ;</span>
    <span class="string">.firstKeyPressedInternal                    = $ED       ;</span>
    <span class="string">.keyToIgnoreInternal                        = $EE       ; key to ignore</span>
    <span class="string">.osbyteA                                    = $EF</span>
    <span class="string">.oswordA                                    = $EF</span>
    <span class="string">.osbyteX                                    = $F0</span>
    <span class="string">.oswordX                                    = $F0</span>
    <span class="string">.stackPointerLastBRK                        = $F0</span>
    <span class="string">.osbyteY                                    = $F1</span>
    <span class="string">.oswordY                                    = $F1</span>
    <span class="string">.stringInputBufferAddressLow                = $F2       ; } Start address of string for user input</span>
    <span class="string">.stringInputBufferAddressHigh               = $F3       ; }</span>

    <span class="string">.currentlySelectedROM                       = $F4</span>
    <span class="string">.currentLogicalSpeechPHROMOrROMFSNumber     = $F5       ; ROM number for current Speech PHROM (if bit 7 set)</span>
                                                            <span class="string">;         or for current ROMFS        (if bit 7 clear)</span>

    <span class="string">.romAddressLow                              = $F6       ;</span>
    <span class="string">.romAddressHigh                             = $F7       ;</span>

    <span class="string">; $F8 unused</span>
    <span class="string">; $F9 unused</span>

    <span class="string">.tempStoreFA                                = $FA</span>
    <span class="string">.tempStoreFB                                = $FB</span>
    <span class="string">.interruptAccumulator                       = $FC</span>

    <span class="string">.brkAddressLow                              = $FD       ; } address after last BRK</span>
    <span class="string">.brkAddressHigh                             = $FE       ; }</span>

    <span class="string">.languageVersionString                      = $FD       ; dual use variable</span>
    <span class="string">.displayStringAddressLow                    = $FD       ; dual use variable</span>
    <span class="string">.displayStringAddressHigh                   = $FE</span>
    <span class="string">.escapeFlag                                 = $FF       ; the ESCAPE flag</span>

    <span class="string">.systemVariableBase                         = $0190</span>

    <span class="string">.page2Start                                 = $0200</span>

    <span class="string">; Vectors (See NAUG Section 6, Page 102)</span>
    <span class="string">.vectorUSERV                                = $0200     ; User vector</span>
    <span class="string">.vectorBRKV                                 = $0202     ; BRK vector</span>
    <span class="string">.vectorIRQ1V                                = $0204     ; Primary IRQ vector</span>
    <span class="string">.vectorIRQ2V                                = $0206     ; Unrecognised IRQ vector</span>
    <span class="string">.vectorCLIV                                 = $0208     ; Command line interpreter</span>
    <span class="string">.vectorBYTEV                                = $020A     ; OSBYTE call</span>
    <span class="string">.vectorWORDV                                = $020C     ; OSWORD call</span>
    <span class="string">.vectorWRCHV                                = $020E     ; OSWRCH call</span>
    <span class="string">.vectorRDCHV                                = $0210     ; OSRDCH call</span>
    <span class="string">.vectorFILEV                                = $0212     ; Load / Save file</span>
    <span class="string">.vectorARGSV                                = $0214     ; Load / Save file parameters</span>
    <span class="string">.vectorBGETV                                = $0216     ; Get byte from file</span>
    <span class="string">.vectorBPUTV                                = $0218     ; Put byte to file</span>
    <span class="string">.vectorGBPBV                                = $021A     ; Multiple BPUT/BGET</span>
    <span class="string">.vectorFINDV                                = $021C     ; Open / Close file</span>
    <span class="string">.vectorFSCV                                 = $021E     ; filing system control</span>
    <span class="string">.vectorEVNTV                                = $0220     ; events</span>
    <span class="string">.vectorUPTV                                 = $0222     ; User print</span>
    <span class="string">.vectorNETV                                 = $0224     ; Econet</span>
    <span class="string">.vectorVDUV                                 = $0226     ; Called for unrecognised PLOT / VDU 23 commands</span>
    <span class="string">.vectorKEYV                                 = $0228     ; Keyboard</span>
    <span class="string">.vectorINSV                                 = $022A     ; Insert character into buffer</span>
    <span class="string">.vectorREMV                                 = $022C     ; Remove character from buffer</span>
    <span class="string">.vectorCNPV                                 = $022E     ; Count/purge buffer</span>
    <span class="string">.vectorIND1V                                = $0230     ; Spare vector</span>
    <span class="string">.vectorIND2V                                = $0232     ; Spare vector</span>
    <span class="string">.vectorIND3V                                = $0234     ; Spare vector</span>

    <span class="string">; $0236/7 = start address of MOS variables         (.systemVariableBase)     ; (Read using OSBYTE 166/167)</span>
    <span class="string">; $0238/9 = start address of ROM pointer table     (.extendedVectorSpace)    ; (Read using OSBYTE 168/169)</span>
    <span class="string">; $023A/B = start address of ROM information table (.romTypeTable)           ; (Read using OSBYTE 170/171)</span>
    <span class="string">; $023C/D = start address of key translation table (.keyDataBlock1 - 16)     ; (Read using OSBYTE 172/173)</span>
    <span class="string">; $023E/F = start address of VDU variables         (.vduVariablesStart)      ; (Read using OSBYTE 174/175)</span>

    <span class="string">.verticalSyncCounter                        = $0240     ; Decremented every vertical sync           (Read/Write using OSBYTE 176)</span>
    <span class="string">.currentInputBuffer                         = $0241     ; Buffer number for current input           (Read/Write using OSBYTE 177) (e.g. 0=keyboard; 1=RS423)</span>
    <span class="string">.keyboardSemaphore                          = $0242     ; 0 means keyboard interrupts are ignored, 255 means they are enabled (Read/Write using OSBYTE 178)</span>
    <span class="string">.defaultPAGE                                = $0243     ; also known as default/primary OSHWM       (Read/Write using OSBYTE 179)</span>
    <span class="string">.currentPAGE                                = $0244     ; also known as current OSHWM               (Read/Write using OSBYTE 180)</span>
    <span class="string">.rs423Mode                                  = $0245     ; RS423 mode (1 is default)                 (Read/Write using OSBYTE 181)</span>
                                                            <span class="string">;   0 means treat RS423 input same as keyboard</span>
                                                            <span class="string">;   1 means ESCAPE is ignored; soft keys are not expanded; no events are triggered</span>
    <span class="string">.softCharacterDefinitionsSwitch             = $0246     ; which ranges characters are SOFT character definitions (i.e. the value for *FX 20,X) (Read using OSBYTE 182)</span>
    <span class="string">.tapeOrRomSwitch                            = $0247     ; 0 is *TAPE, 2 = *ROM                      (Read/Write using OSBYTE 183)</span>
    <span class="string">.videoULAVideoControlRegisterCopy           = $0248     ; OS copy of video control register         (Read using OSBYTE 184)</span>
    <span class="string">.videoULAPaletteValue                       = $0249     ; value last written to the palette</span>
                                                            <span class="string">; (bits 0-3: physical colour EOR 7; bits 4-7:logical colour) (Read using OSBYTE 185)</span>
    <span class="string">.romNumberActiveLastBRK                     = $024A     ; ROM socket number when last BRK occurred  (Read using OSBYTE 186)</span>
    <span class="string">.basicROMNumber                             = $024B     ; ROM socket number containing BASIC or $FF (Read using OSBYTE 187)</span>
    <span class="string">.adcCurrentChannel                          = $024C     ; current ADC channel number                (Read using OSBYTE 188)</span>
    <span class="string">.maximumADCChannelNumber                    = $024D     ; read maximum ADC channel number           (Read using OSBYTE 189)</span>
    <span class="string">.adcConversionType                          = $024E     ; ADC conversion type [0 = default (12 bits); 8 = 8 bits; 12 = 12 bits] (Read/Write using OSBYTE 190)</span>
    <span class="string">.rs423ReadyFlag                             = $024F     ; bit 7 set means RS423 is ready; otherwise RS423 is busy (Read/Write using OSBYTE 191)</span>
    <span class="string">.rs423ControlRegisterCopy                   = $0250     ; OS copy of the RS423 control flag         (Read/Write using OSBYTE 192)</span>
    <span class="string">.videoULAFlashingColourIntervalCount        = $0251     ; counts down time before flashing the colours (Read/Write using OSBYTE 193)</span>
    <span class="string">.videoULAFirstFlashingColourInterval        = $0252     ; number of frames to spend on the first flashing colour (Read/Write using OSBYTE 194, but prefer OSBYTE 9)</span>
    <span class="string">.videoULASecondFlashingColourInterval       = $0253     ; number of frames to spend on the second flashing colour (Read/Write using OSBYTE 195, but prefer OSBYTE 10)</span>
    <span class="string">.keyboardAutorepeatDelay                    = $0254     ; delay before a key held down autorepeats in centiseconds (Read/write using OSBYTE 196, but prefer OSBYTE 11)</span>
    <span class="string">.keyboardAutoRepeatRate                     = $0255     ; keyboard autorepeat rate in centiseconds  (Read/write using OSBYTE 197, but prefer OSBYTE 12)</span>
    <span class="string">.execFileHandle                             = $0256     ; file handle of open EXEC file or zero if none open (Read/Write using OSBYTE 198)</span>
    <span class="string">.spoolFileHandle                            = $0257     ; file handle of open SPOOL file or zero if none open (Read/Write using OSBYTE 199)</span>
    <span class="string">.escapeAndBreakEffect                       = $0258     ; bit 0 set disables ESCAPE; bit 1 set clears memory on BREAK (Read/write using OSBYTE 200)</span>
    <span class="string">.keyboardDisableFlag                        = $0259     ; 0=Normal; otherwise ignore all keys except ESCAPE (Read/Write using OSBYTE 201)</span>
    <span class="string">.keyboardStatusFlags                        = $025A     ; (Read/Write using OSBYTE 202)</span>
                                                            <span class="string">; Bit 3 = 1 means shift pressed</span>
                                                            <span class="string">; Bit 4 = 0 means caps lock engaged</span>
                                                            <span class="string">; bit 5 = 0 means shift lock engaged</span>
                                                            <span class="string">; Bit 6 = 1 means control pressed</span>
                                                            <span class="string">; Bit 7 = 1 means shift enabled</span>
    <span class="string">.rs423HandshakeExtent                       = $025B     ; How many bytes free at the point we deal with a full buffer (Read/Write using OSBYTE 203)</span>
    <span class="string">.rs423InputSuppressionFlag                  = $025C     ; Non-zero value inhibits RS423 input       (Read/Write using OSBYTE 204)</span>
    <span class="string">.tapeRS423SelectionFlag                     = $025D     ; 0 = RS423; $40 = TAPE (Comes into effect when using OSBYTE 7/8 to change) (Read/Write using OSBYTE 205)</span>
    <span class="string">.econetOSCallInterceptionFlag               = $025E     ; bit 7 set sends OS calls through the econet vector (Read/Write using OSBYTE 206)</span>
    <span class="string">.econetReadCharacterInterpretationStatus    = $025F     ; read character from ECONET if bit 7 set   (Read/Write using OSBYTE 207)</span>
    <span class="string">.econetWriteCharacterInterceptionStatus     = $0260     ; bit 7 set means direct the character to write to ECONET (Read/Write using OSBYTE 208)</span>
    <span class="string">.speechSuppressionStatus                    = $0261     ; $50 to enable speech; $20 to disable      (Read/Write using OSBYTE 209)</span>
    <span class="string">.soundDisableFlag                           = $0262     ; non-zero disables sound                   (Read/Write using OSBYTE 210)</span>
    <span class="string">.soundBELLChannel                           = $0263     ; sound channel for CTRL-G BELL             (Read/Write using OSBYTE 211)</span>
    <span class="string">.soundBELLAmplitudeEnvelope                 = $0264     ; sound amplitude/envelope for CTRL-G BELL  (Read/Write using OSBYTE 212)</span>
    <span class="string">.soundBELLFrequency                         = $0265     ; sound frequency for CTRL-G BELL           (Read/Write using OSBYTE 213)</span>
    <span class="string">.soundBELLDuration                          = $0266     ; sound duration for CTRL-G BELL            (Read/Write using OSBYTE 214)</span>
    <span class="string">.startupMessageSuppressionAndBootOptions    = $0267     ; bit 7 = 0 means ignore OS startup message (Read/Write using OSBYTE 215)</span>
                                                            <span class="string">; bit 0 = 1 means if !BOOT errors from DISC because no language found, then lock up machine</span>
                                                            <span class="string">; bit 0 = 0 means if !BOOT errors from *ROM because no language found, then lock up machine</span>
    <span class="string">.softKeyStringLength                        = $0268     ; length of the current soft key string being decoded (Read/Write using OSBYTE 216)</span>
    <span class="string">.pagedModeCounter                           = $0269     ; number of lines printed since last paged mode pause (Read/Write using OSBYTE 217)</span>
    <span class="string">.twosComplimentOfNumberOfBytesInVDUQueue    = $026A     ; 255 - bytes in vdu queue                  (Read/Write using OSBYTE 218)</span>
    <span class="string">.asciiCodeGeneratedByTABKey                 = $026B     ; ASCII value to be produced by TAB         (Read/Write using OSBYTE 219)</span>
    <span class="string">.asciiCodeThatGeneratesESCAPEAction         = $026C     ; key's ASCII code that will generate an ESCAPE action (Read/Write using OSBYTE 220)</span>

    <span class="string">.functionAndCursorKeyCodes                  = $026D     ; 8 bytes here TODO: Explain this more</span>
                                                            <span class="string">; 0=ignore key, 1=expand as 'soft' key</span>
                                                            <span class="string">; 2-$FF add this to base for ASCII code</span>
                                                            <span class="string">; note that provision is made for keypad operation</span>
                                                            <span class="string">; as codes $C0-$FF cannot be generated from keyboard</span>
                                                            <span class="string">; but are recognised by OS</span>

    <span class="string">.escapeAction                               = $0275     ; 0 = normal ESCAPE action; otherwise ASCII (Read/Write using OSBYTE 229)</span>
    <span class="string">.escapeEffects                              = $0276     ; 0 = ESCAPE cleared, EXEC file closed, All buffers purged, Reset VDU paging counter; otherwise nothing.</span>
                                                            <span class="string">;                                           (Read/Write using OSBYTE 230)</span>
    <span class="string">.userVIAIRQBitMask                          = $0277     ;                                           (Read using OSBYTE 231)</span>
    <span class="string">.rs423IRQBitMask                            = $0278     ;                                           (Read using OSBYTE 232)</span>
    <span class="string">.systemVIAIRQBitMask                        = $0279     ;                                           (Read using OSBYTE 233)</span>
    <span class="string">.tubePresentFlag                            = $027A     ; 0 = no Tube; 255 = Tube present           (Read using OSBYTE 234)</span>
    <span class="string">.speechSystemPresentFlag                    = $027B     ; 0 = no speech; 255 = SPEECH present       (Read using OSBYTE 235)</span>

    <span class="string">.characterDestinationStatus                 = $027C     ; bit 0 - enable RS423 driver               (Read using OSBYTE 236)</span>
                                                            <span class="string">; bit 1 - disable VDU driver</span>
                                                            <span class="string">; bit 2 - disable printer driver</span>
                                                            <span class="string">; bit 3 - enable printer, independent of CTRL-B/C</span>
                                                            <span class="string">; bit 4 - disable SPOOLed output</span>
                                                            <span class="string">; bit 5 - not used</span>
                                                            <span class="string">; bit 6 - disable printed driver (unless preceded by VDU 1)</span>
                                                            <span class="string">; bit 7 - not used</span>
    <span class="string">.cursorEditingState                         = $027D     ; 0 = normal cursor editing                 (Read using OSBYTE 237)</span>
                                                            <span class="string">; 1=disable (cursor keys return codes $87-$8B)</span>
                                                            <span class="string">; 2=disable (cursor keys and COPY key are soft keys 11=COPY,12=LEFT,13=RIGHT,14=DOWN,15=UP)</span>

    <span class="string">; $027E is unused (Read/Write using OSBYTE 238)</span>
    <span class="string">; $027F is unused (Read/Write using OSBYTE 239)</span>

    <span class="string">.countryCode                                = $0280     ; 0 = UK; 1 = US; (not used by the OS) (Read/Write using OSBYTE 240)</span>
    <span class="string">.userFlag                                   = $0281     ; free for use by an application (not used by the OS) (Read/Write with OSBYTE 241, but prefer using OSBYTE 1)</span>

    <span class="string">.serialULARegisterCopy                      = $0282     ; Copy of the serial ULA control register   (Read using OSBYTE 242)</span>
    <span class="string">.timeClockSwitch                            = $0283     ; which five byte clock is in currently use (5 or 10) (Read using OSBYTE 243)</span>
    <span class="string">.softKeyConsistencyFlag                     = $0284     ; 0 = consistent, non-zero means inconsistent (Read/Write using OSBYTE 244)</span>
    <span class="string">.printerDestination                         = $0285     ; 0 = no printer output                     (Read/Write using OSBYTE 245)</span>
                                                            <span class="string">; 1 = parallel printer</span>
                                                            <span class="string">; 2 = serial printer</span>
                                                            <span class="string">; 3 = user printer routine</span>
                                                            <span class="string">; 4 = net printer</span>
                                                            <span class="string">; 5-255 = user printer routine</span>
    <span class="string">.printerIgnoreCharacter                     = $0286     ; Character that the printer ignores        (Read/Write using OSBYTE 246)</span>
    <span class="string">.breakInterceptJMPInstruction               = $0287     ; }                                         (Read/Write using OSBYTE 247)</span>
    <span class="string">.breakInterceptLowAddress                   = $0288     ; } Three bytes form a 'JMP address' instruction, activated on BREAK (Read/Write using OSBYTE 248)</span>
    <span class="string">.breakInterceptHighAddress                  = $0289     ; }                                         (Read/Write using OSBYTE 249)</span>

    <span class="string">; $028A is unused (Read/Write using OSBYTE 250)</span>
    <span class="string">; $028B is unused (Read/Write using OSBYTE 251)</span>

    <span class="string">.languageRomNumber                          = $028C     ; ROM Number for current language           (Read/Write using OSBYTE 252)</span>
    <span class="string">.lastResetType                              = $028D     ; What type of reset was last done?         (Read/Write using OSBYTE 253)</span>
                                                            <span class="string">;        0    Soft reset (BREAK)</span>
                                                            <span class="string">;        1    Power on</span>
                                                            <span class="string">;        2    Hard reset (CTRL-BREAK)</span>
                                                            <span class="string">; Only used during the boot sequence itself</span>
    <span class="string">.systemAvailableRAM                         = $028E     ; $40 = 16k (usually Model A); $80 = 32k (usually Model B) (Read using OSBYTE 254)</span>
    <span class="string">.startUpOptions                             = $028F     ; bits 0-2 are the initial MODE</span>
                                                            <span class="string">; bit 3 (if clear, reverses the action of SHIFT-BREAK)</span>
                                                            <span class="string">; bits 4-5 are disc drive timings</span>
                                                            <span class="string">; bits 6-7 unused (Read/Write with OSBYTE 255)</span>

    <span class="string">.hardResetLWM                               = $0290     ; Low water mark for resetting variables on a hard reset / power on reset</span>
                                                            <span class="string">; (variables are reset from here to end of page)</span>
    <span class="string">.vduVerticalAdjust                          = $0290     ; *TV value</span>
    <span class="string">.vduInterlaceValue                          = $0291     ; *TV interlace value</span>
    <span class="string">.timeClockA                                 = $0292     ; } 5 byte clock as read by TIME</span>
    <span class="string">.timeClockB                                 = $0297     ; } read and write alternates between these two 5 byte buffers (see .timeClockSwitch)</span>
    <span class="string">.countdownIntervalTimer                     = $029C     ; 5 byte countdown interval timer (used to cause an EVENT when it reaches zero)</span>

    <span class="string">.softResetLWM                               = $029C     ; Low water mark for resetting variables on a soft reset (sets variables from here to end of page)</span>
    <span class="string">.romTypeTable                               = $02A1     ; The type of each of the sixteen ROMs $02A1-$2B0</span>
    <span class="string">.inkeyTimeoutCounterLow                     = $02B1     ; }</span>
    <span class="string">.inkeyTimeoutCounterHigh                    = $02B2     ; } 16 bit value that is decremented at 100Hz while processing a timed keyboard read</span>

    <span class="string">.osword0MaxLineLength                       = $02B3     ; }</span>
    <span class="string">.osword0MinASCIICharacter                   = $02B4     ; } copies of the values in the OSWORD 0 parameter block</span>
    <span class="string">.osword0MaxASCIICharacter                   = $02B5     ; }</span>
    <span class="string">.lowByteLastByteFromADCChannel1             = $02B6     ;</span>
    <span class="string">.lowByteLastByteFromADCChannel2             = $02B7     ;</span>
    <span class="string">.lowByteLastByteFromADCChannel3             = $02B8     ;</span>
    <span class="string">.lowByteLastByteFromADCChannel4             = $02B9     ;</span>
    <span class="string">.highByteLastByteFromADCChannel1            = $02BA     ;</span>
    <span class="string">.highByteLastByteFromADCChannel2            = $02BB     ;</span>
    <span class="string">.highByteLastByteFromADCChannel3            = $02BC     ;</span>
    <span class="string">.highByteLastByteFromADCChannel4            = $02BD     ;</span>
    <span class="string">.analogueSystemFlag                         = $02BE     ;</span>

    <span class="string">.eventEnabledFlags                          = $02BF     ;</span>
    <span class="string">.outputBufferEmptyEventEnabled              = $02BF     ;</span>
    <span class="string">.inputBufferFullEventEnabled                = $02C0     ;</span>
    <span class="string">.characterEnteringBufferEventEnabled        = $02C1     ;</span>
    <span class="string">.adcConversionCompleteEventEnabled          = $02C2     ;</span>
    <span class="string">.startOfVSyncEventEnabled                   = $02C3     ;</span>
    <span class="string">.intervalTimerCrossingZeroEventEnabled      = $02C4     ;</span>
    <span class="string">.escapeConditionEventEnabled                = $02C5     ;</span>
    <span class="string">.rs423ErrorDetectedEventEnabled             = $02C6     ;</span>
    <span class="string">.econetGeneratedEventEnabled                = $02C7     ;</span>
    <span class="string">.userEventEnabled                           = $02C8     ;</span>
    <span class="string">.softKeyExpansionPointer                    = $02C9     ; Next byte to expand is at: $0B09 + .softKeyExpansionPointer</span>

    <span class="string">.keyboardFirstAutorepeatCount               = $02CA     ;</span>
    <span class="string">.keyboardWorkspaceA                         = $02CB     ;</span>
    <span class="string">.keyboardWorkspaceB                         = $02CC     ;</span>
    <span class="string">.keyboardWorkspaceC                         = $02CD     ;</span>

    <span class="string">.soundSemaphore                             = $02CE     ;</span>

    <span class="string">.bufferEmptyFlags                           = $02CF     ;</span>
    <span class="string">.keyboardBufferEmptyFlag                    = $02CF     ; }</span>
    <span class="string">.rs423InputBufferEmptyFlag                  = $02D0     ; }</span>
    <span class="string">.rs423OutputBufferEmptyFlag                 = $02D1     ; }</span>
    <span class="string">.printerBufferEmptyFlag                     = $02D2     ; }</span>
    <span class="string">.soundChannel0BufferEmptyFlag               = $02D3     ; } Bit 7 set if buffer is empty</span>
    <span class="string">.soundChannel1BufferEmptyFlag               = $02D4     ; }</span>
    <span class="string">.soundChannel2BufferEmptyFlag               = $02D5     ; }</span>
    <span class="string">.soundChannel3BufferEmptyFlag               = $02D6     ; }</span>
    <span class="string">.speechBufferEmptyFlag                      = $02D7     ; }</span>

    <span class="string">.bufferStartIndices                         = $02D8     ;</span>
    <span class="string">.keyboardBufferStartIndex                   = $02D8     ; }</span>
    <span class="string">.rs423InputBufferStartIndex                 = $02D9     ; }</span>
    <span class="string">.rs423OutputBufferStartIndex                = $02DA     ; }</span>
    <span class="string">.printerBufferStartIndex                    = $02DB     ; } Offset to next byte to be removed</span>
    <span class="string">.soundChannel0BufferStartIndex              = $02DC     ; } Highest location in each buffer has offset $FF</span>
    <span class="string">.soundChannel1BufferStartIndex              = $02DD     ; }</span>
    <span class="string">.soundChannel2BufferStartIndex              = $02DE     ; }</span>
    <span class="string">.soundChannel3BufferStartIndex              = $02DF     ; }</span>
    <span class="string">.speechBufferEmptyStartIndex                = $02E0     ; }</span>

    <span class="string">.bufferEndIndices                           = $02E1     ;</span>
    <span class="string">.keyboardBufferEndIndex                     = $02E1     ; }</span>
    <span class="string">.rs423InputBufferEndIndex                   = $02E2     ; }</span>
    <span class="string">.rs423OutputBufferEndIndex                  = $02E3     ; }</span>
    <span class="string">.printerBufferEndIndex                      = $02E4     ; }</span>
    <span class="string">.soundChannel0BufferEndIndex                = $02E5     ; } Offset to last byte entered in each buffer</span>
    <span class="string">.soundChannel1BufferEndIndex                = $02E6     ; }</span>
    <span class="string">.soundChannel2BufferEndIndex                = $02E7     ; }</span>
    <span class="string">.soundChannel3BufferEndIndex                = $02E8     ; }</span>
    <span class="string">.speechBufferEmptyEndIndex                  = $02E9     ; }</span>

    <span class="string">.tapeInputCurrentBlockSizeLow               = $02EA     ;</span>
    <span class="string">.tapeInputCurrentBlockSizeHigh              = $02EB     ;</span>

    <span class="string">.blockFlagOfCurrentlyResidentBlock          = $02EC     ; bit 0 = *RUN only</span>
                                                            <span class="string">; bit 6 = no data</span>
                                                            <span class="string">; bit 7 = last block</span>
    <span class="string">.lastCharacterOfCurrentlyResidentBlock      = $02ED     ;</span>

    <span class="string">.osfileBlockStart                           = $02EE     ;</span>
    <span class="string">.osfileFilenameAddressLow                   = $02EE     ;</span>
    <span class="string">.osfileFilenameAddressHigh                  = $02EF     ;</span>
    <span class="string">.osfileLoadAddressLow                       = $02F0     ;</span>
    <span class="string">.osfileLoadAddressMid1                      = $02F1     ;</span>
    <span class="string">.osfileLoadAddressMid2                      = $02F2     ;</span>
    <span class="string">.osfileLoadAddressHigh                      = $02F3     ;</span>
    <span class="string">.osfileExecAddressLow                       = $02F4     ;</span>
    <span class="string">.osfileExecAddressMid1                      = $02F5     ;</span>
    <span class="string">.osfileExecAddressMid2                      = $02F6     ;</span>
    <span class="string">.osfileExecAddressHigh                      = $02F7     ;</span>
    <span class="string">.osfileStartAddressLow                      = $02F8     ;</span>
    <span class="string">.osfileStartAddressMid1                     = $02F9     ;</span>
    <span class="string">.osfileStartAddressMid2                     = $02FA     ;</span>
    <span class="string">.osfileStartAddressHigh                     = $02FB     ;</span>
    <span class="string">.osfileEndAddressLow                        = $02FC     ;</span>
    <span class="string">.osfileEndAddressMid1                       = $02FD     ;</span>
    <span class="string">.osfileEndAddressMid2                       = $02FE     ;</span>
    <span class="string">.osfileEndAddressHigh                       = $02FF     ;</span>


    <span class="string">.vduVariablesStart                          = $0300     ;</span>

    <span class="string">.vduGraphicsWindowPixelsLeftLow             = $0300     ; }</span>
    <span class="string">.vduGraphicsWindowPixelsLeftHigh            = $0301     ; }</span>
    <span class="string">.vduGraphicsWindowPixelsBottomLow           = $0302     ; }</span>
    <span class="string">.vduGraphicsWindowPixelsBottomHigh          = $0303     ; }</span>
    <span class="string">.vduGraphicsWindowPixelsRightLow            = $0304     ; } graphics window in pixels</span>
    <span class="string">.vduGraphicsWindowPixelsRightHigh           = $0305     ; }</span>
    <span class="string">.vduGraphicsWindowPixelsTopLow              = $0306     ; }</span>
    <span class="string">.vduGraphicsWindowPixelsTopHigh             = $0307     ; }</span>

    <span class="string">.vduTextWindowLeft                          = $0308     ; }</span>
    <span class="string">.vduTextWindowBottom                        = $0309     ; }</span>
    <span class="string">.vduTextWindowRight                         = $030A     ; } text window</span>
    <span class="string">.vduTextWindowTop                           = $030B     ; }</span>

    <span class="string">.vduGraphicsWindowOriginXLow                = $030C     ; }</span>
    <span class="string">.vduGraphicsWindowOriginXHigh               = $030D     ; } graphics origin in external coordinates</span>
    <span class="string">.vduGraphicsWindowOriginYLow                = $030E     ; }</span>
    <span class="string">.vduGraphicsWindowOriginYHigh               = $030F     ; }</span>

    <span class="string">.vduGraphicsCursorPositionXLow              = $0310     ; }</span>
    <span class="string">.vduGraphicsCursorPositionXHigh             = $0311     ; } graphics cursor position in external coordinates</span>
    <span class="string">.vduGraphicsCursorPositionYLow              = $0312     ; } Used for calculating relative plots</span>
    <span class="string">.vduGraphicsCursorPositionYHigh             = $0313     ; }</span>

    <span class="string">.vduOldGraphicsCursorPixelsXLow             = $0314     ; }</span>
    <span class="string">.vduOldGraphicsCursorPixelsXHigh            = $0315     ; } old graphics cursor in pixels</span>
    <span class="string">.vduOldGraphicsCursorPixelsYLow             = $0316     ; }</span>
    <span class="string">.vduOldGraphicsCursorPixelsYHigh            = $0317     ; }</span>

    <span class="string">.vduTextCursorXPosition                     = $0318     ; } text cursor position</span>
    <span class="string">.vduTextCursorYPosition                     = $0319     ; }</span>

    <span class="string">.vduGraphicsCursorVerticalOffsetInCell      = $031A     ; offset within a character cell of the current graphics cursor Y coordinate</span>

    <span class="string">.vduQueueStartByte                          = $031B     ; vdu queue</span>
    <span class="string">.vduQueueWorkspaceA                         = $031B     ;</span>
    <span class="string">.vduQueueWorkspaceB                         = $031C     ;</span>
    <span class="string">.vduQueueEndByte                            = $0323     ;</span>

    <span class="string">.vduGraphicsCursorPixelsXLow                = $0324     ; current graphics cursor position in pixels</span>
    <span class="string">.vduGraphicsCursorPixelsXHigh               = $0325     ;</span>
    <span class="string">.vduGraphicsCursorPixelsYLow                = $0326     ;</span>
    <span class="string">.vduGraphicsCursorPixelsYHigh               = $0327     ;</span>

    <span class="string">.vduWorkspaceA                              = $0328     ; workspace</span>
    <span class="string">.vduWorkspaceB                              = $0329     ;</span>
    <span class="string">.vduWorkspaceC                              = $032A     ;</span>
    <span class="string">.vduWorkspaceD                              = $032B     ;</span>
    <span class="string">.vduWorkspaceE                              = $032C     ;</span>
    <span class="string">.vduWorkspaceF                              = $032D     ;</span>
    <span class="string">.vduWorkspaceG                              = $032E     ;</span>
    <span class="string">.vduWorkspaceH                              = $032F     ;</span>

    <span class="string">.vduClearGraphicsWindowLineCount            = $0330     ; line counter used in VDU 16 (clear graphics window)       } dual use</span>
    <span class="string">.vduPlotLineTerminationValueLow             = $0330     ; } final coordinate in the dominant axis, used to          } dual use</span>
    <span class="string">.vduPlotLineTerminationValueHigh            = $0331     ; } check when we are done plotting a line.</span>

    <span class="string">.vduRoutineLow                              = $0332     ;</span>
    <span class="string">.vduRoutineHigh                             = $0333     ;</span>

    <span class="string">.vduWorkspaceM                              = $0334     ;</span>
    <span class="string">.vduWorkspaceN                              = $0335     ;</span>
    <span class="string">.vduWorkspaceO                              = $0336     ;</span>
    <span class="string">.vduWorkspaceP                              = $0337     ;</span>
    <span class="string">.vduWorkspaceQ                              = $0338     ; } dual use (used for graphics workspace in a graphics mode; or MODE 7 cursor character)</span>
    <span class="string">.vduMode7CursorCharacter                    = $0338     ; }</span>
    <span class="string">.vduWorkspaceR                              = $0339     ;</span>
    <span class="string">.vduWorkspaceS                              = $033A     ;</span>

    <span class="string">.unused33B                                  = $033B     ; unused</span>
    <span class="string">.unused33C                                  = $033C     ; unused</span>

    <span class="string">.vduWorkspaceV                              = $033D     ; written to, but not read (i.e. unused?)</span>

    <span class="string">.unused33E                                  = $033E     ; unused</span>
    <span class="string">.unused33F                                  = $033F     ; unused</span>
    <span class="string">.unused340                                  = $0340     ; unused</span>
    <span class="string">.unused341                                  = $0341     ; unused</span>
    <span class="string">.unused342                                  = $0342     ; unused</span>
    <span class="string">.unused343                                  = $0343     ; unused</span>
    <span class="string">.unused344                                  = $0344     ; unused</span>
    <span class="string">.unused345                                  = $0345     ; unused</span>
    <span class="string">.unused346                                  = $0346     ; unused</span>
    <span class="string">.unused347                                  = $0347     ; unused</span>
    <span class="string">.unused348                                  = $0348     ; unused</span>
    <span class="string">.unused349                                  = $0349     ; unused</span>

    <span class="string">.vduTextCursorCRTCAddressLow                = $034A     ; shape of the cursor</span>
    <span class="string">.vduTextCursorCRTCAddressHigh               = $034B     ;</span>

    <span class="string">.vduTextWindowWidthInBytesLow               = $034C     ;</span>
    <span class="string">.vduTextWindowWidthInBytesHigh              = $034D     ;</span>

    <span class="string">.vduStartScreenAddressHighByte              = $034E     ;</span>
    <span class="string">.vduBytesPerCharacter                       = $034F     ;</span>
    <span class="string">.vduScreenTopLeftAddressLow                 = $0350     ;</span>
    <span class="string">.vduScreenTopLeftAddressHigh                = $0351     ;</span>

    <span class="string">.vduBytesPerCharacterRowLow                 = $0352     ;</span>
    <span class="string">.vduBytesPerCharacterRowHigh                = $0353     ;</span>
    <span class="string">.vduScreenSizeHighByte                      = $0354     ;</span>
    <span class="string">.vduCurrentScreenMode                       = $0355     ;</span>
    <span class="string">.vduCurrentScreenModeMemorySizeIndex        = $0356     ; Screen memory size: 0=20k (MODE 0,1,2); 1=16k (MODE 3); 2=10k (MODE 4,5); 3=8k (MODE 6); 4=1k (MODE 7)</span>
    <span class="string">.vduForegroundTextColour                    = $0357     ;</span>
    <span class="string">.vduBackgroundTextColour                    = $0358     ;</span>
    <span class="string">.vduForegroundGraphicsColour                = $0359     ;</span>
    <span class="string">.vduBackgroundGraphicsColour                = $035A     ;</span>
    <span class="string">.vduForegroundGCOLMode                      = $035B     ; GCOL foreground mode (0=Normal, 1=OR, 2=AND, 3=EOR, 4=Invert)</span>
    <span class="string">.vduBackgroundGCOLMode                      = $035C     ; GCOL background mode (0=Normal, 1=OR, 2=AND, 3=EOR, 4=Invert)</span>

    <span class="string">.vduJumpVectorLow                           = $035D     ;</span>
    <span class="string">.vduJumpVectorHigh                          = $035E     ;</span>

    <span class="string">.vduLastCursorStartRegisterValue            = $035F     ;</span>

    <span class="string">.vduNumberOfLogicalColoursMinusOne          = $0360     ;</span>
    <span class="string">.pixelsPerByteMinusOneForCurrentMode        = $0361     ;</span>

    <span class="string">.vduColourMaskLeft                          = $0362     ; Colour Mask Left.  Bits for the leftmost pixel:  In MODE 0,3,4,6,7 = $80; MODE 1,5 = $88; MODE 2 = $AA</span>
    <span class="string">.vduColourMaskRight                         = $0363     ; Colour Mask Right. Bits for the rightmost pixel: In MODE 0,3,4,6,7 = $01; MODE 1,5 = $11; MODE 2 = $55</span>
    <span class="string">.vduTextInputCursorXCoordinate              = $0364     ;</span>
    <span class="string">.vduTextInputCursorYCoordinate              = $0365     ;</span>
    <span class="string">.vduTeletextCharacterForCursor              = $0366     ;</span>
    <span class="string">.vduFontFlags                               = $0367     ; Which ranges of characters have SOFT character definitions</span>
                                                            <span class="string">;     bit 7 = characters  32-63</span>
                                                            <span class="string">;     bit 6 = characters  64-95</span>
                                                            <span class="string">;     bit 5 = characters  96-127</span>
                                                            <span class="string">;     bit 4 = characters 128-159</span>
                                                            <span class="string">;     bit 3 = characters 160-191</span>
                                                            <span class="string">;     bit 2 = characters 192-223</span>
                                                            <span class="string">;     bit 1 = characters 224-255</span>
                                                            <span class="string">;     bit 0 = unused</span>
    <span class="string">.vduFontZoneAddressesHigh                   = $0368     ; High byte of the address of a range of character definitions (in ROM or RAM)</span>
    <span class="string">.vduFontZoneAddressesHigh2                  = $0369     ; High byte of the address of a range of character definitions (in ROM or RAM)</span>
    <span class="string">.vduFontZoneAddressesHigh3                  = $036A     ; High byte of the address of a range of character definitions (in ROM or RAM)</span>
    <span class="string">.vduFontZoneAddressesHigh4                  = $036B     ; High byte of the address of a range of character definitions (in ROM or RAM)</span>
    <span class="string">.vduFontZoneAddressesHigh5                  = $036C     ; High byte of the address of a range of character definitions (in ROM or RAM)</span>
    <span class="string">.vduFontZoneAddressesHigh6                  = $036D     ; High byte of the address of a range of character definitions (in ROM or RAM)</span>
    <span class="string">.vduFontZoneAddressesHigh7                  = $036E     ; High byte of the address of a range of character definitions (in ROM or RAM)</span>

    <span class="string">.vduColourPaletteStart                      = $036F     ; } 16 bytes of palette information</span>
    <span class="string">.vduColourPaletteEnd                        = $037E     ; }</span>

    <span class="string">; $037F - unused</span>

    <span class="string">.vduVariablesEnd                            = $037F     ;</span>

    <span class="string">.tapeBlockHeaderStart                       = $0380     ;</span>
    <span class="string">.tapeBlockFilename                          = $0380     ; filename (11 bytes)</span>

    <span class="string">; $038B - unused?</span>

    <span class="string">.tapeBlockLoadAddressLow                    = $038C     ; }</span>
    <span class="string">.tapeBlockLoadAddressMid1                   = $038D     ; }</span>
    <span class="string">.tapeBlockLoadAddressMid2                   = $038E     ; } load address</span>
    <span class="string">.tapeBlockLoadAddressHigh                   = $038F     ; }</span>

    <span class="string">.tapeBlockExecutableAddressLow              = $0390     ; }</span>
    <span class="string">.tapeBlockExecutableAddressMid1             = $0391     ; }</span>
    <span class="string">.tapeBlockExecutableAddressMid2             = $0392     ; } executable address</span>
    <span class="string">.tapeBlockExecutableAddressHigh             = $0393     ; }</span>

    <span class="string">.tapeBlockNumberLow                         = $0394     ; block number (low byte)</span>
    <span class="string">.tapeBlockNumberHigh                        = $0395     ; block number (high byte)</span>
    <span class="string">.tapeBlockLengthLow                         = $0396     ;</span>
    <span class="string">.tapeBlockLengthHigh                        = $0397     ;</span>

    <span class="string">.tapeBlockFlagByte                          = $0398     ; top bit set to indicate the last block when closing a file for output</span>
    <span class="string">.tapeBlockSpareByteA                        = $0399     ;</span>
    <span class="string">.tapeBlockSpareByteB                        = $039A     ;</span>
    <span class="string">.tapeBlockSpareByteC                        = $039B     ;</span>
    <span class="string">.tapeBlockSpareByteD                        = $039C     ;</span>

    <span class="string">.bputBufferOffset                           = $039D     ; offset in buffer for next BPUT</span>
    <span class="string">.bgetBufferOffset                           = $039E     ; offset in buffer for next BGET</span>

    <span class="string">.bgetFilename                               = $03A7     ; zero terminated filename (11 bytes)</span>

    <span class="string">.fsFilename                                 = $03B2     ; zero terminated filename (11 bytes)</span>

    <span class="string">; $03BD - unused?</span>

    <span class="string">.fsLoadAddressLow                           = $03BE     ;</span>
    <span class="string">.fsLoadAddressMid1                          = $03BF     ;</span>
    <span class="string">.fsLoadAddressMid2                          = $03C0     ;</span>
    <span class="string">.fsLoadAddressHigh                          = $03C1     ;</span>
    <span class="string">.fsExecutionAddressLow                      = $03C2     ;</span>
    <span class="string">.fsExecutionAddressMid1                     = $03C3     ;</span>
    <span class="string">.fsExecutionAddressMid2                     = $03C4     ;</span>
    <span class="string">.fsExecutionAddressHigh                     = $03C5     ;</span>
    <span class="string">.fsBlockNumberLow                           = $03C6     ;</span>
    <span class="string">.fsBlockNumberHigh                          = $03C7     ;</span>
    <span class="string">.fsBlockLengthLow                           = $03C8     ;</span>
    <span class="string">.fsBlockLengthHigh                          = $03C9     ;</span>
    <span class="string">.fsBlockFlagByte                            = $03CA     ; block flag byte (bit 0=*RUN only; bit 7=last block)</span>
    <span class="string">.fsSpareByteA                               = $03CB     ;</span>
    <span class="string">.fsSpareByteB                               = $03CC     ;</span>
    <span class="string">.fsSpareByteC                               = $03CD     ;</span>
    <span class="string">.fsSpareByteD                               = $03CE     ;</span>

    <span class="string">.fsChecksumLow                              = $03CF     ;</span>
    <span class="string">.fsChecksumHigh                             = $03D0     ; checksum</span>

    <span class="string">.tapeInterBlockGap                          = $03D1     ; Time between SAVEing blocks to cassette (n/10) seconds (n&gt;0).</span>
    <span class="string">.filenameToSearchFor                        = $03D2     ; zero terminated filename (11 bytes)</span>
    <span class="string">.nextBGETBlockLow                           = $03DD     ;</span>
    <span class="string">.nextBGETBlockHigh                          = $03DE     ;</span>
    <span class="string">.fsLastBlockReadFlagsCopy                   = $03DF     ;</span>

    <span class="string">.keyboardInputBuffer                        = $03E0     ; keyboard input buffer (32 bytes)</span>

    <span class="string">.tubeCopyLanguageToSecondProcessor          = $0400     ;</span>
    <span class="string">.tubeCopyESCAPEFlagToSecondProcessor        = $0403     ;</span>
    <span class="string">.tubeTransferData                           = $0406     ;</span>

    <span class="string">.channel0Occupancy                          = $0804     ;</span>
    <span class="string">.channel1Occupancy                          = $0805     ;</span>
    <span class="string">.channel2Occupancy                          = $0806     ;</span>
    <span class="string">.channel3Occupancy                          = $0807     ;</span>

    <span class="string">.channel0Volume                             = $0808     ; }</span>
    <span class="string">.channel1Volume                             = $0809     ; }</span>
    <span class="string">.channel2Volume                             = $080A     ; } current volume</span>
    <span class="string">.channel3Volume                             = $080B     ; }</span>

    <span class="string">.channel0PhaseCounter                       = $080C     ; }</span>
    <span class="string">.channel1PhaseCounter                       = $080D     ; }</span>
    <span class="string">.channel2PhaseCounter                       = $080E     ; } phase counter for current amplitude envelope (which phase of 'ADSR' are we currently in?)</span>
    <span class="string">.channel3PhaseCounter                       = $080F     ; }</span>

    <span class="string">.channel0BasePitch                          = $0810     ; }</span>
    <span class="string">.channel1BasePitch                          = $0811     ; }</span>
    <span class="string">.channel2BasePitch                          = $0812     ; } base pitch number</span>
    <span class="string">.channel3BasePitch                          = $0813     ; }</span>

    <span class="string">.channel0Section                            = $0814     ; }</span>
    <span class="string">.channel1Section                            = $0815     ; }</span>
    <span class="string">.channel2Section                            = $0816     ; } current pitch section (0-2)</span>
    <span class="string">.channel3Section                            = $0817     ; }</span>

    <span class="string">.channel0SectionProgress                    = $0818     ; }</span>
    <span class="string">.channel1SectionProgress                    = $0819     ; }</span>
    <span class="string">.channel2SectionProgress                    = $081A     ; } current countdown timer within pitch section</span>
    <span class="string">.channel3SectionProgress                    = $081B     ; }</span>

    <span class="string">.channel0Duration                           = $081C     ; }</span>
    <span class="string">.channel1Duration                           = $081D     ; }</span>
    <span class="string">.channel2Duration                           = $081E     ; } remaining duration of current sound in 20ths of a second</span>
    <span class="string">.channel3Duration                           = $081F     ; }</span>

    <span class="string">.channel0Countdown                          = $0820     ; }</span>
    <span class="string">.channel1Countdown                          = $0821     ; }</span>
    <span class="string">.channel2Countdown                          = $0822     ; } Count from 5 to 0 to give a signal every 20th of a second</span>
    <span class="string">.channel3Countdown                          = $0823     ; }</span>

    <span class="string">.channel0EnvelopeOffset                     = $0824     ; }</span>
    <span class="string">.channel1EnvelopeOffset                     = $0825     ; }</span>
    <span class="string">.channel2EnvelopeOffset                     = $0826     ; } Offset from .envelopeBuffer of current envelope data (or $FF if no envelope in use)</span>
    <span class="string">.channel3EnvelopeOffset                     = $0827     ; }</span>

    <span class="string">.channel0StepProgress                       = $0828     ; }</span>
    <span class="string">.channel1StepProgress                       = $0829     ; }</span>
    <span class="string">.channel2StepProgress                       = $082A     ; } Step progress of current envelope</span>
    <span class="string">.channel3StepProgress                       = $082B     ; }</span>

    <span class="string">.channel0SyncFlag                           = $082C     ; }</span>
    <span class="string">.channel1SyncFlag                           = $082D     ; }</span>
    <span class="string">.channel2SyncFlag                           = $082E     ; } synchronising flag of current envelope</span>
    <span class="string">.channel3SyncFlag                           = $082F     ; }</span>

    <span class="string">.channel0Pitch                              = $0830     ; }</span>
    <span class="string">.channel1Pitch                              = $0831     ; }</span>
    <span class="string">.channel2Pitch                              = $0832     ; } pitch of current envelope</span>
    <span class="string">.channel3Pitch                              = $0833     ; }</span>

    <span class="string">.channel0Differential                       = $0834     ; }</span>
    <span class="string">.channel1Differential                       = $0835     ; }</span>
    <span class="string">.channel2Differential                       = $0836     ; } pitch differential?</span>
    <span class="string">.channel3Differential                       = $0837     ; }</span>

    <span class="string">.numberOfSoundChannelsRequiredForHold       = $0838     ;</span>
    <span class="string">.currentAmplitudeStep                       = $0839     ;</span>
    <span class="string">.targetAmplitude                            = $083A     ;</span>
    <span class="string">.numberOfSoundChannelsOnHold                = $083B     ;</span>

    <span class="string">.fractionalSemitones                        = $083C     ; When setting pitch, this is value 0-3 between semitones</span>

    <span class="string">.soundVariableA                             = $083D     ;</span>
    <span class="string">.soundVariableB                             = $083E     ;</span>
    <span class="string">.soundVariableC                             = $083F     ;</span>

    <span class="string">.soundChannel0Buffer                        = $0840     ; 16 byte sound buffer</span>
    <span class="string">.soundChannel1Buffer                        = $0850     ; 16 byte sound buffer</span>
    <span class="string">.soundChannel2Buffer                        = $0860     ; 16 byte sound buffer</span>
    <span class="string">.soundChannel3Buffer                        = $0870     ; 16 byte sound buffer</span>
    <span class="string">.printerBuffer                              = $0880     ; 64 byte printer buffer</span>

    <span class="string">.envelopeBuffer                             = $08C0     ;</span>

    <span class="string">.tapeOrRS423OutputBuffer                    = $0900     ;</span>
    <span class="string">.speechBuffer                               = $09C0     ;</span>
    <span class="string">.tapeOrRS423InputBuffer                     = $0A00     ;</span>
    <span class="string">.softKeyPage                                = $0B00     ;</span>
    <span class="string">.softKeysCurrentEndOffset                   = $0B10     ; offset to end character of all current soft key definitions</span>

    <span class="string">.softCharacterDefinitions                   = $0C00     ; Soft character definitions for characters 224-255</span>
    <span class="string">.nmiEntryPoint                              = $0D00     ; Non maskable interrupt routine</span>
    <span class="string">.extendedVectorSpace                        = $0D9F     ; Mechanism for changing vectors at $200+2*n to point into a paged ROM.</span>
                                                            <span class="string">; Pointer to table of 27 entries, where each entry contains three bytes:</span>
                                                            <span class="string">;   ROM address low</span>
                                                            <span class="string">;   ROM address high</span>
                                                            <span class="string">;   ROM number</span>

    <span class="string">.romStartAddress                            = $8000     ;</span>
    <span class="string">.romLanguageEntry                           = $8000     ;</span>
    <span class="string">.romServiceEntry                            = $8003     ;</span>
    <span class="string">.romTypeByte                                = $8006     ;</span>
    <span class="string">.romCopyrightOffsetPointer                  = $8007     ;</span>
    <span class="string">.romTitleString                             = $8009     ;</span>

    <span class="string">; FRED</span>
    <span class="string">.fredPage                                   = $FC00     ;</span>

    <span class="string">; JIM</span>
    <span class="string">.jimPage                                    = $FD00     ;</span>
    <span class="string">.jimPagedEntryPoint                         = $FDFE     ;</span>

    <span class="string">; SHEILA</span>
    <span class="string">.sheilaPage                                 = $FE00     ;</span>
    <span class="string">.crtcAddressRegister                        = $FE00     ;</span>
    <span class="string">.crtcAddressWrite                           = $FE01     ;</span>

    <span class="string">; 6850 ACIA, Control Register ($FE08)</span>
    <span class="string">;</span>
    <span class="string">;     bits 0,1 - counter divide select bits (CR0/CR1)</span>
    <span class="string">;          %00 - divide counter by 1</span>
    <span class="string">;          %01 - divide counter by 16                    (used for 1200 baud tape)</span>
    <span class="string">;          %10 - divide counter by 64 (default for RS423) (used for 300 baud tape)</span>
    <span class="string">;          %11 - master reset</span>
    <span class="string">;     bit 2 - set means odd parity; otherwise even parity</span>
    <span class="string">;     bit 3 - set means 1 stop bit; otherwise 2 stop bits</span>
    <span class="string">;     bit 4 - set means 8 bit word; otherwise 7 bit word</span>
    <span class="string">;     bits 5,6:</span>
    <span class="string">;          %00 - Request To Send (RTS) low, transmit interrupt disabled</span>
    <span class="string">;          %01 - RTS low, transmit interrupt enabled</span>
    <span class="string">;          %10 - RTS high, transmit interrupt disabled</span>
    <span class="string">;          %11 - RTS low, break level on data output, transmit interrupt disabled</span>
    <span class="string">;     bit 7 - enable receive data register full, overrun, DCD transition interrupts</span>
    <span class="string">;</span>
    <span class="string">;         DCD = Data Carrier Detect interrupt occurs when the tone at the end of a cassette block is discontinued</span>
    <span class="string">;</span>
    <span class="string">;     RTS low is the active state ('Ready To Send')</span>
    <span class="string">;</span>
    <span class="string">.acia6850ControlRegister                    = $FE08     ;</span>

    <span class="string">; 6850 ACIA, Status Register ($FE08)</span>
    <span class="string">;     note this is the same address as the Control Register (above), but</span>
    <span class="string">;     represents an entirely different set of data when reading from this address.</span>
    <span class="string">;</span>
    <span class="string">;     bit 0 - set when a receiver interrupt is generated</span>
    <span class="string">;     bit 1 - set when a transmit interrupt is generated</span>
    <span class="string">;     bit 2 - set when a Data Carrier Detect ('DCD') interrupt is generated</span>
    <span class="string">;     bit 3 - set if the 6850 is not clear to send (CTS)</span>
    <span class="string">;     bit 4 - framing error     } only valid if bit 0 set</span>
    <span class="string">;     bit 5 - receiver over run } only valid if bit 0 set</span>
    <span class="string">;     bit 6 - parity error      } only valid if bit 0 set</span>
    <span class="string">;     bit 7 - set if the 6850 generated the current interrupt</span>
    <span class="string">;</span>
    <span class="string">.acia6850StatusRegister                     = $FE08     ;</span>

    <span class="string">.acia6850DataRegister                       = $FE09     ; 6850 ACIA, transmit / receive data register ('TDR'/'RDR')</span>

    <span class="string">; Serial ULA, Control Register ($FE10):</span>
    <span class="string">;</span>
    <span class="string">;     bits 0-2 - transmit rate</span>
    <span class="string">;     bits 3-5 - receive rate</span>
    <span class="string">;                   %000    19200 baud</span>
    <span class="string">;                   %001     9600 baud</span>
    <span class="string">;                   %010     4800 baud</span>
    <span class="string">;                   %011     2400 baud</span>
    <span class="string">;                   %100     1200 baud</span>
    <span class="string">;                   %101      300 baud</span>
    <span class="string">;                   %110      150 baud</span>
    <span class="string">;                   %111       75 baud</span>
    <span class="string">;     bit 6 - if set, the RS423 system has control of the serial system; otherwise the cassette system has control</span>
    <span class="string">;     bit 7 - if set, switch on the cassette motor and relay</span>
    <span class="string">;</span>
    <span class="string">.serialULAControlRegister                   = $FE10     ; SERIAL ULA control register</span>

    <span class="string">.videoULAControlRegister                    = $FE20     ; Video ULA control register</span>
    <span class="string">.videoULAPaletteRegister                    = $FE21     ; Video ULA palette register</span>

    <span class="string">.romSelectRegister                          = $FE30     ;</span>


    <span class="string">; System VIA, Register B ($FE40)</span>
    <span class="string">;</span>
    <span class="string">; Notes:</span>
    <span class="string">;     Values 0-15 can be written to System VIA Port B:</span>
    <span class="string">;</span>
    <span class="string">;         Value   Effect</span>
    <span class="string">;         -------------------------</span>
    <span class="string">;         0       Enable sound chip</span>
    <span class="string">;         1       Enable Read Speech</span>
    <span class="string">;         2       Enable Write Speech</span>
    <span class="string">;         3       Disable Keyboard auto scanning</span>
    <span class="string">;         4       Hardware scrolling - set C0=0 (See below)</span>
    <span class="string">;         5       Hardware scrolling - set C1=0 (See below)</span>
    <span class="string">;         6       Turn on Caps Lock LED</span>
    <span class="string">;         7       Turn on Shift Lock LED</span>
    <span class="string">;         8       Disable sound chip</span>
    <span class="string">;         9       Disable Read Speech</span>
    <span class="string">;         10      Disable Write Speech</span>
    <span class="string">;         11      Enable Keyboard auto scanning</span>
    <span class="string">;         12      Hardware scrolling - set C0=1 (See below)</span>
    <span class="string">;         13      Hardware scrolling - set C1=1 (See below)</span>
    <span class="string">;         14      Turn off Caps Lock LED</span>
    <span class="string">;         15      Turn off Shift Lock LED</span>
    <span class="string">;</span>
    <span class="string">;  The values of C0 and C1 together determine the start scroll address for the screen:</span>
    <span class="string">;</span>
    <span class="string">;         C0   C1      Screen       Used in</span>
    <span class="string">;                      Address   Regular MODEs</span>
    <span class="string">;         ------------------------------------</span>
    <span class="string">;          0    0      $4000           3</span>
    <span class="string">;          0    1      $5800          4,5</span>
    <span class="string">;          1    0      $6000           6</span>
    <span class="string">;          1    1      $3000         0,1,2</span>
    <span class="string">;</span>

    <span class="string">.systemViaRegisterB                         = $FE40     ; System VIA Output Register B (ORB)           Input Register B</span>
    <span class="string">.systemViaRegisterA                         = $FE41     ; System VIA Output Register A (ORA)           Input Register A</span>
    <span class="string">.systemViaDataDirectionRegisterB            = $FE42     ; System VIA data direction register B (DDRB)</span>
    <span class="string">.systemViaDataDirectionRegisterA            = $FE43     ; System VIA data direction register A (DDRA)</span>
    <span class="string">.systemViaT1CL                              = $FE44     ; System VIA T1C-L latches                     T1 low Order counter</span>
    <span class="string">.systemViaT1CH                              = $FE45     ; System VIA T1C-H counter</span>
    <span class="string">.systemViaT1LL                              = $FE46     ; System VIA T1L-L low order latches</span>
    <span class="string">.systemViaT1LH                              = $FE47     ; System VIA T1L-H high order latches</span>
    <span class="string">.systemViaT2CL                              = $FE48     ; System VIA T2C-L latches                     T2C-L low order counter</span>
    <span class="string">.systemViaT2CH                              = $FE49     ; System VIA T2C-H T2 high order counter</span>
    <span class="string">.systemViaShiftRegister                     = $FE4A     ; System VIA shift register</span>
    <span class="string">.systemViaAuxilliaryControlRegister         = $FE4B     ; System VIA auxilliary control register (ACR)</span>
    <span class="string">.systemViaPeripheralControlRegister         = $FE4C     ; System VIA peripheral control register (PCR)</span>
                                                            <span class="string">;</span>
                                                            <span class="string">; bit 0    = CA1 interrupt control</span>
                                                            <span class="string">;            Writing to CA1 means "</span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">taken</span><span class="string">"</span>
                                                            <span class="string">;            0 means negative active edge</span>
                                                            <span class="string">;            1 means positive active edge</span>
                                                            <span class="string">;</span>
                                                            <span class="string">; bits 1-3 = CA2 control mode</span>
                                                            <span class="string">;            CA2 signifies "</span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">ready</span><span class="string">"</span>
                                                            <span class="string">;</span>
                                                            <span class="string">; bit 4    = CB1 interrupt control</span>
                                                            <span class="string">;            Writing to CB1 means "</span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">taken</span><span class="string">"</span>
                                                            <span class="string">;            0 means negative active edge</span>
                                                            <span class="string">;            1 means positive active edge</span>
                                                            <span class="string">;</span>
                                                            <span class="string">; bits 5-7 = CB2 control mode</span>
                                                            <span class="string">;            CB2 signifies "</span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">ready</span><span class="string">"</span>
                                                            <span class="string">;</span>
                                                            <span class="string">; control mode:</span>
                                                            <span class="string">;   000 = negative edges active on input</span>
                                                            <span class="string">;   001 = independent interrupt; input negative edge</span>
                                                            <span class="string">;   010 = positive edges active on input</span>
                                                            <span class="string">;   011 = independent interrupt; input positive edge</span>
                                                            <span class="string">;   100 = handshake output mode</span>
                                                            <span class="string">;   101 = pulse output mode</span>
                                                            <span class="string">;   110 = low output</span>
                                                            <span class="string">;   111 = high output</span>
                                                            <span class="string">;</span>
    <span class="string">.systemViaInterruptFlagRegister             = $FE4D     ; System VIA Interrupt  flag    register (IFR)</span>
                                                            <span class="string">; bit 0 = keyboard key pressed interrupt</span>
                                                            <span class="string">; bit 1 = vertical sync occurred</span>
                                                            <span class="string">; bit 2 = shift register timeout (unused)</span>
                                                            <span class="string">; bit 3 = lightpen strobe off screen</span>
                                                            <span class="string">; bit 4 = analogue conversion completed</span>
                                                            <span class="string">; bit 5 = timer 2 has timed out (used for speech)</span>
                                                            <span class="string">; bit 6 = timer 1 has timed out (100Hz signal, runs TIME etc)</span>
                                                            <span class="string">; bit 7 = master interrupt flag (0-6 invalid if not set)</span>
                                                            <span class="string">; setting a bit 0-6 DISABLEs the interrupt</span>

    <span class="string">.systemViaInterruptEnableRegister           = $FE4E     ; System VIA Interrupt enable   register (IER)</span>
                                                            <span class="string">; bit 0 = keyboard key pressed interrupt</span>
                                                            <span class="string">; bit 1 = vertical sync occurred</span>
                                                            <span class="string">; bit 2 = shift register timeout (unused)</span>
                                                            <span class="string">; bit 3 = lightpen strobe off screen</span>
                                                            <span class="string">; bit 4 = analogue conversion completed</span>
                                                            <span class="string">; bit 5 = timer 2 timed out (used for speech)</span>
                                                            <span class="string">; bit 6 = timer 1 timed out (100Hz signal, runs TIME etc)</span>
                                                            <span class="string">; bit 7 = unused (reads as 1)</span>
    <span class="string">.systemViaRegisterBNoHandshake              = $FE4F     ; System VIA ORB/IRB but no handshake</span>

    <span class="string">.userViaRegisterB                           = $FE60     ; User VIA (6522) Output Register B                   Input Register B</span>
    <span class="string">.userViaRegisterA                           = $FE61     ; User VIA (6522) Output Register A                   Input Register A</span>
    <span class="string">.userViaDataDirectionRegisterB              = $FE62     ; User VIA (6522) data direction register B</span>
    <span class="string">.userViaDataDirectionRegisterA              = $FE63     ; User VIA (6522) data direction register A</span>
    <span class="string">.userViaT1CL                                = $FE64     ; User VIA (6522) T1C-L latches                       T1 low Order counter</span>
    <span class="string">.userViaT1CH                                = $FE65     ; User VIA (6522) T1C-H counter</span>
    <span class="string">.userViaT1LL                                = $FE66     ; User VIA (6522) T1L-L low order latches</span>
    <span class="string">.userViaT1LH                                = $FE67     ; User VIA (6522) T1L-H high order latches</span>
    <span class="string">.userViaT2CL                                = $FE68     ; User VIA (6522) T2C-L latches                       T2C-L low order counter</span>
    <span class="string">.userViaT2CH                                = $FE69     ; User VIA (6522) T2C-H T2 high order counter</span>
    <span class="string">.userViaShiftRegister                       = $FE6A     ; User VIA (6522) shift register</span>
    <span class="string">.userViaAuxilliaryControlRegister           = $FE6B     ; User VIA (6522) auxilliary control register ACR</span>
    <span class="string">.userViaPeripheralControlRegister           = $FE6C     ; User VIA (6522) Peripheral control register PCR</span>
    <span class="string">.userViaInterruptFlagRegister               = $FE6D     ; User VIA (6522) Interrupt  flag    register IFR</span>
    <span class="string">.userViaInterruptEnableRegister             = $FE6E     ; User VIA (6522) Interrupt enable   register IER</span>
    <span class="string">.userViaRegisterBNoHandshake                = $FE6F     ; User VIA (6522) ORB/IRB but no handshake</span>

    <span class="string">.adcDataLatchAndConversionStartRegister     = $FEC0     ; 7002 ADC       data latch and analogue to digital start register</span>
    <span class="string">.adcDataHighByte                            = $FEC1     ; 7002 ADC       high data byte</span>
    <span class="string">.adcDataLowByte                             = $FEC2     ; 7002 ADC       low data byte</span>

    <span class="string">.tubeULAStatusRegister                      = $FEE0     ; Tube ULA Status Register</span>
    <span class="string">.tubeULADataRegister3                       = $FEE5     ;</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
</pre>

<p class="inwebparagraph">Chapter 1
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 1: </span><span class="identifier">Character</span><span class="plain"> </span><span class="identifier">definitions</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">tables</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">* = $</span><span class="identifier">C000</span>

    <span class="plain">.</span><span class="identifier">characterDefinitions</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#######</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#######</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..######</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..###...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..###...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##.#</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..###.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.###.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.###.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..###...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...###..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...###..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...###..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..###...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.###.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.#.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.###.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.####...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.####...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.###.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..###...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.####...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.###....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.####...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##...##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.###.###</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#######</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##...##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##...##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.###.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.###.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.#.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##...##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##...##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#######</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.###.###</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##...##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#....#.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %########</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...###..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...###..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..###...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..###...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.###....</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.####...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..###...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#######</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##...##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....###</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.###.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...###..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##...##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#######</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##.##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##..##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..#####.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.....##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..####..</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.######.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.###....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....##..</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %....###.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %...##...</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##....</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %..##...#</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.##.#.##</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %.#...##.</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %........</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %########</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %########</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %########</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %########</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %########</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %########</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %########</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %########</span>

    <span class="plain">.</span><span class="identifier">vduBaseAddress</span><span class="plain"> = *</span>
    <span class="plain">.</span><span class="identifier">initialiseScreen</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">screenInitialisationRoutines</span>

    <span class="plain">.</span><span class="identifier">bootMessage</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> 13, </span><span class="string">"BBC Computer "</span><span class="plain">, 0</span>

    <span class="plain">.</span><span class="identifier">bootMessageMemory16</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"16K"</span><span class="plain">, .</span><span class="identifier">charBELL</span><span class="plain">, 0</span>

    <span class="plain">.</span><span class="identifier">bootMessageMemory32</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"32K"</span><span class="plain">, .</span><span class="identifier">charBELL</span><span class="plain">, 0</span>

    <span class="plain">.</span><span class="identifier">bootMessageEnding</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> 8, 13, 13                                     ; </span><span class="identifier">Overlaps</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">terminator</span>

    <span class="plain">.</span><span class="identifier">fourColourModeByteMaskTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00, $11, $22, $33, $44, $55, $66, $77</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $88, $99, $</span><span class="identifier">AA</span><span class="plain">, $</span><span class="identifier">BB</span><span class="plain">, $</span><span class="identifier">CC</span><span class="plain">, $</span><span class="identifier">DD</span><span class="plain">, $</span><span class="identifier">EE</span><span class="plain">, $</span><span class="identifier">FF</span>

    <span class="plain">.</span><span class="identifier">sixteenColourModeByteMaskTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00, $55, $</span><span class="identifier">AA</span><span class="plain">, $</span><span class="identifier">FF</span>

    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">stores</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">.</span>
    <span class="plain">; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">holds</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="identifier">corresponding</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> 0-31 </span><span class="identifier">and</span><span class="plain"> 127.</span>
    <span class="plain">;</span>
    <span class="plain">.</span><span class="identifier">vduEntryPointTableLow</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu0EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu1EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu2EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu3EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu4EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu5EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu6EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu7EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu8EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu9EntryPoint</span><span class="plain">                              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu10EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu11EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu12EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu13EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu14EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu15EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu16EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu17EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu18EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu19EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu20EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu21EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu22EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu23EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu24EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu25EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu26EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu27EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu28EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu29EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu30EntryPoint</span><span class="plain">                             ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu31EntryPoint</span><span class="plain">                             ;</span>
    <span class="plain">.</span><span class="identifier">vduEntryPointTableDelete</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">vdu127EntryPoint</span><span class="plain">                            ;</span>

    <span class="identifier">vduBaseAddress</span><span class="plain"> = .</span><span class="identifier">vduBaseAddress</span>

    <span class="plain">!</span><span class="identifier">macro</span><span class="plain"> </span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">addr</span><span class="plain">, .</span><span class="identifier">params</span><span class="plain"> {</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> (&gt;(.</span><span class="identifier">addr</span><span class="plain"> - </span><span class="identifier">vduBaseAddress</span><span class="plain">))*16 + (16 - .</span><span class="identifier">params</span><span class="plain">)</span>
    <span class="plain">}</span>

    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">stores</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">. </span><span class="identifier">The</span>
    <span class="plain">; </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">holds</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">.</span>
    <span class="plain">; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">holds</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="identifier">corresponding</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> 0-31 </span><span class="identifier">and</span><span class="plain"> 127.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">required</span><span class="plain">, </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> 4 </span><span class="identifier">bits</span><span class="plain">, </span><span class="identifier">and</span>
    <span class="plain">; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">upper</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">holds</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">vduBaseAddress</span><span class="plain">. </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span>
    <span class="plain">; </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">indicates</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">required</span><span class="plain">, </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">just</span><span class="plain"> </span><span class="identifier">hold</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span>
    <span class="plain">; </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">directly</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">.</span><span class="identifier">vduEntryPointTableHigh</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu0EntryPoint</span><span class="plain">                              ; </span><span class="identifier">Does</span><span class="plain"> </span><span class="identifier">nothing</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu1EntryPoint</span><span class="plain">, 1               ; </span><span class="identifier">Send</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">only</span><span class="plain"> (1 </span><span class="identifier">parameter</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu2EntryPoint</span><span class="plain">                              ; </span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">printer</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu3EntryPoint</span><span class="plain">                              ; </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">printer</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu4EntryPoint</span><span class="plain">                              ; </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu5EntryPoint</span><span class="plain">                              ; </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu6EntryPoint</span><span class="plain">                              ; </span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">drivers</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu7EntryPoint</span><span class="plain">                              ; </span><span class="identifier">Make</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">beep</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu8EntryPoint</span><span class="plain">                              ; </span><span class="identifier">Backspace</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu9EntryPoint</span><span class="plain">                              ; </span><span class="identifier">Forward</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu10EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Move</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">down</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu11EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Move</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu12EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Clear</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">area</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu13EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Move</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu14EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Page</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">on</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu15EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Page</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">off</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu16EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Clear</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">area</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu17EntryPoint</span><span class="plain">, 1              ; </span><span class="identifier">Define</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> (1 </span><span class="identifier">parameter</span><span class="plain">)</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu18EntryPoint</span><span class="plain">, 2              ; </span><span class="identifier">Define</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> (2 </span><span class="identifier">parameters</span><span class="plain">)</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu19EntryPoint</span><span class="plain">, 5              ; </span><span class="identifier">Define</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> (5 </span><span class="identifier">parameters</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu20EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Restore</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu21EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">drivers</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">delete</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu22EntryPoint</span><span class="plain">, 1              ; </span><span class="identifier">Select</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> (1 </span><span class="identifier">parameter</span><span class="plain">)</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu23EntryPoint</span><span class="plain">, 9              ; </span><span class="identifier">Reprogram</span><span class="plain"> </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> (9 </span><span class="identifier">parameters</span><span class="plain">)</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu24EntryPoint</span><span class="plain">, 8              ; </span><span class="identifier">Define</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> (8 </span><span class="identifier">parameters</span><span class="plain">)</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu25EntryPoint</span><span class="plain">, 5              ; </span><span class="identifier">PLOT</span><span class="plain"> (5 </span><span class="identifier">parameters</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu26EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Restore</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">windows</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu27EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Does</span><span class="plain"> </span><span class="identifier">nothing</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu28EntryPoint</span><span class="plain">, 4              ; </span><span class="identifier">Define</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> (4 </span><span class="identifier">parameters</span><span class="plain">)</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu29EntryPoint</span><span class="plain">, 4              ; </span><span class="identifier">Define</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> (4 </span><span class="identifier">parameters</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu30EntryPoint</span><span class="plain">                             ; </span><span class="identifier">Move</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> (</span><span class="character">'home'</span><span class="plain"> </span><span class="identifier">position</span><span class="plain">)</span>
        <span class="plain">+</span><span class="identifier">encode_entryPoint</span><span class="plain"> .</span><span class="identifier">vdu31EntryPoint</span><span class="plain">, 2              ; </span><span class="identifier">Move</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> (2 </span><span class="identifier">parameters</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">vdu127EntryPoint</span><span class="plain">                            ; </span><span class="identifier">Delete</span>

    <span class="plain">.</span><span class="identifier">multiplyBy640Table</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 0 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 1 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 2 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 3 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 4 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 5 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 6 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 7 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 8 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 9 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 10 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 11 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 12 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 13 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 14 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 15 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 16 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 17 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 18 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 19 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 20 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 21 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 22 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 23 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 24 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 25 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 26 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 27 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 28 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 29 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 30 * 640</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 31 * 640</span>

    <span class="plain">.</span><span class="identifier">multiplyBy40Table</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 0 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 1 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 2 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 3 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 4 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 5 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 6 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 7 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 8 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 9 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 10 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 11 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 12 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 13 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 14 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 15 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 16 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 17 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 18 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 19 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 20 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 21 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 22 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 23 * 40</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> 24 * 40</span>

    <span class="plain">; </span><span class="identifier">Maximum</span><span class="plain"> </span><span class="identifier">allowed</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">mode</span>
    <span class="plain">.</span><span class="identifier">textWindowBottomRowTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 31                                            ; </span><span class="identifier">Mode</span><span class="plain"> 0 (32 </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 31                                            ; </span><span class="identifier">Mode</span><span class="plain"> 1 (32 </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 31                                            ; </span><span class="identifier">Mode</span><span class="plain"> 2 (32 </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 24                                            ; </span><span class="identifier">Mode</span><span class="plain"> 3 (25 </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 31                                            ; </span><span class="identifier">Mode</span><span class="plain"> 4 (32 </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 31                                            ; </span><span class="identifier">Mode</span><span class="plain"> 5 (32 </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 24                                            ; </span><span class="identifier">Mode</span><span class="plain"> 6 (25 </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 24                                            ; </span><span class="identifier">Mode</span><span class="plain"> 7 (25 </span><span class="identifier">rows</span><span class="plain">)</span>

    <span class="plain">; </span><span class="identifier">Maximum</span><span class="plain"> </span><span class="identifier">allowed</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">column</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">mode</span>
    <span class="plain">.</span><span class="identifier">textWindowRightColumnTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 79                                            ; </span><span class="identifier">Mode</span><span class="plain"> 0 (80 </span><span class="identifier">columns</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 39                                            ; </span><span class="identifier">Mode</span><span class="plain"> 1 (40 </span><span class="identifier">columns</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 19                                            ; </span><span class="identifier">Mode</span><span class="plain"> 2 (20 </span><span class="identifier">columns</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 79                                            ; </span><span class="identifier">Mode</span><span class="plain"> 3 (80 </span><span class="identifier">columns</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 39                                            ; </span><span class="identifier">Mode</span><span class="plain"> 4 (40 </span><span class="identifier">columns</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 19                                            ; </span><span class="identifier">Mode</span><span class="plain"> 5 (20 </span><span class="identifier">columns</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 39                                            ; </span><span class="identifier">Mode</span><span class="plain"> 6 (40 </span><span class="identifier">columns</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 39                                            ; </span><span class="identifier">Mode</span><span class="plain"> 7 (40 </span><span class="identifier">columns</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Video</span><span class="plain"> </span><span class="identifier">Control</span><span class="plain"> </span><span class="identifier">Register</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">VideoULA</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">bit</span>
    <span class="plain">;   0 - </span><span class="identifier">Flash</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">select</span><span class="plain"> (</span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">flashing</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain">)</span>
    <span class="plain">;   1 - </span><span class="identifier">Teletext</span><span class="plain"> </span><span class="identifier">select</span>
    <span class="plain">;   2 - } </span><span class="identifier">These</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">determine</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">row</span>
    <span class="plain">;   3 - } </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">table</span><span class="plain">:</span>
    <span class="plain">;       %00 = 10 </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">row</span>
    <span class="plain">;       %01 = 20 </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">row</span>
    <span class="plain">;       %10 = 40 </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">row</span>
    <span class="plain">;       %11 = 80 </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">row</span>
    <span class="plain">;   4 - </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain"> </span><span class="identifier">rate</span><span class="plain"> </span><span class="identifier">select</span><span class="plain">:</span>
    <span class="plain">;        %0 = </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">frequency</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">MODEs</span><span class="plain"> 4-7</span>
    <span class="plain">;        %1 = </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">frequency</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">MODEs</span><span class="plain"> 0-3</span>
    <span class="plain">;   5 - } </span><span class="identifier">These</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">determine</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">bytes</span>
    <span class="plain">;   6 - } </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">table</span><span class="plain">:</span>
    <span class="plain">;       %00 = 1 (</span><span class="identifier">MODEs</span><span class="plain"> 0,3,4,6)</span>
    <span class="plain">;       %01 = - </span><span class="identifier">undefined</span>
    <span class="plain">;       %10 = 2 (</span><span class="identifier">MODEs</span><span class="plain"> 1,5,7)</span>
    <span class="plain">;       %11 = 4 (</span><span class="identifier">MODE</span><span class="plain"> 2)</span>
    <span class="plain">;   7 - </span><span class="identifier">Master</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">width</span><span class="plain">. </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">, </span><span class="identifier">causes</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">larger</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">displayed</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">videoULAVideoControlRegisterDefaultValuesPerMode</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %10011100                                     ; </span><span class="identifier">Mode</span><span class="plain"> 0</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11011000                                     ; </span><span class="identifier">Mode</span><span class="plain"> 1</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11110100                                     ; </span><span class="identifier">Mode</span><span class="plain"> 2</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %10011100                                     ; </span><span class="identifier">Mode</span><span class="plain"> 3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %10001000                                     ; </span><span class="identifier">Mode</span><span class="plain"> 4</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11000100                                     ; </span><span class="identifier">Mode</span><span class="plain"> 5</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %10001000                                     ; </span><span class="identifier">Mode</span><span class="plain"> 6</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %01001011                                     ; </span><span class="identifier">Mode</span><span class="plain"> 7</span>

    <span class="plain">.</span><span class="identifier">bytesPerCharacter</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 8                                             ; </span><span class="identifier">Mode</span><span class="plain"> 0</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 16                                            ; </span><span class="identifier">Mode</span><span class="plain"> 1</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 32                                            ; </span><span class="identifier">Mode</span><span class="plain"> 2</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 8                                             ; </span><span class="identifier">Mode</span><span class="plain"> 3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 8                                             ; </span><span class="identifier">Mode</span><span class="plain"> 4</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 16                                            ; </span><span class="identifier">Mode</span><span class="plain"> 5</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 8                                             ; </span><span class="identifier">Mode</span><span class="plain"> 6</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 1                                             ; </span><span class="identifier">Mode</span><span class="plain"> 7</span>

    <span class="plain">.</span><span class="identifier">sixteenColourModeMaskTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %10101010, %01010101                          ; 2 </span><span class="identifier">pixels</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 2)</span>

    <span class="plain">.</span><span class="identifier">fourColourModeMaskTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %10001000, %01000100, %00100010, %00010001    ; 4 </span><span class="identifier">pixels</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 1 </span><span class="identifier">or</span><span class="plain"> 5)</span>

    <span class="plain">.</span><span class="identifier">fontMaskTable</span><span class="plain">                                          ; 8 </span><span class="identifier">pixels</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 0 </span><span class="identifier">or</span><span class="plain"> 4)</span>
                                                            <span class="plain">; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">array</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">dual</span><span class="plain"> </span><span class="identifier">purpose</span><span class="plain"> - </span><span class="identifier">used</span><span class="plain"> </span><span class="identifier">both</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">part</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">and</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $80, $40, $20, $10, $08, $04, $02            ; </span><span class="identifier">also</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">interrogate</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">particular</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">vduFontByte</span><span class="plain">.</span>
        <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">overlaps</span><span class="plain"> (</span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">numberOfColoursMinusOneInModeTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 1                                             ; </span><span class="identifier">Mode</span><span class="plain"> 0</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 3                                             ; </span><span class="identifier">Mode</span><span class="plain"> 1</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 15                                            ; </span><span class="identifier">Mode</span><span class="plain"> 2</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 1                                             ; </span><span class="identifier">Mode</span><span class="plain"> 3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 1                                             ; </span><span class="identifier">Mode</span><span class="plain"> 4</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 3                                             ; </span><span class="identifier">Mode</span><span class="plain"> 5</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 1                                             ; </span><span class="identifier">Mode</span><span class="plain"> 6</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">Mode</span><span class="plain"> 7</span>

    <span class="plain">.</span><span class="identifier">gcolPlotOptionsTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                                           ; </span><span class="identifier">Mode</span><span class="plain"> 0        </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">EXPLAIN</span><span class="plain">!</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                                           ; </span><span class="identifier">Mode</span><span class="plain"> 1</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                                           ; </span><span class="identifier">Mode</span><span class="plain"> 2</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                                           ; </span><span class="identifier">Mode</span><span class="plain"> 3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                                           ; </span><span class="identifier">Mode</span><span class="plain"> 4</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                                           ; </span><span class="identifier">Mode</span><span class="plain"> 5</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                                           ; </span><span class="identifier">Mode</span><span class="plain"> 6</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                                           ; </span><span class="identifier">Mode</span><span class="plain"> 7</span>

    <span class="plain">.</span><span class="identifier">twoColourModeParameterTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00000000                                     ; </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">EXPLAIN</span><span class="plain">!</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11111111                                     ;</span>

    <span class="plain">.</span><span class="identifier">fourColourModeParameterTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00000000                                     ; </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">EXPLAIN</span><span class="plain">!</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00001111                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11110000                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11111111                                     ;</span>

    <span class="plain">.</span><span class="identifier">sixteenColourModeParameterTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00000000                                     ; </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">EXPLAIN</span><span class="plain">!</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00000011                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00001100                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00001111                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00110000                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00110011                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00111100                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00111111                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11000000                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11000011                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11001100                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11001111                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11110000                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11110011                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11111100                                     ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11111111                                     ;</span>

    <span class="plain">.</span><span class="identifier">pixelsPerByteMinusOneInModeTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 7                                             ; </span><span class="identifier">Mode</span><span class="plain"> 0</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 3                                             ; </span><span class="identifier">Mode</span><span class="plain"> 1</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 1                                             ; </span><span class="identifier">Mode</span><span class="plain"> 2</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">Mode</span><span class="plain"> 3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 7                                             ; </span><span class="identifier">Mode</span><span class="plain"> 4</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 3                                             ; </span><span class="identifier">Mode</span><span class="plain"> 5</span>
        <span class="plain">; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> (</span><span class="identifier">zeroes</span><span class="plain">) </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">overlapping</span><span class="plain">, </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> (</span><span class="identifier">Mode</span><span class="plain"> 6 </span><span class="identifier">and</span><span class="plain"> 7 </span><span class="identifier">values</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain">.</span>

    <span class="plain">.</span><span class="identifier">screenDisplayMemoryIndexTable</span><span class="plain">                          ; </span><span class="identifier">How</span><span class="plain"> </span><span class="identifier">much</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">does</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">take</span><span class="plain">?</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">Mode</span><span class="plain"> 0</span>
    <span class="plain">.</span><span class="identifier">soundPitchOffsetByChannelTable</span><span class="plain">                                             ; </span><span class="identifier">Dual</span><span class="plain"> </span><span class="identifier">use</span><span class="plain">: </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">offsets</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">Mode</span><span class="plain"> 1            ; </span><span class="identifier">Channel</span><span class="plain"> 0</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">Mode</span><span class="plain"> 2            ; </span><span class="identifier">Channel</span><span class="plain"> 1</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 1                                             ; </span><span class="identifier">Mode</span><span class="plain"> 3            ; </span><span class="identifier">Channel</span><span class="plain"> 2</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 2                                             ; </span><span class="identifier">Mode</span><span class="plain"> 4            ; </span><span class="identifier">Channel</span><span class="plain"> 3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 2                                             ; </span><span class="identifier">Mode</span><span class="plain"> 5</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 3                                             ; </span><span class="identifier">Mode</span><span class="plain"> 6</span>
    <span class="plain">.</span><span class="identifier">vduGraphicsWindowBoundariesTable</span><span class="plain">                                           ; </span><span class="identifier">Dual</span><span class="plain"> </span><span class="identifier">use</span><span class="plain">: </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">vdu</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">plotting</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 4                                             ; </span><span class="identifier">Mode</span><span class="plain"> 7            ; </span><span class="identifier">aka</span><span class="plain">: .</span><span class="identifier">vduGraphicsWindowPixelsRightLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">vduGraphicsWindowPixelsLeftLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">              ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">vduGraphicsWindowPixelsTopLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">               ; </span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">offsets</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">edges</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> (</span><span class="identifier">right</span><span class="plain">, </span><span class="identifier">left</span><span class="plain">, </span><span class="identifier">top</span><span class="plain">, </span><span class="identifier">bottom</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">vduGraphicsWindowPixelsBottomLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">            ;</span>



    <span class="plain">.</span><span class="identifier">crtcHardwareScrollParametersTable1</span><span class="plain">                     ; </span><span class="identifier">Which</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">scrolling</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $0</span><span class="identifier">D</span><span class="plain">                                           ; 20</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 0,1,2)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $05                                           ; 16</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 3)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $0</span><span class="identifier">D</span><span class="plain">                                           ; 10</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 4,5)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $05                                           ; 8</span><span class="identifier">k</span><span class="plain">  (</span><span class="identifier">MODE</span><span class="plain"> 6)</span>

    <span class="plain">.</span><span class="identifier">crtcHardwareScrollParametersTable2</span><span class="plain">                     ; </span><span class="identifier">Which</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">scrolling</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $04                                           ; 20</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 0,1,2)    ; </span><span class="identifier">Also</span><span class="plain">: </span><span class="identifier">Overlap</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">table</span><span class="plain">... 1</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 7)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $04                                           ; 16</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 3)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $0</span><span class="identifier">C</span><span class="plain">                                           ; 10</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 4,5)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $0</span><span class="identifier">C</span><span class="plain">                                           ; 8</span><span class="identifier">k</span><span class="plain">  (</span><span class="identifier">MODE</span><span class="plain"> 6)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $04                                           ; 1</span><span class="identifier">k</span><span class="plain">  (</span><span class="identifier">MODE</span><span class="plain"> 7)</span>

    <span class="plain">.</span><span class="identifier">clearScreenRoutineEntryPointLow</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">clearScreenRoutineEntryPointMode012</span><span class="plain">         ; </span><span class="identifier">Mode</span><span class="plain"> 0,1,2    </span><span class="identifier">Low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">clearScreenRoutineEntryPointMode3</span><span class="plain">           ; </span><span class="identifier">Mode</span><span class="plain"> 3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">clearScreenRoutineEntryPointMode45</span><span class="plain">          ; </span><span class="identifier">Mode</span><span class="plain"> 4,5</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">clearScreenRoutineEntryPointMode6</span><span class="plain">           ; </span><span class="identifier">Mode</span><span class="plain"> 6</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">clearScreenRoutineEntryPointMode7</span><span class="plain">           ; </span><span class="identifier">Mode</span><span class="plain"> 7</span>

    <span class="plain">.</span><span class="identifier">screenMemorySizeInBytesHigh</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $50                                           ; </span><span class="identifier">Modes</span><span class="plain"> 0,1,2 ($5000 = 20</span><span class="identifier">k</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $40                                           ; </span><span class="identifier">Mode</span><span class="plain">  3     ($4000 = 16</span><span class="identifier">k</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $28                                           ; </span><span class="identifier">Modes</span><span class="plain"> 4,5   ($2800 = 10</span><span class="identifier">k</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $20                                           ; </span><span class="identifier">Mode</span><span class="plain">  6     ($2000 = 8</span><span class="identifier">k</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $04                                           ; </span><span class="identifier">Mode</span><span class="plain">  7     ($0400 = 1</span><span class="identifier">k</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">screenMemoryStartHigh</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $30                                           ; </span><span class="identifier">Modes</span><span class="plain"> 0,1,2 ($3000)   %00110000</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $40                                           ; </span><span class="identifier">Mode</span><span class="plain">  3     ($4000)   %01000000</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $58                                           ; </span><span class="identifier">Modes</span><span class="plain"> 4,5   ($5800)   %01011000</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $60                                           ; </span><span class="identifier">Mode</span><span class="plain">  6     ($6000)   %01100000</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $7</span><span class="identifier">C</span><span class="plain">                                           ; </span><span class="identifier">Mode</span><span class="plain">  7     ($7</span><span class="identifier">C00</span><span class="plain">)   %01111100</span>

    <span class="plain">.</span><span class="identifier">bytesPerRowLow</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;40                                           ; </span><span class="identifier">MODE</span><span class="plain"> 7                $0040 =  40 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">row</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;320                                          ; </span><span class="identifier">MODE</span><span class="plain"> 4,5,6            $0140 = 320 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">row</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;640                                          ; </span><span class="identifier">MODE</span><span class="plain"> 0,1,2,3          $0280 = 640 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">row</span>

    <span class="plain">; </span><span class="identifier">Which</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">use</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">address</span><span class="plain">, </span><span class="identifier">assumes</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">tables</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain"> </span><span class="identifier">page</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">multiplicationTabletoUseLow</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">multiplyBy40Table</span><span class="plain">                           ; </span><span class="identifier">MODE</span><span class="plain"> 7</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">multiplyBy640Table</span><span class="plain">                          ; </span><span class="identifier">MODE</span><span class="plain"> 4,5,6</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">multiplyBy640Table</span><span class="plain">                          ; </span><span class="identifier">MODE</span><span class="plain"> 0,1,2,3</span>

    <span class="plain">.</span><span class="identifier">crtcCursorEndRegisterTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">crtcModes012CursorEndRegister</span><span class="plain"> - .</span><span class="identifier">crtcRegisters0to11ForModes012</span><span class="plain">   ; </span><span class="identifier">Modes</span><span class="plain"> 0,1,2</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">crtcMode3CursorEndRegister</span><span class="plain">    - .</span><span class="identifier">crtcRegisters0to11ForModes012</span><span class="plain">   ; </span><span class="identifier">Mode</span><span class="plain">  3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">crtcMode45CursorEndRegister</span><span class="plain">   - .</span><span class="identifier">crtcRegisters0to11ForModes012</span><span class="plain">   ; </span><span class="identifier">Modes</span><span class="plain"> 4,5</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">crtcMode6CursorEndRegister</span><span class="plain">    - .</span><span class="identifier">crtcRegisters0to11ForModes012</span><span class="plain">   ; </span><span class="identifier">Mode</span><span class="plain">  6</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">crtcMode7CursorEndRegister</span><span class="plain">    - .</span><span class="identifier">crtcRegisters0to11ForModes012</span><span class="plain">   ; </span><span class="identifier">Mode</span><span class="plain">  7</span>

    <span class="plain">.</span><span class="identifier">crtcRegisters0to11ForModes012</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 127                                           ; </span><span class="identifier">R0</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 80                                            ; </span><span class="identifier">R1</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 98                                            ; </span><span class="identifier">R2</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $28                                           ; </span><span class="identifier">R3</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 38                                            ; </span><span class="identifier">R4</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">R5</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="identifier">adjust</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 32                                            ; </span><span class="identifier">R6</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> (</span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">visible</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 34                                            ; </span><span class="identifier">R7</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00000001                                     ; </span><span class="identifier">R8</span><span class="plain"> = </span><span class="identifier">Interlace</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">delay</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 7                                             ; </span><span class="identifier">R9</span><span class="plain"> = </span><span class="identifier">Scan</span><span class="plain"> </span><span class="identifier">lines</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $67                                           ; </span><span class="identifier">R10</span><span class="plain"> = </span><span class="identifier">Cursor</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="reserved">register</span>
    <span class="plain">.</span><span class="identifier">crtcModes012CursorEndRegister</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 8                                             ; </span><span class="identifier">R11</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="reserved">register</span>

    <span class="plain">.</span><span class="identifier">crtcRegisters0to11ForMode3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 127                                           ; </span><span class="identifier">R0</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 80                                            ; </span><span class="identifier">R1</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 98                                            ; </span><span class="identifier">R2</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $28                                           ; </span><span class="identifier">R3</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $1</span><span class="identifier">E</span><span class="plain">                                           ; </span><span class="identifier">R4</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $02                                           ; </span><span class="identifier">R5</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="identifier">adjust</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $19                                           ; </span><span class="identifier">R6</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> (</span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">visible</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $1</span><span class="identifier">B</span><span class="plain">                                           ; </span><span class="identifier">R7</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $01                                           ; </span><span class="identifier">R8</span><span class="plain"> = </span><span class="identifier">Interlace</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">delay</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $09                                           ; </span><span class="identifier">R9</span><span class="plain"> = </span><span class="identifier">Scan</span><span class="plain"> </span><span class="identifier">lines</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $67                                           ; </span><span class="identifier">R10</span><span class="plain"> = </span><span class="identifier">Cursor</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="reserved">register</span>
    <span class="plain">.</span><span class="identifier">crtcMode3CursorEndRegister</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $09                                           ; </span><span class="identifier">R11</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="reserved">register</span>

    <span class="plain">.</span><span class="identifier">crtcRegisters0to11ForModes45</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $3</span><span class="identifier">F</span><span class="plain">                                           ; </span><span class="identifier">R0</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $28                                           ; </span><span class="identifier">R1</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $31                                           ; </span><span class="identifier">R2</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $24                                           ; </span><span class="identifier">R3</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $26                                           ; </span><span class="identifier">R4</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                                           ; </span><span class="identifier">R5</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="identifier">adjust</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $20                                           ; </span><span class="identifier">R6</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> (</span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">visible</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $22                                           ; </span><span class="identifier">R7</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $01                                           ; </span><span class="identifier">R8</span><span class="plain"> = </span><span class="identifier">Interlace</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">delay</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $07                                           ; </span><span class="identifier">R9</span><span class="plain"> = </span><span class="identifier">Scan</span><span class="plain"> </span><span class="identifier">lines</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $67                                           ; </span><span class="identifier">R10</span><span class="plain"> = </span><span class="identifier">Cursor</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="reserved">register</span>
    <span class="plain">.</span><span class="identifier">crtcMode45CursorEndRegister</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $08                                           ; </span><span class="identifier">R11</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="reserved">register</span>

    <span class="plain">.</span><span class="identifier">crtcRegisters0to11ForMode6</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $3</span><span class="identifier">F</span><span class="plain">                                           ; </span><span class="identifier">R0</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $28                                           ; </span><span class="identifier">R1</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $31                                           ; </span><span class="identifier">R2</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $24                                           ; </span><span class="identifier">R3</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $1</span><span class="identifier">E</span><span class="plain">                                           ; </span><span class="identifier">R4</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $02                                           ; </span><span class="identifier">R5</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="identifier">adjust</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $19                                           ; </span><span class="identifier">R6</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> (</span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">visible</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $1</span><span class="identifier">B</span><span class="plain">                                           ; </span><span class="identifier">R7</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $01                                           ; </span><span class="identifier">R8</span><span class="plain"> = </span><span class="identifier">Interlace</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">delay</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $09                                           ; </span><span class="identifier">R9</span><span class="plain"> = </span><span class="identifier">Scan</span><span class="plain"> </span><span class="identifier">lines</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $67                                           ; </span><span class="identifier">R10</span><span class="plain"> = </span><span class="identifier">Cursor</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="reserved">register</span>
    <span class="plain">.</span><span class="identifier">crtcMode6CursorEndRegister</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $09                                           ; </span><span class="identifier">R11</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="reserved">register</span>

    <span class="plain">.</span><span class="identifier">crtcRegisters0to11ForMode7</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $3</span><span class="identifier">F</span><span class="plain">                                           ; </span><span class="identifier">R0</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $28                                           ; </span><span class="identifier">R1</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $33                                           ; </span><span class="identifier">R2</span><span class="plain"> = </span><span class="identifier">Horizontal</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $24                                           ; </span><span class="identifier">R3</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $1</span><span class="identifier">E</span><span class="plain">                                           ; </span><span class="identifier">R4</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $02                                           ; </span><span class="identifier">R5</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="identifier">adjust</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $19                                           ; </span><span class="identifier">R6</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> (</span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">visible</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">rows</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $1</span><span class="identifier">B</span><span class="plain">                                           ; </span><span class="identifier">R7</span><span class="plain"> = </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $93                                           ; </span><span class="identifier">R8</span><span class="plain"> = </span><span class="identifier">Interlace</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">delay</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $12                                           ; </span><span class="identifier">R9</span><span class="plain"> = </span><span class="identifier">Scan</span><span class="plain"> </span><span class="identifier">lines</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $72                                           ; </span><span class="identifier">R10</span><span class="plain"> = </span><span class="identifier">Cursor</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="reserved">register</span>
    <span class="plain">.</span><span class="identifier">crtcMode7CursorEndRegister</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $13                                           ; </span><span class="identifier">R11</span><span class="plain"> = </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="reserved">register</span>

    <span class="plain">.</span><span class="identifier">vduPlotLineRoutineAddresses</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">plotLineWithDominantAxisX</span><span class="plain">                    ; </span><span class="identifier">Which</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">drawing</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">use</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">plotLineWithDominantAxisY</span><span class="plain">                    ;</span>

    <span class="plain">.</span><span class="identifier">vduRoutineBranchVectorAddressesLow</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">plotLineDominantYAxisSameSign</span><span class="plain">               ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">plotLineDominantYAxisDifferentSign</span><span class="plain">          ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">plotLineDominantXAxisSameSign</span><span class="plain">               ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &lt;.</span><span class="identifier">plotLineDominantXAxisDifferentSign</span><span class="plain">          ;</span>

    <span class="plain">.</span><span class="identifier">vduRoutineBranchVectorAddressesHigh</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">plotLineDominantYAxisSameSign</span><span class="plain">               ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">plotLineDominantYAxisDifferentSign</span><span class="plain">          ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">plotLineDominantXAxisSameSign</span><span class="plain">               ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> &gt;.</span><span class="identifier">plotLineDominantXAxisDifferentSign</span><span class="plain">          ;</span>

    <span class="plain">.</span><span class="identifier">teletextCharacterConversionTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $23                                           ; </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">MODE</span><span class="plain"> 7, </span><span class="identifier">replace</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">here</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $5</span><span class="identifier">F</span><span class="plain">                                           ; </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">reading</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain">, </span><span class="identifier">replace</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $60                                           ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $23                                           ;</span>

    <span class="plain">.</span><span class="identifier">softCharacterRamAllocationTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $04                                           ; </span><span class="identifier">Offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">PAGE</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">) </span><span class="identifier">required</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">explosions</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $05                                           ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $06                                           ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                                           ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $01                                           ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $02                                           ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 2
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 2: </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">OSWORD</span><span class="plain"> </span><span class="identifier">routines</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">VDUCHR</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">point</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="character">'cut down'</span><span class="plain"> </span><span class="identifier">version</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">OSWRCH</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">assumes</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain"> </span><span class="identifier">only</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">display</span><span class="plain">,</span>
    <span class="plain">; </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">Econet</span><span class="plain">, </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain">, </span><span class="identifier">RS423</span><span class="plain">, </span><span class="identifier">nor</span><span class="plain"> </span><span class="identifier">SPOOLed</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">file</span><span class="plain">. </span><span class="identifier">It</span><span class="plain"> </span><span class="identifier">also</span><span class="plain"> </span><span class="identifier">assumes</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">is</span>
    <span class="plain">; </span><span class="identifier">enabled</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Note</span><span class="plain"> </span><span class="identifier">about</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">BBC</span><span class="plain"> </span><span class="identifier">Micro</span><span class="plain"> </span><span class="identifier">Character</span><span class="plain"> </span><span class="identifier">Set</span><span class="plain"> (</span><span class="identifier">it</span><span class="character">'s almost, but not quite 7-bit ASCII)</span>
    <span class="character">; -------------------------------------------------------------------------------</span>
    <span class="character">;</span>
    <span class="character">; One of the main tasks for OSWRCH is to draw characters to the screen. In particular,</span>
    <span class="character">; with A in the range 32-126 these are the '</span><span class="identifier">printable</span><span class="character">' characters. They result in a</span>
    <span class="character">; visual '</span><span class="identifier">glyph</span><span class="character">' appearing on screen. They almost match the standard 7-bit ASCII character</span>
    <span class="character">; set. The exception being ASCII CODE 96 '</span><span class="plain">`</span><span class="character">' (GRAVE ACCENT) which is not available. When</span>
    <span class="character">; this code is used with OSWRCH, a pound sign '</span><span class="plain">?</span><span class="character">' is displayed instead.</span>
    <span class="character">;</span>
    <span class="character">; Additionally, MODE 7 (the TELETEXT mode) has a different character set from ASCII, which</span>
    <span class="character">; means 10 of the ASCII printable characters can'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain">. </span><span class="identifier">Substitutions</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">made</span>
    <span class="plain">; </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">follows</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">;     </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">CODE</span><span class="plain"> 91  </span><span class="character">'['</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">displayed</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">arrow</span><span class="plain"> </span><span class="identifier">pointing</span><span class="plain"> </span><span class="identifier">left</span>
    <span class="plain">;     </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">CODE</span><span class="plain"> 92  </span><span class="character">'\</span><span class="plain">'</span><span class="character"> is displayed as the fraction 1/2</span>
    <span class="character">;     ASCII CODE 93  '</span><span class="plain">]</span><span class="character">' is displayed as an arrow pointing right</span>
    <span class="character">;     ASCII CODE 94  '</span><span class="plain">^</span><span class="character">' is displayed as an arrow pointing up</span>
    <span class="character">;     ASCII CODE 95  '</span><span class="identifier">_</span><span class="character">' is displayed as a dash</span>
    <span class="character">;     ASCII CODE 96  '</span><span class="plain">`</span><span class="character">' is displayed as a pound sign</span>
    <span class="character">;     ASCII CODE 123 '</span><span class="plain">{</span><span class="character">' is displayed as the fraction 1/4</span>
    <span class="character">;     ASCII CODE 124 '</span><span class="plain">|</span><span class="character">' is displayed as a double vertical bar</span>
    <span class="character">;     ASCII CODE 125 '</span><span class="plain">}</span><span class="character">' is displayed as the fraction 3/4</span>
    <span class="character">;     ASCII CODE 126 '</span><span class="plain">~</span><span class="character">' is displayed as the divide symbol</span>
    <span class="character">;</span>
    <span class="character">; Note that when writing directly to the display memory in MODE 7, this gives different</span>
    <span class="character">; results in three cases to printing via OSWRCH. In particular:</span>
    <span class="character">;</span>
    <span class="character">; Value     Write to Screen     Write to screen</span>
    <span class="character">;           Memory Directly       via OSWRCH</span>
    <span class="character">; ----------------------------------------------</span>
    <span class="character">;   $23           ?                   #</span>
    <span class="character">;   $5F           #                   long dash</span>
    <span class="character">;   $60           long dash           ?</span>
    <span class="character">; ----------------------------------------------</span>
    <span class="character">;</span>
    <span class="character">; Control characters (0-31) have special meanings.</span>
    <span class="character">; Top bit set characters (128-255) have proprietary meanings.</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vduChrEntryPoint</span>
        <span class="character">LDX .twosComplimentOfNumberOfBytesInVDUQueue        ; get the number of items in the VDU queue</span>
        <span class="character">BNE .parametersAreOutstanding                       ; if (parameters are still needed) then branch</span>
        <span class="character">BIT .vduStatusByte                                  ; test VDU status byte</span>
        <span class="character">BVC +                                               ; if (cursor editing is NOT active) then branch forward</span>

        <span class="character">; handle cursor editing...</span>
        <span class="character">JSR .swapTextCursorAndInputCursorValues             ; temporarily swap the text cursor and input cursor coordinates</span>
        <span class="character">JSR .setUpWriteCursor                               ; set up write cursor</span>
        <span class="character">BMI +                                               ; if (display is disabled) then branch forward</span>
        <span class="character">CMP #.charRETURN                                    ;</span>
        <span class="character">BNE +                                               ; if (character is not RETURN) then branch forward</span>
        <span class="character">JSR .terminateEdit                                  ; terminate editing</span>

    <span class="character">+</span>
        <span class="character">CMP #.charDELETE                                    ;</span>
        <span class="character">BEQ .handleDeleteCharacter                          ; if (character is DELETE) then branch</span>
        <span class="character">CMP #.charSPACE                                     ;</span>
        <span class="character">BCC .readVDUEntryPointAddressAndParameters          ; if (character less than space, i.e. a VDU control code) then branch</span>
        <span class="character">BIT .vduStatusByte                                  ; test VDU status byte again</span>
        <span class="character">BMI +                                               ; if (screen disabled) then branch forward</span>
        <span class="character">JSR .displayACharacter                              ; display a character</span>
        <span class="character">JSR .vdu9EntryPoint                                 ; and cursor right</span>
    <span class="character">+</span>
        <span class="character">JMP .exitOSWRCH                                     ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.handleDeleteCharacter</span>
        <span class="character">LDA #.vduEntryPointTableDelete - .vduEntryPointTableLow     ; Use index to read the vdu entry point table for DELETE</span>
        <span class="character">; fall through</span>

    <span class="character">.readVDUEntryPointAddressAndParameters</span>
        <span class="character">TAY                                                 ; store the VDU number in Y</span>
        <span class="character">LDA .vduEntryPointTableLow,Y                        ; get low byte of entry point address</span>
        <span class="character">STA .vduJumpVectorLow                               ; store it in jump vector</span>
        <span class="character">LDA .vduEntryPointTableHigh,Y                       ; get high byte of entry point address</span>
        <span class="character">BMI .explicitAddressNoParameters                    ; if (a direct access with no parameters) then branch</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">ORA #%11110000                                      ; set up negated parameter count (set bits in top nybble)</span>
        <span class="character">STA .twosComplimentOfNumberOfBytesInVDUQueue        ; store it back as number of items in VDU queue</span>
        <span class="character">TXA                                                 ; get back A</span>
        <span class="character">LSR                                                 ; A = A / 16</span>
        <span class="character">LSR                                                 ;</span>
        <span class="character">LSR                                                 ;</span>
        <span class="character">LSR                                                 ;</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">ADC #&gt;.vduBaseAddress                               ; add base address (high byte) to get high byte of VDU entry point address</span>
        <span class="character">STA .vduJumpVectorHigh                              ;</span>
        <span class="character">BIT .vduStatusByte                                  ; check for cursor editing enabled</span>
        <span class="character">BVS .reexchangeCursorsAndExit                       ; if (cursor editing mode enabled) then branch (re-exchange cursors)</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 0       Does nothing        }</span>
    <span class="character">;   VDU 6       Enable VDU drivers  } The default handlers for these do nothing</span>
    <span class="character">;   VDU 27      Does nothing        }</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu0EntryPoint</span>
    <span class="character">.vdu6EntryPoint</span>
    <span class="character">.vdu27EntryPoint</span>
    <span class="character">.exit</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.parametersAreOutstanding</span>
        <span class="character">STA .vduQueueEndByte-$FF,X                          ; store parameter in vdu queue (X = 2'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">complement</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=$</span><span class="identifier">FF</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> 1, </span><span class="identifier">FE</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> 2 </span><span class="identifier">etc</span><span class="plain">.)</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">twosComplimentOfNumberOfBytesInVDUQueue</span><span class="plain">        ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">queue</span><span class="plain"> (2</span><span class="character">'s complement)</span>
        <span class="character">BNE .clearCarryAndExit                              ; if (more parameters are needed) then branch</span>
        <span class="character">BIT .vduStatusByte                                  ; test VDU status byte</span>
        <span class="character">BMI .preVDU1                                        ; if (VDU disabled) then branch to VDU 1 code</span>
        <span class="character">BVS .handleCursorEditing                            ; if (cursor editing) then branch</span>
        <span class="character">JSR .executeRequiredFunction                        ; execute required function for VDU command</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.handleCursorEditing</span>
        <span class="character">JSR .swapTextCursorAndInputCursorValues             ; swap values of cursors</span>
        <span class="character">JSR .setUpWriteCursor                               ; set up write cursor</span>
        <span class="character">JSR .executeRequiredFunction                        ; execute required function for VDU command</span>
    <span class="character">.reexchangeCursorsAndExit</span>
        <span class="character">JSR .reswapCursorsBack                              ; re-exchange cursors</span>
    <span class="character">.clearCarryAndExit</span>
        <span class="character">CLC                                                 ; carry clear</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.preVDU1</span>
        <span class="character">LDY .vduJumpVectorHigh                              ; check the upper byte of entry point address</span>
        <span class="character">CPY #&gt;.vdu1EntryPoint                               ; check for the default handler</span>
        <span class="character">BNE .clearCarryAndExit                              ; if (not the default handler) then branch (exit)</span>
        <span class="character">; fall through</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 1       Send next byte to printer only</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu1EntryPoint</span>
        <span class="character">TAX                                                 ; remember A</span>
        <span class="character">LDA .vduStatusByte                                  ; get VDU status byte</span>
        <span class="character">LSR                                                 ; get bit 0 into carry (printer enabled bit)</span>
        <span class="character">BCC .exit                                           ; if (printer not enabled) then branch (exit)</span>
        <span class="character">TXA                                                 ; restore A</span>
        <span class="character">JMP .sendValidByteToPrinter                         ; send byte in A (next byte) to printer</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.explicitAddressNoParameters</span>
        <span class="character">STA .vduJumpVectorHigh                              ; upper byte of link address</span>
        <span class="character">TYA                                                 ; restore A (the VDU number)</span>
        <span class="character">CMP #8                                              ;</span>
        <span class="character">BCC +                                               ; if (VDU number &lt; 8) then branch (carry clear) }</span>
        <span class="character">EOR #$FF                                            ; invert value                                  }</span>
        <span class="character">CMP #$F2                                            ; if (VDU number &gt; 13) then clear carry         } set carry if VDU number 8-13 (cursor movement)</span>
        <span class="character">EOR #$FF                                            ; re-invert value back again                    }</span>
    <span class="character">+</span>
        <span class="character">BIT .vduStatusByte                                  ; test VDU status byte</span>
        <span class="character">BMI .displayDisabled                                ; if (display disabled) then branch</span>
        <span class="character">PHP                                                 ; push processor flags</span>
        <span class="character">JSR .executeRequiredFunction                        ; execute required function</span>
        <span class="character">PLP                                                 ; pull processor flags back</span>
        <span class="character">BCC +                                               ; if (not VDU 8-13 cursor movement) then branch (skip '</span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">enabled</span><span class="character">' check)</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.exitOSWRCH</span>
        <span class="character">LDA .vduStatusByte                                  ; read VDU status byte</span>
        <span class="character">LSR                                                 ; carry is set if printer is enabled</span>
    <span class="character">+</span>
        <span class="character">BIT .vduStatusByte                                  ; test VDU status byte</span>
        <span class="character">BVC .exit                                           ; if (no cursor editing) then branch</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.reswapCursorsBack</span>
        <span class="character">JSR .restoreWriteCursor                             ; restore normal write cursor</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.swapTextCursorAndInputCursorValues</span>
        <span class="character">PHP                                                 ; save flags</span>
        <span class="character">PHA                                                 ; save A</span>
        <span class="character">LDX #.vduTextCursorXPosition        - .vduVariablesStart    ; Offset within VDU variables for text cursor position</span>
        <span class="character">LDY #.vduTextInputCursorXCoordinate - .vduVariablesStart    ; Offset within VDU variables for text input cursor position</span>
        <span class="character">JSR .swapTwoVDUVariables                            ; exchange current text cursor coordinates with text input cursor coordinates</span>
        <span class="character">JSR .setUpCursorScreenAddresses                     ; set up cursor screen addresses</span>
        <span class="character">JSR .setCursorPosition                              ; set cursor position</span>
        <span class="character">LDA .vduStatusByte                                  ; get VDU status byte</span>
        <span class="character">EOR #%00000010                                      ; invert bit 1 to allow or inhibit scrolling</span>
        <span class="character">STA .vduStatusByte                                  ; store VDU status byte</span>
        <span class="character">PLA                                                 ; restore flags</span>
        <span class="character">PLP                                                 ; restore A</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.displayDisabled</span>
        <span class="character">EOR #6                                              ; check for VDU 6 (to reenable the display)?</span>
        <span class="character">BNE .exit1                                          ; if (not VDU 6) then branch (exit)</span>
        <span class="character">LDA #%01111111                                      ; Set up A to clear the top bit of the VDU status byte</span>
        <span class="character">BCC .clearVDUStatusByteFlags                        ; ALWAYS branch, clearing the top bit (enabling the display again)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; On Exit:</span>
    <span class="character">;    A = 0   if text cursor is active           (Z flag set)</span>
    <span class="character">;    A = $20 otherwise (graphics cursor active) (Z flag clear)</span>
    <span class="character">.isTextCursorActive</span>
        <span class="character">LDA .vduStatusByte                                  ; VDU status byte</span>
        <span class="character">AND #%00100000                                      ; test bit 5 of status byte</span>
    <span class="character">.exit1</span>
        <span class="character">RTS                                                 ; and exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 14    Set paged mode</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu14EntryPoint</span>
        <span class="character">LDY #0                                              ; Y = 0</span>
        <span class="character">STY .pagedModeCounter                               ; paged mode counter</span>
        <span class="character">LDA #4                                              ; A = 4</span>
        <span class="character">BNE .setVDUStatusByteFlags                          ; ALWAYS branch</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 2     Printer On</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu2EntryPoint</span>
        <span class="character">JSR .printerServiceCall                             ; select printer buffer</span>
        <span class="character">LDA #$94                                            ; A=$94 when inverted at next statement this = 1</span>
                                                            <span class="character">; thereby setting bit 0 of the VDU status byte (printer output enable)</span>
        <span class="character">; fall through...</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 21    Disable display</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu21EntryPoint</span>
        <span class="character">EOR #$95                                            ; if A=21  (entry from VDU 21) then A = $80</span>
                                                            <span class="character">; if A=$94 (entry from VDU 2)  then A = 1</span>
    <span class="character">.setVDUStatusByteFlags</span>
        <span class="character">ORA .vduStatusByte                                  ; VDU status byte set bit 0 or bit 7</span>
        <span class="character">BNE .storeVDUStatusByteAndReturn                    ; ALWAYS branch (since A != 0)</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 3     Printer off</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu3EntryPoint</span>
        <span class="character">JSR .printerServiceCall                             ; select printer buffer</span>
        <span class="character">LDA #10                                             ;</span>
        <span class="character">; fall through...</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 15    Paged mode off</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu15EntryPoint</span>
    <span class="character">; On Entry: A = 15 or A = 10 (paged mode off or printer off respectively)</span>
        <span class="character">EOR #$F4                                            ; Convert to $FB or $FE to clear bit 2 or 1 respectively</span>
    <span class="character">.clearVDUStatusByteFlags</span>
        <span class="character">AND .vduStatusByte                                  ; VDU status byte clear bit 0 or bit 2 of status</span>
    <span class="character">.storeVDUStatusByteAndReturn</span>
        <span class="character">STA .vduStatusByte                                  ; VDU status byte</span>
    <span class="character">-</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 4       Select text cursor</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu4EntryPoint</span>
        <span class="character">LDA .pixelsPerByteMinusOneForCurrentMode            ; pixels per byte</span>
        <span class="character">BEQ -                                               ; if (no graphics in current mode) then branch (return)</span>
        <span class="character">JSR .setTextCursor                                  ; set CRT controller for text cursor</span>
        <span class="character">LDA #%11011111                                      ; clear bit 5 of VDU status byte</span>
        <span class="character">BNE .clearVDUStatusByteFlags                        ; ALWAYs branch - clear bit 5 and exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 5       Select graphics cursor</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu5EntryPoint</span>
        <span class="character">LDA .pixelsPerByteMinusOneForCurrentMode            ; pixels per byte minus one</span>
        <span class="character">BEQ -                                               ; if (this is text mode) then branch (return)</span>
        <span class="character">LDA #32                                             ; cursor setting</span>
        <span class="character">JSR .setCursorOnOrOff                               ; Turn off cursor</span>
        <span class="character">BNE .setVDUStatusByteFlags                          ; ALWAYs branch - set bit 5 of VDU status byte and exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 8       Cursor left</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu8EntryPoint</span>
        <span class="character">JSR .isTextCursorActive                             ; Set A=0 if text cursor is active; A=$20 if graphics cursor</span>
        <span class="character">BNE .moveGraphicsCursorLeftEightPixels              ; if (currently in graphics cursor mode) then branch (to move cursor left 8 pixels)</span>
        <span class="character">DEC .vduTextCursorXPosition                         ; decrement text column</span>
        <span class="character">LDX .vduTextCursorXPosition                         ; get new text column</span>
        <span class="character">CPX .vduTextWindowLeft                              ; check against left of text window</span>
        <span class="character">BMI .wrapFromLeftEdgeToRightEdgeOfTextWindow        ; if (less than left edge of text window) then branch (wrap to right edge and one line up)</span>
        <span class="character">LDA .vduTextCursorCRTCAddressLow                    ; get text cursor CRTC address (low)</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">SBC .vduBytesPerCharacter                           ; subtract bytes per character</span>
        <span class="character">TAX                                                 ; put in X</span>
        <span class="character">LDA .vduTextCursorCRTCAddressHigh                   ; get text cursor CRTC address (high)</span>
        <span class="character">SBC #0                                              ; subtract 0 + carry</span>
        <span class="character">CMP .vduStartScreenAddressHighByte                  ; compare with high byte of screen RAM address</span>
        <span class="character">BCS +                                               ; if (text cursor is not below the start of the screen address) then branch forward</span>
        <span class="character">ADC .vduScreenSizeHighByte                          ; add screen RAM size high byte to wrap back onto screen</span>
    <span class="character">+</span>
        <span class="character">TAY                                                 ; Y=A</span>
        <span class="character">JMP .setTextCursorCRTCAddress                       ; A high and X low byte of cursor address</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.wrapFromLeftEdgeToRightEdgeOfTextWindow</span>
        <span class="character">LDA .vduTextWindowRight                             ; load text window right edge</span>
        <span class="character">STA .vduTextCursorXPosition                         ; set current text column</span>
        <span class="character">; fall through...</span>

    <span class="character">.cursorUp</span>
        <span class="character">DEC .pagedModeCounter                               ; paged mode counter</span>
        <span class="character">BPL +                                               ; if (not less than zero) then branch (skip next instruction)</span>
        <span class="character">INC .pagedModeCounter                               ; paged mode counter to restore X=0</span>
    <span class="character">+</span>
        <span class="character">LDX .vduTextCursorYPosition                         ; current text line</span>
        <span class="character">CPX .vduTextWindowTop                               ; top of text window</span>
        <span class="character">BEQ .cursorAtTopOfTextWindow                        ; if (it'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">vduTextCursorYPosition</span><span class="plain">                         ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">setDisplayAddressAndCursor</span><span class="plain">                     ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">moving</span><span class="plain"> </span><span class="identifier">cursor</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">cursorAtTopOfTextWindow</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">moveTextCursorToNextLine</span><span class="plain">                       ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">cursor</span>
        <span class="identifier">LDA</span><span class="plain"> #%00001000                                      ; </span><span class="identifier">A</span><span class="plain">=8 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">software</span><span class="plain"> </span><span class="identifier">scrolling</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">vduStatusByte</span><span class="plain">                                  ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">software</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">forward</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setScreenStartRegisterAndAdjustRAM</span><span class="plain">             ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">adjust</span><span class="plain"> </span><span class="identifier">RAM</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">skipScrolling</span><span class="plain">                                  ; </span><span class="identifier">branch</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">scrollDownwards</span><span class="plain">                                ; </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">scroll</span><span class="plain"> 1 </span><span class="identifier">line</span>
    <span class="plain">.</span><span class="identifier">skipScrolling</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">clearOneLine</span><span class="plain">                                   ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">moveGraphicsCursorLeftEightPixels</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; </span><span class="identifier">X</span><span class="plain"> = 0 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">select</span><span class="plain"> </span><span class="identifier">horizontal</span><span class="plain"> </span><span class="identifier">movement</span><span class="plain"> (</span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">left</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">moveGraphicsCursorLeftOrDown8Pixels</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;      </span><span class="identifier">X</span><span class="plain"> = 0 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">or</span>
    <span class="plain">;      </span><span class="identifier">X</span><span class="plain"> = 2 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">down</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tempStoreDB</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkGraphicsCursorIsWithinGraphicsWindow</span><span class="plain">      ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">bounds</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">tempStoreDB</span><span class="plain">                                    ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduGraphicsCursorPixelsXLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                  ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">=2 </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">movement</span><span class="plain">)</span>
        <span class="identifier">SBC</span><span class="plain"> #8                                              ; </span><span class="identifier">subtract</span><span class="plain"> 8 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">/</span><span class="identifier">down</span><span class="plain"> 1 </span><span class="identifier">character</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduGraphicsCursorPixelsXLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                  ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">=2 </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">movement</span><span class="plain">)</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">, </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">need</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">adjust</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">forward</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">vduGraphicsCursorPixelsXHigh</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">setUpExternalGraphicsCoordinates</span><span class="plain">               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">bounds</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkGraphicsCursorIsWithinGraphicsWindow</span><span class="plain">      ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">setUpExternalGraphicsCoordinates</span><span class="plain">               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bounds</span><span class="plain"> </span><span class="identifier">now</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="plain">; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="reserved">case</span><span class="plain"> </span><span class="identifier">where</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">coordinates</span><span class="plain"> </span><span class="identifier">were</span><span class="plain"> </span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">window</span><span class="plain">, </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">now</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">not</span><span class="plain">.</span>
        <span class="plain">; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">moving</span><span class="plain"> </span><span class="identifier">left</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">clamp</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">.</span>
        <span class="plain">; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">moving</span><span class="plain"> </span><span class="identifier">down</span><span class="plain"> </span><span class="identifier">clamp</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">.</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">tempStoreDB</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduGraphicsWindowPixelsRightLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">=0) </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">=2)</span>
        <span class="identifier">CPX</span><span class="plain"> #1                                              ;</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">moving</span><span class="plain"> </span><span class="identifier">down</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">forward</span>
        <span class="identifier">SBC</span><span class="plain"> #6                                              ; </span><span class="identifier">moving</span><span class="plain"> </span><span class="identifier">left</span><span class="plain">. </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">A</span><span class="plain"> - 7 (</span><span class="identifier">note</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduGraphicsCursorPixelsXLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                  ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">=2 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">vertical</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduGraphicsWindowPixelsRightHigh</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">             ; </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">=0) </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">=2) </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">SBC</span><span class="plain"> #0                                              ; </span><span class="identifier">subtract</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduGraphicsCursorPixelsXHigh</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                 ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">=2 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">vertical</span><span class="plain">)</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">graphicsCursorUp8Pixels</span><span class="plain">                        ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">moving</span><span class="plain"> </span><span class="identifier">left</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">because</span><span class="plain"> </span><span class="identifier">we</span><span class="character">'ve hit the left edge, move graphics cursor up)</span>

    <span class="character">.setUpExternalGraphicsCoordinates</span>
        <span class="character">JMP .convertInternalGraphicsCoordinatesToExternal   ; set up external coordinates for graphics</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 11       Cursor up</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu11EntryPoint</span>
        <span class="character">JSR .isTextCursorActive                             ; zero flag set means text cursor is active</span>
        <span class="character">BEQ .cursorUp                                       ; if (text cursor is active) then branch</span>
    <span class="character">.graphicsCursorUp8Pixels</span>
        <span class="character">LDX #2                                              ; set X = 2 for moving graphics cursor UP</span>
        <span class="character">BNE .moveGraphicsCursorUpOrRight8Pixels             ; ALWAYs branch</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 9        Cursor right</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu9EntryPoint</span>
        <span class="character">LDA .vduStatusByte                                  ; get VDU status byte</span>
        <span class="character">AND #%00100000                                      ; check bit 5 (graphics cursor)</span>
        <span class="character">BNE .moveGraphicsCursorRight8Pixels                 ; if (graphics cursor in use) then branch</span>
        <span class="character">LDX .vduTextCursorXPosition                         ; text column</span>
        <span class="character">CPX .vduTextWindowRight                             ; text window right</span>
        <span class="character">BCS .moveTextCursorToLeftEdgeAndDown                ; if (X exceeds window right) then branch</span>
        <span class="character">INC .vduTextCursorXPosition                         ; text column</span>
        <span class="character">LDA .vduTextCursorCRTCAddressLow                    ; text cursor CRTC address low</span>
        <span class="character">ADC .vduBytesPerCharacter                           ; add bytes per character</span>
        <span class="character">TAX                                                 ; X = new low byte of CRTC address</span>
        <span class="character">LDA .vduTextCursorCRTCAddressHigh                   ; text cursor CRTC address high</span>
        <span class="character">ADC #0                                              ; add carry. A = new high byte of CRTC address</span>
        <span class="character">JMP .setTextCursorCRTCAddress                       ; use X and A to set new text cursor CRTC address</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.moveTextCursorToLeftEdgeAndDown</span>
        <span class="character">LDA .vduTextWindowLeft                              ; text window left</span>
        <span class="character">STA .vduTextCursorXPosition                         ; text column</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.moveTextCursorDown</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">JSR .handleScrollingInPagedModeInternal             ; check text window bottom edge, X=line count</span>
        <span class="character">LDX .vduTextCursorYPosition                         ; current text line</span>
        <span class="character">CPX .vduTextWindowBottom                            ; bottom edge</span>
        <span class="character">BCS +                                               ; if (current text Y position =&gt; bottom edge) then branch</span>
        <span class="character">INC .vduTextCursorYPosition                         ; increment current text line</span>
        <span class="character">BCC .setDisplayAddressAndCursor                     ; ALWAYs branch</span>
    <span class="character">+</span>
        <span class="character">JSR .moveTextCursorToNextLine                       ; move cursor to next line</span>
        <span class="character">LDA #%00001000                                      ; check bit 3 (software scrolling)</span>
        <span class="character">BIT .vduStatusByte                                  ; test VDU status byte</span>
        <span class="character">BNE +                                               ; if (software scrolling enabled) then branch</span>
        <span class="character">JSR .hardwareScrollUp                               ; perform hardware scroll</span>
        <span class="character">BNE .clearOneLine                                   ;</span>
    <span class="character">+</span>
        <span class="character">JSR .scrollUpwards                                  ; execute upward scroll</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.clearOneLine</span>
        <span class="character">JSR .clearOneLineInternal                           ; clear a line</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.setDisplayAddressAndCursor</span>
        <span class="character">JSR .setUpCursorScreenAddresses                     ; set up cursor screen addresses</span>
        <span class="character">BCC .setCursorPositionLocal                         ;</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.moveGraphicsCursorRight8Pixels</span>
        <span class="character">LDX #0                                              ; X=0 for move cursor right</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X = 0 means move graphics cursor right</span>
    <span class="character">;   X = 2 means move graphics cursor up</span>
    <span class="character">.moveGraphicsCursorUpOrRight8Pixels</span>
        <span class="character">STX .tempStoreDB                                    ; store X</span>
        <span class="character">JSR .checkGraphicsCursorIsWithinGraphicsWindow      ; check window bounds</span>
        <span class="character">LDX .tempStoreDB                                    ; recall X</span>
        <span class="character">CLC                                                 ;</span>
        <span class="character">LDA .vduGraphicsCursorPixelsXLow,X                  ; get current graphics cursor (low)</span>
        <span class="character">ADC #8                                              ; Add 8 pixels</span>
        <span class="character">STA .vduGraphicsCursorPixelsXLow,X                  ; set current graphics cursor (low)</span>
        <span class="character">BCC +                                               ;</span>
        <span class="character">INC .vduGraphicsCursorPixelsXHigh,X                 ; set current graphics cursor (high)</span>
    <span class="character">+</span>
        <span class="character">LDA .tempStoreDA                                    ; A=0 no window violations, 1 or 2 indicates violation</span>
        <span class="character">BNE .setUpExternalGraphicsCoordinates               ; if (outside graphics window) then branch</span>
        <span class="character">JSR .checkGraphicsCursorIsWithinGraphicsWindow      ; check window bounds</span>
        <span class="character">BEQ .setUpExternalGraphicsCoordinates               ; if (within graphics window) then branch</span>

        <span class="character">LDX .tempStoreDB                                    ; get back X</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftLow,X               ; get left/bottom edge of graphics window (low) (X=0 means left, else X=2 means bottom)</span>
        <span class="character">CPX #1                                              ;</span>
        <span class="character">BCC +                                               ; if (X is 0; hit left edge) then branch</span>
        <span class="character">ADC #6                                              ; A = A + 7 (including carry)</span>
    <span class="character">+</span>
        <span class="character">STA .vduGraphicsCursorPixelsXLow,X                  ; set current graphics cursor position (low)</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftHigh,X              ; get left edge (high)</span>
        <span class="character">ADC #0                                              ; add carry</span>
        <span class="character">STA .vduGraphicsCursorPixelsXHigh,X                 ; set current graphics cursor position (high)</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">BEQ .graphicsCursorDown                             ; if (X = 0) then branch (move graphics cursor down)</span>
        <span class="character">JMP .convertInternalGraphicsCoordinatesToExternal   ; set up external coordinates for graphics</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 10       Cursor down</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu10EntryPoint</span>
        <span class="character">JSR .isTextCursorActive                             ; A=0 if text cursor active; A=$20 if graphics cursor</span>
        <span class="character">BEQ .moveTextCursorDown                             ; if (text cursor active) then branch</span>
    <span class="character">.graphicsCursorDown</span>
        <span class="character">LDX #2                                              ; X = 2 to indicate movement down</span>
        <span class="character">JMP .moveGraphicsCursorLeftOrDown8Pixels            ; move graphics cursor down</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 28       Define Text Window</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu28ParamLeftEdge   = $0320</span>
    <span class="character">.vdu28ParamBottomEdge = $0321</span>
    <span class="character">.vdu28ParamRightEdge  = $0322</span>
    <span class="character">.vdu28ParamTopEdge    = $0323</span>
    <span class="character">; Note that last parameter is always in 0323</span>

    <span class="character">.vdu28EntryPoint</span>
        <span class="character">LDX .vduCurrentScreenMode                           ; get current screen mode</span>
        <span class="character">LDA .vdu28ParamBottomEdge                           ; get bottom edge</span>
        <span class="character">CMP .vdu28ParamTopEdge                              ; compare with top edge</span>
        <span class="character">BCC .exit2                                          ; if (bottom edge exceeds top edge) then branch (return)</span>
        <span class="character">CMP .textWindowBottomRowTable,X                     ; check against text window bottom edge maximum</span>
        <span class="character">BEQ +                                               ; if (on the edge) then branch (its OK)</span>
        <span class="character">BCS .exit2                                          ; if (outside bounds) then branch (exit)</span>
    <span class="character">+</span>
        <span class="character">LDA .vdu28ParamRightEdge                            ; get right edge</span>
        <span class="character">TAY                                                 ; put it in Y</span>
        <span class="character">CMP .textWindowRightColumnTable,X                   ; text window right hand edge maximum</span>
        <span class="character">BEQ +                                               ; if (on the edge) then branch (its OK)</span>
        <span class="character">BCS .exit2                                          ; if (outside bounds) then branch (exit)</span>
    <span class="character">+</span>
        <span class="character">SEC                                                 ; set carry to subtract</span>
        <span class="character">SBC .vdu28ParamLeftEdge                             ; left edge</span>
        <span class="character">BMI .exit2                                          ; if (left edge greater than right) then branch (exit)</span>
        <span class="character">TAY                                                 ; A=Y (window width)</span>
        <span class="character">JSR .calculateBytesPerTextWindowRow                 ; calculate number of bytes in a text window row</span>
        <span class="character">LDA #%00001000                                      ; Set bit 3 of .vduStatusByte</span>
        <span class="character">JSR .setVDUStatusByteFlags                          ; indicating that text window is defined</span>
        <span class="character">LDX #.vdu28ParamLeftEdge - .vduVariablesStart       ; point to parameters</span>
        <span class="character">LDY #.vduTextWindowLeft  - .vduVariablesStart       ; point to text window edges</span>
        <span class="character">JSR .copyFourBytesWithinVDUVariables                ; Copy 4 parameters into the text window edges</span>
        <span class="character">JSR .validatePositionAndSetupScreenAddress          ; check ok and set up screen address</span>
        <span class="character">BCS .vdu30EntryPoint                                ; home cursor within window</span>
    <span class="character">.setCursorPositionLocal</span>
        <span class="character">JMP .setCursorPosition                              ; set cursor position</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   OSWORD 9       Read a pixel</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">; On entry:</span>
    <span class="character">;      .oswordA = 9</span>
    <span class="character">;      .oswordX = low byte of parameter block address</span>
    <span class="character">;      .oswordY = high byte of parameter block address</span>
    <span class="character">;  PARAMETER BLOCK:</span>
    <span class="character">;      bytes 0,1: X coordinate</span>
    <span class="character">;      bytes 2,3: Y coordinate</span>
    <span class="character">; On exit:</span>
    <span class="character">;     Result stored in byte 4 of parameter block:</span>
    <span class="character">;      $FF if point was off screen, or logical colour of point if on screen</span>
    <span class="character">;</span>
    <span class="character">.osword9EntryPoint</span>
        <span class="character">LDY #3                                              ; Y=3 to point to high byte of Y coordinate</span>
    <span class="character">-</span>
        <span class="character">LDA (.oswordX),Y                                    ; get it</span>
        <span class="character">STA .vduWorkspaceA,Y                                ; store it</span>
        <span class="character">DEY                                                 ; decrement counter</span>
        <span class="character">BPL -                                               ; loop back until done</span>
        <span class="character">LDA #$28                                            ;</span>
        <span class="character">JSR .readPixel                                      ;</span>
        <span class="character">LDY #4                                              ; Y=4</span>
        <span class="character">BNE .storeAInParameterBlock                         ; ALWAYs branch</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   OSWORD 11      Read palette</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">; On entry:</span>
    <span class="character">;      .oswordA = 11</span>
    <span class="character">;      .osWordX = low byte of parameter block address</span>
    <span class="character">;      .osWordY = high byte of parameter block address</span>
    <span class="character">;  PARAMETER BLOCK:</span>
    <span class="character">;      byte 0: logical colour to read</span>
    <span class="character">; On exit:</span>
    <span class="character">;      byte 0: logical colour</span>
    <span class="character">;      byte 1: physical colour</span>
    <span class="character">;      byte 2: zero</span>
    <span class="character">;      byte 3: zero</span>
    <span class="character">; Corresponds to reading VDU 19</span>
    <span class="character">.osword11EntryPoint</span>
        <span class="character">AND .vduNumberOfLogicalColoursMinusOne              ; number of logical colours less 1</span>
        <span class="character">TAX                                                 ; put it in X</span>
        <span class="character">LDA .vduColourPaletteStart,X                        ; get value from colour palette</span>
    <span class="character">-</span>
        <span class="character">INY                                                 ; increment Y to point to byte 1</span>
    <span class="character">.storeAInParameterBlock</span>
        <span class="character">STA (.oswordX),Y                                    ; store data</span>
        <span class="character">LDA #0                                              ; issue 0s</span>
        <span class="character">CPY #4                                              ; to next bytes until Y=4</span>
        <span class="character">BNE -                                               ;</span>
    <span class="character">.exit2</span>
        <span class="character">RTS                                                 ; and exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 12      Clear text window</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu12EntryPoint</span>
        <span class="character">JSR .isTextCursorActive                             ; A=0 if text cursor active; A=$20 if graphics cursor</span>
        <span class="character">BNE .clearGraphicsScreen                            ; if (graphics cursor active) then branch (clear graphics area)</span>
        <span class="character">LDA .vduStatusByte                                  ; VDU status byte</span>
        <span class="character">AND #%00001000                                      ; check if software scrolling (text window set)</span>
        <span class="character">BNE +                                               ; if (software scrolling) then branch</span>
        <span class="character">JMP .initializeDisplayAndHomeCursor                 ; initialise screen display and home cursor</span>
    <span class="character">+</span>
        <span class="character">LDX .vduTextWindowTop                               ; top of text window</span>
    <span class="character">-</span>
        <span class="character">STX .vduTextCursorYPosition                         ; current text line</span>
        <span class="character">JSR .clearOneLineInternal                           ; clear a line</span>

        <span class="character">LDX .vduTextCursorYPosition                         ; current text line</span>
        <span class="character">CPX .vduTextWindowBottom                            ; bottom edge</span>
        <span class="character">INX                                                 ; X=X+1</span>
        <span class="character">BCC -                                               ; if (not reached bottom edge yet) then branch (loop back and clear the next row)</span>
        <span class="character">; fall through...</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 30      Home Cursor</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu30EntryPoint</span>
        <span class="character">JSR .isTextCursorActive                             ; A=0 if text cursor active; A=$20 if graphics cursor</span>
        <span class="character">BEQ +                                               ; if (text cursor active) then branch</span>
        <span class="character">JMP .graphicsCursorHome                             ; home graphic cursor</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">+</span>
        <span class="character">STA .vdu31ParamYCoordinate                          ; store 0 in last two parameters</span>
        <span class="character">STA .vdu31ParamXCoordinate                          ;</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 31      Position text cursor</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu31ParamXCoordinate = $0322</span>
    <span class="character">.vdu31ParamYCoordinate = $0323</span>
    <span class="character">.vdu31EntryPoint</span>
        <span class="character">JSR .isTextCursorActive                             ; A=0 if text cursor active; A=$20 if graphics cursor</span>
        <span class="character">BNE .exit2                                          ; if (graphics cursor active) then branch (exit)</span>
        <span class="character">JSR +                                               ; exchange text column/line with workspace .vduWorkspaceA/B</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">LDA .vdu31ParamXCoordinate                          ; get X coordinate</span>
        <span class="character">ADC .vduTextWindowLeft                              ; add to text window left</span>
        <span class="character">STA .vduTextCursorXPosition                         ; store as text column</span>
        <span class="character">LDA .vdu31ParamYCoordinate                          ; get Y coordinate</span>
        <span class="character">CLC                                                 ;</span>
        <span class="character">ADC .vduTextWindowTop                               ; add top of text window</span>
        <span class="character">STA .vduTextCursorYPosition                         ; current text line</span>
        <span class="character">JSR .validatePositionAndSetupScreenAddress          ; set up screen address</span>
        <span class="character">BCC .setCursorPositionLocal                         ; if (carry clear, ie. on screen) then branch (set cursor position)</span>
    <span class="character">+</span>
        <span class="character">LDX #&lt;.vduTextCursorXPosition                       ; point to text cursor position (low byte)</span>
        <span class="character">LDY #&lt;.vduWorkspaceA                                ; point to vdu workspace (low byte)</span>
        <span class="character">JMP .swapTwoVDUVariables                            ; exchange text cursor position with workspace .vduWorkspaceA/B</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 13      Carriage Return</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu13EntryPoint</span>
        <span class="character">JSR .isTextCursorActive                             ; A=0 if text cursor active; A=$20 if graphics cursor</span>
        <span class="character">BEQ +                                               ; if (text cursor active) then branch</span>
        <span class="character">JMP .setGraphicsCursorToLeftHandColumn              ; set graphics cursor to left hand columm</span>
    <span class="character">+</span>
        <span class="character">JSR .setTextCursorToLeftHandColumn                  ; set text column to left hand column</span>
        <span class="character">JMP .setDisplayAddressAndCursor                     ; set up cursor and display address</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.clearGraphicsScreen</span>
        <span class="character">JSR .graphicsCursorHome                             ; home graphic cursor</span>
        <span class="character">; fall through...</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 16      Clear graphics window</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu16EntryPoint</span>
        <span class="character">LDA .pixelsPerByteMinusOneForCurrentMode                    ; pixels per byte</span>
        <span class="character">BEQ .exitNoGraphics                                         ; if (current mode has no graphics) then branch (exit)</span>
        <span class="character">LDX .vduBackgroundGraphicsColour                            ; Background graphics colour</span>
        <span class="character">LDY .vduBackgroundGCOLMode                                  ; background graphics plot mode (GCOL n)</span>
        <span class="character">JSR .setGraphicsColourMaskXY                                ; set graphics byte mask in .graphicsColourByteOR/EOR</span>
        <span class="character">LDX #.vduGraphicsWindowPixelsLeftLow - .vduVariablesStart   ; source      = graphics window</span>
        <span class="character">LDY #.vduWorkspaceA - .vduVariablesStart                    ; destination = workspace</span>
        <span class="character">JSR .copy8BytesWithinVDUVariables                           ; copy graphics window coordinates to workspace</span>
        <span class="character">SEC                                                         ; set carry</span>
        <span class="character">LDA .vduGraphicsWindowPixelsTopLow                          ; graphics window top low</span>
        <span class="character">SBC .vduGraphicsWindowPixelsBottomLow                       ; graphics window bottom low</span>
        <span class="character">TAY                                                         ; Y=difference</span>
        <span class="character">INY                                                         ; increment</span>
        <span class="character">STY .vduClearGraphicsWindowLineCount                        ; and store in workspace (this is line count)</span>
    <span class="character">-</span>
        <span class="character">LDX #.vduWorkspaceE - .vduVariablesStart                    ; graphics window right column</span>
        <span class="character">LDY #.vduWorkspaceA - .vduVariablesStart                    ; graphics window left column</span>
        <span class="character">JSR .fillRow                                                ; fillRow</span>
        <span class="character">LDA .vduWorkspaceG                                          ; decrement window height in pixels</span>
        <span class="character">BNE +                                                       ;</span>
        <span class="character">DEC .vduWorkspaceH                                          ;</span>
    <span class="character">+</span>
        <span class="character">DEC .vduWorkspaceG                                          ;</span>
        <span class="character">DEC .vduClearGraphicsWindowLineCount                        ; decrement line count</span>
        <span class="character">BNE -                                                       ; if (not zero) then branch (do it again)</span>
    <span class="character">.exitNoGraphics</span>
        <span class="character">RTS                                                         ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 17      Define text colour</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu17EntryPoint</span>
        <span class="character">LDY #0                                              ; Y = 0</span>
        <span class="character">BEQ .defineTextOrGraphicsColour                     ; ALWAYS branch</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 18      Define graphics colour</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu18ParameterGCOLNumber           = $322</span>
    <span class="character">.vdu18ParameterLogicalColour        = $323</span>

    <span class="character">.vdu18EntryPoint</span>
        <span class="character">LDY #2                                              ; Y = 2</span>

    <span class="character">.defineTextOrGraphicsColour</span>
        <span class="character">LDA .vdu18ParameterLogicalColour                    ; get last parameter</span>
        <span class="character">BPL +                                               ; if (not negative, it'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">foreground</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">y</span>
    <span class="plain">+</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">              ; </span><span class="identifier">ensure</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">most</span><span class="plain"> </span><span class="character">'number of logical colours less 1'</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">              ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> 1</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit3</span><span class="plain">                                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> #7                                              ; </span><span class="identifier">limit</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">available</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">M</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">table</span><span class="plain">.</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">tables</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain">.</span>
                                                            <span class="plain">; </span><span class="identifier">X</span><span class="plain"> = (</span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> - 1 + </span><span class="identifier">logicalColour</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">twoColourModeParameterTable</span><span class="plain">-1,</span><span class="identifier">X</span><span class="plain">                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">options</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduForegroundTextColour</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                      ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain">:</span>
                                                            <span class="plain">;       </span><span class="identifier">Y</span><span class="plain">=0 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">foreground</span>
                                                            <span class="plain">;       </span><span class="identifier">Y</span><span class="plain">=1 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">background</span>
                                                            <span class="plain">;       </span><span class="identifier">Y</span><span class="plain">=2 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">foreground</span>
                                                            <span class="plain">;       </span><span class="identifier">Y</span><span class="plain">=3 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">background</span>
        <span class="identifier">CPY</span><span class="plain"> #2                                              ;</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">setGraphicsGCOLColour</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">changed</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduForegroundTextColour</span><span class="plain">                        ; </span><span class="identifier">foreground</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">EOR</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">invert</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">textColourByteEOR</span><span class="plain">                              ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">EORed</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">vduBackgroundTextColour</span><span class="plain">                        ; </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">textColourByteOR</span><span class="plain">                               ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ORred</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">memory</span>
    <span class="plain">.</span><span class="identifier">exit3</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setGraphicsGCOLColour</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu18ParameterGCOLNumber</span><span class="plain">                       ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">parameter</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduForegroundGraphicsColour</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                  ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">=0=</span><span class="identifier">foreground</span><span class="plain">; 1=</span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">etc</span><span class="plain">.</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">restoreMode7TextBackgroundColour</span>
        <span class="identifier">LDA</span><span class="plain"> #32                                             ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduBackgroundTextColour</span><span class="plain">                        ; </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">VDU</span><span class="plain"> 20      </span><span class="identifier">Restore</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">colours</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu20EntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> #5                                              ; </span><span class="identifier">X</span><span class="plain"> = 5</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain"> = 0</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduForegroundTextColour</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                      ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">colours</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ;</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=$</span><span class="identifier">FF</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">              ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> 1</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">restoreMode7TextBackgroundColour</span><span class="plain">               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">none</span><span class="plain">, </span><span class="identifier">it</span><span class="character">'s MODE 7) then branch</span>
        <span class="character">LDA #$FF                                            ; A=$FF</span>
        <span class="character">CPX #15                                             ;</span>
        <span class="character">BNE +                                               ; if (not 16 colours; ie. not MODE 2) then branch</span>
        <span class="character">LDA #$3F                                            ; A=$3F</span>
    <span class="character">+</span>
        <span class="character">STA .vduForegroundTextColour                        ; foreground text colour</span>
        <span class="character">STA .vduForegroundGraphicsColour                    ; foreground graphics colour</span>
        <span class="character">EOR #$FF                                            ; invert A</span>
        <span class="character">STA .textColourByteOR                               ; text colour byte to be OR-ed into memory</span>
        <span class="character">STA .textColourByteEOR                              ; text colour byte to be EOR-ed into memory</span>
        <span class="character">STX .vdu19ParameterLogicalColour                    ; set first parameter of 5</span>
        <span class="character">CPX #3                                              ;</span>
        <span class="character">BEQ .restore4Colours                                ; if (there are 4 colours) then branch</span>
        <span class="character">BCC .restore2Colours                                ; if (there are 2 colours) then branch</span>
    <span class="character">.restore16Colours                                       ; there are 16 colours</span>
        <span class="character">STX .vdu19ParameterPhysicalColour                   ; set second parameter</span>
    <span class="character">-</span>
        <span class="character">JSR .vdu19EntryPoint                                ; VDU 19 - define logical colour</span>
        <span class="character">DEC .vdu19ParameterPhysicalColour                   ; decrement first parameter</span>
        <span class="character">DEC .vdu19ParameterLogicalColour                    ; and last parameter</span>
        <span class="character">BPL -                                               ;</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.restore4Colours</span>
        <span class="character">LDX #7                                              ; X = 7</span>
        <span class="character">STX .vdu19ParameterPhysicalColour                   ; set first parameter</span>
    <span class="character">-</span>
        <span class="character">JSR .vdu19EntryPoint                                ; and do VDU 19</span>
        <span class="character">LSR .vdu19ParameterPhysicalColour                   ;</span>
        <span class="character">DEC .vdu19ParameterLogicalColour                    ;</span>
        <span class="character">BPL -                                               ;</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.restore2Colours</span>
        <span class="character">LDX #7                                              ; X = 7</span>
        <span class="character">JSR +                                               ; store physical colour and execute VDU 19</span>
        <span class="character">LDX #0                                              ; X = 0</span>
        <span class="character">STX .vdu19ParameterLogicalColour                    ; store it as</span>
    <span class="character">+</span>
        <span class="character">STX .vdu19ParameterPhysicalColour                   ; both parameters</span>
        <span class="character">; fall through...</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">;   VDU 19      Write palette - Map a logical colour to a physical colour</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu19ParameterLogicalColour  = $031F</span>
    <span class="character">.vdu19ParameterPhysicalColour = $0320</span>

    <span class="character">.vdu19EntryPoint</span>
        <span class="character">PHP                                                 ; push processor flags</span>
        <span class="character">SEI                                                 ; disable interrupts</span>
        <span class="character">LDA .vdu19ParameterLogicalColour                    ; get logical colour</span>
        <span class="character">AND .vduNumberOfLogicalColoursMinusOne              ; AND with number of logical colours less 1 to make legal.</span>
        <span class="character">TAX                                                 ; Store logical colour in X</span>
        <span class="character">LDA .vdu19ParameterPhysicalColour                   ; A=physical colour</span>
    <span class="character">.writePaletteAX</span>
        <span class="character">AND #15                                             ; make legal</span>
        <span class="character">STA .vduColourPaletteStart,X                        ; store physical in colour palette</span>
        <span class="character">TAY                                                 ; Remember physical colour in Y</span>
        <span class="character">LDA .vduNumberOfLogicalColoursMinusOne              ; number of logical colours less 1</span>
        <span class="character">STA .tempStoreFA                                    ; store it</span>
        <span class="character">CMP #3                                              ; is it 4 colour mode?</span>
        <span class="character">PHP                                                 ; save flags</span>
        <span class="character">TXA                                                 ; Recall A = logical colour</span>
    <span class="character">-</span>
        <span class="character">ROR                                                 ; rotate the logical colour (A) into the top bits of .tempStoreFA</span>
        <span class="character">ROR .tempStoreFA                                    ; rotate the (number of colours in the mode-1) down by one bit</span>
        <span class="character">BCS -                                               ; if (there are more set bits) then branch (loop back)</span>
        <span class="character">ASL .tempStoreFA                                    ; The final rotate wasn'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain">, </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">rectify</span>
                                                            <span class="plain">; </span><span class="identifier">At</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain"> </span><span class="identifier">holds</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">N</span><span class="plain"> </span><span class="identifier">bits</span>
                                                            <span class="plain">; </span><span class="identifier">where</span><span class="plain"> </span><span class="identifier">N</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">required</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain">.</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">Recall</span><span class="plain"> </span><span class="identifier">physical</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">We</span><span class="plain"> </span><span class="identifier">OR</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">physical</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">bits</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">. </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">working</span><span class="plain"> </span><span class="identifier">towards</span><span class="plain"> </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span>
                                                            <span class="plain">; </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">palette</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">Video</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain">.</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0</span>
    <span class="plain">-</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">notFourColourMode</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain">; </span><span class="identifier">A</span><span class="plain">!=3 </span><span class="identifier">earlier</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">AND</span><span class="plain"> #%01100000                                      ; </span><span class="identifier">special</span><span class="plain"> </span><span class="reserved">case</span><span class="plain"> </span><span class="identifier">coding</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">modes</span><span class="plain">. </span><span class="identifier">Test</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 5 </span><span class="identifier">and</span><span class="plain"> 6</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">both</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">CMP</span><span class="plain"> #%01100000                                      ;</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">both</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">Recall</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">value</span><span class="plain">.</span>
        <span class="identifier">EOR</span><span class="plain"> #%01100000                                      ; </span><span class="identifier">Invert</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 5 </span><span class="identifier">and</span><span class="plain"> 6 (</span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">other</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">).</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">notFourColourMode</span><span class="plain">                              ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain">. </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">palette</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">Video</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain">.</span>

    <span class="plain">+</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
    <span class="plain">.</span><span class="identifier">notFourColourMode</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte155Internal</span><span class="plain">                              ; </span><span class="identifier">Pass</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">palette</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ;</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">              ;</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">Y</span><span class="plain"> + </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> - 1</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> #16                                             ;</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">X</span><span class="plain"> + 16</span>
        <span class="identifier">CPY</span><span class="plain"> #16                                             ;</span>
        <span class="identifier">BCC</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain"> &lt; 16) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">twice</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">OSWORD</span><span class="plain"> 12      </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">Palette</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">YX</span><span class="plain"> </span><span class="identifier">points</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">block</span>
    <span class="plain">;   </span><span class="identifier">PARAMETER</span><span class="plain"> </span><span class="identifier">BLOCK</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">byte</span><span class="plain"> 0: </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colour</span>
    <span class="plain">;       </span><span class="identifier">byte</span><span class="plain"> 1: </span><span class="identifier">physical</span><span class="plain"> </span><span class="identifier">colour</span>
    <span class="plain">;       </span><span class="identifier">byte</span><span class="plain"> 2: </span><span class="identifier">zero</span>
    <span class="plain">;       </span><span class="identifier">byte</span><span class="plain"> 3: </span><span class="identifier">zero</span>
    <span class="plain">;       </span><span class="identifier">byte</span><span class="plain"> 4: </span><span class="identifier">zero</span>
    <span class="plain">.</span><span class="identifier">osword12EntryPoint</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">              ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> 1</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">oswordX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">physical</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">writePaletteAX</span><span class="plain">                                 ; </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">VDU19</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">A</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">VDU</span><span class="plain"> 22      </span><span class="identifier">Select</span><span class="plain"> </span><span class="identifier">Mode</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu22Parameter</span><span class="plain"> = $0323</span>

    <span class="plain">.</span><span class="identifier">vdu22EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu22Parameter</span><span class="plain">                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">parameter</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">setMODE</span><span class="plain">                                        ; </span><span class="identifier">change</span><span class="plain"> </span><span class="identifier">mode</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">VDU</span><span class="plain"> 23      </span><span class="identifier">Define</span><span class="plain"> </span><span class="identifier">Character</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu23ParameterLogicalColour</span><span class="plain"> = $031</span><span class="identifier">B</span>
    <span class="plain">.</span><span class="identifier">vdu23Parameter1</span><span class="plain"> = $031</span><span class="identifier">B</span>
    <span class="plain">.</span><span class="identifier">vdu23Parameter2</span><span class="plain"> = $031</span><span class="identifier">C</span>
    <span class="plain">.</span><span class="identifier">vdu23Parameter3</span><span class="plain"> = $031</span><span class="identifier">D</span>
    <span class="plain">.</span><span class="identifier">vdu23Parameter4</span><span class="plain"> = $031</span><span class="identifier">E</span>
    <span class="plain">.</span><span class="identifier">vdu23Parameter5</span><span class="plain"> = $031</span><span class="identifier">F</span>
    <span class="plain">.</span><span class="identifier">vdu23Parameter6</span><span class="plain"> = $0320</span>
    <span class="plain">.</span><span class="identifier">vdu23Parameter7</span><span class="plain"> = $0321</span>
    <span class="plain">.</span><span class="identifier">vdu23Parameter8</span><span class="plain"> = $0322</span>
    <span class="plain">.</span><span class="identifier">vdu23Parameter9</span><span class="plain"> = $0323</span>

    <span class="plain">.</span><span class="identifier">vdu23EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu23ParameterLogicalColour</span><span class="plain">                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">define</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charSPACE</span><span class="plain">                                     ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">vdu23SetCRTCRegister</span><span class="plain">                           ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">SPACE</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">CRT</span><span class="plain"> </span><span class="reserved">register</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">parameter</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">A</span><span class="plain"> / 32</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">zone</span><span class="plain"> (1-7) </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fontMaskTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                ; </span><span class="identifier">look</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">single</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">representing</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">zone</span><span class="plain"> (</span><span class="identifier">character</span><span class="plain"> / 32)</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">vduFontFlags</span><span class="plain">                                   ; </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">storage</span><span class="plain"> </span><span class="identifier">area</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">established</span><span class="plain"> </span><span class="identifier">already</span><span class="plain">)</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">vduFontFlags</span><span class="plain">                                   ; </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">found</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> 0</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduFontFlags</span><span class="plain">                                   ; </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">zone</span><span class="plain"> (1-7)</span>
        <span class="identifier">AND</span><span class="plain"> #3                                              ; </span><span class="identifier">AND</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> 3 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0 </span><span class="identifier">and</span><span class="plain"> 1 (</span><span class="identifier">A</span><span class="plain"> = 1, 2, 3)</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> #&gt;.</span><span class="identifier">characterDefinitions</span><span class="plain"> - 1                     ; </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">C0</span><span class="plain">, $</span><span class="identifier">C1</span><span class="plain">, $</span><span class="identifier">C2</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">select</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">page</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">ROM</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDF</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduFontZoneAddressesHigh</span><span class="plain">-1,</span><span class="identifier">X</span><span class="plain">                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDD</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ;</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ;</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreDE</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">tempStoreDC</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ;</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ;</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>
    <span class="plain">+</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setupCharacterDefinitionAddress</span><span class="plain">                ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">pointers</span>
        <span class="identifier">LDY</span><span class="plain"> #7                                              ; </span><span class="identifier">Y</span><span class="plain">=7</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu23Parameter2</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                              ; </span><span class="identifier">transfer</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">parameters</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">tempStoreDE</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">definition</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ;</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">unused</span>
    <span class="plain">.</span><span class="identifier">exit4</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vduParameter5</span><span class="plain"> = $031</span><span class="identifier">F</span>
    <span class="plain">.</span><span class="identifier">vduPlotExtension</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduParameter5</span><span class="plain">                                  ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">fifth</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">parameter</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
    <span class="plain">-</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorVDUV</span><span class="plain">)                                   ; </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">VDUV</span><span class="plain"> </span><span class="identifier">vector</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu23SetCRTCRegister</span>
        <span class="identifier">CMP</span><span class="plain"> #1                                              ; </span><span class="identifier">does</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=1</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">vdu23CommaZeroSetCRTCRegister</span><span class="plain">                  ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain"> = 0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="reserved">register</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain"> != 1) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">VDUV</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">isTextCursorActive</span><span class="plain">                             ; </span><span class="identifier">Zero</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">active</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">exit4</span><span class="plain">                                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">active</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>

        <span class="plain">; </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain">...</span>
        <span class="identifier">LDA</span><span class="plain"> #32                                             ;</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vdu23Parameter2</span><span class="plain">                                ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">parameter</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">setCursorOnOrOff</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">=0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">off</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">setTextCursor</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduLastCursorStartRegisterValue</span><span class="plain">                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">ON</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">setCursorOnOrOff</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">crtcCursorStartRegister</span><span class="plain">                       ; </span><span class="identifier">Y</span><span class="plain"> = .</span><span class="identifier">crtcCursorStartRegister</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">setCRTCRegisterDirect</span><span class="plain">                          ; </span><span class="identifier">ALWAYS</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu23CommaZeroSetCRTCRegister</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu23Parameter3</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">third</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vdu23Parameter2</span><span class="plain">                                ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">parameter</span>
    <span class="plain">.</span><span class="identifier">setCRTCRegisterAY</span>
        <span class="identifier">CPY</span><span class="plain"> #.</span><span class="identifier">crtcVerticalSyncPositionRegister</span><span class="plain">              ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">setCRTCRegisterDirect</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain"> &lt; 7) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">directly</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain"> &gt; 7) </span><span class="identifier">branch</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduVerticalAdjust</span><span class="plain">                              ; </span><span class="identifier">ADD</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain">=1 </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">adjustment</span>
    <span class="plain">+</span>
        <span class="identifier">CPY</span><span class="plain"> #.</span><span class="identifier">crtcInterlaceAndDelayRegister</span><span class="plain">                 ;</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain"> != 8) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">ORA</span><span class="plain"> #0                                              ; </span><span class="identifier">test</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">set</span>
        <span class="identifier">BMI</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">set</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">vduInterlaceValue</span><span class="plain">                              ; </span><span class="identifier">EOR</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">interlace</span><span class="plain"> </span><span class="identifier">toggle</span>
    <span class="plain">+</span>
        <span class="identifier">CPY</span><span class="plain"> #.</span><span class="identifier">crtcCursorStartRegister</span><span class="plain">                       ;</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">setCRTCRegisterDirect</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain"> != 10) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> - </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">directly</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduLastCursorStartRegisterValue</span><span class="plain">                ; </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">CRT</span><span class="plain"> </span><span class="identifier">controller</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduStatusByte</span><span class="plain">                                  ; </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">AND</span><span class="plain"> #%00100000                                      ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 5 (</span><span class="identifier">printing</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain">)</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">crtcCursorStartRegister</span><span class="plain">                       ; </span><span class="identifier">Y</span><span class="plain">=10</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">active</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setCRTCRegisterDirect</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">crtcAddressRegister</span><span class="plain">                            ; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">crtcAddressWrite</span><span class="plain">                               ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">Y</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">VDU</span><span class="plain"> 25      </span><span class="identifier">Plot</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu25EntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">pixelsPerByteMinusOneForCurrentMode</span><span class="plain">            ; </span><span class="identifier">pixels</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">vduPlotExtension</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">available</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">extension</span><span class="plain">)</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">vdu25Plot</span><span class="plain">                                      ; </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">main</span><span class="plain"> </span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">routine</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setScreenStartRegisterAndAdjustRAM</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressLow</span><span class="plain">                     ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressHigh</span><span class="plain">                    ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">subtractNumberOfBytesInALineToAX</span><span class="plain">               ; </span><span class="identifier">subtract</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">this</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">wraparound</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduScreenSizeHighByte</span><span class="plain">                          ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">wrap</span><span class="plain"> </span><span class="identifier">around</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ;</span>

    <span class="plain">.</span><span class="identifier">hardwareScrollUp</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressLow</span><span class="plain">                     ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressHigh</span><span class="plain">                    ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">addNumberOfBytesInACharacterRowToAX</span><span class="plain">            ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ;</span>

        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">wrap</span><span class="plain"> </span><span class="identifier">around</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduScreenSizeHighByte</span><span class="plain">                          ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressHigh</span><span class="plain">                    ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressLow</span><span class="plain">                     ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LDY</span><span class="plain"> #12                                             ; </span><span class="identifier">Y</span><span class="plain">=12</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">setCursorPositionInternal</span><span class="plain">                      ; </span><span class="identifier">ALWAYS</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">VDU</span><span class="plain"> 26      </span><span class="identifier">Reset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">use</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">windows</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu26EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">LDX</span><span class="plain"> #$2</span><span class="identifier">C</span><span class="plain">                                            ; </span><span class="identifier">X</span><span class="plain">=$2</span><span class="identifier">C</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                            ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">whole</span><span class="plain"> </span><span class="identifier">bunch</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">vdu</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain">,</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">including</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">windows</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=$</span><span class="identifier">FF</span>

        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduCurrentScreenMode</span><span class="plain">                           ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">textWindowRightColumnTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                   ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">hand</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">maximum</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">vduTextWindowRight</span><span class="plain">                             ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">right</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">calculateBytesPerTextWindowRow</span><span class="plain">                 ; </span><span class="identifier">calculate</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">row</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">textWindowBottomRowTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">maximum</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">vduTextWindowBottom</span><span class="plain">                            ; </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span>
        <span class="identifier">LDY</span><span class="plain"> #3                                              ;</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">vdu24ParameterTopEdgeHigh</span><span class="plain">                      ; </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">    = 3</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">vdu24ParameterRightEdgeHigh</span><span class="plain">                    ; </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">  = 4</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">vdu24ParameterTopEdgeLow</span><span class="plain">                       ; </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">low</span><span class="plain">          = $</span><span class="identifier">FF</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">vdu24ParameterRightEdgeLow</span><span class="plain">                     ; </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">low</span><span class="plain">        = $</span><span class="identifier">FF</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">vdu24EntryPoint</span><span class="plain">                                ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> 24 (</span><span class="identifier">define</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">window</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #%11110111                                      ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearVDUStatusByteFlags</span><span class="plain">                        ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 3 </span><span class="identifier">of</span><span class="plain"> .</span><span class="identifier">vduStatusByte</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressLow</span><span class="plain">                     ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressHigh</span><span class="plain">                    ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span>
    <span class="plain">.</span><span class="identifier">setTextCursorCRTCAddress</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduTextCursorCRTCAddressLow</span><span class="plain">                    ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduTextCursorCRTCAddressHigh</span><span class="plain">                   ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">setCursorPosition</span><span class="plain">                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ;</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduScreenSizeHighByte</span><span class="plain">                          ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setCursorPosition</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">AX</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ;</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduTextCursorCRTCAddressLow</span><span class="plain">                    ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextCursorCRTCAddressHigh</span><span class="plain">                   ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">crtcCursorPositionHigh</span><span class="plain">                        ; </span><span class="identifier">Y</span><span class="plain">=14</span>
    <span class="plain">.</span><span class="identifier">setCursorPositionInternal</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduCurrentScreenMode</span><span class="plain">                           ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">CMP</span><span class="plain"> #7                                              ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> 7?</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">Restore</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">setCursorPositionMode7</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">mode</span><span class="plain"> 7 </span><span class="identifier">selected</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">divide</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">/</span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> 8</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ;</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ;</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">setTwoCRTCRegisters</span><span class="plain">                            ; </span><span class="identifier">jump</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setCursorPositionMode7</span>
        <span class="identifier">SBC</span><span class="plain"> #$74                                            ; </span><span class="identifier">mode</span><span class="plain"> 7 </span><span class="identifier">subtract</span><span class="plain"> $74</span>
        <span class="identifier">EOR</span><span class="plain"> #$20                                            ; </span><span class="identifier">EOR</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> $20. </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">What</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">arithmetic</span><span class="plain"> </span><span class="reserved">for</span><span class="plain">?</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setTwoCRTCRegisters</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">crtcAddressRegister</span><span class="plain">                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">into</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">crtcAddressWrite</span><span class="plain">                               ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">crtcAddressRegister</span><span class="plain">                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">into</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">crtcAddressWrite</span><span class="plain">                               ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">RETURN</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">VDU</span><span class="plain"> 24      </span><span class="identifier">Define</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">window</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu24ParameterLeftEdgeLow</span><span class="plain">      = $031</span><span class="identifier">C</span>
    <span class="plain">.</span><span class="identifier">vdu24ParameterLeftEdgeHigh</span><span class="plain">     = $031</span><span class="identifier">D</span>
    <span class="plain">.</span><span class="identifier">vdu24ParameterBottomEdgeLow</span><span class="plain">    = $031</span><span class="identifier">E</span>
    <span class="plain">.</span><span class="identifier">vdu24ParameterBottomEdgeHigh</span><span class="plain">   = $031</span><span class="identifier">F</span>
    <span class="plain">.</span><span class="identifier">vdu24ParameterRightEdgeLow</span><span class="plain">     = $0320</span>
    <span class="plain">.</span><span class="identifier">vdu24ParameterRightEdgeHigh</span><span class="plain">    = $0321</span>
    <span class="plain">.</span><span class="identifier">vdu24ParameterTopEdgeLow</span><span class="plain">       = $0322</span>
    <span class="plain">.</span><span class="identifier">vdu24ParameterTopEdgeHigh</span><span class="plain">      = $0323</span>

    <span class="plain">.</span><span class="identifier">vdu24EntryPoint</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">exchangeGraphicsCursorPositionWithWorkspaceAD</span><span class="plain">          ; </span><span class="identifier">exchange</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> .</span><span class="identifier">vduWorkspaceABCD</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vdu24ParameterLeftEdgeLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">        ; </span><span class="identifier">Source</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> (</span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduWorkspaceE</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">                    ; </span><span class="identifier">Destination</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> /</span><span class="identifier">height</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> .</span><span class="identifier">vduworkspaceEFGH</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">coordinateSubtraction</span><span class="plain">                                  ; </span><span class="identifier">calculate</span><span class="plain">  </span><span class="identifier">width</span><span class="plain"> = </span><span class="identifier">right</span><span class="plain"> - </span><span class="identifier">left</span>
                                                                    <span class="plain">;           </span><span class="identifier">height</span><span class="plain"> = </span><span class="identifier">top</span><span class="plain"> - </span><span class="identifier">bottom</span>
                                                                    <span class="plain">;                </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">height</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">vduWorkspaceF</span><span class="plain">                                          ; </span><span class="identifier">OR</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">width</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">exchangeGraphicsCursorPositionWithWorkspaceAD</span><span class="plain">          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">either</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">height</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">exchange</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vdu24ParameterRightEdgeLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">       ; </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">plotConvertAbsoluteCoordinatesToPixels</span><span class="plain">                 ; </span><span class="identifier">scale</span><span class="plain"> </span><span class="identifier">pointers</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vdu24ParameterLeftEdgeLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">        ; </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">plotConvertAbsoluteCoordinatesToPixels</span><span class="plain">                 ; </span><span class="identifier">scale</span><span class="plain"> </span><span class="identifier">pointers</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu24ParameterBottomEdgeHigh</span><span class="plain">                           ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain"> </span><span class="identifier">edges</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">vdu24ParameterLeftEdgeHigh</span><span class="plain">                             ;</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">exchangeGraphicsCursorPositionWithWorkspaceAD</span><span class="plain">          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">exchange</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu24ParameterTopEdgeHigh</span><span class="plain">                              ;</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">exchangeGraphicsCursorPositionWithWorkspaceAD</span><span class="plain">          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">non</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">exchange</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduCurrentScreenMode</span><span class="plain">                                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu24ParameterRightEdgeHigh</span><span class="plain">                            ; </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                            ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu24ParameterRightEdgeLow</span><span class="plain">                             ; </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                            ; /2</span>
        <span class="identifier">ROR</span><span class="plain">                                                         ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">/2</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                            ; /2</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">exchangeGraphicsCursorPositionWithWorkspaceAD</span><span class="plain">          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">exchange</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">ROR</span><span class="plain">                                                         ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">/2</span>
        <span class="identifier">LSR</span><span class="plain">                                                         ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">/2</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">textWindowRightColumnTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">hand</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">maximum</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                                       ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">equal</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">exchangeGraphicsCursorPositionWithWorkspaceAD</span><span class="plain">          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">exchange</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDY</span><span class="plain"> #$00                                                    ; </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="identifier">LDX</span><span class="plain"> #$1</span><span class="identifier">C</span><span class="plain">                                                    ; </span><span class="identifier">X</span><span class="plain">=$1</span><span class="identifier">C</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copy8BytesWithinVDUVariables</span><span class="plain">                           ; </span><span class="identifier">set</span><span class="plain">(300/7+</span><span class="identifier">Y</span><span class="plain">) </span><span class="identifier">from</span><span class="plain"> (300/7+</span><span class="identifier">X</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">exchangeGraphicsCursorPositionWithWorkspaceAD</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vduGraphicsCursorPositionXLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">    ; </span><span class="identifier">X</span><span class="plain">=$10</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduWorkspaceA</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">                    ; </span><span class="identifier">Y</span><span class="plain">=$28</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">exchangeFourVariables</span><span class="plain">                                  ; </span><span class="identifier">exchange</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">bytes</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">calculateBytesPerTextWindowRow</span>
        <span class="identifier">INY</span><span class="plain">                                                 ;</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">vduTextWindowWidthInBytesHigh</span><span class="plain">                  ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> (</span><span class="identifier">bytes</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduTextWindowWidthInBytesLow</span><span class="plain">                   ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> (</span><span class="identifier">bytes</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacter</span><span class="plain">                           ; </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; /2</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
    <span class="plain">-</span>
        <span class="identifier">ASL</span><span class="plain"> .</span><span class="identifier">vduTextWindowWidthInBytesLow</span><span class="plain">                   ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> (</span><span class="identifier">bytes</span><span class="plain">)</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">vduTextWindowWidthInBytesHigh</span><span class="plain">                  ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> (</span><span class="identifier">bytes</span><span class="plain">)</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; /2</span>
        <span class="identifier">BCC</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">VDU</span><span class="plain"> 29      </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">origin</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu29ParameterStart</span><span class="plain"> = $320</span>

    <span class="plain">.</span><span class="identifier">vdu29EntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vdu29ParameterStart</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">          ; }</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduGraphicsWindowOriginXLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">  ; } </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">vdu</span><span class="plain"> </span><span class="identifier">queue</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">origin</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyFourBytesWithinVDUVariables</span><span class="plain">                    ; }</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">convertInternalGraphicsCoordinatesToExternal</span><span class="plain">       ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">external</span><span class="plain"> </span><span class="identifier">coordinates</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">graphics</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">VDU</span><span class="plain"> 127     </span><span class="identifier">Delete</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu127EntryPoint</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">vdu8EntryPoint</span><span class="plain">                                 ; </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">left</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">isTextCursorActive</span><span class="plain">                             ; </span><span class="identifier">A</span><span class="plain">=0 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">active</span><span class="plain">; </span><span class="identifier">A</span><span class="plain">=$20 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">deleteGraphicsCursor</span><span class="plain">                           ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">active</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">              ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> 1</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">deleteMode7</span><span class="plain">                                    ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">mode</span><span class="plain"> 7) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">always</span><span class="plain"> 0)</span>
        <span class="identifier">LDA</span><span class="plain"> #&gt;.</span><span class="identifier">characterDefinitions</span><span class="plain">                         ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">ROM</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDF</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">tempStoreDF</span><span class="plain"> (.</span><span class="identifier">tempStoreDE</span><span class="plain">) </span><span class="identifier">now</span><span class="plain"> </span><span class="identifier">points</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">SPACE</span><span class="plain"> </span><span class="identifier">pattern</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">displayACharacterAtAddress</span><span class="plain">                     ; </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">space</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">deleteMode7</span>
        <span class="identifier">LDA</span><span class="plain"> #</span><span class="character">' '</span><span class="plain">                                            ;</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">displayCharacterMode7</span><span class="plain">                          ; </span><span class="identifier">Display</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">space</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">deleteGraphicsCursor</span>
        <span class="identifier">LDA</span><span class="plain"> #$7</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setupCharacterDefinitionAddress</span><span class="plain">                ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">pointers</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduBackgroundGraphicsColour</span><span class="plain">                    ; </span><span class="identifier">Background</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Normal</span><span class="plain"> </span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">plotACharacterWithXYAsGraphicsColourAndMode</span><span class="plain">    ; </span><span class="identifier">Plot</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">colour</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">addNumberOfBytesInACharacterRowToAX</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">High</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> 16 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">value</span>
    <span class="plain">;   </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">Low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> 16 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacterRowLow</span><span class="plain">                     ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacterRowHigh</span><span class="plain">                    ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (</span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain">)</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Scroll</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">needed</span>
    <span class="plain">.</span><span class="identifier">handleScrollingInPagedMode</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearPagedModeCounter</span><span class="plain">                          ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">.</span><span class="identifier">handleScrollingInPagedModeInternal</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte118EntryPoint</span><span class="plain">                            ; </span><span class="identifier">OSBYTE</span><span class="plain"> 118 - </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">LEDs</span><span class="plain"> </span><span class="identifier">based</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">state</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">)</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">handleScrollingInPagedMode</span><span class="plain">                     ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> (</span><span class="identifier">waiting</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduStatusByte</span><span class="plain">                                  ; </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">EOR</span><span class="plain"> #%00000100                                      ; </span><span class="identifier">invert</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 2 (</span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> #%01000110                                      ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">there</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> 2 </span><span class="identifier">cursors</span><span class="plain">, </span><span class="identifier">OR</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">off</span><span class="plain">, </span><span class="identifier">OR</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain">)...</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">exit5</span><span class="plain">                                          ; ...</span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">pagedModeCounter</span><span class="plain">                               ; </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">incrementPagedModeAndExit</span><span class="plain">                      ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextCursorYPosition</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">vduTextWindowBottom</span><span class="plain">                            ; </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">incrementPagedModeAndExit</span><span class="plain">                      ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">/4</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">pagedModeCounter</span><span class="plain">                               ; </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduTextWindowTop</span><span class="plain">                               ; </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">vduTextWindowBottom</span><span class="plain">                            ; </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">incrementPagedModeAndExit</span><span class="plain">                      ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte118EntryPoint</span><span class="plain">                            ; </span><span class="identifier">OSBYTE</span><span class="plain"> 118 - </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">LEDs</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">reflect</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">state</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (+</span><span class="identifier">ve</span><span class="plain"> </span><span class="identifier">result</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">clearPagedModeCounter</span>
        <span class="identifier">LDA</span><span class="plain"> #255                                            ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">pagedModeCounter</span><span class="plain">                               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">.</span><span class="identifier">incrementPagedModeAndExit</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">pagedModeCounter</span><span class="plain">                               ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">.</span><span class="identifier">exit5</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 3
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 3: </span><span class="identifier">Changing</span><span class="plain"> </span><span class="identifier">MODEs</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">screenInitialisationRoutines</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">MODE</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">)</span>

        <span class="plain">; </span><span class="identifier">Clear</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> (0-126)</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vduVariablesEnd</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">          ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduStatusByte</span><span class="plain">                                  ; </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">conditions</span><span class="plain"> (</span><span class="identifier">zero</span><span class="plain">)</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain">-1,</span><span class="identifier">X</span><span class="plain">                          ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> (0-126)</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">loop</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>

        <span class="plain">; </span><span class="identifier">implode</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte20EntryPoint</span><span class="plain">                             ; </span><span class="identifier">implode</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain"> = 0)</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">)</span>

        <span class="plain">; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">teletext</span><span class="plain"> </span><span class="identifier">cursor</span>
        <span class="identifier">LDX</span><span class="plain"> #$7</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">X</span><span class="plain">=$7</span><span class="identifier">F</span><span class="plain"> (</span><span class="identifier">Note</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">NUAG</span><span class="plain"> </span><span class="identifier">Chapter</span><span class="plain"> 13.2.2 </span><span class="identifier">Page</span><span class="plain"> 186 </span><span class="identifier">says</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="reserved">default</span><span class="plain">)</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduTeletextCharacterForCursor</span><span class="plain">                  ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> 7 </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">MODE</span><span class="plain"> </span><span class="identifier">number</span>
    <span class="plain">.</span><span class="identifier">setMODE</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">systemAvailableRAM</span><span class="plain">                             ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">available</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">pages</span><span class="plain"> ($40 = 16</span><span class="identifier">k</span><span class="plain">; $80 = 32</span><span class="identifier">k</span><span class="plain">)</span>
        <span class="identifier">BMI</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (32</span><span class="identifier">k</span><span class="plain"> </span><span class="identifier">available</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">ORA</span><span class="plain"> #4                                              ; </span><span class="identifier">ensure</span><span class="plain"> </span><span class="identifier">only</span><span class="plain"> </span><span class="identifier">modes</span><span class="plain"> 4-7 </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">available</span>
    <span class="plain">+</span>
        <span class="identifier">AND</span><span class="plain"> #7                                              ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">AND</span><span class="plain"> 7 (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ensure</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">legal</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain">)</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">mode</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduCurrentScreenMode</span><span class="plain">                           ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span>

        <span class="plain">; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">characteristic</span><span class="plain"> </span><span class="identifier">vdu</span><span class="plain"> </span><span class="identifier">variable</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">numberOfColoursMinusOneInModeTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">           ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> -1 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">              ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> 1</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">bytesPerCharacter</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                            ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> /</span><span class="identifier">character</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacter</span><span class="plain">                           ; </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">pixelsPerByteMinusOneInModeTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">             ; </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">pixels</span><span class="plain">/</span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">pixelsPerByteMinusOneForCurrentMode</span><span class="plain">            ; </span><span class="identifier">pixels</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">-1</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #7                                              ; </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain">; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> = 7</span>
    <span class="plain">+</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">A</span><span class="plain"> * 2</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain"> = 2 * (</span><span class="identifier">pixels</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">-1), </span><span class="identifier">index</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">masks</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">sixteenColourModeMaskTable</span><span class="plain"> - 1,</span><span class="identifier">Y</span><span class="plain">               ; </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduColourMaskRight</span><span class="plain">                             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">right</span>
    <span class="plain">-</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">Shift</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">left</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">becomes</span><span class="plain"> </span><span class="identifier">set</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduColourMaskLeft</span><span class="plain">                              ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">left</span>

        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">screenDisplayMemoryIndexTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">index</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">vduCurrentScreenModeMemorySizeIndex</span><span class="plain">            ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">:</span>
                                                            <span class="plain">;       0 = 20</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 0,1,2)</span>
                                                            <span class="plain">;       1 = 16</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 3)</span>
                                                            <span class="plain">;       2 = 10</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 4,5)</span>
                                                            <span class="plain">;       3 = 8</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 6)</span>
                                                            <span class="plain">;       4 = 1</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 7)</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">crtcHardwareScrollParametersTable2</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">writeAToSystemVIARegisterB</span><span class="plain">                     ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">crtcHardwareScrollParametersTable1</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">writeAToSystemVIARegisterB</span><span class="plain">                     ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">screenMemorySizeInBytesHigh</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                  ; </span><span class="identifier">Screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduScreenSizeHighByte</span><span class="plain">                          ; </span><span class="identifier">Screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">screenMemoryStartHigh</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                        ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">ram</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduStartScreenAddressHighByte</span><span class="plain">                  ; </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">address</span>

        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">           </span><span class="identifier">A</span><span class="plain"> = 0 1 2 3 4 (</span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">)</span>
        <span class="identifier">ADC</span><span class="plain"> #2                                              ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">+2         </span><span class="identifier">A</span><span class="plain"> = 2 3 4 5 6</span>
        <span class="identifier">EOR</span><span class="plain"> #7                                              ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">EOR</span><span class="plain"> 7     </span><span class="identifier">A</span><span class="plain"> = 5 4 3 2 1</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain"> / 2       </span><span class="identifier">A</span><span class="plain"> = 2 2 1 1 0</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">Index</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> (0=</span><span class="identifier">MODE</span><span class="plain"> 7; 1=</span><span class="identifier">MODE</span><span class="plain"> 4,5,6; 2= </span><span class="identifier">MODE</span><span class="plain"> 0,1,2,3)</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">multiplicationTabletoUseLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                  ; </span><span class="identifier">Load</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">use</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduMultiplicationTableLow</span><span class="plain">                      ; </span><span class="identifier">store</span>
        <span class="identifier">LDA</span><span class="plain"> #&gt;.</span><span class="identifier">multiplyBy640Table</span><span class="plain">                           ; </span><span class="identifier">High</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">tables</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduMultiplicationTableHigh</span><span class="plain">                     ; </span><span class="identifier">store</span><span class="plain">. </span><span class="identifier">Now</span><span class="plain"> (.</span><span class="identifier">vduMultiplicationTableLow</span><span class="plain">) </span><span class="identifier">points</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 640</span><span class="identifier">x</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> 40</span><span class="identifier">x</span><span class="plain">.</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">bytesPerRowLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                               ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">nuber</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">) </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">table</span>

        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacterRowLow</span><span class="plain">                     ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacterRowHigh</span><span class="plain">                    ; </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #%01000011                                      ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearVDUStatusByteFlags</span><span class="plain">                        ; </span><span class="identifier">Clear</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 2,3,4,5,7 </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">vduStatusByteFlags</span><span class="plain">:</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 2 = </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> </span><span class="identifier">selected</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 3 = </span><span class="identifier">software</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> (</span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 4 = </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">used</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 5 = </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain"> (</span><span class="identifier">VDU</span><span class="plain"> 5)</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 7 = </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">disabled</span>


        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduCurrentScreenMode</span><span class="plain">                           ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">videoULAVideoControlRegisterDefaultValuesPerMode</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">video</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">setting</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setVideoULA</span><span class="plain">                                    ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">video</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 154</span>

        <span class="plain">; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">registers</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">crtcCursorEndRegisterTable</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">LDY</span><span class="plain"> #11                                             ; </span><span class="identifier">Y</span><span class="plain">=11</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">crtcRegisters0to11ForModes012</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setCRTCRegisterAY</span><span class="plain">                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">Register</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">reduce</span><span class="plain"> </span><span class="identifier">pointers</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ;</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">still</span><span class="plain"> &gt;=0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">vdu20EntryPoint</span><span class="plain">                                ; </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">colours</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">vdu26EntryPoint</span><span class="plain">                                ; </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">windows</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">initializeDisplayAndHomeCursor</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; </span><span class="identifier">X</span><span class="plain"> = 0</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduStartScreenAddressHighByte</span><span class="plain">                  ; </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressLow</span><span class="plain">                     ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressHigh</span><span class="plain">                    ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTextCursorCRTCAddress</span><span class="plain">                       ; </span><span class="identifier">use</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">LDY</span><span class="plain"> #12                                             ; </span><span class="identifier">Y</span><span class="plain">=12</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTwoCRTCRegisters</span><span class="plain">                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">registers</span><span class="plain"> 12 </span><span class="identifier">and</span><span class="plain"> 13 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">CRTC</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduBackgroundTextColour</span><span class="plain">                        ; </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduCurrentScreenModeMemorySizeIndex</span><span class="plain">            ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> [0=20</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 0,1,2); 1=16</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 3); 2=10</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 4,5); 3=8</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 6); 4=1</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 7)]</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">clearScreenRoutineEntryPointLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">section</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">vduJumpVectorLow</span><span class="plain">                               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LDY</span><span class="plain"> #&gt;.</span><span class="identifier">clearScreenRoutineEntryPointMode012</span><span class="plain">          ; </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">clearing</span><span class="plain"> </span><span class="identifier">routine</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">vduJumpVectorHigh</span><span class="plain">                              ; </span><span class="identifier">upper</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">link</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; </span><span class="identifier">X</span><span class="plain"> = 0</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">pagedModeCounter</span><span class="plain">                               ; </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduTextCursorXPosition</span><span class="plain">                         ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">column</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduTextCursorYPosition</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vduJumpVectorLow</span><span class="plain">)                             ; </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">indirect</span><span class="plain"> - </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">calls</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">clearing</span><span class="plain"> </span><span class="identifier">routine</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSWORD</span><span class="plain"> 10 - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">A</span><span class="plain">           = </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">read</span>
    <span class="plain">;   .</span><span class="identifier">oswordX</span><span class="plain">/</span><span class="identifier">Y</span><span class="plain">  = </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">results</span>
    <span class="plain">.</span><span class="identifier">osword10EntryPoint</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setupCharacterDefinitionAddress</span><span class="plain">                ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">pointers</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreDE</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">oswordX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">YX</span>
        <span class="identifier">CPY</span><span class="plain"> #8                                              ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">=8</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Screen</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">routine</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">contains</span><span class="plain"> </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">every</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">clearScreenRoutineEntryPointMode012</span>
        <span class="identifier">STA</span><span class="plain"> $3000,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3100,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3200,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3300,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3400,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3500,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3600,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3700,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3800,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3900,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3</span><span class="identifier">A00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3</span><span class="identifier">B00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3</span><span class="identifier">C00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3</span><span class="identifier">D00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3</span><span class="identifier">E00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $3</span><span class="identifier">F00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>

    <span class="plain">.</span><span class="identifier">clearScreenRoutineEntryPointMode3</span>
        <span class="identifier">STA</span><span class="plain"> $4000,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4100,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4200,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4300,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4400,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4500,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4600,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4700,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4800,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4900,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4</span><span class="identifier">A00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4</span><span class="identifier">B00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4</span><span class="identifier">C00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4</span><span class="identifier">D00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4</span><span class="identifier">E00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $4</span><span class="identifier">F00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5000,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5100,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5200,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5300,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5400,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5500,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5600,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5700,</span><span class="identifier">X</span><span class="plain">                                         ;</span>

    <span class="plain">.</span><span class="identifier">clearScreenRoutineEntryPointMode45</span>
        <span class="identifier">STA</span><span class="plain"> $5800,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5900,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5</span><span class="identifier">A00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5</span><span class="identifier">B00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5</span><span class="identifier">C00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5</span><span class="identifier">D00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5</span><span class="identifier">E00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $5</span><span class="identifier">F00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>

    <span class="plain">.</span><span class="identifier">clearScreenRoutineEntryPointMode6</span>
        <span class="identifier">STA</span><span class="plain"> $6000,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6100,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6200,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6300,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6400,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6500,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6600,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6700,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6800,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6900,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6</span><span class="identifier">A00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6</span><span class="identifier">B00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6</span><span class="identifier">C00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6</span><span class="identifier">D00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6</span><span class="identifier">E00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $6</span><span class="identifier">F00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7000,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7100,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7200,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7300,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7400,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7500,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7600,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7700,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7800,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7900,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7</span><span class="identifier">A00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7</span><span class="identifier">B00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>

    <span class="plain">.</span><span class="identifier">clearScreenRoutineEntryPointMode7</span>
        <span class="identifier">STA</span><span class="plain"> $7</span><span class="identifier">C00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7</span><span class="identifier">D00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7</span><span class="identifier">E00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">STA</span><span class="plain"> $7</span><span class="identifier">F00</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ;</span>
        <span class="identifier">INX</span><span class="plain">                                                 ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit7</span><span class="plain">                                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">done</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">executeRequiredFunction</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vduJumpVectorLow</span><span class="plain">)                             ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">, </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">previously</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 4
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 4: </span><span class="identifier">Graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain">, </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">subtractNumberOfBytesInALineToAX</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">High</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> 16 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">value</span>
    <span class="plain">;   </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">Low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> 16 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">subtraction</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacterRowLow</span><span class="plain">                     ; </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">goes</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacterRowHigh</span><span class="plain">                    ; </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">vduStartScreenAddressHighByte</span><span class="plain">                  ; </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">address</span>
    <span class="plain">.</span><span class="identifier">exit6</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 20 - </span><span class="identifier">Explode</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">allocation</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte20EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> #%00001111                                      ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduFontFlags</span><span class="plain">                                   ; </span><span class="identifier">characters</span><span class="plain"> 160-255 </span><span class="identifier">have</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span>
        <span class="identifier">LDA</span><span class="plain"> #&gt;.</span><span class="identifier">softCharacterDefinitions</span><span class="plain">                     ; </span><span class="identifier">Page</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">software</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduFontZoneAddressesHigh6</span><span class="plain"> - (.</span><span class="identifier">vduFontZoneAddressesHigh</span><span class="plain"> - 1)     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduFontZoneAddressesHigh</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">zone</span><span class="plain"> </span><span class="identifier">addresses</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> $0</span><span class="identifier">C</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">indicate</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">page</span><span class="plain"> </span><span class="identifier">available</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span>

        <span class="identifier">CPX</span><span class="plain"> #7                                              ;</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain"> &lt; 7) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDX</span><span class="plain"> #6                                              ; </span><span class="identifier">X</span><span class="plain">=6</span>
    <span class="plain">+</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">softCharacterDefinitionsSwitch</span><span class="plain">                 ; </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">explosion</span><span class="plain"> </span><span class="reserved">switch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">defaultPAGE</span><span class="plain">                                    ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">PAGE</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; </span><span class="identifier">X</span><span class="plain">=0</span>
    <span class="plain">-</span>
        <span class="identifier">CPX</span><span class="plain"> .</span><span class="identifier">softCharacterDefinitionsSwitch</span><span class="plain">                 ; </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">explosion</span><span class="plain"> </span><span class="reserved">switch</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ;</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">softCharacterRamAllocationTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">allocation</span><span class="plain"> </span><span class="identifier">offset</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduFontZoneAddressesHigh</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                     ; </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">location</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="identifier">ADC</span><span class="plain"> #1                                              ; </span><span class="identifier">Add</span><span class="plain"> 1 (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">)</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">+1</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">currentPAGE</span><span class="plain">                                    ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">page</span><span class="plain"> (</span><span class="identifier">OSHWM</span><span class="plain">)</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit6</span><span class="plain">                                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>

        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallFontImplosionExplosionWarning</span><span class="plain">   ; } </span><span class="identifier">issue</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">let</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">know</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">implosion</span><span class="plain">/</span><span class="identifier">explosion</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; } </span><span class="identifier">e</span><span class="plain">.</span><span class="identifier">g</span><span class="plain">. </span><span class="identifier">used</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">let</span><span class="plain"> </span><span class="identifier">languages</span><span class="plain"> </span><span class="identifier">know</span><span class="plain"> </span><span class="identifier">OSHWM</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">changing</span><span class="plain">. </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">PAGE</span><span class="plain"> </span><span class="identifier">number</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">moveTextCursorToNextLine</span>
        <span class="identifier">LDA</span><span class="plain"> #2                                              ; </span><span class="identifier">A</span><span class="plain">=2 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> </span><span class="identifier">disabled</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">vduStatusByte</span><span class="plain">                                  ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">scrolling</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BVC</span><span class="plain"> .</span><span class="identifier">exit8</span><span class="plain">                                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">editing</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">RETURN</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextWindowBottom</span><span class="plain">                            ; </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextWindowTop</span><span class="plain">                               ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
    <span class="plain">+</span>
        <span class="identifier">BVS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">editing</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduTextCursorYPosition</span><span class="plain">                         ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">link</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ;</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">setDisplayAddressAndCursor</span><span class="plain">                     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">address</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">+</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">vduTextInputCursorYCoordinate</span><span class="plain">                  ; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">coordinate</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">cursor</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">pullAndExit</span><span class="plain">                                    ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ;</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">vduTextInputCursorYCoordinate</span><span class="plain">                  ; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">coordinate</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">cursor</span>
    <span class="plain">.</span><span class="identifier">exit7</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">+</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">vduTextInputCursorYCoordinate</span><span class="plain">                  ; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">coordinate</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">cursor</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">cursor</span>
    <span class="plain">.</span><span class="identifier">setUpWriteCursor</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacter</span><span class="plain">                           ;</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> - 1</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">restoreWriteCursorNonMode7</span><span class="plain">                     ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Mode</span><span class="plain"> 7 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">use</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduMode7CursorCharacter</span><span class="plain">                        ; </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> 7 </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> $7</span><span class="identifier">F</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">character</span>
    <span class="plain">.</span><span class="identifier">pullTwiceAndExit</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">A</span>
    <span class="plain">.</span><span class="identifier">pullAndExit</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span>
    <span class="plain">.</span><span class="identifier">exit8</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Restore</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">normal</span><span class="plain"> </span><span class="identifier">cursor</span>
    <span class="plain">.</span><span class="identifier">restoreWriteCursor</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacter</span><span class="plain">                           ;</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> - 1</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">restoreWriteCursorNonMode7</span><span class="plain">                     ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> 7) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduMode7CursorCharacter</span><span class="plain">                        ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTeletextCharacterForCursor</span><span class="plain">                  ; </span><span class="identifier">mode</span><span class="plain"> 7 </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> 7 </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">pullTwiceAndExit</span><span class="plain">                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">restoreWriteCursorNonMode7</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FF</span><span class="plain"> (</span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain">)</span>
        <span class="identifier">CPY</span><span class="plain"> #$1</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">MODE</span><span class="plain"> 2) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #$3</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=$3</span><span class="identifier">F</span><span class="plain"> (</span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">invert</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">pullTwiceAndExit</span><span class="plain">                               ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">pullTwiceAndExit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">scrollDownwards</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkVerticalTextWindowBoundsAndMoveToLeftColumn</span><span class="plain">   ;</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextWindowBottom</span><span class="plain">                            ; </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduTextCursorYPosition</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setUpCursorScreenAddresses</span><span class="plain">                     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">addresses</span>
    <span class="plain">.</span><span class="identifier">loopBackScrollDown</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">subtractNumberOfBytesInALineToAX</span><span class="plain">               ; </span><span class="identifier">subtract</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">this</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ; </span><span class="identifier">wraparound</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">necessary</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduScreenSizeHighByte</span><span class="plain">                          ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDB</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">X</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">noWraparound</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">; </span><span class="identifier">there</span><span class="plain"> </span><span class="identifier">was</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">wraparound</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyCharacterLineOfTextWindow</span><span class="plain">                  ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">position</span>
                                                            <span class="plain">; </span><span class="identifier">using</span><span class="plain"> (.</span><span class="identifier">tempStoreDA</span><span class="plain">) </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">read</span>
                                                            <span class="plain">; </span><span class="identifier">and</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">) </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">write</span>
        <span class="identifier">JMP</span><span class="plain"> +                                               ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">noWraparound</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">subtractNumberOfBytesInALineToAX</span><span class="plain">               ; </span><span class="identifier">subtract</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">/</span><span class="identifier">A</span>
        <span class="identifier">BCC</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">outside</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyCharacterRow</span><span class="plain">                               ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">pointer</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ;</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">                 ;</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">height</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">loopBackScrollDown</span><span class="plain">                             ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">swapTextCursorPositionWithWorkspaceAB</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vduWorkspaceA</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">            ; </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">workspace</span>

        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduTextCursorXPosition</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">   ; </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">column</span><span class="plain">/</span><span class="identifier">line</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">swapTwoVDUVariables</span>
        <span class="identifier">LDA</span><span class="plain"> #2                                              ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">swap</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">exchangeAVariables</span><span class="plain">                             ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain">. </span><span class="identifier">Exchange</span><span class="plain"> (.</span><span class="identifier">vduWorkspaceA</span><span class="plain">/</span><span class="identifier">B</span><span class="plain">)+</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> (.</span><span class="identifier">workspaceA</span><span class="plain">/</span><span class="identifier">B</span><span class="plain">)+</span><span class="identifier">X</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">swapGraphicsCursorWithOldPosition</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vduGraphicsCursorPixelsXLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">         ; </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span>
    <span class="plain">.</span><span class="identifier">swapGraphicsCursorPositionWithVariableX</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduOldGraphicsCursorPixelsXLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">      ; </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">exchangeFourVariables</span>
        <span class="identifier">LDA</span><span class="plain"> #4                                              ; </span><span class="identifier">A</span><span class="plain"> = 4</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">exchangeAVariables</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                            ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                            ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">pointed</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                            ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> 300+</span><span class="identifier">X</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                            ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> 300+</span><span class="identifier">Y</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">pointers</span>
        <span class="identifier">INY</span><span class="plain">                                                 ;</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> 0 </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">scrollUpwards</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkVerticalTextWindowBoundsAndMoveToLeftColumn</span><span class="plain">   ;</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduTextWindowTop</span><span class="plain">                               ; </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">vduTextCursorYPosition</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setUpCursorScreenAddresses</span><span class="plain">                     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">addresses</span>
    <span class="plain">.</span><span class="identifier">loopBackScrollUp</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">addNumberOfBytesInACharacterRowToAX</span><span class="plain">            ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="reserved">char</span><span class="plain">. </span><span class="identifier">row</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ;</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ;</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduScreenSizeHighByte</span><span class="plain">                          ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDB</span><span class="plain">                                    ; (.</span><span class="identifier">tempStoreDA</span><span class="plain">)=</span><span class="identifier">X</span><span class="plain">/</span><span class="identifier">A</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; .</span><span class="identifier">tempStoreDC</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ;</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyCharacterLineOfTextWindow</span><span class="plain">                  ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">position</span>
                                                            <span class="plain">; </span><span class="identifier">using</span><span class="plain"> (.</span><span class="identifier">tempStoreDA</span><span class="plain">) </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">read</span>
                                                            <span class="plain">; </span><span class="identifier">and</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">) </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">write</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">finishScroll</span><span class="plain">                                   ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">addNumberOfBytesInACharacterRowToAX</span><span class="plain">            ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="reserved">char</span><span class="plain">. </span><span class="identifier">row</span>
        <span class="identifier">BMI</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">outside</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyCharacterRow</span><span class="plain">                               ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
    <span class="plain">.</span><span class="identifier">finishScroll</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ;</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ;</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">                 ;</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">height</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">loopBackScrollUp</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">swapTextCursorPositionWithWorkspaceAB</span><span class="plain">          ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> - </span><span class="identifier">swap</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">workspace</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Copies</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   .</span><span class="identifier">tempStoreDA</span><span class="plain">/</span><span class="identifier">DB</span><span class="plain">                      </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">from</span>
    <span class="plain">;   .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">destination</span><span class="plain"> </span><span class="identifier">address</span>
    <span class="plain">;   .</span><span class="identifier">vduTextWindowWidthInBytesLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain">   </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">copy</span>
    <span class="plain">.</span><span class="identifier">copyCharacterRow</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduTextWindowWidthInBytesHigh</span><span class="plain">                  ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> (</span><span class="identifier">bytes</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">more</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> 256 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">copy</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreDA</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; } </span><span class="identifier">copy</span><span class="plain"> 256 </span><span class="identifier">bytes</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; }</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; }</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; } </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">till</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">=0 </span><span class="identifier">again</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">tempStoreDB</span><span class="plain">                                    ;</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">done</span><span class="plain"> </span><span class="identifier">yet</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduTextWindowWidthInBytesLow</span><span class="plain">                   ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> (</span><span class="identifier">bytes</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">wide</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
    <span class="plain">-</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreDA</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ;</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">done</span><span class="plain"> </span><span class="identifier">yet</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkVerticalTextWindowBoundsAndMoveToLeftColumn</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">swapTextCursorPositionWithWorkspaceAB</span><span class="plain">          ; </span><span class="identifier">exchange</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">workspaceAB</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextWindowBottom</span><span class="plain">                            ; </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduTextWindowTop</span><span class="plain">                               ; </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">height</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">area</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">setTextCursorToLeftHandColumn</span><span class="plain">                  ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">column</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">hand</span><span class="plain"> </span><span class="identifier">column</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">caller</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">early</span><span class="plain">)</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ;</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">swapTextCursorPositionWithWorkspaceAB</span><span class="plain">          ; </span><span class="identifier">exchange</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">workspaceAB</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setTextCursorToLeftHandColumn</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextWindowLeft</span><span class="plain">                              ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">left</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">storeTextCursorXSetCarryAndReturn</span><span class="plain">              ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">position</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">copyCharacterLineOfTextWindow</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextWindowRight</span><span class="plain">                             ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">right</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduTextWindowLeft</span><span class="plain">                              ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">left</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDF</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span>
    <span class="plain">--</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacter</span><span class="plain">                           ; </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">loop</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreDA</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">source</span><span class="plain">: </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">/</span><span class="identifier">DB</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">destination</span><span class="plain">: </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">screen</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ;</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">keep</span><span class="plain"> </span><span class="identifier">copying</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">LDX</span><span class="plain"> #2                                              ; </span><span class="identifier">X</span><span class="plain">=2 </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">               ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacter</span><span class="plain">                           ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">               ; </span><span class="identifier">and</span><span class="plain"> (</span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=0) </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">/</span><span class="identifier">DB</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">              ;</span>
        <span class="identifier">ADC</span><span class="plain"> #0                                              ;</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">remains</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">OK</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">wrap</span><span class="plain"> </span><span class="identifier">around</span><span class="plain"> </span><span class="identifier">screen</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduScreenSizeHighByte</span><span class="plain">                          ; </span><span class="identifier">take</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">              ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-2</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ;</span>
        <span class="identifier">BEQ</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">=0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">adjust</span><span class="plain"> </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">pointers</span><span class="plain">)</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">tempStoreDF</span><span class="plain">                                    ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BPL</span><span class="plain"> --                                              ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">still</span><span class="plain"> +</span><span class="identifier">ve</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">clearOneLineInternal</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextCursorXPosition</span><span class="plain">                         ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">column</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTextCursorToLeftHandColumn</span><span class="plain">                  ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">column</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">hand</span><span class="plain"> </span><span class="identifier">column</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setUpCursorScreenAddresses</span><span class="plain">                     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">addresses</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextWindowRight</span><span class="plain">                             ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">right</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduTextWindowLeft</span><span class="plain">                              ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">left</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span>
    <span class="plain">--</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduBackgroundTextColour</span><span class="plain">                        ; </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacter</span><span class="plain">                           ; </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
    <span class="plain">-</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1 </span><span class="identifier">decrementing</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">screen</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">add</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacter</span><span class="plain">                           ; </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">restoring</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">ADC</span><span class="plain"> #0                                              ; </span><span class="identifier">Add</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">any</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (+</span><span class="identifier">ve</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">wrap</span><span class="plain"> </span><span class="identifier">around</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduScreenSizeHighByte</span><span class="plain">                          ; </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
    <span class="plain">+</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">values</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ;</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">width</span>
        <span class="identifier">BPL</span><span class="plain"> --                                              ; </span><span class="identifier">ind</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> 0 </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>

    <span class="plain">.</span><span class="identifier">storeTextCursorXSetCarryAndReturn</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduTextCursorXPosition</span><span class="plain">                         ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">column</span>
    <span class="plain">.</span><span class="identifier">setCarryAndReturn</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">validatePositionAndSetupScreenAddress</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduTextCursorXPosition</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="identifier">CPX</span><span class="plain"> .</span><span class="identifier">vduTextWindowLeft</span><span class="plain">                              ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">setCarryAndReturn</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
        <span class="identifier">CPX</span><span class="plain"> .</span><span class="identifier">vduTextWindowRight</span><span class="plain">                             ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">equal</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">thats</span><span class="plain"> </span><span class="identifier">OK</span><span class="plain">)</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">setCarryAndReturn</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">greater</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduTextCursorYPosition</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">CPX</span><span class="plain"> .</span><span class="identifier">vduTextWindowTop</span><span class="plain">                               ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">setCarryAndReturn</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
        <span class="identifier">CPX</span><span class="plain"> .</span><span class="identifier">vduTextWindowBottom</span><span class="plain">                            ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">window</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">setUpCursorScreenAddresses</span><span class="plain">                     ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">equal</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">ok</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">addresses</span><span class="plain">)</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">setCarryAndReturn</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">greater</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Let</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> (</span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">absolute</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">cells</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">corner</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">;     </span><span class="identifier">Mode</span><span class="plain"> 0: </span><span class="identifier">address</span><span class="plain"> = </span><span class="identifier">screen_start</span><span class="plain"> + </span><span class="identifier">Y</span><span class="plain">*640 + </span><span class="identifier">X</span><span class="plain">* 8</span>
    <span class="plain">;     </span><span class="identifier">Mode</span><span class="plain"> 1: </span><span class="identifier">address</span><span class="plain"> = </span><span class="identifier">screen_start</span><span class="plain"> + </span><span class="identifier">Y</span><span class="plain">*640 + </span><span class="identifier">X</span><span class="plain">*16</span>
    <span class="plain">;     </span><span class="identifier">Mode</span><span class="plain"> 2: </span><span class="identifier">address</span><span class="plain"> = </span><span class="identifier">screen_start</span><span class="plain"> + </span><span class="identifier">Y</span><span class="plain">*640 + </span><span class="identifier">X</span><span class="plain">*32</span>
    <span class="plain">;     </span><span class="identifier">Mode</span><span class="plain"> 3: </span><span class="identifier">address</span><span class="plain"> = </span><span class="identifier">screen_start</span><span class="plain"> + </span><span class="identifier">Y</span><span class="plain">*640 + </span><span class="identifier">X</span><span class="plain">* 8</span>
    <span class="plain">;     </span><span class="identifier">Mode</span><span class="plain"> 4: </span><span class="identifier">address</span><span class="plain"> = </span><span class="identifier">screen_start</span><span class="plain"> + </span><span class="identifier">Y</span><span class="plain">*320 + </span><span class="identifier">X</span><span class="plain">* 8</span>
    <span class="plain">;     </span><span class="identifier">Mode</span><span class="plain"> 5: </span><span class="identifier">address</span><span class="plain"> = </span><span class="identifier">screen_start</span><span class="plain"> + </span><span class="identifier">Y</span><span class="plain">*320 + </span><span class="identifier">X</span><span class="plain">*16</span>
    <span class="plain">;     </span><span class="identifier">Mode</span><span class="plain"> 6: </span><span class="identifier">address</span><span class="plain"> = </span><span class="identifier">screen_start</span><span class="plain"> + </span><span class="identifier">Y</span><span class="plain">*320 + </span><span class="identifier">X</span><span class="plain">* 8</span>
    <span class="plain">;     </span><span class="identifier">Mode</span><span class="plain"> 7: </span><span class="identifier">address</span><span class="plain"> = </span><span class="identifier">screen_start</span><span class="plain"> + </span><span class="identifier">Y</span><span class="plain">* 40 + </span><span class="identifier">X</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Given</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">position</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">use</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">other</span>
    <span class="plain">; </span><span class="identifier">characteristic</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">MODE</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">calculate</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">We</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">vduTextCursorCRTCAddressLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">wrap</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">on</span>
    <span class="plain">; </span><span class="identifier">screen</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">beyond</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain">. </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">wrapped</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">in</span>
    <span class="plain">; .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain">.</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setUpCursorScreenAddresses</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextCursorYPosition</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">*2</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">vduMultiplicationTableLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                  ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">pointer</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ; .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
        <span class="identifier">LDA</span><span class="plain"> #2                                              ; </span><span class="identifier">A</span><span class="plain">=2</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">vduCurrentScreenModeMemorySizeIndex</span><span class="plain">            ; </span><span class="identifier">AND</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">:</span>
                                                            <span class="plain">;   0 = 20</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 0,1,2)</span>
                                                            <span class="plain">;   1 = 16</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 3)</span>
                                                            <span class="plain">;   2 = 10</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 4,5)</span>
                                                            <span class="plain">;   3 = 8</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 6)</span>
                                                            <span class="plain">;   4 = 1</span><span class="identifier">k</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 7)</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">vduMultiplicationTableLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                  ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">pointer</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="identifier">Branch</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">MODE</span><span class="plain"> 0,1,2,3 </span><span class="identifier">or</span><span class="plain"> 7</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ; </span><span class="identifier">MODE</span><span class="plain"> 4,5,6: </span><span class="identifier">Halve</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">multiplication</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain">)</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">/2 + (128*</span><span class="identifier">carry</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressLow</span><span class="plain">                     ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">                 ; </span><span class="identifier">store</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain">)</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduScreenTopLeftAddressHigh</span><span class="plain">                    ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain">)</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduTextCursorXPosition</span><span class="plain">                         ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">column</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduBytesPerCharacter</span><span class="plain">                           ; </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">mode7Cursor</span><span class="plain">                                    ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">MODE</span><span class="plain"> 7) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">CPX</span><span class="plain"> #15                                             ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> 1 </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> 5? (</span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">modes</span><span class="plain"> = 16 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">mode1or5Cursor</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">mode</span><span class="plain"> 1 </span><span class="identifier">or</span><span class="plain"> 5) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">mode0346Cursor</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">mode</span><span class="plain"> 0,3,4, </span><span class="identifier">or</span><span class="plain"> 6) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">)</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">*16 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">here</span><span class="plain"> (</span><span class="identifier">mode</span><span class="plain"> 2)</span>
    <span class="plain">.</span><span class="identifier">mode1or5Cursor</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">*8 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">here</span>
    <span class="plain">.</span><span class="identifier">mode0346Cursor</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">*4 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">here</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">skipIncs</span><span class="plain">                                       ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+2</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span>
    <span class="plain">.</span><span class="identifier">skipIncs</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">*2</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">skipInc</span><span class="plain">                                        ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">) </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">)</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
    <span class="plain">.</span><span class="identifier">mode7Cursor</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
    <span class="plain">.</span><span class="identifier">skipInc</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">                 ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduTextCursorCRTCAddressLow</span><span class="plain">                    ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">ADC</span><span class="plain"> #0                                              ; </span><span class="identifier">Add</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">set</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduTextCursorCRTCAddressHigh</span><span class="plain">                   ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">CRTC</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> (</span><span class="identifier">before</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">wraparound</span><span class="plain">)</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">wrap</span><span class="plain"> </span><span class="identifier">around</span><span class="plain">...</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">vduScreenSizeHighByte</span><span class="plain">                          ; ...</span><span class="identifier">subtract</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWriteCursorScreenAddressHigh</span><span class="plain">                ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Display</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span>
    <span class="plain">.</span><span class="identifier">plotACharacterAtGraphicsCursor</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduForegroundGraphicsColour</span><span class="plain">                        ; </span><span class="identifier">foreground</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduForegroundGCOLMode</span><span class="plain">                              ; </span><span class="identifier">foreground</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> (</span><span class="identifier">GCOL</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">plotACharacterWithXYAsGraphicsColourAndMode</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setGraphicsColourMaskXY</span><span class="plain">                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">graphicsColourByteOR</span><span class="plain">/</span><span class="identifier">EOR</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyGraphicsCursorPixelPositionToWorkspaceABCD</span><span class="plain">     ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">pixels</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">workspace</span><span class="plain"> (.</span><span class="identifier">vduWorkspaceA</span><span class="plain">-</span><span class="identifier">D</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                                  ; </span><span class="identifier">Y</span><span class="plain">=0</span>
    <span class="plain">.</span><span class="identifier">displayNextRowOfCharacter</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                        ; .</span><span class="identifier">tempStoreDC</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                        ; </span><span class="identifier">Y</span><span class="plain">=.</span><span class="identifier">tempStoreDC</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreDE</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">pattern</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">characterPatternZero</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain">=0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDD</span><span class="plain">                                        ; .</span><span class="identifier">tempStoreDD</span><span class="plain"> = 1 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">pattern</span><span class="plain"> </span><span class="identifier">byte</span>
    <span class="plain">-</span>
        <span class="identifier">BPL</span><span class="plain"> +                                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pattern</span><span class="character">'s top bit is clear) then branch (nothing to draw)</span>
        <span class="character">JSR .plotAPixelInACharacter                             ; display a pixel</span>
    <span class="character">+</span>
        <span class="character">INC .vduGraphicsCursorPixelsXLow                        ; current horizontal graphics cursor</span>
        <span class="character">BNE +                                                   ;</span>
        <span class="character">INC .vduGraphicsCursorPixelsXHigh                       ; current horizontal graphics cursor</span>
    <span class="character">+</span>
        <span class="character">ASL .tempStoreDD                                        ; shift the bit pattern left to draw next pixel</span>
        <span class="character">BNE -                                                   ; if (there'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">still</span><span class="plain"> </span><span class="identifier">something</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">draw</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">characterPatternZero</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vduWorkspaceA</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">                ; </span><span class="identifier">source</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">workspace</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduGraphicsCursorPixelsXLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">  ; </span><span class="identifier">destination</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">horizontal</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">pixel</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copy2BytesWithinVDUVariables</span><span class="plain">                       ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduGraphicsCursorPixelsYLow</span><span class="plain">                        ; }</span>
        <span class="identifier">BNE</span><span class="plain"> +                                                   ; }</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">vduGraphicsCursorPixelsYHigh</span><span class="plain">                       ; } </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">pixel</span><span class="plain"> </span><span class="identifier">position</span>
    <span class="plain">+                                                           ; }</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">vduGraphicsCursorPixelsYLow</span><span class="plain">                        ; }</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                        ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">INY</span><span class="plain">                                                     ;</span>
        <span class="identifier">CPY</span><span class="plain"> #8                                                  ;</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">displayNextRowOfCharacter</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">&lt;8) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vduWorkspaceA</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">                ; </span><span class="identifier">source</span><span class="plain">: </span><span class="identifier">workspaceA</span><span class="plain">-</span><span class="identifier">D</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduGraphicsCursorPixelsXLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">  ; </span><span class="identifier">destination</span><span class="plain">: </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">copyFourBytesWithinVDUVariables</span><span class="plain">                    ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">graphicsCursorHome</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vduGraphicsWindowPixelsTopLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">    ; </span><span class="identifier">source</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> (</span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">top</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduGraphicsCursorPixelsYLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">      ; </span><span class="identifier">destination</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> (</span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copy2BytesWithinVDUVariables</span><span class="plain">                           ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setGraphicsCursorToLeftHandColumn</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vduGraphicsWindowPixelsLeftLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">   ; </span><span class="identifier">source</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduGraphicsCursorPixelsXLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">      ; </span><span class="identifier">destination</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copy2BytesWithinVDUVariables</span><span class="plain">                           ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">convertInternalGraphicsCoordinatesToExternal</span><span class="plain">           ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">external</span><span class="plain"> </span><span class="identifier">coordinates</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">graphics</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">displayACharacter</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">             ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> 1</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">displayCharacterMode7</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">MODE</span><span class="plain"> 7) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setupCharacterDefinitionAddress</span><span class="plain">               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">pointers</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">displayACharacterAtAddress</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">             ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> 1</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduStatusByte</span><span class="plain">                                 ; </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">AND</span><span class="plain"> #$20                                           ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 5 (</span><span class="identifier">printing</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">plotACharacterAtGraphicsCursor</span><span class="plain">                ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">set</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDY</span><span class="plain"> #7                                             ; </span><span class="identifier">Y</span><span class="plain">=7</span>
        <span class="identifier">CPX</span><span class="plain"> #3                                             ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">displayACharacter4ColourMode</span><span class="plain">                  ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain"> = 3) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> 4 </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">modes</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">displayACharacter16ColourMode</span><span class="plain">                 ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain"> &gt; 3) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">deal</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> 16 </span><span class="identifier">colours</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreDE</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                               ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">pattern</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">textColourByteOR</span><span class="plain">                              ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">orred</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">EORed</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">textColourByteEOR</span><span class="plain">                             ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">orred</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">EORed</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">            ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">screen</span>
        <span class="identifier">DEY</span><span class="plain">                                                ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1</span>
        <span class="identifier">BPL</span><span class="plain"> -                                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">still</span><span class="plain"> +</span><span class="identifier">ve</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">RTS</span><span class="plain">                                                ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">displayCharacterMode7</span>
        <span class="identifier">LDY</span><span class="plain"> #2                                              ; </span><span class="identifier">Y</span><span class="plain">=2, </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain">/</span><span class="identifier">index</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">teletext</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">table</span>
    <span class="plain">-</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">teletextCharacterConversionTable</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">teletext</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">convertMODE7Character</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">found</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">convert</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">done</span>
    <span class="plain">.</span><span class="identifier">writeByteToMode7Screen</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">)             ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">screen</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">convertMODE7Character</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">teletextCharacterConversionTable</span><span class="plain"> + 1,</span><span class="identifier">Y</span><span class="plain">         ; </span><span class="identifier">convert</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">teletext</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">writeByteToMode7Screen</span><span class="plain">                         ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">it</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">displayACharacter4ColourMode</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreDE</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">pattern</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fourColourModeByteMaskTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                   ; 4 </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">look</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">textColourByteOR</span><span class="plain">                               ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">orred</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">EORed</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">textColourByteEOR</span><span class="plain">                              ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">orred</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">EORed</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">screen</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">ADC</span><span class="plain"> #8                                              ; </span><span class="identifier">add</span><span class="plain"> 8 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> 8 </span><span class="identifier">bytes</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">AND</span><span class="plain"> #%00001111                                      ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">nybble</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fourColourModeByteMaskTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                  ; 4 </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">look</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">textColourByteOR</span><span class="plain">                               ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">orred</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">EORed</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">textColourByteEOR</span><span class="plain">                              ; </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">orred</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">EORed</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">screen</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">SBC</span><span class="plain"> #8                                              ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">-9</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">displayACharacter4ColourMode</span><span class="plain">                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">exit9</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">nextPatternByte</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-$21</span>
        <span class="identifier">SBC</span><span class="plain"> #$21                                            ;</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">exit9</span><span class="plain">                                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">displayACharacter16ColourMode</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreDE</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">pattern</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
    <span class="plain">.</span><span class="identifier">iloop</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">now</span><span class="plain"> </span><span class="identifier">occupies</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">DC</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">nextPatternByte</span><span class="plain">                                ; </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">DC</span><span class="plain">=0 </span><span class="identifier">again</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">deal</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">pattern</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 0</span>
        <span class="identifier">ASL</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">second</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">sixteenColourModeByteMaskTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">               ; </span><span class="identifier">multiply</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> $55 </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">look</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">textColourByteOR</span><span class="plain">                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">factors</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">textColourByteEOR</span><span class="plain">                              ;</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">ADC</span><span class="plain"> #8                                              ; } </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+8 </span><span class="identifier">moving</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> 8 </span><span class="identifier">bytes</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; }</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">iloop</span><span class="plain">                                          ; </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">deal</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">pair</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ascii</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">printable</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> 32-127 (</span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">pattern</span><span class="plain"> </span><span class="identifier">abcdefgh</span><span class="plain">)</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       .</span><span class="identifier">tempStoreDE</span><span class="plain">/</span><span class="identifier">F</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span>
    <span class="plain">;                      </span><span class="identifier">either</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">definitions</span>

    <span class="plain">.</span><span class="identifier">setupCharacterDefinitionAddress</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">bcdefgh0</span><span class="plain">  </span><span class="identifier">C</span><span class="plain">=</span><span class="identifier">a</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">cdefgh0a</span><span class="plain">  </span><span class="identifier">C</span><span class="plain">=</span><span class="identifier">b</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">defgh0ab</span><span class="plain">  </span><span class="identifier">C</span><span class="plain">=</span><span class="identifier">c</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">pattern</span><span class="plain"> (</span><span class="identifier">defgh0ab</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> #%00000011                                      ; 000000</span><span class="identifier">ab</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; 00000</span><span class="identifier">abc</span><span class="plain">  </span><span class="identifier">C</span><span class="plain">=0</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">zone</span><span class="plain"> (1 - 7)</span>
        <span class="identifier">AND</span><span class="plain"> #%00000011                                      ; </span><span class="identifier">A</span><span class="plain"> = 000000</span><span class="identifier">bc</span><span class="plain"> (1 - 3)</span>
        <span class="identifier">ADC</span><span class="plain"> #&gt;.</span><span class="identifier">characterDefinitions</span><span class="plain"> - 1                     ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span><span class="plain"> ($</span><span class="identifier">C0</span><span class="plain">, $</span><span class="identifier">C1</span><span class="plain">, $</span><span class="identifier">C2</span><span class="plain">)</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fontMaskTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                ; </span><span class="identifier">Get</span><span class="plain"> </span><span class="identifier">single</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">depending</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> (0-7)</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">vduFontFlags</span><span class="plain">                                   ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">font</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">have</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">hard</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduFontZoneAddressesHigh</span><span class="plain"> - 1,</span><span class="identifier">X</span><span class="plain">                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definitions</span>
    <span class="plain">+</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tempStoreDF</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">pattern</span><span class="plain"> (</span><span class="identifier">defgh0ab</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> #%11111000                                      ; </span><span class="identifier">defgh000</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">re</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain">. </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 8 </span><span class="identifier">times</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">giving</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 5
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 5: </span><span class="identifier">PLOT</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Plot</span><span class="plain"> </span><span class="identifier">routine</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">vdu25ParameterPlotType</span><span class="plain"> = $031</span><span class="identifier">F</span>
    <span class="plain">.</span><span class="identifier">vdu25ParameterXLow</span><span class="plain">     = $0320</span>
    <span class="plain">.</span><span class="identifier">vdu25ParameterXHigh</span><span class="plain">    = $0321</span>
    <span class="plain">.</span><span class="identifier">vdu25ParameterYLow</span><span class="plain">     = $0322</span>
    <span class="plain">.</span><span class="identifier">vdu25ParameterYHigh</span><span class="plain">    = $0323</span>
    <span class="plain">.</span><span class="identifier">vdu25Plot</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">vdu25ParameterXLow</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">       ; </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">Coordinate</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">plotConvertCoordinatesToPixels</span><span class="plain">                 ; </span><span class="identifier">translate</span><span class="plain"> </span><span class="identifier">coordinates</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu25ParameterPlotType</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">type</span>
        <span class="identifier">CMP</span><span class="plain"> #4                                              ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> (</span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">absolute</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">plotMoveAbsolute</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">four</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">absolute</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> #5                                              ; </span><span class="identifier">Y</span><span class="plain">=5</span>
        <span class="identifier">AND</span><span class="plain"> #3                                              ; </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">only</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0 </span><span class="identifier">and</span><span class="plain"> 1</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">relative</span><span class="plain"> </span><span class="identifier">operation</span><span class="plain">)</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">zero</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">graphicsColourWantedForPlot</span><span class="plain">                    ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">either</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">foreground</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">wanted</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=4 (</span><span class="character">'invert'</span><span class="plain"> </span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain">. </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">logic</span><span class="plain"> </span><span class="identifier">inverse</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">must</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">wanted</span>

    <span class="plain">; ---------------------------------------------------------------------------------------</span>
    <span class="plain">; </span><span class="identifier">PLOT</span><span class="plain"> </span><span class="identifier">TYPE</span><span class="plain">   </span><span class="identifier">RANGE</span><span class="plain"> </span><span class="identifier">IN</span><span class="plain"> </span><span class="identifier">BINARY</span><span class="plain">      </span><span class="identifier">BITS3</span><span class="plain">-6    </span><span class="identifier">DESCRIPTION</span>
    <span class="plain">; </span><span class="identifier">RANGE</span><span class="plain">       </span><span class="identifier">abcdefgh</span><span class="plain">-</span><span class="identifier">abcdefgh</span><span class="plain">    </span><span class="identifier">bcde</span>
    <span class="plain">; ---------------------------------------------------------------------------------------</span>
    <span class="plain">; 0-7         00000000-00000111    0000       </span><span class="identifier">Move</span><span class="plain">/</span><span class="identifier">Draw</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">standard</span><span class="plain"> </span><span class="identifier">options</span><span class="plain"> 0-7</span>
    <span class="plain">; 8-15        00001000-00001111    0001       </span><span class="identifier">As</span><span class="plain"> 0-7 </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">omitted</span>
    <span class="plain">; 16-23       00010000-00010111    0010       </span><span class="identifier">As</span><span class="plain"> 0-7 </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">dotted</span><span class="plain"> </span><span class="identifier">line</span>
    <span class="plain">; 24-31       00011000-00011111    0011       </span><span class="identifier">As</span><span class="plain"> 0-7 </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">dotted</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">omitted</span>
    <span class="plain">; 32-39       00100000-00100111    0100       </span><span class="identifier">RESERVED</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">future</span><span class="plain"> </span><span class="identifier">expansion</span>
    <span class="plain">; 40-47       00101000-00101111    0101       </span><span class="identifier">RESERVED</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">future</span><span class="plain"> </span><span class="identifier">expansion</span>
    <span class="plain">; 48-55       00110000-00110111    0110       </span><span class="identifier">RESERVED</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">future</span><span class="plain"> </span><span class="identifier">expansion</span>
    <span class="plain">; 56-63       00111000-00111111    0111       </span><span class="identifier">RESERVED</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">future</span><span class="plain"> </span><span class="identifier">expansion</span>
    <span class="plain">; 64-71       01000000-01000111    1000       </span><span class="identifier">As</span><span class="plain"> 0-7 </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">only</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">single</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">plotted</span>
    <span class="plain">; 72-79       01001000-01001111    1001       </span><span class="identifier">As</span><span class="plain"> 0-7 </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">fill</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">horizontally</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">right</span>
    <span class="plain">; 80-87       01010000-01010111    1010       </span><span class="identifier">As</span><span class="plain"> 0-7 </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">fill</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">triangle</span>
    <span class="plain">; 88-95       01011000-01011111    1011       </span><span class="identifier">As</span><span class="plain"> 0-7 </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">fill</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">horizontally</span><span class="plain"> </span><span class="identifier">right</span>
    <span class="plain">; 96-103      01100000-01100111    1100       </span><span class="identifier">RESERVED</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">future</span><span class="plain"> </span><span class="identifier">expansion</span>
    <span class="plain">; 104-111     01101000-01101111    1101       </span><span class="identifier">RESERVED</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">future</span><span class="plain"> </span><span class="identifier">expansion</span>
    <span class="plain">; 112-119     01110000-01110111    1110       </span><span class="identifier">RESERVED</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">future</span><span class="plain"> </span><span class="identifier">expansion</span>
    <span class="plain">; 120-127     01111000-01111111    1111       </span><span class="identifier">RESERVED</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">future</span><span class="plain"> </span><span class="identifier">expansion</span>
    <span class="plain">; 128-255     10000000-11111111    </span><span class="identifier">xxxx</span><span class="plain">       </span><span class="identifier">RESERVED</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">future</span><span class="plain"> </span><span class="identifier">expansion</span>
    <span class="plain">; ---------------------------------------------------------------------------------------</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain">=0 </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">foreground</span><span class="plain"> </span><span class="identifier">colour</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain">=1 </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">background</span>
    <span class="plain">.</span><span class="identifier">graphicsColourWantedForPlot</span>
        <span class="identifier">TAX</span><span class="plain">                                                  ;</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduForegroundGCOLMode</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">foreground</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">PLOT</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> (</span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduForegroundGraphicsColour</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                   ; }</span>
        <span class="identifier">TAX</span><span class="plain">                                                  ; } </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">foreground</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> (</span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setGraphicsColourMaskXY</span><span class="plain">                         ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">masks</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">graphicsColourByteOR</span><span class="plain">/</span><span class="identifier">EOR</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vdu25ParameterPlotType</span><span class="plain">                          ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">plot</span><span class="plain"> </span><span class="identifier">type</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">plotExtensionLocal</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> (128-255) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">it</span><span class="character">'s RESERVED for future expansion)</span>
        <span class="character">ASL                                                  ; bcdefgh0</span>
        <span class="character">BPL .plotType0to63                                   ; if (bit 7 is now 0) then branch (plot type is 0-63 so branch)</span>
        <span class="character">AND #%11110000                                       ; bcde0000</span>
        <span class="character">ASL                                                  ; cde00000</span>
        <span class="character">BEQ .plotPointAndMove                                ; if (zero) then branch (plot type 64-71 was called, single point plot)</span>
        <span class="character">EOR #%01000000                                       ; cDe00000 (inverted bit d)</span>
        <span class="character">BEQ .plotFillTriangleLocal                           ; if (bit '</span><span class="identifier">D</span><span class="character">' clear; i.e. bit '</span><span class="identifier">d</span><span class="character">' set) then branch (plot type 80-87, fill triangle)</span>
                                                            <span class="character">;</span>
        <span class="character">PHA                                                  ; push cDe00000</span>
        <span class="character">JSR .copyPlotParametersToGraphicsCursorPixelPosition ; copy 0320/3 to 0324/7 setting XY in current graphics</span>
                                                            <span class="character">; coordinates</span>
        <span class="character">PLA                                                  ; get back cDe00000</span>
        <span class="character">EOR #%01100000                                       ; cdE00000 (invert bit D back to d, and invert bit e)</span>
        <span class="character">BEQ .storeAndLateralFillLeftRight                    ; if (cdE00000 == 00000000) (ie. cde == 001) then branch (type is 72-79, it'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">lateral</span><span class="plain"> </span><span class="identifier">fill</span><span class="plain"> </span><span class="identifier">left</span><span class="plain">/</span><span class="identifier">right</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #%01000000                                       ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">cdE00000</span><span class="plain"> == 01000000) (</span><span class="identifier">ie</span><span class="plain">. </span><span class="identifier">cde</span><span class="plain"> == 011) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 88-95 (</span><span class="identifier">it</span><span class="character">'s a lateral fill right)</span>
        <span class="character">BNE .plotExtensionLocal                              ; otherwise branch (RESERVED for future expansion)</span>
        <span class="character">; fall through...</span>

    <span class="character">.plotLateralFillRight                                    ;</span>
        <span class="character">LDA #2                                               ; A=2</span>
        <span class="character">STA .tempStoreDC                                     ; .tempStoreDC = 2</span>
        <span class="character">JMP .lateralFillRight                                ; lateral fill right</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotFillTriangleLocal</span>
        <span class="character">JMP .plotFillTriangle                               ; to fill triangle routine</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotExtensionLocal</span>
        <span class="character">JMP .vduPlotExtension                               ; VDU extension access entry</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.storeAndLateralFillLeftRight</span>
        <span class="character">STA .tempStoreDC                                    ; .tempStoreDC = 0</span>
        <span class="character">JMP .lateralFillLeftRight                           ; lateral fill left and right</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X = colour to set</span>
    <span class="character">;   Y = graphics MODE</span>
    <span class="character">; On Exit:</span>
    <span class="character">;   .graphicsColourByteOR / EOR hold the appropriate mask values</span>
    <span class="character">;</span>
    <span class="character">.setGraphicsColourMaskXY</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">ORA .gcolPlotOptionsTable,Y                         ; or with GCOL plot options table byte</span>
        <span class="character">EOR .gcolPlotOptionsTable + 1,Y                     ; EOR with following byte</span>
        <span class="character">STA .graphicsColourByteOR                           ; and store it</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">ORA .gcolPlotOptionsTable - 1,Y                     ;</span>
        <span class="character">EOR .gcolPlotOptionsTable + 4,Y                     ;</span>
        <span class="character">STA .graphicsColourByteEOR                          ;</span>
        <span class="character">RTS                                                 ; exit (with masks in .graphicsColourByteOR/EOR)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Continue processing of a PLOT command, where the plot type is in the range 0-63</span>
    <span class="character">.plotType0to63</span>
        <span class="character">ASL                                                 ; cdefgh00</span>
        <span class="character">BMI .plotExtensionLocal                             ; if (options are in range 32-63) then branch (not implemented)</span>
        <span class="character">ASL                                                 ; defgh000</span>
        <span class="character">ASL                                                 ; efgh0000</span>
        <span class="character">BPL +                                               ; if (still +ve; type is 0-7 or 16-23) then branch (skips plot point)</span>
        <span class="character">JSR .plotPoint                                      ; display a point</span>
    <span class="character">+</span>
        <span class="character">JSR .plotLine                                       ; draw a line or dotted line</span>
        <span class="character">JMP .plotMoveAbsolute                               ; move the graphics cursor</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Plot a single point and move the graphics cursor position</span>
    <span class="character">.plotPointAndMove</span>
        <span class="character">JSR .plotPoint                                      ; display a point</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotMoveAbsolute</span>
        <span class="character">JSR .swapGraphicsCursorWithOldPosition              ; swap current and last graphics position</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.copyPlotParametersToGraphicsCursorPixelPosition</span>
        <span class="character">LDY #.vduGraphicsCursorPixelsXLow - .vduVariablesStart      ; Destination is the graphics cursor position in pixels</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.copyPositionToGraphicsCursorPixelPosition</span>
        <span class="character">LDX #.vdu25ParameterXLow - .vduVariablesStart               ; Source is the position coordinate on the VDU queue</span>
        <span class="character">JMP .copyFourBytesWithinVDUVariables                        ; copy four bytes</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; When drawing a *character* at the graphics cursor, this draws an individual pixel</span>
    <span class="character">; of that character. (This is almost identical to .plotPoint but it uses a different</span>
    <span class="character">; VDU variable).</span>
    <span class="character">.plotAPixelInACharacter</span>
        <span class="character">LDX #.vduGraphicsCursorPixelsXLow - .vduVariablesStart  ;</span>
        <span class="character">JSR .checkPointXInBoundsAndSetScreenAddresses           ; calculate position</span>
        <span class="character">BEQ .plotPointWithinBounds                              ; if (result is zero) then branch</span>
        <span class="character">RTS                                                     ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Plots a single point whose position is given by the four bytes of the VDU parameters</span>
    <span class="character">; at .vdu25ParameterXLow and above.</span>
    <span class="character">;</span>
    <span class="character">; This checks we are in the graphics window, gets the address details, applies the mask</span>
    <span class="character">; to the OR and EOR byte values for the given plot type, and uses these to update the</span>
    <span class="character">; contents of the screen address.</span>
    <span class="character">.plotPoint</span>
        <span class="character">JSR .checkParameterInBoundsAndSetScreenAddresses    ; check in bounds and set up screen addresses</span>
        <span class="character">BNE +                                               ; if (A is not zero) then branch (return)</span>
    <span class="character">.plotPointWithinBounds</span>
        <span class="character">LDY .vduGraphicsCursorVerticalOffsetInCell          ; get current graphics scan line</span>
    <span class="character">.plotPointWithinBoundsAtY</span>
        <span class="character">LDA .vduCurrentPlotByteMask                         ;</span>
        <span class="character">AND .graphicsColourByteOR                           ;</span>
        <span class="character">ORA (.screenAddressOfGraphicsCursorCellLow),Y       ;</span>
        <span class="character">STA .tempStoreDA                                    ;</span>
        <span class="character">LDA .graphicsColourByteEOR                          ;</span>
        <span class="character">AND .vduCurrentPlotByteMask                         ;</span>
        <span class="character">EOR .tempStoreDA                                    ;</span>
        <span class="character">STA (.screenAddressOfGraphicsCursorCellLow),Y       ; put it back again</span>
    <span class="character">+</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Plots a point as part of a lateral fill.</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       Y is the vertical offset within a character cell (0-7)</span>
    <span class="character">.lateralFillPlotPoint</span>
        <span class="character">LDA (.screenAddressOfGraphicsCursorCellLow),Y       ;</span>
        <span class="character">ORA .graphicsColourByteOR                           ;</span>
        <span class="character">EOR .graphicsColourByteEOR                          ;</span>
        <span class="character">STA (.screenAddressOfGraphicsCursorCellLow),Y       ;</span>
        <span class="character">RTS                                                 ; and exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Check that the graphics cursor is within the graphics window.</span>
    <span class="character">;</span>
    <span class="character">; On Exit:</span>
    <span class="character">;   .tempStoreDA is zero if the point is within the graphics window, or the four low bits</span>
    <span class="character">;                indicate which regions failed:</span>
    <span class="character">;       %0000   success (point is within window)</span>
    <span class="character">;       %0001   graphics cursor X is left of  the left   edge of the graphics window</span>
    <span class="character">;       %0010   graphics cursor X is right of the right  edge of the graphics window</span>
    <span class="character">;       %0100   graphics cursor Y is below    the bottom edge of the graphics window</span>
    <span class="character">;       %1000   graphics cursor Y is above    the top    edge of the graphics window</span>
    <span class="character">;</span>
    <span class="character">.checkGraphicsCursorIsWithinGraphicsWindow</span>
        <span class="character">LDX #.vduGraphicsCursorPixelsXLow - .vduVariablesStart     ; X is the offset to check the graphics cursor</span>
    <span class="character">.checkVariableXIsWithinGraphicsWindow</span>
        <span class="character">LDY #0                                                     ;</span>
        <span class="character">STY .tempStoreDA                                           ; .tempStoreDA is initialised to zero (used to store the error code)</span>
        <span class="character">LDY #2                                                     ; Y is the index to check the vertical bounds of the graphics window</span>
        <span class="character">JSR .checkPointIsWithinWindowHorizontalOrVertical          ; check graphics cursor is within window vertically</span>
        <span class="character">ASL .tempStoreDA                                           ; } Shift up error results two bits to make room for the next horizontal test results</span>
        <span class="character">ASL .tempStoreDA                                           ; }</span>
        <span class="character">DEX                                                        ;</span>
        <span class="character">DEX                                                        ; Reduce index by two to check the X position</span>
        <span class="character">LDY #0                                                     ; Y is the index to check the horizontal bounds of the graphics window</span>
        <span class="character">JSR .checkPointIsWithinWindowHorizontalOrVertical          ; check graphics cursor is within window horizontally</span>
        <span class="character">INX                                                        ; }</span>
        <span class="character">INX                                                        ; } Restore X to initial value</span>
        <span class="character">LDA .tempStoreDA                                           ; A = error code (0,1,2,4,5,6,8,9,10) depending on which bounds are exceeded</span>
        <span class="character">RTS                                                        ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Check that a given coordinate of a point is within the given window horizontal or vertical bounds</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X is the offset to the coordinate to check minus two bytes</span>
    <span class="character">;   Y is the offset to the second variable to check (0 for horizontal or 2 for vertical)</span>
    <span class="character">; On Exit:</span>
    <span class="character">;   .tempStoreDA is the error code (0 = no error, 1 = first check failed, 2 = second check failed)</span>
    <span class="character">;   Zero flag set if no error</span>
    <span class="character">;</span>
    <span class="character">.checkPointIsWithinWindowHorizontalOrVertical</span>
        <span class="character">LDA .vduVariablesStart + 2,X                        ; } Subtract two sixteen bit variables, compare the results.</span>
        <span class="character">CMP .vduVariablesStart + 0,Y                        ; } if var[X+2,X+3] &lt; var[Y,Y+1] then error</span>
        <span class="character">LDA .vduVariablesStart + 3,X                        ; }</span>
        <span class="character">SBC .vduVariablesStart + 1,Y                        ; }</span>
        <span class="character">BMI .oneError                                       ; so branch</span>

        <span class="character">LDA .vduVariablesStart + 4,Y                        ; } Subtract two sixteen bit variables, compare the results.</span>
        <span class="character">CMP .vduVariablesStart + 2,X                        ; } if var[Y+4,Y+5] &lt; var[X+2,X+3] then error</span>
        <span class="character">LDA .vduVariablesStart + 5,Y                        ; }</span>
        <span class="character">SBC .vduVariablesStart + 3,X                        ; }</span>
        <span class="character">BPL +                                               ; if (no violation) then branch (exit)</span>
        <span class="character">INC .tempStoreDA                                    ; increment error code</span>
    <span class="character">.oneError</span>
        <span class="character">INC .tempStoreDA                                    ; increment error code</span>
    <span class="character">+</span>
        <span class="character">RTS                                                 ; and exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Convert external coordinates to pixels (horizontal and vertical)</span>
    <span class="character">; X is the offset in vdu variables to the coordinate to convert</span>
    <span class="character">.plotConvertAbsoluteCoordinatesToPixels</span>
        <span class="character">LDA #$FF                                           ; A=$FF to make sure we are using absolute coordinates</span>
        <span class="character">BNE +                                              ; ALWAYs branch</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Convert pair of external coordinates to pixels (horizontal and vertical)</span>
    <span class="character">; X is the offset in vdu variables to the coordinate to convert</span>
    <span class="character">.plotConvertCoordinatesToPixels</span>
        <span class="character">LDA .vdu25ParameterPlotType                         ; get first parameter in plot</span>
    <span class="character">+</span>
        <span class="character">STA .tempStoreDA                                    ; store in .tempStoreDA</span>
        <span class="character">LDY #2                                              ; Y=2 (for vertical coordinates)</span>
        <span class="character">JSR .convertCoordinatesToAbsoluteAndDivideByTwo     ; set up vertical coordinates / 2</span>
        <span class="character">JSR .signedDivideCoordinateByTwo                    ; /2 again to convert 1023 to 0-255 for internal use</span>
        <span class="character">LDY #0                                              ; Y=0 (for horizontal coordinates)</span>
        <span class="character">DEX                                                 ;</span>
        <span class="character">DEX                                                 ; X+=2</span>
        <span class="character">JSR .convertCoordinatesToAbsoluteAndDivideByTwo     ; set up horiz. coordinates / 2</span>
        <span class="character">LDY .pixelsPerByteMinusOneForCurrentMode            ; get number of pixels/byte (-1)</span>
                                                            <span class="character">;     7 for Mode 0</span>
                                                            <span class="character">;     3 for Mode 1</span>
                                                            <span class="character">;     1 for Mode 2</span>
                                                            <span class="character">;     0 for Mode 3</span>
                                                            <span class="character">;     7 for Mode 4</span>
                                                            <span class="character">;     3 for Mode 5</span>
                                                            <span class="character">;     0 for Mode 6</span>
                                                            <span class="character">;     0 for Mode 7</span>

        <span class="character">CPY #3                                              ;</span>
        <span class="character">BEQ +                                               ; if (mode 1 or 5) then branch (divide by 2)</span>
        <span class="character">BCS .doneDividing                                   ; if (mode 0 or 4) then branch (ok - no division needed)</span>
        <span class="character">JSR .signedDivideCoordinateByTwo                    ; if (mode 2,3,6 or 7) then divide by 4 (divide by two twice)</span>
    <span class="character">+</span>
        <span class="character">JSR .signedDivideCoordinateByTwo                    ; divide by 2</span>
    <span class="character">.doneDividing</span>
        <span class="character">LDA .vduCurrentScreenModeMemorySizeIndex            ; screen memory size type</span>
        <span class="character">BNE .signedDivideCoordinateByTwo                    ; if (modes 3-7) then branch (divide by 2 again)</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Converts the vdu queue parameter to absolute coordinates and divides by two</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X            is the offset in vdu variables to the vdu queue parameter coordinate to convert</span>
    <span class="character">;   Y            is 0 or 2 for the horizontal or vertical cursor coordinates</span>
    <span class="character">;   .tempStoreDA is the plot type (used to check for relative coordinate conversion)</span>
    <span class="character">.convertCoordinatesToAbsoluteAndDivideByTwo</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">LDA .tempStoreDA                                    ; get .tempStoreDA</span>
        <span class="character">AND #4                                              ; }</span>
        <span class="character">BEQ .calculateRelativeCoordinates                   ; } if (bit 2=0) then branch to calculate relative coordinates</span>
        <span class="character">LDA .vduGraphicsWindowPixelsBottomLow,X             ; get coordinate</span>
        <span class="character">PHA                                                 ;</span>
        <span class="character">LDA .vduGraphicsWindowPixelsBottomHigh,X            ;</span>
        <span class="character">BCC .gotCoordinatesAS                               ; ALWAYs branch</span>

    <span class="character">.calculateRelativeCoordinates</span>
        <span class="character">LDA .vduGraphicsWindowPixelsBottomLow,X             ; get coordinate</span>
        <span class="character">ADC .vduGraphicsCursorPositionXLow,Y                ; add cursor position</span>
        <span class="character">PHA                                                 ; save it</span>
        <span class="character">LDA .vduGraphicsWindowPixelsBottomHigh,X            ;</span>
        <span class="character">ADC .vduGraphicsCursorPositionXHigh,Y               ; add cursor</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">; fall through...</span>

    <span class="character">.gotCoordinatesAS</span>
        <span class="character">STA .vduGraphicsCursorPositionXHigh,Y               ; save new cursor</span>
        <span class="character">ADC .vduGraphicsWindowOriginXHigh,Y                 ; add graphics origin</span>
        <span class="character">STA .vduGraphicsWindowPixelsBottomHigh,X            ; store it</span>
        <span class="character">PLA                                                 ; get back low byte</span>
        <span class="character">STA .vduGraphicsCursorPositionXLow,Y                ; save it in new cursor low</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">ADC .vduGraphicsWindowOriginXLow,Y                  ; add to graphics orgin</span>
        <span class="character">STA .vduGraphicsWindowPixelsBottomLow,X             ; store it</span>
        <span class="character">BCC .signedDivideCoordinateByTwo                    ; if (carry clear) then branch (skip over next statement)</span>
        <span class="character">INC .vduGraphicsWindowPixelsBottomHigh,X            ; increment high byte as you would expect!</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Divides the signed 16 bit coordinate value by two</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X is the offset to the coordinate from .vduGraphicsWindowPixelsBottomLow</span>
    <span class="character">;</span>
    <span class="character">.signedDivideCoordinateByTwo</span>
        <span class="character">LDA .vduGraphicsWindowPixelsBottomHigh,X            ; get high byte</span>
        <span class="character">ASL                                                 ;</span>
        <span class="character">ROR .vduGraphicsWindowPixelsBottomHigh,X            ; divide by 2</span>
        <span class="character">ROR .vduGraphicsWindowPixelsBottomLow,X             ;</span>
        <span class="character">RTS                                                 ; and exit</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.convertInternalGraphicsCoordinatesToExternal</span>
        <span class="character">LDY #.vduGraphicsCursorPositionXLow - .vduVariablesStart    ; destination: graphics cursor in external coordinates</span>
        <span class="character">JSR .copyGraphicsCursorPixelPosition                        ; source is graphics cursor in pixel coordinates.</span>
                                                                    <span class="character">; copy pixel coordinates to external coordinates.</span>
        <span class="character">LDX #2                                                      ; X=2 (offset to update the vertical coordinate)</span>
        <span class="character">LDY #2                                                      ; Y=2 (shift twice to multiply by four)</span>
        <span class="character">JSR +                                                       ; multiply .vduGraphicsCursorPositionY by 4 and subtract graphics origin</span>
                                                                    <span class="character">; this is the external Y coordinate.</span>
        <span class="character">LDX #0                                                      ; X=0 (offset to update the horizontal coordinate)</span>
        <span class="character">LDY #4                                                      ; Y=4</span>
        <span class="character">LDA .pixelsPerByteMinusOneForCurrentMode                    ; get number of pixels/byte</span>
    <span class="character">-</span>
        <span class="character">DEY                                                         ; Y=Y-1</span>
        <span class="character">LSR                                                         ; divide by 2</span>
        <span class="character">BNE -                                                       ; if (result not 0) then branch (loop back)</span>

        <span class="character">; Pixels                                     Number of</span>
        <span class="character">; per byte   Screen     Y    Screen Mode   multiplication</span>
        <span class="character">; minus one   Mode     Now   Memory Size   steps (#shifts)</span>
        <span class="character">; --------------------------------------------------------</span>
        <span class="character">;    7       Mode 0     1         0              1  (x1)</span>
        <span class="character">;    3       Mode 1     2         0              2  (x2)</span>
        <span class="character">;    1       Mode 2     3         0              3  (x4)</span>
        <span class="character">;    0       Mode 3     -         1              -</span>
        <span class="character">;    7       Mode 4     1         2              2  (x2)</span>
        <span class="character">;    3       Mode 5     2         2              3  (x4)</span>
        <span class="character">;    0       Mode 6     -         3              -</span>
        <span class="character">;    0       Mode 7     -         4              -</span>
        <span class="character">; --------------------------------------------------------</span>

        <span class="character">LDA .vduCurrentScreenModeMemorySizeIndex                    ; screen memory size type</span>
        <span class="character">BEQ +                                                       ; and if 0 then branch</span>
        <span class="character">INY                                                         ; Y holds the number of multiplication steps (1, 2 or 3)</span>
    <span class="character">+</span>
    <span class="character">-</span>
        <span class="character">ASL .vduGraphicsCursorPositionXLow,X                        ; } multiply coordinate by 2</span>
        <span class="character">ROL .vduGraphicsCursorPositionXHigh,X                       ; }</span>
        <span class="character">DEY                                                         ; Y-Y-1</span>
        <span class="character">BNE -                                                       ; and if Y != 0 then branch (do it again)</span>

        <span class="character">SEC                                                         ; set carry</span>
        <span class="character">JSR +                                                       ;</span>
        <span class="character">INX                                                         ; increment X</span>
    <span class="character">+</span>
        <span class="character">LDA .vduGraphicsCursorPositionXLow,X                        ; get current graphics position in external coordinates</span>
        <span class="character">SBC .vduGraphicsWindowOriginXLow,X                          ; subtract origin</span>
        <span class="character">STA .vduGraphicsCursorPositionXLow,X                        ; store in graphics cursor position</span>
        <span class="character">RTS                                                         ; and exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Plot a line or a dotted line</span>
    <span class="character">.plotLine</span>
        <span class="character">JSR .getOffsetFromCurrentGraphicsCursorPosition     ; .vduWorkspaceA/B = graphics cursorX - parameterX  (lets call this dX)</span>
                                                            <span class="character">; .vduWorkspaceC/D = graphics cursorY - parameterY  (lets call this dY)</span>

    <span class="character">; At this point, the values in workspaceABCD are the dX/dY in pixels for the line we</span>
    <span class="character">; want to draw. The values are 16 bit signed integers. Positive values are to the left and</span>
    <span class="character">; down on screen, like so:</span>
    <span class="character">;</span>
    <span class="character">;                                         |</span>
    <span class="character">;                                         |</span>
    <span class="character">;                                         |</span>
    <span class="character">;                       dX /______________|_____________</span>
    <span class="character">;                          \</span><span class="plain"> </span><span class="character">          ###|&lt;-(current graphics</span>
    <span class="character">;                                   ###   |   cursor position)</span>
    <span class="character">;                                ###      |</span>
    <span class="character">;                             ###         |</span>
    <span class="character">;        (new parameter -&gt; ###           \</span><span class="plain">|</span><span class="character">/</span>
    <span class="character">;           coordinates)                 dY</span>
    <span class="character">;</span>

        <span class="character">LDA .vduWorkspaceD                                  ;</span>
        <span class="character">EOR .vduWorkspaceB                                  ; check high bytes for different Sign bit in dX/dY</span>
        <span class="character">BMI .sectionB                                       ; if (result -ve; then deltas are different in sign) then branch later</span>
    <span class="character">; -------------SECTION A-------------</span>
    <span class="character">; dX and dY have the same sign</span>
        <span class="character">LDA .vduWorkspaceC                                  ; }</span>
        <span class="character">CMP .vduWorkspaceA                                  ; } if (dY &gt;= dX) then A = dY - dX</span>
        <span class="character">LDA .vduWorkspaceD                                  ; }               else A = dY - dX - 1</span>
        <span class="character">SBC .vduWorkspaceB                                  ; }</span>
                                                            <span class="character">; } Result: A is positive if dY &gt; dX, A is negative if dY &lt; dX, otherwise A = 0.</span>
                                                            <span class="character">; }    i.e. A is SIGN(dY - dX), C = carry of difference (^)</span>
    <span class="character">; ----------SECTION A ENDS-----------</span>
        <span class="character">JMP .plotLineGotDeltas                              ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.sectionB</span>
    <span class="character">; -------------SECTION B-------------</span>
    <span class="character">; dX and dY have different signs</span>
        <span class="character">LDA .vduWorkspaceA                                  ; } A = (dX + dY) (high byte)</span>
        <span class="character">CLC                                                 ; } (where deltas are different in sign, so really a subtraction)</span>
        <span class="character">ADC .vduWorkspaceC                                  ; }</span>
        <span class="character">LDA .vduWorkspaceB                                  ; } Result: A is positive if (dX &gt; -dY), A is negative if dX &lt; -dY, otherwise A = 0</span>
        <span class="character">ADC .vduWorkspaceD                                  ; }    i.e. A is SIGN(dX - dY), C = carry of difference (^)</span>
    <span class="character">; ----------SECTION B ENDS-----------</span>

    <span class="character">.plotLineGotDeltas</span>
        <span class="character">ROR                                                 ; top bit of A = result carry from above</span>
        <span class="character">LDX #0                                              ; X = 0</span>
        <span class="character">EOR .vduWorkspaceD                                  ; Check if carry from result above has same sign as workspaceD</span>
        <span class="character">BPL +                                               ; if (dY has same sign as A) then branch (with X=0)</span>
        <span class="character">LDX #2                                              ; X=2</span>
    <span class="character">+</span>
        <span class="character">STX .tempStoreDE                                    ; store X: X=0 means dx is the dominant axis, at least as large in magnitude as dy; X=2 otherwise.</span>
        <span class="character">LDA .vduPlotLineRoutineAddresses,X                  ; }</span>
        <span class="character">STA .vduJumpVectorLow                               ; }</span>
        <span class="character">LDA .vduPlotLineRoutineAddresses+1,X                ; } set up the address of one of two line drawing routines into .vduJumpVectorLow/High (based on X=0 or 2)</span>
        <span class="character">STA .vduJumpVectorHigh                              ; }</span>
        <span class="character">LDA .vduWorkspaceB,X                                ; Choose which side of the line dY = -dX we are drawing on. (values $00 or $FF)</span>

    <span class="character">; Examples:                                  ----------SECTION A----------   ------------SECTION B-------------</span>
    <span class="character">;               vduWorkspace       signs     Carry    Result                    Carry      Result                  (Result Carry            X</span>
    <span class="character">;    dX   dY    A   B   C   D    different?  (C&gt;=A)   D-B-(1-Carry)          (A+C) &gt; 255   (B+D+Carry)             EOR top bit of D)   .tempStoreDE      .vduWorkspaceB,X</span>
    <span class="character">; -----------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
    <span class="character">;    3    1    $03 $00 $01 $00      no         0      $FF (Result Carry=0)        -        -                        0 EOR 0 = 0         0                 $00</span>
    <span class="character">;    1    3    $01 $00 $03 $00      no         1      $00 (Result Carry=1)        -        -                        1 EOR 0 = 1         2 (Y dominant)    $00</span>
    <span class="character">;   -3    1    $FD $FF $01 $00      yes        -       -                          0        $FF (Result Carry=0)     0 EOR 0 = 0         0                 $FF (dy &lt; -dx)</span>
    <span class="character">;   -1    3    $FF $FF $03 $00      yes        -       -                          1        $00 (Result Carry=1)     1 EOR 0 = 1         2 (Y dominant)    $00</span>
    <span class="character">;    3   -1    $03 $00 $FF $FF      yes        -       -                          1        $00 (Result Carry=1)     1 EOR 1 = 0         0                 $00</span>
    <span class="character">;    1   -3    $01 $00 $FD $FF      yes        -       -                          0        $FF (Result Carry=0)     0 EOR 1 = 1         2 (Y dominant)    $FF (dy &lt; -dx)</span>
    <span class="character">;   -3   -1    $FD $FF $FF $FF      no         1      $00 (Result Carry=1)        -        -                        1 EOR 1 = 0         0                 $FF (dy &lt; -dx)</span>
    <span class="character">;   -1   -3    $FF $FF $FD $FF      no         0      $FF (Result Carry=0)        -        -                        0 EOR 1 = 1         2 (Y dominant)    $FF (dy &lt; -dx)</span>
    <span class="character">; -----------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        <span class="character">BPL +                                                   ; if (dY &gt;=-dX) then branch  (start drawing from the new parameter position)</span>
        <span class="character">LDX #.vduGraphicsCursorPixelsXLow - .vduVariablesStart  ; source: current graphics cursor    (start drawing from current cursor position)</span>
        <span class="character">BNE .parametersSet                                      ; ALWAYs branch</span>

    <span class="character">+</span>
        <span class="character">LDX #.vdu25ParameterXLow - .vduVariablesStart       ; source: vdu queue parameters          (start drawing from new cursor position)</span>
    <span class="character">.parametersSet</span>
        <span class="character">;</span>
        <span class="character">; The line'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">furthest</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> (</span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">dominant</span><span class="plain"> </span><span class="identifier">axis</span><span class="plain">) </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">nearest</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> (</span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">dominant</span><span class="plain"> </span><span class="identifier">axis</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">now</span><span class="plain"> </span><span class="identifier">holds</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">vdu</span><span class="plain"> </span><span class="identifier">variable</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">line</span><span class="plain">.</span>
        <span class="plain">;</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tempStoreDF</span><span class="plain">                                    ;      </span><span class="identifier">source</span><span class="plain">: (</span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">vdu</span><span class="plain"> </span><span class="identifier">variable</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">point</span><span class="plain">, </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">tempStoreDF</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">vduWorkspaceE</span><span class="plain"> - .</span><span class="identifier">vduVariablesStart</span><span class="plain">            ; </span><span class="identifier">destination</span><span class="plain">: .</span><span class="identifier">vduWorkspaceEFGH</span><span class="plain"> (</span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">workspace</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyFourBytesWithinVDUVariables</span><span class="plain">                ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">pixel</span><span class="plain"> </span><span class="identifier">coordinates</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">draw</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">workspace</span><span class="plain"> </span><span class="identifier">EFGH</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreDF</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">vdu</span><span class="plain"> </span><span class="identifier">variable</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">point</span>
        <span class="identifier">EOR</span><span class="plain"> #4                                              ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">whichever</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> (</span><span class="identifier">vdu</span><span class="plain"> </span><span class="identifier">queue</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain"> / </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain">) </span><span class="identifier">wasn</span><span class="character">'t chosen before,</span>
                                                            <span class="character">; i.e. the end of the line to draw</span>
        <span class="character">STA .tempStoreDD                                    ; .tempStoreDD = offset to vdu variable for the end of the line</span>
        <span class="character">ORA .tempStoreDE                                    ; OR with 0 or 2 (if Y is the dominant axis we offset by 2 to copy the Y coordinate of the end point;</span>
                                                            <span class="character">; otherwise copy the X coordinate). We will use this later to check for termination on plotting the line.</span>
        <span class="character">TAX                                                 ;</span>
        <span class="character">JSR .copy2BytesWithinVDUVariablesToTerminationValue ; copy final coordinate to termination value. We use this later to check for termination on plotting the line.</span>

        <span class="character">LDA .vdu25ParameterPlotType                         ; get plot type</span>
        <span class="character">AND #%00010000                                      ; check bit 4 (dotted line)</span>
        <span class="character">ASL                                                 ;</span>
        <span class="character">ASL                                                 ;</span>
        <span class="character">ASL                                                 ; move to bit 7</span>
        <span class="character">STA .tempStoreDB                                    ; store whether we want a dotted line ($80) or not ($00)</span>

        <span class="character">LDX #.vduWorkspaceE - .vduVariablesStart            ;</span>
        <span class="character">JSR .checkVariableXIsWithinGraphicsWindow           ; check EFGH coordinates for being out of bounds</span>
        <span class="character">STA .tempStoreDC                                    ; store error code</span>
        <span class="character">BEQ +                                               ; if (none) then branch</span>
        <span class="character">LDA #%01000000                                      ; }</span>
        <span class="character">ORA .tempStoreDB                                    ; } Set bit 6 of .tempStoreDB to indicate out of bounds</span>
        <span class="character">STA .tempStoreDB                                    ; }</span>
    <span class="character">+</span>
        <span class="character">LDX .tempStoreDD                                    ;</span>
        <span class="character">JSR .checkVariableXIsWithinGraphicsWindow           ; check other end of line for out of bounds</span>
        <span class="character">BIT .tempStoreDC                                    ; BIT test (AND) together the bits of the two out of bounds calculations</span>
                                                            <span class="character">; this checks if the two ends of the line are out of bounds in the same direction</span>
                                                            <span class="character">; (e.g. both to the right of the right edge)</span>
        <span class="character">BEQ .worthPlottingLine                              ; if (result is zero) then branch</span>
        <span class="character">RTS                                                 ; the line is all off screen so return</span>

    <span class="character">.worthPlottingLine</span>
        <span class="character">LDX .tempStoreDE                                    ; .tempStoreDE holds the dominant axis value (0 or 2)</span>
        <span class="character">BEQ +                                               ; if (X=0) then branch (skip the next bit. Bits 0 and 1 of A are the error code results for the X axis)</span>
        <span class="character">LSR                                                 ; } here the Y axis is dominant.</span>
        <span class="character">LSR                                                 ; } shift the error code down twice so that the '</span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bounds</span><span class="character">' results for the Y axis are in bits 0 and 1</span>
    <span class="character">+</span>
        <span class="character">AND #2                                              ; clear all but bit 1</span>
                                                            <span class="character">; NOTE: bit 1 is set if the end point is either:</span>
                                                            <span class="character">;                 to the right of the graphics window (when X axis is dominant)</span>
                                                            <span class="character">;             or above the top of the graphics window (when Y axis is dominant)</span>
        <span class="character">BEQ +                                               ; if (bit 2 clear) then branch (end point is ok, NOT off to the right/above the graphics window)</span>
        <span class="character">TXA                                                 ; } The end point is beyond the right or top of the graphics window, so we set</span>
        <span class="character">ORA #4                                              ; } the termination variable (.vduPlotLineTerminationValue) to the edge of the screen.</span>
                                                            <span class="character">; } set bit 3 of X (now X is the offset to .vduGraphicsWindowPixelsRightLow or .vduGraphicsWindowPixelsTopLow)</span>
        <span class="character">TAX                                                 ; }</span>
        <span class="character">JSR .copy2BytesWithinVDUVariablesToTerminationValue ; copy final X or Y coordinate to the termination value</span>
    <span class="character">+</span>
        <span class="character">JSR .plotLineMoreCalculations                       ; more calculations</span>
        <span class="character">LDA .tempStoreDE                                    ; get the dominant axis (0 or 2)</span>
        <span class="character">EOR #2                                              ; EOR it with 2 to get the non-dominant axis (2 or 0)</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">TAY                                                 ; Y=A</span>
        <span class="character">LDA .vduWorkspaceB                                  ; } compare upper bytes of dX with dY</span>
        <span class="character">EOR .vduWorkspaceD                                  ; }</span>
        <span class="character">BPL +                                               ; if (signs are the same) then branch</span>
        <span class="character">INX                                                 ; X=X+1 (X is 3 or 1)</span>
    <span class="character">+</span>
        <span class="character">LDA .vduRoutineBranchVectorAddressesLow,X           ; get vector addresses and store at .vduRoutineLow/High</span>
        <span class="character">STA .vduRoutineLow                                  ; Routine 0 is for a dominant Y axis, and same signs of dX/dY       (.plotLineDominantYAxisSameSign)</span>
        <span class="character">LDA .vduRoutineBranchVectorAddressesHigh,X          ; Routine 1 is for a dominant Y axis, and different signs of dX/dY  (.plotLineDominantYAxisDifferentSign)</span>
        <span class="character">STA .vduRoutineHigh                                 ; Routine 2 is for a dominant X axis, and same signs of dX/dY       (.plotLineDominantXAxisSameSign)</span>
                                                            <span class="character">; Routine 3 is for a dominant X axis, and different signs of dX/dY  (.plotLineDominantXAxisDifferentSign)</span>

        <span class="character">LDA #$7F                                            ; A=$7F</span>
        <span class="character">STA .vduWorkspaceM                                  ; store it</span>
        <span class="character">BIT .tempStoreDB                                    ; check to see if EFGH is out of bounds</span>
        <span class="character">BVS .workspaceEFGHisOutOfBounds                     ; if (out of bounds) then branch (EFGH is out of bounds)</span>

        <span class="character">LDA .vduGraphicsWindowBoundariesTable,X             ; get offset to graphics window boundary</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">LDA .vduVariablesStart + 0,X                        ; } get graphics window boundary - workspaceEF</span>
        <span class="character">SBC .vduWorkspaceE,Y                                ; }</span>
        <span class="character">STA .tempStoreDA                                    ; } DA = low byte</span>
        <span class="character">LDA .vduVariablesStart + 1,X                        ; }</span>
        <span class="character">SBC .vduWorkspaceF,Y                                ; } A = high byte</span>
        <span class="character">LDY .tempStoreDA                                    ; Y = low byte</span>
        <span class="character">TAX                                                 ; X = high byte</span>
        <span class="character">BPL +                                               ; and if X+Ve then branch</span>
        <span class="character">JSR .negateAY                                       ; negate Y/A: Make sure offset is negative</span>

    <span class="character">+</span>
        <span class="character">TAX                                                 ; } X = high byte of offset</span>
        <span class="character">INY                                                 ; } Y =  low byte of offset</span>
        <span class="character">BNE +                                               ; } Increment AY</span>
        <span class="character">INX                                                 ; }</span>
    <span class="character">+                                                       ; }</span>
        <span class="character">TXA                                                 ; } A = high byte</span>

        <span class="character">BEQ +                                               ; if (A=0) then branch</span>
        <span class="character">LDY #0                                              ; Y=0</span>
    <span class="character">+</span>
        <span class="character">STY .tempStoreDF                                    ; .tempStoreDF = Y</span>
        <span class="character">BEQ +                                               ; if (zero) then branch</span>

    <span class="character">.workspaceEFGHisOutOfBounds</span>
        <span class="character">TXA                                                 ; A = X</span>
        <span class="character">LSR                                                 ; A = A / 2</span>
        <span class="character">ROR                                                 ; A = A / 2</span>
        <span class="character">ORA #2                                              ; bit 1 set</span>
        <span class="character">EOR .tempStoreDE                                    ;</span>
        <span class="character">STA .tempStoreDE                                    ; and store</span>
    <span class="character">+</span>
        <span class="character">LDX #.vduWorkspaceE - .vduVariablesStart            ; X points to workspaceE</span>
        <span class="character">JSR .setScreenAddress                               ;</span>
        <span class="character">LDX .tempStoreDC                                    ;</span>
        <span class="character">BNE +                                               ;</span>
        <span class="character">DEC .tempStoreDD                                    ;</span>
    <span class="character">+</span>
        <span class="character">DEX                                                 ; X = X - 1</span>

    <span class="character">.plotLineLoop</span>
        <span class="character">LDA .tempStoreDB                                    ;</span>
        <span class="character">BEQ .writePointToScreen                             ; if (zero) then branch</span>
        <span class="character">BPL ++                                              ; if (+ve) then branch</span>
        <span class="character">BIT .vduWorkspaceM                                  ;</span>
        <span class="character">BPL +                                               ; if (bit 7=0) then branch</span>
        <span class="character">DEC .vduWorkspaceM                                  ; decrement</span>
        <span class="character">BNE .postWritePointToScreen                         ; if (not zero) then branch</span>
    <span class="character">+</span>
        <span class="character">INC .vduWorkspaceM                                  ;</span>
        <span class="character">ASL                                                 ; A = A * 2</span>
        <span class="character">BPL .writePointToScreen                             ; if (+ve) then branch</span>
    <span class="character">++</span>
        <span class="character">STX .tempStoreDC                                    ;</span>
        <span class="character">LDX #.vduWorkspaceE - .vduVariablesStart            ;</span>
        <span class="character">JSR .checkPointXInBoundsAndSetScreenAddresses       ; calculate screen position</span>
        <span class="character">LDX .tempStoreDC                                    ; get back original X</span>
        <span class="character">ORA #0                                              ;</span>
        <span class="character">BNE .postWritePointToScreen                         ;</span>

    <span class="character">.writePointToScreen</span>
        <span class="character">LDA .vduCurrentPlotByteMask                         ; byte mask for current graphics point</span>
        <span class="character">AND .graphicsColourByteOR                           ; and with graphics colour OR byte</span>
        <span class="character">ORA (.screenAddressOfGraphicsCursorCellLow),Y       ; or  with curent graphics cell line</span>
        <span class="character">STA .tempStoreDA                                    ; store result</span>
        <span class="character">LDA .graphicsColourByteEOR                          ; same again with colour EOR byte</span>
        <span class="character">AND .vduCurrentPlotByteMask                         ;</span>
        <span class="character">EOR .tempStoreDA                                    ;</span>
        <span class="character">STA (.screenAddressOfGraphicsCursorCellLow),Y       ; then store it in current graphics line</span>

    <span class="character">.postWritePointToScreen</span>
        <span class="character">SEC                                                 ; }</span>
        <span class="character">LDA .vduWorkspaceN                                  ; }</span>
        <span class="character">SBC .vduWorkspaceP                                  ; } NO = NO - PQ</span>
        <span class="character">STA .vduWorkspaceN                                  ; }</span>
        <span class="character">LDA .vduWorkspaceO                                  ; }</span>
        <span class="character">SBC .vduWorkspaceQ                                  ; }</span>
        <span class="character">BCS +                                               ; }</span>
        <span class="character">STA .tempStoreDA                                    ; } if (NO &lt; PQ) then NO = NO+RS</span>
        <span class="character">LDA .vduWorkspaceN                                  ; }</span>
        <span class="character">ADC .vduWorkspaceR                                  ; }</span>
        <span class="character">STA .vduWorkspaceN                                  ; }</span>
        <span class="character">LDA .tempStoreDA                                    ; }</span>
        <span class="character">ADC .vduWorkspaceS                                  ; }</span>
        <span class="character">CLC                                                 ; }</span>
    <span class="character">+                                                       ; }</span>
        <span class="character">STA .vduWorkspaceO                                  ; }</span>
        <span class="character">PHP                                                 ;</span>
        <span class="character">BCS .jumpVector                                     ; if (carry set) then branch</span>
        <span class="character">JMP (.vduRoutineLow)                                ; jump to VDU routine</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotLineDominantXAxisSameSign                          ;</span>
        <span class="character">DEY                                                 ; Y=Y-1 (moving up the screen)</span>
        <span class="character">BPL .jumpVector                                     ; if (not negative) then branch</span>
        <span class="character">JSR .moveGraphicsCursorAddressUpOneCharacterCell    ; call subroutine to advance cursor address to the next cell up</span>
    <span class="character">.jumpVector</span>
        <span class="character">JMP (.vduJumpVectorLow)                             ; and JUMP indirect</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotLineDominantXAxisDifferentSign                     ;</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">CPY #8                                              ; }</span>
        <span class="character">BNE .jumpVector                                     ; } if Y != 8 then branch</span>

        <span class="character">CLC                                                 ; }</span>
        <span class="character">LDA .screenAddressOfGraphicsCursorCellLow           ; }</span>
        <span class="character">ADC .vduBytesPerCharacterRowLow                     ; } add a row onto the graphic cursor address</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellLow           ; }</span>
        <span class="character">LDA .screenAddressOfGraphicsCursorCellHigh          ; }</span>
        <span class="character">ADC .vduBytesPerCharacterRowHigh                    ; }</span>
        <span class="character">BPL +                                               ; if (result +ve) then branch (we are within screen RAM)</span>
        <span class="character">SEC                                                 ; we are above screen RAM</span>
        <span class="character">SBC .vduScreenSizeHighByte                          ; subtract screen memory size high</span>
    <span class="character">+</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellHigh          ; store it (this wraps around point to screen RAM)</span>
        <span class="character">LDY #0                                              ; Y=0</span>
        <span class="character">JMP (.vduJumpVectorLow)                             ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotLineDominantYAxisSameSign</span>
        <span class="character">LSR .vduCurrentPlotByteMask                             ; shift byte mask</span>
        <span class="character">BCC .jumpVector                                         ; if (carry clear) then branch (plot it)</span>
        <span class="character">JSR .moveGraphicsCursorAddressTotheRightAndUpdateMask   ; update address and mask</span>
        <span class="character">JMP (.vduJumpVectorLow)                                 ; and off to do more</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotLineDominantYAxisDifferentSign</span>
        <span class="character">ASL .vduCurrentPlotByteMask                             ; shift byte mask</span>
        <span class="character">BCC .jumpVector                                         ; if (carry clear; .vduCurrentPlotByteMask was +ve) then branch</span>
        <span class="character">JSR .moveGraphicsCursorAddressTotheLeftAndUpdateMask    ; move graphics cursor address left and update mask value</span>
        <span class="character">JMP (.vduJumpVectorLow)                                 ; and off to do more</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotLineWithDominantAxisY</span>
        <span class="character">DEY                                                 ; Y = Y - 1</span>
        <span class="character">BPL .plotLinePostAdjustAddress                      ; if (+ve) then branch</span>
        <span class="character">JSR .moveGraphicsCursorAddressUpOneCharacterCell    ; advance pointers</span>
        <span class="character">BNE .plotLinePostAdjustAddress                      ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotLineWithDominantAxisX</span>
        <span class="character">LSR .vduCurrentPlotByteMask                             ; shift byte mask</span>
        <span class="character">BCC .plotLinePostAdjustAddress                          ; if (carry clear; .vduCurrentPlotByteMask was +ve) branch</span>
        <span class="character">JSR .moveGraphicsCursorAddressTotheRightAndUpdateMask   ; update address and mask</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotLinePostAdjustAddress</span>
        <span class="character">PLP                                                 ; pull flags</span>
        <span class="character">INX                                                 ; X=X+1</span>
        <span class="character">BNE +                                               ; if (X &gt; 0) then branch</span>
        <span class="character">INC .tempStoreDD                                    ; increment .tempStoreDD</span>
        <span class="character">BEQ .plotLineFinished                               ; and if not 0 then branch (finished)</span>
    <span class="character">+</span>
        <span class="character">BIT .tempStoreDB                                    ; check bit 6</span>
        <span class="character">BVS .plotLineContinue                               ; if (bit 6 set) then branch</span>
        <span class="character">BCS .plotLineSkip                                   ; if (bit 7 set) then branch</span>
        <span class="character">DEC .tempStoreDF                                    ; Decrement .tempStoreDF</span>
        <span class="character">BNE .plotLineSkip                                   ; if (not zero) then branch</span>

    <span class="character">.plotLineFinished</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">.plotLineContinue</span>
        <span class="character">LDA .tempStoreDE                                    ; A=.tempStoreDE</span>
        <span class="character">STX .tempStoreDC                                    ; .tempStoreDC=X</span>
        <span class="character">AND #2                                              ; clear all but bit 1</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">BCS ++                                              ; if (carry set) then branch</span>
        <span class="character">BIT .tempStoreDE                                    ; check (bit 7 of .tempStoreDE)</span>
        <span class="character">BMI +                                               ; if (bit 7 set) then branch</span>
        <span class="character">INC .vduWorkspaceE,X                                ; increment</span>
        <span class="character">BNE ++                                              ; if (not zero) then branch</span>
        <span class="character">INC .vduWorkspaceF,X                                ; increment high byte</span>
        <span class="character">BCC ++                                              ; if (carry clear) then branch</span>
    <span class="character">+</span>
        <span class="character">LDA .vduWorkspaceE,X                                ; A=.vduWorkspaceE,X</span>
        <span class="character">BNE +                                               ; and if not 0 D3BF</span>
        <span class="character">DEC .vduWorkspaceF,X                                ; decrement high byte</span>
    <span class="character">+</span>
        <span class="character">DEC .vduWorkspaceE,X                                ; decrement low byte</span>
    <span class="character">++</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">EOR #2                                              ; invert bit 2</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">INC .vduWorkspaceE,X                                ; Increment .vduWorkspaceE/F</span>
        <span class="character">BNE +                                               ;</span>
        <span class="character">INC .vduWorkspaceF,X                                ;</span>
    <span class="character">+</span>
        <span class="character">LDX .tempStoreDC                                    ; X=.tempStoreDC</span>

    <span class="character">.plotLineSkip</span>
        <span class="character">JMP .plotLineLoop                                   ; jump back to continue plotting the line</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">.moveGraphicsCursorAddressUpOneCharacterCell</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">LDA .screenAddressOfGraphicsCursorCellLow           ; }</span>
        <span class="character">SBC .vduBytesPerCharacterRowLow                     ; }</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellLow           ; } subtract number of bytes per line from address</span>
        <span class="character">LDA .screenAddressOfGraphicsCursorCellHigh          ; }</span>
        <span class="character">SBC .vduBytesPerCharacterRowHigh                    ; }</span>
        <span class="character">CMP .vduStartScreenAddressHighByte                  ; compare with bottom of screen memory</span>
        <span class="character">BCS +                                               ; if (inside screen RAM) then branch</span>
        <span class="character">ADC .vduScreenSizeHighByte                          ; add screen memory size to wrap it around</span>
    <span class="character">+</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellHigh          ; store in current address of graphics cell top line</span>
        <span class="character">LDY #7                                              ; Y=7</span>
        <span class="character">RTS                                                 ; and RETURN</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Update the mask value, and move graphics cursor address on to next cell to the right</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       carry always SET</span>
    <span class="character">.moveGraphicsCursorAddressTotheRightAndUpdateMask</span>
        <span class="character">LDA .vduColourMaskLeft                              ; get current left colour mask</span>
        <span class="character">STA .vduCurrentPlotByteMask                         ; store it</span>
        <span class="character">LDA .screenAddressOfGraphicsCursorCellLow           ; }</span>
        <span class="character">ADC #7                                              ; }</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellLow           ; } get current graphics cursor address and</span>
        <span class="character">BCC +                                               ; } add 8 to move to next cell to the right</span>
        <span class="character">INC .screenAddressOfGraphicsCursorCellHigh          ; }</span>
    <span class="character">+</span>
        <span class="character">RTS                                                 ; and return</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Update the mask value, and move graphics cursor address on to previous cell to the left</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       carry always SET</span>
    <span class="character">.moveGraphicsCursorAddressTotheLeftAndUpdateMask</span>
        <span class="character">LDA .vduColourMaskRight                            ; get right colour mask</span>
        <span class="character">STA .vduCurrentPlotByteMask                        ; store it</span>
        <span class="character">LDA .screenAddressOfGraphicsCursorCellLow          ; A=top line graphics cell low</span>
        <span class="character">BNE +                                              ; if (not zero) then branch</span>
        <span class="character">DEC .screenAddressOfGraphicsCursorCellHigh         ; decrement high byte</span>
    <span class="character">+</span>
        <span class="character">SBC #8                                             ; subtract 8 (carry is always SET)</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellLow          ; and store in low byte</span>
        <span class="character">RTS                                                ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Workspace = currentCursor - param</span>
    <span class="character">;</span>
    <span class="character">; Called at the start of the line drawing, this function takes the current graphics cursor</span>
    <span class="character">; position, subtracts the desired graphics cursor position (two 16 bit values on the VDU</span>
    <span class="character">; queue), and stores the result in workspace A/B/C/D.</span>
    <span class="character">.getOffsetFromCurrentGraphicsCursorPosition</span>
        <span class="character">LDY #.vduWorkspaceA - .vduVariablesStart            ; destination: workspace A/B/C/D</span>
        <span class="character">LDX #.vdu25ParameterXLow - .vduVariablesStart       ; source: four parameters on the VDU queue</span>
                                                            <span class="character">; and the four following bytes (graphics cursor position)</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.coordinateSubtraction</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X = source offset into vdu variables</span>
    <span class="character">;   Y = destination offset into vdu variables</span>
    <span class="character">; On Exit:</span>
    <span class="character">;   Destination (4 bytes) stores 16 bit width and height based on the difference of four</span>
    <span class="character">;   16 bit source values (left, bottom, right, top)</span>
    <span class="character">;       width  = right - left</span>
    <span class="character">;       height = top - bottom</span>
    <span class="character">;   A = height (high byte)</span>
        <span class="character">JSR +                                               ;</span>
        <span class="character">INX                                                 ; X=X+2</span>
        <span class="character">INX                                                 ;</span>
        <span class="character">INY                                                 ; Y=Y+2</span>
        <span class="character">INY                                                 ;</span>
    <span class="character">+</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">LDA .vduVariablesStart + 4,X                        ; subtract coordinates</span>
        <span class="character">SBC .vduVariablesStart + 0,X                        ;</span>
        <span class="character">STA .vduVariablesStart + 0,Y                        ;</span>
        <span class="character">LDA .vduVariablesStart + 5,X                        ;</span>
        <span class="character">SBC .vduVariablesStart + 1,X                        ;</span>
        <span class="character">STA .vduVariablesStart + 1,Y                        ;</span>
        <span class="character">RTS                                                 ; and return</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; In the coordinates at .vduWorkspaceABCD:</span>
    <span class="character">;</span>
    <span class="character">;   1. Make sure the dominant axis is stored first, by swapping X and Y values if needed.</span>
    <span class="character">;   2. Both coordinates are then made positive and stored in .vduWorkspacePQRS.</span>
    <span class="character">;   3. .tempStoreDC/DD stores the negative of the number of steps to take (along the dominant axis).</span>
    <span class="character">;   4. .vduWorkspaceNO stores half this value.</span>
    <span class="character">;</span>
    <span class="character">.plotLineMoreCalculations</span>
        <span class="character">LDA .tempStoreDE                                    ; get the dominant axis (0 or 2)</span>
        <span class="character">BNE +                                               ; if (Y axis is dominant) then branch</span>
        <span class="character">LDX #.vduWorkspaceA - .vduVariablesStart            ; X is workspace A</span>
        <span class="character">LDY #.vduWorkspaceC - .vduVariablesStart            ; Y is workspace C</span>
        <span class="character">JSR .swapTwoVDUVariables                            ; exchange the X and Y variables. So the dominant axis is now the first coordinate.</span>
    <span class="character">+</span>
        <span class="character">LDX #.vduWorkspaceA - .vduVariablesStart            ;      Source: .workspaceABCD (the start coordinates)</span>
        <span class="character">LDY #.vduWorkspaceP - .vduVariablesStart            ; Destination: .workspacePQRS (working coordinates)</span>
        <span class="character">JSR .copyFourBytesWithinVDUVariables                ; copy four bytes</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">LDX .tempStoreDE                                    ; get the dominant axis (0 or 2)</span>
        <span class="character">LDA .vduPlotLineTerminationValueLow                 ; }</span>
        <span class="character">SBC .vduWorkspaceE,X                                ; }     AY = .vduPlotLineTerminationValue - .vduWorkspaceEF (or GH)</span>
        <span class="character">TAY                                                 ; } ie. AY = finalPoint - start point (in dominant axis)</span>
        <span class="character">LDA .vduPlotLineTerminationValueHigh                ; }</span>
        <span class="character">SBC .vduWorkspaceF,X                                ; }</span>
        <span class="character">BMI +                                               ; if (startPoint &gt; finalPoint) then branch</span>
        <span class="character">JSR .negateAY                                       ; negate value stored in A and Y</span>
    <span class="character">+</span>
        <span class="character">STA .tempStoreDD                                    ; store high byte of negative value     } this is the -ve of the number of steps we</span>
        <span class="character">STY .tempStoreDC                                    ; store low byte of negative value      } need to take when plotting the line.</span>
        <span class="character">LDX #.vduWorkspaceN - .vduVariablesStart            ;</span>
    <span class="character">.lineCalculations</span>
        <span class="character">JSR .ensurePositive                                 ; make .vduWorkspaceRS positive</span>
        <span class="character">LSR                                                 ; }</span>
        <span class="character">STA .vduVariablesStart + 1,X                        ; }</span>
        <span class="character">TYA                                                 ; } .vduWorkspaceNO = .vduWorkspaceRS / 2</span>
        <span class="character">ROR                                                 ; }</span>
        <span class="character">STA .vduVariablesStart,X                            ; }</span>
        <span class="character">DEX                                                 ; Point to .vduWorkspaceLM</span>
        <span class="character">DEX                                                 ; and fall through to make .vduWorkspacePQ positive</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Make sure that the 16 bit coordinate at (vduVariablesStart + 4 + X)</span>
    <span class="character">; is positive by negating it if necessary.</span>
    <span class="character">; On entry:</span>
    <span class="character">;       X is offset to vdu variable i.e.:</span>
    <span class="character">;       (vduVariablesStart + 4 + X) has the low byte of the coordinate</span>
    <span class="character">;       (vduVariablesStart + 5 + X) has the high byte of the coordinate</span>
    <span class="character">; On Exit:</span>
    <span class="character">;       A is the high byte of the result (also stored in .vduVariablesStart + 5 + X)</span>
    <span class="character">;       Y is the low byte of the result  (also stored in .vduVariablesStart + 4 + X)</span>
    <span class="character">.ensurePositive</span>
        <span class="character">LDY .vduVariablesStart + 4,X                        ;</span>
        <span class="character">LDA .vduVariablesStart + 5,X                        ;</span>
        <span class="character">BPL +                                               ; if (A is +ve) then branch (return)</span>
        <span class="character">JSR .negateAY                                       ; negate Y/A</span>
        <span class="character">STA .vduVariablesStart + 5,X                        ; store back again</span>
        <span class="character">PHA                                                 ;</span>
        <span class="character">TYA                                                 ;</span>
        <span class="character">STA .vduVariablesStart + 4,X                        ;</span>
        <span class="character">PLA                                                 ; get back A</span>
    <span class="character">+</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.copy8BytesWithinVDUVariables</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X = source (offset from .vduVariablesStart)</span>
    <span class="character">;   Y = destination (offset from .vduVariablesStart)</span>
        <span class="character">LDA #8                                              ; A = 8</span>
        <span class="character">BNE .copyABytesWithinVDUVariables                   ; ALWAYS branch - copy 8 bytes</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.copy2BytesWithinVDUVariablesToTerminationValue</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X = source (offset from .vduVariablesStart)</span>
        <span class="character">LDY #.vduPlotLineTerminationValueLow - .vduVariablesStart ; Y = destination offset from .vduVariablesStart</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.copy2BytesWithinVDUVariables</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X = source (offset from .vduVariablesStart)</span>
    <span class="character">;   Y = destination (offset from .vduVariablesStart)</span>
        <span class="character">LDA #2                                              ; A = 2</span>
        <span class="character">BNE .copyABytesWithinVDUVariables                   ; ALWAYS branch - copy 2 bytes</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.copyGraphicsCursorPixelPositionToWorkspaceABCD</span>
        <span class="character">LDY #.vduWorkspaceA - .vduVariablesStart            ; Y = offset to workspaceA</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.copyGraphicsCursorPixelPosition</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   Y = destination (offset from .vduVariablesStart)</span>
        <span class="character">LDX #.vduGraphicsCursorPixelsXLow  - .vduVariablesStart     ; X = offset to graphics cursor position</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.copyFourBytesWithinVDUVariables</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X = source (offset from .vduVariablesStart)</span>
    <span class="character">;   Y = destination (offset from .vduVariablesStart)</span>
        <span class="character">LDA #4                                              ; Number of bytes to copy</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.copyABytesWithinVDUVariables</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       A = number of bytes to copy</span>
    <span class="character">;       X = source (offset from .vduVariablesStart)</span>
    <span class="character">;       Y = destination (offset from .vduVariablesStart)</span>
        <span class="character">STA .tempStoreDA                                    ; Store A as a loop counter</span>
    <span class="character">-</span>
        <span class="character">LDA .vduVariablesStart,X                            ; Load value from source address</span>
        <span class="character">STA .vduVariablesStart,Y                            ; Store value in destination address</span>
        <span class="character">INX                                                 ; Move index forwards</span>
        <span class="character">INY                                                 ; Move index forwards</span>
        <span class="character">DEC .tempStoreDA                                    ; Decrement loop counter</span>
        <span class="character">BNE -                                               ; Loop back until done</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Negate the sixteen bit value in A and Y</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       A = high byte</span>
    <span class="character">;       Y = low byte</span>
    <span class="character">; On Exit:</span>
    <span class="character">;       A = high byte of negated value</span>
    <span class="character">;       Y = low byte of negated value</span>
    <span class="character">;       Preserves X</span>
    <span class="character">.negateAY</span>
        <span class="character">PHA                                                 ; save A</span>
        <span class="character">TYA                                                 ;</span>
        <span class="character">EOR #$FF                                            ;</span>
        <span class="character">TAY                                                 ; Y=255 - Y</span>
        <span class="character">PLA                                                 ; restore A</span>
        <span class="character">EOR #$FF                                            ; A=255 - A</span>
        <span class="character">INY                                                 ; Y=Y+1 (effectively making Y = 256 - initialY)</span>
        <span class="character">BNE +                                               ; if (Y != 0) then exit</span>
        <span class="character">CLC                                                 ;</span>
        <span class="character">ADC #1                                              ; A+=1</span>
    <span class="character">+</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.checkPixel</span>
        <span class="character">JSR .checkParameterInBoundsAndSetScreenAddresses    ; check window boundaries and set up screen addresses</span>
        <span class="character">BNE .outsideBoundaries                              ; if (outside) then branch</span>
        <span class="character">LDA (.screenAddressOfGraphicsCursorCellLow),Y       ; get byte from current graphics cell</span>
        <span class="character">EOR .vduBackgroundGraphicsColour                    ; compare with current background colour</span>
        <span class="character">STA .tempStoreDA                                    ; store it</span>
        <span class="character">RTS                                                 ; and RETURN</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.outsideBoundaries</span>
        <span class="character">PLA                                                 ; get back return link</span>
        <span class="character">PLA                                                 ;</span>
    <span class="character">-</span>
        <span class="character">INC .vduGraphicsCursorPixelsYLow                    ; increment current graphics cursor y pixel position</span>
        <span class="character">JMP .setNextPixelPosition                           ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.lateralFillLeftRight</span>
        <span class="character">JSR .checkPixel                                     ; check current screen state</span>
        <span class="character">AND .vduCurrentPlotByteMask                         ; check '</span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">vduCurrentPlotByteMask</span><span class="character">'</span>
        <span class="character">BNE -                                               ; if (a plotted point has been found) then branch</span>
        <span class="character">LDX #0                                              ; X=0</span>
        <span class="character">JSR .lateralFillRoutine1                            ; update pointers</span>
        <span class="character">BEQ .lateralFillRoutine2                            ; if (zero) then branch</span>
        <span class="character">LDY .vduGraphicsCursorVerticalOffsetInCell          ; Y=graphics scan line</span>
        <span class="character">ASL .vduCurrentPlotByteMask                         ;</span>
        <span class="character">BCS .lateralFillLoop                                ; if (carry set) then branch</span>
        <span class="character">JSR .lateralFillRoutine3                            ;</span>
        <span class="character">BCC .lateralFillRoutine2                            ; if (carry clear) then branch</span>

    <span class="character">.lateralFillLoop</span>
        <span class="character">JSR .moveGraphicsCursorAddressTotheLeftAndUpdateMask   ; call subroutine to move cursor address on and reset mask</span>
        <span class="character">LDA (.screenAddressOfGraphicsCursorCellLow),Y       ; get graphics cell line</span>
        <span class="character">EOR .vduBackgroundGraphicsColour                    ; EOR with background colour</span>
        <span class="character">STA .tempStoreDA                                    ; and store</span>
        <span class="character">BNE .lateralFillRoutine4                            ; if (not zero) then branch</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">ADC .pixelsPerByteMinusOneForCurrentMode            ; add pixels/byte</span>
        <span class="character">BCC +                                               ; and if carry clear then branch</span>
        <span class="character">INC .tempStoreDB                                    ; increment .tempStoreDB</span>
        <span class="character">BPL .lateralFillRoutine4                            ; if (+ve) then branch</span>
    <span class="character">+</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">JSR .lateralFillPlotPoint                           ; display a pixel</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">BCS .lateralFillLoop                                ; ALWAYs branch (loop back)</span>

    <span class="character">.lateralFillRoutine4</span>
        <span class="character">JSR .lateralFillRoutine3                            ;</span>

    <span class="character">.lateralFillRoutine2</span>
        <span class="character">LDY #0                                              ; Y=0</span>
        <span class="character">JSR .lateralFillRoutineA                            ;</span>
        <span class="character">LDY #$20                                            ;</span>
        <span class="character">LDX #.vduGraphicsCursorPixelsXLow - .vduVariablesStart  ;</span>
        <span class="character">JSR .exchangeFourVariables                          ; exchange 300/3 +Y with 300/3+X</span>

    <span class="character">.lateralFillRight</span>
        <span class="character">JSR .checkPixel                                     ; check screen pixel</span>
        <span class="character">LDX #4                                              ;</span>
        <span class="character">JSR .lateralFillRoutine1                            ;</span>
        <span class="character">TXA                                                 ; A=x</span>
        <span class="character">BNE +                                               ; if (A is not zero) then branch</span>
        <span class="character">DEC .tempStoreDB                                    ; .tempStoreDB--</span>
    <span class="character">+</span>
        <span class="character">DEX                                                 ; X=X-1</span>

    <span class="character">.lateralFillLoop2</span>
        <span class="character">JSR .lateralFillRoutine5                            ;</span>
        <span class="character">BCC .lateralFillRoutine6                            ;</span>

    <span class="character">.lateralFillLoop3</span>
        <span class="character">JSR .moveGraphicsCursorAddressTotheRightAndUpdateMask  ; update pointers</span>
        <span class="character">LDA (.screenAddressOfGraphicsCursorCellLow),Y       ; get byte from graphics line</span>
        <span class="character">EOR .vduBackgroundGraphicsColour                    ; EOR with background colour</span>
        <span class="character">STA .tempStoreDA                                    ; and store it</span>
        <span class="character">LDA .tempStoreDC                                    ;</span>
        <span class="character">BNE .lateralFillLoop2                               ; if (A is not zero) then branch (loop back)</span>
        <span class="character">LDA .tempStoreDA                                    ; A=.tempStoreDA</span>
        <span class="character">BNE .skipAdditions                                  ; if (A is not zero) then branch</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">TXA                                                 ; A=x</span>
        <span class="character">ADC .pixelsPerByteMinusOneForCurrentMode            ; Add number of pixels/byte</span>
        <span class="character">BCC +                                               ; and if carry clear D536</span>
        <span class="character">INC .tempStoreDB                                    ; inc DB</span>
        <span class="character">BPL .skipAdditions                                  ; and if +ve then branch</span>
    <span class="character">+</span>
        <span class="character">TAX                                                 ; get back X</span>
        <span class="character">JSR .lateralFillPlotPoint                           ; display a point</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">BCS .lateralFillLoop3                               ; ALWAYs branch (loop back)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.skipAdditions</span>
        <span class="character">JSR .lateralFillRoutine5                            ;</span>

    <span class="character">.lateralFillRoutine6</span>
        <span class="character">LDY #4                                              ;</span>
        <span class="character">JSR .lateralFillRoutineA                            ;</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.setNextPixelPosition</span>
        <span class="character">JSR .plotMoveAbsolute                               ;</span>
        <span class="character">JMP .convertInternalGraphicsCoordinatesToExternal   ; scale pointers</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.lateralFillRoutine5</span>
        <span class="character">LDA .vduCurrentPlotByteMask                         ; get byte mask</span>
        <span class="character">PHA                                                 ; save it</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">BCC .lateralFillRoutine7                            ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.lateralFillRoutine8</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">INX                                                 ; X=X+1</span>
        <span class="character">BNE +                                               ; if (not zero) then branch</span>
        <span class="character">INC .tempStoreDB                                    ;</span>
        <span class="character">BPL .lateralFillRoutine9                            ; if (+ve) then branch</span>

    <span class="character">+</span>
        <span class="character">LSR .vduCurrentPlotByteMask                         ; shift mask</span>
        <span class="character">BCS .lateralFillRoutine9                            ; if (carry set) then branch</span>
        <span class="character">ORA .vduCurrentPlotByteMask                         ; OR with mask</span>
        <span class="character">PHA                                                 ; save result</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.lateralFillRoutine7</span>
        <span class="character">LDA .vduCurrentPlotByteMask                         ; A=.vduCurrentPlotByteMask</span>
        <span class="character">BIT .tempStoreDA                                    ; test bits 6 and 7 of .tempStoreDA</span>
        <span class="character">PHP                                                 ; save flags</span>
        <span class="character">PLA                                                 ; get into A</span>
        <span class="character">EOR .tempStoreDC                                    ; EOR</span>
        <span class="character">PHA                                                 ; save A</span>
        <span class="character">PLP                                                 ;</span>
        <span class="character">BEQ .lateralFillRoutine8                            ;</span>
        <span class="character">PLA                                                 ; A=A EOR .vduCurrentPlotByteMask (byte mask)</span>
        <span class="character">EOR .vduCurrentPlotByteMask                         ;</span>

    <span class="character">.lateralFillRoutine9</span>
        <span class="character">STA .vduCurrentPlotByteMask                         ; store it</span>
        <span class="character">JMP .plotPointWithinBounds                          ; and display a pixel</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.lateralFillRoutine3</span>
        <span class="character">LDA #0                                              ; A=0</span>
        <span class="character">CLC                                                 ; Clear carry</span>
        <span class="character">BCC .lateralFillRoutine10                           ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.lateralFillRoutine11</span>
        <span class="character">INX                                                 ; X=X+1</span>
        <span class="character">BNE +                                               ; if (X is not zero) then branch</span>
        <span class="character">INC .tempStoreDB                                    ; inc .tempStoreDB</span>
        <span class="character">BPL .lateralFillRoutine9                            ; and if +ve then branch</span>
    <span class="character">+</span>
        <span class="character">ASL                                                 ; A=A*2</span>
        <span class="character">BCS .lateralFillRoutine12                           ; if (C set) then branch</span>

    <span class="character">.lateralFillRoutine10</span>
        <span class="character">ORA .vduCurrentPlotByteMask                         ; A=A OR (.vduCurrentPlotByteMask)</span>
        <span class="character">BIT .tempStoreDA                                    ; set V and M from .tempStoreDA b6 b7</span>
        <span class="character">BEQ .lateralFillRoutine11                           ;</span>
        <span class="character">EOR .vduCurrentPlotByteMask                         ; A=A EOR .vduCurrentPlotByteMask</span>
        <span class="character">LSR                                                 ; /2</span>
        <span class="character">BCC .lateralFillRoutine9                            ; if (carry clear) then branch</span>

    <span class="character">.lateralFillRoutine12</span>
        <span class="character">ROR                                                 ; *2</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">BCS .lateralFillRoutine9                            ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.lateralFillRoutine1</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftLow,X               ; }</span>
        <span class="character">SEC                                                 ; }</span>
        <span class="character">SBC .vdu25ParameterXLow                             ; }</span>
        <span class="character">TAY                                                 ; } AY = window left - paramX</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftHigh,X              ; }</span>
        <span class="character">SBC .vdu25ParameterXHigh                            ; }</span>
        <span class="character">BMI +                                               ; if (negative) then branch</span>
        <span class="character">JSR .negateAY                                       ; or negate Y/A</span>
    <span class="character">+</span>
        <span class="character">STA .tempStoreDB                                    ; store A (high coordinate)</span>
        <span class="character">TYA                                                 ; A = low coordinate</span>
        <span class="character">TAX                                                 ; X = low coordinate</span>
        <span class="character">ORA .tempStoreDB                                    ; A = low OR high coordinate</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.lateralFillRoutineA</span>
        <span class="character">STY .tempStoreDA                                    ; Y=.tempStoreDA</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">TAY                                                 ; Y=A</span>
        <span class="character">LDA .tempStoreDB                                    ; A=.tempStoreDB</span>
        <span class="character">BMI +                                               ; if (-ve) then branch</span>
        <span class="character">LDA #0                                              ; A=0</span>
    <span class="character">+</span>
        <span class="character">LDX .tempStoreDA                                    ; X=.tempStoreDA</span>
        <span class="character">BNE +                                               ; if (X is not zero) then branch</span>
        <span class="character">JSR .negateAY                                       ; negate</span>
    <span class="character">+</span>
        <span class="character">PHA                                                 ; }</span>
        <span class="character">CLC                                                 ; }</span>
        <span class="character">TYA                                                 ; }</span>
        <span class="character">ADC .vduGraphicsWindowPixelsLeftLow,X               ; } paramX = AY + window left</span>
        <span class="character">STA .vdu25ParameterXLow                             ; }</span>
        <span class="character">PLA                                                 ; }</span>
        <span class="character">ADC .vduGraphicsWindowPixelsLeftHigh,X              ; }</span>
        <span class="character">STA .vdu25ParameterXHigh                            ; }</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSWORD 13 - read last two graphic cursor positions</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osword13EntryPoint</span>
        <span class="character">LDA #3                                              ; A=3 (offset into oswordX block)</span>
        <span class="character">JSR +                                               ;</span>
        <span class="character">LDA #7                                              ; A=7 (offset into oswordX block)</span>
    <span class="character">+</span>
        <span class="character">PHA                                                 ; Save A</span>
        <span class="character">JSR .swapGraphicsCursorWithOldPosition              ; exchange old graphics cursor position with current</span>
        <span class="character">JSR .convertInternalGraphicsCoordinatesToExternal   ; convert to external coordinates</span>
        <span class="character">LDX #3                                              ; X=3</span>
        <span class="character">PLA                                                 ; save A</span>
        <span class="character">TAY                                                 ; Y=A</span>
    <span class="character">-</span>
        <span class="character">LDA .vduGraphicsCursorPositionXLow,X                ; get graphics coordinate</span>
        <span class="character">STA (.oswordX),Y                                    ; store it in OS buffer</span>
        <span class="character">DEY                                                 ; decrement Y and X</span>
        <span class="character">DEX                                                 ;</span>
        <span class="character">BPL -                                               ; if (+ve) then branch (loop back)</span>
        <span class="character">RTS                                                 ; then Exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">.plotFillTriangle</span>
        <span class="character">LDX #.vdu25ParameterXLow - .vduVariablesStart       ; X=$20</span>
        <span class="character">LDY #$3E                                            ; Y=$3E</span>
        <span class="character">JSR .copy8BytesWithinVDUVariables                   ; copy 300/7+X to 300/7+Y</span>
                                                            <span class="character">; this gets XY data parameters and current graphics cursor position</span>
        <span class="character">JSR .sortPlotPositionAndOldPosition                 ; exchange 320/3 with 324/7 if 316/7=&lt;322/3</span>
        <span class="character">LDX #.vduOldGraphicsCursorPixelsXLow - .vduVariablesStart  ;</span>
        <span class="character">LDY #.vduGraphicsCursorPixelsXLow - .vduVariablesStart     ;</span>
        <span class="character">JSR .sortCoordinatesXY                              ;</span>
        <span class="character">JSR .sortPlotPositionAndOldPosition                 ;</span>

        <span class="character">LDX #.vdu25ParameterXLow - .vduVariablesStart       ;</span>
        <span class="character">LDY #$2A                                            ;</span>
        <span class="character">JSR .coordinateSubtraction                          ; calculate .vduWorkspaceC/D-(324/5-320/1)</span>
        <span class="character">LDA .vduWorkspaceD                                  ; and store</span>
        <span class="character">STA .vduRoutineLow                                  ; result</span>

        <span class="character">LDX #$28                                            ; set pointers</span>
        <span class="character">JSR .lineCalculations                               ;</span>
        <span class="character">LDY #$2E                                            ;</span>

        <span class="character">JSR .copyPositionToGraphicsCursorPixelPosition      ; copy 320/3 32/31</span>
        <span class="character">JSR .swapGraphicsCursorWithOldPosition              ; exchange 314/7 with 324/7</span>
        <span class="character">CLC                                                 ;</span>
        <span class="character">JSR .fillTriangleContinues                          ; execute fill routine</span>

        <span class="character">JSR .swapGraphicsCursorWithOldPosition              ;</span>
        <span class="character">LDX #.vdu25ParameterXLow - .vduVariablesStart       ;</span>
        <span class="character">JSR .swapGraphicsCursorPositionWithVariableX        ;</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">JSR .fillTriangleContinues                          ;</span>

        <span class="character">LDX #$3E                                            ; X=$3E</span>
        <span class="character">LDY #.vdu25ParameterXLow - .vduVariablesStart       ; Y=$20</span>
        <span class="character">JSR .copy8BytesWithinVDUVariables                   ; copy 300/7+X to 300/7+Y</span>
        <span class="character">JMP .plotMoveAbsolute                               ; this gets XY data parameters and current graphics cursor position</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">.sortPlotPositionAndOldPosition</span>
        <span class="character">LDX #.vdu25ParameterXLow - .vduVariablesStart               ; }</span>
        <span class="character">LDY #.vduOldGraphicsCursorPixelsXLow - .vduVariablesStart   ; } Sort paramX and old graphics position X</span>
        <span class="character">; fall through...</span>

    <span class="character">; given two pairs of coordinates (one indexed by register X the other by register Y), sort them by their Y coordinates (lowest first)</span>
    <span class="character">.sortCoordinatesXY</span>
        <span class="character">LDA .vduVariablesStart + 2,X                        ; Y coordinate low byte</span>
        <span class="character">CMP .vduVariablesStart + 2,Y                        ; Y coordinate low byte</span>
        <span class="character">LDA .vduVariablesStart + 3,X                        ; Y coordinate high byte</span>
        <span class="character">SBC .vduVariablesStart + 3,Y                        ; Y coordinate high byte</span>
        <span class="character">BMI .exit10                                         ; if (Y coordinate of variable indexed by Y &gt; Y coordinate of variable indexed by X) then branch (return)</span>
        <span class="character">JMP .exchangeFourVariables                          ; swap coordinates</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSBYTE 134 - read text cursor position</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osbyte134EntryPoint</span>
        <span class="character">LDA .vduTextCursorXPosition                         ; read current text cursor X position</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">SBC .vduTextWindowLeft                              ; subtract text window left position</span>
        <span class="character">TAX                                                 ; X = text cursor X - text window left</span>
        <span class="character">LDA .vduTextCursorYPosition                         ; get current text cursor Y position</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">SBC .vduTextWindowTop                               ; subtract text window top position</span>
        <span class="character">TAY                                                 ; Y = text cursor Y - text window top</span>
    <span class="character">.exit10</span>
        <span class="character">RTS                                                 ; and exit</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; FILL TRIANGLE routines continue</span>
    <span class="character">.fillTriangleContinues</span>
        <span class="character">PHP                                                 ; store flags</span>
        <span class="character">LDX #.vdu25ParameterXLow - .vduVariablesStart       ;</span>
        <span class="character">LDY #.vduWorkspaceN - .vduVariablesStart            ;</span>
        <span class="character">JSR .coordinateSubtraction                          ; 335/6=(324/5+X-320/1)</span>
        <span class="character">LDA .vduWorkspaceO                                  ;</span>
        <span class="character">STA .vduWorkspaceV                                  ;</span>
        <span class="character">LDX #$33                                            ;</span>
        <span class="character">JSR .lineCalculations                               ; set pointers</span>

        <span class="character">LDY #$39                                            ; set 339/C=320/3</span>
        <span class="character">JSR .copyPositionToGraphicsCursorPixelPosition      ;</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">LDA .vdu25ParameterYLow                             ;</span>
        <span class="character">SBC .vduGraphicsCursorPixelsYLow                    ;</span>
        <span class="character">STA .vduQueueWorkspaceA                             ;</span>
        <span class="character">LDA .vdu25ParameterYHigh                            ;</span>
        <span class="character">SBC .vduGraphicsCursorPixelsYHigh                   ;</span>
        <span class="character">STA .vduQueueWorkspaceB                             ;</span>
        <span class="character">ORA .vduQueueWorkspaceA                             ; check VDU queue</span>
        <span class="character">BEQ +                                               ;</span>
    <span class="character">-</span>
        <span class="character">JSR .setVDUVariables                                ; display a line</span>
        <span class="character">LDX #$33                                            ;</span>
        <span class="character">JSR .updatePointers                                 ; update pointers</span>
        <span class="character">LDX #$28                                            ;</span>
        <span class="character">JSR .updatePointers                                 ; and again!</span>
        <span class="character">INC .vduQueueWorkspaceA                             ; update VDU queue</span>
        <span class="character">BNE -                                               ; and if not empty do it again</span>
        <span class="character">INC .vduQueueWorkspaceB                             ; increment next byte</span>
        <span class="character">BNE -                                               ; and do it again</span>
    <span class="character">+</span>
        <span class="character">PLP                                                 ; pull flags</span>
        <span class="character">BCC .exit10                                         ; if (carry clear) then branch (exit)</span>

    <span class="character">.setVDUVariables</span>
        <span class="character">LDX #$39                                            ;</span>
        <span class="character">LDY #$2E                                            ;</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Fills a single row</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X = offset into VDU variables for right graphics pixel X coordinate</span>
    <span class="character">;   Y = offset into VDU variables for left graphics pixel X coordinate</span>
    <span class="character">.fillRow</span>
        <span class="character">STX .tempStoreDE                                    ;</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftLow,X               ; }</span>
        <span class="character">CMP .vduGraphicsWindowPixelsLeftLow,Y               ; }</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftHigh,X              ; } if (300/1+X &lt; 300/1+Y) then branch</span>
        <span class="character">SBC .vduGraphicsWindowPixelsLeftHigh,Y              ; }</span>
        <span class="character">BMI +                                               ; }</span>
        <span class="character">TYA                                                 ; A=Y</span>
        <span class="character">LDY .tempStoreDE                                    ; Y=.tempStoreDE</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">STX .tempStoreDE                                    ; .tempStoreDE=X</span>
    <span class="character">+</span>
        <span class="character">STY .tempStoreDF                                    ; .tempStoreDF=Y</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftLow,Y               ;</span>
        <span class="character">PHA                                                 ;</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftHigh,Y              ;</span>
        <span class="character">PHA                                                 ;</span>
        <span class="character">LDX .tempStoreDF                                    ;</span>
        <span class="character">JSR .checkVariableXIsWithinGraphicsWindow           ; check window bounds</span>
        <span class="character">BEQ +                                               ;</span>
        <span class="character">CMP #2                                              ;</span>
        <span class="character">BNE .postPlotPoint                                  ;</span>
        <span class="character">LDX #4                                              ;</span>
        <span class="character">LDY .tempStoreDF                                    ;</span>
        <span class="character">JSR .copy2BytesWithinVDUVariables                   ;</span>
        <span class="character">LDX .tempStoreDF                                    ;</span>
    <span class="character">+</span>
        <span class="character">JSR .setScreenAddress                               ; set a screen address</span>
        <span class="character">LDX .tempStoreDE                                    ; X=.tempStoreDE</span>
        <span class="character">JSR .checkVariableXIsWithinGraphicsWindow           ; check window bounds</span>
        <span class="character">LSR                                                 ; A=A/2</span>
        <span class="character">BNE .postPlotPoint                                  ; if (A is not zero) then branch (exit)</span>
        <span class="character">BCC +                                               ; if (C clear) then branch</span>
        <span class="character">LDX #0                                              ;</span>
    <span class="character">+</span>
        <span class="character">LDY .tempStoreDF                                    ;</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftLow,Y               ;</span>
        <span class="character">SBC .vduGraphicsWindowPixelsLeftLow,X               ;</span>
        <span class="character">STA .tempStoreDC                                    ;</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftHigh,Y              ;</span>
        <span class="character">SBC .vduGraphicsWindowPixelsLeftHigh,X              ;</span>
        <span class="character">STA .tempStoreDD                                    ;</span>
        <span class="character">LDA #0                                              ;</span>

    <span class="character">-</span>
        <span class="character">ASL                                                 ;</span>
        <span class="character">ORA .vduCurrentPlotByteMask                         ;</span>
        <span class="character">LDY .tempStoreDC                                    ;</span>
        <span class="character">BNE .nextPart                                       ;</span>
        <span class="character">DEC .tempStoreDD                                    ;</span>
        <span class="character">BPL .nextPart                                       ;</span>
        <span class="character">STA .vduCurrentPlotByteMask                         ;</span>
        <span class="character">JSR .plotPointWithinBounds                          ; display a point</span>

    <span class="character">.postPlotPoint</span>
        <span class="character">LDX .tempStoreDF                                    ; restore X</span>
        <span class="character">PLA                                                 ; and A</span>
        <span class="character">STA .vduGraphicsWindowPixelsLeftHigh,X              ; store it</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">STA .vduGraphicsWindowPixelsLeftLow,X               ; and store it</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.nextPart</span>
        <span class="character">DEC .tempStoreDC                                    ;</span>
        <span class="character">TAX                                                 ;</span>
        <span class="character">BPL -                                               ;</span>
        <span class="character">STA .vduCurrentPlotByteMask                         ;</span>
        <span class="character">JSR .plotPointWithinBounds                          ; display a point</span>
        <span class="character">LDX .tempStoreDC                                    ;</span>
        <span class="character">INX                                                 ;</span>
        <span class="character">BNE +                                               ;</span>
        <span class="character">INC .tempStoreDD                                    ;</span>
    <span class="character">+</span>
        <span class="character">TXA                                                 ;</span>
        <span class="character">PHA                                                 ;</span>
        <span class="character">LSR .tempStoreDD                                    ;</span>
        <span class="character">ROR                                                 ;</span>
        <span class="character">LDY .pixelsPerByteMinusOneForCurrentMode            ; number of pixels/byte</span>
        <span class="character">CPY #3                                              ; check for four colour modes</span>
        <span class="character">BEQ +                                               ; if (four colour mode) then branch</span>
        <span class="character">BCC .mode2Version                                   ; if (&gt;four colour mode, i.e. MODE 2) then branch</span>
        <span class="character">LSR .tempStoreDD                                    ; rotate bottom bit of .tempStoreDD</span>
        <span class="character">ROR                                                 ; into accumulator</span>

    <span class="character">+</span>
        <span class="character">LSR .tempStoreDD                                    ; rotate bottom bit of .tempStoreDD</span>
        <span class="character">LSR                                                 ; into accumulator</span>

    <span class="character">.mode2Version</span>
        <span class="character">LDY .vduGraphicsCursorVerticalOffsetInCell          ; Y=line in current graphics cell containing current point</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">BEQ .nextByte                                       ;</span>

    <span class="character">.loopPlotPixel</span>
        <span class="character">TYA                                                 ; }</span>
        <span class="character">SEC                                                 ; }</span>
        <span class="character">SBC #8                                              ; } Y=Y-8</span>
        <span class="character">TAY                                                 ; }</span>

        <span class="character">BCS +                                               ;</span>
        <span class="character">DEC .screenAddressOfGraphicsCursorCellHigh          ; decrement byte of top line off current graphics cell</span>
    <span class="character">+</span>
        <span class="character">JSR .lateralFillPlotPoint                           ; display a point</span>
        <span class="character">DEX                                                 ;</span>
        <span class="character">BNE .loopPlotPixel                                  ;</span>

    <span class="character">.nextByte</span>
        <span class="character">PLA                                                 ;</span>
        <span class="character">AND .pixelsPerByteMinusOneForCurrentMode            ; pixels/byte</span>
        <span class="character">BEQ .postPlotPoint                                  ;</span>
        <span class="character">TAX                                                 ;</span>
        <span class="character">LDA #0                                              ; A=0</span>

    <span class="character">-</span>
        <span class="character">ASL                                                 ;</span>
        <span class="character">ORA .vduColourMaskRight                             ; or with right colour mask</span>
        <span class="character">DEX                                                 ;</span>
        <span class="character">BNE -                                               ;</span>

        <span class="character">STA .vduCurrentPlotByteMask                         ; store as byte mask</span>
        <span class="character">TYA                                                 ; Y=Y-8</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">SBC #8                                              ;</span>
        <span class="character">TAY                                                 ;</span>
        <span class="character">BCS +                                               ; if (carry clear) then branch</span>
        <span class="character">DEC .screenAddressOfGraphicsCursorCellHigh          ; decrement byte of top line off current graphics cell</span>
    <span class="character">+</span>
        <span class="character">JSR .plotPointWithinBoundsAtY                       ; display a point</span>
        <span class="character">JMP .postPlotPoint                                  ; jump to next point</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.updatePointers</span>
        <span class="character">INC .vduVariablesStart + 8,X                        ; }</span>
        <span class="character">BNE +                                               ; } eightnine++</span>
        <span class="character">INC .vduVariablesStart + 9,X                        ; }</span>
    <span class="character">+</span>
        <span class="character">SEC                                                 ; }</span>
        <span class="character">LDA .vduVariablesStart,X                            ; }</span>
        <span class="character">SBC .vduVariablesStart + 2,X                        ; }</span>
        <span class="character">STA .vduVariablesStart,X                            ; } zeroOne = zeroOne - twoThree</span>
        <span class="character">LDA .vduVariablesStart + 1,X                        ; }</span>
        <span class="character">SBC .vduVariablesStart + 3,X                        ; }</span>
        <span class="character">STA .vduVariablesStart + 1,X                        ; }</span>
        <span class="character">BPL .exit11                                         ;</span>
    <span class="character">-</span>
        <span class="character">LDA .vduVariablesStart + 10,X                       ;</span>
        <span class="character">BMI .forward1                                       ; if (ten &gt;= 128) then branch</span>
        <span class="character">INC .vduVariablesStart + 6,X                        ; }</span>
        <span class="character">BNE .forward2                                       ; } sixseven++</span>
        <span class="character">INC .vduVariablesStart + 7,X                        ; }</span>
        <span class="character">JMP .forward2                                       ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.forward1</span>
        <span class="character">LDA .vduVariablesStart + 6,X                        ; }</span>
        <span class="character">BNE +                                               ; }</span>
        <span class="character">DEC .vduVariablesStart + 7,X                        ; } sixseven--</span>
    <span class="character">+</span>
        <span class="character">DEC .vduVariablesStart + 6,X                        ; }</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.forward2</span>
        <span class="character">CLC                                                 ; }</span>
        <span class="character">LDA .vduVariablesStart,X                            ; }</span>
        <span class="character">ADC .vduVariablesStart+4,X                          ; }</span>
        <span class="character">STA .vduVariablesStart,X                            ; } zeroOne += fourFive</span>
        <span class="character">LDA .vduVariablesStart+1,X                          ; }</span>
        <span class="character">ADC .vduVariablesStart+5,X                          ; }</span>
        <span class="character">STA .vduVariablesStart+1,X                          ; }</span>
        <span class="character">BMI -                                               ;</span>
    <span class="character">.exit11</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
</pre>

<p class="inwebparagraph">Chapter 6
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 6: </span><span class="identifier">COPY</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">editing</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 135 - </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">position</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte135EntryPoint</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduNumberOfLogicalColoursMinusOne</span><span class="plain">              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">logical</span><span class="plain"> </span><span class="identifier">colours</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">nonMode7ReadCharacter</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> 7) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> 7 </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">screen</span>
        <span class="identifier">LDY</span><span class="plain"> #2                                              ; </span><span class="identifier">Y</span><span class="plain">=2</span>
    <span class="plain">-</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">teletextCharacterConversionTable</span><span class="plain"> + 1,</span><span class="identifier">Y</span><span class="plain">         ; </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">equal</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">teletextCharacterConversionTable</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1</span>
    <span class="plain">+</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> +</span><span class="identifier">ve</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span>
    <span class="plain">.</span><span class="identifier">finishUpFX135</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduCurrentScreenMode</span><span class="plain">                           ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; }</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; } </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">nonMode7ReadCharacter</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readCharacterDefinitionMaskFromScreen</span><span class="plain">          ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain">, </span><span class="identifier">making</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> 8 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">match</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">, </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">workspaceA</span><span class="plain">-</span><span class="identifier">H</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">charSPACE</span><span class="plain">                                     ; </span><span class="identifier">Start</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">readCharLoop</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">Loop</span><span class="plain"> </span><span class="identifier">through</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">looking</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">matches</span><span class="plain"> </span><span class="identifier">workspaceA</span><span class="plain">-</span><span class="identifier">H</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">Save</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setupCharacterDefinitionAddress</span><span class="plain">                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">X</span>
    <span class="plain">-</span>
        <span class="identifier">LDY</span><span class="plain"> #7                                              ; </span><span class="identifier">Y</span><span class="plain">=7</span>
    <span class="plain">--</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduWorkspaceA</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">workspaceA</span><span class="plain">-</span><span class="identifier">H</span><span class="plain"> </span><span class="identifier">copy</span>
        <span class="identifier">CMP</span><span class="plain"> (.</span><span class="identifier">tempStoreDE</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">)</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">--</span>
        <span class="identifier">BPL</span><span class="plain"> --                                              ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">still</span><span class="plain"> </span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">negative</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">eight</span><span class="plain"> </span><span class="identifier">times</span><span class="plain">, </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">At</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">matches</span>
        <span class="identifier">CPX</span><span class="plain"> #.</span><span class="identifier">charDELETE</span><span class="plain">                                    ; </span><span class="identifier">but</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">it</span><span class="character">'s the DELETE character then pretend we didn'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">match</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">on</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">finishUpFX135</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">NOT</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">DELETE</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">finish</span><span class="plain"> </span><span class="identifier">up</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">match</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ; }</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; } </span><span class="identifier">Add</span><span class="plain"> 8 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">ADC</span><span class="plain"> #8                                              ; } </span><span class="identifier">Affects</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">only</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">page</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">time</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDE</span><span class="plain">                                    ; }</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">have</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">reached</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">page</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">)</span>

        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">readCharLoop</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">finishUpFX135</span><span class="plain">                                  ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">finish</span><span class="plain"> </span><span class="identifier">up</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readCharacterDefinitionMaskFromScreen</span>
        <span class="identifier">LDY</span><span class="plain"> #7                                              ; </span><span class="identifier">Y</span><span class="plain">=7</span>
    <span class="plain">.</span><span class="identifier">setupPatternLoop</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; .</span><span class="identifier">tempStoreDA</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #1                                              ; </span><span class="identifier">A</span><span class="plain">=1</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDB</span><span class="plain">                                    ; .</span><span class="identifier">tempStoreDB</span><span class="plain">=</span><span class="identifier">A</span>
    <span class="plain">--</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduColourMaskLeft</span><span class="plain">                              ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">mask</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">vduWriteCursorScreenAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">             ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">vduBackgroundTextColour</span><span class="plain">                        ; </span><span class="identifier">EOR</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">background</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
    <span class="plain">-</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">mask</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">result</span><span class="plain"> = 0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">becomes</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">our</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain">)</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain">. </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">becomes</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">our</span><span class="plain"> </span><span class="identifier">mask</span>
    <span class="plain">+</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">tempStoreDB</span><span class="plain">                                    ; </span><span class="identifier">Rotate</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">bit</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">now</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">originally</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">because</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">done</span><span class="plain">:</span>
                                                            <span class="plain">;               </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">initial</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> 1 </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">rotated</span><span class="plain"> </span><span class="identifier">through</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> 8 </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain">)</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">tempStoreDC</span><span class="plain">                                    ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">place</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">pixel</span>
        <span class="identifier">BCC</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">; </span><span class="identifier">nothing</span><span class="plain"> </span><span class="identifier">shifted</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">left</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">ADC</span><span class="plain"> #7                                              ; } </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">Y</span><span class="plain"> + 8 (</span><span class="identifier">Carry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">, </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">adding</span><span class="plain"> 7 + </span><span class="identifier">carry</span><span class="plain"> = 8)</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; }</span>
        <span class="identifier">BCC</span><span class="plain"> --                                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">overflow</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">add</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">, </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">cell</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">from</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">modified</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreDB</span><span class="plain">                                    ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduWorkspaceA</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">copy</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">setupPatternLoop</span><span class="plain">                               ; </span><span class="identifier">until</span><span class="plain"> 8 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">copied</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">variable</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">coordinates</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">use</span><span class="plain">.</span>
    <span class="plain">.</span><span class="identifier">readPixel</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">plotConvertAbsoluteCoordinatesToPixels</span><span class="plain">         ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">positional</span><span class="plain"> </span><span class="identifier">data</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkPointXInBoundsAndSetScreenAddresses</span><span class="plain">       ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">checking</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">window</span><span class="plain"> </span><span class="identifier">bounds</span>
        <span class="identifier">BNE</span><span class="plain"> ++                                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bounds</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FF</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">screenAddressOfGraphicsCursorCellLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">       ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">graphics</span><span class="plain"> </span><span class="identifier">cell</span>
    <span class="plain">-</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">*2 </span><span class="identifier">C</span><span class="plain">=</span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; .</span><span class="identifier">tempStoreDA</span><span class="plain">=.</span><span class="identifier">tempStoreDA</span><span class="plain">+2 +</span><span class="identifier">C</span><span class="plain">  </span><span class="identifier">C</span><span class="plain">=</span><span class="identifier">bit</span><span class="plain"> 7 .</span><span class="identifier">tempStoreDA</span>
        <span class="identifier">ASL</span><span class="plain"> .</span><span class="identifier">vduCurrentPlotByteMask</span><span class="plain">                         ; </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain">=</span><span class="identifier">bM</span><span class="plain">*2 +</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain">                                    ; </span><span class="identifier">restore</span><span class="plain"> .</span><span class="identifier">tempStoreDA</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="character">'=0</span>
    <span class="character">+</span>
        <span class="character">PLP                                                 ; pull flags</span>
        <span class="character">BNE -                                               ; if (Z set) then branch</span>
        <span class="character">LDA .tempStoreDA                                    ; A=.tempStoreDA AND number of colours in current mode -1</span>
        <span class="character">AND .vduNumberOfLogicalColoursMinusOne              ;</span>
        <span class="character">RTS                                                 ; then exit</span>

    <span class="character">++</span>
        <span class="character">LDA #$FF                                            ; A=$FF</span>
    <span class="character">-</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Takes the parameters from the VDU queue that represent a graphics coordinate,</span>
    <span class="character">; checks whether they are in bounds, and sets up screen addresses.</span>
    <span class="character">;</span>
    <span class="character">.checkParameterInBoundsAndSetScreenAddresses</span>
        <span class="character">LDX #.vdu25ParameterXLow - .vduVariablesStart       ; X is the offset to the desired parameter for the point in graphics coordinates</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Takes the graphics coordinates pointed to by X, checks whether they are in the bounds</span>
    <span class="character">; of the graphics window, and sets up screen addresses.</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       X is the vdu variables offset to the graphics point to check</span>
    <span class="character">; On Exit:</span>
    <span class="character">;       Y is the vertical offset within the character cell (0-7)</span>
    <span class="character">;</span>
    <span class="character">.checkPointXInBoundsAndSetScreenAddresses</span>
        <span class="character">JSR .checkVariableXIsWithinGraphicsWindow           ;</span>
        <span class="character">BNE -                                               ; if (point is not in graphics window) then branch (exit)</span>
    <span class="character">.setScreenAddress</span>
        <span class="character">LDA .vduGraphicsWindowPixelsBottomLow,X             ; read low byte of Y coordinate</span>
        <span class="character">EOR #$FF                                            ; Flip the coordinates to be from the top of the screen</span>
        <span class="character">TAY                                                 ; Remember in Y</span>
        <span class="character">AND #7                                              ; A is the vertical offset within a character cell</span>
        <span class="character">STA .vduGraphicsCursorVerticalOffsetInCell          ; store</span>
        <span class="character">TYA                                                 ; A=Y</span>
        <span class="character">LSR                                                 ; }</span>
        <span class="character">LSR                                                 ; }</span>
        <span class="character">LSR                                                 ; } Divide by 8</span>
        <span class="character">ASL                                                 ; Multiply by two to give the offset in the multiplication table</span>
        <span class="character">TAY                                                 ; Y = offset into multiplication table</span>
        <span class="character">LDA (.vduMultiplicationTableLow),Y                  ; Get high byte of offset from screen RAM start</span>
        <span class="character">STA .tempStoreDA                                    ; store it</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">LDA (.vduMultiplicationTableLow),Y                  ; get low byte</span>
        <span class="character">LDY .vduCurrentScreenModeMemorySizeIndex            ; check screen memory size type</span>
        <span class="character">BEQ +                                               ; if (zero; MODEs 0,1,2) then branch (skip this next bit)</span>
        <span class="character">LSR .tempStoreDA                                    ; } Divide the offset by two</span>
        <span class="character">ROR                                                 ; }</span>
    <span class="character">+</span>
        <span class="character">ADC .vduScreenTopLeftAddressLow                     ; add the screen top left address (low)</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellLow           ; store it</span>
        <span class="character">LDA .tempStoreDA                                    ; get high byte</span>
        <span class="character">ADC .vduScreenTopLeftAddressHigh                    ; add with carry the screen top left address (high)</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellHigh          ; store it</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftHigh,X              ;</span>
        <span class="character">STA .tempStoreDA                                    ; store x coordinate of point (high)</span>
        <span class="character">LDA .vduGraphicsWindowPixelsLeftLow,X               ; get x coordinate of point (low)</span>
        <span class="character">PHA                                                 ; remember it</span>
        <span class="character">AND .pixelsPerByteMinusOneForCurrentMode            ; get the horizontal X offset within the range of pixelsPerByte</span>
        <span class="character">ADC .pixelsPerByteMinusOneForCurrentMode            ; add the pixels per byte minus one, which offsets to (one more than) the</span>
                                                            <span class="character">;                       start of the mode mask table for the current mode</span>
        <span class="character">TAY                                                 ; Y=A</span>
        <span class="character">LDA .sixteenColourModeMaskTable - 1,Y               ; read byte mask</span>
        <span class="character">STA .vduCurrentPlotByteMask                         ; store it</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">LDY .pixelsPerByteMinusOneForCurrentMode            ; Y=number of pixels per byte minus one</span>
        <span class="character">CPY #3                                              ; is Y=3 (modes 1,6)</span>
        <span class="character">BEQ +                                               ; goto D8B2</span>
        <span class="character">BCS ++                                              ; if (mode = 1 or 4) then branch</span>
        <span class="character">ASL                                                 ; A/.tempStoreDA =A/.tempStoreDA *2</span>
        <span class="character">ROL .tempStoreDA                                    ;</span>
    <span class="character">+</span>
        <span class="character">ASL                                                 ;</span>
        <span class="character">ROL .tempStoreDA                                    ;</span>
    <span class="character">++</span>
        <span class="character">AND #$F8                                            ; clear bits 0-2</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">ADC .screenAddressOfGraphicsCursorCellLow           ; add A/.tempStoreDA to screen address</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellLow           ;</span>
        <span class="character">LDA .tempStoreDA                                    ;</span>
        <span class="character">ADC .screenAddressOfGraphicsCursorCellHigh          ;</span>
        <span class="character">BPL +                                               ; if (result +ve) then branch</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">SBC .vduScreenSizeHighByte                          ; and subtract screen memory size making it wrap round</span>
    <span class="character">+</span>
        <span class="character">STA .screenAddressOfGraphicsCursorCellHigh          ; store it in D7</span>
        <span class="character">LDY .vduGraphicsCursorVerticalOffsetInCell          ; get line in graphics cell containing current graphics</span>
    <span class="character">.zeroAReturn</span>
        <span class="character">LDA #0                                              ; point A=0</span>
        <span class="character">RTS                                                 ; And exit</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.someRoutine</span>
        <span class="character">PHA                                                 ; Push A</span>
        <span class="character">LDA #$A0                                            ; A=$A0</span>
        <span class="character">LDX .twosComplimentOfNumberOfBytesInVDUQueue        ; X=number of items in VDU queue</span>
        <span class="character">BNE .pullAndReturn2                                 ; if (not 0) then branch</span>
        <span class="character">BIT .vduStatusByte                                  ; check VDU status byte</span>
        <span class="character">BNE .pullAndReturn2                                 ; if (either VDU is disabled, or plot to graphics cursor enabled) then branch (exit)</span>
        <span class="character">BVS +                                               ; if (cursor editing enabled) then branch</span>
        <span class="character">LDA .vduLastCursorStartRegisterValue                ; get CRTC register start setting</span>
        <span class="character">AND #%10011111                                      ; clear bits 5 and 6</span>
        <span class="character">ORA #%01000000                                      ; set bit 6 to modify last cursor size setting</span>
        <span class="character">JSR .setCursorOnOrOff                               ; change cursor format</span>
        <span class="character">LDX #.vduTextCursorXPosition - .vduVariablesStart          ; source = text cursor</span>
        <span class="character">LDY #.vduTextInputCursorXCoordinate - .vduVariablesStart   ; destination = text input cursor</span>
        <span class="character">JSR .copy2BytesWithinVDUVariables                   ; set text input cursor from text output cursor</span>
        <span class="character">JSR .restoreWriteCursor                             ; modify character at cursor position</span>
        <span class="character">LDA #2                                              ;</span>
        <span class="character">JSR .setVDUStatusByteFlags                          ; bit 1 of VDU status is set to bar scrolling</span>
    <span class="character">+</span>
        <span class="character">LDA #%10111111                                      ;</span>
        <span class="character">JSR .clearVDUStatusByteFlags                        ; bit 6 of VDU status (separated cursors) is set to zero</span>
        <span class="character">PLA                                                 ; Pull A</span>
        <span class="character">AND #%01111111                                      ; clear high bit (7)</span>
        <span class="character">JSR .vduChrEntryPoint                               ; call VDU routine</span>
        <span class="character">LDA #%01000000                                      ; set bit six (separate cursors)</span>
        <span class="character">JMP .setVDUStatusByteFlags                          ; set separated cursors and return</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.readCharacterFromScreenAndCursorRight</span>
        <span class="character">LDA #%00100000                                      ; A=$20</span>
        <span class="character">BIT .vduStatusByte                                  ;</span>
        <span class="character">BVC .zeroAReturn                                    ; if (bit 6 clear; not cursor editing) then branch (exit)</span>
        <span class="character">BNE .zeroAReturn                                    ; if (bit 5 set; graphics cursor enabled) then branch (exit)</span>
        <span class="character">JSR .osbyte135EntryPoint                            ; read a character from the screen</span>
        <span class="character">BEQ .exit12                                         ; if (A = 0) then branch (exit)</span>
        <span class="character">PHA                                                 ; store A</span>
        <span class="character">JSR .vdu9EntryPoint                                 ; perform cursor right</span>
    <span class="character">.pullAndReturn2</span>
        <span class="character">PLA                                                 ; restore A</span>
    <span class="character">.exit12</span>
        <span class="character">RTS                                                 ; and exit</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; When editing a line with two cursors, pressing return terminates the edit.</span>
    <span class="character">; This clears the VDU status flags and restores the text cursor to normal.</span>
    <span class="character">.terminateEdit</span>
        <span class="character">LDA #%10111101                                      ; }</span>
        <span class="character">JSR .clearVDUStatusByteFlags                        ; } clear bits 2 and 6 of VDU status (page scrolling; separated cursors)</span>
        <span class="character">JSR .setTextCursor                                  ; set text cursor</span>
        <span class="character">LDA #.charRETURN                                    ; continue processing as a RETURN character</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSBYTE 132 - Read start of screen memory for current mode (HIMEM)</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osbyte132EntryPoint</span>
        <span class="character">LDX .vduCurrentScreenMode                           ; get current screen mode</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSBYTE 133 - Read start of screen memory for given MODE number</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osbyte133EntryPoint</span>
        <span class="character">TXA                                                 ; X=MODE number</span>
        <span class="character">AND #7                                              ; keep it in range 0-7</span>
        <span class="character">TAY                                                 ; Y=MODE number</span>
        <span class="character">LDX .screenDisplayMemoryIndexTable,Y                ; X = get screen RAM size index</span>
        <span class="character">LDA .screenMemoryStartHigh,X                        ; A = high byte of start address</span>
        <span class="character">LDX #0                                              ; X = 0 (low byte of result)</span>
        <span class="character">BIT .systemAvailableRAM                             ; get available RAM</span>
        <span class="character">BMI .returnTheScreenAddress                         ; if (32k available) then branch</span>
        <span class="character">AND #$3F                                            ; AND A with $3F to bring into memory range for a 16K BBC Micro</span>
        <span class="character">CPY #4                                              ;</span>
        <span class="character">BCS .returnTheScreenAddress                         ; if (MODE number &gt;= 4) then branch (to return the value)</span>
        <span class="character">TXA                                                 ; return zero (Model A can'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">modes</span><span class="plain"> 0-3)</span>
    <span class="plain">.</span><span class="identifier">returnTheScreenAddress</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 7
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 7: </span><span class="identifier">Default</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">tables</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Reset</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">point</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Default</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">table</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">defaultVectorTable</span>
        <span class="plain">;     </span><span class="identifier">value</span><span class="plain">                     </span><span class="identifier">name</span><span class="plain">           </span><span class="identifier">address</span><span class="plain">      </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">label</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">badCommandError</span><span class="plain">        ; </span><span class="identifier">USERV</span><span class="plain">          $0200-1      .</span><span class="identifier">vectorUSERV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">brkHandler</span><span class="plain">             ; </span><span class="identifier">BRKV</span><span class="plain">           $0202-3      .</span><span class="identifier">vectorBRKV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">irq1Handler</span><span class="plain">            ; </span><span class="identifier">IRQ1V</span><span class="plain">          $0204-5      .</span><span class="identifier">vectorIRQ1V</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">irq2Handler</span><span class="plain">            ; </span><span class="identifier">IRQ2V</span><span class="plain">          $0206-7      .</span><span class="identifier">vectorIRQ2V</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">oscliHandler</span><span class="plain">           ; </span><span class="identifier">CLIV</span><span class="plain">           $0208-9      .</span><span class="identifier">vectorCLIV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">osbyteEntryPoint</span><span class="plain">       ; </span><span class="identifier">BYTEV</span><span class="plain">          $020</span><span class="identifier">A</span><span class="plain">-</span><span class="identifier">B</span><span class="plain">      .</span><span class="identifier">vectorBYTEV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">oswordEntryPoint</span><span class="plain">       ; </span><span class="identifier">WORDV</span><span class="plain">          $020</span><span class="identifier">C</span><span class="plain">-</span><span class="identifier">D</span><span class="plain">      .</span><span class="identifier">vectorWORDV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">oswrchEntryPoint</span><span class="plain">       ; </span><span class="identifier">WRCHV</span><span class="plain">          $020</span><span class="identifier">E</span><span class="plain">-</span><span class="identifier">F</span><span class="plain">      .</span><span class="identifier">vectorWRCHV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">osrdchEntryPoint</span><span class="plain">       ; </span><span class="identifier">RDCHV</span><span class="plain">          $0210-1      .</span><span class="identifier">vectorRDCHV</span>
    <span class="plain">.</span><span class="identifier">defaultFileVectorEntry</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">osfileEntryPoint</span><span class="plain">       ; </span><span class="identifier">FILEV</span><span class="plain">          $0212-3      .</span><span class="identifier">vectorFILEV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">osargsEntryPoint</span><span class="plain">       ; </span><span class="identifier">ARGSV</span><span class="plain">          $0214-5      .</span><span class="identifier">vectorARGSV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">osbgetEntryPoint</span><span class="plain">       ; </span><span class="identifier">BGETV</span><span class="plain">          $0216-7      .</span><span class="identifier">vectorBGETV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">osbputEntryPoint</span><span class="plain">       ; </span><span class="identifier">BPUTV</span><span class="plain">          $0218-9      .</span><span class="identifier">vectorBPUTV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="reserved">return</span><span class="plain">                 ; </span><span class="identifier">GBPBV</span><span class="plain">          $021</span><span class="identifier">A</span><span class="plain">-</span><span class="identifier">B</span><span class="plain">      .</span><span class="identifier">vectorGBPBV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">osfindEntryPoint</span><span class="plain">       ; </span><span class="identifier">FINDV</span><span class="plain">          $021</span><span class="identifier">C</span><span class="plain">-</span><span class="identifier">D</span><span class="plain">      .</span><span class="identifier">vectorFINDV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">fscEntryPoint</span><span class="plain">          ; </span><span class="identifier">FSCV</span><span class="plain">           $021</span><span class="identifier">E</span><span class="plain">-</span><span class="identifier">F</span><span class="plain">      .</span><span class="identifier">vectorFSCV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="reserved">return</span><span class="plain">                 ; </span><span class="identifier">EVNTV</span><span class="plain">          $0220-1      .</span><span class="identifier">vectorEVNTV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="reserved">return</span><span class="plain">                 ; </span><span class="identifier">UPTV</span><span class="plain">           $0222-3      .</span><span class="identifier">vectorUPTV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="reserved">return</span><span class="plain">                 ; </span><span class="identifier">NETV</span><span class="plain">           $0224-5      .</span><span class="identifier">vectorNETV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="reserved">return</span><span class="plain">                 ; </span><span class="identifier">VDUV</span><span class="plain">           $0226-7      .</span><span class="identifier">vectorVDUV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">keyEntryPoint</span><span class="plain">          ; </span><span class="identifier">KEYV</span><span class="plain">           $0228-9      .</span><span class="identifier">vectorKEYV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">insEntryPoint</span><span class="plain">          ; </span><span class="identifier">INSBV</span><span class="plain">          $022</span><span class="identifier">A</span><span class="plain">-</span><span class="identifier">B</span><span class="plain">      .</span><span class="identifier">vectorINSV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">remEntryPoint</span><span class="plain">          ; </span><span class="identifier">REMVB</span><span class="plain">          $022</span><span class="identifier">C</span><span class="plain">-</span><span class="identifier">D</span><span class="plain">      .</span><span class="identifier">vectorREMV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">cnpEntryPoint</span><span class="plain">          ; </span><span class="identifier">CNPV</span><span class="plain">           $022</span><span class="identifier">E</span><span class="plain">-</span><span class="identifier">F</span><span class="plain">      .</span><span class="identifier">vectorCNPV</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="reserved">return</span><span class="plain">                 ; </span><span class="identifier">IND1V</span><span class="plain">          $0230-1      .</span><span class="identifier">vectorIND1V</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="reserved">return</span><span class="plain">                 ; </span><span class="identifier">IND2V</span><span class="plain">          $0232-3      .</span><span class="identifier">vectorIND2V</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="reserved">return</span><span class="plain">                 ; </span><span class="identifier">IND3V</span><span class="plain">          $0234-5      .</span><span class="identifier">vectorIND3V</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">MOS</span><span class="plain"> </span><span class="identifier">Variables</span><span class="plain"> </span><span class="identifier">Default</span><span class="plain"> </span><span class="identifier">Values</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">read</span><span class="plain">/</span><span class="identifier">written</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">OSBYTEs</span><span class="plain"> 166-252</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>

        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">systemVariableBase</span><span class="plain">     ; </span><span class="identifier">MOS</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> (</span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">)     $0236-7   *</span><span class="identifier">FX</span><span class="plain"> 166/7</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">extendedVectorSpace</span><span class="plain">    ; </span><span class="identifier">Address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">table</span><span class="plain">                  $0238-9   *</span><span class="identifier">FX</span><span class="plain"> 168/9</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">romTypeTable</span><span class="plain">           ; </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">information</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">address</span><span class="plain">                 $023</span><span class="identifier">A</span><span class="plain">-</span><span class="identifier">B</span><span class="plain">   *</span><span class="identifier">FX</span><span class="plain"> 170/1</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">keyDataBlock1</span><span class="plain"> - 16     ; </span><span class="identifier">Key</span><span class="plain"> </span><span class="identifier">translation</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">address</span><span class="plain">                 $023</span><span class="identifier">C</span><span class="plain">-</span><span class="identifier">D</span><span class="plain">   *</span><span class="identifier">FX</span><span class="plain"> 172/3</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain">      ; </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> </span><span class="identifier">start</span><span class="plain">                           $023</span><span class="identifier">E</span><span class="plain">-</span><span class="identifier">F</span><span class="plain">   *</span><span class="identifier">FX</span><span class="plain"> 174/5</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">timeout</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain">                           $0240     *</span><span class="identifier">FX</span><span class="plain"> 176</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">                   $0241     *</span><span class="identifier">FX</span><span class="plain"> 177</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                     ; </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">semaphore</span><span class="plain">                  $0242     *</span><span class="identifier">FX</span><span class="plain"> 178</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">primary</span><span class="plain"> </span><span class="identifier">OSHWM</span><span class="plain"> (</span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">PAGE</span><span class="plain">)                  $0243     *</span><span class="identifier">FX</span><span class="plain"> 179</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OSHWM</span><span class="plain"> (</span><span class="identifier">PAGE</span><span class="plain">)                          $0244     *</span><span class="identifier">FX</span><span class="plain"> 180</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 1                       ; </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">Mode</span><span class="plain">                                    $0245     *</span><span class="identifier">FX</span><span class="plain"> 181</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">definition</span><span class="plain"> </span><span class="identifier">explosion</span><span class="plain"> </span><span class="identifier">state</span><span class="plain">          $0246     *</span><span class="identifier">FX</span><span class="plain"> 182</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">Filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">=2 </span><span class="identifier">CFS</span><span class="plain">=0                $0247     *</span><span class="identifier">FX</span><span class="plain"> 183</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">Video</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span><span class="plain">            $0248     *</span><span class="identifier">FX</span><span class="plain"> 184</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">palette</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain">                       $0249     *</span><span class="identifier">FX</span><span class="plain"> 185</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain">             $024</span><span class="identifier">A</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 186</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                     ; </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">                           $024</span><span class="identifier">B</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 187</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 4                       ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">                    $024</span><span class="identifier">C</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 188</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 4                       ; </span><span class="identifier">maximum</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">                    $024</span><span class="identifier">D</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 189</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">: 0 </span><span class="identifier">or</span><span class="plain"> $0</span><span class="identifier">C</span><span class="plain">=12 </span><span class="identifier">bit</span><span class="plain">; 8=8 </span><span class="identifier">Bit</span><span class="plain"> $024</span><span class="identifier">E</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 190</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                     ; </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">busy</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">clear</span><span class="plain">=</span><span class="identifier">busy</span><span class="plain">)            $024</span><span class="identifier">F</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 191</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $56                     ; </span><span class="identifier">curent</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain">          $0250     *</span><span class="identifier">FX</span><span class="plain"> 192</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $19                     ; </span><span class="identifier">flash</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain">                                 $0251     *</span><span class="identifier">FX</span><span class="plain"> 193</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $19                     ; </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">period</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">                             $0252     *</span><span class="identifier">FX</span><span class="plain"> 194</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $19                     ; </span><span class="identifier">space</span><span class="plain"> </span><span class="identifier">period</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">                            $0253     *</span><span class="identifier">FX</span><span class="plain"> 195</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 50                      ; </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">Auto</span><span class="plain">-</span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">delay</span><span class="plain">                    $0254     *</span><span class="identifier">FX</span><span class="plain"> 196</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 8                       ; </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">Auto</span><span class="plain">-</span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">rate</span><span class="plain">                     $0255     *</span><span class="identifier">FX</span><span class="plain"> 197</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; *</span><span class="identifier">EXEC</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain">  (0 -</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">allocated</span><span class="plain">)         $0256     *</span><span class="identifier">FX</span><span class="plain"> 198</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; *</span><span class="identifier">SPOOL</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> (0 -</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">allocated</span><span class="plain">)         $0257     *</span><span class="identifier">FX</span><span class="plain"> 199</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">Escape</span><span class="plain"> </span><span class="identifier">enable</span><span class="plain">/</span><span class="identifier">disable</span><span class="plain">                   $0258     *</span><span class="identifier">FX</span><span class="plain"> 200</span>
                                    <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 1 </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">normal</span><span class="plain">/</span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">Econet</span><span class="plain"> </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">                  $0259     *</span><span class="identifier">FX</span><span class="plain"> 201</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00100000               ; </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span><span class="plain">    </span><span class="identifier">bit</span><span class="plain"> 3=1 </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">      $025</span><span class="identifier">A</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 202</span>
                                    <span class="plain">;                    </span><span class="identifier">bit</span><span class="plain"> 4=0 </span><span class="identifier">caps</span><span class="plain">  </span><span class="identifier">lock</span>
                                    <span class="plain">;                    </span><span class="identifier">bit</span><span class="plain"> 5=0 </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">lock</span>
                                    <span class="plain">;                    </span><span class="identifier">bit</span><span class="plain"> 6=1 </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">bit</span>
                                    <span class="plain">;                    </span><span class="identifier">bit</span><span class="plain"> 7=1 </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">enabled</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 9                       ; </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">full</span><span class="plain"> </span><span class="identifier">signal</span><span class="plain">       $025</span><span class="identifier">B</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 203</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">suppression</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">                  $025</span><span class="identifier">C</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 204</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">cassette</span><span class="plain">/</span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">  (0=</span><span class="identifier">CFS</span><span class="plain">, $40=</span><span class="identifier">RS423</span><span class="plain">)       $025</span><span class="identifier">D</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 205</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">Econet</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">interception</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> 7)      $025</span><span class="identifier">E</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 206</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">Econet</span><span class="plain"> </span><span class="identifier">OSRDCH</span><span class="plain"> </span><span class="identifier">interception</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> 7)       $025</span><span class="identifier">F</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 207</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">Econet</span><span class="plain"> </span><span class="identifier">OSWRCH</span><span class="plain"> </span><span class="identifier">interception</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> 7)       $0260     *</span><span class="identifier">FX</span><span class="plain"> 208</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $50                     ; </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">enable</span><span class="plain">/</span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> ($50/$20)          $0261     *</span><span class="identifier">FX</span><span class="plain"> 209</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">                     $0262     *</span><span class="identifier">FX</span><span class="plain"> 210</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 3                       ; </span><span class="identifier">BELL</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">                           $0263     *</span><span class="identifier">FX</span><span class="plain"> 211</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $90                     ; </span><span class="identifier">BELL</span><span class="plain"> </span><span class="identifier">amplitude</span><span class="plain">/</span><span class="identifier">Envelope</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">                $0264     *</span><span class="identifier">FX</span><span class="plain"> 212</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $64                     ; </span><span class="identifier">BELL</span><span class="plain"> </span><span class="identifier">frequency</span><span class="plain">                                $0265     *</span><span class="identifier">FX</span><span class="plain"> 213</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 6                       ; </span><span class="identifier">BELL</span><span class="plain"> </span><span class="identifier">duration</span><span class="plain">                                 $0266     *</span><span class="identifier">FX</span><span class="plain"> 214</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $81                     ; </span><span class="identifier">bit</span><span class="plain"> 7=0 </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">message</span><span class="plain">               $0267     *</span><span class="identifier">FX</span><span class="plain"> 215</span>
                                    <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 0=1 </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> !</span><span class="identifier">BOOT</span><span class="plain"> </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> *</span><span class="identifier">disc</span><span class="plain">* </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">set</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">KEY</span><span class="plain"> </span><span class="identifier">string</span><span class="plain">                          $0268     *</span><span class="identifier">FX</span><span class="plain"> 216</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; </span><span class="identifier">PRINT</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain">                            $0269     *</span><span class="identifier">FX</span><span class="plain"> 217</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                       ; 2</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">compliment</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">items</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">queue</span><span class="plain"> $026</span><span class="identifier">A</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 218</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 9                       ; </span><span class="identifier">TAB</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">value</span><span class="plain">                                 $026</span><span class="identifier">B</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 219</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $1</span><span class="identifier">B</span><span class="plain">                     ; </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">Character</span><span class="plain">                              $026</span><span class="identifier">C</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 220</span>

        <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">how</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">interpreted</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">placed</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $01                     ; </span><span class="identifier">C0</span><span class="plain">-</span><span class="identifier">CF</span><span class="plain">                                         $026</span><span class="identifier">D</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 221</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">D0</span><span class="plain">                     ; </span><span class="identifier">D0</span><span class="plain">-</span><span class="identifier">DF</span><span class="plain">                                         $026</span><span class="identifier">E</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 222</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">E0</span><span class="plain">                     ; </span><span class="identifier">E0</span><span class="plain">-</span><span class="identifier">EF</span><span class="plain">                                         $026</span><span class="identifier">F</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 223</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">F0</span><span class="plain">                     ; </span><span class="identifier">F0</span><span class="plain">-</span><span class="identifier">FF</span><span class="plain">                                         $0270     *</span><span class="identifier">FX</span><span class="plain"> 224</span>

        <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> (</span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">codes</span><span class="plain">) </span><span class="reserved">for</span><span class="plain">:</span>
        <span class="plain">;</span>
        <span class="plain">;            </span><span class="identifier">function</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="plain">;      </span><span class="identifier">SHIFT</span><span class="plain">-</span><span class="identifier">function</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="plain">;       </span><span class="identifier">CTRL</span><span class="plain">-</span><span class="identifier">function</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="plain">; </span><span class="identifier">CTRL</span><span class="plain">-</span><span class="identifier">SHIFT</span><span class="plain">-</span><span class="identifier">function</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="plain">;</span>
        <span class="plain">; 0 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="plain">; 1 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">expand</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">normal</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">; 2-$</span><span class="identifier">FF</span><span class="plain"> </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">expand</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">normal</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> + </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">value</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $01                     ; 80-8</span><span class="identifier">F</span><span class="plain">                                         $0271     *</span><span class="identifier">FX</span><span class="plain"> 225</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $80                     ; 90-9</span><span class="identifier">F</span><span class="plain">                                         $0272     *</span><span class="identifier">FX</span><span class="plain"> 226</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $90                     ; </span><span class="identifier">A0</span><span class="plain">-</span><span class="identifier">AF</span><span class="plain">                                         $0273     *</span><span class="identifier">FX</span><span class="plain"> 227</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">B0</span><span class="plain">-</span><span class="identifier">BF</span><span class="plain">                                         $0274     *</span><span class="identifier">FX</span><span class="plain"> 228</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> (0=</span><span class="identifier">ESC</span><span class="plain">, 1=</span><span class="identifier">ASCII</span><span class="plain">)            $0275     *</span><span class="identifier">FX</span><span class="plain"> 229</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">action</span><span class="plain">                                 $0276     *</span><span class="identifier">FX</span><span class="plain"> 230</span>
    <span class="plain">.</span><span class="identifier">allBitsSet</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                     ; </span><span class="identifier">USER</span><span class="plain"> 6522 </span><span class="identifier">Bit</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain">                        $0277     *</span><span class="identifier">FX</span><span class="plain"> 231</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                     ; 6850 </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">Bit</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain">                    $0278     *</span><span class="identifier">FX</span><span class="plain"> 232</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                     ; </span><span class="identifier">System</span><span class="plain"> 6522 </span><span class="identifier">IRQ</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain">                      $0279     *</span><span class="identifier">FX</span><span class="plain"> 233</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">presence</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">                            $027</span><span class="identifier">A</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 234</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">presence</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">                $027</span><span class="identifier">B</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 235</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">destination</span><span class="plain"> </span><span class="identifier">status</span><span class="plain">                  $027</span><span class="identifier">C</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 236</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">editing</span><span class="plain"> </span><span class="identifier">status</span><span class="plain">                         $027</span><span class="identifier">D</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 237</span>

    <span class="plain">.</span><span class="identifier">softResetHWM</span>
    <span class="plain">; ************************* </span><span class="identifier">SOFT</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">water</span><span class="plain"> </span><span class="identifier">mark</span><span class="plain"> **********************************</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">unused</span><span class="plain">                                        $027</span><span class="identifier">E</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 238</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">unused</span><span class="plain">                                        $027</span><span class="identifier">F</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 239</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">country</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> (0=</span><span class="identifier">UK</span><span class="plain">,1=</span><span class="identifier">US</span><span class="plain">)                      $0280     *</span><span class="identifier">FX</span><span class="plain"> 240</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">                                     $0281     *</span><span class="identifier">FX</span><span class="plain"> 241</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $64                     ; </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain">           $0282     *</span><span class="identifier">FX</span><span class="plain"> 242</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $05                     ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain">            $0283     *</span><span class="identifier">FX</span><span class="plain"> 243</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                     ; </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> (</span><span class="identifier">unstable</span><span class="plain">)                    $0284     *</span><span class="identifier">FX</span><span class="plain"> 244</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $01                     ; </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">destination</span><span class="plain"> (</span><span class="identifier">parallel</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain">)        $0285     *</span><span class="identifier">FX</span><span class="plain"> 245</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 10                      ; </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> (</span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">feed</span><span class="plain">)          $0286     *</span><span class="identifier">FX</span><span class="plain"> 246</span>

    <span class="plain">.</span><span class="identifier">hardResetHWM</span>
    <span class="plain">; ************************* </span><span class="identifier">HARD</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">water</span><span class="plain"> </span><span class="identifier">mark</span><span class="plain"> **********************************</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">JMP</span><span class="plain">                $0287     *</span><span class="identifier">FX</span><span class="plain"> 247</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span><span class="plain">                $0288     *</span><span class="identifier">FX</span><span class="plain"> 248</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span><span class="plain">               $0289     *</span><span class="identifier">FX</span><span class="plain"> 249</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">unused</span><span class="plain">                                        $028</span><span class="identifier">A</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 250</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                     ; </span><span class="identifier">unused</span><span class="plain">                                        $028</span><span class="identifier">B</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 251</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">                     ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">                   $028</span><span class="identifier">C</span><span class="plain">     *</span><span class="identifier">FX</span><span class="plain"> 252</span>

    <span class="plain">.</span><span class="identifier">powerOnResetHWM</span>
    <span class="plain">; ********************** </span><span class="identifier">RESET</span><span class="plain"> </span><span class="identifier">High</span><span class="plain"> </span><span class="identifier">Water</span><span class="plain"> </span><span class="identifier">mark</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">Power</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> *****************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Reset</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">point</span>
    <span class="plain">; </span><span class="identifier">Called</span><span class="plain"> </span><span class="identifier">on</span><span class="plain">:</span>
    <span class="plain">;       * </span><span class="identifier">Power</span><span class="plain"> </span><span class="identifier">on</span>
    <span class="plain">;       * </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">HARD</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">occurs</span>
    <span class="plain">;       * </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">SOFT</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">occurs</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">power</span><span class="plain"> </span><span class="identifier">on</span><span class="plain">: 6522 </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">IER</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0 </span><span class="identifier">to</span><span class="plain"> 6 </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">clear</span>
    <span class="plain">;       </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain">   : 6522 </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">IER</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0 </span><span class="identifier">to</span><span class="plain"> 6 </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">least</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">set</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">resetEntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> #$40                                            ; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">numerical</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">RTI</span><span class="plain"> </span><span class="identifier">opcode</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">nmiEntryPoint</span><span class="plain">                                  ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">RTI</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">NMI</span><span class="plain"> </span><span class="identifier">routine</span>

        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">just</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="reserved">case</span>
        <span class="identifier">CLD</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">decimal</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">LDX</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">where</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">should</span><span class="plain"> </span><span class="identifier">be</span>
        <span class="identifier">TXS</span><span class="plain">                                                 ; ($01</span><span class="identifier">FF</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">systemViaInterruptEnableRegister</span><span class="plain">               ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">interupt</span><span class="plain"> </span><span class="identifier">enable</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 (</span><span class="identifier">reading</span><span class="plain"> </span><span class="identifier">IER</span><span class="plain"> </span><span class="identifier">always</span><span class="plain"> </span><span class="identifier">returns</span><span class="plain"> 1 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7) </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">what</span><span class="character">'s left (for use later when setting page 2: just before .setUpPage2)</span>
        <span class="character">BEQ .clearRAM                                       ; if (power on) then branch</span>
        <span class="character">LDA .escapeAndBreakEffect                           ; read BREAK Action flags (set by *FX200,n)</span>
        <span class="character">LSR                                                 ; divide by 2 to get the break action</span>
        <span class="character">CMP #1                                              ;</span>
        <span class="character">BNE .setUpSystemVIA                                 ; if (break action says we don'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">need</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=0 (</span><span class="identifier">since</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=1 </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">clearRAM</span>
        <span class="identifier">LDX</span><span class="plain"> #4                                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">page</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">clearance</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> (4)</span>
        <span class="identifier">STX</span><span class="plain"> $01                                             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">ZP</span><span class="plain"> 01</span>
        <span class="identifier">STA</span><span class="plain"> $00                                             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">at</span><span class="plain"> $00</span>

        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">zero</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> ($00),</span><span class="identifier">Y</span><span class="plain">                                         ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">RAM</span>
        <span class="identifier">CMP</span><span class="plain"> $01                                             ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain">. </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">happens</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> $4001 </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> 16</span><span class="identifier">k</span><span class="plain"> </span><span class="identifier">machine</span><span class="plain"> </span><span class="identifier">the</span>
                                                            <span class="plain">; </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">addressing</span><span class="plain"> </span><span class="identifier">loops</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">around</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> $0001. </span><span class="identifier">We</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">done</span>
                                                            <span class="plain">; </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">avoid</span><span class="plain"> </span><span class="identifier">overwriting</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">rest</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">page</span><span class="plain">.</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">=1) </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">avoids</span><span class="plain"> </span><span class="identifier">overwriting</span><span class="plain"> </span><span class="identifier">RTI</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $</span><span class="identifier">D00</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">INC</span><span class="plain"> $01                                             ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=$80 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">+</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">systemAvailableRAM</span><span class="plain">                             ; </span><span class="identifier">writes</span><span class="plain"> </span><span class="identifier">marker</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">available</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> ($40=16</span><span class="identifier">k</span><span class="plain">; $80=32</span><span class="identifier">k</span><span class="plain">)</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">softKeyConsistencyFlag</span><span class="plain">                         ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">consistency</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setUpSystemVIA</span>
        <span class="identifier">LDX</span><span class="plain"> #%00001111                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">PORT</span><span class="plain"> </span><span class="identifier">B</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0-3; </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 4-7</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">systemViaDataDirectionRegisterB</span><span class="plain">                ;</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain">, </span><span class="identifier">Register</span><span class="plain"> </span><span class="identifier">B</span><span class="plain"> ($</span><span class="identifier">FE40</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Notes</span><span class="plain">:</span>
    <span class="plain">;     </span><span class="identifier">Values</span><span class="plain"> 0-15 </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">written</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">Port</span><span class="plain"> </span><span class="identifier">B</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">;         </span><span class="identifier">Value</span><span class="plain">   </span><span class="identifier">Effect</span>
    <span class="plain">;         -------------------------</span>
    <span class="plain">;         0       </span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">chip</span>
    <span class="plain">;         1       </span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">Speech</span>
    <span class="plain">;         2       </span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">Speech</span>
    <span class="plain">;         3       </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">Keyboard</span><span class="plain"> </span><span class="reserved">auto</span><span class="plain"> </span><span class="identifier">scanning</span>
    <span class="plain">;         4       </span><span class="identifier">Hardware</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> - </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">C0</span><span class="plain">=0 (</span><span class="identifier">See</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
    <span class="plain">;         5       </span><span class="identifier">Hardware</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> - </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">C1</span><span class="plain">=0 (</span><span class="identifier">See</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
    <span class="plain">;         6       </span><span class="identifier">Turn</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">Caps</span><span class="plain"> </span><span class="identifier">Lock</span><span class="plain"> </span><span class="identifier">LED</span>
    <span class="plain">;         7       </span><span class="identifier">Turn</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">Shift</span><span class="plain"> </span><span class="identifier">Lock</span><span class="plain"> </span><span class="identifier">LED</span>
    <span class="plain">;         8       </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">chip</span>
    <span class="plain">;         9       </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">Speech</span>
    <span class="plain">;         10      </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">Speech</span>
    <span class="plain">;         11      </span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">Keyboard</span><span class="plain"> </span><span class="reserved">auto</span><span class="plain"> </span><span class="identifier">scanning</span>
    <span class="plain">;         12      </span><span class="identifier">Hardware</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> - </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">C0</span><span class="plain">=1 (</span><span class="identifier">See</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
    <span class="plain">;         13      </span><span class="identifier">Hardware</span><span class="plain"> </span><span class="identifier">scrolling</span><span class="plain"> - </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">C1</span><span class="plain">=1 (</span><span class="identifier">See</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
    <span class="plain">;         14      </span><span class="identifier">Turn</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">Caps</span><span class="plain"> </span><span class="identifier">Lock</span><span class="plain"> </span><span class="identifier">LED</span>
    <span class="plain">;         15      </span><span class="identifier">Turn</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">Shift</span><span class="plain"> </span><span class="identifier">Lock</span><span class="plain"> </span><span class="identifier">LED</span>
    <span class="plain">;</span>
    <span class="plain">;  </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">C0</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">C1</span><span class="plain"> </span><span class="identifier">together</span><span class="plain"> </span><span class="identifier">determine</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">scroll</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">screen</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">;         </span><span class="identifier">C0</span><span class="plain">   </span><span class="identifier">C1</span><span class="plain">      </span><span class="identifier">Screen</span><span class="plain">      </span><span class="identifier">Regular</span>
    <span class="plain">;                      </span><span class="identifier">Address</span><span class="plain">      </span><span class="identifier">MODEs</span>
    <span class="plain">;         --------------------------------</span>
    <span class="plain">;          0    0      $4000         3</span>
    <span class="plain">;          0    1      $5800        4,5</span>
    <span class="plain">;          1    0      $6000         6</span>
    <span class="plain">;          1    1      $3000       0,1,2</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">writes</span><span class="plain"> 14,13,12,11,10,9,8 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">Register</span><span class="plain"> </span><span class="identifier">B</span><span class="plain"> </span><span class="identifier">which</span><span class="plain">:</span>
    <span class="plain">;       - </span><span class="identifier">turns</span><span class="plain"> </span><span class="identifier">Caps</span><span class="plain"> </span><span class="identifier">Lock</span><span class="plain"> </span><span class="identifier">off</span><span class="plain">;</span>
    <span class="plain">;       - </span><span class="identifier">sets</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">scroll</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $3000;</span>
    <span class="plain">;       - </span><span class="identifier">enables</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">write</span><span class="plain">;</span>
    <span class="plain">;       - </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">read</span><span class="plain">/</span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain">;</span>
    <span class="plain">;       - </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">-</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">B</span>
        <span class="identifier">CPX</span><span class="plain"> #9                                              ;</span>
        <span class="identifier">BCS</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">X</span><span class="plain">&gt;=9) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span><span class="plain">)</span>

        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=9</span>
    <span class="plain">-</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">Start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">interrogate</span><span class="plain"> </span><span class="identifier">keyboard</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">interrogateKeyboard</span><span class="plain">                            ; </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> = 9...1 </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">reads</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">links</span><span class="plain"> 9-2 </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> (1):</span>
        <span class="identifier">CPX</span><span class="plain"> #$80                                            ; 9 = }</span>
                                                            <span class="plain">; 8 = } </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">startup</span>
                                                            <span class="plain">; 7 = }</span>
                                                            <span class="plain">; 6 = </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">reverse</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">action</span>
                                                            <span class="plain">; 5 = }</span>
                                                            <span class="plain">; 4 = } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">disc</span><span class="plain"> </span><span class="identifier">drive</span><span class="plain"> </span><span class="identifier">timings</span>
                                                            <span class="plain">; 3 = </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">used</span>
                                                            <span class="plain">; 2 = </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">used</span>
                                                            <span class="plain">; 1 = </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">MSB</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">loop</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> &gt; 0 </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">again</span>

                                                            <span class="plain">; </span><span class="identifier">At</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">Carry</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">) </span><span class="identifier">and</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain"> </span><span class="identifier">holds</span><span class="plain">:</span>
                                                            <span class="plain">; </span><span class="identifier">C</span><span class="plain"> = }</span>
                                                            <span class="plain">; 0 = } </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">startup</span>
                                                            <span class="plain">; 1 = }</span>
                                                            <span class="plain">; 2 = </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">reverse</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">action</span>
                                                            <span class="plain">; 3 = }</span>
                                                            <span class="plain">; 4 = } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">disc</span><span class="plain"> </span><span class="identifier">drive</span><span class="plain"> </span><span class="identifier">timings</span>
                                                            <span class="plain">; 5 = </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">used</span>
                                                            <span class="plain">; 6 = </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">used</span>
                                                            <span class="plain">; 7 = </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">key</span>

        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">lastResetType</span><span class="plain">                                  ; </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> = 0</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">now</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain">; .</span><span class="identifier">interruptAccumulator</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">links</span><span class="plain">:</span>
                                                            <span class="plain">; 0 = }</span>
                                                            <span class="plain">; 1 = } </span><span class="identifier">screen</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">startup</span>
                                                            <span class="plain">; 2 = }</span>
                                                            <span class="plain">; 3 = </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">reverse</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">action</span>
                                                            <span class="plain">; 4 = }</span>
                                                            <span class="plain">; 5 = } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">disc</span><span class="plain"> </span><span class="identifier">drive</span><span class="plain"> </span><span class="identifier">timings</span>
                                                            <span class="plain">; 6 = </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">used</span>
                                                            <span class="plain">; 7 = </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">used</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">keyboardIndicators</span><span class="plain">                             ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">LEDs</span><span class="plain">. </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> (</span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">key</span><span class="plain">) </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">key</span><span class="plain">) </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">flag</span>

        <span class="plain">; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">page</span><span class="plain"> 2 </span><span class="identifier">based</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">type</span>
        <span class="identifier">LDX</span><span class="plain"> #&lt;.</span><span class="identifier">softResetLWM</span><span class="plain">                                 ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">water</span><span class="plain"> </span><span class="identifier">mark</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> (</span><span class="identifier">writes</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> $200+</span><span class="identifier">X</span><span class="plain"> -&gt; $2</span><span class="identifier">FF</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">powerOnResetHWM</span><span class="plain"> - .</span><span class="identifier">defaultVectorTable</span><span class="plain">         ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">water</span><span class="plain"> </span><span class="identifier">mark</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> (</span><span class="identifier">writes</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> $200+</span><span class="identifier">Y</span><span class="plain"> -&gt; $0200)</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> .</span><span class="identifier">systemViaInterruptEnableRegister</span><span class="plain"> </span><span class="identifier">shifted</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">once</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain">=0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">power</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain">, </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=$9</span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">=$8</span><span class="identifier">D</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">softResetHWM</span><span class="plain"> - .</span><span class="identifier">defaultVectorTable</span><span class="plain">            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">HWM</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">setUpPage2</span><span class="plain">                                     ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">hardResetHWM</span><span class="plain"> - .</span><span class="identifier">defaultVectorTable</span><span class="plain">            ; </span><span class="identifier">hard</span><span class="plain"> </span><span class="identifier">reset</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">lastResetType</span><span class="plain">                                  ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">=1</span>
    <span class="plain">+</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">lastResetType</span><span class="plain">                                  ; </span><span class="character">'power on'</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">hard</span><span class="plain"> </span><span class="identifier">reset</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">links</span><span class="plain"> </span><span class="identifier">set</span>
        <span class="identifier">EOR</span><span class="plain"> #%11111111                                      ; </span><span class="identifier">invert</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">bits</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">startUpOptions</span><span class="plain">                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">record</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">options</span>
        <span class="identifier">LDX</span><span class="plain"> #&lt;.</span><span class="identifier">hardResetLWM</span><span class="plain">                                 ;</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       .</span><span class="identifier">lastResetType</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">;        0    </span><span class="identifier">Soft</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain">    </span><span class="identifier">X</span><span class="plain">=&lt;.</span><span class="identifier">softResetLWM</span><span class="plain">    </span><span class="identifier">Y</span><span class="plain">=.</span><span class="identifier">softResetHWM</span><span class="plain">    - .</span><span class="identifier">defaultVectorTable</span>
    <span class="plain">;        1    </span><span class="identifier">Power</span><span class="plain"> </span><span class="identifier">on</span><span class="plain">      </span><span class="identifier">X</span><span class="plain">=&lt;.</span><span class="identifier">hardResetLWM</span><span class="plain">    </span><span class="identifier">Y</span><span class="plain">=.</span><span class="identifier">powerOnResetHWM</span><span class="plain"> - .</span><span class="identifier">defaultVectorTable</span>
    <span class="plain">;        2    </span><span class="identifier">Hard</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain">    </span><span class="identifier">X</span><span class="plain">=&lt;.</span><span class="identifier">hardResetLWM</span><span class="plain">    </span><span class="identifier">Y</span><span class="plain">=.</span><span class="identifier">hardResetHWM</span><span class="plain">    - .</span><span class="identifier">defaultVectorTable</span>
    <span class="plain">;</span>
    <span class="plain">;   - </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $200+</span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> 255</span>
    <span class="plain">;   - </span><span class="identifier">Copy</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">variables</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> $0200+</span><span class="identifier">Y</span><span class="plain">-1 </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">below</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">defaultVectorTable</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setUpPage2</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
    <span class="plain">-</span>
        <span class="identifier">CPX</span><span class="plain"> #$</span><span class="identifier">CE</span><span class="plain">                                            ; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">writes</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">addresses</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> $0290/</span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $02</span><span class="identifier">CD</span><span class="plain">...</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ;</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; ... </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">writes</span><span class="plain"> 255 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">addresses</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> $02</span><span class="identifier">CE</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $02</span><span class="identifier">FF</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">page2Start</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                   ;</span>
        <span class="identifier">INX</span><span class="plain">                                                 ;</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>
                                                            <span class="plain">; </span><span class="identifier">At</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FF</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=0</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">userViaDataDirectionRegisterA</span><span class="plain">                  ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">port</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">outputs</span><span class="plain"> (</span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">out</span><span class="plain">)</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">LDX</span><span class="plain"> #$</span><span class="identifier">E2</span><span class="plain">                                            ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> $00,</span><span class="identifier">X</span><span class="plain">                                           ; }</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; } </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">stores</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">-</span><span class="identifier">page</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">locations</span><span class="plain"> $</span><span class="identifier">E2</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $</span><span class="identifier">FF</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; }</span>

        <span class="plain">; ***********************************************************************************</span>
        <span class="plain">; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">vectors</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">MOS</span><span class="plain"> </span><span class="identifier">vectors</span><span class="plain">.</span>
        <span class="plain">; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> (</span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">above</span><span class="plain">, </span><span class="identifier">depending</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">boot</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">).</span>
        <span class="plain">; ***********************************************************************************</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">defaultVectorTable</span><span class="plain"> - 1,</span><span class="identifier">Y</span><span class="plain">                       ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">table</span><span class="plain">+</span><span class="identifier">Y</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">page2Start</span><span class="plain"> - 1,</span><span class="identifier">Y</span><span class="plain">                               ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $0200+</span><span class="identifier">Y</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span>

        <span class="plain">; ***********************************************************************************</span>
        <span class="plain">; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">SPACE</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">variable</span>
        <span class="plain">; ***********************************************************************************</span>
        <span class="identifier">LDA</span><span class="plain"> #.</span><span class="identifier">internalKeyNumberSPACE</span><span class="plain">                        ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; } </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">SPACE</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setupACIA</span><span class="plain">                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">ACIA</span>
                                                            <span class="plain">; </span><span class="identifier">X</span><span class="plain">=0</span>

        <span class="plain">; ***********************************************************************************</span>
        <span class="plain">; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">registers</span>
        <span class="plain">; ***********************************************************************************</span>
        <span class="identifier">LDA</span><span class="plain"> #$7</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> (</span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">others</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain">)</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=1</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaInterruptFlagRegister</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">               ; </span><span class="identifier">Set</span><span class="plain"> .</span><span class="identifier">systemViaInterruptEnableRegister</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> .</span><span class="identifier">systemViaInterruptFlagRegister</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">userViaInterruptFlagRegister</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                 ; </span><span class="identifier">Set</span><span class="plain">   .</span><span class="identifier">userViaInterruptEnableRegister</span><span class="plain"> </span><span class="identifier">and</span><span class="plain">   .</span><span class="identifier">userViaInterruptFlagRegister</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">--</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> &gt;= 0</span>

        <span class="plain">; ***********************************************************************************</span>
        <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">initialising</span><span class="plain"> </span><span class="identifier">JIM</span><span class="plain"> </span><span class="identifier">device</span>
        <span class="plain">; ***********************************************************************************</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">briefly</span><span class="plain"> </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">anything</span><span class="plain"> </span><span class="identifier">pending</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">disallow</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> (</span><span class="identifier">N</span><span class="plain">.</span><span class="identifier">B</span><span class="plain">. </span><span class="identifier">All</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">IRQs</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">)</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6=1 (</span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">link</span><span class="plain"> 2)</span>
        <span class="identifier">BVC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">link</span><span class="plain"> 2 </span><span class="identifier">clear</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">over</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">instruction</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">jimPagedEntryJumper</span><span class="plain">                            ; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">calls</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">JIM</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">initialise</span><span class="plain"> </span><span class="identifier">JIM</span><span class="plain"> </span><span class="identifier">based</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain">)</span>
    <span class="plain">+</span>

        <span class="plain">; ***********************************************************************************</span>
        <span class="plain">; </span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">some</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="plain">; ***********************************************************************************</span>
        <span class="identifier">LDX</span><span class="plain"> #%11110010                                      ; </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">some</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain">:</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">systemViaInterruptEnableRegister</span><span class="plain">               ;   1   </span><span class="identifier">Vertical</span><span class="plain"> </span><span class="identifier">sync</span>
                                                            <span class="plain">;   4   </span><span class="identifier">Analogue</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">finished</span>
                                                            <span class="plain">;   5   </span><span class="identifier">T2</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> (</span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain">)</span>
                                                            <span class="plain">;   6   </span><span class="identifier">T1</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> (100</span><span class="identifier">Hz</span><span class="plain">)</span>
        <span class="identifier">LDX</span><span class="plain"> #%00000100                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">PCR</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">systemViaPeripheralControlRegister</span><span class="plain">             ; </span><span class="identifier">CA1</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">       (</span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">CA2</span><span class="plain"> </span><span class="identifier">positive</span><span class="plain"> </span><span class="identifier">edges</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> (</span><span class="identifier">keyboard</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">CB1</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">       (</span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">analogue</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">CB2</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">edges</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> (</span><span class="identifier">light</span><span class="plain"> </span><span class="identifier">pen</span><span class="plain"> </span><span class="identifier">strobe</span><span class="plain">)</span>

        <span class="identifier">LDA</span><span class="plain"> #%01100000                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">ACR</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaAuxilliaryControlRegister</span><span class="plain">             ; </span><span class="identifier">PA</span><span class="plain">/</span><span class="identifier">PB</span><span class="plain"> </span><span class="identifier">latch</span><span class="plain"> </span><span class="identifier">disable</span><span class="plain">; </span><span class="identifier">shift</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain"> (</span><span class="identifier">bits</span><span class="plain"> 0-4 = 0)</span>
                                                            <span class="plain">; </span><span class="identifier">timer</span><span class="plain"> 2 </span><span class="identifier">countdown</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">pulses</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">PB6</span><span class="plain">         (</span><span class="identifier">bit</span><span class="plain"> 5    = 1)</span>
                                                            <span class="plain">; </span><span class="identifier">timer</span><span class="plain"> 1 </span><span class="identifier">continuous</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain">; </span><span class="identifier">PB7</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">  (</span><span class="identifier">bit</span><span class="plain"> 6-7  = %01)</span>

        <span class="identifier">LDA</span><span class="plain"> #$0</span><span class="identifier">E</span><span class="plain">                                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">T1</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> (</span><span class="identifier">Low</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaT1LL</span><span class="plain">                                  ; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">becomes</span><span class="plain"> </span><span class="identifier">effective</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">T1</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">set</span>

        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">userViaPeripheralControlRegister</span><span class="plain">               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">PCR</span>
                                                            <span class="plain">; </span><span class="identifier">CA1</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> -</span><span class="identifier">ve</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">     (</span><span class="identifier">usually</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">Acknowledge</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">CA2</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">output</span><span class="plain">               (</span><span class="identifier">usually</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">strobe</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">CB1</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> -</span><span class="identifier">ve</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">     (</span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">port</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">CB2</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain"> </span><span class="identifier">edge</span><span class="plain">             (</span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">port</span><span class="plain">)</span>

        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">adcDataLatchAndConversionStartRegister</span><span class="plain">         ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">/</span><span class="identifier">D</span><span class="plain"> </span><span class="identifier">converter</span>
                                                            <span class="plain">; </span><span class="identifier">Bits</span><span class="plain"> 0 </span><span class="identifier">and</span><span class="plain"> 1 </span><span class="identifier">determine</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">selected</span>
                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 3=0 8 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 3=1 12 </span><span class="identifier">bit</span>

        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">userViaPeripheralControlRegister</span><span class="plain">               ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">IER</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">present</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">userVIAIRQBitMask</span><span class="plain">                              ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 0 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">interrupts</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> #$27                                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">T1</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> $27. </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">sets</span><span class="plain"> </span><span class="identifier">T1</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $270</span><span class="identifier">E</span><span class="plain"> (=9998 </span><span class="identifier">uS</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaT1LH</span><span class="plain">                                  ; </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">approximately</span><span class="plain"> </span><span class="identifier">every</span><span class="plain"> 100</span><span class="identifier">th</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">second</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaT1CH</span><span class="plain">                                  ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>

        <span class="plain">; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">sounds</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearSoundChannels</span><span class="plain">                             ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">channels</span>

        <span class="plain">; </span><span class="identifier">Initialise</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">ULA</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">serialULARegisterCopy</span><span class="plain">                          ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> (</span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">copy</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> #$7</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setSerialULADirectly</span><span class="plain">                           ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">ULA</span>

        <span class="plain">; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">function</span><span class="plain"> </span><span class="identifier">keys</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">softKeyConsistencyFlag</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">selectROMloop</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">keys</span><span class="plain"> </span><span class="identifier">OK</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte18EntryPoint</span><span class="plain">                             ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">function</span><span class="plain"> </span><span class="identifier">keys</span>

        <span class="plain">; ***********************************************************************************</span>
        <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">sideways</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">catalogue</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">their</span><span class="plain"> </span><span class="identifier">types</span>
        <span class="plain">; </span><span class="identifier">X</span><span class="plain">=0...15</span>
        <span class="plain">; ***********************************************************************************</span>
    <span class="plain">.</span><span class="identifier">selectROMloop</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">selectROM</span><span class="plain">                                      ; </span><span class="identifier">select</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">LDX</span><span class="plain"> #3                                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">romCopyrightOffsetPointer</span><span class="plain">                      ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">copyright</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">ROM</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">romStartAddress</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">copyrightString</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                              ; </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">noCopyright</span><span class="plain">                                    ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">copyright</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">ROM</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="string">")C("</span><span class="plain">,0 </span><span class="identifier">string</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">still</span><span class="plain"> +</span><span class="identifier">ve</span><span class="plain"> </span><span class="identifier">go</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span>
                                                            <span class="plain">; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">reached</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> 4 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">indicate</span><span class="plain"> </span><span class="identifier">valid</span><span class="plain"> </span><span class="identifier">ROM</span>

        <span class="plain">; ***********************************************************************************</span>
        <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> 1</span><span class="identifier">K</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">higher</span><span class="plain"> </span><span class="identifier">priority</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ensure</span><span class="plain"> </span><span class="identifier">that</span>
        <span class="plain">; </span><span class="identifier">there</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">matches</span><span class="plain">. </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">match</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">, </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="identifier">priority</span><span class="plain"> </span><span class="identifier">ROM</span>
        <span class="plain">; ***********************************************************************************</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span>

    <span class="plain">.</span><span class="identifier">nextROM</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span>
        <span class="identifier">CPY</span><span class="plain"> #16                                             ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> 16</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">romComparisonDone</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 16 </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">more</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">done</span><span class="plain"> </span><span class="identifier">checking</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">, </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">catalogue</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">EOR</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">invert</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span>
        <span class="identifier">LDA</span><span class="plain"> #$7</span><span class="identifier">F</span><span class="plain">                                            ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreFB</span><span class="plain">                                    ; } </span><span class="identifier">store</span><span class="plain"> $7</span><span class="identifier">F</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> .</span><span class="identifier">tempStoreFB</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> $7</span><span class="identifier">FFF</span><span class="plain">-</span><span class="identifier">Y</span>

    <span class="plain">.</span><span class="identifier">nextByteInROM</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">romSelectRegister</span><span class="plain">                              ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">map</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">tempStoreFA</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">romSelectRegister</span><span class="plain">                              ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">map</span>
        <span class="identifier">CMP</span><span class="plain"> (.</span><span class="identifier">tempStoreFA</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">called</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">nextROM</span><span class="plain">                                        ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">go</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain">)</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">increment</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">location</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">nextByteInROM</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> (.</span><span class="identifier">tempStoreFA</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">tempStoreFB</span><span class="plain">                                    ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">tempStoreFB</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">address</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreFB</span><span class="plain">                                    ; </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">CMP</span><span class="plain"> #$84                                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">reached</span><span class="plain"> $84 = $80 + (4*256 </span><span class="identifier">bytes</span><span class="plain">), </span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. 1</span><span class="identifier">k</span><span class="plain"> </span><span class="identifier">checked</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">nextByteInROM</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">checked</span><span class="plain"> 1</span><span class="identifier">k</span><span class="plain"> </span><span class="identifier">yet</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> 256 </span><span class="identifier">bytes</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">noCopyright</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ROM</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (+</span><span class="identifier">ve</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">romComparisonDone</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">romTypeByte</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">romTypeTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">catalogue</span>
        <span class="identifier">AND</span><span class="plain"> #$8</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">BASIC</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">basicROMNumber</span><span class="plain">                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain"> </span><span class="identifier">pointer</span>
    <span class="plain">+</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">ROM</span>
        <span class="identifier">CPX</span><span class="plain"> #16                                             ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> 15 </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">less</span><span class="plain">?</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">selectROMloop</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> (15 </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">less</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">back</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">)</span>

        <span class="plain">; ***********************************************************************************</span>
        <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">system</span>
        <span class="plain">; ***********************************************************************************</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">system</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">skipSpeech</span><span class="plain">                                     ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">set</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">don</span><span class="character">'t have speech system fitted)</span>

        <span class="character">DEC .speechSystemPresentFlag                        ; .speechSystemPresentFlag set to $FF to indicate speech present</span>

    <span class="character">-</span>
        <span class="character">LDY #$FF                                            ; Y=$FF</span>
        <span class="character">JSR .osbyte159EntryPoint                            ; initialise speech generator</span>
        <span class="character">DEX                                                 ; loop counter X from 16 to zero</span>
        <span class="character">BNE -                                               ; branch back unless zero</span>

        <span class="character">STX .systemViaT2CL                                  ; }</span>
        <span class="character">STX .systemViaT2CH                                  ; } set T2 timer for speech to zero</span>


    <span class="character">.skipSpeech</span>
        <span class="character">; Initialise screen</span>
        <span class="character">LDA .startUpOptions                                 ; get back start up options (bits 0-2 are mode)</span>
        <span class="character">JSR .initialiseScreen                               ; then jump to screen initialisation</span>

        <span class="character">; *KEY 10 facility (insert the KEY 10 character code into the keyboard buffer)</span>
        <span class="character">LDY #$CA                                            ; }</span>
        <span class="character">JSR .insertByteIntoKeyboardBuffer                   ; } enter $CA in keyboard buffer. This activates the *KEY 10 facility.</span>

        <span class="character">; if there'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">BOOT</span><span class="plain"> </span><span class="identifier">interception</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">execute</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> (</span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte247EntryPoint</span><span class="plain">                            ; </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">boot</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">present</span><span class="plain">, </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span>

        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setupTapeOptions</span><span class="plain">                               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">options</span>

        <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">Tube</span>
        <span class="identifier">LDA</span><span class="plain"> #%10000001                                      ; </span><span class="identifier">test</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">FIFO</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> 1</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tubeULAStatusRegister</span><span class="plain">                          ;</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tubeULAStatusRegister</span><span class="plain">                          ; </span><span class="identifier">test</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">presence</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallTubeMainInitialisation</span><span class="plain">          ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; } </span><span class="identifier">initialise</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> (</span><span class="identifier">issue</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">call</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">initialised</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">tubePresentFlag</span><span class="plain">                                ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">show</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">active</span>

    <span class="plain">+</span>
        <span class="identifier">LDY</span><span class="plain"> #$0</span><span class="identifier">E</span><span class="plain">                                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">PAGE</span><span class="plain">: $0</span><span class="identifier">E00</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallAbsoluteWorkspaceClaim</span><span class="plain">          ; </span><span class="identifier">issue</span><span class="plain"> </span><span class="identifier">claim</span><span class="plain"> </span><span class="identifier">absolute</span><span class="plain"> </span><span class="identifier">workspace</span><span class="plain"> </span><span class="identifier">call</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; </span><span class="identifier">via</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallPrivateWorkspaceClaim</span><span class="plain">           ; </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">private</span><span class="plain"> </span><span class="identifier">workspace</span><span class="plain"> </span><span class="identifier">claim</span><span class="plain"> </span><span class="identifier">call</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; </span><span class="identifier">via</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">defaultPAGE</span><span class="plain">                                    ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">primary</span><span class="plain"> </span><span class="identifier">OSHWM</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">currentPAGE</span><span class="plain">                                    ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OSHWM</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallTubeSystemPostInitialisation</span><span class="plain">    ; </span><span class="identifier">post</span><span class="plain"> </span><span class="identifier">initialisation</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> (</span><span class="identifier">issue</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">explode</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">etc</span><span class="plain">.)</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">tubePresentFlag</span><span class="plain">                                ; </span><span class="identifier">Y</span><span class="plain">=$</span><span class="identifier">FF</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">present</span><span class="plain"> </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span>

        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">startupMessageSuppressionAndBootOptions</span><span class="plain">        ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">post</span><span class="plain">-</span><span class="identifier">init</span><span class="plain"> </span><span class="identifier">AND</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> .</span><span class="identifier">startupMessageSuppressionAndBootOptions</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">continue</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">skipStartupMessage</span><span class="plain">                             ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">message</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">bootMessage</span><span class="plain"> - .</span><span class="identifier">vduBaseAddress</span><span class="plain"> - 1             ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">displayString</span><span class="plain">                                  ; </span><span class="identifier">output</span><span class="plain"> </span><span class="character">'BBC Computer '</span><span class="plain"> </span><span class="identifier">message</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">lastResetType</span><span class="plain">                                  ; 0=</span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain">, </span><span class="identifier">anything</span><span class="plain"> </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">continue</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">outputTwoNewlines</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">forward</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">bootMessageMemory32</span><span class="plain"> - .</span><span class="identifier">vduBaseAddress</span><span class="plain"> - 1     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 32</span><span class="identifier">k</span><span class="plain"> </span><span class="identifier">message</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">systemAvailableRAM</span><span class="plain">                             ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">available</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> ($40 = 16</span><span class="identifier">k</span><span class="plain">; $80 = 32</span><span class="identifier">k</span><span class="plain">)</span>
        <span class="identifier">BMI</span><span class="plain"> +                                               ; </span><span class="identifier">skip</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> 32</span><span class="identifier">k</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">bootMessageMemory16</span><span class="plain"> - .</span><span class="identifier">vduBaseAddress</span><span class="plain"> - 1     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 16</span><span class="identifier">K</span><span class="plain"> </span><span class="identifier">message</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">displayString</span><span class="plain">                                  ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="character">'16K'</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="character">'32K'</span>

    <span class="plain">.</span><span class="identifier">outputTwoNewlines</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">bootMessageEnding</span><span class="plain">  - .</span><span class="identifier">vduBaseAddress</span><span class="plain"> - 1      ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">newlines</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">displayString</span><span class="plain">                                  ;</span>

    <span class="plain">.</span><span class="identifier">skipStartupMessage</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte247EntryPoint</span><span class="plain">                            ; </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="reserved">break</span><span class="plain"> </span><span class="identifier">intercept</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">present</span><span class="plain"> (</span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte118EntryPoint</span><span class="plain">                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">LEDs</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">reflect</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">remember</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">nvbdizc</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=0000</span><span class="identifier">nvbd</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">startUpOptions</span><span class="plain">                                 ; </span><span class="identifier">EOR</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">options</span><span class="plain">, </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">particular</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">care</span><span class="plain"> </span><span class="identifier">about</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 3 (</span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">reverse</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">action</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> #8                                              ; </span><span class="identifier">isolate</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 3 </span><span class="identifier">only</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=0 (</span><span class="identifier">execute</span><span class="plain"> !</span><span class="identifier">BOOT</span><span class="plain">) </span><span class="identifier">or</span><span class="plain"> 8 (</span><span class="identifier">don</span><span class="character">'t execute !BOOT)</span>
        <span class="character">LDX #.romServiceCallAutoBoot                        ; service type = auto-boot call</span>
        <span class="character">JSR .osbyte143EntryPoint                            ; ask each ROM in turn if they want to handle it</span>
        <span class="character">BEQ .checkForFindingLanguageRom                     ; if a ROM accepts this call then branch (to enter language ROM)</span>
        <span class="character">TYA                                                 ; else put result from ROM (Y register) in A (to test if it'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">setTapeFSAndEnterLanguageROM</span><span class="plain">                   ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">!=0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #141                                            ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte141EntryPoint</span><span class="plain">                            ; } </span><span class="identifier">select</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>

        <span class="identifier">LDX</span><span class="plain"> #&lt;.</span><span class="identifier">runBootString</span><span class="plain">                                ;</span>
        <span class="identifier">LDY</span><span class="plain"> #&gt;.</span><span class="identifier">runBootString</span><span class="plain">                                ;</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">startupMessageSuppressionAndBootOptions</span><span class="plain">        ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSCLI</span><span class="plain">                                          ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">execute</span><span class="plain"> */!</span><span class="identifier">BOOT</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">startupMessageSuppressionAndBootOptions</span><span class="plain">        ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">checkForFindingLanguageRom</span><span class="plain">                     ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">setTapeFSAndEnterLanguageROM</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; }</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTapeOrRomFS</span><span class="plain">                                 ; }</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkForFindingLanguageRom</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">lastResetType</span><span class="plain">                                  ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">RESET</span><span class="plain"> </span><span class="identifier">Type</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">findBestLanguageROM</span><span class="plain">                            ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">languageRomNumber</span><span class="plain">                              ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">resetLanguageRom</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> +</span><span class="identifier">ve</span><span class="plain"> (</span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">available</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">search</span><span class="plain"> </span><span class="identifier">routine</span>

    <span class="plain">.</span><span class="identifier">findBestLanguageROM</span>
        <span class="identifier">LDX</span><span class="plain"> #15                                             ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">highest</span><span class="plain"> </span><span class="identifier">available</span><span class="plain"> </span><span class="identifier">rom</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">romTypeTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">map</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">resetLanguageRom</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> .</span><span class="identifier">resetLanguageRom</span>

        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">search</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=255</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ;</span>

        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">No</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">.</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">tubePresentFlag</span><span class="plain">                                ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">present</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">tubeCopyLanguageToSecondProcessorLocal</span><span class="plain">         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">brkNoLanguageError</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">F9</span><span class="plain">                                           ; </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"Language?"</span><span class="plain">,0                                 ; </span><span class="identifier">message</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">resetLanguageRom</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 142 - </span><span class="identifier">Enter</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> (</span><span class="identifier">at</span><span class="plain"> $8000)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">number</span>
    <span class="plain">;       </span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> </span><span class="identifier">call</span><span class="plain">;</span>
    <span class="plain">;       </span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">initialisation</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte142EntryPoint</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">languageRomNumber</span><span class="plain">                              ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">selectROM</span><span class="plain">                                      ; </span><span class="identifier">select</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">ROM</span>
        <span class="identifier">LDA</span><span class="plain"> #&gt;(.</span><span class="identifier">romTitleString</span><span class="plain"> - 1)                         ; } </span><span class="identifier">AY</span><span class="plain">=</span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">title</span><span class="plain"> </span><span class="identifier">string</span>
        <span class="identifier">LDY</span><span class="plain"> #&lt;(.</span><span class="identifier">romTitleString</span><span class="plain"> - 1)                         ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">displayStringAY</span><span class="plain">                                ; </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">held</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> .</span><span class="identifier">romTitleString</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">languageVersionString</span><span class="plain">                          ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> (</span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">string</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSNEWL</span><span class="plain">                                         ; </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">feeds</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSNEWL</span><span class="plain">                                         ; </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">output</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">LDA</span><span class="plain"> #1                                              ; </span><span class="identifier">A</span><span class="plain">=1 </span><span class="identifier">required</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">entry</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">tubePresentFlag</span><span class="plain">                                ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">exists</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">tubeCopyLanguageToSecondProcessorLocal</span><span class="plain">         ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">romLanguageEntry</span><span class="plain">                               ; </span><span class="identifier">enter</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $8000</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">tubeCopyLanguageToSecondProcessorLocal</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">tubeCopyLanguageToSecondProcessor</span><span class="plain">              ; </span><span class="identifier">enter</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">environment</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">given</span><span class="plain"> </span><span class="identifier">ROM</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;         </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span>
    <span class="plain">;   $</span><span class="identifier">F6</span><span class="plain">/$</span><span class="identifier">F7</span><span class="plain"> = </span><span class="identifier">address</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osrdrmEntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">romSelectRegister</span><span class="plain">                              ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">map</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">PHROM</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">romAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                              ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Select</span><span class="plain"> </span><span class="identifier">ROM</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (0-15)</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">selectROM</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">latch</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">romSelectRegister</span><span class="plain">                              ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">map</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>



    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 8
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 8: </span><span class="identifier">Interrupt</span><span class="plain"> </span><span class="identifier">processing</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Main</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">point</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Stack</span><span class="plain"> </span><span class="identifier">contains</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="reserved">register</span><span class="plain">; </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">program</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">mainIRQEntryPoint</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> (</span><span class="identifier">flags</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">AND</span><span class="plain"> #%00010000                                      ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">brkRoutine</span><span class="plain">                                     ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorIRQ1V</span><span class="plain">)                                  ; </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">IRQ1</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> (</span><span class="identifier">by</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">irq1Handler</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">brkRoutine</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; } </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">TSX</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> </span><span class="identifier">pointer</span>
        <span class="identifier">LDA</span><span class="plain"> $0103,</span><span class="identifier">X</span><span class="plain">                                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">program</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">CLD</span><span class="plain">                                                 ;</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">SBC</span><span class="plain"> #1                                              ; </span><span class="identifier">subtract</span><span class="plain"> 1</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">brkAddressLow</span><span class="plain">                                  ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">LDA</span><span class="plain"> $0104,</span><span class="identifier">X</span><span class="plain">                                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">SBC</span><span class="plain"> #0                                              ; </span><span class="identifier">subtract</span><span class="plain"> 1 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">necessary</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">brkAddressHigh</span><span class="plain">                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">ROM</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">romNumberActiveLastBRK</span><span class="plain">                         ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">stackPointerLastBRK</span><span class="plain">                            ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> </span><span class="identifier">pointer</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallBreakInstruction</span><span class="plain">                ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; } </span><span class="identifier">issue</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> 6 (</span><span class="identifier">Break</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">they</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">chance</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">respond</span><span class="plain">.</span>
                                                            <span class="plain">; </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> .</span><span class="identifier">brkAddressLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain"> </span><span class="identifier">points</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain">.</span>
                                                            <span class="plain">; </span><span class="identifier">ROMS</span><span class="plain"> </span><span class="identifier">may</span><span class="plain"> </span><span class="identifier">use</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">their</span><span class="plain"> </span><span class="identifier">own</span><span class="plain"> </span><span class="identifier">purposes</span>

        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">languageRomNumber</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">language</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">selectROM</span><span class="plain">                                      ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">activate</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ;</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorBRKV</span><span class="plain">)                                   ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">JUMP</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">BRKV</span><span class="plain"> (</span><span class="identifier">normally</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">language</span><span class="plain">)</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Default</span><span class="plain"> </span><span class="identifier">BRK</span><span class="plain"> </span><span class="identifier">handler</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">brkHandler</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">BRK</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printMessage</span><span class="plain">                                   ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">message</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">startupMessageSuppressionAndBootOptions</span><span class="plain">        ; } </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">means</span><span class="plain">: </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">machine</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> !</span><span class="identifier">BOOT</span><span class="plain"> </span><span class="identifier">errors</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">DISC</span><span class="plain"> (</span><span class="identifier">because</span><span class="plain"> </span><span class="identifier">e</span><span class="plain">.</span><span class="identifier">g</span><span class="plain">. </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">)</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; } </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span>
    <span class="plain">-</span>
        <span class="identifier">BCS</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">hang</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">machine</span><span class="plain">!</span>

        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSNEWL</span><span class="plain">                                         ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">newlines</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSNEWL</span><span class="plain">                                         ;</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">setTapeFSAndEnterLanguageROM</span><span class="plain">                   ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">speed</span><span class="plain"> </span><span class="identifier">before</span><span class="plain"> </span><span class="identifier">entering</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">language</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">rs423Handler</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">rs423ReadyFlag</span><span class="plain">                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">ready</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">rs423ControlRegisterCopy</span><span class="plain">                       ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> (</span><span class="identifier">aka</span><span class="plain"> </span><span class="identifier">CR7</span><span class="plain"> - </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">)</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">rs423SetRequestToSendInactive</span><span class="plain">                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">getRS423InputBufferFreeBytes</span><span class="plain">                   ; </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">subroutine</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">full</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 5 </span><span class="identifier">and</span><span class="plain"> 6 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span>
                                                            <span class="plain">; (</span><span class="identifier">aka</span><span class="plain"> </span><span class="identifier">CR5</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">CR6</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> 6850 </span><span class="identifier">datasheet</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="character">'Request To Send'</span><span class="plain"> </span><span class="identifier">pin</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">transmit</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">.</span>
                                                            <span class="plain">; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">state</span><span class="plain">.</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">rs423BufferSpaceOK</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">enough</span><span class="plain"> </span><span class="identifier">free</span><span class="plain"> </span><span class="identifier">space</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">rs423SetRequestToSendInactive</span>
        <span class="identifier">LDX</span><span class="plain"> #%01000000                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 5 </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span>
                                                            <span class="plain">; (                                        </span><span class="identifier">aka</span><span class="plain"> </span><span class="identifier">CR5</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">CR6</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> 6850 </span><span class="identifier">datasheet</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="character">'Request To Send'</span><span class="plain"> </span><span class="identifier">pin</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">transmit</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">.</span>
                                                            <span class="plain">; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">inactive</span><span class="plain"> </span><span class="identifier">state</span><span class="plain">.</span>
    <span class="plain">.</span><span class="identifier">rs423BufferSpaceOK</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">writeToBits5And6OfACIA</span><span class="plain">                         ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">ACIA</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readFromRS423</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">acia6850DataRegister</span><span class="plain">                           ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">ACIA</span>
        <span class="identifier">AND</span><span class="plain"> #$3</span><span class="identifier">A</span><span class="plain">                                            ; </span><span class="identifier">and</span><span class="plain"> %0011 1010</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">rs423ErrorDetected</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">rs423InputSuppressionFlag</span><span class="plain">                      ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">suppression</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">suppressed</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=1</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte153EntryPoint</span><span class="plain">                            ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">getRS423InputBufferFreeBytes</span><span class="plain">                   ; </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">rs423SetRequestToSendInactive</span><span class="plain">                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">free</span><span class="plain"> </span><span class="identifier">space</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">make</span><span class="plain"> </span><span class="character">'Request To Send'</span><span class="plain"> </span><span class="identifier">inactive</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">IRQ1</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">handler</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Note</span><span class="plain">: </span><span class="identifier">Enters</span><span class="plain"> </span><span class="identifier">here</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> .</span><span class="identifier">mainIRQEntryPoint</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">irq1Handler</span>
        <span class="identifier">CLD</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">decimal</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; }</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; } </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">onto</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>

        <span class="identifier">LDA</span><span class="plain"> #&gt;(.</span><span class="identifier">restoreRegistersAndReturnFromInterrupt</span><span class="plain">-1)   ; }</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; } </span><span class="identifier">push</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">onto</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">LDA</span><span class="plain"> #&lt;(.</span><span class="identifier">restoreRegistersAndReturnFromInterrupt</span><span class="plain">-1)   ; } </span><span class="identifier">RTS</span><span class="plain"> </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">now</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">restoreRegistersAndReturnFromInterrupt</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">CLV</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> (</span><span class="identifier">meaning</span><span class="plain">: </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">generated</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Two</span><span class="plain"> </span><span class="identifier">modes</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">operation</span><span class="plain"> (</span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">CLEAR</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">SET</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">CLEAR</span><span class="plain"> </span><span class="identifier">means</span><span class="plain"> (</span><span class="identifier">a</span><span class="plain">) </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">generated</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">;</span>
    <span class="plain">;                     (</span><span class="identifier">b</span><span class="plain">) </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">control</span><span class="plain">;</span>
    <span class="plain">;                 </span><span class="identifier">and</span><span class="plain"> (</span><span class="identifier">c</span><span class="plain">) </span><span class="identifier">give</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">Cassette</span><span class="plain"> </span><span class="identifier">Filing</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">attention</span>
    <span class="plain">;       </span><span class="identifier">V</span><span class="plain">  </span><span class="identifier">SET</span><span class="plain">  </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">just</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">needing</span><span class="plain"> </span><span class="identifier">attention</span>
    <span class="plain">.</span><span class="identifier">checkIfACIANeedsAttention</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">acia6850StatusRegister</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ACIA</span>
        <span class="identifier">BVS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">SET</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">don</span><span class="character">'t check the ACIA generated the interrupt)</span>
        <span class="character">BPL .irq1CheckVIA                                   ; if ACIA didn'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">generate</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">thing</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">rs423TimeoutCounter</span><span class="plain">                            ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">timeout</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">rs423HasControl</span><span class="plain">                                ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">timed</span><span class="plain"> </span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
                                                            <span class="plain">; </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">control</span>
        <span class="identifier">BVS</span><span class="plain"> .</span><span class="identifier">exit13</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="character">'V SET'</span><span class="plain"> </span><span class="identifier">mode</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">updateACIA</span><span class="plain">                                     ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">ACIA</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">rs423ErrorDetectedSetAY</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">acia6850DataRegister</span><span class="plain">                           ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">data</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ;</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ;</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">rs423ErrorDetected</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">shifted</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">once</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">received</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">eventRS423ErrorDetected</span><span class="plain">                       ; </span><span class="identifier">Y</span><span class="plain">=7</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">eventEntryPoint</span><span class="plain">                                ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">EVENT</span><span class="plain"> 7 </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">error</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">writeToACIA</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">bufferNumberRS423Output</span><span class="plain">                       ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte145EntryPoint</span><span class="plain">                            ; } </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">wasn</span><span class="character">'t empty) then branch forward</span>
        <span class="character">LDA .printerDestination                             ; read printer destination</span>
        <span class="character">CMP #2                                              ; is it serial printer?</span>
        <span class="character">BNE .rs423Handler                                   ; if not then branch (it must be RS423)</span>
        <span class="character">INX                                                 ; X=3 (.bufferNumberPrinter)</span>
        <span class="character">JSR .osbyte145EntryPoint                            ; read printer buffer</span>
        <span class="character">ROR .printerBufferEmptyFlag                         ; rotate to put carry (set if buffer is empty) into bit 7</span>
        <span class="character">BMI .rs423Handler                                   ; if (printer buffer is empty) then branch</span>
    <span class="character">+</span>
        <span class="character">STA .acia6850DataRegister                           ; pass either printer or RS423 data to ACIA</span>
        <span class="character">LDA #$E7                                            ; set timeout counter to stored value</span>
        <span class="character">STA .rs423TimeoutCounter                            ;</span>
    <span class="character">.exit13</span>
        <span class="character">RTS                                                 ; and exit</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; See NAUG Section 8.4 - Serial system interrupts (Page 126)</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       A = ACIA status byte</span>
    <span class="character">;</span>
    <span class="character">;       Two modes of operation:</span>
    <span class="character">;       V CLEAR - read from RS423; handle DCD; write to RS423; handle unrecognised interrupt</span>
    <span class="character">;       V SET   - handle DCD; write to RS423</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.rs423HasControl</span>
        <span class="character">AND .rs423IRQBitMask                                ; AND with ACIA bit mask (normally $FF)</span>
        <span class="character">LSR                                                 ; shift right to put bit 0 of ACIA status (receive interrupt) in carry</span>
        <span class="character">BCC +                                               ; if (not a receive interrupt) then branch (skip read)</span>
        <span class="character">BVS +                                               ; if (V SET mode) then branch (skip read)</span>
        <span class="character">LDY .rs423ControlRegisterCopy                       ; read copy of ACIA control register</span>
        <span class="character">BMI .readFromRS423                                  ; if (6850 interrupts enabled) then branch</span>
    <span class="character">+</span>
        <span class="character">LSR                                                 ; shift,  put bit 1 of ACIA status into carry</span>
        <span class="character">ROR                                                 ; rotate, put bit 2 of ACIA status into carry</span>
        <span class="character">BCS .rs423ErrorDetectedSetAY                        ; if (Data Carrier Detected interrupt) then branch</span>
        <span class="character">BMI .writeToACIA                                    ; if ACIA status bit 1 is set then branch (transmit interrupt)</span>
        <span class="character">BVS .exit13                                         ; if V SET then branch (exit)</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; When we have an interrupt that we don'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">understand</span><span class="plain">, </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span>
    <span class="plain">; </span><span class="identifier">they</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">it</span><span class="plain">. </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">not</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">IRQ2</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain">.</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">unrecognisedInterrupt</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallUnrecognisedInterrupt</span><span class="plain">           ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; } </span><span class="identifier">issue</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="character">'unrecognised interrupt'</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit13</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">recognises</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">exit</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">otherwise</span><span class="plain"> </span><span class="identifier">remove</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ;</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">, </span><span class="identifier">X</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ;</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ;</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ;</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; .</span><span class="identifier">interruptAccumulator</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorIRQ2V</span><span class="plain">)                                  ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">offer</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">IRQ2V</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">, </span><span class="identifier">particularly</span><span class="plain"> </span><span class="identifier">VSYNC</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">deal</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">it</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">irq1CheckVIA</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">systemViaInterruptFlagRegister</span><span class="plain">                 ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">irq1CheckPrinter</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">caused</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">try</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">thing</span><span class="plain">)</span>

        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">systemVIAIRQBitMask</span><span class="plain">                            ; </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">mask</span><span class="plain"> (</span><span class="identifier">normally</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">systemViaInterruptEnableRegister</span><span class="plain">               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">enable</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; } </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">twice</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain"> 1 (</span><span class="identifier">vsync</span><span class="plain">)</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; } </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">only</span><span class="plain"> </span><span class="identifier">type</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">interested</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">here</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">irq1CheckSpeech</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">vsync</span><span class="plain">), </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">speech</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">verticalSyncCounter</span><span class="plain">                            ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">rs423TimeoutCounter</span><span class="plain">                            ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">Timeout</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">positive</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">rs423TimeoutCounter</span><span class="plain">                            ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">videoULAFlashingColourIntervalCount</span><span class="plain">            ; </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">flash</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">doneFlashingColours</span><span class="plain">                            ; </span><span class="reserved">if</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">use</span><span class="plain">, </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">videoULAFlashingColourIntervalCount</span><span class="plain">            ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">doneFlashingColours</span><span class="plain">                            ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">non</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">time</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">flash</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="reserved">continue</span><span class="plain"> </span><span class="identifier">processing</span><span class="plain">)</span>

        <span class="plain">; </span><span class="identifier">ready</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">flash</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">videoULAFirstFlashingColourInterval</span><span class="plain">            ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">period</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">videoULAVideoControlRegisterCopy</span><span class="plain">               ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">VIDEO</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">C</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">restoreAndFlipBit</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">effect</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">videoULASecondFlashingColourInterval</span><span class="plain">           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">colour</span><span class="plain"> </span><span class="identifier">period</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
    <span class="plain">.</span><span class="identifier">restoreAndFlipBit</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">bit</span>
        <span class="identifier">EOR</span><span class="plain"> #1                                              ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">invert</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setVideoULA</span><span class="plain">                                    ; </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">change</span><span class="plain"> </span><span class="identifier">colour</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">videoULAFlashingColourIntervalCount</span><span class="plain">            ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">flash</span>

    <span class="plain">.</span><span class="identifier">doneFlashingColours</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">eventStartOfVSync</span><span class="plain">                             ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">event</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">: </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">vsync</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">eventEntryPoint</span><span class="plain">                                ; </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">event</span>
        <span class="identifier">LDA</span><span class="plain"> #%00000010                                      ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">vsync</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">storeToSystemVIAIFR</span><span class="plain">                            ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">Printer</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> (</span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">USER</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain">) </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">deal</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">it</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">irq1CheckPrinter</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">userViaInterruptFlagRegister</span><span class="plain">                   ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">USER</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">unrecognisedInterrupt</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">USER</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">did</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">userVIAIRQBitMask</span><span class="plain">                              ; }</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">userViaInterruptEnableRegister</span><span class="plain">                 ; }</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; } </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">USER</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1 </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">)</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">unrecognisedInterrupt</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">printerDestination</span><span class="plain">                             ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">type</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">unrecognisedInterrupt</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">parallel</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #%00000010                                      ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1 (</span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">userViaInterruptFlagRegister</span><span class="plain">                   ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">userViaInterruptEnableRegister</span><span class="plain">                 ; </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">bufferNumberPrinter</span><span class="plain">                           ; }</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">openPrinterChannel</span><span class="plain">                             ; } </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">parallel</span><span class="plain"> </span><span class="identifier">printer</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">Speech</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> (</span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain">) </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">deal</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">it</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">shifted</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">twice</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">irq1CheckSpeech</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; }</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; } </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">twice</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">alignment</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">bits</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 5 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">irq1Check100HzTimer</span><span class="plain">                            ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 5 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">IFR</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">it</span><span class="character">'s not timer 2, used for this speech interrupt routine) then branch</span>

        <span class="character">LDA #%00100000                                      ; }</span>
        <span class="character">LDX #0                                              ; } clear bit 5 (the timer 2 interrupt)</span>
        <span class="character">STA .systemViaInterruptFlagRegister                 ; }</span>
        <span class="character">STX .systemViaT2CH                                  ; zero the high byte of timer 2</span>

    <span class="character">.updateSpeech</span>
        <span class="character">LDX #8                                              ; }</span>
        <span class="character">STX .tempStoreFB                                    ; } loop counter (shifted right on each loop iteration)</span>
    <span class="character">.speechLoop</span>
        <span class="character">JSR .osbyte152EntryPoint                            ; and examine buffer status for buffer 8 (speech buffer) C set if buffer is empty</span>
        <span class="character">ROR .speechBufferEmptyFlag                          ; shift carry into bit 7 - store as the speech buffer empty</span>
        <span class="character">BMI .exit14                                         ; and if top bit is set (set buffer is empty) then branch (return)</span>
        <span class="character">TAY                                                 ; Y=A = next byte to be removed from speech buffer</span>
        <span class="character">BEQ +                                               ;</span>
        <span class="character">JSR .osbyte158EntryPoint                            ; read byte from speech chip</span>
        <span class="character">BMI .exit14                                         ; if negative exit</span>
    <span class="character">+</span>
        <span class="character">JSR .osbyte145EntryPoint                            ; else get a byte from buffer</span>
        <span class="character">STA .currentLogicalSpeechPHROMOrROMFSNumber         ; store it to indicate speech or file rom</span>
        <span class="character">JSR .osbyte145EntryPoint                            ; get another byte</span>
        <span class="character">STA .romAddressHigh                                 ; store it</span>
        <span class="character">JSR .osbyte145EntryPoint                            ; and another</span>
        <span class="character">STA .romAddressLow                                  ; giving address to be accessed in paged ROM</span>
        <span class="character">LDY .currentLogicalSpeechPHROMOrROMFSNumber         ; Y=.currentLogicalSpeechPHROMOrROMFSNumber</span>
        <span class="character">BEQ .writeROMAddressToSpeechProcessor               ; if current logical speech PHROM or ROMFS Number is zero then branch ()</span>
        <span class="character">BPL .writeCommandAndAddressToSpeechProcessor        ; if +ve then branch</span>
        <span class="character">BIT .currentLogicalSpeechPHROMOrROMFSNumber         ; check bit 6 of .currentLogicalSpeechPHROMOrROMFSNumber</span>
        <span class="character">BVS +                                               ; if set (.currentLogicalSpeechPHROMOrROMFSNumber)&gt;=$40) then branch</span>
        <span class="character">JSR .writeAddressToSpeechProcessor                  ; else continue for more speech processing</span>
        <span class="character">BVC .enableOrDisableSpeech                          ; if bit 6 clear then branch</span>
    <span class="character">+</span>
        <span class="character">ASL .romAddressLow                                  ; else double ROM address</span>
        <span class="character">ROL .romAddressHigh                                 ;</span>
        <span class="character">JSR .readFromPHROM                                  ; and call .readFromPHROM</span>

    <span class="character">.enableOrDisableSpeech</span>
        <span class="character">LDY .speechSuppressionStatus                        ; get speech enable/disable flag into Y</span>
        <span class="character">JMP .osbyte159EntryPoint                            ; and JMP to *fx 159</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.writeCommandAndAddressToSpeechProcessor</span>
        <span class="character">JSR .osbyte159EntryPoint                            ; Call *FX 159</span>

    <span class="character">.writeROMAddressToSpeechProcessor</span>
        <span class="character">LDY .romAddressLow                                  ; get address pointer in Y</span>
        <span class="character">JSR .osbyte159EntryPoint                            ;</span>
        <span class="character">LDY .romAddressHigh                                 ; get address pointer high in Y</span>
        <span class="character">JSR .osbyte159EntryPoint                            ;</span>
        <span class="character">LSR .tempStoreFB                                    ;</span>
        <span class="character">BNE .speechLoop                                     ;</span>
    <span class="character">.exit14</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; System Interrupt six - 100Hz interrupt</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.irq1Check100HzTimer</span>
        <span class="character">BCC .irq1CheckADCEndConversion                      ; bit 6 is in carry. if (there is no bit 6 interrupt) then branch</span>
        <span class="character">LDA #%01000000                                      ; }</span>
        <span class="character">STA .systemViaInterruptFlagRegister                 ; } clear interrupt 6</span>

        <span class="character">; Update timers. There are 2 timer stores, at .timeClockA and .timeClockB. These are updated by</span>
        <span class="character">; adding 1 to the current timer and storing the result in the other, the direction of</span>
        <span class="character">; transfer being changed each time of update.  This ensures that at least 1 timer is</span>
        <span class="character">; valid at any call as the current timer is only read.  Other methods would cause</span>
        <span class="character">; inaccuracies if a timer was read whilst being updated.</span>
        <span class="character">LDA .timeClockSwitch                                ; get current system clock pointer (5 or 10)</span>
        <span class="character">TAX                                                 ; put old system clock pointer in X</span>
        <span class="character">EOR #$0F                                            ; invert bits so it toggles between 5 and 10</span>
        <span class="character">PHA                                                 ; remember A</span>
        <span class="character">TAY                                                 ; put new system clock pointer in Y</span>
    <span class="character">-</span>
        <span class="character">LDA .timeClockA-1,X                                 ; get current system clock value</span>
        <span class="character">ADC #0                                              ; increment it (carry is set on the first iteration of the loop,</span>
                                                            <span class="character">;     thereafter carry is set as needed based on this increment)</span>
        <span class="character">STA .timeClockA-1,Y                                 ; store result in new copy</span>
        <span class="character">DEX                                                 ; decrement X</span>
        <span class="character">BEQ +                                               ; if 0 exit</span>
        <span class="character">DEY                                                 ; else decrement Y</span>
        <span class="character">BNE -                                               ; and go back and do next byte</span>
    <span class="character">+</span>
        <span class="character">PLA                                                 ; get back new clock pointer</span>
        <span class="character">STA .timeClockSwitch                                ; and store back in clock pointer</span>

        <span class="character">; Update countdown interval timer. An EVENT is generated when it times out.</span>
        <span class="character">LDX #5                                              ; set loop counter</span>
    <span class="character">-</span>
        <span class="character">INC .countdownIntervalTimer - 1,X                   ; increment byte for countdown timer</span>
        <span class="character">BNE +                                               ; if (done updating timer bytes) then branch</span>
        <span class="character">DEX                                                 ; else decrement loop counter</span>
        <span class="character">BNE -                                               ; if (not finished looping) do it again</span>

        <span class="character">LDY #.eventIntervalTimerCrossingZero                ; at this point all the interval timer bytes are zero</span>
        <span class="character">JSR .eventEntryPoint                                ; call EVENT 5 interval timer</span>

        <span class="character">; Update INKEY timeout. Used when reading a key within a time limit.</span>
    <span class="character">+</span>
        <span class="character">LDA .inkeyTimeoutCounterLow                         ; get low byte of inkey countdown timer</span>
        <span class="character">BNE +                                               ; if (inkey timer is non-zero) then branch forward</span>
        <span class="character">LDA .inkeyTimeoutCounterHigh                        ; get high byte of inkey countdown timer</span>
        <span class="character">BEQ ++                                              ; if (inkey timer is zero) then branch forward</span>
        <span class="character">DEC .inkeyTimeoutCounterHigh                        ; decrement high byte</span>
    <span class="character">+</span>
        <span class="character">DEC .inkeyTimeoutCounterLow                         ; and decrement low byte</span>

        <span class="character">; Update sound.</span>
    <span class="character">++</span>
        <span class="character">BIT .soundSemaphore                                 ; check bit 7 of sound semaphore</span>
                                                            <span class="character">; (this bit is set while processing sound interrupt.</span>
                                                            <span class="character">; check so we don'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">try</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">process</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">sound</span>
                                                            <span class="plain">; </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="reserved">while</span><span class="plain"> </span><span class="identifier">still</span><span class="plain"> </span><span class="identifier">processing</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">first</span><span class="plain">)</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">; </span><span class="identifier">still</span><span class="plain"> </span><span class="identifier">processing</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">forward</span><span class="plain">)</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">soundSemaphore</span><span class="plain">                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 0 (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">signify</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">processed</span><span class="plain"> </span><span class="identifier">here</span><span class="plain">)</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">briefly</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">processSoundInterrupt</span><span class="plain">                          ; </span><span class="identifier">process</span><span class="plain"> </span><span class="identifier">sound</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">soundSemaphore</span><span class="plain">                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">semaphore</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $</span><span class="identifier">FF</span>
                                                            <span class="plain">; (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">signifies</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">done</span><span class="plain"> </span><span class="identifier">processing</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain">)</span>

        <span class="plain">; </span><span class="identifier">Update</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain">.</span>
    <span class="plain">+</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">speechBufferEmptyFlag</span><span class="plain">                          ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">busy</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BMI</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain">, </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">routine</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte158EntryPoint</span><span class="plain">                            ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">EOR</span><span class="plain"> #%10100000                                      ; </span><span class="identifier">flip</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span>
        <span class="identifier">CMP</span><span class="plain"> #%01100000                                      ; </span><span class="identifier">check</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> &lt; $60 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">updateSpeech</span><span class="plain">                                   ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">process</span><span class="plain"> </span><span class="identifier">speech</span>

        <span class="plain">; </span><span class="identifier">Update</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain">.</span>
    <span class="plain">+</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">allBitsSet</span><span class="plain">                                     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkIfACIANeedsAttention</span><span class="plain">                      ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">needs</span><span class="plain"> </span><span class="identifier">attention</span>

        <span class="plain">; </span><span class="identifier">Update</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain">.</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; }</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; } </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">OR</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">been</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">keyboardSemaphore</span><span class="plain">                              ; </span><span class="identifier">ignore</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">semaphore</span><span class="plain"> </span><span class="identifier">says</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 0 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">ignored</span><span class="plain">, </span><span class="reserved">else</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain">)</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">keyboardInterruptRoutine</span><span class="plain">                       ; </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">interrupt</span>

        <span class="plain">; </span><span class="identifier">Update</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain">.</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printerServiceCallIfNotEmpty</span><span class="plain">                   ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span>

        <span class="plain">; </span><span class="identifier">Update</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain">.</span>

        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">adcDataLatchAndConversionStartRegister</span><span class="plain">         ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">BVS</span><span class="plain"> .</span><span class="identifier">handleADCConversionEnds</span><span class="plain">                        ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">busy</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">Interrupt</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> - </span><span class="identifier">Analogue</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">Digital</span><span class="plain"> </span><span class="identifier">Conversion</span><span class="plain"> (</span><span class="identifier">End</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">Conversion</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">irq1CheckADCEndConversion</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 4 </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">systemViaInterruptFlagRegister</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">irq1CheckKeyboard</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">handleADCConversionEnds</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">adcCurrentChannel</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">channel</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">clearInterrupt4</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>

        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">adcDataLowByte</span><span class="plain">                                 ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">lowByteLastByteFromADCChannel1</span><span class="plain"> - 1,</span><span class="identifier">X</span><span class="plain">           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">adcDataHighByte</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">highByteLastByteFromADCChannel1</span><span class="plain"> - 1,</span><span class="identifier">X</span><span class="plain">          ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">analogueSystemFlag</span><span class="plain">                             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">Analogue</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">marking</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">channel</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">eventADCConversionComplete</span><span class="plain">                    ; </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">event</span><span class="plain"> 3 </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">complete</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">eventEntryPoint</span><span class="plain">                                ;</span>

        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=0</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">maximumADCChannelNumber</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">highest</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">present</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">startADCConversion</span><span class="plain">                             ; </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">conversion</span>
    <span class="plain">.</span><span class="identifier">clearInterrupt4</span>
        <span class="identifier">LDA</span><span class="plain"> #%00010000                                      ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> 4</span>
    <span class="plain">.</span><span class="identifier">storeToSystemVIAIFR</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaInterruptFlagRegister</span><span class="plain">                 ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">Interrupt</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> - </span><span class="identifier">keyboard</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">irq1CheckKeyboard</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">position</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ;</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ;</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ;</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">interrupt</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">keyboardInterruptRoutine</span><span class="plain">                       ; </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">keyboard</span>
        <span class="identifier">LDA</span><span class="plain"> #%00000001                                      ; }</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">storeToSystemVIAIFR</span><span class="plain">                            ; } </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> 0 </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">+</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">unrecognisedInterrupt</span><span class="plain">                          ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">restoreRegistersAndReturnFromInterrupt</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">registers</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ;</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ;</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ;</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Default</span><span class="plain"> </span><span class="identifier">IRQ2</span><span class="plain"> </span><span class="identifier">handler</span><span class="plain"> - </span><span class="identifier">does</span><span class="plain"> </span><span class="identifier">nothing</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">irq2Handler</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">interruptAccumulator</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">RTI</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">calling</span><span class="plain"> </span><span class="identifier">routine</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 9
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 9: </span><span class="identifier">Keyboard</span><span class="plain"> </span><span class="identifier">reading</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">conversion</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 17   </span><span class="identifier">Start</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">conversion</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">channel</span><span class="plain"> (0-4)</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte17EntryPoint</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">analogueSystemFlag</span><span class="plain">                             ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">finish</span><span class="plain"> </span><span class="identifier">conversion</span>
    <span class="plain">.</span><span class="identifier">startADCConversion</span>
        <span class="identifier">CPX</span><span class="plain"> #5                                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">&lt;4 </span><span class="identifier">then</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ;</span>
        <span class="identifier">LDX</span><span class="plain"> #4                                              ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=4</span>
    <span class="plain">+</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">adcCurrentChannel</span><span class="plain">                              ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ADC</span><span class="plain"> </span><span class="identifier">channel</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">adcConversionType</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">conversion</span><span class="plain"> </span><span class="identifier">type</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">AND</span><span class="plain"> #%00001000                                      ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> 8</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">adcCurrentChannel</span><span class="plain">                              ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ADC</span>
        <span class="identifier">SBC</span><span class="plain"> #0                                              ; -1</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">adcDataLatchAndConversionStartRegister</span><span class="plain">         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">/</span><span class="identifier">D</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">panel</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">page</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">vduBaseAddress</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> -1</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">displayString</span>
        <span class="identifier">LDA</span><span class="plain"> #&gt;.</span><span class="identifier">vduBaseAddress</span><span class="plain">                               ; </span><span class="identifier">Start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">area</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">displayStringAY</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">displayStringAddressHigh</span><span class="plain">                       ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">Low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> (</span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">use</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">index</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">correct</span><span class="plain"> </span><span class="identifier">string</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">displayStringAddressLow</span><span class="plain">                        ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">loop</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">printMessage</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">string</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">displayStringAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                    ; </span><span class="identifier">pointed</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> $</span><span class="identifier">FD</span><span class="plain">/</span><span class="identifier">E</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSASCI</span><span class="plain">                                         ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">expanding</span><span class="plain"> </span><span class="identifier">Carriage</span><span class="plain"> </span><span class="identifier">returns</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">printMessage</span><span class="plain">                                   ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">X</span><span class="plain">/</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">holds</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">time</span><span class="plain"> </span><span class="identifier">limit</span>
    <span class="plain">.</span><span class="identifier">osbyte129Timed</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">inkeyTimeoutCounterLow</span><span class="plain">                         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">time</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">INKEY</span><span class="plain"> </span><span class="identifier">countdown</span><span class="plain"> </span><span class="identifier">timer</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">inkeyTimeoutCounterHigh</span><span class="plain">                        ; </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">decremented</span><span class="plain"> </span><span class="identifier">every</span><span class="plain"> 10</span><span class="identifier">ms</span>
        <span class="identifier">LDA</span><span class="plain"> #255                                            ;</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">readCharacterTimed</span><span class="plain">                             ; </span><span class="identifier">ALWAYS</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSRDCH</span><span class="plain"> - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">character</span>
    <span class="plain">;       </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">reads</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> *</span><span class="identifier">EXEC</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">otherwise</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osrdchEntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ;</span>
    <span class="plain">.</span><span class="identifier">readCharacterTimed</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">readCharacterTimedFlag</span><span class="plain">                         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (0 </span><span class="identifier">or</span><span class="plain"> 255) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">indicate</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">it</span><span class="character">'s a timed read</span>
        <span class="character">TXA                                                 ; }</span>
        <span class="character">PHA                                                 ; }</span>
        <span class="character">TYA                                                 ; } store X and Y</span>
        <span class="character">PHA                                                 ; }</span>
        <span class="character">LDY .execFileHandle                                 ; get *EXEC file handle</span>
        <span class="character">BEQ +                                               ; if 0 (not allocated) then branch</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">ROR .tapeCritical                                   ; set bit 7 of CFS active flag to prevent clashes</span>
        <span class="character">JSR .OSBGET                                         ; get a byte from the file</span>
        <span class="character">PHP                                                 ; push processor flags to preserve carry</span>
        <span class="character">LSR .tapeCritical                                   ; clear .tapeCritical flag</span>
        <span class="character">PLP                                                 ; get back flags</span>
        <span class="character">BCC .pullAndReturn                                  ; if carry clear (character found) then branch (recall values and exit)</span>
        <span class="character">LDA #0                                              ; error reading from file, so close the file</span>
        <span class="character">STA .execFileHandle                                 ; store it in exec file handle</span>
        <span class="character">JSR .OSFIND                                         ; and close file via OSFIND</span>
    <span class="character">+</span>
    <span class="character">-</span>
        <span class="character">BIT .escapeFlag                                     ; check ESCAPE flag</span>
        <span class="character">BMI .setEscapeConditionAndExit                      ; if ESCAPE flag set then branch (set escape condition and exit)</span>
        <span class="character">LDX .currentInputBuffer                             ; get current input buffer number</span>
        <span class="character">JSR .readFromEconetOrSoftKeyOrInputBufferA          ; get a byte from current input buffer</span>
        <span class="character">BCC .pullAndReturn                                  ; and exit if valid character found</span>

    <span class="character">.checkForTiming</span>
        <span class="character">BIT .readCharacterTimedFlag                         ; check for timed read</span>
        <span class="character">BVC -                                               ; if this is not timed go back and</span>
                                                            <span class="character">; read byte from input buffer again</span>
        <span class="character">LDA .inkeyTimeoutCounterLow                         ; check timers</span>
        <span class="character">ORA .inkeyTimeoutCounterHigh                        ;</span>
        <span class="character">BNE -                                               ; and if timer is not zero then branch back and keep trying to read</span>
        <span class="character">BCS +                                               ; if timed out, then branch (exit without storing character read)</span>

    <span class="character">.setEscapeConditionAndExit</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">LDA #.charESCAPE                                    ; ESCAPE character read</span>
        <span class="character">; fall through...</span>

    <span class="character">.pullAndReturn</span>
        <span class="character">STA .readCharacterTimedFlag                         ; remember character read</span>
    <span class="character">+</span>
        <span class="character">PLA                                                 ; }</span>
        <span class="character">TAY                                                 ; } restore X,Y</span>
        <span class="character">PLA                                                 ; }</span>
        <span class="character">TAX                                                 ; }</span>
        <span class="character">LDA .readCharacterTimedFlag                         ; recall character read</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
</pre>

<p class="inwebparagraph">Chapter 10
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 10: </span><span class="identifier">Command</span><span class="plain"> </span><span class="identifier">Line</span><span class="plain"> </span><span class="identifier">Interpreter</span><span class="plain"> (</span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">commands</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">copyrightString</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">")C("</span><span class="plain">,0                                       ; </span><span class="identifier">Copyright</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> (</span><span class="identifier">backwards</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">starCommandTable</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"."</span><span class="plain">                                           ; </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">name</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">passToCurrentFilingSystem</span><span class="plain">                    ; </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">call</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 5                                             ; </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> (</span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">)</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"FX"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">fxEntryPoint</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 255</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"BASIC"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">basicEntryPoint</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"CAT"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">passToCurrentFilingSystem</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 5</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"CODE"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starCodeMotorOptTapeRomTV</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $88</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"EXEC"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">closeExecFiles</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"HELP"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starHelp</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"KEY"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starKey</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FF</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"LOAD"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starLoad</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"LINE"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starCodeLineEntryPoint</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 1</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"MOTOR"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starCodeMotorOptTapeRomTV</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $89</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"OPT"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starCodeMotorOptTapeRomTV</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $8</span><span class="identifier">B</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"RUN"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">passToCurrentFilingSystem</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 4</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"ROM"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starCodeMotorOptTapeRomTV</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $8</span><span class="identifier">D</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"SAVE"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starLoadSave</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"SPOOL"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starSpool</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"TAPE"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starCodeMotorOptTapeRomTV</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $8</span><span class="identifier">C</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"TV"</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">starCodeMotorOptTapeRomTV</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $90</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">""</span>
        <span class="plain">!</span><span class="identifier">be16</span><span class="plain"> .</span><span class="identifier">passToCurrentFilingSystem</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSCLI</span><span class="plain"> - </span><span class="identifier">Command</span><span class="plain"> </span><span class="identifier">Line</span><span class="plain"> </span><span class="identifier">Interpreter</span>
    <span class="plain">;       </span><span class="identifier">the</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">handler</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">CLIV</span><span class="plain"> </span><span class="identifier">vector</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">XY</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> (</span><span class="identifier">terminated</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">carriage</span><span class="plain"> </span><span class="reserved">return</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">,</span><span class="identifier">F</span><span class="plain"> </span><span class="identifier">undefined</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">oscliHandler</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">                    ; </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">XY</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">/</span><span class="identifier">High</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressHigh</span><span class="plain">                   ;</span>
        <span class="identifier">LDA</span><span class="plain"> #8                                              ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">passToCurrentFilingSystem</span><span class="plain">                      ; </span><span class="identifier">Inform</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">CLI</span><span class="plain"> </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">processed</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                ; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">correctly</span><span class="plain"> </span><span class="identifier">terminated</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charRETURN</span><span class="plain">                                    ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">found</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">stringOK</span><span class="plain">                                       ;</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> 256 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="reserved">long</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="reserved">return</span><span class="plain"> (</span><span class="identifier">string</span><span class="plain"> &gt; 255 </span><span class="identifier">characters</span><span class="plain">)</span>

        <span class="plain">; </span><span class="identifier">String</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">terminated</span><span class="plain"> </span><span class="identifier">ok</span><span class="plain"> - </span><span class="identifier">now</span><span class="plain"> </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">prepended</span><span class="plain"> </span><span class="identifier">spaces</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="character">'*'</span><span class="identifier">s</span>
    <span class="plain">.</span><span class="identifier">stringOK</span>
        <span class="identifier">LDY</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> (</span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">about</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">incremented</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">)</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">incAndSkipSpaces</span><span class="plain">                               ; </span><span class="identifier">Skip</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">spaces</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit15</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">CR</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charSTAR</span><span class="plain">                                      ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="character">'*'</span>
        <span class="identifier">BEQ</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="character">'*'</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">Loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">spaces</span><span class="plain"> </span><span class="identifier">again</span><span class="plain">)</span>

        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">skipSpacesAndCheckForCRInStringInput</span><span class="plain">           ; </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">more</span><span class="plain"> </span><span class="identifier">spaces</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain"> (</span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain">? </span><span class="identifier">didn</span><span class="character">'t we just check this?)</span>
        <span class="character">BEQ .exit15                                         ; if (CR found) then branch (exit)</span>
        <span class="character">CMP #.charBAR                                       ; check for '</span><span class="plain">|</span><span class="character">' (a comment)</span>
        <span class="character">BEQ .exit15                                         ; if ('</span><span class="plain">|</span><span class="character">' found) then branch (exit)</span>
        <span class="character">CMP #.charFORWARDSLASH                              ; check for '</span><span class="plain">/</span><span class="character">'</span>
        <span class="character">BNE .startLookingForCommand                         ; if (NOT forward slash) then branch forward</span>
        <span class="character">INY                                                 ; Move past the '</span><span class="plain">/</span><span class="character">'</span>
        <span class="character">JSR .convertStringInputPointerToXY                  ; Convert the address (.stringInputBufferAddressLow/High + Y) into XY</span>
        <span class="character">LDA #2                                              ; 2 = execute "*/" command (See NAUG Section 16.1.7 - FSCV, Page 256)</span>
        <span class="character">BNE .passToCurrentFilingSystem                      ; ALWAYs branch (call into current filing system service routine)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Look command up in command table</span>
    <span class="character">.startLookingForCommand</span>
        <span class="character">STY .currentStringPointer                           ; Store offset to start of command in command line</span>
        <span class="character">LDX #0                                              ; start of command</span>
        <span class="character">BEQ .lookForCommand                                 ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.compareCharacterInCommand</span>
        <span class="character">EOR .starCommandTable,X                             ; compare with character from star command table</span>
        <span class="character">AND #%11011111                                      ; ignore case (zero the bit that distinguishes between upper and lower case)</span>
        <span class="character">BNE .namesDontMatch                                 ; if (no match) then branch</span>
        <span class="character">INY                                                 ; increment offset in command line</span>
        <span class="character">CLC                                                 ; test next character</span>

    <span class="character">.atEndOfCommandName</span>
        <span class="character">BCS .foundMatchForCommand                           ;</span>
        <span class="character">INX                                                 ; increment offset in star command table</span>
        <span class="character">LDA (.stringInputBufferAddressLow),Y                ; read next character in command line</span>
        <span class="character">JSR .isLetter                                       ; carry clear if letter in A</span>
        <span class="character">BCC .compareCharacterInCommand                      ;</span>

    <span class="character">.lookForCommand</span>
        <span class="character">LDA .starCommandTable,X                             ; read byte from command table</span>
        <span class="character">BMI .endOfCommandStringFound                        ; if top bit set (end of command name string) then branch</span>
        <span class="character">LDA (.stringInputBufferAddressLow),Y                ; read byte from command line</span>
        <span class="character">CMP #.charDOT                                       ; is it dot?</span>
        <span class="character">BEQ .foundDot                                       ;</span>

    <span class="character">.namesDontMatch</span>
        <span class="character">CLC                                                 ;</span>
        <span class="character">LDY .currentStringPointer                           ;</span>
        <span class="character">DEY                                                 ;</span>

    <span class="character">.foundDot</span>
        <span class="character">INY                                                 ;</span>
        <span class="character">INX                                                 ;</span>

    <span class="character">-</span>
        <span class="character">INX                                                 ;</span>
        <span class="character">LDA .starCommandTable-2,X                           ;</span>
        <span class="character">BEQ .passCommandToROMs                              ; reached end of table; unrecognised star command</span>
        <span class="character">BPL -                                               ; if top bit clear (not yet end of command name) then branch back (move to next character)</span>
        <span class="character">BMI .atEndOfCommandName                             ; ALWAYs branch</span>

    <span class="character">.endOfCommandStringFound</span>
        <span class="character">INX                                                 ;</span>
        <span class="character">INX                                                 ;</span>

    <span class="character">.foundMatchForCommand</span>
        <span class="character">DEX                                                 ;</span>
        <span class="character">DEX                                                 ;</span>
        <span class="character">PHA                                                 ; push star command address (high byte)</span>
        <span class="character">LDA .starCommandTable+1,X                           ;  get star command address (low byte)</span>
        <span class="character">PHA                                                 ; push star command address (low byte)</span>
        <span class="character">JSR .skipSpacesAndCheckForCRInStringInput           ; skip over the following spaces</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">PHP                                                 ; push flags</span>
        <span class="character">JSR .prepareRegistersForStarCommand                 ; prepare the A,X,Y registers for the call to star command routine</span>
        <span class="character">RTI                                                 ; the RTI instruction restores the flags, and jumps to the</span>
                                                            <span class="character">; address we'</span><span class="identifier">ve</span><span class="plain"> </span><span class="identifier">just</span><span class="plain"> </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain">. </span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">jumps</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain">.</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">prepareRegistersForStarCommand</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">starCommandTable</span><span class="plain">+2,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="identifier">Get</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">exit15</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">implies</span><span class="plain"> </span><span class="identifier">there</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">probably</span><span class="plain"> </span><span class="identifier">numeric</span><span class="plain"> </span><span class="identifier">parameters</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">otherwise</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">XY</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">rest</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">based</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">line</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> .</span><span class="identifier">starCommandTable</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">convertStringInputPointerToXY</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">Pass</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">later</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">starCommandTable</span><span class="plain">+2,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="identifier">Get</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">returned</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> (.</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain"> + </span><span class="identifier">A</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">XY</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">string</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">convertStringAddressToXY</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">                    ;</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">remember</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressHigh</span><span class="plain">                   ; }</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">exit15</span><span class="plain">                                         ; } </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">, </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">needed</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; }</span>
    <span class="plain">.</span><span class="identifier">exit15</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; *</span><span class="identifier">BASIC</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">basicEntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">basicROMNumber</span><span class="plain">                                 ; </span><span class="identifier">Get</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">passCommandToROMs</span><span class="plain">                              ; </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">, </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">on</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">Carry</span><span class="plain"> = </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">entering</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">RESET</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">osbyte142EntryPoint</span><span class="plain">                            ; </span><span class="identifier">Enter</span><span class="plain"> </span><span class="identifier">language</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Pass</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">other</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">passCommandToROMs</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">currentStringPointer</span><span class="plain">                           ; </span><span class="identifier">Restore</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">command</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallUnrecognisedCommand</span><span class="plain">             ; 4 = </span><span class="identifier">Unrecognised</span><span class="plain"> </span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">command</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; </span><span class="identifier">Pass</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">sideways</span><span class="plain"> </span><span class="identifier">ROMs</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit15</span><span class="plain">                                         ; </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">claimed</span><span class="plain">, </span><span class="identifier">exit</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">currentStringPointer</span><span class="plain">                           ; </span><span class="identifier">Restore</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">command</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">convertStringAddressToXY</span><span class="plain">                       ; </span><span class="identifier">Convert</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain">+</span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">XY</span><span class="plain">, </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">returned</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> #3                                              ; 3 = </span><span class="identifier">Auto</span><span class="plain">-</span><span class="identifier">boot</span><span class="plain"> </span><span class="identifier">call</span>

    <span class="plain">.</span><span class="identifier">passToCurrentFilingSystem</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorFSCV</span><span class="plain">)                                   ; </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">handler</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 139 - </span><span class="identifier">Select</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">options</span><span class="plain"> (*</span><span class="identifier">OPT</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte139EntryPoint</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">Double</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 127 - </span><span class="identifier">Check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">EOF</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte127EntryPoint</span>
        <span class="identifier">AND</span><span class="plain"> #1                                              ; </span><span class="identifier">A</span><span class="plain"> = 1 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 127</span>
                                                            <span class="plain">; </span><span class="identifier">A</span><span class="plain"> = 0 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 139</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">passToCurrentFilingSystem</span><span class="plain">                      ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">send</span><span class="plain"> *</span><span class="identifier">OPT</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">By</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">ends</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> .</span><span class="identifier">fscEntryPoint</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Skip</span><span class="plain"> </span><span class="identifier">spaces</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       .</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">test</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">string</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">incremented</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">space</span><span class="plain"> </span><span class="identifier">character</span>
    <span class="plain">;       </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain"> </span><span class="identifier">found</span><span class="plain"> (</span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">string</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">incAndSkipSpaces</span>
        <span class="identifier">INY</span>
    <span class="plain">.</span><span class="identifier">skipSpacesAndCheckForCRInStringInput</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">),</span><span class="identifier">Y</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charSPACE</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">incAndSkipSpaces</span>
    <span class="plain">.</span><span class="identifier">compareWithReturnAndExit</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charRETURN</span>
        <span class="identifier">RTS</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Skip</span><span class="plain"> </span><span class="identifier">past</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">spaces</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">CR</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">incremented</span><span class="plain"> </span><span class="identifier">past</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">spaces</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">comma</span>
    <span class="plain">;       </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain"> </span><span class="identifier">found</span>
    <span class="plain">;       </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">otherwise</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">skipSpacesAndComma</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">skipSpacesAndCheckForCRInStringInput</span>
    <span class="plain">.</span><span class="identifier">skipSpacesAndCommaValid</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">skipSpacesAndCheckForCRInStringInput</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charCOMMA</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">compareWithReturnAndExit</span>
        <span class="identifier">INY</span>
        <span class="identifier">RTS</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (0-255) </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">string</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain"> + </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">holding</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">number</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">result</span><span class="plain"> (</span><span class="identifier">value</span><span class="plain"> 0-255) </span><span class="identifier">also</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span>
    <span class="plain">;       </span><span class="identifier">Carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">error</span>
    <span class="plain">;       </span><span class="identifier">Zero</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain"> </span><span class="identifier">found</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">convertNumberToBinary</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">skipSpacesAndCheckForCRInStringInput</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readDigitFromString</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">errorReadingString</span>

    <span class="plain">.</span><span class="identifier">readingDigits</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readNextDigitFromString</span><span class="plain">                        ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">digit</span><span class="plain"> 0-9</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">finishedParsingDigits</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">digit</span><span class="plain">, </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">have</span><span class="plain"> </span><span class="identifier">finished</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">remember</span><span class="plain"> </span><span class="identifier">best</span><span class="plain"> </span><span class="identifier">valid</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">far</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">digit</span><span class="plain"> </span><span class="identifier">P</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">P</span><span class="plain">*2</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">errorReadingString</span><span class="plain">                             ; </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">too</span><span class="plain"> </span><span class="identifier">big</span><span class="plain">, </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">P</span><span class="plain">*4</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">errorReadingString</span><span class="plain">                             ; </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">too</span><span class="plain"> </span><span class="identifier">big</span><span class="plain">, </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">A</span><span class="plain">=(</span><span class="identifier">P</span><span class="plain">*4)+</span><span class="identifier">P</span><span class="plain"> =</span><span class="identifier">P</span><span class="plain">*5</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">errorReadingString</span><span class="plain">                             ; </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">too</span><span class="plain"> </span><span class="identifier">big</span><span class="plain">, </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">P</span><span class="plain">*10</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">errorReadingString</span><span class="plain">                             ; </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">too</span><span class="plain"> </span><span class="identifier">big</span><span class="plain">, </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">digit</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">Add</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">digit</span><span class="plain"> </span><span class="identifier">times</span><span class="plain"> </span><span class="identifier">ten</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">errorReadingString</span><span class="plain">                             ; </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">too</span><span class="plain"> </span><span class="identifier">big</span><span class="plain">, </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">readingDigits</span><span class="plain">                                  ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">finishedParsingDigits</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">best</span><span class="plain"> </span><span class="identifier">valid</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charRETURN</span><span class="plain">                                    ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">RETURN</span><span class="plain"> </span><span class="identifier">found</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> (</span><span class="identifier">success</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">)</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readNextDigitFromString</span>
        <span class="identifier">INY</span>
    <span class="plain">.</span><span class="identifier">readDigitFromString</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">digit</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">string</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charNINE</span><span class="plain"> + 1                                  ; }</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">errorReadingString</span><span class="plain">                             ; } </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">digit</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> </span><span class="character">'0'</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="character">'9'</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charZERO</span><span class="plain">                                      ; }</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">errorReadingString</span><span class="plain">                             ; }</span>
        <span class="identifier">AND</span><span class="plain"> #$0</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">leave</span><span class="plain"> </span><span class="identifier">binary</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> 0-9</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">notAHexByte</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">skipSpacesAndCommaValid</span><span class="plain">                        ;</span>

    <span class="plain">.</span><span class="identifier">errorReadingString</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">success</span><span class="plain">, </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">, </span><span class="identifier">A</span><span class="plain"> = 0-15, </span><span class="identifier">based</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">ascii</span><span class="plain"> </span><span class="identifier">digit</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> (0-9,</span><span class="identifier">A</span><span class="plain">-</span><span class="identifier">F</span><span class="plain">)</span>
    <span class="plain">;       </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">, </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readHexDigit</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readDigitFromString</span><span class="plain">                            ;</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ;</span>
        <span class="identifier">AND</span><span class="plain"> #%11011111                                      ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 5 (</span><span class="identifier">converts</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="reserved">case</span><span class="plain"> </span><span class="identifier">letters</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">upper</span><span class="plain"> </span><span class="reserved">case</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charF</span><span class="plain"> + 1                                     ;</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">notAHexByte</span><span class="plain">                                    ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">higher</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="character">'F'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charA</span><span class="plain">                                         ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">notAHexByte</span><span class="plain">                                    ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="character">'A'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">, </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SBC</span><span class="plain"> #.</span><span class="identifier">charA</span><span class="plain"> - 10                                    ; </span><span class="identifier">Convert</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> 10-15</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">, </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">successful</span><span class="plain"> </span><span class="identifier">result</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 11
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 11: </span><span class="identifier">Writing</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain">; </span><span class="identifier">printer</span><span class="plain">; </span><span class="identifier">buffers</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSWRCH</span><span class="plain"> - </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">character</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">oswrchEntryPoint</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; } </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">registers</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TSX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">stack</span><span class="plain"> </span><span class="identifier">pointer</span>
        <span class="identifier">LDA</span><span class="plain"> $0103,</span><span class="identifier">X</span><span class="plain">                                         ; </span><span class="identifier">Peek</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">back</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">Push</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">econetWriteCharacterInterceptionStatus</span><span class="plain">         ; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">OSWRCH</span><span class="plain"> </span><span class="identifier">interception</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">skipEconetProcessing</span><span class="plain">                           ; </span><span class="identifier">Not</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">, </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">interception</span><span class="plain"> </span><span class="identifier">call</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Pass</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">LDA</span><span class="plain"> #4                                              ; </span><span class="identifier">A</span><span class="plain">=4 </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">OSWRCH</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">call</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">netvJumper</span><span class="plain">                                     ; </span><span class="identifier">Call</span><span class="plain"> </span><span class="identifier">NETV</span><span class="plain"> </span><span class="identifier">code</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">oswrchFinishUp</span><span class="plain">                                 ; </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">claimed</span><span class="plain">, </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">past</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">.</span><span class="identifier">skipEconetProcessing</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">Prepare</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">printer</span>
        <span class="identifier">LDA</span><span class="plain"> #2                                              ; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">destination</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">characterDestinationStatus</span><span class="plain">                     ; </span><span class="identifier">Is</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">driver</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">?</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">skipVDUOutput</span><span class="plain">                                  ; </span><span class="identifier">Yes</span><span class="plain">, </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">past</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">driver</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">Pull</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">back</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">Push</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">back</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">vduChrEntryPoint</span><span class="plain">                               ; </span><span class="identifier">Call</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">driver</span>
                                                            <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">, </span><span class="identifier">C</span><span class="plain">=1 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">sent</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">printer</span>
    <span class="plain">.</span><span class="identifier">skipVDUOutput</span>
        <span class="identifier">LDA</span><span class="plain"> #8                                              ; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">destination</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">characterDestinationStatus</span><span class="plain">                     ; </span><span class="identifier">Is</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">seperately</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain">?</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">printerEnabled</span><span class="plain">                                 ; </span><span class="identifier">Yes</span><span class="plain">, </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">driver</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">printerDisabled</span><span class="plain">                                ; </span><span class="identifier">Carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">, </span><span class="identifier">don</span><span class="character">'t sent to printer</span>

    <span class="character">.printerEnabled</span>
        <span class="character">PLA                                                 ; Pull character back</span>
        <span class="character">PHA                                                 ; Push character back</span>
        <span class="character">JSR .sendCharacterToPrinter                         ; Call printer driver</span>

    <span class="character">.printerDisabled</span>
        <span class="character">LDA .characterDestinationStatus                     ; Check output destination</span>
        <span class="character">ROR                                                 ; check RS423 output bit</span>
        <span class="character">BCC .skipRS423Output                                ; If RS423 output is disabled then branch (skip past serial output)</span>
        <span class="character">LDY .rs423TimeoutCounter                            ; Get RS423 timout counter</span>
        <span class="character">DEY                                                 ; Decrease counter</span>
        <span class="character">BPL .skipRS423Output                                ; if timed out then branch (skip past serial code)</span>
        <span class="character">PLA                                                 ; Pull character back</span>
        <span class="character">PHA                                                 ; Push character back</span>
        <span class="character">PHP                                                 ; Save IRQs</span>
        <span class="character">SEI                                                 ; Disable IRQs</span>
        <span class="character">LDX #.bufferNumberRS423Output                       ; X=RS423 output buffer</span>
        <span class="character">PHA                                                 ; Save character</span>
        <span class="character">JSR .osbyte152EntryPoint                            ; examine RS423 output buffer to see if it'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">empty</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="identifier">Buffer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain">, </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearBusyFlagAndSetRS423Active</span><span class="plain">                 ; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">Active</span>
    <span class="plain">+</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">Get</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">back</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">bufferNumberRS423Output</span><span class="plain">                       ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">addByteToBuffer</span><span class="plain">                                ; </span><span class="identifier">Send</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">Restore</span><span class="plain"> </span><span class="identifier">IRQs</span>

    <span class="plain">.</span><span class="identifier">skipRS423Output</span>
        <span class="identifier">LDA</span><span class="plain"> #$10                                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">destination</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">characterDestinationStatus</span><span class="plain">                     ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">SPOOL</span><span class="plain"> </span><span class="identifier">output</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">oswrchFinishUp</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">SPOOL</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">past</span><span class="plain"> </span><span class="identifier">SPOOL</span><span class="plain"> </span><span class="identifier">output</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">spoolFileHandle</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">SPOOL</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">oswrchFinishUp</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">open</span><span class="plain">, </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">past</span><span class="plain"> </span><span class="identifier">SPOOL</span><span class="plain"> </span><span class="identifier">output</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">back</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; }</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">tapeCritical</span><span class="plain">                                   ; } </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">critical</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSBPUT</span><span class="plain">                                         ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">SPOOL</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain">, </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain">)</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">tapeCritical</span><span class="plain">                                   ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">critical</span><span class="plain"> </span><span class="identifier">flag</span>

    <span class="plain">.</span><span class="identifier">oswrchFinishUp</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ;</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; } </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">registers</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">print</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">sendCharacterToPrinter</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">characterDestinationStatus</span><span class="plain">                     ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">disabled</span>
        <span class="identifier">BVS</span><span class="plain"> .</span><span class="identifier">exit16</span><span class="plain">                                         ; </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">printerIgnoreCharacter</span><span class="plain">                         ; </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit16</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">sendValidByteToPrinter</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> (</span><span class="identifier">including</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">)</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">LDA</span><span class="plain"> #%00000100                                      ; }</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">characterDestinationStatus</span><span class="plain">                     ; } </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 2 </span><span class="character">'disable printer driver'</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">pullAndExit14</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">bufferNumberPrinter</span><span class="plain">                           ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">addByteToBuffer</span><span class="plain">                                ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">pullAndExit14</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> (</span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>

        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">printerBufferEmptyFlag</span><span class="plain">                         ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">pullAndExit14</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">openPrinterChannel</span><span class="plain">                             ; </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">channel</span>
    <span class="plain">.</span><span class="identifier">pullAndExit14</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> (</span><span class="identifier">including</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">exit16</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">openPrinterChannel</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">printerDestination</span><span class="plain">                             ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">destination</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">flushBufferX</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #1                                              ; }</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">checkForSerialPrinter</span><span class="plain">                          ; } </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">parallel</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">selected</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte145EntryPoint</span><span class="plain">                            ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">printerBufferEmptyFlag</span><span class="plain">                         ; </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">exit17</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> #$82                                            ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> 1 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">external</span><span class="plain"> </span><span class="identifier">VIA</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">userViaInterruptEnableRegister</span><span class="plain">                 ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">userViaRegisterA</span><span class="plain">                               ; </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">centronics</span><span class="plain"> </span><span class="identifier">port</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">userViaPeripheralControlRegister</span><span class="plain">               ; }</span>
        <span class="identifier">AND</span><span class="plain"> #%11110001                                      ; }</span>
        <span class="identifier">ORA</span><span class="plain"> #%00001100                                      ; } </span><span class="identifier">pulse</span><span class="plain"> </span><span class="identifier">CA2</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">generate</span><span class="plain"> </span><span class="identifier">STROBE</span><span class="plain"> </span><span class="identifier">signal</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">advise</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">valid</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">waiting</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">userViaPeripheralControlRegister</span><span class="plain">               ; }</span>
        <span class="identifier">ORA</span><span class="plain"> #%00001110                                      ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">userViaPeripheralControlRegister</span><span class="plain">               ; }</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">exit17</span><span class="plain">                                         ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkForSerialPrinter</span>
        <span class="identifier">CMP</span><span class="plain"> #2                                              ; }</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">userPrinter</span><span class="plain">                                    ; } </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">NOT</span><span class="plain"> </span><span class="identifier">selected</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain">)</span>

        <span class="plain">; </span><span class="identifier">Serial</span><span class="plain"> </span><span class="identifier">printer</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">rs423TimeoutCounter</span><span class="plain">                            ; }</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; }</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">flushBufferX</span><span class="plain">                                   ; } </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">timeout</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">more</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">flush</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain">)</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">printerBufferEmptyFlag</span><span class="plain">                         ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain"> </span><span class="identifier">flag</span>

    <span class="plain">.</span><span class="identifier">clearBusyFlagAndSetRS423Active</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">rs423ReadyFlag</span><span class="plain">                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">busy</span><span class="plain"> </span><span class="identifier">flag</span>
    <span class="plain">.</span><span class="identifier">setRS423Active</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">getRS423InputBufferFreeBytes</span><span class="plain">                   ; }</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">exit17</span><span class="plain">                                         ; } </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">free</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">low</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">LDX</span><span class="plain"> #%00100000                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 5 </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span>
                                                            <span class="plain">; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">Request</span><span class="plain"> </span><span class="identifier">To</span><span class="plain"> </span><span class="identifier">Send</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> (</span><span class="identifier">meaning</span><span class="plain"> </span><span class="identifier">Active</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">writeToBits5And6OfACIA</span>
        <span class="identifier">LDY</span><span class="plain"> #%10011111                                      ; </span><span class="identifier">Mask</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 5 </span><span class="identifier">and</span><span class="plain"> 6</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 156 - </span><span class="identifier">update</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">Control</span><span class="plain"> </span><span class="identifier">Register</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">Copy</span><span class="plain"> (</span><span class="identifier">RS423</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">write</span><span class="plain"> (</span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">AND</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">) </span><span class="identifier">EOR</span><span class="plain"> </span><span class="identifier">X</span>
    <span class="plain">; </span><span class="identifier">Preserves</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">flags</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte156EntryPoint</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; .</span><span class="identifier">tempStoreFA</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">rs423ControlRegisterCopy</span><span class="plain">                       ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">AND</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">EOR</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ;</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">rs423ControlRegisterCopy</span><span class="plain">                       ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
    <span class="plain">.</span><span class="identifier">storeACIAAndPull</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">rs423ControlRegisterCopy</span><span class="plain">                       ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">in</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">acia6850ControlRegister</span><span class="plain">                        ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
    <span class="plain">.</span><span class="identifier">exit17</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">userPrinter</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">LDA</span><span class="plain"> #1                                              ; </span><span class="identifier">A</span><span class="plain"> = 1</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printerServiceCall</span><span class="plain">                             ;</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 123 - </span><span class="identifier">Warn</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">about</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">going</span><span class="plain"> </span><span class="identifier">dormant</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte123EntryPoint</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">printerBufferEmptyFlag</span><span class="plain">                         ; </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain"> (</span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain">)</span>
    <span class="plain">-</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Signal</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">there</span><span class="character">'s at least one character in the printer buffer, at a</span>
    <span class="character">; rate of 100Hz until the printer driver deals with it.</span>
    <span class="character">.printerServiceCallIfNotEmpty</span>
        <span class="character">BIT .printerBufferEmptyFlag                         ; check printer buffer empty flag</span>
        <span class="character">BMI -                                               ; if bit 7 is set (buffer is empty) then branch (exit)</span>
        <span class="character">LDA #0                                              ; else A=0 (100Hz update when printer is active and buffer is not empty)</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Econet / User printer routines</span>
    <span class="character">;</span>
    <span class="character">; See NAUG Section 24.2.4 P424 for more detail on reason codes</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       A = reason code</span>
    <span class="character">;           0 means 100Hz update</span>
    <span class="character">;           1 means become active, since printer buffer is no longer empty</span>
    <span class="character">;           2 means VDU 2 happened (disable printer output)</span>
    <span class="character">;           3 means VDU 3 happened (enable printer output)</span>
    <span class="character">;           5 means select new printer driver (entry via OSBYTE 5 to .selectPrinterType)</span>
    <span class="character">;</span>
    <span class="character">.printerServiceCall</span>
        <span class="character">LDX #.bufferNumberPrinter                           ; X=printer buffer number</span>
    <span class="character">.selectPrinterType</span>
        <span class="character">LDY .printerDestination                             ; Y=printer destination (*FX 5 value)</span>
        <span class="character">JSR .netvJumper                                     ; let network have a look (should respond if Y=4 for net printer)</span>
        <span class="character">JMP (.vectorUPTV)                                   ; let user printer routine have a look (can respond if Y=3, or 5-255 for user printer)</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; Flushes the given buffer</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       X=buffer number</span>
    <span class="character">;</span>
    <span class="character">;                      Address      Empty     Start      End</span>
    <span class="character">; Buffer number        Range        Flag      pointer    pointer</span>
    <span class="character">; --------------------------------------------------------------</span>
    <span class="character">; 0 = Keyboard         3E0-3FF      2CF       2D8        2E1</span>
    <span class="character">; 1 = RS423 Input      A00-AFF      2D0       2D9        2E2</span>
    <span class="character">; 2 = RS423 output     900-9BF      2D1       2DA        2E3</span>
    <span class="character">; 3 = printer          880-8BF      2D2       2DB        2E4</span>
    <span class="character">; 4 = sound0           840-84F      2D3       2DC        2E5</span>
    <span class="character">; 5 = sound1           850-85F      2D4       2DD        2E6</span>
    <span class="character">; 6 = sound2           860-86F      2D5       2DE        2E7</span>
    <span class="character">; 7 = sound3           870-87F      2D6       2DF        2E8</span>
    <span class="character">; 8 = speech           8C0-8FF      2D7       2E0        2E9</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.flushBufferX</span>
        <span class="character">CLC                                                 ; clear carry</span>

    <span class="character">.flushSoundBufferX</span>
        <span class="character">PHA                                                 ; save A</span>
        <span class="character">PHP                                                 ; save flags</span>
        <span class="character">SEI                                                 ; disable interrupts</span>
        <span class="character">BCS +                                               ; if carry set on entry then branch forward</span>
        <span class="character">LDA .bufferTypeAndSerialBaudRatesTable,X            ; carry clear so get byte from table</span>
        <span class="character">BPL +                                               ; if (not sound buffer) then branch forward</span>
        <span class="character">JSR .clearSoundChannelBuffer                        ; clear sound buffer</span>
    <span class="character">+</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">ROR .bufferEmptyFlags,X                             ; rotate buffer flag to show buffer empty</span>
        <span class="character">CPX #2                                              ;</span>
        <span class="character">BCS .skipInputBufferHandling                        ; if X&gt;1 then branch (its not an input buffer)</span>

        <span class="character">LDA #0                                              ; this is an input buffer</span>
        <span class="character">STA .softKeyStringLength                            ; reset length of key string being decoded (to stop decoding a soft key)</span>
        <span class="character">STA .twosComplimentOfNumberOfBytesInVDUQueue        ; reset length of VDU queue</span>

    <span class="character">.skipInputBufferHandling</span>
        <span class="character">JSR .purgeBuffer                                    ; purge buffer</span>
        <span class="character">PLP                                                 ; restore flags</span>
        <span class="character">PLA                                                 ; restore A</span>
        <span class="character">RTS                                                 ; and exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Count / Purge Buffer - Default Entry Point</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       X = buffer to access</span>
    <span class="character">;       if V set then purge buffer (else count buffer)</span>
    <span class="character">;       for count buffer: if C set then get bytes free</span>
    <span class="character">;                                  else get bytes used</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.cnpEntryPoint</span>
        <span class="character">BVC .countBuffer                                    ; if V clear then branch (count buffer)</span>
        <span class="character">LDA .bufferStartIndices,X                           ; purge buffer by setting</span>
        <span class="character">STA .bufferEndIndices,X                             ; end of buffer = start of buffer</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">.countBuffer</span>
        <span class="character">PHP                                                 ; push flags</span>
        <span class="character">SEI                                                 ; disable interrupts</span>
        <span class="character">PHP                                                 ; push flags</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">LDA .bufferEndIndices,X                             ; get end of buffer</span>
        <span class="character">SBC .bufferStartIndices,X                           ; subtract start of buffer</span>
        <span class="character">BCS +                                               ; if carry set then branch</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">SBC .emptyBufferStartOffset,X                       ; subtract buffer start offset (i.e. add buffer length)</span>
    <span class="character">+</span>
        <span class="character">PLP                                                 ; pull flags</span>
        <span class="character">BCC +                                               ; if carry clear then branch (to tidy up and exit)</span>
        <span class="character">CLC                                                 ; clear carry</span>
        <span class="character">ADC .emptyBufferStartOffset,X                       ; adc to get bytes used</span>
        <span class="character">EOR #$FF                                            ; and invert to get space left</span>
    <span class="character">+</span>
        <span class="character">LDY #0                                              ; Y=0</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">PLP                                                 ; get back flags</span>
        <span class="character">RTS                                                 ; and exit</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; Adds a byte to a buffer.</span>
    <span class="character">; If it doesn'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">work</span><span class="plain"> (</span><span class="identifier">e</span><span class="plain">.</span><span class="identifier">g</span><span class="plain">. </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">full</span><span class="plain">), </span><span class="identifier">flash</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">lights</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">keep</span><span class="plain"> </span><span class="identifier">trying</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">successful</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">addByteToBuffer</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">prevent</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">insJumper</span><span class="plain">                                      ; </span><span class="identifier">enter</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">exit18</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">successful</span><span class="plain"> </span><span class="identifier">exit</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">turnOnKeyboardLightsAndTestEscape</span><span class="plain">              ; </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">both</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">lights</span>

        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">keyboardIndicators</span><span class="plain">                             ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">unselected</span><span class="plain"> </span><span class="identifier">LEDs</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">flags</span>

        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">exit18</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> -</span><span class="identifier">ve</span><span class="plain"> </span><span class="identifier">Escape</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">exit</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">addByteToBuffer</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">didn</span><span class="character">'t enter buffer go and try it again</span>
    <span class="character">.exit18</span>
        <span class="character">RTS                                                 ; then return</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
</pre>

<p class="inwebparagraph">Chapter 12
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 12: </span><span class="identifier">Filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">routines</span><span class="plain">; </span><span class="identifier">star</span><span class="plain"> </span><span class="identifier">commands</span><span class="plain">; </span><span class="identifier">events</span><span class="plain">; </span><span class="identifier">buffers</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Clear</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">consecutive</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">OSFILE</span><span class="plain"> </span><span class="identifier">block</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">OSFILE</span><span class="plain"> </span><span class="identifier">block</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Preserves</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">clearOSFILEAddress</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">osfileBlockStart</span><span class="plain"> + 0,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">osfile</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">workspace</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">osfileBlockStart</span><span class="plain"> + 1,</span><span class="identifier">X</span><span class="plain">                         ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">osfileBlockStart</span><span class="plain"> + 2,</span><span class="identifier">X</span><span class="plain">                         ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">osfileBlockStart</span><span class="plain"> + 3,</span><span class="identifier">X</span><span class="plain">                         ;</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">shiftDigitIntoAddress</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">remember</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">*2</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; *4</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; *8</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; *16</span>
        <span class="identifier">LDY</span><span class="plain"> #$04                                            ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">*32</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">osfileBlockStart</span><span class="plain"> + 0,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">osfileBlockStart</span><span class="plain"> + 1,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">and</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">osfileBlockStart</span><span class="plain"> + 2,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">shift</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">osfileBlockStart</span><span class="plain"> + 3,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">along</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">brkBadAddress</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">overflowed</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="character">'Bad address'</span><span class="plain"> </span><span class="identifier">error</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">&gt;0 </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">another</span><span class="plain"> </span><span class="identifier">shift</span>

        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   *</span><span class="identifier">LOAD</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">XY</span><span class="plain"> = </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">rest</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">line</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">starLoad</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">signal</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">performed</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   *</span><span class="identifier">SAVE</span><span class="plain"> </span><span class="identifier">ENTRY</span><span class="plain"> (</span><span class="identifier">and</span><span class="plain"> *</span><span class="identifier">LOAD</span><span class="plain"> </span><span class="identifier">continued</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain">=0         </span><span class="reserved">for</span><span class="plain"> *</span><span class="identifier">SAVE</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">zero</span><span class="plain">  </span><span class="reserved">for</span><span class="plain"> *</span><span class="identifier">LOAD</span>
    <span class="plain">;       </span><span class="identifier">XY</span><span class="plain"> = </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">rest</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">line</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">starLoadSave</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">rest</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressHigh</span><span class="plain">                   ;</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">osfileFilenameAddressLow</span><span class="plain">                       ; </span><span class="identifier">x</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">OSfile</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">osfileFilenameAddressHigh</span><span class="plain">                      ;</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">Push</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDX</span><span class="plain"> #2                                              ; </span><span class="identifier">X</span><span class="plain">=2</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearOSFILEAddress</span><span class="plain">                             ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">LDY</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">Y</span><span class="plain">=255</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">osfileExecAddressLow</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> 2</span><span class="identifier">F4</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">gsinitForFilenameParsing</span><span class="plain">                       ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">GSINIT</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">prepare</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">reading</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">gsreadEntryPoint</span><span class="plain">                               ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">BCC</span><span class="plain"> -                                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">reached</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">starSave</span><span class="plain">                                       ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=0 (*</span><span class="identifier">SAVE</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="plain">; </span><span class="identifier">loading</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readHexByteClearStartAddressAndShiftByte</span><span class="plain">       ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">hex</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">checkForErrorAndLoadFile</span><span class="plain">                       ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">success</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">OSFILE</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">callOSFILEWithParameterBlockForLoadSave</span><span class="plain">        ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">brkBadAddress</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FC</span><span class="plain">                                           ;</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"Bad address"</span><span class="plain">,0                               ; </span><span class="identifier">error</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 119 - </span><span class="identifier">Close</span><span class="plain"> </span><span class="identifier">Spool</span><span class="plain"> / </span><span class="identifier">Exec</span><span class="plain"> </span><span class="identifier">files</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte119EntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallSpoolExecClosureWarning</span><span class="plain">         ; } </span><span class="identifier">Let</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">know</span><span class="plain"> </span><span class="identifier">about</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">closure</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">SPOOL</span><span class="plain">/</span><span class="identifier">EXEC</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; }</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit19</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">accepts</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">issues</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">exec0EntryPoint</span><span class="plain">                                ; </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">;   *</span><span class="identifier">SPOOL</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = 0 (</span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">SPOOLed</span><span class="plain"> </span><span class="identifier">file</span><span class="plain">, </span><span class="identifier">OR</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">SPOOLing</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">closing</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">spooled</span><span class="plain"> </span><span class="identifier">file</span><span class="plain">:</span>
    <span class="plain">;           </span><span class="identifier">A</span><span class="plain">, </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">preserved</span>
    <span class="plain">;       </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">opening</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">spooled</span><span class="plain"> </span><span class="identifier">file</span><span class="plain">:</span>
    <span class="plain">;          </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">spooled</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">starSpool</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">remember</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">spoolFileHandle</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">spoolFileHandle</span><span class="plain">                                ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
        <span class="identifier">BEQ</span><span class="plain">  +                                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">forward</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSFIND</span><span class="plain">                                         ; </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">OSFIND</span>
    <span class="plain">+</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit19</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=0 </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">, </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">done</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #$80                                            ; </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="character">'open file for output'</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSFIND</span><span class="plain">                                         ; </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">XY</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">OSFIND</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> *</span><span class="identifier">SPOOLed</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">badCommandError</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="character">'Bad command'</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">spoolFileHandle</span><span class="plain">                                ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
    <span class="plain">.</span><span class="identifier">exit19</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkForErrorAndLoadFile</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">badCommandError</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">line</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">show</span><span class="plain"> </span><span class="character">'Bad command'</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">osfileExecAddressLow</span><span class="plain">                           ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (</span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">why</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">higher</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain">??)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">callOSFILEWithParameterBlockForLoadSave</span>
        <span class="identifier">LDX</span><span class="plain"> #&lt;.</span><span class="identifier">osfileBlockStart</span><span class="plain">                             ; }</span>
        <span class="identifier">LDY</span><span class="plain"> #&gt;.</span><span class="identifier">osfileBlockStart</span><span class="plain">                             ; } </span><span class="identifier">XY</span><span class="plain"> = </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">OSFILE</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">OSFILE</span><span class="plain">                                         ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">JUMP</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">OSFILE</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">successs</span>
    <span class="plain">;       </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">found</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readHexByteClearStartAddressAndShiftByte</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">skipSpacesAndCheckForCRInStringInput</span><span class="plain">           ; </span><span class="identifier">look</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">NEWline</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readHexDigit</span><span class="plain">                                   ; </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">finds</span><span class="plain"> </span><span class="identifier">hex</span><span class="plain"> </span><span class="identifier">digit</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">exit20</span><span class="plain">                                         ; </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">exit</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearOSFILEAddress</span><span class="plain">                             ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">OSFILE</span><span class="plain"> </span><span class="identifier">block</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">shiftDigitIntoAddress</span><span class="plain">                          ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readHexDigit</span><span class="plain">                                   ; </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">Hex</span><span class="plain"> </span><span class="identifier">digit</span>
        <span class="identifier">BCS</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">found</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
    <span class="plain">.</span><span class="identifier">exit20</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">starSave</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">osfileStartAddressLow</span><span class="plain"> - .</span><span class="identifier">osfileBlockStart</span><span class="plain">     ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">OSFILE</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readHexByteClearStartAddressAndShiftByte</span><span class="plain">       ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">badCommandError</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">hex</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">found</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="character">'Bad command'</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">CLV</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6</span>

        <span class="plain">;</span>
        <span class="plain">; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="character">'+'</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">indicate</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">rather</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="plain">;</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">text</span><span class="plain"> </span><span class="identifier">line</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charPLUS</span><span class="plain">                                      ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="character">'+'</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="character">'+'</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">address</span><span class="plain">)</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">allBitsSet</span><span class="plain">                                     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> (</span><span class="identifier">it</span><span class="character">'s the length)</span>
        <span class="character">INY                                                 ; increment Y to point to hex group</span>
    <span class="character">+</span>

        <span class="character">;</span>
        <span class="character">; read file length/end address from command line string</span>
        <span class="character">;</span>
        <span class="character">LDX #.osfileEndAddressLow - .osfileBlockStart       ; X=offset into OSFILE block for end address</span>
        <span class="character">JSR .readHexByteClearStartAddressAndShiftByte       ;</span>
        <span class="character">BCC .badCommandError                                ; if carry clear then branch (no hex byte) so exit ('</span><span class="identifier">Bad</span><span class="plain"> </span><span class="identifier">command</span><span class="character">' error)</span>
        <span class="character">PHP                                                 ; save flags</span>
        <span class="character">BVC .explicitEndAddressFound                        ; if (V clear; i.e. explicit end address found; i.e. no '</span><span class="plain">+</span><span class="character">') then branch</span>

        <span class="character">; add start address and length, and store as end address</span>
        <span class="character">LDX #$FC                                            ; X=loop counter, from $FC incrementing to $00 (4 bytes copied)</span>
        <span class="character">CLC                                                 ; clear carry</span>
    <span class="character">-</span>
        <span class="character">LDA .osfileStartAddressLow - $FC,X                  ; Get start address</span>
        <span class="character">ADC .page2Start,X                                   ; add length</span>
        <span class="character">STA .page2Start,X                                   ; store as end address</span>
        <span class="character">INX                                                 ;</span>
        <span class="character">BNE -                                               ; loop until X=0</span>

    <span class="character">.explicitEndAddressFound</span>
        <span class="character">LDX #3                                              ; X=loop counter</span>
    <span class="character">-</span>
        <span class="character">LDA .osfileStartAddressLow,X                        ; }</span>
        <span class="character">STA .osfileExecAddressLow,X                         ; }</span>
        <span class="character">STA .osfileLoadAddressLow,X                         ; } copy start adddress to load and execution addresses</span>
        <span class="character">DEX                                                 ; }</span>
        <span class="character">BPL -                                               ; }</span>

        <span class="character">PLP                                                 ; get back flag</span>
        <span class="character">BEQ .callOSFILEWithParameterBlockForLoadSave        ; if end of command line reached then branch to do OSFILE</span>

        <span class="character">;</span>
        <span class="character">; read command line for execution address</span>
        <span class="character">;</span>
        <span class="character">LDX #.osfileExecAddressLow - .osfileBlockStart      ; X=offset into OSFILE block for execution address</span>
        <span class="character">JSR .readHexByteClearStartAddressAndShiftByte       ;</span>
        <span class="character">BCC .badCommandError                                ; if error then branch ('</span><span class="identifier">Bad</span><span class="plain"> </span><span class="identifier">command</span><span class="character">' error)</span>
        <span class="character">BEQ .callOSFILEWithParameterBlockForLoadSave        ; and if end of line reached do OSFILE</span>

        <span class="character">;</span>
        <span class="character">; read command line for load address</span>
        <span class="character">;</span>
        <span class="character">LDX #.osfileLoadAddressLow - .osfileBlockStart      ; X=offset into OSFILE block for load address</span>
        <span class="character">JSR .readHexByteClearStartAddressAndShiftByte       ;</span>
        <span class="character">BCC .badCommandError                                ; if error then branch ('</span><span class="identifier">Bad</span><span class="plain"> </span><span class="identifier">command</span><span class="character">' error)</span>
        <span class="character">BEQ .callOSFILEWithParameterBlockForLoadSave        ; else on end of line do OSFILE</span>
        <span class="character">; fall through... (anything else is an error!)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.badCommandError</span>
        <span class="character">BRK                                                 ;</span>
        <span class="character">!byte $FE                                           ; error number</span>
        <span class="character">!text "Bad command"                                 ; string. Next instruction is also the zero terminator</span>

    <span class="character">.badKeyError</span>
        <span class="character">BRK                                                 ;</span>
        <span class="character">!byte $FB                                           ; error number</span>
        <span class="character">!text "Bad key",0                                   ; string with zero terminator</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; *KEY</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.starKey</span>
        <span class="character">JSR .convertNumberToBinary                          ; set up key number in A</span>
        <span class="character">BCC .badKeyError                                    ; if (not valid number) then branch ('</span><span class="identifier">Bad</span><span class="plain"> </span><span class="identifier">key</span><span class="character">' error)</span>
        <span class="character">CPX #16                                             ; compare key number with 16</span>
        <span class="character">BCS .badKeyError                                    ; if (key number is 16 or more) then branch ('</span><span class="identifier">Bad</span><span class="plain"> </span><span class="identifier">key</span><span class="character">' error)</span>
        <span class="character">JSR .skipSpacesAndCommaValid                        ; skip commas, and check for CR</span>
        <span class="character">PHP                                                 ; save flags for later (remember Z = CR found)</span>
        <span class="character">LDX .softKeysCurrentEndOffset                       ; get pointer to top of existing key strings</span>
        <span class="character">TYA                                                 ; }</span>
        <span class="character">PHA                                                 ; } save Y to preserve text pointer</span>
        <span class="character">JSR .initializeKey                                  ; set up soft key definition</span>
        <span class="character">PLA                                                 ; }</span>
        <span class="character">TAY                                                 ; } restore Y</span>
        <span class="character">PLP                                                 ; restore flags (recalls Z = CR found)</span>
        <span class="character">BNE .parseStarKeyString                             ; if (CR not found) then branch (to set up new string)</span>
        <span class="character">RTS                                                 ; else return to set null string</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; *FX</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.fxEntryPoint</span>
        <span class="character">JSR .convertNumberToBinary                          ; convert the number to binary</span>
        <span class="character">BCC .badCommandError                                ; if bad number call bad command</span>
        <span class="character">TXA                                                 ; save X</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       A = $88     *CODE</span>
    <span class="character">;       A = $89     *MOTOR</span>
    <span class="character">;       A = $8B     *OPT</span>
    <span class="character">;       A = $8C     *TAPE</span>
    <span class="character">;       A = $8D     *ROM</span>
    <span class="character">;       A = $90     *TV</span>
    <span class="character">;       A = any     *FX     (when falling through from .fxEntryPoint above)</span>
    <span class="character">;</span>
    <span class="character">; Parses one or optionally two numeric (0-255) parameters (space and/or comma separated)</span>
    <span class="character">; then calls OSBYTE with A as above</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.starCodeMotorOptTapeRomTV</span>
        <span class="character">PHA                                                 ; save A</span>
        <span class="character">LDA #0                                              ; }</span>
        <span class="character">STA .starCommandXParameter                          ; } clear the X/Y parameters for the upcoming OSBYTE call</span>
        <span class="character">STA .starCommandYParameter                          ; }</span>
        <span class="character">JSR .skipSpacesAndComma                             ; skip commas and check for newline (CR)</span>
        <span class="character">BEQ .parsedParameters                               ; if CR found then branch (to call appropriate OSBYTE)</span>

        <span class="character">JSR .convertNumberToBinary                          ; parse first parameter (X Parameter for OSBYTE)</span>
        <span class="character">BCC .badCommandError                                ; if bad character then branch (to give bad command error)</span>
        <span class="character">STX .starCommandXParameter                          ; store as X parameter for OSBYTE</span>
        <span class="character">JSR .skipSpacesAndCommaValid                        ; skip comma and check CR</span>
        <span class="character">BEQ .parsedParameters                               ; if CR found then branch (to call appropriate OSBYTE)</span>

        <span class="character">JSR .convertNumberToBinary                          ; parse second parameter (Y Parameter for OSBYTE)</span>
        <span class="character">BCC .badCommandError                                ; if bad error</span>
        <span class="character">STX .starCommandYParameter                          ; store as Y parameter for OSBYTE</span>
        <span class="character">JSR .skipSpacesAndCheckForCRInStringInput           ; now we must have a newline</span>
        <span class="character">BNE .badCommandError                                ; if none then output an error</span>

    <span class="character">.parsedParameters</span>
        <span class="character">LDY .starCommandYParameter                          ; Y = OSBYTE parameter</span>
        <span class="character">LDX .starCommandXParameter                          ; X = OSBYTE parameter</span>
        <span class="character">PLA                                                 ; A = OSBYTE parameter</span>
        <span class="character">JSR .OSBYTE                                         ; call OSBYTE</span>
        <span class="character">BVS .badCommandError                                ; if V set on return then error</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.parseStarKeyString</span>
        <span class="character">SEC                                                 ; set carry (meaning: check for '</span><span class="string">"' marks around string)</span>
        <span class="string">JSR .gsinitEntryPoint                               ; start reading string</span>
    <span class="string">-</span>
        <span class="string">JSR .gsreadEntryPoint                               ; call GSREAD</span>
        <span class="string">BCS +                                               ; if carry set (end of string reached) deal with end of string</span>
        <span class="string">INX                                                 ; point to first byte of new key definition</span>
        <span class="string">BEQ .badKeyError                                    ; if X=0 (buffer overflow) then branch (exit with 'Bad Key' error)</span>
        <span class="string">STA .softKeyPage,X                                  ; store character</span>
        <span class="string">BCC -                                               ; if (not end of line) then branch (loop to copy next byte)</span>

    <span class="string">+</span>
        <span class="string">BNE .badKeyError                                    ; if (parsing error) then branch (show 'Bad Key' error)</span>
        <span class="string">PHP                                                 ; save flags</span>
        <span class="string">SEI                                                 ; disable interrupts</span>
        <span class="string">JSR .initializeKey                                  ; initialise *KEY with the stored string definition</span>

        <span class="string">; TODO: Explain this loop</span>
        <span class="string">LDX #$10                                            ; set loop counter</span>
    <span class="string">-</span>
        <span class="string">CPX .tempWorkspaceE6                                ; if key being defined is found</span>
        <span class="string">BEQ .skipRestOfLoop                                 ; then skip rest of loop</span>
        <span class="string">LDA .softKeyPage,X                                  ; else get start of string X</span>
        <span class="string">CMP .softKeyPage,Y                                  ; compare with start of string Y</span>
        <span class="string">BNE .skipRestOfLoop                                 ; if not the same then skip rest of loop</span>
        <span class="string">LDA .softKeysCurrentEndOffset                       ; else store top of string definition</span>
        <span class="string">STA .softKeyPage,X                                  ; in designated key pointer</span>
    <span class="string">.skipRestOfLoop</span>
        <span class="string">DEX                                                 ; decrement loop pointer X</span>
        <span class="string">BPL -                                               ; and do it all again</span>
        <span class="string">PLP                                                 ; get back flags</span>
        <span class="string">RTS                                                 ; and exit</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">; TODO: Explain this function better, and all of the *KEY code really</span>
    <span class="string">.getStringLength</span>
        <span class="string">PHP                                                 ; push flags</span>
        <span class="string">SEI                                                 ; disable interrupts</span>
        <span class="string">LDA .softKeysCurrentEndOffset                       ; get top of currently defined strings</span>
        <span class="string">SEC                                                 ;</span>
        <span class="string">SBC .softKeyPage,Y                                  ; subtract to get the number of bytes in strings above end of string Y</span>
        <span class="string">STA .tempStoreFB                                    ; store this</span>
        <span class="string">TXA                                                 ; save X</span>
        <span class="string">PHA                                                 ;</span>
        <span class="string">LDX #$10                                            ; and X=16</span>

    <span class="string">-</span>
        <span class="string">LDA .softKeyPage,X                                  ; get start offset (from .softKeyPage) of key string X</span>
        <span class="string">SEC                                                 ;</span>
        <span class="string">SBC .softKeyPage,Y                                  ; subtract offset of string we are working on</span>
        <span class="string">BCC +                                               ; if carry clear (.softKeyPage+Y &gt; .softKeyPage+X) or</span>
        <span class="string">BEQ +                                               ; result (in A)=0</span>
        <span class="string">CMP .tempStoreFB                                    ; or greater or equal to number of bytes above string we are working on</span>
        <span class="string">BCS +                                               ; then branch</span>
        <span class="string">STA .tempStoreFB                                    ; else store A in .tempStoreFB</span>
    <span class="string">+</span>
        <span class="string">DEX                                                 ; point to next lower key offset</span>
        <span class="string">BPL -                                               ; and if 0 or +ve go back and do it again</span>

        <span class="string">PLA                                                 ; else get back value of X</span>
        <span class="string">TAX                                                 ;</span>
        <span class="string">LDA .tempStoreFB                                    ; get back latest value of A</span>
        <span class="string">PLP                                                 ; pull flags</span>
        <span class="string">RTS                                                 ; and return</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">; initialise a *KEY string</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.initializeKey</span>
        <span class="string">PHP                                                 ; push flags</span>
        <span class="string">SEI                                                 ; disable interrupts</span>
        <span class="string">TXA                                                 ; save X</span>
        <span class="string">PHA                                                 ; push A</span>
        <span class="string">LDY .tempWorkspaceE6                                ; get key number</span>
        <span class="string">JSR .getStringLength                                ; and set up .tempStoreFB</span>
        <span class="string">LDA .softKeyPage,Y                                  ; get start of string</span>
        <span class="string">TAY                                                 ; put it in Y</span>
        <span class="string">CLC                                                 ; clear carry</span>
        <span class="string">ADC .tempStoreFB                                    ; add number of bytes above string</span>
        <span class="string">TAX                                                 ; put this in X</span>
        <span class="string">STA .tempStoreFA                                    ; and store it</span>
        <span class="string">LDA .softKeyStringLength                            ; check number of bytes left to remove from key buffer</span>
                                                            <span class="string">; if not 0 key is being used (definition expanded) so</span>
                                                            <span class="string">; error.  This stops *KEY 1 "</span><span class="plain">*</span><span class="identifier">key1</span><span class="plain"> </span><span class="identifier">FRED</span><span class="string">" etc.</span>
        <span class="string">BEQ +                                               ; if not in use continue</span>
    <span class="string">.keyInUseError</span>
        <span class="string">BRK                                                 ;</span>
        <span class="string">!byte $FA                                           ; error number</span>
        <span class="string">!text "</span><span class="identifier">Key</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">use</span><span class="string">",0                                ;</span>
    <span class="string">+</span>
        <span class="string">DEC .softKeyConsistencyFlag                         ; decrement consistency flag to $FF to warn that key definitions are being changed</span>
        <span class="string">PLA                                                 ; pull A</span>
        <span class="string">SEC                                                 ;</span>
        <span class="string">SBC .tempStoreFA                                    ; subtract .tempStoreFA</span>
        <span class="string">STA .tempStoreFA                                    ; and re store it</span>
        <span class="string">BEQ +                                               ; if 0 then branch</span>
    <span class="string">-</span>
        <span class="string">LDA .softKeyPage + 1,X                              ; else move string</span>
        <span class="string">STA .softKeyPage + 1,Y                              ; from X to Y</span>
        <span class="string">INY                                                 ;</span>
        <span class="string">INX                                                 ;</span>
        <span class="string">DEC .tempStoreFA                                    ; for length of string</span>
        <span class="string">BNE -                                               ;</span>

    <span class="string">+</span>
        <span class="string">TYA                                                 ; store end of moved string(s)</span>
        <span class="string">PHA                                                 ;</span>
        <span class="string">LDY .tempWorkspaceE6                                ; get back key number</span>
        <span class="string">LDX #$10                                            ; point at top of last string</span>
    <span class="string">-</span>
        <span class="string">LDA .softKeyPage,X                                  ; get this value</span>
        <span class="string">CMP .softKeyPage,Y                                  ; compare it with start of new or re defined key</span>
        <span class="string">BCC +                                               ; if less then branch</span>
        <span class="string">BEQ +                                               ; if = then branch</span>
        <span class="string">SBC .tempStoreFB                                    ; shift key definitions accordingly</span>
        <span class="string">STA .softKeyPage,X                                  ;</span>
    <span class="string">+</span>
        <span class="string">DEX                                                 ; point to next lowest string def</span>
        <span class="string">BPL -                                               ; and if =&gt;0 then loop and do it again</span>
        <span class="string">LDA .softKeysCurrentEndOffset                       ; else make top of key definitions</span>
        <span class="string">STA .softKeyPage,Y                                  ; the start of our key def</span>
        <span class="string">PLA                                                 ; get new end of strings</span>
        <span class="string">STA .softKeysCurrentEndOffset                       ; and store it</span>
        <span class="string">TAX                                                 ; put A in X</span>
        <span class="string">INC .softKeyConsistencyFlag                         ; reset consistency flag</span>
        <span class="string">PLP                                                 ; restore flags</span>
        <span class="string">RTS                                                 ; and exit</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">.bufferAddressesHigh</span>
        <span class="string">!byte &gt;(.keyboardInputBuffer - .keyboardInputBufferOffset)          ; 0 = Keyboard</span>
        <span class="string">!byte &gt;(.tapeOrRS423InputBuffer - .tapeOrRS423InputBufferOffset)    ; 1 = RS423 Input</span>
        <span class="string">!byte &gt;(.tapeOrRS423OutputBuffer - .rs423OutputBufferOffset)        ; 2 = RS423 output</span>
        <span class="string">!byte &gt;(.printerBuffer - .printerBufferOffset)                      ; 3 = printer</span>
        <span class="string">!byte &gt;(.soundChannel0Buffer - .soundChannel0BufferOffset)          ; 4 = sound channel 0</span>
        <span class="string">!byte &gt;(.soundChannel1Buffer - .soundChannel1BufferOffset)          ; 5 = sound channel 1</span>
        <span class="string">!byte &gt;(.soundChannel2Buffer - .soundChannel2BufferOffset)          ; 6 = sound channel 2</span>
        <span class="string">!byte &gt;(.soundChannel3Buffer - .soundChannel3BufferOffset)          ; 7 = sound channel 3</span>
        <span class="string">!byte &gt;(.speechBuffer - .speechBufferOffset)                        ; 8 = speech</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">.bufferAddressesLow</span>
        <span class="string">!byte &lt;(.keyboardInputBuffer - .keyboardInputBufferOffset)          ; 0 = Keyboard</span>
        <span class="string">!byte &lt;(.tapeOrRS423InputBuffer - .tapeOrRS423InputBufferOffset)    ; 1 = RS423 Input</span>
        <span class="string">!byte &lt;(.tapeOrRS423OutputBuffer - .rs423OutputBufferOffset)        ; 2 = RS423 output</span>
        <span class="string">!byte &lt;(.printerBuffer - .printerBufferOffset)                      ; 3 = printer</span>
        <span class="string">!byte &lt;(.soundChannel0Buffer - .soundChannel0BufferOffset)          ; 4 = sound channel 0</span>
        <span class="string">!byte &lt;(.soundChannel1Buffer - .soundChannel1BufferOffset)          ; 5 = sound channel 1</span>
        <span class="string">!byte &lt;(.soundChannel2Buffer - .soundChannel2BufferOffset)          ; 6 = sound channel 2</span>
        <span class="string">!byte &lt;(.soundChannel3Buffer - .soundChannel3BufferOffset)          ; 7 = sound channel 3</span>
        <span class="string">!byte &lt;(.speechBuffer - .speechBufferOffset)                        ; 8 = speech</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">.emptyBufferStartOffset</span>
        <span class="string">!byte .keyboardInputBufferOffset                    ; 0 = Keyboard</span>
        <span class="string">!byte .tapeOrRS423InputBufferOffset                 ; 1 = RS423 Input</span>
        <span class="string">!byte .rs423OutputBufferOffset                      ; 2 = RS423 output</span>
        <span class="string">!byte .printerBufferOffset                          ; 3 = printer</span>
        <span class="string">!byte .soundChannel0BufferOffset                    ; 4 = sound channel 0</span>
        <span class="string">!byte .soundChannel1BufferOffset                    ; 5 = sound channel 1</span>
        <span class="string">!byte .soundChannel2BufferOffset                    ; 6 = sound channel 2</span>
        <span class="string">!byte .soundChannel3BufferOffset                    ; 7 = sound channel 3</span>
        <span class="string">!byte .speechBufferOffset                           ; 8 = speech</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X=buffer number</span>
    <span class="string">;</span>
    <span class="string">;                      Address      Empty     Start      End</span>
    <span class="string">; Buffer number        Range        Flag      pointer    pointer</span>
    <span class="string">; --------------------------------------------------------------</span>
    <span class="string">; 0 = Keyboard         3E0-3FF      2CF       2D8        2E1</span>
    <span class="string">; 1 = RS423 Input      A00-AFF      2D0       2D9        2E2</span>
    <span class="string">; 2 = RS423 output     900-9BF      2D1       2DA        2E3</span>
    <span class="string">; 3 = printer          880-8BF      2D2       2DB        2E4</span>
    <span class="string">; 4 = sound0           840-84F      2D3       2DC        2E5</span>
    <span class="string">; 5 = sound1           850-85F      2D4       2DD        2E6</span>
    <span class="string">; 6 = sound2           860-86F      2D5       2DE        2E7</span>
    <span class="string">; 7 = sound3           870-87F      2D6       2DF        2E8</span>
    <span class="string">; 8 = speech           8C0-8FF      2D7       2E0        2E9</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.getBufferAddress</span>
        <span class="string">LDA .bufferAddressesLow,X                           ; get buffer base address low</span>
        <span class="string">STA .tempStoreFA                                    ; store it</span>
        <span class="string">LDA .bufferAddressesHigh,X                          ; get buffer base address high</span>
        <span class="string">STA .tempStoreFB                                    ; store it</span>
        <span class="string">RTS                                                 ;</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 152 - Examine buffer status</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X = buffer number</span>
    <span class="string">; On Exit:</span>
    <span class="string">;       $FA/$FB points to buffer start</span>
    <span class="string">;       Y is offset to next character</span>
    <span class="string">;</span>
    <span class="string">;       if buffer is empty C=1, Y is preserved</span>
    <span class="string">;                     else C=0</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte152EntryPoint</span>
        <span class="string">BIT .allBitsSet                                     ; set V flag (meaning examine buffer)</span>
        <span class="string">BVS .remJumper                                      ; ALWAYs branch (to REMV)</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 145 - Get byte from buffer</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X = buffer number</span>
    <span class="string">; On Exit:</span>
    <span class="string">;       Y = character extracted</span>
    <span class="string">;       if buffer is empty C=1, else C=0</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte145EntryPoint</span>
        <span class="string">CLV                                                 ; clear V</span>
    <span class="string">.remJumper</span>
        <span class="string">JMP (.vectorREMV)                                   ; Jump via REMV. Default destination is .remEntryPoint below</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; REMV - default entry point for remove from buffer vector</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X = buffer number</span>
    <span class="string">;       V = 1 if only examination is requested</span>
    <span class="string">; On Exit:</span>
    <span class="string">;       Examination Only:   A = next byte to be removed</span>
    <span class="string">;                           X preserved</span>
    <span class="string">;                           Y undefined</span>
    <span class="string">;</span>
    <span class="string">;       Removal:            A undefined</span>
    <span class="string">;                           X preserved</span>
    <span class="string">;                           Y = value of the byte removed</span>
    <span class="string">;</span>
    <span class="string">;       if buffer was already empty C=1</span>
    <span class="string">;                              else C=0</span>
    <span class="string">;</span>
    <span class="string">; Used by: OSBYTE 152 - examine buffer status</span>
    <span class="string">;      and OSBYTE 145 - get byte from buffer</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.remEntryPoint</span>
        <span class="string">PHP                                                 ; push flags</span>
        <span class="string">SEI                                                 ; disable interrupts</span>
        <span class="string">LDA .bufferStartIndices,X                           ; get output pointer for buffer X</span>
        <span class="string">CMP .bufferEndIndices,X                             ; compare to input pointer</span>
        <span class="string">BEQ .pullSetCarryAndExit                            ; if equal buffer is empty so exit</span>
        <span class="string">TAY                                                 ; Y = buffer start position</span>
        <span class="string">JSR .getBufferAddress                               ; and get buffer pointer into .tempStoreFA/B</span>
        <span class="string">LDA (.tempStoreFA),Y                                ; read byte from buffer</span>
        <span class="string">BVS .pullClearCarryAndExit                          ; if V is set (only examination) exit with CARRY clear</span>
                                                            <span class="string">; OSBYTE 152 has been done</span>
        <span class="string">PHA                                                 ; must be OSBYTE 145 so save byte</span>
        <span class="string">INY                                                 ; increment Y</span>
        <span class="string">TYA                                                 ; A=Y</span>
        <span class="string">BNE +                                               ; if end of buffer not reached then branch</span>
        <span class="string">LDA .emptyBufferStartOffset,X                       ; get pointer start from offset table</span>
    <span class="string">+</span>
        <span class="string">STA .bufferStartIndices,X                           ; set buffer output pointer</span>
        <span class="string">CPX #2                                              ;</span>
        <span class="string">BCC .recallAndExit                                  ; if buffer is input (0=keyboard or 1=RS423 input) then branch</span>

        <span class="string">CMP .bufferEndIndices,X                             ; for output buffers compare with buffer start</span>
        <span class="string">BNE .recallAndExit                                  ; if not the same (buffer is not empty) then branch</span>

        <span class="string">LDY #.eventOutputBufferBecomesEmpty                 ; buffer is empty so Y=0</span>
        <span class="string">JSR .eventEntryPoint                                ; and enter EVENT routine to signal EVENT 0 - buffer becoming empty</span>

    <span class="string">.recallAndExit</span>
        <span class="string">PLA                                                 ; get back byte from buffer</span>
        <span class="string">TAY                                                 ; put it in Y</span>
    <span class="string">.pullClearCarryAndExit</span>
        <span class="string">PLP                                                 ; get back flags</span>
        <span class="string">CLC                                                 ; clear carry to indicate success</span>
        <span class="string">RTS                                                 ; and exit</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; Cause an event</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">; on entry Y=event number</span>
    <span class="string">; A and X may be significant Y=A, A=event number when event generated @E4A1</span>
    <span class="string">; on exit carry clear indicates action has been taken else carry set</span>
    <span class="string">.eventEntryPoint</span>
        <span class="string">PHP                                                 ; push flags</span>
        <span class="string">SEI                                                 ; disable interrupts</span>
        <span class="string">PHA                                                 ; push A</span>
        <span class="string">STA .tempStoreFA                                    ; .tempStoreFA=A</span>
        <span class="string">LDA .eventEnabledFlags,Y                            ; get enable event flag</span>
        <span class="string">BEQ .pullTwiceSetCarryAndExit                       ; if (event is not enabled) then branch (exit with carry set)</span>
        <span class="string">TYA                                                 ; Y=event enabled flag</span>
        <span class="string">LDY .tempStoreFA                                    ; Y=original A</span>
        <span class="string">JSR .eventJumper                                    ; call the EVENV vector</span>
        <span class="string">PLA                                                 ; get back A</span>
        <span class="string">PLP                                                 ; get back flags</span>
        <span class="string">CLC                                                 ; clear carry for success</span>
        <span class="string">RTS                                                 ; and exit</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">.generateEventAndPutByteIntoBuffer</span>
        <span class="string">TYA                                                 ; A=Y</span>
        <span class="string">LDY #.eventCharacterEnteringInputBuffer             ; Y=2</span>
        <span class="string">JSR .eventEntryPoint                                ; send event</span>
        <span class="string">TAY                                                 ; Y=A</span>
        <span class="string">; fall through...</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 138 - Put byte into buffer</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X is buffer number</span>
    <span class="string">;       Y is character to be written</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte138EntryPoint</span>
        <span class="string">TYA                                                 ; A=Y</span>
    <span class="string">.insJumper</span>
        <span class="string">JMP (.vectorINSV)                                   ; jump to INSV</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; INSV - insert value into buffer - default entry point</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       A is value to write</span>
    <span class="string">;       X is buffer number</span>
    <span class="string">; On Exit:</span>
    <span class="string">;       A preserved</span>
    <span class="string">;       X preserved</span>
    <span class="string">;       C clear on success</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.insEntryPoint</span>
        <span class="string">PHP                                                 ; save flags</span>
        <span class="string">SEI                                                 ; disable interrupts</span>
        <span class="string">PHA                                                 ; save A</span>
        <span class="string">LDY .bufferEndIndices,X                             ; get buffer input pointer</span>
        <span class="string">INY                                                 ; increment Y to next byte</span>
        <span class="string">BNE +                                               ; if not reached the end index, skip forward</span>
        <span class="string">LDY .emptyBufferStartOffset,X                       ; set back to the start index</span>
    <span class="string">+</span>
        <span class="string">TYA                                                 ; put it in A</span>
        <span class="string">CMP .bufferStartIndices,X                           ; compare it with input pointer</span>
        <span class="string">BEQ .insertIntoFullBuffer                           ; if buffer is full then branch</span>
        <span class="string">LDY .bufferEndIndices,X                             ; get buffer end in Y</span>
        <span class="string">STA .bufferEndIndices,X                             ; set new offset</span>
        <span class="string">JSR .getBufferAddress                               ; and point .tempStoreFA/B at it</span>
        <span class="string">PLA                                                 ; get back value to write</span>
        <span class="string">STA (.tempStoreFA),Y                                ; write it in buffer</span>
        <span class="string">PLP                                                 ; pull flags</span>
        <span class="string">CLC                                                 ; clear carry for success</span>
        <span class="string">RTS                                                 ; and exit</span>

    <span class="string">.insertIntoFullBuffer</span>
        <span class="string">PLA                                                 ; get back byte</span>
        <span class="string">CPX #2                                              ; }</span>
        <span class="string">BCS .pullSetCarryAndExit                            ; } if we are working on output buffer then branch</span>

        <span class="string">LDY #.eventInputBufferBecomesFull                   ; input buffer is full</span>
        <span class="string">JSR .eventEntryPoint                                ; to service input buffer full event</span>
        <span class="string">PHA                                                 ; push A</span>

    <span class="string">.pullTwiceSetCarryAndExit</span>
        <span class="string">PLA                                                 ; restore A</span>
    <span class="string">.pullSetCarryAndExit</span>
        <span class="string">PLP                                                 ; restore flags</span>
        <span class="string">SEC                                                 ; set carry</span>
        <span class="string">RTS                                                 ; and exit</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       A = character to check</span>
    <span class="string">; On Exit:</span>
    <span class="string">;       Preserves A</span>
    <span class="string">;       Carry clear if character is an upper or lower case letter (A-Z or a-z)</span>
    <span class="string">;       otherwise carry set</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.isLetter</span>
        <span class="string">PHA                                                 ; Save A</span>
        <span class="string">AND #$DF                                            ; convert lower to upper case</span>
        <span class="string">CMP #.charA                                         ; compare with 'A'</span>
        <span class="string">BCC .noLetter                                       ; if lower than 'A' then branch (exit routine with carry set)</span>
        <span class="string">CMP #.charZ + 1                                     ; compare with 'Z' + 1</span>
        <span class="string">BCC .yesLetter                                      ; if no larger than 'Z' then branch (exit with carry clear)</span>
    <span class="string">.noLetter</span>
        <span class="string">SEC                                                 ; set carry</span>
    <span class="string">.yesLetter</span>
        <span class="string">PLA                                                 ; restore original value of A</span>
        <span class="string">RTS                                                 ;</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">.insertByteIntoKeyboardBuffer</span>
        <span class="string">LDX #0                                              ; X=0 to indicate keyboard buffer</span>
        <span class="string">; fall through...</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 153 - Put byte in input buffer (checking for ESCAPE)</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X is buffer number:</span>
    <span class="string">;           1 is RS423 input</span>
    <span class="string">;           0 is Keyboard</span>
    <span class="string">;       Y is character to be written</span>
    <span class="string">;</span>
    <span class="string">; On Exit:</span>
    <span class="string">;       Carry clear</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte153EntryPoint</span>
        <span class="string">TXA                                                 ; A=buffer number</span>
        <span class="string">AND .rs423Mode                                      ; and with RS423 mode (0 = treat as keyboard; 1 = ignore Escapes; no events; no soft keys)</span>
        <span class="string">BNE .osbyte138EntryPoint                            ; if (RS423 input buffer) AND (RS423 in normal mode) then branch (enter byte into buffer)</span>
        <span class="string">TYA                                                 ; Y=character to write</span>
        <span class="string">EOR .asciiCodeThatGeneratesESCAPEAction             ; compare with current escape ASCII code (0=match)</span>
        <span class="string">ORA .escapeAction                                   ; or with current ESCAPE status (0=ESC, 1=ASCII)</span>
        <span class="string">BNE .generateEventAndPutByteIntoBuffer              ; if (not ESCAPE character) OR (ESCAPE action says ASCII) then branch (to enter byte in buffer)</span>
        <span class="string">LDA .escapeAndBreakEffect                           ; get ESCAPE/BREAK effect byte</span>
        <span class="string">ROR                                                 ; Rotate to get ESCAPE bit into carry</span>
        <span class="string">TYA                                                 ; get character back in A</span>
        <span class="string">BCS .exitWithCarryClear                             ; if (escape effect disabled) then branch (exit with carry clear)</span>
        <span class="string">LDY #.eventESCAPEConditionDetected                  ; signal event "</span><span class="identifier">Escape</span><span class="plain"> </span><span class="identifier">condition</span><span class="plain"> </span><span class="identifier">detected</span><span class="string">"</span>
        <span class="string">JSR .eventEntryPoint                                ;</span>
        <span class="string">BCC .exitWithCarryClear                             ; if (event handles ESCAPE) then branch (exit with carry clear)</span>
        <span class="string">JSR .osbyte125EntryPoint                            ; set ESCAPE flag</span>

    <span class="string">.exitWithCarryClear</span>
        <span class="string">CLC                                                 ; clear carry</span>
        <span class="string">RTS                                                 ; and exit</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">; get a byte from keyboard buffer and interpret as necessary</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       A = cursor editing status</span>
    <span class="string">;           1 = return $87 - $8B (codes for COPY, LEFT, RIGHT, DOWN, UP)</span>
    <span class="string">;           2 = use cursor keys as soft keys 11-15</span>
    <span class="string">;</span>
    <span class="string">;           this code not reached if cursor editing is normal</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.handleCursorKeysAndCOPYPress</span>
        <span class="string">ROR                                                 ; get bit 0 into carry</span>
                                                            <span class="string">; carry set for (cursor keys return codes $87-$8B)</span>
                                                            <span class="string">; carry clear for (cursor keys and COPY key are soft keys 11=COPY,12=LEFT,13=RIGHT,14=DOWN,15=UP)</span>
        <span class="string">PLA                                                 ; get back character A</span>
        <span class="string">BCS .exitWithCarryClear2                            ; if (carry is set) then return</span>
                                                            <span class="string">; cursor keys are 'soft'</span>
        <span class="string">; fall through...</span>

    <span class="string">.handleFunctionKeyPress</span>
        <span class="string">TYA                                                 ; A=Y get back original key code ($80-$FF)</span>
        <span class="string">PHA                                                 ; PUSH A</span>
        <span class="string">LSR                                                 ; }</span>
        <span class="string">LSR                                                 ; }</span>
        <span class="string">LSR                                                 ; } shift high nybble down into low nybble</span>
        <span class="string">LSR                                                 ; }</span>
                                                            <span class="string">; A=$08 - $0F</span>
        <span class="string">EOR #4                                              ; invert bit 2</span>
                                                            <span class="string">; $08 becomes $0C</span>
                                                            <span class="string">; $09 becomes $0D</span>
                                                            <span class="string">; $0A becomes $0E</span>
                                                            <span class="string">; $0B becomes $0F</span>
                                                            <span class="string">; $0C becomes $08</span>
                                                            <span class="string">; $0D becomes $09</span>
                                                            <span class="string">; $0E becomes $0A</span>
                                                            <span class="string">; $0F becomes $0B</span>
        <span class="string">TAY                                                 ;</span>
        <span class="string">LDA .functionAndCursorKeyCodes - 8,Y                ; read code interpretation status</span>
                                                            <span class="string">; 0=ignore key, 1=expand as 'soft' key</span>
                                                            <span class="string">; 2-$FF add this to base for ASCII code</span>
                                                            <span class="string">; note that provision is made for keypad operation</span>
                                                            <span class="string">; as codes $C0-$FF cannot be generated from keyboard</span>
                                                            <span class="string">; but are recognised by OS</span>

        <span class="string">CMP #1                                              ; is it 1</span>
        <span class="string">BEQ .expandSoftKey                                  ; if so expand as 'soft' key</span>
        <span class="string">PLA                                                 ; get back original byte</span>
        <span class="string">BCC .readFromInputBufferX                           ; if above CMP generated Carry then code 0 must have</span>
                                                            <span class="string">; been returned so .readFromInputBufferX to ignore</span>
        <span class="string">AND #$0F                                            ; else add ASCII to BASE key number so clear high nybble</span>
        <span class="string">CLC                                                 ; clear carry</span>
        <span class="string">ADC .functionAndCursorKeyCodes - 8,Y                ; add ASCII base</span>
        <span class="string">CLC                                                 ; clear carry</span>
        <span class="string">RTS                                                 ; and exit</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">.errorOnReadingCharacterFromScreen</span>
        <span class="string">JSR .vdu7EntryPoint                                 ; produce bell</span>
        <span class="string">PLA                                                 ; get back A, buffer number</span>
        <span class="string">TAX                                                 ; X=buffer number</span>
        <span class="string">; fall through...</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; Read from input buffer X (0 = keyboard; 1 = RS423)</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.readFromInputBufferX</span>
        <span class="string">JSR .osbyte145EntryPoint                            ; get byte from buffer X</span>
        <span class="string">BCS .exit21                                         ; if buffer is empty then branch (return)</span>
        <span class="string">PHA                                                 ; push byte received</span>
        <span class="string">CPX #.bufferNumberRS423Input                        ; }</span>
        <span class="string">BNE +                                               ; } if RS423 input buffer is not the one then branch</span>

        <span class="string">JSR .setRS423Active                                 ;</span>
        <span class="string">LDX #.bufferNumberRS423Input                        ; X=RS423 input buffer</span>
        <span class="string">SEC                                                 ; set carry</span>
    <span class="string">+</span>
        <span class="string">PLA                                                 ; get back original byte</span>
        <span class="string">BCC +                                               ; if carry clear (not RS423 input) then branch forward</span>
        <span class="string">LDY .rs423Mode                                      ; else Y=RS423 mode</span>
                                                            <span class="string">;   0 means treat RS423 input same as keyboard</span>
                                                            <span class="string">;   1 means ESCAPE is ignored; soft keys are not expanded; no events are triggered</span>
        <span class="string">BNE .exitWithCarryClear2                            ; if (normal RS423 mode) then branch (exit)</span>

    <span class="string">+</span>
        <span class="string">TAY                                                 ; Y=original character to add to buffer</span>
        <span class="string">BPL .exitWithCarryClear2                            ; if (code is less than $80) then branch (it's simple, so exit)</span>
        <span class="string">AND #%00001111                                      ; clear high nybble</span>
        <span class="string">CMP #11                                             ; compare with 11</span>
        <span class="string">BCC .handleFunctionKeyPress                         ; if less than 11 (function key) then branch</span>
        <span class="string">ADC #$7B                                            ; add $7C ($7B +C) to convert codes $0B-$0F to $87-$8B</span>
        <span class="string">PHA                                                 ; Push A</span>
        <span class="string">LDA .cursorEditingState                             ; get cursor editing status</span>
        <span class="string">BNE .handleCursorKeysAndCOPYPress                   ; if (not standard cursor key editing) then branch</span>
        <span class="string">LDA .characterDestinationStatus                     ; else get character destination status</span>

                                                            <span class="string">; bit 0 - enable RS423 driver</span>
                                                            <span class="string">; bit 1 - disable VDU driver</span>
                                                            <span class="string">; bit 2 - disable printer driver</span>
                                                            <span class="string">; bit 3 - enable printer, independent of CTRL-B/C</span>
                                                            <span class="string">; bit 4 - disable SPOOLed output</span>
                                                            <span class="string">; bit 5 - not used</span>
                                                            <span class="string">; bit 6 - disable printed driver (unless preceded by VDU 1)</span>
                                                            <span class="string">; bit 7 - not used</span>

        <span class="string">ROR                                                 ; get bit 1 into carry</span>
        <span class="string">ROR                                                 ;</span>
        <span class="string">PLA                                                 ;</span>
        <span class="string">BCS .readFromInputBufferX                           ; if carry is set (VDU disabled) then branch</span>
        <span class="string">CMP #.charCOPY                                      ; check for COPY key</span>
        <span class="string">BEQ .handleCOPYkeyToReadCharacterFromScreen         ; if (COPY key pressed) then branch (handle COPY key)</span>

        <span class="string">TAY                                                 ; Y=A</span>
        <span class="string">TXA                                                 ; A=X</span>
        <span class="string">PHA                                                 ; Push X</span>
        <span class="string">TYA                                                 ; get back Y</span>
        <span class="string">JSR .someRoutine                                    ; execute edit action</span>

        <span class="string">PLA                                                 ; restore X</span>
        <span class="string">TAX                                                 ;</span>

    <span class="string">.readFromEconetOrSoftKeyOrInputBufferA</span>
        <span class="string">BIT .econetReadCharacterInterpretationStatus        ; check econet RDCH flag</span>
        <span class="string">BPL .readFromSoftKeyOrInputBufferA                  ; if not set then branch</span>
        <span class="string">LDA #6                                              ; Econet function 6</span>
    <span class="string">.netvJumper</span>
        <span class="string">JMP (.vectorNETV)                                   ; to the Econet vector</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">.readFromSoftKeyOrInputBufferA</span>
        <span class="string">LDA .softKeyStringLength                            ; get length of soft key string</span>
        <span class="string">BEQ .readFromInputBufferX                           ; if no soft key then get a character from the buffer</span>
        <span class="string">LDY .softKeyExpansionPointer                        ; get soft key expansion pointer</span>
        <span class="string">LDA .softKeyPage + 1,Y                              ; get character from string</span>
        <span class="string">INC .softKeyExpansionPointer                        ; increment pointer</span>
        <span class="string">DEC .softKeyStringLength                            ; decrement length</span>
    <span class="string">.exitWithCarryClear2</span>
        <span class="string">CLC                                                 ;</span>
    <span class="string">.exit21</span>
        <span class="string">RTS                                                 ;</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">; Y=pointer to string number</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.expandSoftKey</span>
        <span class="string">PLA                                                 ; restore original code</span>
        <span class="string">AND #$0F                                            ; get low nybble (key string number)</span>
        <span class="string">TAY                                                 ; Y=A</span>
        <span class="string">JSR .getStringLength                                ; get string length in A</span>
        <span class="string">STA .softKeyStringLength                            ; store it</span>
        <span class="string">LDA .softKeyPage,Y                                  ; get start point</span>
        <span class="string">STA .softKeyExpansionPointer                        ; store it</span>
        <span class="string">BNE .readFromEconetOrSoftKeyOrInputBufferA          ; if not 0 then branch (get byte and exit) (TODO: ALWAYs branch?)</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">.handleCOPYkeyToReadCharacterFromScreen</span>
        <span class="string">TXA                                                 ; A=X</span>
        <span class="string">PHA                                                 ; Push A</span>
        <span class="string">JSR .readCharacterFromScreenAndCursorRight          ; read a character from the screen</span>
        <span class="string">TAY                                                 ; Y=A</span>
        <span class="string">BEQ .errorOnReadingCharacterFromScreen              ; if not valid A=0 so BEEP</span>
        <span class="string">PLA                                                 ; else restore X</span>
        <span class="string">TAX                                                 ;</span>
        <span class="string">TYA                                                 ; and Y</span>
        <span class="string">CLC                                                 ; clear carry</span>
        <span class="string">RTS                                                 ; and exit</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE lookup table</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyteRoutineTable</span>
        <span class="string">!word .osbyte0EntryPoint                       ; OSBYTE   0</span>
        <span class="string">!word .osbyte1EntryPoint                       ; OSBYTE   1</span>
        <span class="string">!word .osbyte2EntryPoint                       ; OSBYTE   2</span>
        <span class="string">!word .osbyte3EntryPoint                       ; OSBYTE   3</span>
        <span class="string">!word .osbyte4EntryPoint                       ; OSBYTE   4</span>
        <span class="string">!word .osbyte5EntryPoint                       ; OSBYTE   5</span>
        <span class="string">!word .osbyte6EntryPoint                       ; OSBYTE   6</span>
        <span class="string">!word .osbyte7EntryPoint                       ; OSBYTE   7</span>
        <span class="string">!word .osbyte8EntryPoint                       ; OSBYTE   8</span>
        <span class="string">!word .osbyte9EntryPoint                       ; OSBYTE   9</span>
        <span class="string">!word .osbyte10EntryPoint                      ; OSBYTE  10</span>
        <span class="string">!word .osbyte11EntryPoint                      ; OSBYTE  11</span>
        <span class="string">!word .osbyte12EntryPoint                      ; OSBYTE  12</span>
        <span class="string">!word .osbyte13EntryPoint                      ; OSBYTE  13</span>
        <span class="string">!word .osbyte14EntryPoint                      ; OSBYTE  14</span>
        <span class="string">!word .osbyte15EntryPoint                      ; OSBYTE  15</span>
        <span class="string">!word .osbyte16EntryPoint                      ; OSBYTE  16</span>
        <span class="string">!word .osbyte17EntryPoint                      ; OSBYTE  17</span>
        <span class="string">!word .osbyte18EntryPoint                      ; OSBYTE  18</span>
        <span class="string">!word .osbyte19EntryPoint                      ; OSBYTE  19</span>
        <span class="string">!word .osbyte20EntryPoint                      ; OSBYTE  20</span>
        <span class="string">!word .osbyte21EntryPoint                      ; OSBYTE  21</span>
        <span class="string">!word .osbyte117EntryPoint                     ; OSBYTE 117</span>
        <span class="string">!word .osbyte118EntryPoint                     ; OSBYTE 118</span>
        <span class="string">!word .osbyte119EntryPoint                     ; OSBYTE 119</span>
        <span class="string">!word .osbyte120EntryPoint                     ; OSBYTE 120</span>
        <span class="string">!word .osbyte121EntryPoint                     ; OSBYTE 121</span>
        <span class="string">!word .osbyte122EntryPoint                     ; OSBYTE 122</span>
        <span class="string">!word .osbyte123EntryPoint                     ; OSBYTE 123</span>
        <span class="string">!word .osbyte124EntryPoint                     ; OSBYTE 124</span>
        <span class="string">!word .osbyte125EntryPoint                     ; OSBYTE 125</span>
        <span class="string">!word .osbyte126EntryPoint                     ; OSBYTE 126</span>
        <span class="string">!word .osbyte127EntryPoint                     ; OSBYTE 127</span>
        <span class="string">!word .osbyte128EntryPoint                     ; OSBYTE 128</span>
        <span class="string">!word .osbyte129EntryPoint                     ; OSBYTE 129</span>
        <span class="string">!word .osbyte130EntryPoint                     ; OSBYTE 130</span>
        <span class="string">!word .osbyte131EntryPoint                     ; OSBYTE 131</span>
        <span class="string">!word .osbyte132EntryPoint                     ; OSBYTE 132</span>
        <span class="string">!word .osbyte133EntryPoint                     ; OSBYTE 133</span>
        <span class="string">!word .osbyte134EntryPoint                     ; OSBYTE 134</span>
        <span class="string">!word .osbyte135EntryPoint                     ; OSBYTE 135</span>
        <span class="string">!word .osbyte136EntryPoint                     ; OSBYTE 136</span>
        <span class="string">!word .osbyte137EntryPoint                     ; OSBYTE 137</span>
        <span class="string">!word .osbyte138EntryPoint                     ; OSBYTE 138</span>
        <span class="string">!word .osbyte139EntryPoint                     ; OSBYTE 139</span>
        <span class="string">!word .osbyte140EntryPoint                     ; OSBYTE 140</span>
        <span class="string">!word .osbyte141EntryPoint                     ; OSBYTE 141</span>
        <span class="string">!word .osbyte142EntryPoint                     ; OSBYTE 142</span>
        <span class="string">!word .osbyte143EntryPoint                     ; OSBYTE 143</span>
        <span class="string">!word .osbyte144EntryPoint                     ; OSBYTE 144</span>
        <span class="string">!word .osbyte145EntryPoint                     ; OSBYTE 145</span>
        <span class="string">!word .osbyte146EntryPoint                     ; OSBYTE 146</span>
        <span class="string">!word .osbyte147EntryPoint                     ; OSBYTE 147</span>
        <span class="string">!word .osbyte148EntryPoint                     ; OSBYTE 148</span>
        <span class="string">!word .osbyte149EntryPoint                     ; OSBYTE 149</span>
        <span class="string">!word .osbyte150EntryPoint                     ; OSBYTE 150</span>
        <span class="string">!word .osbyte151EntryPoint                     ; OSBYTE 151</span>
        <span class="string">!word .osbyte152EntryPoint                     ; OSBYTE 152</span>
        <span class="string">!word .osbyte153EntryPoint                     ; OSBYTE 153</span>
        <span class="string">!word .osbyte154EntryPoint                     ; OSBYTE 154</span>
        <span class="string">!word .osbyte155EntryPoint                     ; OSBYTE 155</span>
        <span class="string">!word .osbyte156EntryPoint                     ; OSBYTE 156</span>
        <span class="string">!word .osbyte157EntryPoint                     ; OSBYTE 157</span>
        <span class="string">!word .osbyte158EntryPoint                     ; OSBYTE 158</span>
        <span class="string">!word .osbyte159EntryPoint                     ; OSBYTE 159</span>
        <span class="string">!word .osbyte160EntryPoint                     ; OSBYTE 160</span>
        <span class="string">!word .osbyte166to255EntryPoint                ; OSBYTE 166 to 255</span>
        <span class="string">!word .starCodeLineEntryPoint                  ;</span>

    <span class="string">;</span>
    <span class="string">; OSWORD lookup table - effectively a continuation of the same table as above</span>
    <span class="string">;</span>
        <span class="string">!word .osword0EntryPoint                       ; OSWORD   0</span>
        <span class="string">!word .osword1EntryPoint                       ; OSWORD   1</span>
        <span class="string">!word .osword2EntryPoint                       ; OSWORD   2</span>
        <span class="string">!word .osword3EntryPoint                       ; OSWORD   3</span>
        <span class="string">!word .osword4EntryPoint                       ; OSWORD   4</span>
        <span class="string">!word .osword5EntryPoint                       ; OSWORD   5</span>
        <span class="string">!word .osword6EntryPoint                       ; OSWORD   6</span>
        <span class="string">!word .osword7EntryPoint                       ; OSWORD   7</span>
        <span class="string">!word .osword8EntryPoint                       ; OSWORD   8</span>
        <span class="string">!word .osword9EntryPoint                       ; OSWORD   9</span>
        <span class="string">!word .osword10EntryPoint                      ; OSWORD  10</span>
        <span class="string">!word .osword11EntryPoint                      ; OSWORD  11</span>
        <span class="string">!word .osword12EntryPoint                      ; OSWORD  12</span>
        <span class="string">!word .osword13EntryPoint                      ; OSWORD  13</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 136 - Execute code via User Vector (i.e. *LINE)</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte136EntryPoint</span>
        <span class="string">LDA #0                                              ; A=0</span>
        <span class="string">; fall through...</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; *CODE / *LINE</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.starCodeLineEntryPoint</span>
        <span class="string">JMP (.vectorUSERV)                                  ; Jump via USERV</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 126 - Acknowledge detection of ESCAPE condition</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte126EntryPoint</span>
        <span class="string">LDX #0                                              ; X=0</span>
        <span class="string">BIT .escapeFlag                                     ; check for ESCAPE flag</span>
        <span class="string">BPL .osbyte124EntryPoint                            ; if (no ESCAPE flag) then branch (just clear ESCAPE condition)</span>
        <span class="string">LDA .escapeEffects                                  ; get ESCAPE effects</span>
        <span class="string">BNE +                                               ; if (escape effects is non-zero) then branch (no effects)</span>

                                                            <span class="string">; reset VDU paging counter</span>
                                                            <span class="string">; close EXEC files</span>
                                                            <span class="string">; purge all buffers</span>
                                                            <span class="string">; Clear ESCAPE condition</span>

        <span class="string">CLI                                                 ; allow interrupts</span>
        <span class="string">STA .pagedModeCounter                               ; zero the number of lines printed since last halt in paged mode</span>
        <span class="string">JSR .closeExecFiles                                 ; close any open EXEC files</span>
        <span class="string">JSR .flushAllBuffers                                ; clear all buffers</span>
    <span class="string">+</span>
        <span class="string">LDX #$FF                                            ; X=$FF to indicate ESCAPE acknowledged</span>
        <span class="string">; fall through...</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 124 - Clear ESCAPE condition</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte124EntryPoint</span>
        <span class="string">CLC                                                ; clear carry</span>
        <span class="string">; fall through...</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 125 - Set ESCAPE condition</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte125EntryPoint</span>
        <span class="string">ROR .escapeFlag                                    ; clear  bit 7 of ESCAPE flag</span>
        <span class="string">BIT .tubePresentFlag                               ; read bit 7 of Tube flag</span>
        <span class="string">BMI +                                              ; if Tube exists then branch</span>
        <span class="string">RTS                                                ; else RETURN</span>
    <span class="string">+</span>
        <span class="string">JMP .tubeCopyESCAPEFlagToSecondProcessor           ; Jump into Tube entry point</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 137 - Turn on tape motor</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte137EntryPoint</span>
        <span class="string">LDA .serialULARegisterCopy                         ; get serial ULA control setting</span>
        <span class="string">TAY                                                ; Y=A</span>
        <span class="string">ROL                                                ; rotate left (shifts bit 7 into carry)</span>
        <span class="string">CPX #1                                             ; if X=1 (turn on motor) then set carry</span>
        <span class="string">ROR                                                ; rotate carry back in serialULA copy (bit 7)</span>
        <span class="string">BVC .setSerialULADirectly                          ; ALWAYs branch</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 8 - Set RS423 baud rate for transmitting data</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X = baud rate</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte8EntryPoint</span>
        <span class="string">LDA #%00111000                                      ; Once it's EOR'd with the next instruction,</span>
                                                            <span class="string">; this value becomes %00000111 (set transmit baud rate)</span>
        <span class="string">; fall through...</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 7 - Set RS423 baud rate for receiving data</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X = baud rate</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte7EntryPoint</span>
        <span class="string">EOR #%00111111                                     ; converts 7 -&gt; $38 = %00111000 (set receive baud rate)</span>
                                                        <span class="string">; converts $38 -&gt; 7 = %00000111 (set transmit baud rate)</span>
        <span class="string">STA .tempStoreFA                                   ; store result</span>
        <span class="string">LDY .serialULARegisterCopy                         ; get serial ULA control register setting</span>
        <span class="string">CPX #9                                             ; }</span>
        <span class="string">BCS .putNewSettingYInXAndReturn                    ; } is it 9 or more then branch (exit)</span>
        <span class="string">AND .bufferTypeAndSerialBaudRatesTable,X           ; and with byte from look up table</span>
        <span class="string">STA .tempStoreFB                                   ; store it</span>
        <span class="string">TYA                                                ; put Y in A</span>
        <span class="string">ORA .tempStoreFA                                   ; set the transmit or receive baud rate bits to 1</span>
        <span class="string">EOR .tempStoreFA                                   ; zero the transmit or receive baud rate bits to 0</span>
        <span class="string">ORA .tempStoreFB                                   ; set baud rate from value read from table lookup</span>
        <span class="string">ORA #$40                                           ; set bit 6</span>
        <span class="string">EOR .tapeRS423SelectionFlag                        ; clear bit 6 if tape active (0=RS423 or $40=TAPE)</span>
    <span class="string">.setSerialULADirectly</span>
        <span class="string">STA .serialULARegisterCopy                         ; store serial ULA flag</span>
        <span class="string">STA .serialULAControlRegister                      ; and write to control register</span>
    <span class="string">.putNewSettingYInXAndReturn</span>
        <span class="string">TYA                                                ; put Y in A to save old contents</span>
    <span class="string">.setXAndReturn</span>
        <span class="string">TAX                                                ; write new setting to X</span>
        <span class="string">RTS                                                ; and return</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 9 - Duration of first colour</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;      Y = 0</span>
    <span class="string">;      X = new value</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte9EntryPoint</span>
        <span class="string">INY                                                 ; Y=1</span>
        <span class="string">CLC                                                 ; clear carry</span>
        <span class="string">; fall through...</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 10 - Duration of second colour</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       Y = 0 (or 1 if falling through from OSBYTE 9 call above)</span>
    <span class="string">;       X = new value</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte10EntryPoint</span>
        <span class="string">LDA .videoULAFirstFlashingColourInterval,Y          ; get mark period count</span>
        <span class="string">PHA                                                 ; push it</span>
        <span class="string">TXA                                                 ; get new count</span>
        <span class="string">STA .videoULAFirstFlashingColourInterval,Y          ; store it</span>
        <span class="string">PLA                                                 ; get back original value</span>
        <span class="string">TAY                                                 ; put it in Y</span>
        <span class="string">LDA .videoULAFlashingColourIntervalCount            ; get value of flash counter</span>
        <span class="string">BNE +                                               ; if not zero then branch</span>
        <span class="string">STX .videoULAFlashingColourIntervalCount            ; else restore old value</span>
        <span class="string">LDA .videoULAVideoControlRegisterCopy               ; get current video ULA control register setting</span>
        <span class="string">PHP                                                 ; push flags</span>
        <span class="string">ROR                                                 ; rotate bit 0 into carry, carry into bit 7</span>
        <span class="string">PLP                                                 ; get back flags</span>
        <span class="string">ROL                                                 ; rotate back carry into bit 0</span>
        <span class="string">STA .videoULAVideoControlRegisterCopy               ; store it in RAM copy</span>
        <span class="string">STA .videoULAControlRegister                        ; and ULA control register</span>
    <span class="string">+</span>
        <span class="string">BVC .putNewSettingYInXAndReturn                     ; then exit</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 2 - select input stream</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X contains stream number</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte2EntryPoint</span>
        <span class="string">TXA                                                 ; A=X</span>
        <span class="string">AND #1                                              ; blank out bits 1 - 7</span>
        <span class="string">PHA                                                 ; push A</span>
        <span class="string">LDA .rs423ControlRegisterCopy                       ; and get current ACIA control setting</span>
        <span class="string">ROL                                                 ; Bit 7 into carry</span>
        <span class="string">CPX #$01                                            ; if X&gt;=1 then</span>
        <span class="string">ROR                                                 ; bit 7 of A=1</span>
        <span class="string">CMP .rs423ControlRegisterCopy                       ; compare this with ACIA control setting</span>
        <span class="string">PHP                                                 ; push processor</span>
        <span class="string">STA .rs423ControlRegisterCopy                       ; put A into ACIA control setting</span>
        <span class="string">STA .acia6850ControlRegister                        ; and write to control register</span>
        <span class="string">JSR .setRS423Active                                 ; set up RS423 buffer</span>
        <span class="string">PLP                                                 ; get back P</span>
        <span class="string">BEQ +                                               ; if new setting different from old E6F1 else</span>
        <span class="string">BIT .acia6850DataRegister                           ; set bit 6 and 7</span>

    <span class="string">+</span>
        <span class="string">LDX .currentInputBuffer                             ; get current input buffer number</span>
        <span class="string">PLA                                                 ; get back A</span>
        <span class="string">STA .currentInputBuffer                             ; store it</span>
        <span class="string">RTS                                                 ; and return</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 13 - disable events</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X contains event number 0-9</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte13EntryPoint</span>
        <span class="string">TYA                                                 ; Y=0; A=0</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 14 - enable events</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       A contains value to write</span>
    <span class="string">;       X contains event number 0-9</span>
    <span class="string">; On Exit:</span>
    <span class="string">;       Y contains previous value</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte14EntryPoint</span>
        <span class="string">CPX #10                                            ; }</span>
        <span class="string">BCS .setXAndReturn                                 ; } if X&gt;9 then branch (set X from A and return)</span>
        <span class="string">LDY .eventEnabledFlags,X                           ; else get event enable flag</span>
        <span class="string">STA .eventEnabledFlags,X                           ; store new value in flag</span>
        <span class="string">BVC .putNewSettingYInXAndReturn                    ; and exit</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 16 - Select A/D channel</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X contains channel number or 0 if disable conversion</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte16EntryPoint</span>
        <span class="string">BEQ +                                               ; if X=0 then branch</span>
        <span class="string">JSR .osbyte17EntryPoint                             ; start conversion</span>
    <span class="string">+</span>
        <span class="string">LDA .maximumADCChannelNumber                        ; get  current maximum ADC channel number</span>
        <span class="string">STX .maximumADCChannelNumber                        ; store new value</span>
        <span class="string">TAX                                                 ; put old value in X</span>
        <span class="string">RTS                                                 ; and exit</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 129 - Read key within time limit</span>
    <span class="string">;</span>
    <span class="string">; X and Y contains either time limit in centi-seconds (Y=$7F max)</span>
    <span class="string">; or Y=$FF and X=-ve INKEY value</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte129EntryPoint</span>
        <span class="string">TYA                                                 ; A=Y</span>
        <span class="string">BMI .readNegativeKeyNumber                          ; if N set (Y negative) then branch</span>
        <span class="string">CLI                                                 ; allow interrupts</span>
        <span class="string">JSR .osbyte129Timed                                 ; and go to timed routine</span>
        <span class="string">BCS +                                               ; if carry set then branch</span>
        <span class="string">TAX                                                 ; then X=A</span>
        <span class="string">LDA #0                                              ; A=0</span>
    <span class="string">+</span>
        <span class="string">TAY                                                 ; Y=A</span>
        <span class="string">RTS                                                 ;</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">.readNegativeKeyNumber</span>
        <span class="string">TXA                                                 ; A=X</span>
        <span class="string">EOR #$7F                                            ; convert to keyboard input</span>
        <span class="string">TAX                                                 ; X=A</span>
        <span class="string">JSR .keyJumper                                      ; then scan keyboard</span>
        <span class="string">ROL                                                 ; put bit 7 into carry</span>
    <span class="string">.setXYAndExit</span>
        <span class="string">; fall through...</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 130 - Read machine high order address</span>
    <span class="string">; Returns the two bytes to be used to pad the filing system addresses to make up a 32 bit address.</span>
    <span class="string">;</span>
    <span class="string">; On Entry: Carry set if entry is via OSBYTE 130</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte130EntryPoint</span>
        <span class="string">LDX #$FF                                            ; X=$FF</span>
        <span class="string">LDY #$FF                                            ; Y=$FF</span>
        <span class="string">BCS +                                               ; if bit 7 of A was set then branch (exit)</span>
        <span class="string">INX                                                 ; X=0</span>
        <span class="string">INY                                                 ; Y=0</span>
    <span class="string">+</span>
        <span class="string">RTS                                                 ; and exit</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; Get the free space of an input buffer, or the used space for output buffer</span>
    <span class="string">;</span>
    <span class="string">; On Entry:</span>
    <span class="string">;       X=255 - buffer number</span>
    <span class="string">;</span>
    <span class="string">;                              Address      Empty     Start      End</span>
    <span class="string">;         Buffer number        Range        Flag      pointer    pointer</span>
    <span class="string">;         --------------------------------------------------------------</span>
    <span class="string">;         0 = Keyboard         3E0-3FF      2CF       2D8        2E1</span>
    <span class="string">;         1 = RS423 Input      A00-AFF      2D0       2D9        2E2</span>
    <span class="string">;         2 = RS423 output     900-9BF      2D1       2DA        2E3</span>
    <span class="string">;         3 = printer          880-8BF      2D2       2DB        2E4</span>
    <span class="string">;         4 = sound0           840-84F      2D3       2DC        2E5</span>
    <span class="string">;         5 = sound1           850-85F      2D4       2DD        2E6</span>
    <span class="string">;         6 = sound2           860-86F      2D5       2DE        2E7</span>
    <span class="string">;         7 = sound3           870-87F      2D6       2DF        2E8</span>
    <span class="string">;         8 = speech           8C0-8FF      2D7       2E0        2E9</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.countNegativeBuffer</span>
        <span class="string">TXA                                                 ; buffer number in A</span>
        <span class="string">EOR #$FF                                            ; invert it</span>
        <span class="string">TAX                                                 ; X=A</span>
        <span class="string">CPX #2                                              ; is X&gt;=2 (C set if output buffer, get bytes used)</span>
    <span class="string">.countBufferStartup</span>
        <span class="string">CLV                                                 ; clear V flag (meaning count buffer)</span>
        <span class="string">BVC .countOrPurgeBuffer                             ; ALWAYs branch (count buffer)</span>

    <span class="string">.purgeBuffer</span>
        <span class="string">BIT .allBitsSet                                     ; set V flag (meaning purge buffer) (N flag also set)</span>
    <span class="string">.countOrPurgeBuffer</span>
        <span class="string">JMP (.vectorCNPV)                                   ; CNPV defaults to .cnpEntryPoint</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">; On Exit:</span>
    <span class="string">;   carry set, all is OK</span>
    <span class="string">;   carry clear, free space in buffer is low</span>
    <span class="string">;</span>
    <span class="string">.getRS423InputBufferFreeBytes</span>
        <span class="string">SEC                                                ; to check for free bytes</span>
        <span class="string">LDX #1                                             ; X=1 to point to RS423 input buffer</span>
        <span class="string">JSR .countBufferStartup                            ; and count it</span>
        <span class="string">CPY #1                                             ; if the high byte of the length is 1 or more</span>
        <span class="string">BCS +                                              ; then return</span>
        <span class="string">CPX .rs423HandshakeExtent                          ; else compare with minimum buffer space free</span>
    <span class="string">+</span>
        <span class="string">RTS                                                ; and exit</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
    <span class="string">; OSBYTE 128 - Read ADC Channel</span>
    <span class="string">;</span>
    <span class="string">; On Entry:              On Exit:</span>
    <span class="string">; X=0                    Y contains number of last channel converted (1-4)</span>
    <span class="string">; X=channel number       X,Y contain 16 bit value read from channel</span>
    <span class="string">; X&lt;0 Y=$FF              X returns information about various buffers</span>
    <span class="string">; X=$FF (keyboard)       X = number of characters in buffer</span>
    <span class="string">; X=$FE (RS423 input)    X = number of characters in buffer</span>
    <span class="string">; X=$FD (RS423 output)   X = number of empty spaces in buffer</span>
    <span class="string">; X=$FC (printer)        X = number of empty spaces in buffer</span>
    <span class="string">; X=$FB (sound 0)        X = number of empty spaces in buffer</span>
    <span class="string">; X=$FA (sound 1)        X = number of empty spaces in buffer</span>
    <span class="string">; X=$F9 (sound 2)        X = number of empty spaces in buffer</span>
    <span class="string">; X=$F8 (sound 3)        X = number of empty spaces in buffer</span>
    <span class="string">; X=$F7 (Speech)         X = number of empty spaces in buffer</span>
    <span class="string">;</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">.osbyte128EntryPoint</span>
        <span class="string">BMI .countNegativeBuffer                            ; if X is -ve then branch (count space free/used)</span>
        <span class="string">BEQ .lastChannelConverted                           ; if X=0 then branch</span>
        <span class="string">CPX #5                                              ; }</span>
        <span class="string">BCS .setXYAndExit                                   ; } if channel is not valid then branch (set X and Y to 255 and exit)</span>
        <span class="string">LDY .highByteLastByteFromADCChannel1 - 1,X          ; get last value read for channel of interest (high byte)</span>
        <span class="string">LDA .lowByteLastByteFromADCChannel1 - 1,X           ; get last value read for channel of interest (low byte)</span>
        <span class="string">TAX                                                 ; X=low byte</span>
        <span class="string">RTS                                                 ; and exit</span>

    <span class="string">; ***************************************************************************************</span>
    <span class="string">.lastChannelConverted</span>
        <span class="string">LDA .systemViaRegisterB                             ; read system VIA port B</span>
        <span class="string">ROR                                                 ; move high nybble to low</span>
        <span class="string">ROR                                                 ;</span>
        <span class="string">ROR                                                 ;</span>
        <span class="string">ROR                                                 ;</span>
        <span class="string">EOR #$FF                                            ; and invert it</span>
        <span class="string">AND #3                                              ; isolate the FIRE buttons</span>
        <span class="string">LDY .analogueSystemFlag                             ; get analogue system flag byte</span>
        <span class="string">STX .analogueSystemFlag                             ; store X here</span>
        <span class="string">TAX                                                 ; A=X bits 0 and 1 indicate fire buttons</span>
        <span class="string">RTS                                                 ; and return</span>


    <span class="string">; ***************************************************************************************</span>
    <span class="string">; ***************************************************************************************</span>
    <span class="string">;</span>
</pre>

<p class="inwebparagraph">Chapter 13
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 13: </span><span class="identifier">OSBYTE</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">OSWORD</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> - </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">point</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyteEntryPoint</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">Processor</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">osbyteA</span><span class="plain">                                        ; }</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">osbyteX</span><span class="plain">                                        ; } </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">page</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">osbyteY</span><span class="plain">                                        ; }</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallUnrecognisedOSBYTE</span><span class="plain">              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">necessary</span><span class="plain">, </span><span class="identifier">signal</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">unrecognised</span><span class="plain"> </span><span class="identifier">osbyte</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">attempted</span>
        <span class="identifier">CMP</span><span class="plain"> #117                                            ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">osbyte0to116</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">&lt;117 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">CMP</span><span class="plain"> #161                                            ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">osbyteTableLookup</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">&lt;161 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">NOTE</span><span class="plain">: </span><span class="identifier">A</span><span class="plain">=161 </span><span class="identifier">and</span><span class="plain"> 162 </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">special</span><span class="plain"> </span><span class="identifier">cases</span><span class="plain"> </span><span class="identifier">handled</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #166                                            ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">unknownOsbyteOrOsword</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">&lt;166 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="plain">; </span><span class="identifier">osbyte</span><span class="plain"> &gt;= 166</span>

    <span class="plain">.</span><span class="identifier">osbyte166to255orOsword224to255</span>
        <span class="identifier">LDA</span><span class="plain"> #161                                            ; </span><span class="identifier">A</span><span class="plain"> = 161    } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">look</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> 161 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">ADC</span><span class="plain"> #0                                              ; </span><span class="identifier">Add</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain">  } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">OSWORD</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain">  </span><span class="identifier">set</span><span class="plain">  </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">look</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> 162 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyteTableLookup</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">SBC</span><span class="plain"> #95                                             ; </span><span class="identifier">convert</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">range</span><span class="plain"> (22-67)</span>

    <span class="plain">.</span><span class="identifier">indexToTable</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="reserved">double</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> (44-130) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">index</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">osbyteOrOswordTableLookup</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">osbyteY</span><span class="plain">                                        ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">econetOSCallInterceptionFlag</span><span class="plain">                   ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">econet</span><span class="plain"> </span><span class="identifier">intercept</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">skipEconetCall</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">econet</span><span class="plain"> </span><span class="identifier">intercept</span><span class="plain"> </span><span class="identifier">required</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">CLV</span><span class="plain">                                                 ; </span><span class="identifier">V</span><span class="plain">=0</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">netvJumper</span><span class="plain">                                     ; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">JMP</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">ECONET</span><span class="plain"> </span><span class="identifier">vector</span>
        <span class="identifier">BVS</span><span class="plain"> .</span><span class="identifier">finishUpOsbyteOrOsword</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">returned</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">skipEconetCall</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">osbyteRoutineTable</span><span class="plain"> + 1,</span><span class="identifier">Y</span><span class="plain">                       ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreFB</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">osbyteRoutineTable</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">osbyteA</span><span class="plain">                                        ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">osbyteY</span><span class="plain">                                        ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">setCarryXAndJumpOsbyte</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">OSBYTE</span><span class="plain"> </span><span class="identifier">call</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">LDY</span><span class="plain"> #0                                              ;</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">osbyteX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> (</span><span class="identifier">XY</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">setCarryXAndJumpOsbyte</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">osbyteX</span><span class="plain">                                        ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyteJumper</span><span class="plain">                                   ; </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> (.</span><span class="identifier">tempStoreFA</span><span class="plain">/</span><span class="identifier">B</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">finishUpOsbyteOrOsword</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; </span><span class="identifier">C</span><span class="plain">=</span><span class="identifier">bit</span><span class="plain"> 0</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">bit</span><span class="plain"> 0=</span><span class="identifier">Carry</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">CLV</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">V</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte0to116</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                             ; </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="identifier">CMP</span><span class="plain"> #22                                            ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">indexToTable</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">&lt;22 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 22 </span><span class="identifier">to</span><span class="plain"> 116: </span><span class="identifier">these</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">unknown</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> </span><span class="identifier">calls</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Unknown</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">OSWORD</span><span class="plain"> </span><span class="identifier">command</span><span class="plain">. </span><span class="identifier">Pass</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">onto</span><span class="plain"> </span><span class="identifier">ROMS</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">servicing</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">unknownOsbyteOrOsword</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>

    <span class="plain">.</span><span class="identifier">pullTwiceAndOfferCallToRoms</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; </span><span class="identifier">offer</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">ROMS</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> 7/8 </span><span class="identifier">unrecognised</span><span class="plain"> </span><span class="identifier">osbyte</span><span class="plain">/</span><span class="identifier">word</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">romsDontRecogniseUnknownCommand</span><span class="plain">                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">roms</span><span class="plain"> </span><span class="identifier">don</span><span class="character">'t recognise it then branch</span>
        <span class="character">LDX .osbyteX                                        ; restore X</span>
        <span class="character">JMP .finishUpOsbyteOrOsword                         ; finish up</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.romsDontRecogniseUnknownCommand</span>
        <span class="character">PLP                                                 ; else pull flags</span>
        <span class="character">PLA                                                 ; and A</span>
        <span class="character">BIT .allBitsSet                                     ; set N and V flags</span>
        <span class="character">RTS                                                 ; and return</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Checks if the cassette filing system is in a critical state</span>
    <span class="character">; Check the catalogue status</span>
    <span class="character">; Checks the bits that allow printing short or long messages</span>
    <span class="character">;</span>
    <span class="character">; On Exit:</span>
    <span class="character">;       A = 0 (and therefore Z set) means no messages are desired</span>
    <span class="character">;       A != 0 (and therefore Z clear) means messages can be printed</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.checkIfSafeToPrintMessage</span>
        <span class="character">LDA .tapeCritical                                   ; read cassette critical flag bit 7 = busy</span>
        <span class="character">BMI .zeroAAndExit                                   ; if busy then branch</span>
        <span class="character">LDA #%00001000                                      ; check current catalogue status bit</span>
        <span class="character">AND .tapeROMFSStatusByte                            ; AND with FS status byte</span>
        <span class="character">BNE +                                               ; if not set (not in use) then branch (exit)</span>
        <span class="character">LDA #%10001000                                      ; A=%10001000 (these are the bits set if a message is required)</span>
        <span class="character">AND .tapeCurrentOptionsByte                         ; AND with FS options (short/long message bits)</span>
    <span class="character">+</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSWORD - Default entry point</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.oswordEntryPoint</span>
        <span class="character">PHA                                                 ; Push A</span>
        <span class="character">PHP                                                 ; Push flags</span>
        <span class="character">SEI                                                 ; disable interrupts</span>
        <span class="character">STA .oswordA                                        ; store A,X,Y</span>
        <span class="character">STX .oswordX                                        ;</span>
        <span class="character">STY .oswordY                                        ;</span>
        <span class="character">LDX #.romServiceCallUnrecognisedOSWORD              ; if necessary, signal to ROMs that an unrecognised OSWORD is being attempted</span>
        <span class="character">CMP #224                                            ;</span>
        <span class="character">BCS .osbyte166to255orOsword224to255                 ; if A&gt;=224 then branch</span>
        <span class="character">CMP #14                                             ;</span>
        <span class="character">BCS .unknownOsbyteOrOsword                          ; if A&gt;=14 then branch (with carry set)</span>

        <span class="character">; OSWORD 0-13</span>
        <span class="character">ADC #68                                             ; add 68 to form pointer to table (68 to 81)</span>
        <span class="character">ASL                                                 ; double it to form low byte of pointer ($88 to $A2)</span>
        <span class="character">BCC .osbyteOrOswordTableLookup                      ; ALWAYs branch</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSWORD 5 - Read a byte from I/O memory (This allows reads across the Tube)</span>
    <span class="character">;</span>
    <span class="character">; block of 5 bytes:</span>
    <span class="character">;     XY +0  32 bit address of byte</span>
    <span class="character">;        +4  on exit byte read</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osword5EntryPoint</span>
        <span class="character">JSR .setUpDataBlock                                 ; set up address of data block</span>
        <span class="character">LDA ($F9,X)                                         ; get byte</span>
        <span class="character">STA (.oswordX),Y                                    ; store it</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSWORD 6 - Write a byte to I/O memory (This allows writes across the Tube)</span>
    <span class="character">;</span>
    <span class="character">; block of 5 bytes:</span>
    <span class="character">;     XY +0  32 bit address of byte</span>
    <span class="character">;        +4  byte to be written</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osword6EntryPoint</span>
        <span class="character">JSR .setUpDataBlock                                 ; set up address</span>
        <span class="character">LDA (.oswordX),Y                                    ; get byte to write</span>
        <span class="character">STA ($F9,X)                                         ; write byte</span>
    <span class="character">.zeroAAndExit</span>
        <span class="character">LDA #0                                              ; a=0</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.setUpDataBlock</span>
        <span class="character">STA .tempStoreFA                                    ; .tempStoreFA=A=low byte of address</span>
        <span class="character">INY                                                 ; Y=1</span>
        <span class="character">LDA (.oswordX),Y                                    ; get byte from block</span>
        <span class="character">STA .tempStoreFB                                    ; .tempStoreFB=high byte of address</span>
        <span class="character">LDY #4                                              ; Y=4</span>
    <span class="character">.exitWithX1</span>
        <span class="character">LDX #1                                              ; X=1</span>
        <span class="character">RTS                                                 ; and exit</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSBYTE 0 - version number</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osbyte0EntryPoint</span>
        <span class="character">BNE .exitWithX1                                     ; if A is not zero then exit else print message (as an error)</span>
        <span class="character">BRK                                                 ;</span>
        <span class="character">!byte $F7                                           ; error number</span>
        <span class="character">!text "OS 1.20",0                                   ; error string with zero terminator</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSWORD 7 - make a sound</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       block of 8 bytes set at address pointed to by 00F0/00F1</span>
    <span class="character">;       XY +0  Channel</span>
    <span class="character">;           2  Amplitude</span>
    <span class="character">;           4  Pitch</span>
    <span class="character">;           6  Duration</span>
    <span class="character">; OR</span>
    <span class="character">;       XY +0  Flush Channel</span>
    <span class="character">;          +1  Hold,Sync</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osword7EntryPoint</span>
        <span class="character">INY                                                 ; increment Y to read byte 1 of block</span>
        <span class="character">LDA (.oswordX),Y                                    ; read channel (high byte)</span>
        <span class="character">CMP #$FF                                            ; check if its $FF</span>
        <span class="character">BEQ .osword7Speech                                  ; if (high byte of channel is $FF) then branch (handle speech command)</span>
        <span class="character">CMP #$20                                            ; if channel high byte is $20 or more then set carry</span>
        <span class="character">LDX #.romServiceCallUnrecognisedOSWORD              ; X = 8 for paged ROM service request '</span><span class="identifier">unrecognised</span><span class="plain"> </span><span class="identifier">OSWORD</span><span class="plain"> </span><span class="identifier">call</span><span class="character">'</span>
        <span class="character">BCS .pullTwiceAndOfferCallToRoms                    ; if (channel &gt;= $2000) then branch (offer it to ROMS as unknown OSWORD)</span>
        <span class="character">DEY                                                 ; point at start of block</span>
        <span class="character">JSR .getChannelNumberAndFlush                       ; returns with carry set if flush is required, and A=channel number (0-3)</span>
        <span class="character">ORA #4                                              ; convert channel number to buffer number (4-7)</span>
        <span class="character">TAX                                                 ; X = buffer number</span>
        <span class="character">BCC +                                               ; and if carry clear () then branch</span>
        <span class="character">JSR .flushSoundBufferX                              ; flush buffer</span>
        <span class="character">LDY #1                                              ; Y=1</span>
    <span class="character">+</span>
        <span class="character">JSR .getSyncNumberAndHold                           ; get sync number (0-3) (carry set if hold is required)</span>
        <span class="character">STA .tempStoreFA                                    ; .tempStoreFA = sync number</span>
        <span class="character">PHP                                                 ; save flags</span>
        <span class="character">LDY #6                                              ; }</span>
        <span class="character">LDA (.oswordX),Y                                    ; } get duration (low byte)</span>
        <span class="character">PHA                                                 ; push it</span>
        <span class="character">LDY #4                                              ; }</span>
        <span class="character">LDA (.oswordX),Y                                    ; } get pitch (low byte)</span>
        <span class="character">PHA                                                 ; push it</span>
        <span class="character">LDY #2                                              ; }</span>
        <span class="character">LDA (.oswordX),Y                                    ; } get amplitude (low byte) in the range -15 to 0 (static volume) or 1 to 4 (envelope controlled)</span>

        <span class="character">; At this point carry contains the '</span><span class="identifier">hold</span><span class="character">' bit</span>
        <span class="character">; and .tempStoreFA contains the two '</span><span class="identifier">sync</span><span class="character">' bits</span>

        <span class="character">ROL                                                 ; multiply amplitude by two, and add carry into bit zero = hold bit</span>
        <span class="character">SEC                                                 ;</span>
        <span class="character">SBC #2                                              ; subtract 2</span>
        <span class="character">ASL                                                 ; }</span>
        <span class="character">ASL                                                 ; } multiply by 4</span>
        <span class="character">ORA .tempStoreFA                                    ; add sync value (0-3)</span>

        <span class="character">;</span>
        <span class="character">; To illustrate the changes made by the last six instructions, here is a table showing</span>
        <span class="character">; the changes at each step. Each row is a different value for the amplitude (values &gt; 0</span>
        <span class="character">; are the envelope number 1-4), and the columns show the result after each subsequent</span>
        <span class="character">; instruction.</span>
        <span class="character">;</span>
        <span class="character">; Amplitude   Binary       ROL           SEC;SBC#2    ASL; ASL     ORA .tempStoreFA</span>
        <span class="character">;                          h=hold bit                              ss=sync bits</span>
        <span class="character">; ---------------------------------------------------------------------------------</span>
        <span class="character">;     4       %00000100    %0000100h     %0000011h    %00011h00    %00011hss</span>
        <span class="character">;     3       %00000011    %0000011h     %0000010h    %00010h00    %00010hss</span>
        <span class="character">;     2       %00000010    %0000010h     %0000001h    %00001h00    %00001hss</span>
        <span class="character">;     1       %00000001    %0000001h     %0000000h    %00000h00    %00000hss</span>
        <span class="character">;     0       %00000000    %0000000h     %1111111h    %11111h00    %11111hss</span>
        <span class="character">;    -1       %11111111    %1111111h     %1111110h    %11110h00    %11110hss</span>
        <span class="character">;    -2       %11111110    %1111110h     %1111101h    %11101h00    %11101hss</span>
        <span class="character">;    -3       %11111101    %1111101h     %1111100h    %11100h00    %11100hss</span>
        <span class="character">;    -4       %11111100    %1111100h     %1111011h    %11011h00    %11011hss</span>
        <span class="character">;    -5       %11111011    %1111011h     %1111010h    %11010h00    %11010hss</span>
        <span class="character">;    -6       %11111010    %1111010h     %1111001h    %11001h00    %11001hss</span>
        <span class="character">;    -7       %11111001    %1111001h     %1111000h    %11000h00    %11000hss</span>
        <span class="character">;    -8       %11111000    %1111000h     %1110111h    %10111h00    %10111hss</span>
        <span class="character">;    -9       %11110111    %1110111h     %1110110h    %10110h00    %10110hss</span>
        <span class="character">;   -10       %11110110    %1110110h     %1110101h    %10101h00    %10101hss</span>
        <span class="character">;   -11       %11110101    %1110101h     %1110100h    %10100h00    %10100hss</span>
        <span class="character">;   -12       %11110100    %1110100h     %1110011h    %10011h00    %10011hss</span>
        <span class="character">;   -13       %11110011    %1110011h     %1110010h    %10010h00    %10010hss</span>
        <span class="character">;   -14       %11110010    %1110010h     %1110001h    %10001h00    %10001hss</span>
        <span class="character">;   -15       %11110001    %1110001h     %1110000h    %10000h00    %10000hss</span>
        <span class="character">;</span>
        <span class="character">; At this point:</span>
        <span class="character">;</span>
        <span class="character">; bit 7     = 0 for an envelope number</span>
        <span class="character">; bits 3-6  = envelope number - 1 (0-3), or volume in range (15 to 0)</span>
        <span class="character">; bit 2     = h, the hold bit</span>
        <span class="character">; bits 0-1  = ss, the sync bits (0-3)</span>
        <span class="character">;</span>

        <span class="character">JSR .addByteToBuffer                                ; transfer to buffer</span>
        <span class="character">BCC .markAsUsedAndSendToBuffer                      ; if C set on exit (succesful transfer) then branch (send to buffer)</span>
    <span class="character">.finishUpSound</span>
        <span class="character">PLA                                                 ; }</span>
        <span class="character">PLA                                                 ; } failed to add to buffer, so pull the values off and fall through to exit via OSBYTE 117</span>
        <span class="character">PLP                                                 ; }</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSBYTE 117 - read VDU status</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osbyte117EntryPoint</span>
        <span class="character">LDX .vduStatusByte                                  ; get VDU status byte in X</span>
        <span class="character">RTS                                                 ; and return</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.vdu7EntryPoint</span>
        <span class="character">PHP                                                 ; push P</span>
        <span class="character">SEI                                                 ; disable interrupts</span>
        <span class="character">LDA .soundBELLChannel                               ; get bell channel number in A</span>
        <span class="character">AND #%00000111                                      ; clear all except bits 0-2</span>
        <span class="character">ORA #%00000100                                      ; set bit 2</span>
        <span class="character">TAX                                                 ; X=A = bell channel number +4=buffer number</span>
        <span class="character">LDA .soundBELLAmplitudeEnvelope                     ; get bell amplitude/envelope number</span>
        <span class="character">JSR .insJumper                                      ; store it in buffer pointed to by X</span>
        <span class="character">LDA .soundBELLDuration                              ; get bell duration</span>
        <span class="character">PHA                                                 ; save it</span>
        <span class="character">LDA .soundBELLFrequency                             ; get bell frequency</span>
        <span class="character">PHA                                                 ; save it</span>
    <span class="character">.markAsUsedAndSendToBuffer</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">ROR .channel0Occupancy - 4,X                        ; and pass into bit 7 to indicate that channel is active</span>
        <span class="character">BMI .continueBell                                   ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osword7Speech</span>
        <span class="character">PHP                                                 ; push flags</span>
        <span class="character">INY                                                 ; Y=2</span>
        <span class="character">LDA (.oswordX),Y                                    ; get byte at offset 2</span>
        <span class="character">PHA                                                 ; store it</span>
        <span class="character">INY                                                 ; Y=4</span>
        <span class="character">LDA (.oswordX),Y                                    ; get byte at offset 4</span>
        <span class="character">PHA                                                 ; store it</span>
        <span class="character">LDY #0                                              ; Y=0</span>
        <span class="character">LDA (.oswordX),Y                                    ; get byte</span>
        <span class="character">LDX #.bufferNumberSpeech                            ; X=8</span>
        <span class="character">JSR .addByteToBuffer                                ; select speech buffer and pass A</span>
        <span class="character">BCS .finishUpSound                                  ; if carry set (failed to add to buffer) then branch (restore stack and exit)</span>
        <span class="character">ROR .speechBufferEmptyFlag                          ; clear bit 7 of buffer empty flag to show buffer is not empty</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.continueBell</span>
        <span class="character">PLA                                                 ; pull byte from offset 4</span>
        <span class="character">JSR .insJumper                                      ; enter it in buffer X</span>
        <span class="character">PLA                                                 ; pull byte from offset 2</span>
        <span class="character">JSR .insJumper                                      ; enter it in buffer X</span>
        <span class="character">PLP                                                 ; pull flags</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSWORD 8 - define an envelope</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       A = envelope number</span>
    <span class="character">;       Y = 0</span>
    <span class="character">; a block of 14 bytes set at address pointed to by (.oswordX/.oswordY):</span>
    <span class="character">;</span>
    <span class="character">;       XY +0  envelope number (also in A)</span>
    <span class="character">;           1  bits 0-6 length of each step in centi-seconds</span>
    <span class="character">;              bit 7 clear means auto repeat</span>
    <span class="character">;           2  change of Pitch per step in section 1 (-128 to +127)</span>
    <span class="character">;           3  change of Pitch per step in section 2 (-128 to +127)</span>
    <span class="character">;           4  change of Pitch per step in section 3 (-128 to +127)</span>
    <span class="character">;           5  number of steps in section 1 (0 to 255)</span>
    <span class="character">;           6  number of steps in section 2 (0 to 255)</span>
    <span class="character">;           7  number of steps in section 3 (0 to 255)</span>
    <span class="character">;           8  change of amplitude per step during attack  phase (-127 to +127)</span>
    <span class="character">;           9  change of amplitude per step during decay   phase (-127 to +127)</span>
    <span class="character">;          10  change of amplitude per step during sustain phase (-127 to +127)</span>
    <span class="character">;          11  change of amplitude per step during release phase (-127 to +127)</span>
    <span class="character">;          12  target level at end of attack phase (0 to 126)</span>
    <span class="character">;          13  target level at end of decay  phase (0 to 126)</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osword8EntryPoint</span>
        <span class="character">SBC #1                                              ; }</span>
        <span class="character">ASL                                                 ; }</span>
        <span class="character">ASL                                                 ; } set up appropriate displacement to storage area</span>
        <span class="character">ASL                                                 ; } A=(A-1)*16 OR 15</span>
        <span class="character">ASL                                                 ; }</span>
        <span class="character">ORA #%00001111                                      ; }</span>
        <span class="character">TAX                                                 ; X=A (destination offset)</span>
        <span class="character">LDA #0                                              ; A=0 (value to write)</span>
        <span class="character">LDY #16                                             ; Y = loop counter</span>
    <span class="character">.copyEnvelopeLoop</span>
        <span class="character">CPY #14                                             ;</span>
        <span class="character">BCS +                                               ; if Y &gt;=14 then branch (don'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">block</span><span class="plain">, </span><span class="identifier">just</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">oswordX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">block</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">envelopeBuffer</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">appropriate</span><span class="plain"> </span><span class="identifier">area</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Decrement</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">copyEnvelopeLoop</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>
        <span class="plain">; </span><span class="identifier">Note</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">NOT</span><span class="plain"> </span><span class="identifier">transferred</span><span class="plain">. </span><span class="identifier">The</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain"> </span><span class="identifier">in</span>
        <span class="plain">; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">since</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">determines</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">.</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> = 0:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (0-3)</span>
    <span class="plain">;       </span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> &gt; 15, </span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">flush</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">required</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">When</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> = 1:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">Sync</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (0-3)</span>
    <span class="plain">;       </span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> &gt; 15, </span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">hold</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">required</span>
    <span class="plain">;</span>
    <span class="plain">.</span><span class="identifier">getChannelNumberAndFlush</span>
    <span class="plain">.</span><span class="identifier">getSyncNumberAndHold</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">oswordX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (</span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #$10                                            ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">greater</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> 15, </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">AND</span><span class="plain"> #3                                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> 1 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">parameters</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSWORD</span><span class="plain"> 3 - </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">interval</span><span class="plain"> </span><span class="identifier">timer</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osword3EntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">countdownIntervalTimer</span><span class="plain"> - (.</span><span class="identifier">timeClockA</span><span class="plain"> - 5)    ; </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> (</span><span class="identifier">clockA</span><span class="plain">-5) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">countdown</span><span class="plain"> </span><span class="identifier">timer</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">readFiveBytesIntoBlock</span><span class="plain">                         ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSWORD</span><span class="plain"> 1 - </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">clock</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osword1EntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">timeClockSwitch</span><span class="plain">                                ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">pointer</span>
    <span class="plain">.</span><span class="identifier">readFiveBytesIntoBlock</span>
        <span class="identifier">LDY</span><span class="plain"> #4                                              ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">timeClockA</span><span class="plain"> - 5,</span><span class="identifier">X</span><span class="plain">                               ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">oswordX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">x</span><span class="plain">+1</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">&gt;0 </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span>
    <span class="plain">.</span><span class="identifier">exit22</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSWORD</span><span class="plain"> 4 - </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">interval</span><span class="plain"> </span><span class="identifier">timer</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osword4EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> #.</span><span class="identifier">countdownIntervalTimer</span><span class="plain"> - (.</span><span class="identifier">timeClockA</span><span class="plain"> - 5)    ; </span><span class="identifier">A</span><span class="plain">=15 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">clockA</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">countdown</span><span class="plain"> </span><span class="identifier">timer</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">writeFiveBytesFromBlock</span><span class="plain">                        ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSWORD</span><span class="plain"> 2 - </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">clock</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osword2EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">timeClockSwitch</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">pointer</span>
        <span class="identifier">EOR</span><span class="plain"> #15                                             ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">invert</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">inactive</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain"> (</span><span class="identifier">toggle</span><span class="plain"> </span><span class="identifier">between</span><span class="plain"> 5 </span><span class="identifier">and</span><span class="plain"> 10)</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> (</span><span class="identifier">indicates</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">indicates</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">clock</span>
    <span class="plain">;   </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">indicates</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">interval</span><span class="plain"> </span><span class="identifier">timer</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">writeFiveBytesFromBlock</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">LDY</span><span class="plain"> #4                                              ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">.</span><span class="identifier">writeClockLoop</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">oswordX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">transfer</span><span class="plain"> 5 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">timeClockA</span><span class="plain"> - 5,</span><span class="identifier">X</span><span class="plain">                               ; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">timer</span>
        <span class="identifier">INX</span><span class="plain">                                                 ;</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ;</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">writeClockLoop</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain"> &gt;= 0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain">)</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">exit22</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">interval</span><span class="plain"> </span><span class="identifier">timer</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">timeClockSwitch</span><span class="plain">                                ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">clock</span><span class="plain"> (5 </span><span class="identifier">or</span><span class="plain"> 10) </span><span class="identifier">into</span><span class="plain"> </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">variable</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSWORD</span><span class="plain"> 0 - </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">memory</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       .</span><span class="identifier">oswordX</span><span class="plain">/.</span><span class="identifier">oswordY</span><span class="plain"> - </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">block</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">XY</span><span class="plain"> + 0 = </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain">)</span>
    <span class="plain">;       </span><span class="identifier">XY</span><span class="plain"> + 1 = </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain">)</span>
    <span class="plain">;       </span><span class="identifier">XY</span><span class="plain"> + 2 = </span><span class="identifier">maximum</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">length</span>
    <span class="plain">;       </span><span class="identifier">XY</span><span class="plain"> + 3 = </span><span class="identifier">minimum</span><span class="plain"> </span><span class="identifier">acceptable</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">code</span>
    <span class="plain">;       </span><span class="identifier">XY</span><span class="plain"> + 4 = </span><span class="identifier">maximum</span><span class="plain"> </span><span class="identifier">acceptable</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">code</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">F0</span><span class="plain">/1 </span><span class="identifier">points</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">block</span>
    <span class="plain">;       +0/1    </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">input</span>
    <span class="plain">;       +2      </span><span class="identifier">Maximum</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">length</span>
    <span class="plain">;       +3      </span><span class="identifier">minimum</span><span class="plain"> </span><span class="identifier">acceptable</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">value</span>
    <span class="plain">;       +4      </span><span class="identifier">maximum</span><span class="plain"> </span><span class="identifier">acceptable</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">value</span>
    <span class="plain">.</span><span class="identifier">osword0EntryPoint</span>
        <span class="identifier">LDY</span><span class="plain"> #4                                              ; </span><span class="identifier">Y</span><span class="plain">=4</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">oswordX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> 2,3,4 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">absolute</span><span class="plain"> </span><span class="identifier">addresses</span><span class="plain"> .</span><span class="identifier">osword0MaxLineLength</span><span class="plain">,+1,+2</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">osword0MaxLineLength</span><span class="plain">-2,</span><span class="identifier">Y</span><span class="plain">                       ;</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">CPY</span><span class="plain"> #2                                              ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">=1</span>
        <span class="identifier">BCS</span><span class="plain"> -                                               ;</span>

        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">oswordX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">osword0BufferAddressHigh</span><span class="plain">                       ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">pagedModeCounter</span><span class="plain">                               ; </span><span class="identifier">Y</span><span class="plain">=0 </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">mode</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">oswordX</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                                    ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">osword0BufferAddressLow</span><span class="plain">                        ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">readInputCharacter</span><span class="plain">                             ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readLineInputBufferFull</span>
        <span class="identifier">LDA</span><span class="plain"> #.</span><span class="identifier">charBELL</span><span class="plain">                                      ; </span><span class="identifier">A</span><span class="plain">=7</span>
    <span class="plain">.</span><span class="identifier">retryReadWithoutIncrementingPosition</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">Y</span>
    <span class="plain">.</span><span class="identifier">retryReadIncrementingPosition</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">Y</span>
    <span class="plain">.</span><span class="identifier">outputCharacterAndReadAgain</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSWRCH</span><span class="plain">                                         ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">OSWRCH</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readInputCharacter</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSRDCH</span><span class="plain">                                         ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">stream</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">exitWithNCSet</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">occurred</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">characterDestinationStatus</span><span class="plain">                     ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">destination</span><span class="plain"> </span><span class="identifier">status</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">twice</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">make</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">reflect</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="character">'disable VDU driver'</span><span class="plain"> </span><span class="identifier">bit</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">read</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">vdu</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">forward</span><span class="plain">)</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">twosComplimentOfNumberOfBytesInVDUQueue</span><span class="plain">        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">items</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">queue</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">outputCharacterAndReadAgain</span><span class="plain">                    ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">again</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charDELETE</span><span class="plain">                                    ;</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">delete</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">forward</span>
        <span class="identifier">CPY</span><span class="plain"> #0                                              ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">readInputCharacter</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> (</span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">)</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> (</span><span class="identifier">position</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">decrements</span><span class="plain">)</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">outputCharacterAndReadAgain</span><span class="plain">                    ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">otput</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">DELETE</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">again</span>
    <span class="plain">+</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charDisableVDUOrDeleteLine</span><span class="plain">                    ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">delete</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> (</span><span class="identifier">CTRL</span><span class="plain">-</span><span class="identifier">U</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">forward</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">readInputCharacter</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">still</span><span class="plain"> </span><span class="identifier">reading</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">LDA</span><span class="plain"> #.</span><span class="identifier">charDELETE</span><span class="plain">                                    ;</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSWRCH</span><span class="plain">                                         ; }</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; } </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">DELETE</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; }</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">readInputCharacter</span><span class="plain">                             ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">again</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">osword0BufferAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">designated</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charRETURN</span><span class="plain">                                    ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">outputNewlineAndExit</span><span class="plain">                           ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carriage</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">CPY</span><span class="plain"> .</span><span class="identifier">osword0MaxLineLength</span><span class="plain">                           ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">length</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">readLineInputBufferFull</span><span class="plain">                        ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">full</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ring</span><span class="plain"> </span><span class="identifier">bell</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">osword0MinASCIICharacter</span><span class="plain">                       ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">minimum</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">retryReadWithoutIncrementingPosition</span><span class="plain">           ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="identifier">minimum</span><span class="plain"> </span><span class="identifier">backspace</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">osword0MaxASCIICharacter</span><span class="plain">                       ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">maximum</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">retryReadIncrementingPosition</span><span class="plain">                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">equal</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">accept</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">on</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">retryReadIncrementingPosition</span><span class="plain">                  ; </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">accept</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">on</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">retryReadWithoutIncrementingPosition</span><span class="plain">           ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">reject</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">continue</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">outputNewlineAndExit</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSNEWL</span><span class="plain">                                         ; </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain">/</span><span class="identifier">LF</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">netvJumper</span><span class="plain">                                     ; </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">Econet</span><span class="plain"> </span><span class="identifier">vector</span>
    <span class="plain">.</span><span class="identifier">exitWithNCSet</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">escapeFlag</span><span class="plain">                                     ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">FLAG</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">routine</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 5 - </span><span class="identifier">Select</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">type</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte5EntryPoint</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">briefly</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">escapeFlag</span><span class="plain">                                     ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">pending</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">exit23</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">pending</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">return</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">printerBufferEmptyFlag</span><span class="plain">                         ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">perinter</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">empty</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">osbyte5EntryPoint</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7=0 (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">try</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> (</span><span class="identifier">wait</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">selectPrinterType</span><span class="plain">                              ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">defined</span><span class="plain"> </span><span class="identifier">routine</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">osbyteY</span><span class="plain">                                        ; </span><span class="identifier">F1</span><span class="plain">=0</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 1 - </span><span class="identifier">Read</span><span class="plain">/</span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">flag</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 6 - </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">character</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte1EntryPoint</span>
    <span class="plain">.</span><span class="identifier">osbyte6EntryPoint</span>
        <span class="identifier">ORA</span><span class="plain"> #$0280 - .</span><span class="identifier">systemVariableBase</span><span class="plain">                   ; </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">read</span><span class="plain">/</span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">locations</span><span class="plain">:</span>
                                                        <span class="plain">; </span><span class="identifier">At</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain">, </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">depends</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">point</span><span class="plain">:</span>
                                                        <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 1: </span><span class="identifier">A</span><span class="plain">=$0281 (</span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">)</span>
                                                        <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 5: </span><span class="identifier">A</span><span class="plain">=$0285 (</span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">destination</span><span class="plain">)</span>
                                                        <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 6: </span><span class="identifier">A</span><span class="plain">=$0286 (</span><span class="identifier">printer</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">readWriteSystemVariable</span><span class="plain">                       ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 12 - </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">autorepeat</span><span class="plain"> </span><span class="identifier">rate</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte12EntryPoint</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">osbyte11EntryPoint</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> (.</span><span class="identifier">osbyteX</span><span class="plain"> != 0; </span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">resetting</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">defaults</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDX</span><span class="plain"> #50                                             ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">delay</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">rate</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">keyboardAutorepeatDelay</span><span class="plain">                        ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">autorepeat</span><span class="plain"> </span><span class="identifier">delay</span>
        <span class="identifier">LDX</span><span class="plain"> #8                                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=8 </span><span class="reserved">for</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">autorepeat</span><span class="plain"> </span><span class="identifier">rate</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 11 - </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">autorepeat</span><span class="plain"> </span><span class="identifier">delay</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte11EntryPoint</span>
        <span class="identifier">ADC</span><span class="plain"> #$</span><span class="identifier">CF</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">+208 (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">So</span><span class="plain">...</span>
                                                            <span class="plain">; </span><span class="identifier">A</span><span class="plain">=219 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 11</span>
                                                            <span class="plain">; </span><span class="identifier">A</span><span class="plain">=220 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 12</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 3 - </span><span class="identifier">Select</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">stream</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 4 - </span><span class="identifier">Enable</span><span class="plain"> / </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">cursor</span><span class="plain"> </span><span class="identifier">editing</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte3EntryPoint</span>
    <span class="plain">.</span><span class="identifier">osbyte4EntryPoint</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">ADC</span><span class="plain"> #$</span><span class="identifier">E9</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">A</span><span class="plain"> + 233</span>
                                                            <span class="plain">; </span><span class="identifier">So</span><span class="plain">...</span>
                                                            <span class="plain">; </span><span class="identifier">A</span><span class="plain">=236 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 3</span>
                                                            <span class="plain">; </span><span class="identifier">A</span><span class="plain">=237 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 4</span>
                                                            <span class="plain">; </span><span class="identifier">A</span><span class="plain">=196 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 11</span>
                                                            <span class="plain">; </span><span class="identifier">A</span><span class="plain">=197 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 12</span>
    <span class="plain">.</span><span class="identifier">readWriteSystemVariable</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">osbyteX</span><span class="plain">                                        ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 166 </span><span class="identifier">to</span><span class="plain"> 255 - </span><span class="identifier">read</span><span class="plain">/</span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">variable</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">newValue</span><span class="plain"> = (</span><span class="identifier">oldValue</span><span class="plain"> </span><span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">osbyteY</span><span class="plain">) </span><span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">osbyteX</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">systemVariableBase</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">variable</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">read</span><span class="plain">/</span><span class="identifier">write</span>
    <span class="plain">;       .</span><span class="identifier">osbyteX</span><span class="plain"> = </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">OSBYTE</span>
    <span class="plain">;       .</span><span class="identifier">osbyteY</span><span class="plain"> = </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">OSBYTE</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">oldValue</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">variable</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte166to255EntryPoint</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">systemVariableBase</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                           ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">preserve</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">osbyteY</span><span class="plain">                                        ; }</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">osbyteX</span><span class="plain">                                        ; } </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> = (</span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">AND</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">) </span><span class="identifier">EOR</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemVariableBase</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">systemVariableBase</span><span class="plain">+1,</span><span class="identifier">Y</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
    <span class="plain">.</span><span class="identifier">exit23</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">dual</span><span class="plain"> </span><span class="identifier">use</span><span class="plain">. </span><span class="identifier">It</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">baud</span><span class="plain"> </span><span class="identifier">rate</span><span class="plain"> (</span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0-5), </span><span class="identifier">and</span>
    <span class="plain">; </span><span class="identifier">also</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">identify</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> 7):</span>
    <span class="plain">;</span>
    <span class="plain">;   - </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">buffer</span>
    <span class="plain">;   - </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> (</span><span class="identifier">always</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
    <span class="plain">;   - </span><span class="identifier">bits</span><span class="plain"> 3,4,5 </span><span class="identifier">indicate</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">receive</span><span class="plain"> </span><span class="identifier">baud</span><span class="plain"> </span><span class="identifier">rate</span>
    <span class="plain">;   - </span><span class="identifier">bits</span><span class="plain"> 0,1,2 </span><span class="identifier">indicate</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">transmit</span><span class="plain"> </span><span class="identifier">baud</span><span class="plain"> </span><span class="identifier">rate</span>
    <span class="plain">;</span>
    <span class="plain">;       111 =    75 </span><span class="identifier">baud</span>
    <span class="plain">;       011 =   150 </span><span class="identifier">baud</span>
    <span class="plain">;       101 =   300 </span><span class="identifier">baud</span>
    <span class="plain">;       001 =  1200 </span><span class="identifier">baud</span>
    <span class="plain">;       110 =  2400 </span><span class="identifier">baud</span>
    <span class="plain">;       010 =  4800 </span><span class="identifier">baud</span>
    <span class="plain">;       100 =  9600 </span><span class="identifier">baud</span>
    <span class="plain">;       000 = 19200 </span><span class="identifier">baud</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">bufferTypeAndSerialBaudRatesTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %01100100                                     ; </span><span class="identifier">Keyboard</span><span class="plain">           9600 </span><span class="identifier">baud</span><span class="plain"> (</span><span class="reserved">default</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %01111111                                     ; </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">Input</span><span class="plain">          75 </span><span class="identifier">baud</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %01011011                                     ; </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">output</span><span class="plain">        150 </span><span class="identifier">baud</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %01101101                                     ; </span><span class="identifier">printer</span><span class="plain">             300 </span><span class="identifier">baud</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11001001                                     ; </span><span class="identifier">sound0</span><span class="plain">             1200 </span><span class="identifier">baud</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11110110                                     ; </span><span class="identifier">sound1</span><span class="plain">             2400 </span><span class="identifier">baud</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11010010                                     ; </span><span class="identifier">sound2</span><span class="plain">             4800 </span><span class="identifier">baud</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11100100                                     ; </span><span class="identifier">sound3</span><span class="plain">             9600 </span><span class="identifier">baud</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %01000000                                     ; </span><span class="identifier">speech</span><span class="plain">            19200 </span><span class="identifier">baud</span>


    <span class="plain">; ****************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 19 - </span><span class="identifier">Wait</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">animation</span>
    <span class="plain">;</span>
    <span class="plain">; ****************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte19EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">verticalSyncCounter</span><span class="plain">                            ; </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">briefly</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">verticalSyncCounter</span><span class="plain">                            ; </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">changed</span><span class="plain"> </span><span class="identifier">yet</span><span class="plain">?</span>
        <span class="identifier">BEQ</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain">, </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ****************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 160 - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">Variable</span>
    <span class="plain">;</span>
    <span class="plain">; ****************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte160EntryPoint</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain"> + 1,</span><span class="identifier">X</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">variable</span><span class="plain"> (</span><span class="identifier">often</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                            ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">variable</span><span class="plain"> (</span><span class="identifier">often</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ****************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 18 - </span><span class="identifier">Reset</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">keys</span>
    <span class="plain">;</span>
    <span class="plain">; ****************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte18EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> #$10                                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">consistency</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">softKeyConsistencyFlag</span><span class="plain">                         ;</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; </span><span class="identifier">X</span><span class="plain">=0</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">softKeyPage</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                  ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">wipe</span><span class="plain"> </span><span class="identifier">clean</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=0 </span><span class="identifier">again</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">softKeyConsistencyFlag</span><span class="plain">                         ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">consistency</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 118 - </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">LEDs</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">reflect</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">;       </span><span class="identifier">N</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte118EntryPoint</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">remember</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">LDA</span><span class="plain"> #$40                                            ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">lights</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">turnOnKeyboardLightsAndTestEscape</span><span class="plain">              ; </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">subroutine</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">popRollAndExit</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">condition</span><span class="plain"> </span><span class="identifier">exists</span><span class="plain"> (</span><span class="identifier">M</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">C</span>
        <span class="identifier">CLV</span><span class="plain">                                                 ; </span><span class="identifier">calling</span><span class="plain"> </span><span class="identifier">main</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">to</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">keyJumper</span><span class="plain">                                      ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">lights</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">required</span>
    <span class="plain">.</span><span class="identifier">popRollAndExit</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 0</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">turnOnKeyboardLightsAndTestEscape</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">skipKeyboardLights</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span>
        <span class="identifier">LDY</span><span class="plain"> #7                                              ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">light</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ;</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=6</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">Caps</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">light</span>

    <span class="plain">.</span><span class="identifier">skipKeyboardLights</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">escapeFlag</span><span class="plain">                                     ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">escape</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">indicating</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">condition</span><span class="plain"> </span><span class="identifier">exists</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">writeAToSystemVIARegisterB</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interupts</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; </span><span class="identifier">write</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">B</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">Accumulator</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 154 - </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">Video</span><span class="plain"> </span><span class="identifier">ULA</span><span class="character">'s Video Control Register</span>
    <span class="character">;</span>
    <span class="character">; bit</span>
    <span class="character">;   0 - Flash colour select (which of the flashing colours is displayed)</span>
    <span class="character">;   1 - Teletext select</span>
    <span class="character">;   2 - } These two bits determine the number of characters per row</span>
    <span class="character">;   3 - } from this table:</span>
    <span class="character">;        00 = 10 characters per row</span>
    <span class="character">;        01 = 20 characters per row</span>
    <span class="character">;        10 = 40 characters per row</span>
    <span class="character">;        11 = 80 characters per row</span>
    <span class="character">;   4 - CRTC clock rate select:</span>
    <span class="character">;         0 = low frequency clock for MODEs 4-7</span>
    <span class="character">;         1 = high frequency clock for MODEs 0-3</span>
    <span class="character">;   5 - } These two bits determine the width of cursor in bytes</span>
    <span class="character">;   6 - } from this table:</span>
    <span class="character">;        00 = 1 (MODEs 0,3,4,6)</span>
    <span class="character">;        01 = - undefined</span>
    <span class="character">;        10 = 2 (MODEs 1,5,7)</span>
    <span class="character">;        11 = 4 (MODE 2)</span>
    <span class="character">;   7 - Master cursor width. If set, causes a larger cursor to be displayed</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osbyte154EntryPoint</span>
        <span class="character">TXA                                                 ;</span>
        <span class="character">; fall through...</span>

    <span class="character">.setVideoULA</span>
        <span class="character">PHP                                                 ; save flags</span>
        <span class="character">SEI                                                 ; disable interrupts</span>
        <span class="character">STA .videoULAVideoControlRegisterCopy               ; save RAM copy of new parameter</span>
        <span class="character">STA .videoULAControlRegister                        ; write to control register</span>
        <span class="character">LDA .videoULASecondFlashingColourInterval           ; get second flashing colour interval</span>
        <span class="character">STA .videoULAFlashingColourIntervalCount            ; set flash counter to this value</span>
        <span class="character">PLP                                                 ; get back status</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSBYTE 155 - Set palette value</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X contains value to write</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osbyte155EntryPoint</span>
        <span class="character">TXA                                                 ; A = X</span>
        <span class="character">; fall through...</span>

    <span class="character">.osbyte155Internal</span>
        <span class="character">EOR #7                                              ; convert to palette format required for video ULA register</span>
        <span class="character">PHP                                                 ; remember flags (including interrupt disable flag)</span>
        <span class="character">SEI                                                 ; prevent interrupts</span>
        <span class="character">STA .videoULAPaletteValue                           ; store as current palette setting</span>
        <span class="character">STA .videoULAPaletteRegister                        ; store actual colour in register</span>
        <span class="character">PLP                                                 ; restore flags (including interrupt disable flag)</span>
        <span class="character">RTS                                                 ; and exit</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
</pre>

<p class="inwebparagraph">Chapter 14
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 14: </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">keyboard</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">gsinitForFilenameParsing</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">GSINIT</span><span class="plain"> - </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">initialisation</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Address</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">/</span><span class="identifier">High</span>
    <span class="plain">;       </span><span class="identifier">C</span><span class="plain"> = 0: </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">terminated</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">SPACE</span><span class="plain">/</span><span class="identifier">CR</span><span class="plain">/</span><span class="identifier">Second</span><span class="plain"> </span><span class="identifier">quotation</span><span class="plain"> </span><span class="identifier">mark</span><span class="plain"> (</span><span class="identifier">used</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">parsing</span><span class="plain">)</span>
    <span class="plain">;       </span><span class="identifier">C</span><span class="plain"> = 1: </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">terminated</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain">/</span><span class="identifier">Second</span><span class="plain"> </span><span class="identifier">quotation</span><span class="plain"> </span><span class="identifier">mark</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">blank</span><span class="plain"> </span><span class="identifier">character</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">blank</span><span class="plain"> </span><span class="identifier">character</span>
    <span class="plain">;       </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">empty</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">gsinitEntryPoint</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">stringInputTempE4</span><span class="plain">                              ; </span><span class="identifier">Rotate</span><span class="plain"> </span><span class="identifier">moves</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">memory</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">skipSpacesAndCheckForCRInStringInput</span><span class="plain">           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">text</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charDOUBLEQUOTE</span><span class="plain">                               ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="character">'"'</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
    <span class="plain">+</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">stringInputTempE4</span><span class="plain">                              ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">CMP</span><span class="plain"> #13                                             ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">Z</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">GSREAD</span><span class="plain"> - </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">routine</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Address</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> .</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">/</span><span class="identifier">High</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">Y</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">read</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">index</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">read</span>
    <span class="plain">;       </span><span class="identifier">Carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">reached</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">preserved</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">gsreadEntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
    <span class="plain">.</span><span class="identifier">gsreadInternal</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">stringInputTempE5</span><span class="plain">                              ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (0 </span><span class="identifier">or</span><span class="plain"> $80 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="character">'!'</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charRETURN</span><span class="plain">                                    ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">CR</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">notRETURN</span><span class="plain">                                      ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="reserved">goto</span><span class="plain"> </span><span class="identifier">EA3F</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">stringInputTempE4</span><span class="plain">                              ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">GSINIT</span><span class="plain">; </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">quotation</span><span class="plain"> </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain">)</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">brkBadString</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">quotation</span><span class="plain"> </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="character">'Bad string'</span><span class="plain"> </span><span class="identifier">message</span><span class="plain">)</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">finishedString</span><span class="plain">                                 ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">notRETURN</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charSPACE</span><span class="plain">                                     ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">SPACE</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">brkBadString</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">space</span><span class="plain">, </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="character">'Bad string'</span><span class="plain"> </span><span class="identifier">message</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">notSPACE</span><span class="plain">                                       ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">stringInputTempE4</span><span class="plain">                              ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> .</span><span class="identifier">stringInputTempE4</span><span class="plain"> =1</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">finishUpReadClearV</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BVC</span><span class="plain"> .</span><span class="identifier">finishedString</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 = 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">notSPACE</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charDOUBLEQUOTE</span><span class="plain">                               ; }</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">notDOUBLEQUOTE</span><span class="plain">                                 ; } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="character">'"'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">stringInputTempE4</span><span class="plain">                              ;  }</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">finishUpReadClearV</span><span class="plain">                             ;  } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> .</span><span class="identifier">stringInputTempE4</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 0 (</span><span class="identifier">one</span><span class="plain"> </span><span class="string">" but no previous "</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charDOUBLEQUOTE</span><span class="plain">                               ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="character">'"'</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">finishUpReadClearV</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">finishedString</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">skipSpacesAndCheckForCRInStringInput</span><span class="plain">           ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">text</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">notDOUBLEQUOTE</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charBAR</span><span class="plain">                                       ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="character">'|'</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">finishUpReadClearV</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">increase</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">stringInputBufferAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charBAR</span><span class="plain">                                       ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="character">'|'</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">finishUpReadClearV</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="character">'|'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charDOUBLEQUOTE</span><span class="plain">                               ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="character">'"'</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">finishUpReadClearV</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charEXCLAMATIONMARK</span><span class="plain">                           ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="character">'!'</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">LDA</span><span class="plain"> #$80                                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">gsreadInternal</span><span class="plain">                                 ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> (</span><span class="identifier">sets</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charSPACE</span><span class="plain">                                     ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="character">' '</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">brkBadString</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="identifier">space</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">code</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="character">'Bad string'</span><span class="plain"> </span><span class="identifier">message</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charQUESTIONMARK</span><span class="plain">                              ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="character">'?'</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="character">'?'</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">implementCTRLCodes</span><span class="plain">                             ; </span><span class="identifier">modify</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">had</span><span class="plain"> </span><span class="identifier">been</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">allBitsSet</span><span class="plain">                                     ; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BVS</span><span class="plain"> .</span><span class="identifier">finishUpReadX</span><span class="plain">                                  ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">finish</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> #$7</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0 </span><span class="identifier">to</span><span class="plain"> 6 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">finishUpReadClearV</span>
        <span class="identifier">CLV</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">V</span>
    <span class="plain">.</span><span class="identifier">finishUpReadX</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">stringInputTempE5</span><span class="plain">                              ;</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">brkBadString</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">FD</span><span class="plain">                                           ; </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"Bad string"</span><span class="plain">,0                                ; </span><span class="identifier">message</span><span class="plain"> (</span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">terminator</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Modify</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">was</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">implementSHIFT</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charZERO</span><span class="plain">                                      ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit24</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="character">'0'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">) [</span><span class="identifier">SHIFT</span><span class="plain"> 0 = 0]</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charAT</span><span class="plain">                                        ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit24</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="character">'@'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">) [</span><span class="identifier">SHIFT</span><span class="plain"> @ = @]</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">flipBitFourIfNotCtrlCharacter</span><span class="plain">                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> &lt; </span><span class="character">'@'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
                                                            <span class="plain">; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">converts</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain">  !</span><span class="string">"#$%&amp;`()*+,-./0123456789:;&lt;=&gt;?</span>
                                                            <span class="string">;                           into 0123456789:;&lt;=&gt;? !"</span><span class="plain">#$%&amp;`()*+,-./</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charDELETE</span><span class="plain">                                    ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit24</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">DELETE</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">) [</span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">DELETE</span><span class="plain"> = </span><span class="identifier">DELETE</span><span class="plain">]</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">flipBitFourOnly</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">greater</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> $7</span><span class="identifier">F</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">toggle</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 4 </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">&gt;64 </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">&lt;127</span>
                                                            <span class="plain">; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">converts</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain">:</span>
                                                            <span class="plain">;        </span><span class="identifier">ABCDEFGHIJKLMNOPQRSTUVWXYZ</span><span class="plain">[\]^</span><span class="identifier">_</span><span class="plain">?</span><span class="identifier">abcdefghijklmnopqrstuvwxyz</span><span class="plain">{|}~</span>
                                                            <span class="plain">; </span><span class="identifier">into</span><span class="plain">   </span><span class="identifier">abcdefghijklmnopqrstuvwxyz</span><span class="plain">{|}~?</span><span class="identifier">_ABCDEFGHIJKLMNOPQRSTUVWXYZ</span><span class="plain">[\]^</span>
    <span class="plain">.</span><span class="identifier">flipBitsForShift</span>
        <span class="identifier">EOR</span><span class="plain"> #%00110000                                      ; </span><span class="identifier">flip</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 4 </span><span class="identifier">and</span><span class="plain"> 5</span>
        <span class="identifier">CMP</span><span class="plain"> #(.</span><span class="identifier">charUNDERSCORE</span><span class="plain"> </span><span class="identifier">XOR</span><span class="plain"> %00110000)                ; }</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">was</span><span class="plain"> </span><span class="identifier">originally</span><span class="plain"> </span><span class="identifier">underscore</span><span class="plain"> </span><span class="character">'_'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">CMP</span><span class="plain"> #(.</span><span class="identifier">charPOUND</span><span class="plain"> </span><span class="identifier">XOR</span><span class="plain"> %00110000)                     ; }</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">flipBitFourIfNotCtrlCharacter</span><span class="plain">                  ; } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">was</span><span class="plain"> </span><span class="identifier">NOT</span><span class="plain"> </span><span class="identifier">originally</span><span class="plain"> </span><span class="identifier">pound</span><span class="plain"> </span><span class="character">'?'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
    <span class="plain">+</span>
        <span class="identifier">EOR</span><span class="plain"> #$1</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">EOR</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">converting</span><span class="plain"> </span><span class="identifier">pound</span><span class="plain"> </span><span class="identifier">symbol</span><span class="plain"> (</span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">become</span>
                                                            <span class="plain">; </span><span class="identifier">underscore</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">EOR</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> .</span><span class="identifier">flipBitFourOnly</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">done</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">flipBitFourIfNotCtrlCharacter</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charSPACE</span><span class="plain"> + 1                                 ; }</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">exit24</span><span class="plain">                                         ; } </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">code</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">flipBitFourOnly</span>
        <span class="identifier">EOR</span><span class="plain"> #%00010000                                      ; </span><span class="identifier">flip</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 4</span>
    <span class="plain">.</span><span class="identifier">exit24</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Modify</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">implementCTRLCodes</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charDELETE</span><span class="plain">                                    ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">DEL</span>
        <span class="identifier">BEQ</span><span class="plain"> ++                                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">routine</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">flipBitsForShift</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">greater</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> $7</span><span class="identifier">F</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">process</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charPOUND</span><span class="plain">                                     ; }</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="character">'?'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #.</span><span class="identifier">charUNDERSCORE</span><span class="plain">                                ; </span><span class="identifier">A</span><span class="plain">=</span><span class="character">'_'</span>
    <span class="plain">+</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charAT</span><span class="plain">                                        ; }</span>
        <span class="identifier">BCC</span><span class="plain"> ++                                              ; } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> &lt; </span><span class="character">'@'</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">unchanged</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> #%00011111                                      ; </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain">     </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">between</span><span class="plain"> 64 </span><span class="identifier">to</span><span class="plain"> 126 </span><span class="identifier">inclusive</span>
                                                            <span class="plain">; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 5 </span><span class="identifier">to</span><span class="plain"> 7  </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">between</span><span class="plain">  0 </span><span class="identifier">to</span><span class="plain">  31 </span><span class="identifier">inclusive</span>
    <span class="plain">++</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">runBootString</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"/!BOOT"</span><span class="plain">,13</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 247 - </span><span class="identifier">Intercept</span><span class="plain"> </span><span class="identifier">BREAK</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;           </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">intercept</span><span class="plain"> </span><span class="identifier">code</span>
    <span class="plain">; </span><span class="identifier">otherwise</span><span class="plain"> </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">cleared</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">code</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte247EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">breakInterceptJMPInstruction</span><span class="plain">                  ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> (</span><span class="identifier">looking</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="character">'JMP address'</span><span class="plain">)</span>
        <span class="identifier">EOR</span><span class="plain"> #$4</span><span class="identifier">C</span><span class="plain">                                           ; </span><span class="identifier">produces</span><span class="plain"> 0 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">JMP</span><span class="plain"> </span><span class="identifier">absolute</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">present</span>
        <span class="identifier">BNE</span><span class="plain"> +                                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">breakInterceptJMPInstruction</span><span class="plain">                  ; </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain"> </span><span class="identifier">code</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 144 - *</span><span class="identifier">TV</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">display</span>
    <span class="plain">;   </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">interlace</span><span class="plain"> </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">flag</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;   </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">display</span>
    <span class="plain">;   </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">interlace</span><span class="plain"> </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">flag</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte144EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduVerticalAdjust</span><span class="plain">                              ; </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">vertical</span><span class="plain"> </span><span class="identifier">adjustment</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">vduVerticalAdjust</span><span class="plain">                              ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">interlace</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">AND</span><span class="plain"> #1                                              ; </span><span class="identifier">maximum</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> =1</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">vduInterlaceValue</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vduInterlaceValue</span><span class="plain">                              ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">A</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Exit</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 147 - </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">FRED</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">page</span>
    <span class="plain">; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain">;</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte147EntryPoint</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fredPage</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                     ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 149 - </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">JIM</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">page</span>
    <span class="plain">; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte149EntryPoint</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">jimPage</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                      ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 151 - </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">SHEILA</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">page</span>
    <span class="plain">; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte151EntryPoint</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">sheilaPage</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                   ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 15
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 15: </span><span class="identifier">Sound</span><span class="plain">, </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">processing</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">buffer</span><span class="plain"> (</span><span class="identifier">channel</span><span class="plain">) </span><span class="identifier">number</span><span class="plain"> (4-7)</span>
    <span class="plain">.</span><span class="identifier">silenceChannelX</span>
        <span class="identifier">LDA</span><span class="plain"> #4                                              ; </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">release</span><span class="plain"> </span><span class="identifier">phase</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0PhaseCounter</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">C0</span><span class="plain">                                            ; </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">volume</span>

    <span class="plain">.</span><span class="identifier">setChannelXVolume</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Volume</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">give</span><span class="plain"> </span><span class="identifier">basic</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">level</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">soundDisableFlag</span><span class="plain">                               ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">output</span><span class="plain">/</span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">C0</span><span class="plain">                                            ; </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">volume</span>
    <span class="plain">+</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">SBC</span><span class="plain"> #$40                                            ; </span><span class="identifier">subtract</span><span class="plain"> $40</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">divide</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> 8</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0 - 3</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">EOR</span><span class="plain"> #$0</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">invert</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0-3</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">soundParameterTable</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                      ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">nybble</span>
        <span class="identifier">ORA</span><span class="plain"> #$10                                            ;</span>

    <span class="plain">.</span><span class="identifier">sendToSoundChip</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ;</span>
    <span class="plain">.</span><span class="identifier">sendToSoundChipFlagsAreadyPushed</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">LDY</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; }</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">systemViaDataDirectionRegisterA</span><span class="plain">                ; } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">direction</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">outputs</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterBNoHandshake</span><span class="plain">                  ; </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">chip</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> (</span><span class="identifier">active</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> #2                                              ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">execute</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">delay</span>
                                                            <span class="plain">; (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">keep</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">least</span><span class="plain"> 8 </span><span class="identifier">us</span><span class="plain"> (16 </span><span class="identifier">cycles</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">required</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">chip</span><span class="plain"> </span><span class="identifier">hardware</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">takes</span><span class="plain"> 12 </span><span class="identifier">cycles</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 5 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="reserved">long</span><span class="plain">.</span>
                                                            <span class="plain">; (</span><span class="identifier">An</span><span class="plain"> </span><span class="identifier">alternative</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">also</span><span class="plain"> </span><span class="identifier">takes</span><span class="plain"> 12 </span><span class="identifier">cycles</span><span class="plain">, </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">only</span><span class="plain"> 3 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="reserved">long</span>
                                                            <span class="plain">; </span><span class="identifier">would</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">JSR</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">RTS</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain">.)</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>

        <span class="identifier">LDY</span><span class="plain"> #8                                              ; }</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; } </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> (</span><span class="identifier">inactive</span><span class="plain">)</span>

        <span class="identifier">LDY</span><span class="plain"> #4                                              ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">execute</span><span class="plain"> </span><span class="identifier">another</span><span class="plain"> </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">delay</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; (</span><span class="identifier">it</span><span class="character">'s longer this time for some reason? It seems like this loop is not needed at all to me.)</span>
        <span class="character">PLP                                                 ; get back flags</span>
        <span class="character">RTS                                                 ; and exit</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Table to convert channel number to the value required by the chip</span>
    <span class="character">.soundParameterTable</span>
        <span class="character">!byte $E0,$C0,$A0,$80</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.localSkipToNextChannel</span>
        <span class="character">JMP .skipToNextChannel                              ; go to next channel (local version here is</span>
                                                            <span class="character">; just to allow relative branches in early</span>
                                                            <span class="character">; part of sound interrupt routine)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.processSoundInterrupt</span>
        <span class="character">LDA #0                                              ;</span>
        <span class="character">STA .numberOfSoundChannelsOnHold                    ; zero number of channels on hold for sync</span>
        <span class="character">LDA .numberOfSoundChannelsRequiredForHold           ; get number of channels required for sync</span>
        <span class="character">BNE +                                               ; if this is not zero then branch</span>
        <span class="character">INC .numberOfSoundChannelsOnHold                    ; else number of chanels on hold for sync =1</span>
        <span class="character">DEC .numberOfSoundChannelsRequiredForHold           ; number of channels required for sync =255</span>
    <span class="character">+</span>
        <span class="character">LDX #8                                              ; set loop counter (X = buffer number 4-7, corresponding to the channel number 0-3)</span>
    <span class="character">.processSoundChannel</span>
        <span class="character">DEX                                                 ; loop counter (X=4,5,6,7)</span>
        <span class="character">LDA .channel0Occupancy - 4,X                        ; get (sound queue occupancy)</span>
        <span class="character">BEQ .localSkipToNextChannel                         ; if (nothing playing on this channel) then branch (check next channel)</span>
        <span class="character">LDA .bufferEmptyFlags,X                             ; get buffer empty flag</span>
        <span class="character">BMI .chooseNextSound                                ; if negative (buffer empty) then branch (choose the next sound to play)</span>
        <span class="character">LDA .channel0Duration - 4,X                         ; get duration remaining</span>
        <span class="character">BNE .continueExistingSound                          ; if (duration remaining &gt; 0) then branch (continue processing current sound)</span>
    <span class="character">.chooseNextSound</span>
        <span class="character">JSR .checkForNextSoundToPlay                        ; check and pick up new sound if required</span>
    <span class="character">.continueExistingSound</span>
        <span class="character">LDA .channel0Duration - 4,X                         ; get duration</span>
        <span class="character">BEQ .skipUpdateOfCurrentSound                       ; if (duration is zero) then branch (skip update)</span>
        <span class="character">CMP #$FF                                            ; check for $FF duration (infinite duration)</span>
        <span class="character">BEQ .notAtEndOfCurrentSoundDuration                 ; if (infinite duration) then branch (not at end of current sound)</span>
        <span class="character">DEC .channel0Countdown - 4,X                        ; decrement 10 mS count</span>
        <span class="character">BNE .notAtEndOfCurrentSoundDuration                 ; if (counter not reached zero) then branch (not at end of current sound)</span>
        <span class="character">LDA #5                                              ; reset to 5</span>
        <span class="character">STA .channel0Countdown - 4,X                        ; to give 50 mSec delay</span>
        <span class="character">DEC .channel0Duration - 4,X                         ; and decrement main counter</span>
        <span class="character">BNE .notAtEndOfCurrentSoundDuration                 ; if (duration is non-zero) then branch (not at end of current sound)</span>

    <span class="character">.skipUpdateOfCurrentSound</span>
        <span class="character">JSR .checkForNextSoundToPlay                        ; else check and get new sound</span>

    <span class="character">.notAtEndOfCurrentSoundDuration</span>
        <span class="character">LDA .channel0StepProgress - 4,X                     ; check the step progress</span>
        <span class="character">BEQ +                                               ; if (step progress counter is zero) then branch (don'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">step</span><span class="plain"> </span><span class="identifier">progress</span><span class="plain">)</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">channel0StepProgress</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">step</span><span class="plain"> </span><span class="identifier">progress</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">localSkipToNextChannel</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">step</span><span class="plain"> </span><span class="identifier">progress</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain">)</span>

    <span class="plain">+</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">channel0EnvelopeOffset</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">offset</span>
        <span class="identifier">CPY</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">channel</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">localSkipToNextChannel</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">active</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">envelopeBuffer</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                               ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">step</span><span class="plain"> </span><span class="identifier">length</span>
        <span class="identifier">AND</span><span class="plain"> #%01111111                                      ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">bit</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0StepProgress</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0PhaseCounter</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">phase</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">CMP</span><span class="plain"> #4                                              ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">release</span><span class="plain"> </span><span class="identifier">phase</span><span class="plain"> </span><span class="identifier">complete</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">endOfEnvelope</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">release</span><span class="plain"> </span><span class="identifier">phase</span><span class="plain"> </span><span class="identifier">completed</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0PhaseCounter</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">step</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">getting</span><span class="plain"> </span><span class="identifier">phase</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">channel0EnvelopeOffset</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                   ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">interval</span><span class="plain"> </span><span class="identifier">multiplier</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">transfer</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">envelopeBuffer</span><span class="plain"> + 11,</span><span class="identifier">Y</span><span class="plain">                          ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">target</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">base</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">envelope</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ;</span>
        <span class="identifier">SBC</span><span class="plain"> #$3</span><span class="identifier">F</span><span class="plain">                                            ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">targetAmplitude</span><span class="plain">                                ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">modified</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">target</span><span class="plain"> </span><span class="identifier">amplitude</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">envelopeBuffer</span><span class="plain"> + 7,</span><span class="identifier">Y</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">currentAmplitudeStep</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">amplitude</span><span class="plain"> </span><span class="identifier">step</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0Volume</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">base</span><span class="plain"> </span><span class="identifier">volumelevel</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">currentAmplitudeStep</span><span class="plain">                           ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">amplitude</span><span class="plain"> </span><span class="identifier">step</span>
        <span class="identifier">BVC</span><span class="plain"> .</span><span class="identifier">skipToggleBits</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">overflow</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">Carry</span><span class="plain"> = </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">LDA</span><span class="plain"> #$3</span><span class="identifier">F</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=$3</span><span class="identifier">F</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">skipToggleBits</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">EOR</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">toggle</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">C0</span><span class="plain">)</span>

                                                            <span class="plain">; </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain"> </span><span class="identifier">volume</span><span class="plain"> </span><span class="identifier">commands</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">converted</span>
                                                            <span class="plain">; $</span><span class="identifier">C0</span><span class="plain"> (0) </span><span class="identifier">to</span><span class="plain"> $38 (-15) 3 </span><span class="identifier">times</span><span class="plain">, </span><span class="identifier">In</span><span class="plain"> </span><span class="identifier">fact</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> 3 </span><span class="identifier">bits</span>
                                                            <span class="plain">; </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">ignored</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> $3</span><span class="identifier">F</span><span class="plain"> </span><span class="identifier">represents</span><span class="plain"> -15</span>
    <span class="plain">.</span><span class="identifier">skipToggleBits</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Volume</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">volume</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; </span><span class="identifier">multiply</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> 2</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">channel0Volume</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                           ;</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">updateAmplitude</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 6 </span><span class="identifier">and</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">volume</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">equal</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">update</span><span class="plain"> </span><span class="identifier">amplitude</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #$3</span><span class="identifier">F</span><span class="plain">                                            ; }</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=$3</span><span class="identifier">F</span><span class="plain">; </span><span class="identifier">otherwise</span><span class="plain"> $</span><span class="identifier">C0</span>
        <span class="identifier">EOR</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; }</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Volume</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">volume</span>

    <span class="plain">.</span><span class="identifier">updateAmplitude</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">currentAmplitudeStep</span><span class="plain">                           ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">amplitude</span><span class="plain"> </span><span class="identifier">change</span><span class="plain"> </span><span class="identifier">per</span><span class="plain"> </span><span class="identifier">step</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0Volume</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">volume</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">targetAmplitude</span><span class="plain">                                ; </span><span class="identifier">subtract</span><span class="plain"> </span><span class="identifier">target</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">currentAmplitudeStep</span><span class="plain">                           ; </span><span class="identifier">negative</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">indicates</span><span class="plain"> </span><span class="identifier">correct</span><span class="plain"> </span><span class="identifier">trend</span>
        <span class="identifier">BMI</span><span class="plain"> +                                               ; </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">part</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">targetAmplitude</span><span class="plain">                                ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">enter</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">phase</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Volume</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                           ;</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">channel0PhaseCounter</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ;</span>
    <span class="plain">+</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">old</span><span class="plain"> </span><span class="identifier">volume</span><span class="plain"> </span><span class="identifier">level</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">channel0Volume</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">old</span>
        <span class="identifier">AND</span><span class="plain"> #$</span><span class="identifier">F8</span><span class="plain">                                            ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">endOfEnvelope</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">they</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0Volume</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                           ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">level</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setChannelXVolume</span><span class="plain">                              ; </span><span class="identifier">via</span><span class="plain"> .</span><span class="identifier">setChannelXVolume</span>

    <span class="plain">.</span><span class="identifier">endOfEnvelope</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0Section</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                          ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">section</span><span class="plain"> (0-2)</span>
        <span class="identifier">CMP</span><span class="plain"> #3                                              ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">have</span><span class="plain"> </span><span class="identifier">reached</span><span class="plain"> </span><span class="identifier">section</span><span class="plain"> 3</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">skipToNextChannel</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">section</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 3) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">rest</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">sections</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">finished</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0SectionProgress</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                  ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">progress</span><span class="plain"> </span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">section</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">countdownTimerNotFinished</span><span class="plain">                      ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">countdown</span><span class="plain"> </span><span class="identifier">timer</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">section</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">yet</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">channel0Section</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                          ; </span><span class="identifier">implement</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">section</span><span class="plain"> </span><span class="identifier">change</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0Section</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                          ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">complete</span>
        <span class="identifier">CMP</span><span class="plain"> #3                                              ;</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">complete</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">channel0EnvelopeOffset</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                   ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">from</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">envelopeBuffer</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                               ; </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">skipToNextChannel</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain"> </span><span class="identifier">there</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">repeat</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">restart</span><span class="plain"> </span><span class="identifier">section</span><span class="plain"> </span><span class="identifier">sequence</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Differential</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Section</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                          ;</span>

    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0Section</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                          ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">steps</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">section</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">channel0EnvelopeOffset</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                   ;</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ;</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">envelopeBuffer</span><span class="plain"> + 4,</span><span class="identifier">Y</span><span class="plain">                           ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0SectionProgress</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                  ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">skipToNextChannel</span><span class="plain">                              ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">EC59</span>

    <span class="plain">.</span><span class="identifier">countdownTimerNotFinished</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">channel0SectionProgress</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                  ; </span><span class="identifier">decrement</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0EnvelopeOffset</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                   ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">pick</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">rate</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">change</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">channel0Section</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                          ;</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ;</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">envelopeBuffer</span><span class="plain"> + 1,</span><span class="identifier">Y</span><span class="plain">                           ;</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">channel0Differential</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">rate</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">differential</span><span class="plain"> </span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">change</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Differential</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">channel0BasePitch</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                        ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">base</span><span class="plain"> </span><span class="identifier">pitch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setPitch</span><span class="plain">                                       ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">pitch</span>

    <span class="plain">.</span><span class="identifier">skipToNextChannel</span>
        <span class="identifier">CPX</span><span class="plain"> #4                                              ;</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=4 (</span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">processSoundChannel</span><span class="plain">                            ; </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">again</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">clearSoundChannels</span>
        <span class="identifier">LDX</span><span class="plain"> #8                                              ; </span><span class="identifier">X</span><span class="plain">=8</span>
    <span class="plain">-</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; } </span><span class="identifier">Loop</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=7 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=4 </span><span class="identifier">inclusive</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearSoundChannelBuffer</span><span class="plain">                        ; } </span><span class="identifier">clearing</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">CPX</span><span class="plain"> #4                                              ; }</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; }</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkForNextSoundToPlay</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0PhaseCounter</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">phase</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">CMP</span><span class="plain"> #4                                              ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="character">'release complete'</span><span class="plain"> </span><span class="identifier">state</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">release</span><span class="plain"> </span><span class="identifier">complete</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #3                                              ; </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">release</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">progress</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0PhaseCounter</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">bufferEmptyFlags</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                             ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">skipResetAsBufferIsNotEmpty</span><span class="plain">                    ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">empty</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">bufferEmptyFlags</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                             ; </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>

        <span class="identifier">LDY</span><span class="plain"> #4                                              ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0SyncFlag</span><span class="plain"> - 1,</span><span class="identifier">Y</span><span class="plain">                         ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">bytes</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ;</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">=0</span>

        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Duration</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">duration</span><span class="plain"> </span><span class="identifier">count</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">to</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">numberOfSoundChannelsRequiredForHold</span><span class="plain">           ; $</span><span class="identifier">FF</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">skipResetAsBufferIsNotEmpty</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0SyncFlag</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">synchronising</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">syncSounds</span><span class="plain">                                     ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">numberOfSoundChannelsOnHold</span><span class="plain">                    ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">channels</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">hold</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">silenceNonEnvelopeSound</span><span class="plain">                        ; </span><span class="reserved">if</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">silence</span><span class="plain"> </span><span class="identifier">sound</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="reserved">else</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0SyncFlag</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">synchronising</span><span class="plain"> </span><span class="identifier">flag</span>
    <span class="plain">.</span><span class="identifier">localJump</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">readByteFromSoundBuffer</span><span class="plain">                        ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">clearSoundChannelBuffer</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">silenceChannelX</span><span class="plain">                                ; </span><span class="identifier">silence</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">channel</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=0 </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Duration</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">main</span><span class="plain"> </span><span class="identifier">count</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">bufferEmptyFlags</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                             ; </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">empty</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Occupancy</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                        ; </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">dormant</span>
        <span class="identifier">LDY</span><span class="plain"> #3                                              ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0SyncFlag</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                             ; }</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; } </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; }</span>

        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">numberOfSoundChannelsRequiredForHold</span><span class="plain">           ; </span><span class="identifier">set</span><span class="plain"> </span><span class="character">'number of channels required to hold'</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $</span><span class="identifier">FF</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">setPitchChanged</span><span class="plain">                                ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">Explain</span>
    <span class="plain">.</span><span class="identifier">syncSoundBufferEmpty</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0PhaseCounter</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">release</span>
        <span class="identifier">CMP</span><span class="plain"> #4                                              ;</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">found</span><span class="plain"> </span><span class="identifier">ECCF</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte152EntryPoint</span><span class="plain">                            ; </span><span class="identifier">elseexamine</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain"> </span><span class="identifier">ECCF</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">dormant</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Occupancy</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                        ;</span>
    <span class="plain">+</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">silenceNonEnvelopeSound</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">channel0EnvelopeOffset</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                   ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> 820=$</span><span class="identifier">FF</span>
        <span class="identifier">CPY</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ;</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">exit25</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">envelope</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">silenceChannelX</span><span class="plain">                                ; </span><span class="identifier">silence</span><span class="plain"> </span><span class="identifier">channel</span>
    <span class="plain">.</span><span class="identifier">exit25</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">Explain</span>
    <span class="plain">.</span><span class="identifier">syncSounds</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte152EntryPoint</span><span class="plain">                            ; </span><span class="identifier">examine</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">syncSoundBufferEmpty</span><span class="plain">                           ;</span>
        <span class="identifier">AND</span><span class="plain"> #3                                              ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">examine</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">word</span><span class="plain"> </span><span class="reserved">if</span><span class="plain">&gt;3 </span><span class="identifier">or</span><span class="plain"> 0</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">localJump</span><span class="plain">                                      ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain">   </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">Explain</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">numberOfSoundChannelsRequiredForHold</span><span class="plain">           ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">synchronising</span><span class="plain"> </span><span class="identifier">count</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="identifier">in</span><span class="plain"> 0 (</span><span class="identifier">complete</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">channel0SyncFlag</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">sync</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">numberOfSoundChannelsRequiredForHold</span><span class="plain">           ; </span><span class="reserved">if</span><span class="plain"> 0838 </span><span class="identifier">is</span><span class="plain"> +</span><span class="identifier">ve</span><span class="plain"> </span><span class="identifier">S</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">already</span><span class="plain"> </span><span class="identifier">been</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">so</span>
        <span class="identifier">BPL</span><span class="plain"> ++                                              ; </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ECFB</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte152EntryPoint</span><span class="plain">                            ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">AND</span><span class="plain"> #3                                              ; </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0,1</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">numberOfSoundChannelsRequiredForHold</span><span class="plain">           ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="identifier">Jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ECFE</span><span class="plain"> (</span><span class="identifier">ALWAYS</span><span class="plain">!!)</span>
    <span class="plain">++</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">numberOfSoundChannelsRequiredForHold</span><span class="plain">           ;</span>
    <span class="plain">+</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">silenceNonEnvelopeSound</span><span class="plain">                        ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">silence</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">use</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setPitch</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">channel0Pitch</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit25</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">equal</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">setPitchChanged</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Pitch</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                            ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">pitch</span>
        <span class="identifier">CPX</span><span class="plain"> #4                                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> 4 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">noise</span><span class="plain"> </span><span class="identifier">so</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">setPitchNotNoise</span><span class="plain">                               ; </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ED16</span>

        <span class="plain">; </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">noise</span>
        <span class="identifier">AND</span><span class="plain"> #$0</span><span class="identifier">F</span><span class="plain">                                            ; }</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">soundParameterTable</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                      ; } </span><span class="identifier">convert</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">chip</span><span class="plain"> </span><span class="identifier">format</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">proxySendToSoundChipFlagsAreadyPushed</span><span class="plain">          ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">chip</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">routine</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setPitchNotNoise</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">pitch</span><span class="plain"> (0-252 </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">steps</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">usually</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">semitones</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> #3                                              ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fractionalSemitones</span><span class="plain">                            ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">fractional</span><span class="plain"> </span><span class="identifier">amount</span><span class="plain"> (0-3) </span><span class="identifier">between</span><span class="plain"> </span><span class="identifier">semitones</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ;</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">value</span><span class="plain">)</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; } </span><span class="identifier">divide</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> 4</span>
    <span class="plain">-</span>
        <span class="identifier">CMP</span><span class="plain"> #12                                             ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">finishedGettingOctave</span><span class="plain">                          ;</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">SBC</span><span class="plain"> #12                                             ; </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">remainder</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>

                                                            <span class="plain">; </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain"> </span><span class="identifier">defines</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">Octave</span><span class="plain"> (0-5)</span>
                                                            <span class="plain">; </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">semitone</span><span class="plain"> </span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">octave</span>

    <span class="plain">.</span><span class="identifier">finishedGettingOctave</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">semitone</span><span class="plain"> </span><span class="identifier">within</span><span class="plain"> </span><span class="identifier">octave</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">octave</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">pitchLookupTable1</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                            ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">look</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">pitchLookupTable2</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                            ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">table</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">AND</span><span class="plain"> #3                                              ; </span><span class="identifier">keep</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">least</span><span class="plain"> </span><span class="identifier">significant</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">only</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">soundVariableB</span><span class="plain">                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">them</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; } </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">down</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">nybble</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">soundVariableC</span><span class="plain">                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> (</span><span class="identifier">amount</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">subtract</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">fraction</span><span class="plain"> (0-3) </span><span class="identifier">between</span><span class="plain"> </span><span class="identifier">semitones</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ;</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">fractionalSemitones</span><span class="plain">                            ; </span><span class="identifier">adjust</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">surplus</span><span class="plain"> </span><span class="identifier">eighth</span><span class="plain"> </span><span class="identifier">tones</span>
        <span class="identifier">BEQ</span><span class="plain"> ++                                              ;</span>

    <span class="plain">-</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ; </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">Explain</span><span class="plain">!</span>
        <span class="identifier">SBC</span><span class="plain"> .</span><span class="identifier">soundVariableC</span><span class="plain">                                 ;</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ;</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">soundVariableB</span><span class="plain">                                 ;</span>
    <span class="plain">+</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ;</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>

    <span class="plain">++</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">octave</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> = </span><span class="identifier">octave</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ;</span>
    <span class="plain">-</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">soundVariableB</span><span class="plain">                                 ; }</span>
        <span class="identifier">ROR</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ; } </span><span class="identifier">halve</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">octave</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ;</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ;</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">soundPitchOffsetByChannelTable</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">           ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">depending</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> (0,0,1,2)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ;</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ;</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">soundVariableB</span><span class="plain">                                 ;</span>
    <span class="plain">+</span>
        <span class="identifier">AND</span><span class="plain"> #$0</span><span class="identifier">F</span><span class="plain">                                            ;</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">soundParameterTable</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                      ;</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">P</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">sendToSoundChip</span><span class="plain">                                ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">chip</span><span class="plain"> </span><span class="identifier">access</span><span class="plain"> 1</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">soundVariableA</span><span class="plain">                                 ;</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">soundVariableB</span><span class="plain">                                 ;</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">soundVariableB</span><span class="plain">                                 ;</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ;</span>
    <span class="plain">.</span><span class="identifier">proxySendToSoundChipFlagsAreadyPushed</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">sendToSoundChipFlagsAreadyPushed</span><span class="plain">               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">chip</span><span class="plain"> </span><span class="identifier">access</span><span class="plain"> 2 </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">Explain</span>
    <span class="plain">.</span><span class="identifier">readByteFromSoundBuffer</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte145EntryPoint</span><span class="plain">                            ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">AND</span><span class="plain"> #4                                              ; </span><span class="identifier">isolate</span><span class="plain"> </span><span class="identifier">H</span><span class="plain"> </span><span class="identifier">bit</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">noHold</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">hold</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">channel0EnvelopeOffset</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">offset</span>
        <span class="identifier">CPY</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">use</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">silenceChannelX</span><span class="plain">                                ; </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">silence</span><span class="plain"> </span><span class="identifier">channel</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte145EntryPoint</span><span class="plain">                            ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">redundant</span><span class="plain"> </span><span class="identifier">data</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte145EntryPoint</span><span class="plain">                            ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">again</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">setDurationAndExit</span><span class="plain">                             ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">main</span><span class="plain"> </span><span class="identifier">duration</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">buffer</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">Explain</span>
    <span class="plain">.</span><span class="identifier">noHold</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">AND</span><span class="plain"> #%11111000                                      ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0-2</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> (</span><span class="identifier">envelope</span><span class="plain">) </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">EDC8</span>
        <span class="identifier">EOR</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">invert</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">right</span>
        <span class="identifier">SEC</span><span class="plain">                                                 ;</span>
        <span class="identifier">SBC</span><span class="plain"> #$40                                            ; </span><span class="identifier">subtract</span><span class="plain"> $40</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setChannelXVolume</span><span class="plain">                              ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">volume</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FF</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0EnvelopeOffset</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">number</span><span class="plain">-1 *16 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> #5                                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">duration</span><span class="plain"> </span><span class="identifier">sub</span><span class="plain">-</span><span class="identifier">counter</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Countdown</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                        ;</span>
        <span class="identifier">LDA</span><span class="plain"> #1                                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">phase</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0StepProgress</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ;</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">step</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0SectionProgress</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                  ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0PhaseCounter</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">envelope</span><span class="plain"> </span><span class="identifier">phase</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Differential</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                     ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">differential</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Section</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                          ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">step</span><span class="plain"> </span><span class="identifier">count</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte145EntryPoint</span><span class="plain">                            ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">pitch</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0BasePitch</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                        ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte145EntryPoint</span><span class="plain">                            ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ;</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">duration</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">channel0BasePitch</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">pitch</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setPitch</span><span class="plain">                                       ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">duration</span>
    <span class="plain">.</span><span class="identifier">setDurationAndExit</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">channel0Duration</span><span class="plain"> - 4,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">TODO</span><span class="plain">: </span><span class="identifier">Explain</span><span class="plain"> </span><span class="identifier">these</span><span class="plain"> </span><span class="identifier">tables</span><span class="plain">!</span>
    <span class="plain">.</span><span class="identifier">pitchLookupTable1</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">F0</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">B7</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $82</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $4</span><span class="identifier">F</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $20</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">F3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">C8</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">A0</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $7</span><span class="identifier">B</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $57</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $35</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $16</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">pitchLookupTable2</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">E7</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">D7</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">CB</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">C3</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">B7</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">AA</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">A2</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $9</span><span class="identifier">A</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $92</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $8</span><span class="identifier">A</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $82</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $7</span><span class="identifier">A</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setInitialSpeechPHROMNumber</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">EF</span><span class="plain">                                            ; </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">PHROM</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> $</span><span class="identifier">F0</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">EF</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">since</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">incremented</span><span class="plain"> </span><span class="identifier">before</span><span class="plain"> </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">accessed</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">currentLogicalSpeechPHROMOrROMFSNumber</span><span class="plain">         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readByteFromROMOrPHROM</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallROMFilingSystemInitialize</span><span class="plain">       ; </span><span class="identifier">X</span><span class="plain">=13 (</span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">initialise</span><span class="plain">)</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">currentLogicalSpeechPHROMOrROMFSNumber</span><span class="plain">         ;</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">currentLogicalSpeechPHROMOrROMFSNumber</span><span class="plain">         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">Rom</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">romServiceCall</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> +</span><span class="identifier">ve</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">sideways</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">PHROM</span>

        <span class="plain">; </span><span class="identifier">PHROM</span><span class="plain"> </span><span class="identifier">found</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; }</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">romAddressHigh</span><span class="plain">                                 ; }</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">PHROM</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $0001</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">romAddressLow</span><span class="plain">                                  ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">writeAddressToSpeechProcessor</span><span class="plain">                  ; </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">info</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>

        <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">have</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">copyright</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="string">"(C)"</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">PHROM</span>
        <span class="identifier">LDX</span><span class="plain"> #3                                              ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readByteFromPHROM</span><span class="plain">                              ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">PHROM</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">copyrightString</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                              ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">it</span><span class="character">'s the copyright string</span>
        <span class="character">BNE .readByteFromROMOrPHROM                         ; if (no match) then branch (try next ROM)</span>
        <span class="character">DEX                                                 ; decrement loop counter</span>
        <span class="character">BPL -                                               ; loop back until done</span>

        <span class="character">LDA #$3E                                            ; ROM address is $003E, to read the '</span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">data</span><span class="character">' address (See Speech User Guide, Page 27)</span>
        <span class="character">STA .romAddressLow                                  ; set low byte of address</span>

    <span class="character">.readFromPHROM</span>
        <span class="character">JSR .writeAddressToSpeechProcessor                  ; pass info to speech processor</span>

        <span class="character">LDX #$FF                                            ; X = loop counter (to read two bytes)</span>
    <span class="character">.loopNextByte</span>
        <span class="character">JSR .readByteFromPHROM                              ; check for speech proc. etc.</span>

        <span class="character">; Store the byte read into .romAddressLow/High, reversing all the bits</span>
        <span class="character">LDY #8                                              ; y = loop counter Y (to read 8 bits)</span>
    <span class="character">-</span>
        <span class="character">ASL                                                 ; shift byte from PHROM</span>
        <span class="character">ROR .romAddressHigh,X                               ; rotate into memory, reversing order of the bits</span>
        <span class="character">DEY                                                 ; into .romAddressLow (X=255) and .romAddressHigh (X=0)</span>
        <span class="character">BNE -                                               ; loop eight times</span>

        <span class="character">INX                                                 ; increment X to zero (first loop iteration) or one (second loop iteration)</span>
        <span class="character">BEQ .loopNextByte                                   ; if X=0 (first time around loop) then branch (loop back to read another byte)</span>

        <span class="character">CLC                                                 ;</span>
        <span class="character">BCC .writeAddressToSpeechProcessor                  ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Read from ROM Filing System or Speech PHrase ROM</span>
    <span class="character">.readByteFromRFSROMorPHROM</span>
        <span class="character">LDX #.romServiceCallROMFilingSystemByteGet          ; paged ROM service call to get a byte from the ROM filing system</span>
        <span class="character">LDY .currentLogicalSpeechPHROMOrROMFSNumber         ; check rom number</span>
        <span class="character">BMI .readByteFromPHROM                              ; if Y is negative (PHROM) then branch</span>
        <span class="character">LDY #$FF                                            ; else Y=255</span>
    <span class="character">.romServiceCall</span>
        <span class="character">PHP                                                 ; store flags</span>
        <span class="character">JSR .osbyte143EntryPoint                            ; paged ROM service call</span>
        <span class="character">PLP                                                 ; restore flags</span>
        <span class="character">CMP #1                                              ; if A&gt;0 (ROM service call was not claimed) then set carry (but carry doesn'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">seem</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">used</span><span class="plain">?)</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">read</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readByteFromPHROM</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">LDY</span><span class="plain"> #$10                                            ; </span><span class="identifier">Command</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ask</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte159EntryPoint</span><span class="plain">                            ; </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 159 - </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">readWriteSpeechProcessorPushedFlags</span><span class="plain">            ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain">)</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 158 - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte158EntryPoint</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                             ; </span><span class="identifier">Y</span><span class="plain">=0 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">proc</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">read</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">readWriteSpeechProcessor</span><span class="plain">                      ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">nybbles</span>
    <span class="plain">.</span><span class="identifier">writeTwoNybblesToSpeechProcessor</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">writeLoadAddressCommandToSpeechProcessor</span><span class="plain">       ; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; </span><span class="identifier">bring</span><span class="plain"> </span><span class="identifier">upper</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="identifier">nybble</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">right</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; 4 </span><span class="identifier">times</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ;</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Write</span><span class="plain"> </span><span class="character">'Load address'</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
    <span class="plain">; </span><span class="identifier">See</span><span class="plain"> </span><span class="identifier">Speech</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">Users</span><span class="plain"> </span><span class="identifier">Guide</span><span class="plain"> (</span><span class="identifier">Page</span><span class="plain"> 21)</span>
    <span class="plain">.</span><span class="identifier">writeLoadAddressCommandToSpeechProcessor</span>
        <span class="identifier">AND</span><span class="plain"> #%00001111                                      ; </span><span class="identifier">mask</span><span class="plain"> </span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">nybble</span>
        <span class="identifier">ORA</span><span class="plain"> #%01000000                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 (</span><span class="character">'Load address'</span><span class="plain">)</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">forming</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 159 - </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">command</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte159EntryPoint</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">transfer</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDY</span><span class="plain"> #1                                              ; </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">proc</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span>
    <span class="plain">;           </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">op</span><span class="plain">-</span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">data</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain">=0 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain">=1 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">See</span><span class="plain"> </span><span class="character">'Speech System Users Guide'</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">details</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Speech</span><span class="plain"> </span><span class="identifier">Processor</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="character">'Texas Instruments TMS 5220 Voice Synthesis Processor'</span>
    <span class="plain">; </span><span class="identifier">Speech</span><span class="plain">  </span><span class="identifier">Data</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="character">'Texas Instruments 16K TMS6100'</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readWriteSpeechProcessor</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
    <span class="plain">.</span><span class="identifier">readWriteSpeechProcessorPushedFlags</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">speechSystemPresentFlag</span><span class="plain">                        ; </span><span class="identifier">test</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">presence</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">finishedWithSpeech</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">found</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">speechDataTable</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                              ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaDataDirectionRegisterA</span><span class="plain">                ; } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">DDRA</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">give</span><span class="plain"> 8 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">=0) </span><span class="identifier">or</span><span class="plain"> 8 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">=1)</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterBNoHandshake</span><span class="plain">                  ; </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">chip</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">speechDataTable</span><span class="plain"> + 2,</span><span class="identifier">Y</span><span class="plain">                          ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; } </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">=0) </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">=1)</span>
    <span class="plain">-</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">BMI</span><span class="plain"> -                                               ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">reports</span><span class="plain"> </span><span class="identifier">ready</span><span class="plain"> (</span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">Port</span><span class="plain"> </span><span class="identifier">B</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterBNoHandshake</span><span class="plain">                  ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> (</span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">selected</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">speechDataTable</span><span class="plain"> + 4,</span><span class="identifier">Y</span><span class="plain">                          ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; } </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">=0) </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">=1)</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">finishedWithSpeech</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> (</span><span class="identifier">including</span><span class="plain"> </span><span class="identifier">restoring</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">what</span><span class="plain"> </span><span class="identifier">they</span><span class="plain"> </span><span class="identifier">were</span><span class="plain"> </span><span class="identifier">before</span><span class="plain">)</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">transfer</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">routine</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setRomOrPhromAddress</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsSpareByteA</span><span class="plain">                                   ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">displacement</span><span class="plain"> </span><span class="identifier">pointer</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">romAddressLow</span><span class="plain">                                  ; </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">romAddressLow</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsSpareByteB</span><span class="plain">                                   ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">romAddressHigh</span><span class="plain">                                 ; </span><span class="identifier">And</span><span class="plain"> .</span><span class="identifier">romAddressHigh</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">currentLogicalSpeechPHROMOrROMFSNumber</span><span class="plain">         ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">PHROM</span><span class="plain">/</span><span class="identifier">RFS</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">exit26</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">selected</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">PHROM</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">writeAddressToSpeechProcessor</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">romAddressLow</span><span class="plain">                                  ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">writeTwoNybblesToSpeechProcessor</span><span class="plain">               ; </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">currentLogicalSpeechPHROMOrROMFSNumber</span><span class="plain">         ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; } .</span><span class="identifier">tempStoreFA</span><span class="plain"> = .</span><span class="identifier">currentLogicalSpeechPHROMOrROMFSNumber</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">romAddressHigh</span><span class="plain">                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; }</span>
        <span class="identifier">ROL</span><span class="plain">                                                 ; }</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; } </span><span class="identifier">replace</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">/</span><span class="identifier">PHROM</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; }</span>
        <span class="identifier">ROR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">writeTwoNybblesToSpeechProcessor</span><span class="plain">               ; </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; .</span><span class="identifier">tempStoreFA</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">remaining</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">/</span><span class="identifier">PHROM</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">writeLoadAddressCommandToSpeechProcessor</span><span class="plain">       ; </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">flags</span>
    <span class="plain">.</span><span class="identifier">exit26</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Return</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 16
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 16: </span><span class="identifier">Keyboard</span><span class="plain"> </span><span class="identifier">processing</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">moreKeyboardProcessing</span>
        <span class="identifier">LDX</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ;</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">most</span><span class="plain"> </span><span class="identifier">recently</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; </span><span class="identifier">OR</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">any</span><span class="plain"> </span><span class="identifier">presses</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">anything</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">forward</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #%10000001                                      ; </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> (</span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaInterruptEnableRegister</span><span class="plain">               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">enable</span><span class="plain"> </span><span class="reserved">register</span><span class="plain">)</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=0</span>
    <span class="plain">+</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">keyboardSemaphore</span><span class="plain">                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">semaphore</span>
                                                            <span class="plain">; (0 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">, 255 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">LEDs</span><span class="plain"> (</span><span class="identifier">Shift</span><span class="plain"> </span><span class="identifier">Lock</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Caps</span><span class="plain"> </span><span class="identifier">Lock</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain">:</span>
    <span class="plain">;       .</span><span class="identifier">keyboardStatusFlags</span><span class="plain"> </span><span class="identifier">contains</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> / </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">state</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">LEDs</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">contains</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">entry</span>
    <span class="plain">.</span><span class="identifier">keyboardIndicators</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">keyboardStatusFlags</span><span class="plain">                            ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span>
                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 4 = 0 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">Caps</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">engaged</span><span class="plain"> (</span><span class="identifier">c</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 5 = 0 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">engaged</span><span class="plain"> (</span><span class="identifier">s</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="identifier">A</span><span class="plain"> = %</span><span class="identifier">xxscxxxx</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain"> = %0</span><span class="identifier">xxscxxx</span>
        <span class="identifier">AND</span><span class="plain"> #%00011000                                      ; </span><span class="identifier">A</span><span class="plain"> = %000</span><span class="identifier">sc000</span>
        <span class="identifier">ORA</span><span class="plain"> #6                                              ; </span><span class="identifier">A</span><span class="plain"> = %000</span><span class="identifier">sc110</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">light</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain"> = %0000</span><span class="identifier">sc11</span>
        <span class="identifier">ORA</span><span class="plain"> #7                                              ; </span><span class="identifier">A</span><span class="plain"> = %0000</span><span class="identifier">s111</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">light</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">enableKeyboardScanning</span><span class="plain">                         ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">KEYV</span><span class="plain"> - </span><span class="identifier">Default</span><span class="plain"> </span><span class="identifier">main</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">handling</span><span class="plain"> </span><span class="identifier">routine</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;  </span><span class="identifier">Flags</span>
    <span class="plain">;   </span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">V</span>
    <span class="plain">;   0 0 - </span><span class="identifier">Test</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">keys</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">N</span><span class="plain">=1 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">=1 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">)</span>
    <span class="plain">;   1 0 - </span><span class="identifier">Scan</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> (</span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 121)</span>
    <span class="plain">;   0 1 - </span><span class="identifier">Key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">entry</span>
    <span class="plain">;   1 1 - </span><span class="identifier">Timer</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">entry</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyEntryPoint</span>
        <span class="identifier">BVC</span><span class="plain"> .</span><span class="identifier">keyVClear</span><span class="plain">                                      ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #1                                              ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaInterruptEnableRegister</span><span class="plain">               ; </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">vector</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">keyboardTimerInterrupt</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">timer</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">keyPressedInterrupt</span><span class="plain">                            ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">jump</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyVClear</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">keyTestSHIFTAndCTRL</span><span class="plain">                            ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">SHFT</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">scanKeyboard</span><span class="plain">                                   ; </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">keyboard</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyboardTimerInterrupt</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">keyboardSemaphore</span><span class="plain">                             ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">semaphore</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> 0)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Carry</span><span class="plain"> </span><span class="identifier">CLEAR</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">here</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">testing</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">keys</span>
    <span class="plain">;       </span><span class="identifier">Carry</span><span class="plain"> </span><span class="identifier">SET</span><span class="plain">   </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">timer</span><span class="plain"> </span><span class="identifier">interrupt</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">N</span><span class="plain">=1 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">;       </span><span class="identifier">V</span><span class="plain">=1 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyTestSHIFTAndCTRL</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">keyboardStatusFlags</span><span class="plain">                            ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span>
                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 3 = 1 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">pressed</span>
                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 4 = 0 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">Caps</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">engaged</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 5 = 0 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">engaged</span>
                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 6 = 1 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">pressed</span>
                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 7 = 1 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">enabled</span>
        <span class="identifier">AND</span><span class="plain"> #%10110111                                      ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 3 </span><span class="identifier">and</span><span class="plain"> 6</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">test</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">interrogateKeyboard</span><span class="plain">                            ; </span><span class="identifier">interrogate</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain">: </span><span class="identifier">X</span><span class="plain">=$80 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">CLV</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">V</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">testCTRL</span><span class="plain">                                       ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">press</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">allBitsSet</span><span class="plain">                                     ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">N</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">ORA</span><span class="plain"> #%00001000                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 3 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">indicate</span><span class="plain"> </span><span class="identifier">Shift</span><span class="plain"> </span><span class="identifier">was</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">.</span><span class="identifier">testCTRL</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; (</span><span class="identifier">X</span><span class="plain">=$01 </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=$81 </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">ignored</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> .</span><span class="identifier">interrogateKeyboard</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">interrogateKeyboard</span><span class="plain">                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> (</span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">)</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">keyboardIndicators</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">entered</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">just</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">testing</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">status</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
                                                            <span class="plain">;                        (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">lights</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">required</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">ORA</span><span class="plain"> #%01000000                                      ; </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">keyboardStatusFlags</span><span class="plain">                            ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">updated</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span>

        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">differentKey</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">previously</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">interrogateKeyboard</span><span class="plain">                            ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">still</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">repeatedKeyFound</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">enter</span><span class="plain"> </span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain">)</span>
        <span class="identifier">CPX</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">.</span><span class="identifier">storeLastKeyPressed</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">differentKey</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">different</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> (</span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; }</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; } </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>

    <span class="plain">.</span><span class="identifier">resetAutorepeatAndContinue</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">resetAutorepeatCounters</span><span class="plain">                        ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">.</span><span class="identifier">differentKey</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">keyboardRolloverChecks</span><span class="plain">                         ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">repeatedKeyFound</span>
        <span class="identifier">CPX</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">storeLastKeyPressed</span><span class="plain">                            ; </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">autorepeatCountdownTimer</span><span class="plain">                       ; </span><span class="identifier">get</span><span class="plain"> </span><span class="reserved">auto</span><span class="plain"> </span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">countdown</span><span class="plain"> </span><span class="identifier">timer</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">afterModifiers</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">autorepeatCountdownTimer</span><span class="plain">                       ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">decrement</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">afterModifiers</span><span class="plain">                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
                                                            <span class="plain">; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">either</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">dormant</span>
                                                            <span class="plain">; </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">count</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">keyboardFirstAutorepeatCount</span><span class="plain">                   ; </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">countdown</span><span class="plain"> </span><span class="identifier">timer</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">autorepeatCountdownTimer</span><span class="plain">                       ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">keyboardAutoRepeatRate</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="reserved">auto</span><span class="plain"> </span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">rate</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">keyboardAutoRepeatRate</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">keyboardFirstAutorepeatCount</span><span class="plain">                   ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">Countdown</span><span class="plain"> </span><span class="identifier">timer</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">keyboardStatusFlags</span><span class="plain">                            ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">CPX</span><span class="plain"> #$</span><span class="identifier">D0</span><span class="plain">                                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">testCapsLock</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="plain">; </span><span class="identifier">deal</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">.</span>
        <span class="plain">; </span><span class="identifier">Update</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain">.</span>
        <span class="identifier">ORA</span><span class="plain"> #%10010000                                      ; </span><span class="identifier">sets</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> (</span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain">, </span><span class="identifier">disengage</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">)</span>

                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 3 = 1 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">pressed</span>
                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 4 = 0 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">caps</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">engaged</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 5 = 0 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">engaged</span>
                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 6 = 1 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">pressed</span>
                                                            <span class="plain">; </span><span class="identifier">Bit</span><span class="plain"> 7 = 1 </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">enabled</span>

        <span class="identifier">EOR</span><span class="plain"> #%10100000                                      ; </span><span class="identifier">flip</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">flip</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">engaged</span>

    <span class="plain">.</span><span class="identifier">resetKeyboardStatusAndTimer</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">keyboardStatusFlags</span><span class="plain">                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">timer</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">autorepeatCountdownTimer</span><span class="plain">                       ; </span><span class="identifier">to</span><span class="plain"> 0</span>
    <span class="plain">.</span><span class="identifier">afterModifiers</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">keyboardRolloverChecks</span><span class="plain">                         ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">testCapsLock</span>
        <span class="identifier">CPX</span><span class="plain"> #$</span><span class="identifier">C0</span><span class="plain">                                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">getASCIICode</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">ORA</span><span class="plain"> #$</span><span class="identifier">A0</span><span class="plain">                                            ; </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">disengage</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">ORA</span><span class="plain"> #$10                                            ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">disengaged</span>
        <span class="identifier">EOR</span><span class="plain"> #$80                                            ; </span><span class="identifier">flip</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">enabled</span>
    <span class="plain">+</span>
        <span class="identifier">EOR</span><span class="plain"> #$90                                            ; </span><span class="identifier">reverse</span><span class="plain"> </span><span class="identifier">both</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">resetKeyboardStatusAndTimer</span><span class="plain">                    ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">timer</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">internal</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">WITH</span><span class="plain"> </span><span class="identifier">TOP</span><span class="plain"> </span><span class="identifier">BIT</span><span class="plain"> </span><span class="identifier">SET</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">internal</span><span class="plain"> </span><span class="identifier">numbers</span><span class="plain"> (</span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
    <span class="plain">;                                       </span><span class="identifier">column</span>
    <span class="plain">;        | 0           1      2       3       4       5       6       7       8       9</span>
    <span class="plain">;    ----+----------------------------------------------------------------------------------</span>
    <span class="plain">;    $80 | </span><span class="identifier">SHIFT</span><span class="plain">       </span><span class="identifier">CTRL</span><span class="plain">   </span><span class="identifier">bit</span><span class="plain"> 7   </span><span class="identifier">bit</span><span class="plain"> 6   </span><span class="identifier">bit</span><span class="plain"> 5   </span><span class="identifier">bit</span><span class="plain"> 4   </span><span class="identifier">bit</span><span class="plain"> 3   </span><span class="identifier">bit</span><span class="plain"> 2   </span><span class="identifier">bit</span><span class="plain"> 1   </span><span class="identifier">bit</span><span class="plain"> 0</span>
    <span class="plain">;    $90 | </span><span class="identifier">Q</span><span class="plain">           3      4       5       </span><span class="identifier">f4</span><span class="plain">      8       </span><span class="identifier">f7</span><span class="plain">      -       ^       </span><span class="identifier">LEFT</span>
    <span class="plain">; </span><span class="identifier">r</span><span class="plain">  $</span><span class="identifier">A0</span><span class="plain"> | </span><span class="identifier">f0</span><span class="plain">          </span><span class="identifier">W</span><span class="plain">      </span><span class="identifier">E</span><span class="plain">       </span><span class="identifier">T</span><span class="plain">       7       </span><span class="identifier">I</span><span class="plain">       9       0       </span><span class="identifier">_</span><span class="plain">       </span><span class="identifier">DOWN</span>
    <span class="plain">; </span><span class="identifier">o</span><span class="plain">  $</span><span class="identifier">B0</span><span class="plain"> | 1           2      </span><span class="identifier">D</span><span class="plain">       </span><span class="identifier">R</span><span class="plain">       6       </span><span class="identifier">U</span><span class="plain">       </span><span class="identifier">O</span><span class="plain">       </span><span class="identifier">P</span><span class="plain">       [       </span><span class="identifier">UP</span>
    <span class="plain">; </span><span class="identifier">w</span><span class="plain">  $</span><span class="identifier">C0</span><span class="plain"> | </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">   </span><span class="identifier">A</span><span class="plain">      </span><span class="identifier">X</span><span class="plain">       </span><span class="identifier">F</span><span class="plain">       </span><span class="identifier">Y</span><span class="plain">       </span><span class="identifier">J</span><span class="plain">       </span><span class="identifier">K</span><span class="plain">       @       :       </span><span class="identifier">RETURN</span>
    <span class="plain">;    $</span><span class="identifier">D0</span><span class="plain"> | </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">  </span><span class="identifier">S</span><span class="plain">      </span><span class="identifier">C</span><span class="plain">       </span><span class="identifier">G</span><span class="plain">       </span><span class="identifier">H</span><span class="plain">       </span><span class="identifier">N</span><span class="plain">       </span><span class="identifier">L</span><span class="plain">       ;       ]       </span><span class="identifier">DELETE</span>
    <span class="plain">;    $</span><span class="identifier">E0</span><span class="plain"> | </span><span class="identifier">TAB</span><span class="plain">         </span><span class="identifier">Z</span><span class="plain">      </span><span class="identifier">SPACE</span><span class="plain">   </span><span class="identifier">V</span><span class="plain">       </span><span class="identifier">B</span><span class="plain">       </span><span class="identifier">M</span><span class="plain">       ,       .       /       </span><span class="identifier">COPY</span>
    <span class="plain">;    $</span><span class="identifier">F0</span><span class="plain"> | </span><span class="identifier">ESCAPE</span><span class="plain">      </span><span class="identifier">f1</span><span class="plain">     </span><span class="identifier">f2</span><span class="plain">      </span><span class="identifier">f3</span><span class="plain">      </span><span class="identifier">f5</span><span class="plain">      </span><span class="identifier">f6</span><span class="plain">      </span><span class="identifier">f8</span><span class="plain">      </span><span class="identifier">f9</span><span class="plain">      \       </span><span class="identifier">RIGHT</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">getASCIICode</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">keyDataBlock1</span><span class="plain"> - $90,</span><span class="identifier">X</span><span class="plain">                          ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">look</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">tables</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> (</span><span class="identifier">TAB</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">TAB</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">asciiCodeGeneratedByTABKey</span><span class="plain">                     ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">TAB</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> (9 </span><span class="identifier">by</span><span class="plain"> </span><span class="reserved">default</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">keyboardStatusFlags</span><span class="plain">                            ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">status</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">storage</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">rotate</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">past</span><span class="plain"> </span><span class="identifier">CTRL</span><span class="plain"> </span><span class="identifier">processing</span><span class="plain">)</span>

        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">previously</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">key</span>
    <span class="plain">.</span><span class="identifier">localResetAutorepeatAndContinue</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">resetAutorepeatAndContinue</span><span class="plain">                     ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">autorepeat</span><span class="plain"> </span><span class="identifier">counters</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">implementCTRLCodes</span><span class="plain">                             ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">perform</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">changes</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">CTRL</span>
    <span class="plain">+</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">testCapsLockEngaged</span><span class="plain">                            ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">lock</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">processing</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">implementSHIFT</span><span class="plain">                                 ; </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">changes</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">SHIFT</span>

        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">testShiftEnabled</span><span class="plain">                               ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">testCapsLockEngaged</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">testShift</span><span class="plain">                                      ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">engaged</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">isLetter</span><span class="plain">                                       ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">changes</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain"> </span><span class="identifier">on</span><span class="plain">, </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">C</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">alphabetic</span><span class="plain"> </span><span class="identifier">codes</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">testShift</span><span class="plain">                                      ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">letter</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">implementSHIFT</span><span class="plain">                                 ; </span><span class="identifier">transform</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">letter</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">SHIFT</span>

    <span class="plain">.</span><span class="identifier">testShiftEnabled</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">keyboardStatusFlags</span><span class="plain">                            ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">clear</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">testESCAPEcode</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">disabled</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">testShift</span>
        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">tempStoreFA</span><span class="plain">                                    ; </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">testESCAPEcode</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">key</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">press</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">localResetAutorepeatAndContinue</span><span class="plain">                ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> 0) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">etc</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">implementSHIFT</span><span class="plain">                                 ; </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">changes</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">SHIFT</span>

    <span class="plain">.</span><span class="identifier">testESCAPEcode</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">asciiCodeThatGeneratesESCAPEAction</span><span class="plain">             ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">code</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">code</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">escapeAction</span><span class="plain">                                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">Escape</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">status</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">returns</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">code</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">autorepeatCountdownTimer</span><span class="plain">                       ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="reserved">auto</span><span class="plain">-</span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">countdown</span><span class="plain"> </span><span class="identifier">timer</span>
    <span class="plain">+</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">enableKeyboardScanningFlippingInterrupts</span><span class="plain">       ; </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">scanning</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">keyboardDisableFlag</span><span class="plain">                            ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">Keyboard</span><span class="plain"> </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">Econet</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">keyboardRolloverChecks</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">locked</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">insertByteIntoKeyboardBuffer</span><span class="plain">                   ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span>

    <span class="plain">+</span>
    <span class="plain">.</span><span class="identifier">keyboardRolloverChecks</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">keypress</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">none</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">interrogateKeyboard</span><span class="plain">                            ; </span><span class="identifier">examine</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">see</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">still</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">BMI</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; </span><span class="identifier">and</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span>
    <span class="plain">+</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">continueKeyProcessing</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> 0 </span><span class="reserved">goto</span><span class="plain"> </span><span class="identifier">F012</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">keypress</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearCarryKeyboardScan</span><span class="plain">                         ; </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> $10 (</span><span class="identifier">osbyte</span><span class="plain"> 122)</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">localMoreKeyboardProcessing</span><span class="plain">                    ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">the</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                        ; </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">rollover</span>

    <span class="plain">.</span><span class="identifier">storeKeyAndReset</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">resetAutorepeatCounters</span><span class="plain">                        ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">repeat</span><span class="plain"> </span><span class="identifier">delay</span>

    <span class="plain">.</span><span class="identifier">localMoreKeyboardProcessing</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">moreKeyboardProcessing</span><span class="plain">                        ; </span><span class="identifier">go</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">EEDA</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">key</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyPressedInterrupt</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">interrogateKeyboard</span><span class="plain">                            ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
    <span class="plain">.</span><span class="identifier">continueKeyProcessing</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">press</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">localMoreKeyboardProcessing</span><span class="plain">                    ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">none</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">housekeeping</span><span class="plain"> </span><span class="identifier">routine</span>
        <span class="identifier">LDY</span><span class="plain"> #.</span><span class="identifier">firstKeyPressedInternal</span><span class="plain">                       ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearCarryKeyboardScan</span><span class="plain">                         ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">keyboard</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">localMoreKeyboardProcessing</span><span class="plain">                    ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">housekeeping</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">storeKeyAndReset</span><span class="plain">                               ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">delay</span><span class="plain"> </span><span class="identifier">etc</span><span class="plain">)</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">resetAutorepeatCounters</span>
        <span class="identifier">LDX</span><span class="plain"> #1                                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">timer</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 1</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">autorepeatCountdownTimer</span><span class="plain">                       ;</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">keyboardAutorepeatDelay</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">timer</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">keyboardFirstAutorepeatCount</span><span class="plain">                   ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">keyboard</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">read</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = $80 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> (</span><span class="identifier">N</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
    <span class="plain">;           $00 </span><span class="identifier">otherwise</span><span class="plain"> (</span><span class="identifier">N</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">)</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">interrogateKeyboard</span>
        <span class="identifier">LDY</span><span class="plain"> #3                                              ; </span><span class="identifier">stop</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">scanning</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span>
        <span class="identifier">LDY</span><span class="plain"> #%01111111                                      ; </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7, </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 0 </span><span class="identifier">to</span><span class="plain"> 6</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">systemViaDataDirectionRegisterA</span><span class="plain">                ;</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">systemViaRegisterBNoHandshake</span><span class="plain">                  ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">Port</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">VIA</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">systemViaRegisterBNoHandshake</span><span class="plain">                  ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> $80 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> (</span><span class="identifier">N</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">internal</span><span class="plain"> </span><span class="identifier">numbers</span><span class="plain"> (</span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">)</span>
    <span class="plain">;                                       </span><span class="identifier">column</span>
    <span class="plain">;        | 0           1      2       3       4       5       6       7       8       9</span>
    <span class="plain">;    ----+----------------------------------------------------------------------------------</span>
    <span class="plain">;    $80 | </span><span class="identifier">SHIFT</span><span class="plain">       </span><span class="identifier">CTRL</span><span class="plain">   </span><span class="identifier">bit</span><span class="plain"> 7   </span><span class="identifier">bit</span><span class="plain"> 6   </span><span class="identifier">bit</span><span class="plain"> 5   </span><span class="identifier">bit</span><span class="plain"> 4   </span><span class="identifier">bit</span><span class="plain"> 3   </span><span class="identifier">bit</span><span class="plain"> 2   </span><span class="identifier">bit</span><span class="plain"> 1   </span><span class="identifier">bit</span><span class="plain"> 0</span>
    <span class="plain">;    $90 | </span><span class="identifier">Q</span><span class="plain">           3      4       5       </span><span class="identifier">f4</span><span class="plain">      8       </span><span class="identifier">f7</span><span class="plain">      -       ^       </span><span class="identifier">LEFT</span>
    <span class="plain">; </span><span class="identifier">r</span><span class="plain">  $</span><span class="identifier">A0</span><span class="plain"> | </span><span class="identifier">f0</span><span class="plain">          </span><span class="identifier">W</span><span class="plain">      </span><span class="identifier">E</span><span class="plain">       </span><span class="identifier">T</span><span class="plain">       7       </span><span class="identifier">I</span><span class="plain">       9       0       </span><span class="identifier">_</span><span class="plain">       </span><span class="identifier">DOWN</span>
    <span class="plain">; </span><span class="identifier">o</span><span class="plain">  $</span><span class="identifier">B0</span><span class="plain"> | 1           2      </span><span class="identifier">D</span><span class="plain">       </span><span class="identifier">R</span><span class="plain">       6       </span><span class="identifier">U</span><span class="plain">       </span><span class="identifier">O</span><span class="plain">       </span><span class="identifier">P</span><span class="plain">       [       </span><span class="identifier">UP</span>
    <span class="plain">; </span><span class="identifier">w</span><span class="plain">  $</span><span class="identifier">C0</span><span class="plain"> | </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">   </span><span class="identifier">A</span><span class="plain">      </span><span class="identifier">X</span><span class="plain">       </span><span class="identifier">F</span><span class="plain">       </span><span class="identifier">Y</span><span class="plain">       </span><span class="identifier">J</span><span class="plain">       </span><span class="identifier">K</span><span class="plain">       @       :       </span><span class="identifier">RETURN</span>
    <span class="plain">;    $</span><span class="identifier">D0</span><span class="plain"> | </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">  </span><span class="identifier">S</span><span class="plain">      </span><span class="identifier">C</span><span class="plain">       </span><span class="identifier">G</span><span class="plain">       </span><span class="identifier">H</span><span class="plain">       </span><span class="identifier">N</span><span class="plain">       </span><span class="identifier">L</span><span class="plain">       ;       ]       </span><span class="identifier">DELETE</span>
    <span class="plain">;    $</span><span class="identifier">E0</span><span class="plain"> | </span><span class="identifier">TAB</span><span class="plain">         </span><span class="identifier">Z</span><span class="plain">      </span><span class="identifier">SPACE</span><span class="plain">   </span><span class="identifier">V</span><span class="plain">       </span><span class="identifier">B</span><span class="plain">       </span><span class="identifier">M</span><span class="plain">       ,       .       /       </span><span class="identifier">COPY</span>
    <span class="plain">;    $</span><span class="identifier">F0</span><span class="plain"> | </span><span class="identifier">ESCAPE</span><span class="plain">      </span><span class="identifier">f1</span><span class="plain">     </span><span class="identifier">f2</span><span class="plain">      </span><span class="identifier">f3</span><span class="plain">      </span><span class="identifier">f5</span><span class="plain">      </span><span class="identifier">f6</span><span class="plain">      </span><span class="identifier">f8</span><span class="plain">      </span><span class="identifier">f9</span><span class="plain">      \       </span><span class="identifier">RIGHT</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">What</span><span class="plain"> </span><span class="identifier">follows</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 7 </span><span class="identifier">tables</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> 10 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">spaced</span><span class="plain"> 16 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">apart</span><span class="plain">, </span><span class="identifier">giving</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="character">'ASCII'</span>
    <span class="plain">; </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">codes</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">internal</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">row</span><span class="plain"> (</span><span class="identifier">interspersed</span><span class="plain"> </span><span class="identifier">with</span>
    <span class="plain">; </span><span class="identifier">unrelated</span><span class="plain"> </span><span class="identifier">code</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">keyDataBlock1</span>
        <span class="plain">;      </span><span class="identifier">q</span><span class="plain"> , 3 , 4 , 5 , </span><span class="identifier">f4</span><span class="plain">, 8 , </span><span class="identifier">f7</span><span class="plain">, - , ^ ,</span><span class="identifier">LEFT</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $71,$33,$34,$35,$84,$38,$87,$2</span><span class="identifier">D</span><span class="plain">,$5</span><span class="identifier">E</span><span class="plain">,$8</span><span class="identifier">C</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 120 - </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">data</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte120EntryPoint</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">lastKeyPressedInternal</span><span class="plain">                         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">latest</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">STX</span><span class="plain"> $</span><span class="identifier">ED</span><span class="plain">                                             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">unused</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyDataBlock2</span>
        <span class="plain">;      </span><span class="identifier">f0</span><span class="plain">, </span><span class="identifier">w</span><span class="plain"> , </span><span class="identifier">e</span><span class="plain"> , </span><span class="identifier">t</span><span class="plain"> , 7 , </span><span class="identifier">i</span><span class="plain"> , 9 , 0 , </span><span class="identifier">_</span><span class="plain"> ,</span><span class="identifier">DOWN</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $80,$77,$65,$74,$37,$69,$39,$30,$5</span><span class="identifier">F</span><span class="plain">,$8</span><span class="identifier">E</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">jimPagedEntryJumper</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">jimPagedEntryPoint</span><span class="plain">)                           ; </span><span class="identifier">Jim</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">vector</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyteJumper</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">tempStoreFA</span><span class="plain">)                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyDataBlock3</span>
        <span class="plain">;      1 , 2 , </span><span class="identifier">d</span><span class="plain"> , </span><span class="identifier">r</span><span class="plain"> , 6 , </span><span class="identifier">u</span><span class="plain"> , </span><span class="identifier">o</span><span class="plain"> , </span><span class="identifier">p</span><span class="plain"> , [ ,</span><span class="identifier">UP</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $31,$32,$64,$72,$36,$75,$6</span><span class="identifier">F</span><span class="plain">,$70,$5</span><span class="identifier">B</span><span class="plain">,$8</span><span class="identifier">F</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyboardInterruptRoutine</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">allBitsSet</span><span class="plain">                                    ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">N</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">flags</span>
    <span class="plain">.</span><span class="identifier">keyJumper</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorKEYV</span><span class="plain">)                                  ; </span><span class="identifier">i</span><span class="plain">.</span><span class="identifier">e</span><span class="plain">. </span><span class="identifier">KEYV</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyDataBlock4</span>
        <span class="plain">; </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">, </span><span class="identifier">a</span><span class="plain"> , </span><span class="identifier">x</span><span class="plain"> , </span><span class="identifier">f</span><span class="plain"> , </span><span class="identifier">y</span><span class="plain"> , </span><span class="identifier">j</span><span class="plain"> , </span><span class="identifier">k</span><span class="plain"> , @ , : ,</span><span class="identifier">RETURN</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain">   $01,$61,$78,$66,$79,$6</span><span class="identifier">A</span><span class="plain">,$6</span><span class="identifier">B</span><span class="plain">,$40,$3</span><span class="identifier">A</span><span class="plain">,$0</span><span class="identifier">D</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="identifier">when</span><span class="plain"> </span><span class="identifier">reading</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">speech</span><span class="plain"> </span><span class="identifier">processor</span>
    <span class="plain">.</span><span class="identifier">speechDataTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00,$</span><span class="identifier">FF</span><span class="plain">     ; </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">DDRA</span><span class="plain">       (8 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">Read</span><span class="plain"> / 8 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">Write</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $01,$02     ; </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">Register</span><span class="plain"> </span><span class="identifier">B</span><span class="plain"> (</span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">Speech</span><span class="plain"> / </span><span class="identifier">Enable</span><span class="plain"> </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">Speech</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $09,$0</span><span class="identifier">A</span><span class="plain">     ; </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">VIA</span><span class="plain"> </span><span class="identifier">Register</span><span class="plain"> </span><span class="identifier">B</span><span class="plain"> (</span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">Speech</span><span class="plain"> / </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">Speech</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyDataBlock5</span>
        <span class="plain">; </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">, </span><span class="identifier">s</span><span class="plain"> , </span><span class="identifier">c</span><span class="plain"> , </span><span class="identifier">g</span><span class="plain"> , </span><span class="identifier">h</span><span class="plain"> , </span><span class="identifier">n</span><span class="plain"> , </span><span class="identifier">l</span><span class="plain"> , ; , ] ,</span><span class="identifier">DELETE</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain">    $02,$73,$63,$67,$68,$6</span><span class="identifier">E</span><span class="plain">,$6</span><span class="identifier">C</span><span class="plain">,$3</span><span class="identifier">B</span><span class="plain">,$5</span><span class="identifier">D</span><span class="plain">,$7</span><span class="identifier">F</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 131 - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">OSHWM</span><span class="plain"> (</span><span class="identifier">PAGE</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte131EntryPoint</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">currentPAGE</span><span class="plain">                                    ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OSHWM</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ;</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyDataBlock6</span>
        <span class="plain">;      </span><span class="identifier">TAB</span><span class="plain">, </span><span class="identifier">Z</span><span class="plain"> ,</span><span class="identifier">SPACE</span><span class="plain">, </span><span class="identifier">V</span><span class="plain"> , </span><span class="identifier">b</span><span class="plain"> , </span><span class="identifier">m</span><span class="plain"> , , , . , / ,</span><span class="identifier">COPY</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain">  $00,$7</span><span class="identifier">A</span><span class="plain">,$20  ,$76,$62,$6</span><span class="identifier">D</span><span class="plain">,$2</span><span class="identifier">C</span><span class="plain">,$2</span><span class="identifier">E</span><span class="plain">,$2</span><span class="identifier">F</span><span class="plain">,$8</span><span class="identifier">B</span>
        <span class="plain">; </span><span class="identifier">NOTE</span><span class="plain">: </span><span class="identifier">TAB</span><span class="plain"> </span><span class="identifier">returns</span><span class="plain"> 0, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">handled</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">special</span><span class="plain"> </span><span class="reserved">case</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">code</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">flushCurrentInputBuffer</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">currentInputBuffer</span><span class="plain">                             ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span>
    <span class="plain">.</span><span class="identifier">flushBufferXJumper</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">flushBufferX</span><span class="plain">                                   ; </span><span class="identifier">flush</span><span class="plain"> </span><span class="identifier">it</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">keyDataBlock7</span>
        <span class="plain">;      </span><span class="identifier">ESC</span><span class="plain">, </span><span class="identifier">f1</span><span class="plain">, </span><span class="identifier">f2</span><span class="plain">, </span><span class="identifier">f3</span><span class="plain">, </span><span class="identifier">f5</span><span class="plain">, </span><span class="identifier">f6</span><span class="plain">, </span><span class="identifier">f8</span><span class="plain">, </span><span class="identifier">f9</span><span class="plain">, \ ,</span><span class="identifier">RIGHT</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain">  $1</span><span class="identifier">B</span><span class="plain">,$81,$82,$83,$85,$86,$88,$89,$5</span><span class="identifier">C</span><span class="plain">,$8</span><span class="identifier">D</span>

    <span class="plain">.</span><span class="identifier">eventJumper</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorEVNTV</span><span class="plain">)                                  ; </span><span class="reserved">goto</span><span class="plain"> </span><span class="identifier">eventV</span><span class="plain"> </span><span class="identifier">handling</span><span class="plain"> </span><span class="identifier">routine</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 15 - </span><span class="identifier">Flush</span><span class="plain"> </span><span class="identifier">selected</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">class</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = 0       </span><span class="identifier">flush</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">buffers</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> != 0      </span><span class="identifier">flush</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte15EntryPoint</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">flushCurrentInputBuffer</span><span class="plain">                        ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">flush</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">only</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">flushAllBuffers</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">bufferNumberHighest</span><span class="plain">                           ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">highest</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (8)</span>
    <span class="plain">-</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">briefly</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte21EntryPoint</span><span class="plain">                             ; </span><span class="identifier">flush</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">&gt;=0 </span><span class="identifier">flush</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">... (</span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=255)</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 21 - </span><span class="identifier">Flush</span><span class="plain"> </span><span class="identifier">specific</span><span class="plain"> </span><span class="identifier">buffer</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">number</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte21EntryPoint</span>
        <span class="identifier">CPX</span><span class="plain"> #.</span><span class="identifier">bufferNumberHighest</span><span class="plain"> + 1                       ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">against</span><span class="plain"> </span><span class="identifier">largest</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">flushBufferXJumper</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">&lt;9 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">flush</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">)</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; *</span><span class="identifier">HELP</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">starHelp</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallHelp</span><span class="plain">                            ; } </span><span class="identifier">Issue</span><span class="plain"> *</span><span class="identifier">HELP</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">request</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">paged</span><span class="plain"> </span><span class="identifier">ROMs</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte143EntryPoint</span><span class="plain">                            ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printFollowingMessage</span><span class="plain">                          ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">routine</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> .</span><span class="identifier">charRETURN</span><span class="plain">                                   ; </span><span class="identifier">Carriage</span><span class="plain"> </span><span class="reserved">return</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"OS 1.20"</span><span class="plain">                                     ;</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> .</span><span class="identifier">charRETURN</span><span class="plain">                                   ; </span><span class="identifier">Carriage</span><span class="plain"> </span><span class="reserved">return</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $00                                           ; </span><span class="identifier">terminator</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> = $</span><span class="identifier">EE</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">similar</span>
    <span class="plain">.</span><span class="identifier">clearCarryKeyboardScan</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="plain">; </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 122 - </span><span class="identifier">Keyboard</span><span class="plain"> </span><span class="identifier">Scan</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> 16 </span><span class="identifier">decimal</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte122EntryPoint</span>
        <span class="identifier">LDX</span><span class="plain"> #16                                             ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 16</span>
        <span class="plain">; </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 121 - </span><span class="identifier">Keyboard</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte121EntryPoint</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">keyJumper</span><span class="plain">                                      ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 121 </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 122 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain">.</span>
                                                            <span class="plain">; </span><span class="identifier">We</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">through</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">KEYV</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">keyEntryPoint</span><span class="plain">.</span>
                                                            <span class="plain">; (</span><span class="identifier">Assuming</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">place</span><span class="plain">. </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span>
                                                            <span class="plain">; </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">will</span><span class="plain"> </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">scanKeyboard</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
                                                            <span class="plain">; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> .</span><span class="identifier">clearCarryKeyboardScan</span><span class="plain"> </span><span class="identifier">above</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">is</span>
                                                            <span class="plain">; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> (</span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">positive</span><span class="plain">)</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">specific</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> (</span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">negative</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">;       </span><span class="identifier">Carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">OSBYTE</span>
    <span class="plain">;        </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> .</span><span class="identifier">clearCarryKeyboardScan</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">internal</span><span class="plain"> </span><span class="identifier">numbers</span><span class="plain"> (</span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain">)</span>
    <span class="plain">;                                       </span><span class="identifier">column</span>
    <span class="plain">;        | 0           1      2       3       4       5       6       7       8       9</span>
    <span class="plain">;    ----+----------------------------------------------------------------------------------</span>
    <span class="plain">;    $00 | </span><span class="identifier">SHIFT</span><span class="plain">       </span><span class="identifier">CTRL</span><span class="plain">   </span><span class="identifier">bit</span><span class="plain"> 7   </span><span class="identifier">bit</span><span class="plain"> 6   </span><span class="identifier">bit</span><span class="plain"> 5   </span><span class="identifier">bit</span><span class="plain"> 4   </span><span class="identifier">bit</span><span class="plain"> 3   </span><span class="identifier">bit</span><span class="plain"> 2   </span><span class="identifier">bit</span><span class="plain"> 1   </span><span class="identifier">bit</span><span class="plain"> 0</span>
    <span class="plain">;    $10 | </span><span class="identifier">Q</span><span class="plain">           3      4       5       </span><span class="identifier">f4</span><span class="plain">      8       </span><span class="identifier">f7</span><span class="plain">      -       ^       </span><span class="identifier">LEFT</span>
    <span class="plain">; </span><span class="identifier">r</span><span class="plain">  $20 | </span><span class="identifier">f0</span><span class="plain">          </span><span class="identifier">W</span><span class="plain">      </span><span class="identifier">E</span><span class="plain">       </span><span class="identifier">T</span><span class="plain">       7       </span><span class="identifier">I</span><span class="plain">       9       0       </span><span class="identifier">_</span><span class="plain">       </span><span class="identifier">DOWN</span>
    <span class="plain">; </span><span class="identifier">o</span><span class="plain">  $30 | 1           2      </span><span class="identifier">D</span><span class="plain">       </span><span class="identifier">R</span><span class="plain">       6       </span><span class="identifier">U</span><span class="plain">       </span><span class="identifier">O</span><span class="plain">       </span><span class="identifier">P</span><span class="plain">       [       </span><span class="identifier">UP</span>
    <span class="plain">; </span><span class="identifier">w</span><span class="plain">  $40 | </span><span class="identifier">CAPS</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">   </span><span class="identifier">A</span><span class="plain">      </span><span class="identifier">X</span><span class="plain">       </span><span class="identifier">F</span><span class="plain">       </span><span class="identifier">Y</span><span class="plain">       </span><span class="identifier">J</span><span class="plain">       </span><span class="identifier">K</span><span class="plain">       @       :       </span><span class="identifier">RETURN</span>
    <span class="plain">;    $50 | </span><span class="identifier">SHIFT</span><span class="plain"> </span><span class="identifier">LOCK</span><span class="plain">  </span><span class="identifier">S</span><span class="plain">      </span><span class="identifier">C</span><span class="plain">       </span><span class="identifier">G</span><span class="plain">       </span><span class="identifier">H</span><span class="plain">       </span><span class="identifier">N</span><span class="plain">       </span><span class="identifier">L</span><span class="plain">       ;       ]       </span><span class="identifier">DELETE</span>
    <span class="plain">;    $60 | </span><span class="identifier">TAB</span><span class="plain">         </span><span class="identifier">Z</span><span class="plain">      </span><span class="identifier">SPACE</span><span class="plain">   </span><span class="identifier">V</span><span class="plain">       </span><span class="identifier">B</span><span class="plain">       </span><span class="identifier">M</span><span class="plain">       ,       .       /       </span><span class="identifier">COPY</span>
    <span class="plain">;    $70 | </span><span class="identifier">ESCAPE</span><span class="plain">      </span><span class="identifier">f1</span><span class="plain">     </span><span class="identifier">f2</span><span class="plain">      </span><span class="identifier">f3</span><span class="plain">      </span><span class="identifier">f5</span><span class="plain">      </span><span class="identifier">f6</span><span class="plain">      </span><span class="identifier">f8</span><span class="plain">      </span><span class="identifier">f9</span><span class="plain">      \       </span><span class="identifier">RIGHT</span>
    <span class="plain">;</span>
    <span class="plain">;         (</span><span class="character">'bit n'</span><span class="plain"> </span><span class="identifier">refers</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">DIP</span><span class="plain"> </span><span class="identifier">switches</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">scanKeyboard</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">positive</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">interrogateKeyboard</span><span class="plain">                            ; </span><span class="identifier">interrogate</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">specific</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">enableKeyboardScanning</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">OSBYTE</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">finish</span><span class="plain"> </span><span class="identifier">up</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">remember</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain">, </span><span class="identifier">whether</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain">)</span>
        <span class="identifier">BCC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">was</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> .</span><span class="identifier">clearCarryKeyboardScan</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">LDY</span><span class="plain"> #$</span><span class="identifier">EE</span><span class="plain">                                            ; </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">was</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain">. </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">operation</span><span class="plain"> </span><span class="identifier">saves</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $02</span><span class="identifier">CD</span>
    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">keyboardWorkspaceA</span><span class="plain">-.</span><span class="identifier">keyPressedInternalTable</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">  ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">possible</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (</span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> $02</span><span class="identifier">CB</span><span class="plain">, $02</span><span class="identifier">CC</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> $02</span><span class="identifier">CD</span><span class="plain">)</span>
        <span class="identifier">LDX</span><span class="plain"> #9                                              ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain">: </span><span class="identifier">from</span><span class="plain"> 9 </span><span class="identifier">to</span><span class="plain"> 0 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">select</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">column</span>

    <span class="plain">.</span><span class="identifier">loopKeyboardColumn</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">enableKeyboardScanningFlippingInterrupts</span><span class="plain">       ; </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">scanning</span>
        <span class="identifier">LDA</span><span class="plain"> #%01111111                                      ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaDataDirectionRegisterA</span><span class="plain">                ; } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">port</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 (</span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">others</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain">)</span>

        <span class="identifier">LDA</span><span class="plain"> #3                                              ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                             ; } </span><span class="identifier">stop</span><span class="plain"> </span><span class="reserved">auto</span><span class="plain"> </span><span class="identifier">scanning</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">keyboard</span>

        <span class="identifier">LDA</span><span class="plain"> #15                                             ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterBNoHandshake</span><span class="plain">                  ; } </span><span class="identifier">select</span><span class="plain"> </span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">existent</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">column</span><span class="plain"> 15 (0-9 </span><span class="identifier">only</span><span class="plain">!)</span>

        <span class="identifier">LDA</span><span class="plain"> #1                                              ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaInterruptFlagRegister</span><span class="plain">                 ; } </span><span class="identifier">cancel</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">interrupt</span>

        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">systemViaRegisterBNoHandshake</span><span class="plain">                  ; } </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">column</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> (9 </span><span class="identifier">max</span><span class="plain"> -&gt; 0 </span><span class="identifier">min</span><span class="plain">)</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">systemViaInterruptFlagRegister</span><span class="plain">                 ; }</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">tryNextKeyboardColumn</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">there</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">column</span><span class="plain">) </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">column</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (= </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">internal</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">column</span><span class="plain">) </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span>

    <span class="plain">.</span><span class="identifier">loopKeyboard</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">keyboardWorkspaceA</span><span class="plain">-.</span><span class="identifier">keyPressedInternalTable</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">  ; </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">possible</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">tryNextKey</span><span class="plain">                                     ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">too</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterBNoHandshake</span><span class="plain">                  ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">test</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">systemViaRegisterBNoHandshake</span><span class="plain">                  ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">tryNextKey</span><span class="plain">                                     ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> (</span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">. </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain">)</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ;</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">finishKeyboardScanning</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">finished</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">Push</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">)</span>
        <span class="identifier">EOR</span><span class="plain"> $0000,</span><span class="identifier">Y</span><span class="plain">                                         ; </span><span class="identifier">EOR</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain"> (</span><span class="identifier">in</span><span class="plain"> $</span><span class="identifier">EC</span><span class="plain">,$</span><span class="identifier">ED</span><span class="plain">, </span><span class="identifier">or</span><span class="plain"> $</span><span class="identifier">EE</span><span class="plain"> </span><span class="identifier">depending</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">value</span><span class="plain">)</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #1                                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">Pull</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> (</span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">)</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">finishKeyboardScanning</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">same</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">previous</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">pressed</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
    <span class="plain">.</span><span class="identifier">tryNextKey</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; }</span>
        <span class="identifier">ADC</span><span class="plain"> #16                                             ; } </span><span class="identifier">add</span><span class="plain"> 16 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">key</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">row</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">loopKeyboard</span><span class="plain">                                   ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> 0 &lt;= </span><span class="identifier">key</span><span class="plain"> &lt; 128</span>

    <span class="plain">.</span><span class="identifier">tryNextKeyboardColumn</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">loopKeyboardColumn</span><span class="plain">                             ; </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">greater</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> 0</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ;</span>
    <span class="plain">.</span><span class="identifier">finishKeyboardScanning</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ;</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">enableKeyboardScanningFlippingInterrupts</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">enableKeyboardScanning</span><span class="plain">                         ; </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">keyboard</span><span class="plain"> </span><span class="identifier">scanning</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">briefly</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">enableKeyboardScanning</span>
        <span class="identifier">LDA</span><span class="plain"> #11                                            ; </span><span class="identifier">select</span><span class="plain"> </span><span class="reserved">auto</span><span class="plain"> </span><span class="identifier">scan</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">keyboard</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">systemViaRegisterB</span><span class="plain">                            ; </span><span class="identifier">tell</span><span class="plain"> </span><span class="identifier">VIA</span>
        <span class="identifier">TXA</span><span class="plain">                                                ; </span><span class="identifier">X</span><span class="plain"> = 11</span>
        <span class="identifier">RTS</span><span class="plain">                                                ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 140 - </span><span class="identifier">select</span><span class="plain"> </span><span class="identifier">TAPE</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 141 - </span><span class="identifier">select</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">system</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte140EntryPoint</span>
    <span class="plain">.</span><span class="identifier">osbyte141EntryPoint</span>
        <span class="identifier">EOR</span><span class="plain"> #140                                           ; *</span><span class="identifier">TAPE</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=0; *</span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=1</span>
    <span class="plain">.</span><span class="identifier">setTapeOrRomFS</span>
        <span class="identifier">ASL</span><span class="plain">                                                ; </span><span class="reserved">double</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                               ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">CPX</span><span class="plain"> #3                                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=3 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">Z</span><span class="plain"> (300 </span><span class="identifier">baud</span><span class="plain">)</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">setupTapeBaudRate</span><span class="plain">                             ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Setup</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">options</span><span class="plain">. </span><span class="identifier">Called</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">power</span><span class="plain"> </span><span class="identifier">on</span><span class="plain">, </span><span class="identifier">hard</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">soft</span><span class="plain"> </span><span class="identifier">BREAK</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">LOAD</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">SAVE</span><span class="plain"> </span><span class="identifier">operations</span>
    <span class="plain">; </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">sequential</span><span class="plain"> </span><span class="identifier">access</span>

    <span class="plain">; 0000   </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">errors</span><span class="plain">,          </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 0001   </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">,         </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 0010   </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">,      </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1000   </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">            </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1001   </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">          </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1010   </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">       </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1100   </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">            </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1101   </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">          </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1110   </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">       </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> 1200 </span><span class="identifier">baud</span>
    <span class="plain">;       </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> 300 </span><span class="identifier">baud</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setupTapeOptions</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">LDA</span><span class="plain"> #%10100001                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">sequential</span><span class="plain"> </span><span class="identifier">access</span><span class="plain"> </span><span class="identifier">abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">, </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeOptionsByte</span><span class="plain">                                ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">load</span><span class="plain">/</span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">retry</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">, </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
        <span class="identifier">LDA</span><span class="plain"> #25                                             ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">interblock</span><span class="plain"> </span><span class="identifier">gap</span><span class="plain"> (2.5 </span><span class="identifier">seconds</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeInterBlockGap</span><span class="plain">                              ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> 300 </span><span class="identifier">baud</span>
    <span class="plain">;       </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> 1200 </span><span class="identifier">baud</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setupTapeBaudRate</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">LDA</span><span class="plain"> #6                                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">files</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">FSCV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">passToCurrentFilingSystem</span><span class="plain">                      ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">FSCV</span>
        <span class="identifier">LDX</span><span class="plain"> #6                                              ;</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Z</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">earlier</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">decrement</span><span class="plain"> </span><span class="identifier">X</span>
    <span class="plain">+</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tapeBaudRate</span><span class="plain">                                   ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">baud</span><span class="plain"> </span><span class="identifier">rate</span><span class="plain">: </span><span class="identifier">X</span><span class="plain">=5 </span><span class="identifier">means</span><span class="plain"> 1200 </span><span class="identifier">baud</span><span class="plain">; </span><span class="identifier">X</span><span class="plain">=6 </span><span class="identifier">means</span><span class="plain"> 300 </span><span class="identifier">baud</span>


        <span class="plain">; </span><span class="identifier">Reset</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">based</span><span class="plain"> </span><span class="identifier">vectors</span><span class="plain"> (</span><span class="identifier">FILEV</span><span class="plain">; </span><span class="identifier">ARGSV</span><span class="plain">; </span><span class="identifier">BGETV</span><span class="plain">; </span><span class="identifier">BPUTV</span><span class="plain">; </span><span class="identifier">GBPBV</span><span class="plain">; </span><span class="identifier">FINDV</span><span class="plain">; </span><span class="identifier">FSCV</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">values</span>
        <span class="identifier">LDX</span><span class="plain"> #14                                             ; </span><span class="identifier">Loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">defaultFileVectorEntry</span><span class="plain"> - 1,</span><span class="identifier">X</span><span class="plain">                   ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">vectorFILEV</span><span class="plain"> - 1,</span><span class="identifier">X</span><span class="plain">                              ; } </span><span class="identifier">Reset</span><span class="plain"> </span><span class="identifier">vectors</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">related</span><span class="plain"> </span><span class="identifier">operations</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; }</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; }</span>

        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tapeProgressState</span><span class="plain">                              ; </span><span class="identifier">progress</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> = 0</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">romServiceCallVectorsClaimed</span><span class="plain">                  ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">call</span><span class="plain"> </span><span class="character">'Vectors Claimed'</span>
                                                            <span class="plain">; </span><span class="identifier">used</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">overwrites</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">vectors</span><span class="plain">.</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 143 - </span><span class="identifier">Pass</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">commands</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">sideways</span><span class="plain"> </span><span class="identifier">ROMs</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">number</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">zero</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">chooses</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">call</span><span class="plain">; </span><span class="identifier">or</span><span class="plain"> 255 </span><span class="identifier">otherwise</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">result</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">ROM</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte143EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">Rom</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDX</span><span class="plain"> #15                                             ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=15</span>
                                                            <span class="plain">; </span><span class="identifier">send</span><span class="plain"> </span><span class="identifier">commands</span><span class="plain"> </span><span class="identifier">loop</span>
    <span class="plain">-</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">romTypeTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                 ; } </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">type</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">romTypeTable</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                 ; } </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">indicates</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">routine</span>
                                                            <span class="plain">;   (</span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">user</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">except</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain"> </span><span class="identifier">should</span><span class="plain"> </span><span class="identifier">have</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain">)</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">skips</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">BASIC</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">)</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">romSelectRegister</span><span class="plain">                              ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">map</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">romServiceEntry</span><span class="plain">                                ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">service</span><span class="plain"> </span><span class="identifier">entry</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">romChecksFinished</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> (</span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">recognised</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">selection</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="identifier">rom</span>
    <span class="plain">+</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ;</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">go</span><span class="plain"> </span><span class="identifier">round</span><span class="plain"> </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">again</span>

    <span class="plain">.</span><span class="identifier">romChecksFinished</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">Rom</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">Ram</span><span class="plain"> </span><span class="identifier">copy</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">romSelectRegister</span><span class="plain">                              ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">map</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSARGS</span><span class="plain"> - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">file</span><span class="character">'s attributes</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       In this default implementation, we only need to cover TAPE and ROM filing systems.</span>
    <span class="character">;       We only implement A=0,Y=0, which returns the filing system number in A.</span>
    <span class="character">; On Exit:</span>
    <span class="character">;       A = 0   no filing system present</span>
    <span class="character">;       A = 1   1200 baud tape filing system</span>
    <span class="character">;       A = 2   300 baud tape filing system</span>
    <span class="character">;       A = 3   ROM filing system</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osargsEntryPoint</span>
        <span class="character">ORA #0                                              ;</span>
        <span class="character">BNE .exit27                                         ; if A!=0 then branch (return)</span>
        <span class="character">CPY #0                                              ;</span>
        <span class="character">BNE .exit27                                         ; if Y!=0 then branch (return)</span>
        <span class="character">LDA .tapeBaudRate                                   ; get current baud rate</span>
                                                            <span class="character">; 5 for 1200 baud</span>
                                                            <span class="character">; 6 for 300 baud</span>
        <span class="character">AND #$FB                                            ; 5 becomes 1, 6 becomes 2</span>
                                                            <span class="character">; this next part sets A=3 if ROM selected</span>
        <span class="character">ORA .tapeOrRomSwitch                                ; if cassette selected A=0 else A=2</span>
        <span class="character">ASL                                                 ; multiply by 2</span>
        <span class="character">ORA .tapeOrRomSwitch                                ; OR it again</span>
        <span class="character">LSR                                                 ; divide by 2</span>
    <span class="character">.exit27</span>
        <span class="character">RTS                                                 ;</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
</pre>

<p class="inwebparagraph">Chapter 17
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 17: </span><span class="identifier">More</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">routines</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">fileSystemVectorTable</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">starOptEntryPoint</span><span class="plain"> - 1                        ; *</span><span class="identifier">OPT</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">checkEOFEntryPoint</span><span class="plain"> - 1                       ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">EOF</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">starRunEntryPoint</span><span class="plain"> - 1                        ; */</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">badCommandError</span><span class="plain"> - 1                          ; </span><span class="character">'Bad command'</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">roms</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">FS</span><span class="plain"> </span><span class="identifier">don</span><span class="character">'t want it</span>
        <span class="character">!word .starRunEntryPoint - 1                        ; *RUN</span>
        <span class="character">!word .starCatEntryPoint - 1                        ; *CAT</span>
        <span class="character">!word .osbyte119EntryPoint - 1                      ; osbyte 119 (close SPOOL and EXEC files, to get ready for a new FS)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; FSC</span>
    <span class="character">; On Entry</span>
    <span class="character">;     A is reason code. Only values 0-6 are handled:</span>
    <span class="character">;</span>
    <span class="character">;         A=0    A *OPT command has been issued. X and Y are the 2 parameters</span>
    <span class="character">;         A=1    EOF is being checked. On Entry: X=File handle On Exit: X=FF means EOF else 00</span>
    <span class="character">;         A=2    A */ command has been issued. *RUN the file</span>
    <span class="character">;         A=3    An unrecognised OS command has been issued. X,Y point at command</span>
    <span class="character">;         A=4    A *RUN command has been issued X,Y point at filename</span>
    <span class="character">;         A=5    A *CAT cammand has been issued X,Y point to rest of command</span>
    <span class="character">;         A=6    New filing system is about to take over. Close *SPOOL and *EXEC files</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.fscEntryPoint</span>
        <span class="character">CMP #7                                              ; }</span>
        <span class="character">BCS .exit27                                         ; } if A&gt;=7 then return</span>
        <span class="character">STX .fsTempStorage                                  ; save X</span>
        <span class="character">ASL                                                 ; A=A*2</span>
        <span class="character">TAX                                                 ; X=A to get offset</span>
        <span class="character">LDA .fileSystemVectorTable + 1,X                    ; get high byte of address</span>
        <span class="character">PHA                                                 ; push it</span>
        <span class="character">LDA .fileSystemVectorTable,X                        ; get low byte of address</span>
        <span class="character">PHA                                                 ; push it</span>
        <span class="character">LDX .fsTempStorage                                  ; restore X</span>
        <span class="character">RTS                                                 ; this now jumps to the address got from the table +1</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.loadFile</span>
        <span class="character">PHP                                                 ; save flags on stack</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">JSR .claimSerialSystemForLoadSave                   ; claim serial system for cassette</span>
        <span class="character">LDA .fsExecutionAddressLow                          ; execution address low</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">JSR .searchForFile                                  ; search for file</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">BEQ .checkFileAttributes                            ; if A=0 then branch</span>
        <span class="character">LDX #3                                              ; X= loop counter</span>
        <span class="character">LDA #$FF                                            ; A=$FF</span>
    <span class="character">-</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">LDA .fsLoadAddressLow,X                             ; get load address</span>
        <span class="character">STA .loadAddressLow,X                               ; store it as current load address</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">AND .loadAddressLow,X                               ;</span>
        <span class="character">DEX                                                 ; X=X-1</span>
        <span class="character">BPL -                                               ; until all 4 bytes copied</span>

        <span class="character">CMP #$FF                                            ; check if all the bytes of the load address are $FF</span>
        <span class="character">BNE .checkFileAttributes                            ; if (address is valid) then branch (continue)</span>
        <span class="character">JSR .beepAndCancelTapeOperation                     ; else sound bell, reset ACIA and motor off</span>
        <span class="character">JMP .brkBadAddress                                  ; show '</span><span class="identifier">Bad</span><span class="plain"> </span><span class="identifier">address</span><span class="character">' error</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">+</span>
    <span class="character">.checkFileAttributes</span>
        <span class="character">LDA .fsBlockFlagByte                               ; block flag</span>
        <span class="character">LSR                                                ; set carry from bit 0 (file locked)</span>
        <span class="character">PLA                                                ; get back A</span>
        <span class="character">BEQ .checkAndSetEscapeEffect                       ; if A=0 then branch (entry is from star run)</span>
        <span class="character">BCC .loadOrRun                                     ; if carry clear (not locked) then branch</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.fileLocked</span>
        <span class="character">JSR .cancelTapeOperation                            ;</span>

        <span class="character">BRK                                                 ;</span>
        <span class="character">!byte $D5                                           ; error number</span>
        <span class="character">!text "Locked",0                                    ; '</span><span class="identifier">Locked</span><span class="character">' error message and zero terminator</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.checkAndSetEscapeEffect</span>
        <span class="character">BCC .loadOrRun                                      ; if carry clear then branch (load)</span>
        <span class="character">LDA #3                                              ; A=3</span>
        <span class="character">STA .escapeAndBreakEffect                           ; store to cause ESCAPE disable and memory clear on break</span>

    <span class="character">.loadOrRun</span>
        <span class="character">LDA #%00110000                                      ; check bits 4 and 5</span>
                                                            <span class="character">; Options are stored in top four bits</span>
                                                            <span class="character">;   bit 4 = Abort bit</span>
                                                            <span class="character">;   bit 5 = Retry bit</span>
                                                            <span class="character">;   bit 6 } Message type: 00 = no messages</span>
                                                            <span class="character">;   bit 7 }             : 10 = short messages</span>
                                                            <span class="character">;         }             : 11 = long messages</span>
                                                            <span class="character">;</span>
                                                            <span class="character">; 0000 0000    Ignore errors         no messages</span>
                                                            <span class="character">; 0001 0000    Abort if error        no messages</span>
                                                            <span class="character">; 0010 0000    Retry after error     no messages</span>
                                                            <span class="character">; 1000 0000    Ignore error          short messages</span>
                                                            <span class="character">; 1001 0000    Abort if error        short messages</span>
                                                            <span class="character">; 1010 0000    Retry after error     short messages</span>
                                                            <span class="character">; 1100 0000    Ignore error          long messages</span>
                                                            <span class="character">; 1101 0000    Abort if error        long messages</span>
                                                            <span class="character">; 1110 0000    Retry after error     long messages</span>

        <span class="character">AND .tapeCurrentOptionsByte                         ; check bits 4 and 5 of current OPTions</span>
        <span class="character">BEQ +                                               ; if (ignore errors) then branch</span>
        <span class="character">LDA .checksumResult                                 ; get checksum result</span>
        <span class="character">BNE .checksumFail                                   ; if (checksum failed) then branch</span>
    <span class="character">+</span>
        <span class="character">TYA                                                 ; A=Y</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">JSR .startSendToSecondProcessor                     ; send to second processor if present</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">TAY                                                 ; Y=A</span>
        <span class="character">JSR .resetFSState                                   ; reset state</span>
    <span class="character">.checksumFail</span>
        <span class="character">JSR .loadFileFromTape                               ; load file from tape</span>
        <span class="character">BNE .retryAfterFailure                              ; if not found return to search</span>
        <span class="character">JSR .incrementBlockNumber                           ; increment current block number</span>

    <span class="character">+</span>
        <span class="character">BIT .fsBlockFlagByte                               ; block flag</span>
        <span class="character">BMI .reachedFinalBlock                             ; if bit 7 set (this is the final block) then branch</span>
        <span class="character">JSR .incrementLoadAddress                          ; else increment current load address</span>
        <span class="character">JSR .readBlockHeader                               ; read block header</span>
        <span class="character">BNE .loadOrRun                                     ; if (non zero) then branch (loop back)</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Store tape file length (low/high) and two zeros</span>
    <span class="character">.reachedFinalBlock</span>
        <span class="character">LDY #10                                             ; Y=10</span>
        <span class="character">LDA .tapeFileLengthLow                              ; file length counter low</span>
        <span class="character">STA (.osfileBlockAddressLow),Y                      ; OSFILE parameter block</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">LDA .tapeFileLengthHigh                             ; file length counter high</span>
        <span class="character">STA (.osfileBlockAddressLow),Y                      ; OSFILE parameter block</span>
        <span class="character">LDA #0                                              ; A=0</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">STA (.osfileBlockAddressLow),Y                      ; OSFILE parameter block</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">STA (.osfileBlockAddressLow),Y                      ; OSFILE parameter block</span>
        <span class="character">PLP                                                 ; get back flags</span>

    <span class="character">.beepCancelAndPrintReturn</span>
        <span class="character">JSR .beepAndCancelTapeOperation                     ; bell, reset ACIA and motor</span>

    <span class="character">.printReturnSafely</span>
        <span class="character">BIT .tapeCurrentBlockFlag                           ; current block flag</span>
        <span class="character">BMI .exit28                                         ;</span>

    <span class="character">.saveFlagsPrintCR</span>
        <span class="character">PHP                                                 ; save flags on stack</span>
        <span class="character">JSR .safePrintFollowingMessage                      ; print message following call (in this case a newline character)</span>
        <span class="character">!byte .charRETURN, 0                                ; message</span>
        <span class="character">PLP                                                 ; restore flags from stack</span>
    <span class="character">.exit28</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.retryAfterFailure</span>
        <span class="character">JSR .searchForSpecifiedBlock                        ; search for a specified block</span>
        <span class="character">BNE .loadOrRun                                      ; ALWAYs branch (try again)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; On Entry:</span>
    <span class="character">;   X and Y     filename address (Low/High)</span>
    <span class="character">; On Exit:</span>
    <span class="character">;   A = 0</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.getFilenameFromXY</span>
        <span class="character">STX .stringInputBufferAddressLow                    ; OS filename/command line pointer</span>
        <span class="character">STY .stringInputBufferAddressHigh                   ; OS filename/command line pointer</span>
        <span class="character">LDY #0                                              ; Y=0</span>
        <span class="character">JSR .gsinitForFilenameParsing                       ; initialise string</span>
        <span class="character">LDX #0                                              ; X=0</span>
    <span class="character">-</span>
        <span class="character">JSR .gsreadEntryPoint                               ; GSREAD call</span>
        <span class="character">BCS .terminateFilename                              ; if end of character string F277</span>
        <span class="character">BEQ .brkBadStringJumper                             ; if 0 found then break</span>
        <span class="character">STA .filenameToSearchFor,X                          ; else store character in CFS filename area</span>
        <span class="character">INX                                                 ; X=X+1</span>
        <span class="character">CPX #11                                             ; if X is not 11</span>
        <span class="character">BNE -                                               ; then read next</span>
    <span class="character">.brkBadStringJumper</span>
        <span class="character">JMP .brkBadString                                   ; else Bad String error</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">.terminateFilename</span>
        <span class="character">LDA #0                                              ; terminate filename with 0</span>
        <span class="character">STA .filenameToSearchFor,X                          ;</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; OSFILE</span>
    <span class="character">; default handling for OSFILE (for cassette and ROM filing system)</span>
    <span class="character">;</span>
    <span class="character">; parameter block located by XY</span>
    <span class="character">;   0-1     Address of Filename terminated by CR</span>
    <span class="character">;   2-4     Load Address of File</span>
    <span class="character">;   6-9     Execution Address of File</span>
    <span class="character">;   10-13   Start address of data for write operations or length of file for read operations</span>
    <span class="character">;   14-17   End address of Data (i.e. byte AFTER last byte to be written) or file attributes</span>
    <span class="character">;</span>
    <span class="character">; On Entry action is determined by value in A</span>
    <span class="character">;</span>
    <span class="character">;   A=0     Save section of memory as named file, write catalogue information</span>
    <span class="character">;   A=1     Write catalogue information for named file                              (not supported in this FS)</span>
    <span class="character">;   A=2     Write the LOAD       address (only) for the named File                  (not supported in this FS)</span>
    <span class="character">;   A=3     Write the EXECUTION  address (only) for the named File                  (not supported in this FS)</span>
    <span class="character">;   A=4     Write the ATTRIBUTES for the named File                                 (not supported in this FS)</span>
    <span class="character">;   A=5     Read the named files catalogue information and place file type in A     (not supported in this FS)</span>
    <span class="character">;   A=6     Delete the named file                                                   (not supported in this FS)</span>
    <span class="character">;   A=$FF   Load the named file and read its catalogue information</span>
    <span class="character">;</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">.osfileEntryPoint</span>
        <span class="character">PHA                                                 ; save action on stack</span>
        <span class="character">STX .osfileBlockAddressLow                          ; osfile block pointer low</span>
        <span class="character">STY .osfileBlockAddressHigh                         ; osfile block pointer high</span>
        <span class="character">LDY #0                                              ; Y=0</span>
        <span class="character">LDA (.osfileBlockAddressLow),Y                      ; get address of filename (low byte)</span>
        <span class="character">TAX                                                 ; store in X</span>
        <span class="character">INY                                                 ; Y=1</span>
        <span class="character">LDA (.osfileBlockAddressLow),Y                      ; get address of filename (high byte)</span>
        <span class="character">TAY                                                 ; store in Y</span>
        <span class="character">JSR .getFilenameFromXY                              ; get filename from buffer at XY</span>
        <span class="character">LDY #2                                              ; Y=2</span>

    <span class="character">-</span>
        <span class="character">LDA (.osfileBlockAddressLow),Y                      ; copy parameters to Cassette block at 3BE/C5</span>
        <span class="character">STA .fsLoadAddressLow-2,Y                           ; from LOAD and EXEC address</span>
        <span class="character">STA .loadAddressLow-2,Y                             ; make second copy at B0-B8</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">CPY #10                                             ; until Y=10</span>
        <span class="character">BNE -                                               ;</span>

        <span class="character">PLA                                                 ; get back A (action)</span>
        <span class="character">BEQ .saveFile                                       ; if A=0 then branch (save file)</span>
        <span class="character">CMP #$FF                                            ; else if A is not 255</span>
        <span class="character">BNE .exit28                                         ; if (A != 255) then branch (exit, as cassette has no other options)</span>
        <span class="character">JMP .loadFile                                       ; load file (with Y=0)</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       A = 0</span>
    <span class="character">;       Y = 10 (offset in OSFILE Block)</span>
    <span class="character">.saveFile</span>
        <span class="character">STA .fsBlockNumberLow                               ; zero block number low</span>
        <span class="character">STA .fsBlockNumberHigh                              ; zero block number high</span>

        <span class="character">; loop to store load address, block number and block length in zero page copy</span>
    <span class="character">-</span>
        <span class="character">LDA (.osfileBlockAddressLow),Y                      ; read from .OSFILE parameter block</span>
        <span class="character">STA .loadAddressLow-10,Y                            ; store</span>
        <span class="character">INY                                                 ; data start and data end address</span>
        <span class="character">CPY #10 + 8                                         ; check for Y=18</span>
        <span class="character">BNE -                                               ; if (not finished) then branch (loop back)</span>

        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">BEQ .brkBadStringJumper                             ; if (no filename found) then branch ('</span><span class="identifier">Bad</span><span class="plain"> </span><span class="identifier">string</span><span class="character">' error)</span>

        <span class="character">JSR .claimSerialSystemForLoadSave                   ; claim serial system for load/save on cassette</span>
        <span class="character">JSR .promptToRecordOnTape                           ; prompt to start recording</span>
        <span class="character">LDA #0                                              ; A=0 (meaning read bytes from second processor, aka:</span>
                                                            <span class="character">;      '</span><span class="identifier">multiple</span><span class="plain"> </span><span class="identifier">single</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">transfer</span><span class="plain">: 2</span><span class="identifier">nd</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">/</span><span class="identifier">o</span><span class="plain"> </span><span class="identifier">processor</span><span class="character">')</span>
        <span class="character">JSR .secondProcessorTransfer                        ; start transfer from 2nd processor (if present)</span>
        <span class="character">JSR .setupForCassetteWrite                          ; set up CFS for write operation</span>

    <span class="character">.saveToTapeLoop</span>
        <span class="character">; calculate length to read</span>
        <span class="character">SEC                                                 ; set carry</span>
        <span class="character">LDX #$FD                                            ; X = loop counter (loops three times)</span>

    <span class="character">-</span>
        <span class="character">LDA $0000 + .tapeCurrentBlockNumberLow - $FD,X      ; read current block number and next block number</span>
                                                            <span class="character">; from .tapeCurrentBlockNumberLow/High and .tapeNextBlockNumberLow</span>
        <span class="character">SBC $0000 + .loadAddressLow - $FD,X                 ; subtract load address?</span>
        <span class="character">STA $0000 + .fsBlockLengthLow - $FD,X               ; store at .fsBlockLengthLow/High and .fsBlockFlagByte</span>
        <span class="character">INX                                                 ; X=X+1</span>
        <span class="character">BNE -                                               ;</span>

        <span class="character">TAY                                                 ; Y=A</span>
        <span class="character">BNE .setFullBlockLength                             ; if last byte is non zero then branch</span>

        <span class="character">CPX .fsBlockLengthLow                               ; compare X with block length</span>
        <span class="character">LDA #$01                                            ; A=1</span>
        <span class="character">SBC .fsBlockLengthHigh                              ; subtract block length high</span>
        <span class="character">BCC .setFullBlockLength                             ; if carry clear then branch</span>

        <span class="character">LDX #$80                                            ; X=$80</span>
        <span class="character">BNE .skipSettingBlockLength                         ; ALWAYs branch</span>

    <span class="character">.setFullBlockLength</span>
        <span class="character">LDA #1                                              ; A=1</span>
        <span class="character">STA .fsBlockLengthHigh                              ; }</span>
        <span class="character">STX .fsBlockLengthLow                               ; } block length = $0100 (X=0 at this point)</span>

    <span class="character">.skipSettingBlockLength</span>
        <span class="character">STX .fsBlockFlagByte                               ; block flag</span>
        <span class="character">JSR .saveABlock                                    ; write block to Tape</span>
        <span class="character">BMI .exit29                                        ; if (negative) then branch (exit)</span>
        <span class="character">JSR .incrementLoadAddress                          ; increment current load address</span>
        <span class="character">INC .fsBlockNumberLow                              ; block number</span>
        <span class="character">BNE .saveToTapeLoop                                ; if (not 0) then branch (loop back again)</span>
        <span class="character">INC .fsBlockNumberHigh                             ; block number high</span>
        <span class="character">BNE .saveToTapeLoop                                ; ALWAYs branch (since block number high byte should never wrap around) (loop back again)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.starRunEntryPoint</span>
        <span class="character">JSR .getFilenameFromXY                              ; get filename from buffer at XY</span>
        <span class="character">LDX #$FF                                            ; X=$FF</span>
        <span class="character">STX .fsExecutionAddressLow                          ; store in low byte of execution address</span>
        <span class="character">JSR .loadFile                                       ; load file (with A=0)</span>
        <span class="character">BIT .tubePresentFlag                                ; check to see if Tube is present</span>
        <span class="character">BPL +                                               ; if (Tube is not present) then branch</span>
        <span class="character">LDA .fsExecutionAddressMid2                         ; execution address extend</span>
        <span class="character">AND .fsExecutionAddressHigh                         ; execution address extend</span>
        <span class="character">CMP #$FF                                            ; check if all bits set</span>
        <span class="character">BNE .sendExecAddressToRunFromTube                   ; if (top two bytes of exec address are not both $FF) then branch (execute on the Tube)</span>
    <span class="character">+</span>
        <span class="character">JMP (.fsExecutionAddressLow)                        ; RUN file</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.sendExecAddressToRunFromTube</span>
        <span class="character">LDX #&lt;.fsExecutionAddressLow                        ; }</span>
        <span class="character">LDY #&gt;.fsExecutionAddressHigh                       ; } point to execution address</span>
        <span class="character">LDA #4                                              ; Tube call 4</span>
        <span class="character">JMP .secondProcessorCall                            ; and issue to Tube to run file</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.starCatEntryPoint</span>
        <span class="character">LDA #%00001000                                      ; A=8</span>
        <span class="character">JSR .setTapeStatusBits                              ; set status bits from A</span>
        <span class="character">JSR .claimSerialSystemForLoadSave                   ; Set cassette options into (BB),set C7=6</span>
                                                            <span class="character">; claim serial system for cassette</span>
        <span class="character">LDA #0                                              ; A=0</span>
        <span class="character">JSR .searchForBlockCFSRFS                           ; read data from CFS/RFS</span>
        <span class="character">JSR .cancelTapeOperation2                           ;</span>
        <span class="character">; fall through...</span>

    <span class="character">.clearCatalogueStatus</span>
        <span class="character">LDA #%11110111                                      ;</span>
    <span class="character">.logicalANDWithStatusByteAndStore</span>
        <span class="character">AND .tapeROMFSStatusByte                            ; clear bit 3 of CFS status bit (catalogue status)</span>
    <span class="character">.storeTapeStatusByte</span>
        <span class="character">STA .tapeROMFSStatusByte                            ;</span>
    <span class="character">.exit29</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.setTapeEOFStatus</span>
        <span class="character">LDA #%01000000                                      ; set bit 6 of cassette status</span>
    <span class="character">.setTapeStatusBits</span>
        <span class="character">ORA .tapeROMFSStatusByte                            ;</span>
        <span class="character">BNE .storeTapeStatusByte                            ; ALWAYs branch (store status byte)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.searchForBlockCFSRFS</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">LDA .tapeOrRomSwitch                                ; filing system flag 0=CFS; 2=RFS</span>
        <span class="character">BEQ .searchForBlockCFS                              ; if CFS then branch</span>
        <span class="character">JSR .setInitialSpeechPHROMNumber                    ; set current Filing System ROM/PHROM</span>
        <span class="character">JSR .readByteFromROMOrPHROM                         ; get byte from data Romcheck type</span>
        <span class="character">BCC .searchForBlockCFS                              ; if carry clear then branch</span>
        <span class="character">CLV                                                 ; clear overflow flag</span>
        <span class="character">BVC .pullAAndReturn                                 ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.searchForBlockCFS</span>
        <span class="character">JSR .readBlockHeader                                ; read block header</span>
        <span class="character">LDA .fsBlockNumberLow                               ; block number</span>
        <span class="character">STA .tapeCurrentBlockNumberLow                      ; current block number low</span>
        <span class="character">LDA .fsBlockNumberHigh                              ; block number high</span>
        <span class="character">STA .tapeCurrentBlockNumberHigh                     ; current block number high</span>
        <span class="character">LDX #$FF                                            ; X=$FF</span>
        <span class="character">STX .fsLastBlockReadFlagsCopy                       ; copy of last read block flag</span>
        <span class="character">INX                                                 ; X=0</span>
        <span class="character">STX .tapeCurrentBlockFlag                           ; current block flag</span>
        <span class="character">BEQ +                                               ; ALWAYs branch</span>

    <span class="character">.searchForBlockLoop</span>
        <span class="character">JSR .incrementBlockNumber                           ; inc. current block number</span>
        <span class="character">JSR .readBlockHeader                                ; read block header</span>

    <span class="character">+</span>
        <span class="character">LDA .tapeOrRomSwitch                                ; get filing system flag 0=CFS; 2=RFS</span>
        <span class="character">BEQ +                                               ; if CFS then branch</span>
        <span class="character">BVC .pullAAndReturn                                 ; if V clear then branch</span>

    <span class="character">+</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">BEQ .finishWithBlockAndContinueIfNeeded             ; if A=0 then branch</span>
        <span class="character">JSR .compareFilenames                               ; else check filename header block matches searched Fn</span>
        <span class="character">BNE .messageAndFinishBlock                          ; if (filenames don'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">match</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #%00110000                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 4/5 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OPTions</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">tapeCurrentOptionsByte</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OPTions</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">pullAAndReturn</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsBlockNumberLow</span><span class="plain">                               ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">tapeNextBlockNumberLow</span><span class="plain">                         ; </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">messageAndFinishBlock</span><span class="plain">                          ;</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsBlockNumberHigh</span><span class="plain">                              ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">CMP</span><span class="plain"> .</span><span class="identifier">tapeNextBlockNumberHigh</span><span class="plain">                        ; </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">messageAndFinishBlock</span><span class="plain">                          ;</span>

    <span class="plain">.</span><span class="identifier">pullAAndReturn</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">messageAndFinishBlock</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                                ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> 0=</span><span class="identifier">CFS</span><span class="plain">; 2=</span><span class="identifier">RFS</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">finishWithBlockAndContinueIfNeeded</span><span class="plain">             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">skipMessaging</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setRomOrPhromAddress</span><span class="plain">                           ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">address</span>

    <span class="plain">.</span><span class="identifier">resetBlockNumberAndContinue</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FF</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsBlockNumberLow</span><span class="plain">                               ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsBlockNumberHigh</span><span class="plain">                              ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">searchForBlockLoop</span><span class="plain">                             ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">means</span><span class="plain"> </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">state</span>
    <span class="plain">.</span><span class="identifier">finishWithBlockAndContinueIfNeeded</span>
        <span class="identifier">BVC</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FF</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">resetFSState2</span><span class="plain">                                  ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">flags</span>
    <span class="plain">+</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ; </span><span class="identifier">X</span><span class="plain">=0</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checksumErrorCheck</span><span class="plain">                             ; </span><span class="identifier">report</span><span class="plain"> </span><span class="character">'DATA?'</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">necessary</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> (0=</span><span class="identifier">CFS</span><span class="plain">; 2=</span><span class="identifier">RFS</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">tapeCurrentOptionsByte</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OPTions</span>
        <span class="identifier">BVC</span><span class="plain"> .</span><span class="identifier">skipMessaging</span><span class="plain">                                  ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> (</span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">required</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
    <span class="plain">+</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">fsBlockFlagByte</span><span class="plain">                                ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">resetBlockNumberAndContinue</span><span class="plain">                    ; </span><span class="reserved">if</span><span class="plain"> -</span><span class="identifier">ve</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">searchForBlockLoop</span><span class="plain">                             ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span><span class="plain">)</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSFIND</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;     </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">determines</span><span class="plain"> </span><span class="identifier">action</span><span class="plain">; </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">may</span><span class="plain"> </span><span class="identifier">contain</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain">; </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">XY</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">terminated</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> $0</span><span class="identifier">D</span>
    <span class="plain">;</span>
    <span class="plain">;     </span><span class="identifier">A</span><span class="plain">=0    </span><span class="identifier">closes</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> = 0 </span><span class="identifier">closes</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">files</span>
    <span class="plain">;     </span><span class="identifier">A</span><span class="plain">=$40  </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">input</span><span class="plain">  (</span><span class="identifier">reading</span><span class="plain">) </span><span class="identifier">XY</span><span class="plain"> </span><span class="identifier">points</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">filename</span>
    <span class="plain">;     </span><span class="identifier">A</span><span class="plain">=$80  </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> (</span><span class="identifier">writing</span><span class="plain">) </span><span class="identifier">XY</span><span class="plain"> </span><span class="identifier">points</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">filename</span>
    <span class="plain">;     </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">C0</span><span class="plain">  </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> (</span><span class="identifier">random</span><span class="plain"> </span><span class="identifier">Access</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;     </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">opened</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">zero</span>
    <span class="plain">;     </span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">preserved</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osfindEntryPoint</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">action</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; } </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">action</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">openAFile</span><span class="plain">                                      ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">non</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">specific</span><span class="plain"> </span><span class="identifier">file</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">closeOneFile</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">specified</span><span class="plain"> </span><span class="identifier">file</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">osbyte119EntryPoint</span><span class="plain">                            ; </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">SPOOL</span><span class="plain">/</span><span class="identifier">EXEC</span><span class="plain"> </span><span class="identifier">files</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 119</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">closeFileThatsOpenForOutput</span><span class="plain">                    ; </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">open</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">output</span>
    <span class="plain">-</span>
        <span class="identifier">LSR</span><span class="plain"> .</span><span class="identifier">tapeROMFSStatusByte</span><span class="plain">                            ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">right</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain">)</span>
        <span class="identifier">ASL</span><span class="plain"> .</span><span class="identifier">tapeROMFSStatusByte</span><span class="plain">                            ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">left</span><span class="plain"> (</span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">)</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">finishWithError</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">open</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
    <span class="plain">+</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">contains</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">BCS</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">channelError</span><span class="plain">                                   ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">report</span><span class="plain"> </span><span class="character">'Channel Error'</span>
                                                            <span class="plain">; </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">only</span><span class="plain"> </span><span class="identifier">support</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">file</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">closeFileThatsOpenForOutput</span><span class="plain">                    ; </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">open</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">output</span>
    <span class="plain">.</span><span class="identifier">finishWithError</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">restoreRegistersAndExit</span><span class="plain">                        ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">openAFile</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">getFilenameFromXY</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">XY</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">BVC</span><span class="plain"> .</span><span class="identifier">openAFileForOutputOnly</span><span class="plain">                         ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">openAFileForInput</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">bgetBufferOffset</span><span class="plain">                               ; </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">nextBGETBlockLow</span><span class="plain">                               ; </span><span class="identifier">Expected</span><span class="plain"> </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">nextBGETBlockHigh</span><span class="plain">                              ; </span><span class="identifier">expected</span><span class="plain"> </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">LDA</span><span class="plain"> #%00111110                                      ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">logicalANDWithStatusByteAndStore</span><span class="plain">               ; } </span><span class="identifier">clear</span><span class="plain"> </span><span class="character">'input file open'</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain">; </span><span class="identifier">clear</span><span class="plain"> </span><span class="character">'EOF reached'</span><span class="plain">; </span><span class="identifier">clear</span><span class="plain"> </span><span class="character">'EOF warning given'</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">claimSerialSystemForSequentialAccess</span><span class="plain">           ; </span><span class="identifier">claim</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">OPTions</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">searchForFile</span><span class="plain">                                  ; </span><span class="identifier">search</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkLockedFlag</span><span class="plain">                                ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">protection</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">respond</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">LDX</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>

    <span class="plain">-</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">+1</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsFilename</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                   ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">name</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">bgetFilename</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">filename</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> (</span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">terminator</span><span class="plain">)</span>

        <span class="identifier">LDA</span><span class="plain"> #%00000001                                      ; </span><span class="identifier">A</span><span class="plain">=1 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="character">'input file open'</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTapeStatusBits</span><span class="plain">                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeInputCurrentBlockSizeLow</span><span class="plain">                   ; </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">resident</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">tapeInputCurrentBlockSizeHigh</span><span class="plain">                  ; </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">resident</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 0</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTapeEOFStatus</span><span class="plain">                               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 (</span><span class="identifier">EOF</span><span class="plain"> </span><span class="identifier">reached</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> #1                                              ; </span><span class="identifier">A</span><span class="plain">=1</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                                ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> 0=</span><span class="identifier">CFS</span><span class="plain">; 2=</span><span class="identifier">RFS</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">storeFileStatusAndExit</span><span class="plain">                         ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">restoring</span><span class="plain"> </span><span class="identifier">registers</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">filename</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">openAFileForOutputOnly</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">non</span><span class="plain">-</span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">brkBadString</span><span class="plain">                                   ; </span><span class="identifier">output</span><span class="plain"> </span><span class="character">'Bad String'</span><span class="plain"> </span><span class="identifier">error</span>
    <span class="plain">+</span>
        <span class="identifier">LDX</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">X</span><span class="plain">=$</span><span class="identifier">FF</span>
    <span class="plain">.</span><span class="identifier">copyFilenameLoop</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">+1</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">filenameToSearchFor</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                          ; </span><span class="identifier">sought</span><span class="plain"> </span><span class="identifier">filename</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeBlockHeaderStart</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">BPUT</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">header</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">copyFilenameLoop</span><span class="plain">                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=0 (</span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">terminator</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain">)</span>

        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FF</span>
        <span class="identifier">LDX</span><span class="plain"> #8                                              ; </span><span class="identifier">X</span><span class="plain">=8</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeBlockLoadAddressLow</span><span class="plain">-1,</span><span class="identifier">X</span><span class="plain">                    ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exec</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $</span><span class="identifier">FF</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>

        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">tapeBlockNumberLow</span><span class="plain"> - .</span><span class="identifier">tapeBlockHeaderStart</span><span class="plain">    ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> $14 </span><span class="identifier">to</span><span class="plain"> $1</span><span class="identifier">E</span>
    <span class="plain">-</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeBlockHeaderStart</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                         ; </span><span class="identifier">BPUT</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">header</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">+1</span>
        <span class="identifier">CPX</span><span class="plain"> #.</span><span class="identifier">bgetBufferOffset</span><span class="plain"> - .</span><span class="identifier">tapeBlockHeaderStart</span><span class="plain">      ; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">zeros</span><span class="plain"> </span><span class="identifier">BPUT</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>

        <span class="identifier">ROL</span><span class="plain"> .</span><span class="identifier">tapeBlockLengthHigh</span><span class="plain">                            ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">claimSerialSystemForLoadSave</span><span class="plain">                   ; </span><span class="identifier">claim</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">load</span><span class="plain">/</span><span class="identifier">save</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">promptToRecordOnTape</span><span class="plain">                           ; </span><span class="identifier">prompt</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">start</span><span class="plain"> </span><span class="identifier">recording</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">cancelTapeOperation</span><span class="plain">                            ;</span>
        <span class="identifier">LDA</span><span class="plain"> #%00000010                                      ; </span><span class="identifier">A</span><span class="plain">=2</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTapeStatusBits</span><span class="plain">                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> #2                                              ; </span><span class="identifier">A</span><span class="plain">=2</span>

    <span class="plain">.</span><span class="identifier">storeFileStatusAndExit</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">restoreRegistersAndExit</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
    <span class="plain">.</span><span class="identifier">exit30</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">closeFileThatsOpenForOutput</span>
        <span class="identifier">LDA</span><span class="plain"> #%00000010                                      ; }</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">tapeROMFSStatusByte</span><span class="plain">                            ; } </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">except</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit30</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">open</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeBlockLengthHigh</span><span class="plain">                            ; </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">BPUT</span><span class="plain"> </span><span class="identifier">offset</span>
        <span class="identifier">LDA</span><span class="plain"> #$80                                            ; </span><span class="identifier">A</span><span class="plain">=$80</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">bputBufferOffset</span><span class="plain">                               ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">BPUT</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">offset</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tapeBlockLengthLow</span><span class="plain">                             ; </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">BPUT</span><span class="plain"> </span><span class="identifier">offset</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeBlockFlagByte</span><span class="plain">                              ; </span><span class="identifier">mark</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">last</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">saveBlockToTape</span><span class="plain">                                ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">tape</span>
        <span class="identifier">LDA</span><span class="plain"> #%11111101                                      ; }</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">logicalANDWithStatusByteAndStore</span><span class="plain">               ; } </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">open</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">output</span><span class="plain">) </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">saveBlockToTape</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">claimSerialSystemForSequentialAccess</span><span class="plain">           ; </span><span class="identifier">claim</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">OPTions</span>

        <span class="identifier">LDX</span><span class="plain"> #17                                             ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeBlockLoadAddressLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                      ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsLoadAddressLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                             ; } </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">header</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=255</span>

        <span class="plain">; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="string">"FFFF0900"</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">loadAddressMid2</span><span class="plain">                                ; </span><span class="identifier">store</span><span class="plain"> $</span><span class="identifier">FF</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">loadAddressHigh</span><span class="plain">                                ; </span><span class="identifier">store</span><span class="plain"> $</span><span class="identifier">FF</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">)</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">loadAddressLow</span><span class="plain">                                 ; </span><span class="identifier">store</span><span class="plain"> $00</span>
        <span class="identifier">LDA</span><span class="plain"> #$09                                            ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">loadAddressMid1</span><span class="plain">                                ; </span><span class="identifier">store</span><span class="plain"> $09</span>

        <span class="plain">; </span><span class="identifier">Copy</span>
        <span class="identifier">LDX</span><span class="plain"> #&lt;(.</span><span class="identifier">tapeBlockFilename</span><span class="plain">-1)                        ; </span><span class="identifier">X</span><span class="plain">=$7</span><span class="identifier">F</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyToSoughtFilename</span><span class="plain">                           ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">tapeBlockFilename</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">filenameToSearchFor</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsLastBlockReadFlagsCopy</span><span class="plain">                       ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">zero</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">zeroFileHandleMotorOn</span><span class="plain">                          ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">Motor</span><span class="plain"> </span><span class="identifier">On</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setupForCassetteWrite</span><span class="plain">                          ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">operation</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">saveABlock</span><span class="plain">                                     ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">tape</span>

        <span class="plain">; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">tapeBlockNumberLow</span><span class="plain">                             ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ;</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">tapeBlockNumberHigh</span><span class="plain">                            ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBGET</span><span class="plain"> - </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">contains</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">number</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">preserved</span>
    <span class="plain">;       </span><span class="identifier">C</span><span class="plain">=0 </span><span class="identifier">indicates</span><span class="plain"> </span><span class="identifier">valid</span><span class="plain"> </span><span class="identifier">character</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">contains</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> (</span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">) </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FE</span><span class="plain"> </span><span class="identifier">End</span><span class="plain"> </span><span class="identifier">Of</span><span class="plain"> </span><span class="identifier">File</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbgetEntryPoint</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">LDA</span><span class="plain"> #1                                              ; </span><span class="identifier">A</span><span class="plain">=1</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkFileIsOpen</span><span class="plain">                                ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">conditions</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">OSBGET</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">OK</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeROMFSStatusByte</span><span class="plain">                            ; </span><span class="identifier">tape</span><span class="plain">/</span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">FS</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> (</span><span class="identifier">EOF</span><span class="plain"> </span><span class="identifier">warning</span><span class="plain"> </span><span class="identifier">given</span><span class="plain">)</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">eofErrorMessage</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; </span><span class="identifier">shift</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">notEOF</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">EOF</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">reached</span><span class="plain"> </span><span class="identifier">F4E3</span>
        <span class="identifier">LDA</span><span class="plain"> #%10000000                                      ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTapeStatusBits</span><span class="plain">                              ; } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (</span><span class="character">'EOF warning given'</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FE</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FE</span><span class="plain"> (</span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain">)</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">storeFileStatus</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">notEOF</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">bgetBufferOffset</span><span class="plain">                               ; </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">+1</span>
        <span class="identifier">CPX</span><span class="plain"> .</span><span class="identifier">tapeInputCurrentBlockSizeLow</span><span class="plain">                   ; </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">resident</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">readFromFSBufferAndContinue</span><span class="plain">                    ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">block</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain">)</span>

        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">blockFlagOfCurrentlyResidentBlock</span><span class="plain">              ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">resident</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">setEOF</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">block</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">lastCharacterOfCurrentlyResidentBlock</span><span class="plain">          ; </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">resident</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">claimSerialSystemForSequentialAccess</span><span class="plain">           ; </span><span class="identifier">claim</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">OPTions</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readABlock</span><span class="plain">                                     ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">blockFlagOfCurrentlyResidentBlock</span><span class="plain">              ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">resident</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">incrementAndFinish</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">block</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeInputCurrentBlockSizeLow</span><span class="plain">                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">tapeInputCurrentBlockSizeHigh</span><span class="plain">                  ; </span><span class="identifier">OR</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">incrementAndFinish</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTapeEOFStatus</span><span class="plain">                               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 (</span><span class="identifier">EOF</span><span class="plain"> </span><span class="identifier">reached</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">incrementAndFinish</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">EOF</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">.</span><span class="identifier">setEOF</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setTapeEOFStatus</span><span class="plain">                               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 (</span><span class="identifier">EOF</span><span class="plain"> </span><span class="identifier">reached</span><span class="plain">)</span>

    <span class="plain">.</span><span class="identifier">readFromFSBufferAndContinue</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOrRS423InputBuffer</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                       ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">buffer</span>

    <span class="plain">.</span><span class="identifier">storeFileStatus</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
    <span class="plain">.</span><span class="identifier">incrementAndFinish</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">bgetBufferOffset</span><span class="plain">                               ; </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">restoreRegistersAndExit</span><span class="plain">                        ; </span><span class="identifier">exit</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> .</span><span class="identifier">restoreRegistersAndExit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">eofErrorMessage</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">DF</span><span class="plain">                                           ; </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"EOF"</span><span class="plain">,0                                       ; </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">terminator</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBPUT</span><span class="plain"> - </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">contains</span><span class="plain"> </span><span class="identifier">channel</span><span class="plain"> </span><span class="identifier">number</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">contains</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">written</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbputEntryPoint</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeLastBputValue</span><span class="plain">                              ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain">  </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">LDA</span><span class="plain"> #2                                              ; </span><span class="identifier">A</span><span class="plain">=2 (</span><span class="identifier">meaning</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">open</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">writing</span><span class="plain">, </span><span class="identifier">checking</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkFileIsOpen</span><span class="plain">                                ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">conditions</span><span class="plain"> </span><span class="identifier">necessary</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">OSBPUT</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">OK</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">bputBufferOffset</span><span class="plain">                               ; </span><span class="identifier">BPUT</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeLastBputValue</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeOrRS423OutputBuffer</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                      ; </span><span class="identifier">Cassette</span><span class="plain">/</span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">+1</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> 0 </span><span class="identifier">F545</span><span class="plain">, </span><span class="identifier">otherwise</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">full</span><span class="plain"> </span><span class="identifier">so</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">saveBlockToTape</span><span class="plain">                                ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">tape</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">cancelTapeOperation</span><span class="plain">                            ;</span>
    <span class="plain">+</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">bputBufferOffset</span><span class="plain">                               ; </span><span class="identifier">BPUT</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeLastBputValue</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">storeFileStatusAndExit</span><span class="plain">                         ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">exit</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; *</span><span class="identifier">OPT</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">;        </span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span>
    <span class="plain">;   *</span><span class="identifier">OPT</span><span class="plain"> 0,0  </span><span class="identifier">restore</span><span class="plain"> *</span><span class="identifier">OPT</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">values</span>
    <span class="plain">;   *</span><span class="identifier">OPT</span><span class="plain"> 1,0  </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">;   *</span><span class="identifier">OPT</span><span class="plain"> 1,1  </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">messages</span><span class="plain"> (</span><span class="identifier">normal</span><span class="plain">)</span>
    <span class="plain">;   *</span><span class="identifier">OPT</span><span class="plain"> 1,2  </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">messages</span><span class="plain"> (</span><span class="identifier">extended</span><span class="plain">)</span>
    <span class="plain">;   *</span><span class="identifier">OPT</span><span class="plain"> 2,0  </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">errors</span><span class="plain">, </span><span class="identifier">though</span><span class="plain"> </span><span class="identifier">messages</span><span class="plain"> </span><span class="identifier">may</span><span class="plain"> </span><span class="identifier">be</span><span class="plain"> </span><span class="identifier">displayed</span>
    <span class="plain">;   *</span><span class="identifier">OPT</span><span class="plain"> 2,1  </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">prompt</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">retry</span>
    <span class="plain">;   *</span><span class="identifier">OPT</span><span class="plain"> 2,2  </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">, </span><span class="identifier">abort</span>
    <span class="plain">;   *</span><span class="identifier">OPT</span><span class="plain"> 3,</span><span class="identifier">n</span><span class="plain">  </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">interblock</span><span class="plain"> </span><span class="identifier">gaps</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">/10 </span><span class="identifier">seconds</span><span class="plain"> (</span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">SAVE</span><span class="plain"> </span><span class="identifier">operations</span><span class="plain">)</span>
    <span class="plain">;             </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">&gt;127 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">value</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">starOptEntryPoint</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">restoreDefaultOPTs</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> *</span><span class="identifier">OPT</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">defaults</span><span class="plain">)</span>
        <span class="identifier">CPX</span><span class="plain"> #3                                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=3</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">tapeSetInterblockGap</span><span class="plain">                           ; </span><span class="reserved">if</span><span class="plain"> *</span><span class="identifier">OPT</span><span class="plain"> 3 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">interblock</span><span class="plain"> </span><span class="identifier">gap</span><span class="plain">)</span>
        <span class="identifier">CPY</span><span class="plain"> #3                                              ;</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">issueBadCommand</span><span class="plain">                                ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">&gt;2 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="character">'Bad command'</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">)</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">opt1</span><span class="plain">                                           ; </span><span class="reserved">if</span><span class="plain"> *</span><span class="identifier">OPT</span><span class="plain"> 1 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">level</span><span class="plain">)</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ;</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">opt2</span><span class="plain">                                           ; </span><span class="reserved">if</span><span class="plain"> *</span><span class="identifier">OPT</span><span class="plain"> 2 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">response</span><span class="plain"> </span><span class="identifier">level</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">errors</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">issueBadCommand</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">badCommandError</span><span class="plain">                                ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">issue</span><span class="plain"> </span><span class="character">'Bad command'</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">)</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Set</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">level</span>
    <span class="plain">.</span><span class="identifier">opt1</span>
        <span class="identifier">LDA</span><span class="plain"> #%00110011                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">lower</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">MASK</span>
                                                            <span class="plain">; </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">allows</span><span class="plain"> </span><span class="identifier">us</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> (</span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">) </span><span class="identifier">and</span>
                                                            <span class="plain">; </span><span class="identifier">still</span><span class="plain"> </span><span class="identifier">keep</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">existing</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span>
                                                            <span class="plain">; </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> (</span><span class="identifier">ignore</span><span class="plain">/</span><span class="identifier">retry</span><span class="plain">/</span><span class="identifier">abort</span><span class="plain">)</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; }</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; } </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+3 (</span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> .</span><span class="identifier">tapeOptByteTable</span><span class="plain">)</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; }</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">setOptWithMask</span><span class="plain">                                 ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">opt2</span>
        <span class="identifier">LDA</span><span class="plain"> #%11001100                                      ; </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">MASK</span>
                                                            <span class="plain">; </span><span class="identifier">allows</span><span class="plain"> </span><span class="identifier">us</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> (</span><span class="identifier">ignore</span><span class="plain">/</span><span class="identifier">retry</span><span class="plain">/</span><span class="identifier">abort</span><span class="plain">) </span><span class="identifier">and</span>
                                                            <span class="plain">; </span><span class="identifier">still</span><span class="plain"> </span><span class="identifier">keep</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">existing</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bits</span>
                                                            <span class="plain">; </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> (</span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">setOptWithMask</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1 (</span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> .</span><span class="identifier">tapeOptByteTable</span><span class="plain">)</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">tapeOptionsByte</span><span class="plain">                                ; </span><span class="identifier">keep</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">MASK</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">keeping</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">options</span>
    <span class="plain">.</span><span class="identifier">setOPTValueY</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">tapeOptByteTable</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                             ; </span><span class="identifier">OR</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">options</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeOptionsByte</span><span class="plain">                                ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">tapeSetInterblockGap</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain"> (</span><span class="identifier">interblock</span><span class="plain"> </span><span class="identifier">gap</span><span class="plain">)</span>
        <span class="identifier">BMI</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">&gt;127 </span><span class="identifier">use</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">useGapDontUseDefaultValue</span><span class="plain">                      ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> != 0 </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">instruction</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> #25                                             ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=25 (2.5 </span><span class="identifier">seconds</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="reserved">default</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">useGapDontUseDefaultValue</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeInterBlockGap</span><span class="plain">                              ; </span><span class="identifier">sequential</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">gap</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">restoreDefaultOPTs</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">setOPTValueY</span><span class="plain">                                   ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Options</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> (</span><span class="identifier">LOAD</span><span class="plain">/</span><span class="identifier">SAVE</span><span class="plain">) </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">bottom</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> (</span><span class="identifier">sequential</span><span class="plain"> </span><span class="identifier">access</span><span class="plain">)</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">bit</span><span class="plain"> 0/4 = </span><span class="identifier">Abort</span><span class="plain"> </span><span class="identifier">bit</span>
    <span class="plain">;   </span><span class="identifier">bit</span><span class="plain"> 1/5 = </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">bit</span>
    <span class="plain">;   </span><span class="identifier">bit</span><span class="plain"> 2/6 } </span><span class="identifier">Message</span><span class="plain"> </span><span class="identifier">type</span><span class="plain">: 00 = </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">;   </span><span class="identifier">bit</span><span class="plain"> 3/7 }             : 10 = </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">;           }             : 11 = </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">;</span>
    <span class="plain">; 0000     </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">errors</span><span class="plain">         </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 0001     </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">        </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 0010     </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">     </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1000     </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">          </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1001     </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">        </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1010     </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">     </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1100     </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">          </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1101     </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">        </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">; 1110     </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">     </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>

    <span class="plain">.</span><span class="identifier">tapeOptByteTable</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %10100001                                     ; </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">value</span><span class="plain">:</span>
                                                            <span class="plain">;           </span><span class="identifier">LOAD</span><span class="plain">/</span><span class="identifier">SAVE</span><span class="plain">: </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">, </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">;   </span><span class="identifier">SEQUENTIAL</span><span class="plain"> </span><span class="identifier">ACCESS</span><span class="plain">: </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">, </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00000000                                     ; </span><span class="identifier">ignore</span><span class="plain"> </span><span class="identifier">error</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00100010                                     ; </span><span class="identifier">retry</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00010001                                     ; </span><span class="identifier">abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %00000000                                     ; </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %10001000                                     ; </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> %11001100                                     ; </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">updateACIA</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">filingSystemBufferFlag</span><span class="plain">                         ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                                ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> 0=</span><span class="identifier">CFS</span><span class="plain">; 2=</span><span class="identifier">RFS</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>

        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readByteFromRFSROMorPHROM</span><span class="plain">                      ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">RFS</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">PHROM</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">postReadByte</span><span class="plain">                                   ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">acia6850StatusRegister</span><span class="plain">                         ; </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">AND</span><span class="plain"> #2                                              ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">all</span><span class="plain"> </span><span class="identifier">but</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 1 </span><span class="identifier">A</span><span class="plain">=(0 </span><span class="identifier">or</span><span class="plain"> 2)</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">transmit</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">full</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">RDR</span><span class="plain"> </span><span class="identifier">empty</span><span class="plain">)</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">tapeSendingFlag</span><span class="plain">                                ;</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ;</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsTempStorageBD</span><span class="plain">                                ; </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">storage</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">acia6850DataRegister</span><span class="plain">                           ; </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">transmit</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">+</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">acia6850DataRegister</span><span class="plain">                           ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">receive</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; } </span><span class="identifier">bit</span><span class="plain"> 2 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> (</span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">carrier</span><span class="plain"> </span><span class="identifier">detect</span><span class="plain">)</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; }</span>

    <span class="plain">.</span><span class="identifier">postReadByte</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">tapeProgressState</span><span class="plain">                              ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">progress</span><span class="plain"> </span><span class="identifier">state</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit31</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> .</span><span class="identifier">tapeProgressState</span><span class="plain">=0 </span><span class="identifier">exit</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">tapeProgressMoreThanOne</span><span class="plain">                        ; </span><span class="reserved">if</span><span class="plain"> (.</span><span class="identifier">tapeProgressState</span><span class="plain"> &gt; 1) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">exit31</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">reading</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">OR</span><span class="plain"> </span><span class="identifier">carrier</span><span class="plain"> </span><span class="identifier">tone</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">detected</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">return</span>
        <span class="identifier">LDY</span><span class="plain"> #2                                              ; </span><span class="identifier">Y</span><span class="plain">=2</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">storeTapeProgress</span><span class="plain">                              ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">progress</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">tapeProgressMoreThanOne</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">tapeProgressMoreThan2</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> (.</span><span class="identifier">tapeProgressState</span><span class="plain"> &gt; 2) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">exit31</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carrier</span><span class="plain"> </span><span class="identifier">tone</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">detected</span><span class="plain">  </span><span class="identifier">exit</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">zeroChecksumAndFSBufferFlag</span><span class="plain">                    ; </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">BE</span><span class="plain">/</span><span class="identifier">C0</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> 0</span>
        <span class="identifier">LDY</span><span class="plain"> #3                                              ; </span><span class="identifier">Y</span><span class="plain">=3</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">synchronisationByte</span><span class="plain">                           ; </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">= </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">synchronising</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> $2</span><span class="identifier">A</span><span class="plain">?</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">storeTapeProgress</span><span class="plain">                              ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">state</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">flipRelayOffOnAndDeactivateRequestToSend</span><span class="plain">       ; </span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">system</span>
        <span class="identifier">LDY</span><span class="plain"> #1                                              ; </span><span class="identifier">Y</span><span class="plain">=1</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">storeTapeProgress</span><span class="plain">                              ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">tapeProgressMoreThan2</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">tapeProgressMoreThan3</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> .</span><span class="identifier">tapeProgressState</span><span class="plain">&gt;3</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ;</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">fsTempStorageBD</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit31</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> #$80                                            ; </span><span class="identifier">A</span><span class="plain">=$80</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">filingSystemBufferFlag</span><span class="plain">                         ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">exit31</span><span class="plain">                                         ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">tapeProgressMoreThan3</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">tapeProgressMoreThan4</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> (.</span><span class="identifier">tapeProgressState</span><span class="plain"> &gt; 4) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">resetACIAAndProgress</span><span class="plain">                           ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">stuff</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">updateCRC</span><span class="plain">                                      ; </span><span class="identifier">perform</span><span class="plain"> </span><span class="identifier">CRC</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">fsTempStorageBD</span><span class="plain">                                ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">set</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">finalStage</span><span class="plain">                                     ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">read</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkLoadAddressIsForSecondProcessor</span><span class="plain">           ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">valid</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">INVALID</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tubeULADataRegister3</span><span class="plain">                           ; </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">FIFO3</span><span class="plain"> (</span><span class="identifier">cause</span><span class="plain"> </span><span class="identifier">NMI</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">co</span><span class="plain">-</span><span class="identifier">processor</span><span class="plain">?)</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">finalStage</span><span class="plain">                                     ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>
    <span class="plain">+</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">value</span>
        <span class="identifier">STA</span><span class="plain"> (.</span><span class="identifier">loadAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span>

    <span class="plain">.</span><span class="identifier">finalStage</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
        <span class="identifier">CPY</span><span class="plain"> .</span><span class="identifier">fsBlockLengthLow</span><span class="plain">                               ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">exit31</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">equal</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #1                                              ; </span><span class="identifier">A</span><span class="plain">=1</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">LDY</span><span class="plain"> #5                                              ; </span><span class="identifier">Y</span><span class="plain">=5</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">storeTapeProgress</span><span class="plain">                              ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">progress</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">tapeProgressMoreThan4</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">updateCRC</span><span class="plain">                                      ; </span><span class="identifier">perform</span><span class="plain"> </span><span class="identifier">CRC</span>
        <span class="identifier">DEC</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">exit31</span><span class="plain">                                         ;</span>

    <span class="plain">.</span><span class="identifier">resetACIAAndProgress</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">resetACIA</span><span class="plain">                                      ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">ACIA</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0</span>
    <span class="plain">.</span><span class="identifier">storeTapeProgress</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tapeProgressState</span><span class="plain">                              ; </span><span class="identifier">progress</span><span class="plain"> </span><span class="identifier">flag</span>
    <span class="plain">.</span><span class="identifier">exit31</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">EOF</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Exit</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Preserves</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">Y</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> 0 </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">EOF</span><span class="plain"> </span><span class="identifier">reached</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkEOFEntryPoint</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ;</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; } </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
        <span class="identifier">LDA</span><span class="plain"> #3                                              ; </span><span class="identifier">A</span><span class="plain">=3 (</span><span class="identifier">meaning</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">being</span><span class="plain"> </span><span class="identifier">open</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">write</span><span class="plain">, </span><span class="identifier">bits</span><span class="plain"> 0-1 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkFileIsOpen</span><span class="plain">                                ; </span><span class="identifier">confirm</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">open</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeROMFSStatusByte</span><span class="plain">                            ; </span><span class="identifier">tape</span><span class="plain"> / </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">FS</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">AND</span><span class="plain"> #%01000000                                      ; </span><span class="identifier">mask</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">just</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">EOF</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">searchForFile</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberLow</span><span class="plain">                      ; } </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberHigh</span><span class="plain">                     ; }</span>

    <span class="plain">.</span><span class="identifier">searchForSpecifiedBlock</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberLow</span><span class="plain">                      ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeNextBlockNumberLow</span><span class="plain">                         ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberHigh</span><span class="plain">                     ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeNextBlockNumberHigh</span><span class="plain">                        ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">safePrintFollowingMessage</span><span class="plain">                      ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">call</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"Searching"</span><span class="plain">,$0</span><span class="identifier">D</span><span class="plain">,0                             ;</span>

        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">A</span><span class="plain">=$</span><span class="identifier">FF</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">searchForBlockCFSRFS</span><span class="plain">                           ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">data</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain">/</span><span class="identifier">RFS</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberHigh</span><span class="plain">                     ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberLow</span><span class="plain">                      ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeNextBlockNumberLow</span><span class="plain">                         ; </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">tapeNextBlockNumberHigh</span><span class="plain">                        ; </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberLow</span><span class="plain">                      ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberHigh</span><span class="plain">                     ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">checksumResult</span><span class="plain">                                 ; </span><span class="identifier">checksum</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ;</span>
        <span class="identifier">LDX</span><span class="plain"> #&lt;(.</span><span class="identifier">fsFilename</span><span class="plain">-1)                               ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyToSoughtFilename</span><span class="plain">                           ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">fsFilename</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">filenameToSearchFor</span>
    <span class="plain">+</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                                ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> 0=</span><span class="identifier">CFS</span><span class="plain">; 2=</span><span class="identifier">RFS</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">clearBlockFlagsAndExit</span><span class="plain">                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BVS</span><span class="plain"> .</span><span class="identifier">clearBlockFlagsAndExit</span><span class="plain">                         ;</span>

    <span class="plain">.</span><span class="identifier">fileNotFoundError</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">D6</span><span class="plain">                                           ; </span><span class="identifier">Error</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"File not found"</span><span class="plain">,0                            ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">clearBlockFlagsAndExit</span>
        <span class="identifier">LDY</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">Y</span><span class="plain">=$</span><span class="identifier">FF</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">fsLastBlockReadFlagsCopy</span><span class="plain">                       ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">exec0EntryPoint</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">closeExecFiles</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; .</span><span class="identifier">tempWorkspaceE6</span><span class="plain"> = </span><span class="identifier">Y</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">execFileHandle</span><span class="plain">                                 ; </span><span class="identifier">EXEC</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">execFileHandle</span><span class="plain">                                 ; </span><span class="identifier">EXEC</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">via</span><span class="plain"> </span><span class="identifier">OSFIND</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSFIND</span><span class="plain">                                         ;</span>
    <span class="plain">+</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">tempWorkspaceE6</span><span class="plain">                                ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">= </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">Y</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=0 </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">exit</span><span class="plain"> </span><span class="reserved">else</span>
        <span class="identifier">LDA</span><span class="plain"> #$40                                            ; </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">value</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">opening</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSFIND</span><span class="plain">                                         ; </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">fileNotFoundError</span><span class="plain">                              ; </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">=0 </span><span class="character">'File not found'</span><span class="plain"> </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">execFileHandle</span><span class="plain">                                 ; </span><span class="identifier">EXEC</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">readABlock</span>
        <span class="identifier">LDX</span><span class="plain"> #&lt;(.</span><span class="identifier">bgetFilename</span><span class="plain">-1)                             ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">copyToSoughtFilename</span><span class="plain">                           ; </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">bgetFilename</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">filenameToSearchFor</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">readBlockHeader</span><span class="plain">                                ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">header</span>
    <span class="plain">.</span><span class="identifier">checkLockedFlag</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsBlockFlagByte</span><span class="plain">                                ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">/2 </span><span class="identifier">bit</span><span class="plain"> 0 </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">locked</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">notLocked</span><span class="plain">                                      ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">skip</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">instruction</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">fileLocked</span><span class="plain">                                     ; </span><span class="character">'locked'</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">routine</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">notLocked</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">nextBGETBlockLow</span><span class="plain">                               ; </span><span class="identifier">Expected</span><span class="plain"> </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberLow</span><span class="plain">                      ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">nextBGETBlockHigh</span><span class="plain">                              ; </span><span class="identifier">expected</span><span class="plain"> </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberHigh</span><span class="plain">                     ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">loadAddressLow</span><span class="plain">                                 ; }</span>
        <span class="identifier">LDA</span><span class="plain"> #$0</span><span class="identifier">A</span><span class="plain">                                            ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">loadAddressMid1</span><span class="plain">                                ; } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> $</span><span class="identifier">FFFF0A00</span>
        <span class="identifier">LDA</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">loadAddressMid2</span><span class="plain">                                ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">loadAddressHigh</span><span class="plain">                                ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">resetFSState</span><span class="plain">                                   ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">loadFileFromTape</span><span class="plain">                               ; </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">tape</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">searchForBlock</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">non</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOrRS423InputBuffer</span><span class="plain"> + $</span><span class="identifier">FF</span><span class="plain">                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">buffer</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">lastCharacterOfCurrentlyResidentBlock</span><span class="plain">          ; </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">resident</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">incrementBlockNumber</span><span class="plain">                           ; </span><span class="identifier">inc</span><span class="plain">. </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">nextBGETBlockLow</span><span class="plain">                               ; </span><span class="identifier">expected</span><span class="plain"> </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">nextBGETBlockHigh</span><span class="plain">                              ; </span><span class="identifier">expected</span><span class="plain"> </span><span class="identifier">BGET</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>

        <span class="identifier">LDX</span><span class="plain"> #2                                              ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsBlockLengthLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                             ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">/</span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeInputCurrentBlockSizeLow</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                 ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">values</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">above</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">BPL</span><span class="plain"> -                                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=-1 ($</span><span class="identifier">FF</span><span class="plain">)</span>

        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">blockFlagOfCurrentlyResidentBlock</span><span class="plain">              ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">resident</span><span class="plain"> </span><span class="identifier">block</span>
        <span class="identifier">BPL</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">block</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">don</span><span class="character">'t print newline)</span>
        <span class="character">JSR .printReturnSafely                              ; print newline if needed</span>
    <span class="character">+</span>
        <span class="character">JMP .cancelTapeOperation                            ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.searchForBlock</span>
        <span class="character">JSR .searchForSpecifiedBlock                        ; search for a specified block</span>
        <span class="character">BNE .checkLockedFlag                                ; ALWAYs branch (check for locked condition)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.checkForBlockMarker</span>
        <span class="character">CMP #.synchronisationByte                           ; check for synchronising byte $2A (at start of first block)</span>
        <span class="character">BEQ .startOfBlock                                   ; if (found synchronising byte for first block) then branch</span>
        <span class="character">CMP #.middleBlockHeaderByte                         ; check for header byte for a middle block</span>
        <span class="character">BNE .clearCatalogueStatus2                          ; if (middle block header not found) then branch (error '</span><span class="identifier">Bad</span><span class="plain"> </span><span class="identifier">ROM</span><span class="character">')</span>

        <span class="character">INC .fsBlockNumberLow                               ; block number</span>
        <span class="character">BNE +                                               ;</span>
        <span class="character">INC .fsBlockNumberHigh                              ; block number high</span>
    <span class="character">+</span>
        <span class="character">LDX #$FF                                            ; X=$FF</span>
        <span class="character">BIT .allBitsSet                                     ; set N and V flags</span>
        <span class="character">BNE .clearChecksumTapeProgress                      ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.clearCatalogueStatus2</span>
        <span class="character">LDA #%11110111                                      ; }</span>
        <span class="character">JSR .logicalANDWithStatusByteAndStore               ; } clear current catalogue status</span>

    <span class="character">.badRomError</span>
        <span class="character">BRK                                                 ; cause error</span>
        <span class="character">!byte $D7                                           ; error number</span>
        <span class="character">!text "Bad ROM"                                     ; message</span>
        <span class="character">!byte 0                                             ; terminator</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.readTapeBlockHeader</span>
        <span class="character">LDY #$FF                                            ;</span>
        <span class="character">JSR .storeFileHandleMotorOn                         ; switch Motor on</span>
        <span class="character">LDA #1                                              ; A=1</span>
        <span class="character">STA .tapeProgressState                              ; progress flag</span>
        <span class="character">JSR .flipRelayOffOnAndDeactivateRequestToSend       ; control serial system</span>

    <span class="character">-</span>
        <span class="character">JSR .checkForEscapeDuringCassetteOperation          ; confirm ESC not set and CFS not executing</span>
        <span class="character">LDA #3                                              ; A=3</span>
        <span class="character">CMP .tapeProgressState                              ; progress flag</span>
        <span class="character">BNE -                                               ; back until .tapeProgressState=3</span>

    <span class="character">.startOfBlock</span>
        <span class="character">LDY #0                                              ; Y=0</span>
        <span class="character">JSR .setChecksumBytesToY                            ; zero checksum bytes</span>

        <span class="character">; read filename</span>
    <span class="character">-</span>
        <span class="character">JSR .readByteFromTapeOrROM                          ; get character from file and do CRC</span>
        <span class="character">BVC .reachedEndOfHeader                             ; if (V clear) then branch</span>
        <span class="character">STA .fsFilename,Y                                   ; else store</span>
        <span class="character">BEQ +                                               ; or if A=0 then branch</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">CPY #11                                             ; if Y is not 11</span>
        <span class="character">BNE -                                               ; go back for next character</span>
        <span class="character">DEY                                                 ; Y=Y-1</span>

    <span class="character">+</span>
        <span class="character">; read rest of header</span>
        <span class="character">LDX #12                                             ; X=loop counter (from 12 to 31) to read rest of header</span>
    <span class="character">-</span>
        <span class="character">JSR .readByteFromTapeOrROM                          ; get character from file and do CRC</span>
        <span class="character">BVC .reachedEndOfHeader                             ; if (V clear) then branch</span>
        <span class="character">STA .fsFilename,X                                   ; else store byte</span>
        <span class="character">INX                                                 ; X=X+1</span>
        <span class="character">CPX #$1F                                            ; check X for 31</span>
        <span class="character">BNE -                                               ; if (X is not 31) then loop back</span>

    <span class="character">.reachedEndOfHeader</span>
        <span class="character">TYA                                                 ; }</span>
        <span class="character">TAX                                                 ; } X=Y</span>
        <span class="character">LDA #0                                              ; A=0</span>
        <span class="character">STA .fsFilename,Y                                   ; store it</span>
        <span class="character">LDA .tapeChecksumA                                  ; CRC workspace</span>
        <span class="character">ORA .tapeChecksumB                                  ; CRC workspace</span>
        <span class="character">STA .checksumResult                                 ; Checksum result</span>

    <span class="character">.clearChecksumTapeProgress</span>
        <span class="character">JSR .zeroChecksumAndFSBufferFlag                    ; reset checksum etc</span>
        <span class="character">STY .tapeProgressState                              ; reset progress (Y=0)</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">BNE .exit32                                         ; if X is non-zero then branch (exit)</span>

    <span class="character">.readBlockHeader</span>
        <span class="character">LDA .tapeOrRomSwitch                                ; filing system flag 0=CFS; 2=RFS</span>
        <span class="character">BEQ .readTapeBlockHeader                            ; if cassette then block</span>

        <span class="character">; Read ROM file header</span>
        <span class="character">; See NAUG Section 17.5.6 Page 317 for *ROM data format</span>
    <span class="character">-</span>
        <span class="character">JSR .readByteFromRFSROMorPHROM                      ; read RFS data rom or Phrom</span>
        <span class="character">CMP #.finalBlockHeaderByte                          ; check for ROM file terminator</span>
        <span class="character">BNE .checkForBlockMarker                            ; if (not terminator) then branch</span>

        <span class="character">; terminator found</span>
        <span class="character">LDA #%00001000                                      ; A=isolating bit 3 (catalogue status)</span>
        <span class="character">AND .tapeROMFSStatusByte                            ; check catalogue status</span>
        <span class="character">BEQ +                                               ; if (clear) then branch (skip next instruction)</span>
        <span class="character">JSR .saveFlagsPrintCR                               ; print CR safely</span>
    <span class="character">+</span>
        <span class="character">JSR .readByteFromROMOrPHROM                         ; get byte from data Rom</span>
        <span class="character">BCC -                                               ; if carry clear then branch (loop back and try again)</span>
        <span class="character">CLV                                                 ; clear overflow flag</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; read character from tape or ROM</span>
    <span class="character">.readByteFromTapeOrROM</span>
        <span class="character">LDA .tapeOrRomSwitch                                ; filing system flag 0=CFS; 2=RFS</span>
        <span class="character">BEQ +                                               ; if cassette then branch</span>
        <span class="character">TXA                                                 ; }</span>
        <span class="character">PHA                                                 ; }</span>
        <span class="character">TYA                                                 ; } save X and Y</span>
        <span class="character">PHA                                                 ; }</span>
        <span class="character">JSR .readByteFromRFSROMorPHROM                      ; read RFS data rom or Phrom</span>
        <span class="character">STA .fsTempStorageBD                                ; put it in temporary storage</span>
        <span class="character">LDA #$FF                                            ; A=$FF</span>
        <span class="character">STA .filingSystemBufferFlag                         ; filing system buffer flag</span>
        <span class="character">PLA                                                 ; }</span>
        <span class="character">TAY                                                 ; }</span>
        <span class="character">PLA                                                 ; } restore X and Y</span>
        <span class="character">TAX                                                 ; }</span>
    <span class="character">+</span>
        <span class="character">JSR .waitForTapeByteProcessingToFinish              ; check for Escape and loop till bit 7 of FS buffer flag=1</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.updateCRC</span>
        <span class="character">PHP                                                 ; save flags on stack</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">SEC                                                 ; }</span>
        <span class="character">ROR .tapeCRCBitCounter                              ; } Set top bit of CRC bit counter</span>
        <span class="character">EOR .tapeChecksumB                                  ; CRC workspace</span>
        <span class="character">STA .tapeChecksumB                                  ; CRC workspace</span>
    <span class="character">-</span>
        <span class="character">LDA .tapeChecksumB                                  ; CRC workspace</span>
        <span class="character">ROL                                                 ; A=A*2 C=bit 7</span>
        <span class="character">BCC +                                               ;</span>
        <span class="character">ROR                                                 ; A=A/2</span>
        <span class="character">EOR #%00001000                                      ;</span>
        <span class="character">STA .tapeChecksumB                                  ; CRC workspace</span>
        <span class="character">LDA .tapeChecksumA                                  ; CRC workspace</span>
        <span class="character">EOR #%00010000                                      ;</span>
        <span class="character">STA .tapeChecksumA                                  ; CRC workspace</span>
        <span class="character">SEC                                                 ; set carry flag</span>
    <span class="character">+</span>
        <span class="character">ROL .tapeChecksumA                                  ; CRC workspace</span>
        <span class="character">ROL .tapeChecksumB                                  ; CRC workspace</span>
        <span class="character">LSR .tapeCRCBitCounter                              ; shift CRC bit counter right</span>
        <span class="character">BNE -                                               ; if (eight bits not processed) then branch</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">PLP                                                 ; get back flags</span>
    <span class="character">.exit32</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.resetFSState</span>
        <span class="character">LDA #0                                              ; A=0</span>
    <span class="character">.resetFSState2</span>
        <span class="character">STA .fsTempStorageBD                                ; .fsTempStorageBD = character temporary storage buffer = 0</span>
        <span class="character">LDX #0                                              ; X=0</span>
        <span class="character">STX .fsTempStorage                                  ; file status or temporary store</span>
        <span class="character">BVC +                                               ;</span>
        <span class="character">LDA .fsBlockLengthLow                               ; block length</span>
        <span class="character">ORA .fsBlockLengthHigh                              ; block length high</span>
        <span class="character">BEQ +                                               ; if (block number is zero) then branch</span>
        <span class="character">LDX #4                                              ; X=4 (block number not zero)</span>
    <span class="character">+</span>
        <span class="character">STX .tapeProgressState                              ; filename length/progress flag</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.saveABlock</span>
        <span class="character">PHP                                                 ; save flags on stack</span>
        <span class="character">LDX #3                                              ; X=loop counter</span>
        <span class="character">LDA #0                                              ; A=value to store</span>
    <span class="character">-</span>
        <span class="character">STA .fsSpareByteA,X                                 ; clear the four spare bytes of file system block</span>
        <span class="character">DEX                                                 ; X=X-1</span>
        <span class="character">BPL -                                               ;</span>

        <span class="character">LDA .fsBlockNumberLow                               ; block number</span>
        <span class="character">ORA .fsBlockNumberHigh                              ; block number high</span>
        <span class="character">BNE .waitForInterblockGap                           ; if (block is not zero) then branch</span>
        <span class="character">JSR .waitFiveSeconds                                ; generate a 5 second delay</span>
        <span class="character">BEQ +                                               ; ALWAYs branch</span>

    <span class="character">.waitForInterblockGap</span>
        <span class="character">JSR .generateInterBlockGapDelay                     ; generate delay set by interblock gap</span>

        <span class="character">; initialise and save value $2A to tape</span>
    <span class="character">+</span>
        <span class="character">LDA #.synchronisationByte                           ; A=synchronisation byte (byte to save to tape)</span>
        <span class="character">STA .fsTempStorageBD                                ; store it in temporary store</span>
        <span class="character">JSR .zeroChecksumAndFSBufferFlag                    ; initialise checksum and file system buffer flag</span>
        <span class="character">JSR .activateRequestToSend                          ; request send to tape</span>
        <span class="character">JSR .waitForTapeByteProcessingToFinish              ; save byte to tape</span>
        <span class="character">DEY                                                 ; Y=Y-1</span>

        <span class="character">; save filename</span>
    <span class="character">-</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">LDA .filenameToSearchFor,Y                          ; move sought filename</span>
        <span class="character">STA .fsFilename,Y                                   ; into filename block</span>
        <span class="character">JSR .saveByteAToTapeAndUpdateCRC                    ; transfer byte to CFS and do CRC</span>
        <span class="character">BNE -                                               ; if (filename not yet complete) then branch (do it again)</span>

        <span class="character">; save rest of header:</span>
        <span class="character">;   load address      (4 bytes)</span>
        <span class="character">;   execution address (4 bytes)</span>
        <span class="character">;   block number      (2 bytes)</span>
        <span class="character">;   block length      (2 bytes)</span>
        <span class="character">;   block flag byte   (1 byte)</span>
        <span class="character">;   spare bytes       (4 bytes)</span>
        <span class="character">LDX #.fsLoadAddressLow - .fsFilename                ; X=offset to load address</span>
    <span class="character">-</span>
        <span class="character">LDA .fsFilename,X                                   ; get filename byte</span>
        <span class="character">JSR .saveByteAToTapeAndUpdateCRC                    ; transfer byte to CFS and do CRC</span>
        <span class="character">INX                                                 ; X=X+1</span>
        <span class="character">CPX #.fsChecksumLow - .fsFilename                   ; until X reaches the end of the header block (just before the start of the two checksum bytes)</span>
        <span class="character">BNE -                                               ;</span>

        <span class="character">JSR .saveChecksumToTape                             ; save checksum to TAPE reset buffer flag</span>
        <span class="character">LDA .fsBlockLengthLow                               ; block length</span>
        <span class="character">ORA .fsBlockLengthHigh                              ; block length high</span>
        <span class="character">BEQ .saveFinalTwoBytes                              ; if (block length is zero) then branch</span>

        <span class="character">LDY #0                                              ; else Y=0</span>
        <span class="character">JSR .setChecksumBytesToY                            ; zero checksum bytes</span>

    <span class="character">-</span>
        <span class="character">LDA (.loadAddressLow),Y                             ; get a data byte to save</span>
        <span class="character">JSR .checkLoadAddressIsForSecondProcessor           ; check if load address is from second processor</span>
        <span class="character">BEQ +                                               ; if (not from second processor) then branch</span>
        <span class="character">LDX .tubeULADataRegister3                           ; read byte from second processor</span>
    <span class="character">+</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">JSR .saveByteAToTapeAndUpdateCRC                    ; transfer byte to CFS and do CRC</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">CPY .fsBlockLengthLow                               ; check block length</span>
        <span class="character">BNE -                                               ; if (block not done yet) then branch (loop back)</span>

        <span class="character">JSR .saveChecksumToTape                             ; save checksum to TAPE</span>

    <span class="character">.saveFinalTwoBytes</span>
        <span class="character">JSR .waitForTapeByteProcessingToFinish              ; save byte</span>
        <span class="character">JSR .waitForTapeByteProcessingToFinish              ; save byte</span>
        <span class="character">JSR .resetACIA                                      ; reset ACIA</span>

        <span class="character">LDA #1                                              ; A=1</span>
        <span class="character">JSR .generateDelay                                  ; generate 0.1 second delay</span>
        <span class="character">PLP                                                 ; get back flags</span>
        <span class="character">JSR .updateBlockFlagAndDisplayProgress              ; update block flag, PRINT filename (and address if reqd)</span>
        <span class="character">BIT .fsBlockFlagByte                                ; block flag</span>
        <span class="character">BPL +                                               ; is this last block (bit 7 set)?</span>
        <span class="character">PHP                                                 ; save flags on stack</span>
        <span class="character">JSR .waitFiveSeconds                                ; generate a 5 second delay</span>
        <span class="character">JSR .beepCancelAndPrintReturn                       ; sound bell and abort</span>
        <span class="character">PLP                                                 ; get back flags</span>
    <span class="character">+</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.saveByteAToTapeAndUpdateCRC</span>
        <span class="character">JSR .saveByteAToTape                                ; save byte</span>
        <span class="character">JMP .updateCRC                                      ; update CRC</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.saveChecksumToTape</span>
        <span class="character">LDA .tapeChecksumB                                  ; CRC workspace</span>
        <span class="character">JSR .saveByteAToTape                                ; save byte to buffer, transfer to CFS and reset flag</span>
        <span class="character">LDA .tapeChecksumA                                  ; CRC workspace</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.saveByteAToTape</span>
        <span class="character">STA .fsTempStorageBD                                ; store A in temporary buffer</span>
        <span class="character">; fall through...</span>

    <span class="character">.waitForTapeByteProcessingToFinish</span>
        <span class="character">JSR .checkForEscapeDuringCassetteOperation          ; confirm ESC not set and CFS not executing</span>
        <span class="character">BIT .filingSystemBufferFlag                         ; check filing system buffer flag</span>
        <span class="character">BPL .waitForTapeByteProcessingToFinish              ; loop until bit 7 of .filingSystemBufferFlag is set</span>

        <span class="character">LDA #0                                              ; A=0</span>
        <span class="character">STA .filingSystemBufferFlag                         ; filing system buffer flag</span>
        <span class="character">LDA .fsTempStorageBD                                ; get temporary store byte</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.waitFiveSeconds</span>
        <span class="character">LDA #50                                             ; Set A for 50 tenths of a second delay</span>
        <span class="character">BNE .generateDelay                                  ; ALWAYs branch. generate delay 100ms *A (5 seconds)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Delay for the interblock gap time</span>
    <span class="character">.generateInterBlockGapDelay</span>
        <span class="character">LDA .tapeInterBlockGapTEMP                          ; get current interblock flag</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
    <span class="character">; Wait for A/10 seconds, or until ESCAPE is pressed</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       A = amount of delay in 10ths of a second</span>
    <span class="character">;</span>
    <span class="character">.generateDelay</span>
        <span class="character">LDX #5                                              ; X=loop counter</span>
    <span class="character">--</span>
        <span class="character">STA .verticalSyncCounter                            ; set vsync counter</span>
    <span class="character">-</span>
        <span class="character">JSR .checkForEscapeDuringCassetteOperation          ; confirm ESC not set and CFS not executing</span>
        <span class="character">BIT .verticalSyncCounter                            ; check vsync counter (decremented 50 times a second)</span>
        <span class="character">BPL -                                               ; if not negative then branch back</span>
        <span class="character">DEX                                                 ; X--</span>
        <span class="character">BNE --                                              ;</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.generateScreenReports</span>
        <span class="character">LDA .fsBlockNumberLow                               ; block number low</span>
        <span class="character">ORA .fsBlockNumberHigh                              ; block number high</span>
        <span class="character">BEQ .newlineAndContinue                             ; if block number is zero then branch (print newline and continue)</span>
        <span class="character">BIT .fsLastBlockReadFlagsCopy                       ; copy of last read block flags</span>
        <span class="character">BPL .updateBlockFlagAndDisplayProgress              ; update block flag, PRINT filename (and address if required)</span>

    <span class="character">.newlineAndContinue</span>
        <span class="character">JSR .printReturnSafely                              ; print newline if needed</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.updateBlockFlagAndDisplayProgress</span>
        <span class="character">LDY #0                                              ; Y=0</span>
        <span class="character">STY .tapeCurrentBlockFlag                           ; current block flag</span>
        <span class="character">LDA .fsBlockFlagByte                                ; get block flag byte</span>
        <span class="character">STA .fsLastBlockReadFlagsCopy                       ; store as copy of last read block flag</span>
        <span class="character">JSR .checkIfSafeToPrintMessage                      ; check if free to print message</span>
        <span class="character">BEQ .exit33                                         ; if (not safe to print messages) then branch (return)</span>

        <span class="character">;</span>
        <span class="character">; print just a carriage return, to return text cursor to the start of the current line</span>
        <span class="character">; (without emitting a linefeed to go down to the next line)</span>
        <span class="character">;</span>
        <span class="character">LDA #.charRETURN                                    ; carriage return</span>
        <span class="character">JSR .OSWRCH                                         ; print it (note no linefeed; so text will overwrite any previous block'</span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">message</span><span class="plain">)</span>

        <span class="plain">;</span>
        <span class="plain">; </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">printable</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain">, </span><span class="identifier">or</span><span class="plain"> ? </span><span class="identifier">otherwise</span>
        <span class="plain">;</span>
    <span class="plain">.</span><span class="identifier">filenameLoop</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsFilename</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                                   ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> (</span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">terminated</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">filenameDone</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">ended</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charSPACE</span><span class="plain">                                     ; }</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">displayQuestionMark</span><span class="plain">                            ; } </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">control</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">show</span><span class="plain"> </span><span class="character">'?'</span><span class="plain">)</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charDELETE</span><span class="plain">                                    ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">less</span><span class="plain"> </span><span class="identifier">than</span><span class="plain"> </span><span class="identifier">DELETE</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">displayPrintableCharacter</span><span class="plain">                      ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">printable</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
    <span class="plain">.</span><span class="identifier">displayQuestionMark</span>
        <span class="identifier">LDA</span><span class="plain"> #.</span><span class="identifier">charQUESTIONMARK</span><span class="plain">                              ; </span><span class="identifier">A</span><span class="plain">=</span><span class="character">'?'</span>
    <span class="plain">.</span><span class="identifier">displayPrintableCharacter</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSWRCH</span><span class="plain">                                         ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">it</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">filenameLoop</span><span class="plain">                                   ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">rest</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">filenameDone</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                                ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="reserved">switch</span><span class="plain"> (0=</span><span class="identifier">cassette</span><span class="plain">, 2=</span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain">)</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">tapeCurrentOptionsByte</span><span class="plain">                         ; </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OPTions</span>
        <span class="identifier">BVC</span><span class="plain"> .</span><span class="identifier">exit33</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span><span class="plain"> </span><span class="identifier">needed</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>

        <span class="plain">;</span>
        <span class="plain">; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">spaces</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 11 </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">total</span>
        <span class="plain">;</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printSpace</span><span class="plain">                                     ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">space</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
        <span class="identifier">CPY</span><span class="plain"> #11                                             ;</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">filenameDone</span><span class="plain">                                   ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Y</span><span class="plain">&lt;11) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">again</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">fill</span><span class="plain"> </span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">spaces</span><span class="plain">)</span>

        <span class="plain">;</span>
        <span class="plain">; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">;</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsBlockNumberLow</span><span class="plain">                               ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; </span><span class="identifier">remember</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printHexByte</span><span class="plain">                                   ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">hex</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">ASCII</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">fsBlockFlagByte</span><span class="plain">                                ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (</span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">is</span><span class="plain"> </span><span class="character">'last block'</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">)</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">exit33</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">file</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>

        <span class="plain">;</span>
        <span class="plain">; </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">we</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">file</span>
        <span class="plain">; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">hex</span>
        <span class="plain">;</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">recall</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">X</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ;</span>
        <span class="identifier">ADC</span><span class="plain"> .</span><span class="identifier">fsBlockLengthHigh</span><span class="plain">                              ; </span><span class="identifier">add</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">total</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">high</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeFileLengthHigh</span><span class="plain">                             ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printSpaceThenHexByte</span><span class="plain">                          ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">hex</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">ASCII</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsBlockLengthLow</span><span class="plain">                               ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeFileLengthLow</span><span class="plain">                              ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> (</span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printHexByte</span><span class="plain">                                   ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">hex</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">ASCII</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">tapeCurrentOptionsByte</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OPTions</span>
        <span class="identifier">BVC</span><span class="plain"> .</span><span class="identifier">exit33</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 6 </span><span class="identifier">clear</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span><span class="plain"> </span><span class="identifier">required</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>

        <span class="plain">;</span>
        <span class="plain">; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">spaces</span>
        <span class="plain">;</span>
        <span class="identifier">LDX</span><span class="plain"> #4                                              ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printSpace</span><span class="plain">                                     ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">space</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ;</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> 4 </span><span class="identifier">spaces</span>

        <span class="plain">;</span>
        <span class="plain">; </span><span class="identifier">display</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span><span class="plain">, </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">space</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">executable</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="plain">;</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">fsLoadAddressHigh</span><span class="plain"> - .</span><span class="identifier">fsFilename</span><span class="plain">               ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printFourByteAddress</span><span class="plain">                           ; </span><span class="identifier">print</span><span class="plain"> 4 </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">header</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printSpace</span><span class="plain">                                     ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">space</span>
        <span class="identifier">LDX</span><span class="plain"> #.</span><span class="identifier">fsExecutionAddressHigh</span><span class="plain"> - .</span><span class="identifier">fsFilename</span><span class="plain">          ; </span><span class="identifier">X</span><span class="plain"> = </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">execution</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> (</span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">four</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">header</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> .</span><span class="identifier">fsFilename</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">printFourByteAddress</span>
        <span class="identifier">LDY</span><span class="plain"> #4                                              ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsFilename</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                   ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">header</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printHexByte</span><span class="plain">                                   ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">equivalent</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">hex</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">-1</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ;</span>
    <span class="plain">.</span><span class="identifier">exit33</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">promptToRecordOnTape</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                                ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> 0=</span><span class="identifier">CFS</span><span class="plain">; 2=</span><span class="identifier">RFS</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">F93C</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">badCommandError</span><span class="plain">                                ; </span><span class="reserved">else</span><span class="plain"> </span><span class="character">'Bad command error message'</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">zeroFileHandleMotorOn</span><span class="plain">                          ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">motor</span><span class="plain"> </span><span class="identifier">on</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">setupForCassetteWrite</span><span class="plain">                          ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">operation</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkIfSafeToPrintMessage</span><span class="plain">                      ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">free</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">message</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit33</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">exit</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">safePrintFollowingMessage</span><span class="plain">                      ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">call</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"RECORD then RETURN"</span><span class="plain">                          ; </span><span class="identifier">message</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">terminator</span>

    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkForEscapeDuringCassetteOperation</span><span class="plain">          ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">ESCAPE</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSRDCH</span><span class="plain">                                         ; </span><span class="identifier">wait</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">keypress</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charRETURN</span><span class="plain">                                    ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">RETURN</span><span class="plain"> </span><span class="identifier">key</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">RETURN</span><span class="plain"> </span><span class="identifier">key</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">test</span><span class="plain"> </span><span class="identifier">again</span><span class="plain">)</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">OSNEWL</span><span class="plain">                                         ; </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">Carriage</span><span class="plain"> </span><span class="identifier">RETURN</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">LINE</span><span class="plain"> </span><span class="identifier">FEED</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">incrementLoadAddress</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">loadAddressMid1</span><span class="plain">                                ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">page</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ;</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">loadAddressMid2</span><span class="plain">                                ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">higher</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">needed</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ;</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">loadAddressHigh</span><span class="plain">                                ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">higher</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">needed</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">printSpaceThenHexByte</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printSpace</span><span class="plain">                                     ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">space</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Print</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">version</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">hex</span><span class="plain"> </span><span class="identifier">value</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">print</span>
    <span class="plain">;       </span><span class="identifier">Preserves</span><span class="plain"> </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">Y</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">printHexByte</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; } </span><span class="identifier">divide</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> 16 </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">put</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printHexDigit</span><span class="plain">                                  ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">its</span><span class="plain"> </span><span class="identifier">ASCII</span><span class="plain"> </span><span class="identifier">equivalent</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">A</span>
    <span class="plain">.</span><span class="identifier">printHexDigit</span>
        <span class="identifier">CLC</span><span class="plain">                                                 ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">AND</span><span class="plain"> #%00001111                                      ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain">. </span><span class="identifier">A</span><span class="plain">=0-15</span>
        <span class="identifier">ADC</span><span class="plain"> #.</span><span class="identifier">charZERO</span><span class="plain">                                      ; </span><span class="identifier">A</span><span class="plain"> = $30 </span><span class="identifier">to</span><span class="plain"> $3</span><span class="identifier">F</span>
        <span class="identifier">CMP</span><span class="plain"> #.</span><span class="identifier">charNINE</span><span class="plain"> + 1                                  ; }</span>
        <span class="identifier">BCC</span><span class="plain"> .</span><span class="identifier">writeCharJumper</span><span class="plain">                                ; } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> &lt;= </span><span class="identifier">ASC</span><span class="plain">(</span><span class="character">'9'</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">print</span>
        <span class="identifier">ADC</span><span class="plain"> #.</span><span class="identifier">charA</span><span class="plain"> - (.</span><span class="identifier">charNINE</span><span class="plain"> + 1) - 1                   ; </span><span class="identifier">Convert</span><span class="plain"> $3</span><span class="identifier">A</span><span class="plain">-$3</span><span class="identifier">F</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=$41-$46 (</span><span class="character">'A'</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="character">'F'</span><span class="plain">)</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">.</span><span class="identifier">writeCharJumper</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">OSWRCH</span><span class="plain">                                        ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">return</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">printSpace</span>
        <span class="identifier">LDA</span><span class="plain"> #.</span><span class="identifier">charSPACE</span><span class="plain">                                     ; </span><span class="identifier">A</span><span class="plain">=</span><span class="character">' '</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">writeCharJumper</span><span class="plain">                                ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">it</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkForEscapeDuringCassetteOperation</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">tapeCritical</span><span class="plain">                                   ; </span><span class="identifier">first</span><span class="plain"> </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">critical</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">skipESCAPECheck</span><span class="plain">                                ; </span><span class="identifier">branch</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">critical</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">escapeFlag</span><span class="plain">                                     ; }</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">foundEscapeCondition</span><span class="plain">                           ; } </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">condition</span><span class="plain"> </span><span class="identifier">found</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
    <span class="plain">.</span><span class="identifier">skipESCAPECheck</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">foundEscapeCondition</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">clearCatalogueStatus</span><span class="plain">                           ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">catalogue</span><span class="plain"> </span><span class="identifier">status</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">cancelTapeOperation</span><span class="plain">                            ;</span>
        <span class="identifier">LDA</span><span class="plain"> #126                                            ; }</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSBYTE</span><span class="plain">                                         ; } </span><span class="identifier">Acknowledge</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">condition</span>
    <span class="plain">.</span><span class="identifier">escapeError</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ; </span><span class="identifier">cause</span><span class="plain"> </span><span class="identifier">error</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $11                                           ; </span><span class="identifier">error</span><span class="plain"> 17</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"Escape"</span><span class="plain">                                      ; </span><span class="identifier">message</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">terminator</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> = 0 </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">;       </span><span class="identifier">otherwise</span><span class="plain"> </span><span class="identifier">show</span><span class="plain"> </span><span class="identifier">messages</span>
    <span class="plain">.</span><span class="identifier">loadFileFromTape</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">safePrintFollowingMessage</span><span class="plain">                      ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">call</span>

        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> 13,</span><span class="string">"Loading"</span><span class="plain">,13                               ; </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">text</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">terminator</span>

    <span class="plain">+</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockFlag</span><span class="plain">                           ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">LDX</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">X</span><span class="plain">=$</span><span class="identifier">FF</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">checksumResult</span><span class="plain">                                 ; </span><span class="identifier">Checksum</span><span class="plain"> </span><span class="identifier">result</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">checksumErrorCheck</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">checksum</span><span class="plain"> </span><span class="identifier">failed</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">compareFilenames</span><span class="plain">                               ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">header</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">matches</span><span class="plain"> </span><span class="identifier">searched</span>
                                                            <span class="plain">; </span><span class="identifier">filename</span><span class="plain">.</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">LDX</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">X</span><span class="plain">=$</span><span class="identifier">FF</span>
        <span class="identifier">LDY</span><span class="plain"> #&lt;.</span><span class="identifier">fileError</span><span class="plain">                                    ; }</span>
        <span class="identifier">LDA</span><span class="plain"> #&gt;.</span><span class="identifier">fileError</span><span class="plain">                                    ; } </span><span class="identifier">YA</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="character">'File?'</span><span class="plain"> </span><span class="identifier">error</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">printNewlineThenReportError</span><span class="plain">                    ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">filenames</span><span class="plain"> </span><span class="identifier">don</span><span class="character">'t match) then branch (report a query unexpected file name)</span>

    <span class="character">.checksumErrorCheck</span>
        <span class="character">LDY #&lt;.dataError                                    ; making Y/A point to '</span><span class="identifier">Data</span><span class="character">' for CRC error</span>
        <span class="character">LDA .checksumResult                                 ; Checksum result</span>
        <span class="character">BEQ .noChecksumError                                ; if (no checksum error) then branch</span>
        <span class="character">LDA #&gt;.dataError                                    ; point to dataError</span>
        <span class="character">BNE .printNewlineThenReportError                    ; ALWAYs branch (to report issue)</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.noChecksumError</span>
        <span class="character">LDA .fsBlockNumberLow                               ; block number</span>
        <span class="character">CMP .tapeCurrentBlockNumberLow                      ; current block number low</span>
        <span class="character">BNE .reportBlockError                               ; if (block numbers low byte dont match) then branch</span>
        <span class="character">LDA .fsBlockNumberHigh                              ; block number high</span>
        <span class="character">CMP .tapeCurrentBlockNumberHigh                     ; current block number high</span>
        <span class="character">BEQ .blockNumbersMatch                              ; if (block numbers high byte matches) then branch</span>

    <span class="character">.reportBlockError</span>
        <span class="character">LDY #&lt;.blockError                                   ; } an error has occurred</span>
        <span class="character">LDA #&gt;.blockError                                   ; } point AY to '</span><span class="identifier">Block</span><span class="plain">?</span><span class="character">' error (unexpected block number)</span>
                                                            <span class="character">;</span>
    <span class="character">.printNewlineThenReportError</span>
        <span class="character">PHA                                                 ; }</span>
        <span class="character">TYA                                                 ; }</span>
        <span class="character">PHA                                                 ; } save registers AYX on stack</span>
        <span class="character">TXA                                                 ; }</span>
        <span class="character">PHA                                                 ; }</span>
        <span class="character">JSR .newlineAndContinue                             ; print CR if indicated by current block flag</span>
        <span class="character">PLA                                                 ; }</span>
        <span class="character">TAX                                                 ; }</span>
        <span class="character">PLA                                                 ; } restore XYA from stack</span>
        <span class="character">TAY                                                 ; }</span>
        <span class="character">PLA                                                 ; }</span>
        <span class="character">BNE .checkIfWeShouldShowError                       ; ALWAYs branch</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.blockNumbersMatch</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">JSR .generateScreenReports                          ; report</span>
        <span class="character">JSR .waitForProgressLoop                            ; check loading progress, read another byte</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">LDA .tapeChecksumA                                  ; CRC workspace</span>
        <span class="character">ORA .tapeChecksumB                                  ; CRC workspace</span>
        <span class="character">BEQ .exit34                                         ;</span>
        <span class="character">LDY #&lt;.dataError                                    ; }</span>
        <span class="character">LDA #&gt;.dataError                                    ; } AY points to '</span><span class="identifier">Data</span><span class="plain">?</span><span class="character">'</span>

    <span class="character">.checkIfWeShouldShowError</span>
        <span class="character">DEC .tapeCurrentBlockFlag                           ; current block flag</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">BIT .tapeCritical                                   ; read tape critical flag</span>
        <span class="character">BMI .tidyUpAndDisplayError                          ; if active then branch</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">AND .tapeOrRomSwitch                                ; filing system flag 0=CFS; 2=RFS</span>
        <span class="character">BNE .tidyUpAndDisplayError                          ;</span>
        <span class="character">TXA                                                 ; A=X</span>
        <span class="character">AND #$11                                            ;</span>
        <span class="character">AND .tapeCurrentOptionsByte                         ; current OPTions</span>
        <span class="character">BEQ .ignoreError                                    ; ignore errors</span>

    <span class="character">.tidyUpAndDisplayError</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">STA .printSafeMessageAddressHigh                    ; store A</span>
        <span class="character">STY .printSafeMessageAddressLow                     ; store Y</span>
        <span class="character">JSR .exec0EntryPoint                                ; do *EXEC 0 to tidy up</span>
        <span class="character">LSR .tapeCritical                                   ; clear tape critical flag</span>
        <span class="character">JSR .beepAndCancelTapeOperation                     ; bell, reset ACIA and motor</span>
        <span class="character">JMP (.printSafeMessageAddressLow)                   ; display selected error report</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.ignoreError</span>
        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">INY                                                 ; Y=Y+1</span>
        <span class="character">BNE +                                               ;</span>
        <span class="character">CLC                                                 ; clear carry flag</span>
        <span class="character">ADC #1                                              ; Add 1</span>
    <span class="character">+</span>
        <span class="character">PHA                                                 ; save A on stack</span>
        <span class="character">TYA                                                 ; A=Y</span>
        <span class="character">PHA                                                 ; save Y on stack</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.safePrintFollowingMessage</span>
        <span class="character">JSR .checkIfSafeToPrintMessage                      ; check if free to print message</span>
        <span class="character">TAY                                                 ; Y=A</span>
        <span class="character">; fall through...</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; Print the message that follows the '</span><span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printFollowingMessage</span><span class="character">' instruction</span>
    <span class="character">;</span>
    <span class="character">; On Entry:</span>
    <span class="character">;       if Z set, then don'</span><span class="identifier">t</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">anything</span>
    <span class="plain">;       </span><span class="identifier">otherwise</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">each</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> .</span><span class="identifier">OSASCI</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">printFollowingMessage</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">printSafeMessageAddressLow</span><span class="plain">                     ; } </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">calling</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; } </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> .</span><span class="identifier">printSafeMessageAddressLow</span><span class="plain">/</span><span class="identifier">High</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">printSafeMessageAddressHigh</span><span class="plain">                    ; }</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
    <span class="plain">-</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">printSafeMessageAddressLow</span><span class="plain">                     ;</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ;</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">printSafeMessageAddressHigh</span><span class="plain">                    ;</span>
    <span class="plain">+</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="identifier">LDA</span><span class="plain"> (.</span><span class="identifier">printSafeMessageAddressLow</span><span class="plain">),</span><span class="identifier">Y</span><span class="plain">                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">print</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">printingFinished</span><span class="plain">                               ; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">terminator</span><span class="plain"> </span><span class="identifier">found</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">jump</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">calling</span><span class="plain"> </span><span class="identifier">function</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">message</span><span class="plain">)</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">restore</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">BEQ</span><span class="plain"> -                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> (</span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSASCI</span><span class="plain">                                         ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">JMP</span><span class="plain"> -                                               ; </span><span class="identifier">and</span><span class="plain"> </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">again</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">printingFinished</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">printSafeMessageAddressLow</span><span class="plain">                     ; </span><span class="identifier">increment</span><span class="plain"> </span><span class="identifier">pointers</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ;</span>
        <span class="identifier">INC</span><span class="plain"> .</span><span class="identifier">printSafeMessageAddressHigh</span><span class="plain">                    ;</span>
    <span class="plain">+</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">printSafeMessageAddressLow</span><span class="plain">)                   ; </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">message</span><span class="plain"> </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">condition</span><span class="plain"> </span><span class="identifier">occurs</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">compareFilenames</span>
        <span class="identifier">LDX</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">.</span><span class="identifier">checkNextCharacter</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">+1</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">filenameToSearchFor</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                          ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">sought</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">checkCharacter</span><span class="plain">                                 ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">non</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">)</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">length</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">exit</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">fsFilename</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                   ; </span><span class="identifier">A</span><span class="plain"> = </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">byte</span>
    <span class="plain">+</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkCharacter</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">isLetter</span><span class="plain">                                       ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">NOT</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">letter</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">fsFilename</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                   ; </span><span class="identifier">compare</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">character</span>
        <span class="identifier">BCS</span><span class="plain"> +                                               ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> (</span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">letter</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">AND</span><span class="plain"> #$</span><span class="identifier">DF</span><span class="plain">                                            ; </span><span class="identifier">convert</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">upper</span><span class="plain"> </span><span class="reserved">case</span>
    <span class="plain">+</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">checkNextCharacter</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> (</span><span class="identifier">filename</span><span class="plain"> </span><span class="identifier">characters</span><span class="plain"> </span><span class="identifier">match</span><span class="plain">) </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">next</span><span class="plain"> </span><span class="identifier">character</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">exit34</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">dataError</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">D8</span><span class="plain">                                           ; </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> .</span><span class="identifier">charRETURN</span><span class="plain">, </span><span class="string">"Data?"</span><span class="plain">                          ; </span><span class="identifier">message</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">terminator</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">postFileError</span><span class="plain">                                  ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">fileError</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">DB</span><span class="plain">                                           ; </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> .</span><span class="identifier">charRETURN</span><span class="plain">, </span><span class="string">"File?"</span><span class="plain">                          ; </span><span class="identifier">message</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">terminator</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">postFileError</span><span class="plain">                                  ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">blockError</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">DA</span><span class="plain">                                           ; </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> .</span><span class="identifier">charRETURN</span><span class="plain">, </span><span class="string">"Block?"</span><span class="plain">                         ; </span><span class="identifier">message</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">terminator</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">postFileError</span>
        <span class="identifier">LDA</span><span class="plain"> $</span><span class="identifier">BA</span><span class="plain">                                             ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">skipRewindTapeMessage</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> 0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">skipRewindTapeMessage</span><span class="plain">                          ; </span><span class="identifier">If</span><span class="plain"> </span><span class="identifier">X</span><span class="plain">=0 </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">retry</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> #%00100010                                      ; </span><span class="identifier">A</span><span class="plain">=$22</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">tapeCurrentOptionsByte</span><span class="plain">                         ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OPTions</span><span class="plain"> </span><span class="identifier">checking</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> 1 </span><span class="identifier">and</span><span class="plain"> 5</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">skipRewindTapeMessage</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">neither</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">retry</span><span class="plain">)</span>

        <span class="plain">; </span><span class="identifier">rewind</span><span class="plain"> </span><span class="identifier">tape</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">resetACIA</span><span class="plain">                                      ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">ACIA</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">printFollowingMessage</span><span class="plain">                          ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">message</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">charRETURN</span><span class="plain">                                   ; </span><span class="identifier">Carriage</span><span class="plain"> </span><span class="identifier">Return</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">charBELL</span><span class="plain">                                     ; </span><span class="identifier">Beep</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"Rewind tape"</span><span class="plain">                                 ; </span><span class="identifier">Message</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> .</span><span class="identifier">charRETURN</span><span class="plain">, .</span><span class="identifier">charRETURN</span><span class="plain">                      ; </span><span class="identifier">Carriage</span><span class="plain"> </span><span class="identifier">Return</span><span class="plain">, </span><span class="identifier">Carriage</span><span class="plain"> </span><span class="identifier">Return</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">terminator</span>
    <span class="plain">.</span><span class="identifier">exit35</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">skipRewindTapeMessage</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">saveFlagsPrintCR</span><span class="plain">                               ; </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">critical</span>
    <span class="plain">.</span><span class="identifier">waitForProgressLoop</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeProgressState</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">progress</span><span class="plain"> </span><span class="identifier">state</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit35</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="reserved">return</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkForEscapeDuringCassetteOperation</span><span class="plain">          ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">ESCAPE</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                                ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> 0=</span><span class="identifier">CFS</span><span class="plain">; 2=</span><span class="identifier">RFS</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">waitForProgressLoop</span><span class="plain">                            ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">CFS</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain">)</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">updateACIA</span><span class="plain">                                     ; </span><span class="reserved">else</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">etc</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">waitForProgressLoop</span><span class="plain">                            ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">again</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">beepAndCancelTapeOperation</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkIfSafeToPrintMessage</span><span class="plain">                      ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">free</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">print</span><span class="plain"> </span><span class="identifier">message</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">cancelTapeOperation</span><span class="plain">                            ;</span>
        <span class="identifier">LDA</span><span class="plain"> #7                                              ; </span><span class="identifier">beep</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSWRCH</span><span class="plain">                                         ;</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Cancel</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">operation</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">relinquish</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">Tube</span>
    <span class="plain">;       </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">motor</span>
    <span class="plain">;       </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">ACIA</span>
    <span class="plain">.</span><span class="identifier">cancelTapeOperation</span>
        <span class="identifier">LDA</span><span class="plain"> #$80                                            ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">secondProcessorTransfer</span><span class="plain">                        ; </span><span class="identifier">relinquish</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> (</span><span class="identifier">NAUG</span><span class="plain"> </span><span class="identifier">section</span><span class="plain"> 18.8, </span><span class="identifier">Page</span><span class="plain"> 339)</span>
        <span class="identifier">LDX</span><span class="plain"> #0                                              ;</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">controlMotor</span><span class="plain">                                   ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">off</span><span class="plain"> </span><span class="identifier">motor</span>
    <span class="plain">.</span><span class="identifier">cancelTapeOperation2</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">prevent</span><span class="plain"> </span><span class="identifier">IRQ</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">serialULARegisterCopy</span><span class="plain">                          ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">setting</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">serialULAControlRegister</span><span class="plain">                       ; </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">serial</span><span class="plain"> </span><span class="identifier">ULA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span><span class="plain"> </span><span class="identifier">setting</span>
        <span class="identifier">LDA</span><span class="plain"> #0                                              ; </span><span class="identifier">A</span><span class="plain">=0</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">rs423TimeoutCounter</span><span class="plain">                            ; </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">timeout</span><span class="plain"> </span><span class="identifier">counter</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">setupACIA</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stacksave</span><span class="plain"> </span><span class="identifier">flags</span>
    <span class="plain">+</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">resetACIA</span><span class="plain">                                      ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ACIA</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">rs423ControlRegisterCopy</span><span class="plain">                       ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">last</span><span class="plain"> </span><span class="identifier">setting</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ACIA</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">storeACIAAndPull</span><span class="plain">                               ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">Copy</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">before</span><span class="plain"> </span><span class="identifier">exit</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkForEscapeFlag</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">escapeFlag</span><span class="plain">                                     ; </span><span class="identifier">check</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain"> 7 </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">waitForRS423ToTimeout</span><span class="plain">                          ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">not</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ; </span><span class="reserved">return</span><span class="plain"> (</span><span class="identifier">ESCAPE</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">pending</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">claimSerialSystemForSequentialAccess</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOptionsByte</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">options</span><span class="plain"> </span><span class="identifier">byte</span>
                                                            <span class="plain">; </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">LOAD</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">SAVE</span><span class="plain"> </span><span class="identifier">operations</span>
                                                            <span class="plain">; </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">sequential</span><span class="plain"> </span><span class="identifier">access</span>

                                                            <span class="plain">; 0000   </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">errors</span><span class="plain">,          </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 0001   </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">,         </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 0010   </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">,      </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1000   </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">            </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1001   </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">          </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1010   </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">       </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1100   </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">            </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1101   </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">          </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1110   </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">       </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>

        <span class="identifier">ASL</span><span class="plain">                                                 ; }</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; }</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; } </span><span class="identifier">move</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">nybble</span>
        <span class="identifier">ASL</span><span class="plain">                                                 ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentOptionsByte</span><span class="plain">                         ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OPTions</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeInterBlockGap</span><span class="plain">                              ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">sequential</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">gap</span><span class="plain"> (&gt;0)</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">claimSerialSystem</span><span class="plain">                              ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">claimSerialSystemForLoadSave</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeOptionsByte</span><span class="plain">                                ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">options</span><span class="plain"> </span><span class="identifier">byte</span>
                                                            <span class="plain">; </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">LOAD</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">SAVE</span><span class="plain"> </span><span class="identifier">operations</span>
                                                            <span class="plain">; </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">nybble</span><span class="plain"> </span><span class="identifier">used</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">sequential</span><span class="plain"> </span><span class="identifier">access</span>

                                                            <span class="plain">; 0000   </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">errors</span><span class="plain">,          </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 0001   </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">,         </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 0010   </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">,      </span><span class="identifier">no</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1000   </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">            </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1001   </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">          </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1010   </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">       </span><span class="reserved">short</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1100   </span><span class="identifier">Ignore</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">            </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1101   </span><span class="identifier">Abort</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">          </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>
                                                            <span class="plain">; 1110   </span><span class="identifier">Retry</span><span class="plain"> </span><span class="identifier">after</span><span class="plain"> </span><span class="identifier">error</span><span class="plain">       </span><span class="reserved">long</span><span class="plain"> </span><span class="identifier">messages</span>

        <span class="identifier">AND</span><span class="plain"> #%11110000                                      ; </span><span class="identifier">clear</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">nybble</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeCurrentOptionsByte</span><span class="plain">                         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">OPTions</span>
        <span class="identifier">LDA</span><span class="plain"> #6                                              ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">interblock</span><span class="plain"> </span><span class="identifier">gap</span><span class="plain"> (6/10</span><span class="identifier">ths</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">second</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">claimSerialSystem</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeInterBlockGapTEMP</span><span class="plain">                          ; </span><span class="identifier">to</span><span class="plain"> 6</span>

        <span class="plain">; </span><span class="identifier">wait</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">timeout</span><span class="plain">, </span><span class="identifier">so</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">take</span><span class="plain"> </span><span class="identifier">over</span>
    <span class="plain">.</span><span class="identifier">waitForRS423ToTimeout</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">allow</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">briefly</span>
        <span class="identifier">PHP</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> (</span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">enabled</span><span class="plain">)</span>
        <span class="identifier">SEI</span><span class="plain">                                                 ; </span><span class="identifier">disable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">BIT</span><span class="plain"> .</span><span class="identifier">rs423ReadyFlag</span><span class="plain">                                 ;</span>
        <span class="identifier">BPL</span><span class="plain"> .</span><span class="identifier">checkForEscapeFlag</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">busy</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">escape</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">try</span><span class="plain"> </span><span class="identifier">again</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">rs423TimeoutCounter</span><span class="plain">                            ;</span>
        <span class="identifier">BMI</span><span class="plain"> .</span><span class="identifier">checkForEscapeFlag</span><span class="plain">                             ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> </span><span class="identifier">NOT</span><span class="plain"> </span><span class="identifier">timed</span><span class="plain"> </span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">escape</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">try</span><span class="plain"> </span><span class="identifier">again</span><span class="plain">)</span>

        <span class="identifier">LDA</span><span class="plain"> #1                                              ; }</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">rs423TimeoutCounter</span><span class="plain">                            ; } </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">RS423</span><span class="plain"> </span><span class="identifier">timeout</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">with</span><span class="plain"> </span><span class="identifier">one</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">indicate</span><span class="plain"> </span><span class="identifier">that</span><span class="plain"> </span><span class="identifier">cassette</span><span class="plain"> </span><span class="identifier">has</span><span class="plain"> 6850</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">resetACIA</span><span class="plain">                                      ; </span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">ACIA</span>
        <span class="identifier">PLP</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain"> (</span><span class="identifier">enabling</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain">)</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">resetACIA</span>
        <span class="identifier">LDA</span><span class="plain"> #%00000011                                      ; </span><span class="identifier">A</span><span class="plain">=3 (</span><span class="identifier">bits</span><span class="plain"> </span><span class="identifier">CR0</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">CR1</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">means</span><span class="plain"> </span><span class="character">'master reset'</span><span class="plain">)</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">storeAToACIARegister</span><span class="plain">                           ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">reset</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">activateRequestToSend</span>
        <span class="identifier">LDA</span><span class="plain"> #%00110000                                      ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">tapeSendingFlag</span><span class="plain">                                ; 8 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">word</span><span class="plain">, 2 </span><span class="identifier">stop</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain">, </span><span class="identifier">RTS</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> (</span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">active</span><span class="plain"> </span><span class="identifier">state</span><span class="plain">), </span><span class="identifier">transmit</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">enabled</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">set6850ControlRegister</span><span class="plain">                         ; </span><span class="identifier">ALWAYs</span><span class="plain"> </span><span class="identifier">branch</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">flipRelayOffOnAndDeactivateRequestToSend</span>
        <span class="identifier">LDA</span><span class="plain"> #%00000101                                      ; </span><span class="identifier">set</span><span class="plain"> .</span><span class="identifier">serialULAControlRegister</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">serialULAControlRegister</span><span class="plain">                       ; </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">sets</span><span class="plain"> </span><span class="identifier">transmit</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 300 </span><span class="identifier">baud</span>
                                                            <span class="plain">;           </span><span class="identifier">receive</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 19200 </span><span class="identifier">baud</span>
                                                            <span class="plain">;              </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">use</span>
                                                            <span class="plain">;                       </span><span class="identifier">motor</span><span class="plain"> </span><span class="identifier">off</span>
        <span class="identifier">LDX</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">loop</span><span class="plain"> </span><span class="identifier">counter</span>
    <span class="plain">-</span>
        <span class="identifier">DEX</span><span class="plain">                                                 ; } </span><span class="identifier">delay</span><span class="plain"> </span><span class="identifier">loop</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; }</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tapeSendingFlag</span><span class="plain">                                ; .</span><span class="identifier">tapeSendingFlag</span><span class="plain"> = 0</span>
        <span class="identifier">LDA</span><span class="plain"> #%10000101                                      ;     </span><span class="identifier">transmit</span><span class="plain"> </span><span class="identifier">baud</span><span class="plain"> </span><span class="identifier">rate</span><span class="plain"> 300 </span><span class="identifier">baud</span>
                                                            <span class="plain">;           </span><span class="identifier">receive</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> 19200 </span><span class="identifier">baud</span>
                                                            <span class="plain">;              </span><span class="identifier">tape</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">use</span>
                                                            <span class="plain">;                        </span><span class="identifier">motor</span><span class="plain"> </span><span class="identifier">on</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">serialULAControlRegister</span><span class="plain">                       ;</span>

        <span class="identifier">LDA</span><span class="plain"> #%11010000                                      ; </span><span class="identifier">A</span><span class="plain">=%11010000</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 7     - </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">interrupts</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 6/5   - </span><span class="identifier">RTS</span><span class="plain"> </span><span class="identifier">high</span><span class="plain">, </span><span class="identifier">transmit</span><span class="plain"> </span><span class="identifier">interrupt</span><span class="plain"> </span><span class="identifier">disabled</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 4/3/2 - 8 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">word</span><span class="plain">, 2 </span><span class="identifier">stop</span><span class="plain"> </span><span class="identifier">bits</span>
                                                            <span class="plain">; </span><span class="identifier">bit</span><span class="plain"> 1/0   - </span><span class="identifier">divide</span><span class="plain"> </span><span class="identifier">counter</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> 1</span>
    <span class="plain">.</span><span class="identifier">set6850ControlRegister</span>
        <span class="identifier">ORA</span><span class="plain"> .</span><span class="identifier">tapeBaudRate</span><span class="plain">                                   ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">bits</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">baud</span><span class="plain"> </span><span class="identifier">rate</span><span class="plain">:</span>
                                                            <span class="plain">; 5 = %101 </span><span class="identifier">means</span><span class="plain"> 1200 </span><span class="identifier">baud</span><span class="plain"> (</span><span class="identifier">divide</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> 16; 1 </span><span class="identifier">stop</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain">)</span>
                                                            <span class="plain">; 6 = %110 </span><span class="identifier">means</span><span class="plain">  300 </span><span class="identifier">baud</span><span class="plain"> (</span><span class="identifier">divide</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> 64; 1 </span><span class="identifier">stop</span><span class="plain"> </span><span class="identifier">bit</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">storeAToACIARegister</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">acia6850ControlRegister</span><span class="plain">                        ; </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">ACIA</span><span class="plain"> </span><span class="identifier">control</span><span class="plain"> </span><span class="reserved">register</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">incrementBlockNumber</span>
        <span class="identifier">LDX</span><span class="plain"> .</span><span class="identifier">fsBlockNumberLow</span><span class="plain">                               ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">fsBlockNumberHigh</span><span class="plain">                              ; </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">+1</span>
        <span class="identifier">STX</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberLow</span><span class="plain">                      ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">low</span>
        <span class="identifier">BNE</span><span class="plain"> +                                               ;</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
    <span class="plain">+</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tapeCurrentBlockNumberHigh</span><span class="plain">                     ; </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">high</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">zeroChecksumAndFSBufferFlag</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ;</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">filingSystemBufferFlag</span><span class="plain">                         ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">buffer</span><span class="plain"> </span><span class="identifier">flag</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Set</span><span class="plain"> (</span><span class="identifier">zero</span><span class="plain">) </span><span class="identifier">checksum</span><span class="plain"> </span><span class="identifier">bytes</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">Y</span><span class="plain"> = </span><span class="identifier">value</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">store</span><span class="plain"> (</span><span class="identifier">always</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">practice</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">setChecksumBytesToY</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tapeChecksumA</span><span class="plain">                                  ; </span><span class="identifier">CRC</span><span class="plain"> </span><span class="identifier">workspace</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tapeChecksumB</span><span class="plain">                                  ; </span><span class="identifier">CRC</span><span class="plain"> </span><span class="identifier">workspace</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Copy</span><span class="plain"> </span><span class="identifier">zero</span><span class="plain"> </span><span class="identifier">terminated</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> .</span><span class="identifier">filenameToSearchFor</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">offset</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> $301 </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">source</span><span class="plain"> </span><span class="identifier">string</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">copyToSoughtFilename</span>
        <span class="identifier">LDY</span><span class="plain"> #$</span><span class="identifier">FF</span><span class="plain">                                            ; </span><span class="identifier">Y</span><span class="plain">=$</span><span class="identifier">FF</span>
    <span class="plain">-</span>
        <span class="identifier">INY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">+1</span>
        <span class="identifier">INX</span><span class="plain">                                                 ; </span><span class="identifier">X</span><span class="plain">=</span><span class="identifier">X</span><span class="plain">+1</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">vduVariablesStart</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                            ;</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">filenameToSearchFor</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                          ; </span><span class="identifier">sought</span><span class="plain"> </span><span class="identifier">filename</span>
        <span class="identifier">BNE</span><span class="plain"> -                                               ; </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">end</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">filename</span><span class="plain"> (0)</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">zeroFileHandleMotorOn</span>
        <span class="identifier">LDY</span><span class="plain"> #0                                              ; </span><span class="identifier">Y</span><span class="plain">=0</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">storeFileHandleMotorOn</span>
        <span class="identifier">CLI</span><span class="plain">                                                 ; </span><span class="identifier">enable</span><span class="plain"> </span><span class="identifier">interrupts</span>
        <span class="identifier">LDX</span><span class="plain"> #1                                              ; </span><span class="identifier">X</span><span class="plain">=1 (</span><span class="identifier">relay</span><span class="plain"> </span><span class="identifier">on</span><span class="plain">)</span>
        <span class="identifier">STY</span><span class="plain"> .</span><span class="identifier">tapeCurrentFileHandle</span><span class="plain">                          ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">as</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span>
        <span class="plain">; </span><span class="identifier">fall</span><span class="plain"> </span><span class="identifier">through</span><span class="plain">...</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">On</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain">:</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = 0 </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">relay</span><span class="plain"> </span><span class="identifier">off</span>
    <span class="plain">;       </span><span class="identifier">X</span><span class="plain"> = 1 </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">relay</span><span class="plain"> </span><span class="identifier">on</span>
    <span class="plain">.</span><span class="identifier">controlMotor</span>
        <span class="identifier">LDA</span><span class="plain"> #137                                            ; </span><span class="reserved">do</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 137</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">tapeCurrentFileHandle</span><span class="plain">                          ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">back</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">handle</span><span class="plain"> (</span><span class="identifier">preserved</span><span class="plain"> </span><span class="identifier">through</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain">)</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">OSBYTE</span><span class="plain">                                         ; </span><span class="identifier">turn</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">motor</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">checkFileIsOpen</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">Y</span>
        <span class="identifier">EOR</span><span class="plain"> .</span><span class="identifier">tapeOrRomSwitch</span><span class="plain">                                ; </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain"> </span><span class="identifier">flag</span><span class="plain">: 0=</span><span class="identifier">TAPE</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span><span class="plain">; 2=</span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">filing</span><span class="plain"> </span><span class="identifier">system</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">A</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">tapeROMFSStatusByte</span><span class="plain">                            ; </span><span class="identifier">tape</span><span class="plain"> / </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">FS</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">byte</span>
        <span class="identifier">AND</span><span class="plain"> .</span><span class="identifier">fsTempStorage</span><span class="plain">                                  ; </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">status</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">temporary</span><span class="plain"> </span><span class="identifier">store</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">/2</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1</span>
        <span class="identifier">BEQ</span><span class="plain"> +                                               ;</span>
        <span class="identifier">LSR</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">A</span><span class="plain">/2</span>
        <span class="identifier">DEY</span><span class="plain">                                                 ; </span><span class="identifier">Y</span><span class="plain">=</span><span class="identifier">Y</span><span class="plain">-1</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">channelError</span><span class="plain">                                   ;</span>
    <span class="plain">+</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">exit36</span><span class="plain">                                         ;</span>

    <span class="plain">.</span><span class="identifier">channelError</span>
        <span class="identifier">BRK</span><span class="plain">                                                 ;</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $</span><span class="identifier">DE</span><span class="plain">                                           ; </span><span class="identifier">error</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"Channel"</span><span class="plain">                                     ; </span><span class="identifier">message</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> 0                                             ; </span><span class="identifier">terminator</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">See</span><span class="plain"> </span><span class="identifier">NAUG</span><span class="plain"> </span><span class="identifier">Section</span><span class="plain"> 18.8, </span><span class="identifier">Page</span><span class="plain"> 340</span>
    <span class="plain">.</span><span class="identifier">startSendToSecondProcessor</span>
        <span class="identifier">LDA</span><span class="plain"> #1                                              ; </span><span class="identifier">A</span><span class="plain">=1 (</span><span class="identifier">Reason</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> 1 = </span><span class="identifier">Multiple</span><span class="plain"> </span><span class="identifier">single</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">transfer</span><span class="plain">: </span><span class="identifier">i</span><span class="plain">/</span><span class="identifier">o</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">secondProcessorTransfer</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">checkLoadAddressIsForSecondProcessor</span><span class="plain">           ; </span><span class="identifier">check</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">valid</span>
        <span class="identifier">BEQ</span><span class="plain"> .</span><span class="identifier">exit36</span><span class="plain">                                         ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">IO</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">branch</span><span class="plain"> (</span><span class="identifier">exit</span><span class="plain">)</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; </span><span class="identifier">A</span><span class="plain">=1</span>
        <span class="identifier">LDX</span><span class="plain"> #&lt;.</span><span class="identifier">loadAddressLow</span><span class="plain">                               ; }</span>
        <span class="identifier">LDY</span><span class="plain"> #&gt;.</span><span class="identifier">loadAddressLow</span><span class="plain">                               ; } </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">up</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">address</span>
    <span class="plain">.</span><span class="identifier">secondProcessorCall</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=1 </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">LDA</span><span class="plain"> #.</span><span class="identifier">tubeClaimReasonCode</span><span class="plain"> + .</span><span class="identifier">tubeCallerIDCassetteFS</span><span class="plain"> ; </span><span class="identifier">Claim</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain">, </span><span class="identifier">caller</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">Cassette</span><span class="plain"> </span><span class="identifier">Filing</span><span class="plain"> </span><span class="identifier">System</span>
    <span class="plain">-</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">tubeTransferData</span><span class="plain">                               ; </span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">out</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">Tube</span>
        <span class="identifier">BCC</span><span class="plain"> -                                               ; </span><span class="identifier">keep</span><span class="plain"> </span><span class="identifier">trying</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">claim</span><span class="plain"> </span><span class="identifier">until</span><span class="plain"> </span><span class="identifier">claim</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">done</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; </span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">A</span><span class="plain">=1 (</span><span class="identifier">Reason</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> 1 = </span><span class="identifier">Multiple</span><span class="plain"> </span><span class="identifier">single</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">transfer</span><span class="plain">: </span><span class="identifier">i</span><span class="plain">/</span><span class="identifier">o</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">second</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain">)</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">tubeTransferData</span><span class="plain">                               ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">top</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">bytes</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> 32 </span><span class="identifier">bit</span><span class="plain"> </span><span class="identifier">load</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">are</span><span class="plain"> $</span><span class="identifier">FF</span><span class="plain">, </span><span class="identifier">then</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">main</span><span class="plain"> </span><span class="identifier">processor</span><span class="plain"> </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">OK</span>
    <span class="plain">; </span><span class="identifier">otherwise</span><span class="plain"> </span><span class="identifier">it</span><span class="character">'s for the Tube. Check the Tube is present.</span>
    <span class="character">; On Exit:</span>
    <span class="character">;       Z set if load address is invalid</span>
    <span class="character">;       X is value of A on entry</span>
    <span class="character">.checkLoadAddressIsForSecondProcessor</span>
        <span class="character">TAX                                                 ; X=A</span>
        <span class="character">LDA .loadAddressMid2                                ; current load address high word</span>
        <span class="character">AND .loadAddressHigh                                ; current load address high word</span>
        <span class="character">CMP #$FF                                            ;</span>
        <span class="character">BEQ +                                               ; if $FF then its for base processor</span>
        <span class="character">LDA .tubePresentFlag                                ; $FF if Tube present</span>
        <span class="character">AND #%10000000                                      ; if Tube present then set bit 7 alone</span>
    <span class="character">+</span>
        <span class="character">RTS                                                 ;</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.setupForCassetteWrite</span>
        <span class="character">LDA #%10000101                                      ; } switch on the cassette motor and relay</span>
        <span class="character">STA .serialULAControlRegister                       ; } and set 300 baud</span>
        <span class="character">JSR .resetACIA                                      ; reset ACIA</span>
        <span class="character">LDA #%00010000                                      ; even parity; 2 stop bits; 8 bit word; RTS low (active); disable interrupts</span>
        <span class="character">JSR .set6850ControlRegister                         ; set ACIA to CFS baud rate</span>

    <span class="character">-</span>
        <span class="character">JSR .checkForEscapeDuringCassetteOperation          ; check for ESCAPE</span>
        <span class="character">LDA .acia6850StatusRegister                         ; read ACIA status register</span>
        <span class="character">AND #%00000010                                      ; check bit 1 (transmit interrupt generated)</span>
        <span class="character">BEQ -                                               ; if bit 1 clear then branch (loop back and try again)</span>

        <span class="character">LDA #%10101010                                      ; A=$AA</span>
        <span class="character">STA .acia6850DataRegister                           ; transmit data register</span>
    <span class="character">.exit36</span>
        <span class="character">RTS                                                 ;</span>

        <span class="character">!byte 0                                             ; unused</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
</pre>

<p class="inwebparagraph">Chapter 18
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 18: </span><span class="identifier">Credits</span><span class="plain"> (</span><span class="identifier">stored</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">mapped</span><span class="plain"> </span><span class="identifier">IO</span><span class="plain"> </span><span class="identifier">space</span><span class="plain">)</span>
    <span class="plain">; </span><span class="identifier">This</span><span class="plain"> </span><span class="identifier">area</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> $</span><span class="identifier">FC00</span><span class="plain">-$</span><span class="identifier">FF00</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">mapped</span><span class="plain"> </span><span class="identifier">IO</span><span class="plain"> </span><span class="identifier">space</span><span class="plain">.</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"(C) 1981 Acorn Computers Ltd.Thanks are due to the following contributors to the development of the BBC Computer "</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"(among others too numerous to mention):- David Allen,Bob Austin,Ram Banerjee,Paul Bond,Allen Boothroyd,Cambridge,"</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"Cleartone,John Coll,John Cox,Andy Cripps,Chris Curry,6502 designers,Jeremy Dion,Tim Dobson,Joe Dunn,Paul Farrell,"</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"Ferranti,Steve Furber,Jon Gibbons,Andrew Gordon,Lawrence Hardwick,Dylan Harris,Hermann Hauser,Hitachi,Andy Hopper"</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">",ICL,Martin Jackson,Brian Jones,Chris Jordan,David King,David Kitson,Paul Kriwaczek,Computer Laboratory,Peter Mil"</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"ler,Arthur Norman,Glyn Phillips,Mike Prees,John Radcliffe,Wilberforce Road,Peter Robinson,Richard Russell,Kim Spe"</span>
        <span class="plain">!</span><span class="identifier">text</span><span class="plain"> </span><span class="string">"nce-Jones,Graham Tebby,Jon Thackray,Chris Turner,Adrian Warner,Roger Wilson,Alan Wright."</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">resetEntryPoint</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
</pre>

<p class="inwebparagraph">Chapter 19
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 19: </span><span class="identifier">Extended</span><span class="plain"> </span><span class="identifier">vectors</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; </span><span class="identifier">Extended</span><span class="plain"> </span><span class="identifier">Vector</span><span class="plain"> </span><span class="identifier">Entry</span><span class="plain"> </span><span class="identifier">Points</span>
    <span class="plain">; </span><span class="identifier">See</span><span class="plain"> </span><span class="identifier">NAUG</span><span class="plain"> </span><span class="identifier">Section</span><span class="plain"> 17.4.3 - </span><span class="identifier">Extended</span><span class="plain"> </span><span class="identifier">Vectors</span><span class="plain">, </span><span class="identifier">Page</span><span class="plain"> 312</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">There</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">mechanism</span><span class="plain"> </span><span class="identifier">by</span><span class="plain"> </span><span class="identifier">which</span><span class="plain"> </span><span class="identifier">Paged</span><span class="plain"> </span><span class="identifier">ROMs</span><span class="plain"> </span><span class="identifier">can</span><span class="plain"> </span><span class="identifier">intercept</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">standard</span><span class="plain"> </span><span class="identifier">vectors</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $0200</span>
    <span class="plain">; </span><span class="identifier">upwards</span><span class="plain">, </span><span class="identifier">instead</span><span class="plain"> </span><span class="identifier">getting</span><span class="plain"> </span><span class="identifier">them</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">point</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">specific</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> *</span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">specified</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">*.</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">To</span><span class="plain"> </span><span class="identifier">intercept</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">N</span><span class="plain">:</span>
    <span class="plain">;</span>
    <span class="plain">;   </span><span class="identifier">Disable</span><span class="plain"> </span><span class="identifier">interrupts</span><span class="plain"> </span><span class="identifier">during</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">change</span><span class="plain"> </span><span class="identifier">over</span>
    <span class="plain">;   </span><span class="identifier">Get</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">base</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> (</span><span class="identifier">call</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">V</span><span class="plain">) </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">OSBYTE</span><span class="plain"> 168 (</span><span class="identifier">V</span><span class="plain"> </span><span class="identifier">is</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="character">'.extendedVectorSpace'</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">this</span><span class="plain"> </span><span class="identifier">particular</span><span class="plain"> </span><span class="identifier">version</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain">)</span>
    <span class="plain">;   </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">two</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">starting</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="identifier">V</span><span class="plain">+3*</span><span class="identifier">N</span>
    <span class="plain">;   </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">following</span><span class="plain"> </span><span class="identifier">byte</span>
    <span class="plain">;   </span><span class="identifier">Make</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">original</span><span class="plain"> </span><span class="identifier">contents</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> $0200+2*</span><span class="identifier">N</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">needed</span>
    <span class="plain">;   </span><span class="identifier">Store</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="character">'$FF00+3*N'</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">at</span><span class="plain"> </span><span class="character">'$0200+2*N'</span>
    <span class="plain">;</span>
    <span class="plain">.</span><span class="identifier">extendedVectorTable</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_USERV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_BRKV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_IRQ1V</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_IRQ2V</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_CLIV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_BYTEV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_WORDV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_WRCHV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_RDCHV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_FILEV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_ARGSV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_BGETV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_BPUTV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_GBPBV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_FINDV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_FSCV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_EVENTV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_UPTV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_NETV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_VDUV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_KEYV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_INSV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_REMV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_CNPV</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_IND1V</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_IND2V</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">extendedVectorEntryPoint</span><span class="plain">                       ; </span><span class="identifier">E_IND3V</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">extendedVectorEntryPoint</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> - </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">currently</span><span class="plain"> </span><span class="identifier">selected</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> (</span><span class="identifier">address</span><span class="plain"> </span><span class="character">'$109,X'</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> - </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span><span class="plain">     (</span><span class="identifier">address</span><span class="plain"> </span><span class="character">'$108,X'</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> - </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span><span class="plain">    (</span><span class="identifier">address</span><span class="plain"> </span><span class="character">'$107,X'</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> - </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">low</span><span class="plain">        (</span><span class="identifier">address</span><span class="plain"> </span><span class="character">'$106,X'</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> - </span><span class="identifier">make</span><span class="plain"> </span><span class="identifier">space</span><span class="plain"> </span><span class="reserved">for</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">high</span><span class="plain">       (</span><span class="identifier">address</span><span class="plain"> </span><span class="character">'$105,X'</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">code</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>

        <span class="identifier">PHP</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TXA</span><span class="plain">                                                 ; } </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">Flags</span><span class="plain">,</span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TYA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PHA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TSX</span><span class="plain">                                                 ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> </span><span class="identifier">pointer</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">X</span>

        <span class="identifier">LDA</span><span class="plain"> #&gt;(.</span><span class="identifier">returnFromROM</span><span class="plain">-1)                            ; }</span>
        <span class="identifier">STA</span><span class="plain"> $0108,</span><span class="identifier">X</span><span class="plain">                                         ; }</span>
        <span class="identifier">LDA</span><span class="plain"> #&lt;(.</span><span class="identifier">returnFromROM</span><span class="plain">-1)                            ; } </span><span class="identifier">store</span><span class="plain"> </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">in</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">stack</span><span class="plain"> (</span><span class="identifier">the</span><span class="plain"> .</span><span class="identifier">returnFromROM</span><span class="plain"> </span><span class="identifier">routine</span><span class="plain"> </span><span class="identifier">below</span><span class="plain">)</span>
        <span class="identifier">STA</span><span class="plain"> $0107,</span><span class="identifier">X</span><span class="plain">                                         ; }</span>

        <span class="identifier">LDY</span><span class="plain"> $010</span><span class="identifier">A</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                         ; </span><span class="identifier">Y</span><span class="plain">=3*</span><span class="identifier">N</span><span class="plain">+2 (</span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">caller</span><span class="plain"> </span><span class="identifier">address</span><span class="plain">)</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">extendedVectorSpace</span><span class="plain">-2,</span><span class="identifier">Y</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">low</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">action</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">STA</span><span class="plain"> $0105,</span><span class="identifier">X</span><span class="plain">                                         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">extendedVectorSpace</span><span class="plain">-1,</span><span class="identifier">Y</span><span class="plain">                        ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">high</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">action</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="identifier">STA</span><span class="plain"> $0106,</span><span class="identifier">X</span><span class="plain">                                         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">STA</span><span class="plain"> $0109,</span><span class="identifier">X</span><span class="plain">                                         ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">it</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">LDA</span><span class="plain"> .</span><span class="identifier">extendedVectorSpace</span><span class="plain">,</span><span class="identifier">Y</span><span class="plain">                          ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">new</span><span class="plain"> </span><span class="identifier">rom</span><span class="plain"> </span><span class="identifier">number</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">currentlySelectedROM</span><span class="plain">                           ; </span><span class="identifier">store</span><span class="plain"> </span><span class="identifier">RAM</span><span class="plain"> </span><span class="identifier">copy</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">ROM</span>
        <span class="identifier">STA</span><span class="plain"> .</span><span class="identifier">romSelectRegister</span><span class="plain">                              ; </span><span class="reserved">switch</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">ROM</span><span class="plain"> </span><span class="identifier">into</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">map</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; }</span>
        <span class="identifier">TAY</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; } </span><span class="identifier">Restore</span><span class="plain"> </span><span class="identifier">Y</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">,</span><span class="identifier">A</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">stack</span>
        <span class="identifier">TAX</span><span class="plain">                                                 ; }</span>
        <span class="identifier">PLA</span><span class="plain">                                                 ; }</span>
    <span class="plain">.</span><span class="identifier">returnFromInterrupt</span>
        <span class="identifier">RTI</span><span class="plain">                                                 ; </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">RTI</span><span class="plain"> </span><span class="identifier">instruction</span><span class="plain"> </span><span class="identifier">restores</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">flags</span><span class="plain">, </span><span class="identifier">and</span><span class="plain"> </span><span class="identifier">jumps</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> (</span><span class="identifier">ROM</span><span class="plain">) </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">we</span><span class="character">'ve put on the stack.</span>
                                                            <span class="character">; i.e. this jumps to the ROM routine. When that returns, the address on the stack jumps us to the</span>
                                                            <span class="character">; routine below.</span>

    <span class="character">; ***************************************************************************************</span>
    <span class="character">.returnFromROM</span>
        <span class="character">PHP                                                 ; }</span>
        <span class="character">PHA                                                 ; }</span>
        <span class="character">TXA                                                 ; } save Flags,A,X to the stack</span>
        <span class="character">PHA                                                 ; }</span>
        <span class="character">TSX                                                 ;</span>
        <span class="character">LDA $0102,X                                         ; }</span>
        <span class="character">STA $0105,X                                         ; }</span>
        <span class="character">LDA $0103,X                                         ; } store real return address onto stack (ready for RTS)</span>
        <span class="character">STA $0106,X                                         ; }</span>

        <span class="character">PLA                                                 ; }</span>
        <span class="character">TAX                                                 ; } recall X</span>
        <span class="character">PLA                                                 ; recall A - lose these 2 bytes. They are the address of this routine.</span>
        <span class="character">PLA                                                 ; recall A - lose these 2 bytes. They are the address of this routine.</span>
        <span class="character">PLA                                                 ; get back A (original rom number)</span>
        <span class="character">STA .currentlySelectedROM                           ; store it as RAM copy of current ROM number</span>
        <span class="character">STA .romSelectRegister                              ; switch the ROM into the memory map</span>


        <span class="character">PLA                                                 ; get back A</span>
        <span class="character">PLP                                                 ; get back flags</span>
    <span class="character">.return</span>
        <span class="character">RTS                                                 ; return and exit (pulls real return address from stack)</span>


    <span class="character">; ***************************************************************************************</span>
    <span class="character">; ***************************************************************************************</span>
    <span class="character">;</span>
</pre>

<p class="inwebparagraph">Chapter 20
</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b></p>


<pre class="display">
    <span class="plain">; </span><span class="identifier">Chapter</span><span class="plain"> 20: </span><span class="identifier">Write</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain">/</span><span class="identifier">Fred</span><span class="plain">/</span><span class="identifier">Jim</span><span class="plain">/</span><span class="identifier">Sheila</span><span class="plain">; </span><span class="identifier">OS</span><span class="plain"> </span><span class="identifier">entry</span><span class="plain"> </span><span class="identifier">points</span><span class="plain">; 6502 </span><span class="identifier">Vectors</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">; ***************************************************************************************</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 157 - </span><span class="identifier">Fast</span><span class="plain"> </span><span class="identifier">Tube</span><span class="plain"> </span><span class="identifier">BPUT</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte157EntryPoint</span>
        <span class="identifier">TXA</span><span class="plain">                                                ; </span><span class="identifier">A</span><span class="plain">=</span><span class="identifier">X</span>
        <span class="identifier">BCS</span><span class="plain"> .</span><span class="identifier">OSBPUT</span><span class="plain">                                        ; </span><span class="reserved">if</span><span class="plain"> </span><span class="identifier">carry</span><span class="plain"> </span><span class="identifier">set</span><span class="plain"> </span><span class="identifier">BPUT</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 146 - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">FRED</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte146EntryPoint</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">fredPage</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                     ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">FRED</span><span class="plain"> </span><span class="identifier">area</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 148 - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">JIM</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte148EntryPoint</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">jimPage</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                      ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">JIM</span><span class="plain"> </span><span class="identifier">area</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">OSBYTE</span><span class="plain"> 150 - </span><span class="identifier">Read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">SHEILA</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">osbyte150EntryPoint</span>
        <span class="identifier">LDY</span><span class="plain"> .</span><span class="identifier">sheilaPage</span><span class="plain">,</span><span class="identifier">X</span><span class="plain">                                   ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">SHEILA</span><span class="plain"> </span><span class="identifier">memory</span><span class="plain"> </span><span class="identifier">mapped</span><span class="plain"> </span><span class="identifier">I</span><span class="plain">/</span><span class="identifier">O</span><span class="plain"> </span><span class="identifier">area</span>
        <span class="identifier">RTS</span><span class="plain">                                                 ;</span>

    <span class="plain">; ***************************************************************************************</span>
        <span class="plain">!</span><span class="identifier">byte</span><span class="plain"> $36                                           ; </span><span class="identifier">length</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> .</span><span class="identifier">defaultVectorTable</span><span class="plain">   (</span><span class="identifier">unused</span><span class="plain">)</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">defaultVectorTable</span><span class="plain">                           ; </span><span class="identifier">address</span><span class="plain"> </span><span class="identifier">of</span><span class="plain"> </span><span class="reserved">default</span><span class="plain"> </span><span class="identifier">vector</span><span class="plain"> </span><span class="identifier">table</span><span class="plain"> (</span><span class="identifier">unused</span><span class="plain">)</span>

    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; </span><span class="identifier">Operating</span><span class="plain"> </span><span class="identifier">System</span><span class="plain"> </span><span class="identifier">function</span><span class="plain"> </span><span class="identifier">calls</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">.</span><span class="identifier">OSRDRM</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">osrdrmEntryPoint</span><span class="plain">                               ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">sideways</span><span class="plain"> </span><span class="identifier">ROM</span>
    <span class="plain">.</span><span class="identifier">VDUCHR</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">vduChrEntryPoint</span><span class="plain">                               ; </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">output</span>
    <span class="plain">.</span><span class="identifier">OSEVEN</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">eventEntryPoint</span><span class="plain">                                ; </span><span class="identifier">generate</span><span class="plain"> </span><span class="identifier">an</span><span class="plain"> </span><span class="identifier">EVENT</span>
    <span class="plain">.</span><span class="identifier">GSINIT</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">gsinitEntryPoint</span><span class="plain">                               ; </span><span class="identifier">initialise</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">input</span>
    <span class="plain">.</span><span class="identifier">GSREAD</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">gsreadEntryPoint</span><span class="plain">                               ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">stream</span>
    <span class="plain">.</span><span class="identifier">NVRDCH</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">osrdchEntryPoint</span><span class="plain">                               ; </span><span class="identifier">non</span><span class="plain"> </span><span class="identifier">vectored</span><span class="plain"> .</span><span class="identifier">OSRDCH</span>
    <span class="plain">.</span><span class="identifier">NVWRCH</span>
        <span class="identifier">JMP</span><span class="plain"> .</span><span class="identifier">oswrchEntryPoint</span><span class="plain">                               ; </span><span class="identifier">non</span><span class="plain"> </span><span class="identifier">vectored</span><span class="plain"> .</span><span class="identifier">OSWRCH</span>
    <span class="plain">.</span><span class="identifier">OSFIND</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorFINDV</span><span class="plain">)                                  ; </span><span class="identifier">open</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">close</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">.</span><span class="identifier">OSGBPB</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorGBPBV</span><span class="plain">)                                  ; </span><span class="identifier">transfer</span><span class="plain"> </span><span class="identifier">block</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">.</span><span class="identifier">OSBPUT</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorBPUTV</span><span class="plain">)                                  ; </span><span class="identifier">save</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">.</span><span class="identifier">OSBGET</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorBGETV</span><span class="plain">)                                  ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">.</span><span class="identifier">OSARGS</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorARGSV</span><span class="plain">)                                  ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">file</span><span class="plain"> </span><span class="identifier">arguments</span>
    <span class="plain">.</span><span class="identifier">OSFILE</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorFILEV</span><span class="plain">)                                  ; </span><span class="identifier">read</span><span class="plain"> </span><span class="identifier">or</span><span class="plain"> </span><span class="identifier">write</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">file</span>
    <span class="plain">.</span><span class="identifier">OSRDCH</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorRDCHV</span><span class="plain">)                                  ; </span><span class="identifier">get</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">from</span><span class="plain"> </span><span class="identifier">current</span><span class="plain"> </span><span class="identifier">input</span><span class="plain"> </span><span class="identifier">stream</span>
    <span class="plain">.</span><span class="identifier">OSASCI</span>
        <span class="identifier">CMP</span><span class="plain"> #13                                             ; </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">stream</span><span class="plain"> </span><span class="identifier">expanding</span>
        <span class="identifier">BNE</span><span class="plain"> .</span><span class="identifier">OSWRCH</span><span class="plain">                                         ; </span><span class="identifier">Carriage</span><span class="plain"> </span><span class="identifier">returns</span><span class="plain"> ($0</span><span class="identifier">D</span><span class="plain">) </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain">/</span><span class="identifier">LF</span><span class="plain"> ($0</span><span class="identifier">A</span><span class="plain">,$0</span><span class="identifier">D</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">OSNEWL</span>
        <span class="identifier">LDA</span><span class="plain"> #10                                             ; </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">CR</span><span class="plain">/</span><span class="identifier">LF</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">stream</span>
        <span class="identifier">JSR</span><span class="plain"> .</span><span class="identifier">OSWRCH</span><span class="plain">                                         ;</span>
        <span class="identifier">LDA</span><span class="plain"> #13                                             ;</span>
    <span class="plain">.</span><span class="identifier">OSWRCH</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorWRCHV</span><span class="plain">)                                  ; </span><span class="identifier">output</span><span class="plain"> </span><span class="identifier">a</span><span class="plain"> </span><span class="identifier">character</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">the</span><span class="plain"> </span><span class="identifier">VDU</span><span class="plain"> </span><span class="identifier">stream</span>
    <span class="plain">.</span><span class="identifier">OSWORD</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorWORDV</span><span class="plain">)                                  ; </span><span class="identifier">perform</span><span class="plain"> </span><span class="identifier">operation</span><span class="plain"> </span><span class="identifier">using</span><span class="plain"> </span><span class="identifier">parameter</span><span class="plain"> </span><span class="identifier">table</span>
    <span class="plain">.</span><span class="identifier">OSBYTE</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorBYTEV</span><span class="plain">)                                  ; </span><span class="identifier">perform</span><span class="plain"> </span><span class="identifier">operation</span><span class="plain"> </span><span class="identifier">on</span><span class="plain"> </span><span class="identifier">single</span><span class="plain"> </span><span class="identifier">byte</span><span class="plain"> (*</span><span class="identifier">FX</span><span class="plain">)</span>
    <span class="plain">.</span><span class="identifier">OSCLI</span>
        <span class="identifier">JMP</span><span class="plain"> (.</span><span class="identifier">vectorCLIV</span><span class="plain">)                                   ; </span><span class="identifier">pass</span><span class="plain"> </span><span class="identifier">string</span><span class="plain"> </span><span class="identifier">to</span><span class="plain"> </span><span class="identifier">command</span><span class="plain"> </span><span class="identifier">line</span><span class="plain"> </span><span class="identifier">interpreter</span>


    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">;</span>
    <span class="plain">; 6502 </span><span class="identifier">Vectors</span>
    <span class="plain">;</span>
    <span class="plain">; ***************************************************************************************</span>
    <span class="plain">* = $</span><span class="identifier">FFFA</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">nmiEntryPoint</span><span class="plain">                                ; </span><span class="identifier">NMI</span><span class="plain">   </span><span class="identifier">address</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">resetEntryPoint</span><span class="plain">                              ; </span><span class="identifier">RESET</span><span class="plain"> </span><span class="identifier">address</span>
        <span class="plain">!</span><span class="identifier">word</span><span class="plain"> .</span><span class="identifier">mainIRQEntryPoint</span><span class="plain">                            ; </span><span class="identifier">IRQ</span><span class="plain">   </span><span class="identifier">address</span>
</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><a href=".html">Back to 'Chapter 19'</a></li><li><i>(This section ends Sections.)</i></li></ul><hr class="tocbar">
<!--End of weave-->
		</main>
	</body>
</html>

