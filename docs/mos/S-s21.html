<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Chapter 21: More Low Level Tape Operations</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Carousel.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/ACME-Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<p>BBC Computer 32K</p>
<h1>*CAT</h1>
<ul><li><a href="../index.html">&#x21A9; home</a></li><li><a href="index.html"><span class="selectedlink">contents</span></a></li>
<li><a href="S-s1.html">introduction</a></li>
<li><a href="S-s2.html">constants</a></li>
<li><a href="S-s3.html">memory-mapped i/o</a></li>
<li><a href="S-s4.html"><b>$C000</b>: chapter 4</a></li>
<li><a href="S-s5.html"><b>$C4C0</b>: chapter 5</a></li>
<li><a href="S-s6.html"><b>$CB1D</b>: chapter 6</a></li>
<li><a href="S-s7.html"><b>$CCF8</b>: chapter 7</a></li>
<li><a href="S-s8.html"><b>$D060</b>: chapter 8</a></li>
<li><a href="S-s9.html"><b>$D7C2</b>: chapter 9</a></li>
<li><a href="S-s10.html"><b>$D940</b>: chapter 10</a></li>
<li><a href="S-s11.html"><b>$DC1C</b>: chapter 11</a></li>
<li><a href="S-s12.html"><b>$DEC5</b>: chapter 12</a></li>
<li><a href="S-s13.html"><b>$E0A4</b>: chapter 13</a></li>
<li><a href="S-s14.html"><b>$E20E</b>: chapter 14</a></li>
<li><a href="S-s15.html"><b>$E5B3</b>: chapter 15</a></li>
<li><a href="S-s16.html"><b>$EB03</b>: chapter 16</a></li>
<li><a href="S-s17.html"><b>$EEDA</b>: chapter 17</a></li>
<li><a href="S-s18.html"><b>$F135</b>: chapter 18</a></li>
<li><a href="S-s19.html"><b>$F588</b>: chapter 19</a></li>
<li><a href="S-s20.html"><b>$F8A9</b>: chapter 20</a></li>
<li><span class="unlink"><b>$FAE8</b>: chapter 21</span></li>
<li><a href="S-s22.html"><b>$FC00</b>: chapter 22</a></li>
<li><a href="S-s23.html"><b>$FF00</b>: chapter 23</a></li>
<li><a href="S-s24.html"><b>$FFA7</b>: chapter 24</a></li>
<li><a href="S-s25.html">appendix</a></li>
<li><a href="S-s26.html">index</a></li>

</ul>
		</nav>
		<main role="main">
		<!--Weave of 'Chapter 21: More Low Level Tape Operations' generated by Inweb-->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">MOS 1.20</a></li><li><b>Chapter 21: More Low Level Tape Operations</b></li></ul></div>
<p class="purpose">Setup, Claim, and Reset ACIA; Cancel tape operation; Activate / deactivate RTS; Zero checksum; Copy filename; Motor on/off; Check file is open; Send data to second processor; Setup for cassette write - 280 bytes (1.7%)</p>

<ul class="toc"><li><a href="S-s21.html#SP1">&#167;1. beepAndCancelTapeOperation</a></li><li><a href="S-s21.html#SP2">&#167;2. cancelTapeOperationAndMotor</a></li><li><a href="S-s21.html#SP3">&#167;3. setupACIA</a></li><li><a href="S-s21.html#SP4">&#167;4. checkForEscapeFlag</a></li><li><a href="S-s21.html#SP5">&#167;5. claimSerialSystemForSequentialAccess</a></li><li><a href="S-s21.html#SP6">&#167;6. claimSerialSystemForLoadSave</a></li><li><a href="S-s21.html#SP7">&#167;7. resetACIA</a></li><li><a href="S-s21.html#SP8">&#167;8. activateRequestToSend</a></li><li><a href="S-s21.html#SP9">&#167;9. flipRelayOffAndOnThenSetToReadFromTape</a></li><li><a href="S-s21.html#SP10">&#167;10. incrementBlockNumbers</a></li><li><a href="S-s21.html#SP11">&#167;11. zeroChecksumAndFSFlag</a></li><li><a href="S-s21.html#SP12">&#167;12. setChecksumBytesToY</a></li><li><a href="S-s21.html#SP13">&#167;13. Copy zero terminated string to .filenameToSearchFor</a></li><li><a href="S-s21.html#SP14">&#167;14. zeroFileHandleAndMotorOn</a></li><li><a href="S-s21.html#SP15">&#167;15. storeFileHandleAndMotorOn</a></li><li><a href="S-s21.html#SP16">&#167;16. controlMotor</a></li><li><a href="S-s21.html#SP17">&#167;17. Check file is open</a></li><li><a href="S-s21.html#SP18">&#167;18. startSendToSecondProcessor</a></li><li><a href="S-s21.html#SP19">&#167;19. Check load address for destination</a></li><li><a href="S-s21.html#SP21">&#167;21. setupForCassetteWrite</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. beepAndCancelTapeOperation. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">beepAndCancelTapeOperation</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="ACME-function-syntax">beepAndCancelTapeOperation</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP9">&#167;9</a>, <a href="S-s18.html#SP13">&#167;13</a><br/>Chapter 20: Filing System Messaging and Error Reporting - <a href="S-s20.html#SP14">&#167;14</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fae8</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s15.html#SP25" class="function-link"><span class="ACME-function-syntax">shouldPrintMessage</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">check if free to print message</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP2" class="function-link"><span class="ACME-function-syntax">cancelTapeOperationAndMotor</span></a><span class="ACME-plain-syntax">                    </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP2" class="function-link"><span class="ACME-function-syntax">charBELL</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">beep</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s24.html#SP6" class="function-link"><span class="ACME-function-syntax">OSWRCH</span></a><span class="ACME-plain-syntax">                                         </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. cancelTapeOperationAndMotor. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Cancel the tape operation:</span>
<span class="ACME-plain-syntax">       relinquish the Tube</span>
<span class="ACME-plain-syntax">       switch off the cassette motor</span>
<span class="ACME-plain-syntax">       reset ACIA</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">cancelTapeOperationAndMotor</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="ACME-function-syntax">cancelTapeOperationAndMotor</span></span>:<br/><a href="S-s21.html#SP1">&#167;1</a><br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP11">&#167;11</a>, <a href="S-s18.html#SP30">&#167;30</a>, <a href="S-s18.html#SP35">&#167;35</a><br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP13">&#167;13</a><br/>Chapter 20: Filing System Messaging and Error Reporting - <a href="S-s20.html#SP11">&#167;11</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $faf2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$80</span><span class="ACME-plain-syntax">                                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP18" class="function-link"><span class="ACME-function-syntax">secondProcessorTransfer</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">relinquish the Tube (NAUG Section</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">18.8, Page 339)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #0                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP16" class="function-link"><span class="ACME-function-syntax">controlMotor</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">switch off motor</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">cancelTapeOperation</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="ACME-function-syntax">cancelTapeOperation</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP21">&#167;21</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fafc</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">prevent IRQ interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">serialULARegisterCopy</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">get serial ULA control register</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">setting</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">serialULAControlRegister</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">write to serial ULA control register</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">setting</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">A=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423TimeoutCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">zero RS-423 timeout counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">ALWAYS branch</span>
</pre>
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3. setupACIA. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setupACIA</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="ACME-function-syntax">setupACIA</span></span>:<br/>Chapter 10: Resets - <a href="S-s10.html#SP10">&#167;10</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb0a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags on stacksave flags</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP7" class="function-link"><span class="ACME-function-syntax">resetACIA</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">reset the ACIA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423ControlRegisterCopy</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">get last setting of ACIA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP5" class="function-link"><span class="ACME-function-syntax">storeACIAAndPull</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">set ACIA and OS Copy from A before</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">exit</span>

</pre>
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. checkForEscapeFlag. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">checkForEscapeFlag</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="ACME-function-syntax">checkForEscapeFlag</span></span>:<br/><a href="S-s21.html#SP6">&#167;6</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb14</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">escapeFlag</span></a><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">check bit 7 of ESCAPE flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP6" class="function-link"><span class="ACME-function-syntax">waitForRS423ToTimeout</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">if (ESCAPE flag not set) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">return (ESCAPE is pending)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5. claimSerialSystemForSequentialAccess. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">claimSerialSystemForSequentialAccess</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="ACME-function-syntax">claimSerialSystemForSequentialAccess</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP29">&#167;29</a>, <a href="S-s18.html#SP32">&#167;32</a>, <a href="S-s18.html#SP33">&#167;33</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb1a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeOptionsByte</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">get cassette filing system options</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">byte</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">high nybble used for LOAD and SAVE</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">operations</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">low nybble used for sequential access</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">See .</span><a href="S-s18.html#SP41" class="internal">tapeOptByteTable</a>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} move low nybble into high nybble</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeCurrentOptionsByte</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">save current OPTions</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">tapeSequentialAccessInterBlockGap</span></a><span class="ACME-plain-syntax">              </span><span class="ACME-comment-syntax">get sequential block gap (&gt;0)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP6" class="function-link"><span class="ACME-function-syntax">claimSerialSystem</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">ALWAYS branch</span>
</pre>
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6. claimSerialSystemForLoadSave. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">claimSerialSystemForLoadSave</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="ACME-function-syntax">claimSerialSystemForLoadSave</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP9">&#167;9</a>, <a href="S-s18.html#SP18">&#167;18</a>, <a href="S-s18.html#SP21">&#167;21</a>, <a href="S-s18.html#SP30">&#167;30</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb27</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeOptionsByte</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">get cassette filing system options</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">byte</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">high nybble used for LOAD and SAVE</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">operations</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">low nybble used for sequential access</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">See .</span><a href="S-s18.html#SP41" class="internal">tapeOptByteTable</a>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%11110000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">clear low nybble</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeCurrentOptionsByte</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">store as current OPTions</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #6                                              </span><span class="ACME-comment-syntax">set current interblock gap to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">6/10ths of a second</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">claimSerialSystem</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="ACME-function-syntax">claimSerialSystem</span></span>:<br/><a href="S-s21.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb2f</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeInterBlockGap</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">set current interblock gap</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">wait for the RS-423 system to timeout, so that the cassette system can take over</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">waitForRS423ToTimeout</span><button class="popup" onclick="togglePopup('usagePopup9')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup9">Usage of <span class="code-font"><span class="ACME-function-syntax">waitForRS423ToTimeout</span></span>:<br/><a href="S-s21.html#SP4">&#167;4</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb31</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">allow interrupts briefly</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags on stack (with interrupts</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">enabled)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423ReadyFlag</span></a><span class="ACME-plain-syntax">                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP4" class="function-link"><span class="ACME-function-syntax">checkForEscapeFlag</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">if (RS-423 is busy) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(check escape flag and try again)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423TimeoutCounter</span></a><span class="ACME-plain-syntax">                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP4" class="function-link"><span class="ACME-function-syntax">checkForEscapeFlag</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">if (RS-423 has NOT timed out) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (check for escape flag and</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">try again)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">} store RS-423 timeout counter with</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423TimeoutCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">} one to indicate that cassette has</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} control of the ACIA 6850</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP7" class="function-link"><span class="ACME-function-syntax">resetACIA</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">reset ACIA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags (enabling interrupts)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP7" class="paragraph-anchor"></a><b>&#167;7. resetACIA. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">resetACIA</span><button class="popup" onclick="togglePopup('usagePopup10')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup10">Usage of <span class="code-font"><span class="ACME-function-syntax">resetACIA</span></span>:<br/><a href="S-s21.html#SP3">&#167;3</a>, <a href="S-s21.html#SP6">&#167;6</a>, <a href="S-s21.html#SP21">&#167;21</a><br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP6">&#167;6</a>, <a href="S-s19.html#SP23">&#167;23</a><br/>Chapter 20: Filing System Messaging and Error Reporting - <a href="S-s20.html#SP20">&#167;20</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb46</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00000011</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">A=3 (bits CR0 and CR1 set means</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">     'master reset')</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP9" class="function-link"><span class="ACME-function-syntax">storeAToACIARegister</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">ALWAYS branch (to reset ACIA)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP8" class="paragraph-anchor"></a><b>&#167;8. activateRequestToSend. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">activateRequestToSend</span><button class="popup" onclick="togglePopup('usagePopup11')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup11">Usage of <span class="code-font"><span class="ACME-function-syntax">activateRequestToSend</span></span>:<br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP23">&#167;23</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb4a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00110000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">set current ACIA control register</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">8 bit word, 2 stop bits, RTS low</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(this is the active state), transmit</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupt enabled</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeSendingFlag</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">set non-zero value to indicate</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">sending to tape</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP9" class="function-link"><span class="ACME-function-syntax">setACIA6850ControlRegister</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">ALWAYS branch</span>
</pre>
<p class="commentary firstcommentary"><a id="SP9" class="paragraph-anchor"></a><b>&#167;9. flipRelayOffAndOnThenSetToReadFromTape. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">flipRelayOffAndOnThenSetToReadFromTape</span><button class="popup" onclick="togglePopup('usagePopup12')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup12">Usage of <span class="code-font"><span class="ACME-function-syntax">flipRelayOffAndOnThenSetToReadFromTape</span></span>:<br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP3">&#167;3</a>, <a href="S-s19.html#SP17">&#167;17</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb50</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00000101</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">set .serialULAControlRegister</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">serialULAControlRegister</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">which sets transmit to 300 baud</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">          receive to 19200 baud</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">             tape system in use</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">                      motor off</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">loop counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} delay loop</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeSendingFlag</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">.tapeSendingFlag = 0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%10000101</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">    transmit baud rate 300 baud</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">          receive to 19200 baud</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">             tape system in use</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">                       motor on</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">serialULAControlRegister</span></a><span class="ACME-plain-syntax">                       </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%11010000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">A=%11010000</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">bit 7     - enable interrupts</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">bit 6/5   - RTS high, transmit</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">            interrupt disabled</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">bit 4/3/2 - 8 bit word, 2 stop bits</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">bit 1/0   - divide counter by 1</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setACIA6850ControlRegister</span><button class="popup" onclick="togglePopup('usagePopup13')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup13">Usage of <span class="code-font"><span class="ACME-function-syntax">setACIA6850ControlRegister</span></span>:<br/><a href="S-s21.html#SP8">&#167;8</a>, <a href="S-s21.html#SP21">&#167;21</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb63</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeBaudRate</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">set bits for baud rate:</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">5 = %101 means 1200 baud</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(divide by 16; 1 stop bit)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">6 = %110 means  300 baud</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(divide by 64; 1 stop bit)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">storeAToACIARegister</span><button class="popup" onclick="togglePopup('usagePopup14')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup14">Usage of <span class="code-font"><span class="ACME-function-syntax">storeAToACIARegister</span></span>:<br/><a href="S-s21.html#SP7">&#167;7</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb65</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP5" class="function-link"><span class="ACME-function-syntax">acia6850ControlRegister</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">set up ACIA control register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP10" class="paragraph-anchor"></a><b>&#167;10. incrementBlockNumbers. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">incrementBlockNumbers</span><button class="popup" onclick="togglePopup('usagePopup15')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup15">Usage of <span class="code-font"><span class="ACME-function-syntax">incrementBlockNumbers</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP12">&#167;12</a>, <a href="S-s18.html#SP26">&#167;26</a><br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP13">&#167;13</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb69</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockNumberLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">block number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockNumberHigh</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">block number high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X+1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberLow</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">current block number low</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=Y+1</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberHigh</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">current block number high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP11" class="paragraph-anchor"></a><b>&#167;11. zeroChecksumAndFSFlag. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">zeroChecksumAndFSFlag</span><button class="popup" onclick="togglePopup('usagePopup16')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup16">Usage of <span class="code-font"><span class="ACME-function-syntax">zeroChecksumAndFSFlag</span></span>:<br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP3">&#167;3</a>, <a href="S-s19.html#SP17">&#167;17</a>, <a href="S-s19.html#SP23">&#167;23</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb78</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #0                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsGotACharacterToReadOrWriteFlag</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">clear 'just read character' flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP12" class="paragraph-anchor"></a><b>&#167;12. setChecksumBytesToY. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Set (zero) checksum bytes</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       Y = value to store (always zero in practice)</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setChecksumBytesToY</span><button class="popup" onclick="togglePopup('usagePopup17')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup17">Usage of <span class="code-font"><span class="ACME-function-syntax">setChecksumBytesToY</span></span>:<br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP17">&#167;17</a>, <a href="S-s19.html#SP23">&#167;23</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb7c</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumLow</span></a><span class="ACME-plain-syntax">                                </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumHigh</span></a><span class="ACME-plain-syntax">                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP13" class="paragraph-anchor"></a><b>&#167;13. Copy zero terminated string to .filenameToSearchFor. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       X is offset from $301 for source string</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">copyToSoughtFilename</span><button class="popup" onclick="togglePopup('usagePopup18')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup18">Usage of <span class="code-font"><span class="ACME-function-syntax">copyToSoughtFilename</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP32">&#167;32</a><br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP8">&#167;8</a>, <a href="S-s19.html#SP12">&#167;12</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb81</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">Y=$FF</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=Y+1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X+1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP15" class="function-link"><span class="ACME-function-syntax">vduVariablesStart</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">filenameToSearchFor</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">sought filename</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">until end of filename (0)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP14" class="paragraph-anchor"></a><b>&#167;14. zeroFileHandleAndMotorOn. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">zeroFileHandleAndMotorOn</span><button class="popup" onclick="togglePopup('usagePopup19')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup19">Usage of <span class="code-font"><span class="ACME-function-syntax">zeroFileHandleAndMotorOn</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP32">&#167;32</a><br/>Chapter 20: Filing System Messaging and Error Reporting - <a href="S-s20.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb8e</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">Y=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP15" class="paragraph-anchor"></a><b>&#167;15. storeFileHandleAndMotorOn. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">storeFileHandleAndMotorOn</span><button class="popup" onclick="togglePopup('usagePopup20')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup20">Usage of <span class="code-font"><span class="ACME-function-syntax">storeFileHandleAndMotorOn</span></span>:<br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP17">&#167;17</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb90</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">enable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">X=1 (relay on)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeCurrentFileHandle</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">store Y as current file handle</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP16" class="paragraph-anchor"></a><b>&#167;16. controlMotor. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Control Tape Relay (On / Off)</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       X = 0 for relay off</span>
<span class="ACME-plain-syntax">       X = 1 for relay on</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">controlMotor</span><button class="popup" onclick="togglePopup('usagePopup21')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup21">Usage of <span class="code-font"><span class="ACME-function-syntax">controlMotor</span></span>:<br/><a href="S-s21.html#SP2">&#167;2</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb95</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #137                                            </span><span class="ACME-comment-syntax">do OSBYTE 137</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeCurrentFileHandle</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">get back file handle (preserved</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">through OSBYTE)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s24.html#SP6" class="function-link"><span class="ACME-function-syntax">OSBYTE</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">turn on motor</span>
</pre>
<p class="commentary firstcommentary"><a id="SP17" class="paragraph-anchor"></a><b>&#167;17. Check file is open. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = 1 means check file is open for reading (check bit 0 of tape status byte)</span>
<span class="ACME-plain-syntax">       A = 2 means check file is open for writing (check bit 1 of tape status byte)</span>
<span class="ACME-plain-syntax">       A = 3 means check file is open for reading or writing</span>
<span class="ACME-plain-syntax">       Y = file handle ('channel')</span>

<span class="ACME-plain-syntax"> On Exit:</span>
<span class="ACME-plain-syntax">       If file is not open then a 'Channel' error occurs</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">checkFileIsOpen</span><button class="popup" onclick="togglePopup('usagePopup22')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup22">Usage of <span class="code-font"><span class="ACME-function-syntax">checkFileIsOpen</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP33">&#167;33</a>, <a href="S-s18.html#SP35">&#167;35</a><br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP7">&#167;7</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fb9c</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsTempStorage</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">remember action type (1-3)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=Y=channel:</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">  1 = input file on tape</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">  2 = output file on tape</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">  3 = input file from ROMFS</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">tapeOrROMSwitch</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">EOR with filing system flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=A</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">now, Y = 1 for input</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">     Y = 2 for output</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsStatusByte</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">tape / ROM FS status byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsTempStorage</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">file status or temporary store</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry if open for input</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y = Y - 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (checking open for input) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry if open for output</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y = Y - 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP17" class="function-link"><span class="ACME-function-syntax">channelError</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">if (not checking open for output)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP21" class="function-link"><span class="ACME-function-syntax">exit36</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (file is open as expected) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (exit)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">channelError</span><button class="popup" onclick="togglePopup('usagePopup23')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup23">Usage of <span class="code-font"><span class="ACME-function-syntax">channelError</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP28">&#167;28</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fbb1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BRK</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$DE</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">error number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!text</span><span class="ACME-plain-syntax"> </span><span class="ACME-string-syntax">"Channel"</span><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">message</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">0</span><span class="ACME-plain-syntax">                                             </span><span class="ACME-comment-syntax">terminator</span>
</pre>
<p class="commentary firstcommentary"><a id="SP18" class="paragraph-anchor"></a><b>&#167;18. startSendToSecondProcessor. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> See NAUG Section 18.8, Page 340</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">startSendToSecondProcessor</span><button class="popup" onclick="togglePopup('usagePopup24')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup24">Usage of <span class="code-font"><span class="ACME-function-syntax">startSendToSecondProcessor</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP12">&#167;12</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fbbb</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">A=1 (Multiple single byte transfer:</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">main processor to second processor)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">secondProcessorTransfer</span><button class="popup" onclick="togglePopup('usagePopup25')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup25">Usage of <span class="code-font"><span class="ACME-function-syntax">secondProcessorTransfer</span></span>:<br/><a href="S-s21.html#SP2">&#167;2</a><br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP18">&#167;18</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fbbd</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP19" class="function-link"><span class="ACME-function-syntax">checkLoadAddressIsForSecondProcessor</span></a><span class="ACME-plain-syntax">           </span><span class="ACME-comment-syntax">check if load address is valid</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP21" class="function-link"><span class="ACME-function-syntax">exit36</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (load address is for main</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">processor) then branch (exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #&lt;.</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">loadAddressLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #&gt;.</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">loadAddressLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">} set up parameter block address</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">secondProcessorCall</span><button class="popup" onclick="togglePopup('usagePopup26')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup26">Usage of <span class="code-font"><span class="ACME-function-syntax">secondProcessorCall</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP20">&#167;20</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fbc7</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save A=1 on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP8" class="function-link"><span class="ACME-function-syntax">tubeClaimReasonCode</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP8" class="function-link"><span class="ACME-function-syntax">tubeCallerIDCassetteFS</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">Claim the Tube, caller is the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">Cassette Filing System</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP18" class="function-link"><span class="ACME-function-syntax">tubeTransferData</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">call out to Tube</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">keep trying to claim until claim is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">done</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">pull A=1 (Multiple single byte</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">transfer: main processor to second</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">processor)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP18" class="function-link"><span class="ACME-function-syntax">tubeTransferData</span></a><span class="ACME-plain-syntax">                               </span>
</pre>
<p class="commentary firstcommentary"><a id="SP19" class="paragraph-anchor"></a><b>&#167;19. Check load address for destination. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Check the top two bytes of the 32 bit load address. If they are both $FF, then it is for</span>
<span class="ACME-plain-syntax"> the main processor and we return with Z set. If the Tube is not present, then we also</span>
<span class="ACME-plain-syntax"> return with Z set. Otherwise it's for the Tube, we return with Z clear.</span>

<span class="ACME-plain-syntax"> On Exit:</span>
<span class="ACME-plain-syntax">       Z set if load address is for the second processor</span>
<span class="ACME-plain-syntax">       X is value of A on entry</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">checkLoadAddressIsForSecondProcessor</span><button class="popup" onclick="togglePopup('usagePopup27')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup27">Usage of <span class="code-font"><span class="ACME-function-syntax">checkLoadAddressIsForSecondProcessor</span></span>:<br/><a href="S-s21.html#SP18">&#167;18</a><br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP5">&#167;5</a>, <a href="S-s19.html#SP23">&#167;23</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fbd3</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">loadAddressMid2</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">current load address high word</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">loadAddressHigh</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">current load address high word</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if ($FF, i.e. it's for base</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">processor) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">tubePresentFlag</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">$FF if Tube is present</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%10000000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">Set bit 7 alone if Tube is present</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP20" class="paragraph-anchor"></a><b>&#167;20.  </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> This routine is actually a bugfix. Commented from the original source code:</span>

<span class="ACME-plain-syntax"> BUGFIX</span>

<span class="ACME-plain-syntax"> When the 6850 counter divide bits are reset, it is possible for the SERPROC to get out</span>
<span class="ACME-plain-syntax"> of synch. for a few bits. This has the effect of corrupting the first character of the</span>
<span class="ACME-plain-syntax"> first block of a SAVE, or the first character of ANY block during sequential access</span>
<span class="ACME-plain-syntax"> (since the 6850 is reset for every block during putbytes).</span>

<span class="ACME-plain-syntax"> The cure is to write a dummy byte to tape at the start of a SAVE, and at the start of</span>
<span class="ACME-plain-syntax"> every block during putbytes. This must be done by polling, since there must be a period</span>
<span class="ACME-plain-syntax"> of high-tone after the dummy byte, which is difficult to accomplish if the 6850 is</span>
<span class="ACME-plain-syntax"> interrupting all the time. BUGFIX is thus called after the SERPROC is set and before the</span>
<span class="ACME-plain-syntax"> 6850 is set to interrupt during a block write operation.</span>

<span class="ACME-plain-syntax"> ["SERPROC" refers to .serialULAControlRegister, and "BUGFIX" is this routine]</span>
</pre>
<p class="commentary firstcommentary"><a id="SP21" class="paragraph-anchor"></a><b>&#167;21. setupForCassetteWrite. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setupForCassetteWrite</span><button class="popup" onclick="togglePopup('usagePopup28')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup28">Usage of <span class="code-font"><span class="ACME-function-syntax">setupForCassetteWrite</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP18">&#167;18</a>, <a href="S-s18.html#SP32">&#167;32</a><br/>Chapter 20: Filing System Messaging and Error Reporting - <a href="S-s20.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fbe2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%10000101</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">} switch on the cassette motor and</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} relay</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">serialULAControlRegister</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">} and set 300 baud</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP7" class="function-link"><span class="ACME-function-syntax">resetACIA</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">reset ACIA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00010000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">} even parity</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} 2 stop bits</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} 8 bit word</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} 'Request To Send' ('RTS') low</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} (active)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP9" class="function-link"><span class="ACME-function-syntax">setACIA6850ControlRegister</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">set ACIA to tape filing system baud</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">rate</span>

<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s20.html#SP10" class="function-link"><span class="ACME-function-syntax">checkForEscapeDuringCassetteOperation</span></a><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">check for ESCAPE</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP6" class="function-link"><span class="ACME-function-syntax">acia6850StatusRegister</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">read ACIA status register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00000010</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">check bit 1 (transmit interrupt</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">generated)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (bit 1 clear, i.e. transmit</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupt generated) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(loop back and try again)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%10101010</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">A=$AA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP6" class="function-link"><span class="ACME-function-syntax">acia6850DataRegister</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">send byte to tape</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit36</span><button class="popup" onclick="togglePopup('usagePopup29')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup29">Usage of <span class="code-font"><span class="ACME-function-syntax">exit36</span></span>:<br/><a href="S-s21.html#SP17">&#167;17</a>, <a href="S-s21.html#SP18">&#167;18</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $fbfe</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">0</span><span class="ACME-plain-syntax">                                             </span><span class="ACME-comment-syntax">[unused]</span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="S-s20.html">&#10094;</a></li><li class="progresssection"><a href="S-s1.html">1</a></li><li class="progresssection"><a href="S-s2.html">2</a></li><li class="progresssection"><a href="S-s3.html">3</a></li><li class="progresssection"><a href="S-s4.html">4</a></li><li class="progresssection"><a href="S-s5.html">5</a></li><li class="progresssection"><a href="S-s6.html">6</a></li><li class="progresssection"><a href="S-s7.html">7</a></li><li class="progresssection"><a href="S-s8.html">8</a></li><li class="progresssection"><a href="S-s9.html">9</a></li><li class="progresssection"><a href="S-s10.html">10</a></li><li class="progresssection"><a href="S-s11.html">11</a></li><li class="progresssection"><a href="S-s12.html">12</a></li><li class="progresssection"><a href="S-s13.html">13</a></li><li class="progresssection"><a href="S-s14.html">14</a></li><li class="progresssection"><a href="S-s15.html">15</a></li><li class="progresssection"><a href="S-s16.html">16</a></li><li class="progresssection"><a href="S-s17.html">17</a></li><li class="progresssection"><a href="S-s18.html">18</a></li><li class="progresssection"><a href="S-s19.html">19</a></li><li class="progresssection"><a href="S-s20.html">20</a></li><li class="progresscurrent">21</li><li class="progresssection"><a href="S-s22.html">22</a></li><li class="progresssection"><a href="S-s23.html">23</a></li><li class="progresssection"><a href="S-s24.html">24</a></li><li class="progresssection"><a href="S-s25.html">25</a></li><li class="progresssection"><a href="S-s26.html">26</a></li><li class="progressnext"><a href="S-s22.html">&#10095;</a></li></ul></div>
</nav><!--End of weave-->

		</main>
	</body>
</html>

