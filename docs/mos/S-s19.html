<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Chapter 19: Low Level Tape Operations</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Carousel.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/ACME-Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<p>BBC Computer 32K</p>
<h1>*CAT</h1>
<ul><li><a href="../index.html">&#x21A9; home</a></li><li><a href="index.html"><span class="selectedlink">contents</span></a></li>
<li><a href="S-s1.html">introduction</a></li>
<li><a href="S-s2.html">constants</a></li>
<li><a href="S-s3.html">memory-mapped i/o</a></li>
<li><a href="S-s4.html"><b>$C000</b>: chapter 4</a></li>
<li><a href="S-s5.html"><b>$C4C0</b>: chapter 5</a></li>
<li><a href="S-s6.html"><b>$CB1D</b>: chapter 6</a></li>
<li><a href="S-s7.html"><b>$CCF8</b>: chapter 7</a></li>
<li><a href="S-s8.html"><b>$D060</b>: chapter 8</a></li>
<li><a href="S-s9.html"><b>$D7C2</b>: chapter 9</a></li>
<li><a href="S-s10.html"><b>$D940</b>: chapter 10</a></li>
<li><a href="S-s11.html"><b>$DC1C</b>: chapter 11</a></li>
<li><a href="S-s12.html"><b>$DEC5</b>: chapter 12</a></li>
<li><a href="S-s13.html"><b>$E0A4</b>: chapter 13</a></li>
<li><a href="S-s14.html"><b>$E20E</b>: chapter 14</a></li>
<li><a href="S-s15.html"><b>$E5B3</b>: chapter 15</a></li>
<li><a href="S-s16.html"><b>$EB03</b>: chapter 16</a></li>
<li><a href="S-s17.html"><b>$EEDA</b>: chapter 17</a></li>
<li><a href="S-s18.html"><b>$F135</b>: chapter 18</a></li>
<li><span class="unlink"><b>$F588</b>: chapter 19</span></li>
<li><a href="S-s20.html"><b>$F8A9</b>: chapter 20</a></li>
<li><a href="S-s21.html"><b>$FAE8</b>: chapter 21</a></li>
<li><a href="S-s22.html"><b>$FC00</b>: chapter 22</a></li>
<li><a href="S-s23.html"><b>$FF00</b>: chapter 23</a></li>
<li><a href="S-s24.html"><b>$FFA7</b>: chapter 24</a></li>
<li><a href="S-s25.html">appendix</a></li>
<li><a href="S-s26.html">index</a></li>

</ul>
		</nav>
		<main role="main">
		<!--Weave of 'Chapter 19: Low Level Tape Operations' generated by Inweb-->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">MOS 1.20</a></li><li><b>Chapter 19: Low Level Tape Operations</b></li></ul></div>
<p class="purpose">Update ACIA; Check EOF; Search for file; Spool or Exec file; Load and save block; Load block header; Load and save byte; Update CRC - 801 bytes (4.8%)</p>

<ul class="toc"><li><a href="S-s19.html#SP1">&#167;1. Update ACIA</a></li><li><a href="S-s19.html#SP2">&#167;2. Process byte after being read from tape or ROMFS</a></li><li><a href="S-s19.html#SP3">&#167;3. fsReadProgress2FoundCarrierTone</a></li><li><a href="S-s19.html#SP4">&#167;4. fsReadProgress3FoundSyncByte</a></li><li><a href="S-s19.html#SP5">&#167;5. fsReadProgress4FoundBlockData</a></li><li><a href="S-s19.html#SP6">&#167;6. fsReadProgress5FinishedReadingBlockData</a></li><li><a href="S-s19.html#SP7">&#167;7. Check for EOF on an open file</a></li><li><a href="S-s19.html#SP8">&#167;8. searchForFile</a></li><li><a href="S-s19.html#SP9">&#167;9. setBlockFlagsAndExit</a></li><li><a href="S-s19.html#SP10">&#167;10. Close a SPOOL / EXEC file</a></li><li><a href="S-s19.html#SP11">&#167;11. Close EXEC file and optionally open a new EXEC file</a></li><li><a href="S-s19.html#SP12">&#167;12. bgetReadBlockAndHeader</a></li><li><a href="S-s19.html#SP13">&#167;13. Set Load Address and Load Block</a></li><li><a href="S-s19.html#SP14">&#167;14. searchForBlock</a></li><li><a href="S-s19.html#SP15">&#167;15. checkForROMBlockMarker</a></li><li><a href="S-s19.html#SP16">&#167;16. clearCatalogueStatusBadROM</a></li><li><a href="S-s19.html#SP17">&#167;17. readTapeBlockHeader</a></li><li><a href="S-s19.html#SP18">&#167;18. Read block header</a></li><li><a href="S-s19.html#SP19">&#167;19. Read byte from tape or ROM</a></li><li><a href="S-s19.html#SP20">&#167;20. Update CRC</a></li><li><a href="S-s19.html#SP21">&#167;21. Set state ready for loading block data (or reset)</a></li><li><a href="S-s19.html#SP22">&#167;22. Set state ready for loading block data or searching (or reset state)</a></li><li><a href="S-s19.html#SP23">&#167;23. Save a block to tape</a></li><li><a href="S-s19.html#SP24">&#167;24. saveByteAToTapeAndUpdateCRC</a></li><li><a href="S-s19.html#SP25">&#167;25. saveChecksumToTape</a></li><li><a href="S-s19.html#SP26">&#167;26. Save a byte to tape</a></li><li><a href="S-s19.html#SP27">&#167;27. waitFiveSeconds</a></li><li><a href="S-s19.html#SP28">&#167;28. Delay for the (temporary) interblock gap time</a></li><li><a href="S-s19.html#SP29">&#167;29. Wait for A/10 seconds, or until ESCAPE is pressed</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. Update ACIA. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> If necessary, read or write a byte to cassette, or read a byte from ROMFS.</span>
<span class="ACME-plain-syntax"> Can either be called from interrupt routine, or when loading from cassette.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">updateACIA</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="ACME-function-syntax">updateACIA</span></span>:<br/>Chapter 11: Interrupt processing - <a href="S-s11.html#SP7">&#167;7</a><br/>Chapter 20: Filing System Messaging and Error Reporting - <a href="S-s20.html#SP21">&#167;21</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f588</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsGotACharacterToReadOrWriteFlag</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">Used when writing to tape,</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to decrement the value from zero to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">255 indicating the byte has been</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">written (which happens below)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">tapeOrROMSwitch</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">filing system flag 0=tape; 2=ROMFS</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP1" class="function-link"><span class="ACME-function-syntax">updateACIATape</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (tape filing system active) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with reading a byte from ROM / PHROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP20" class="function-link"><span class="ACME-function-syntax">readByteFromROMFSorPHROM</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">read ROMFS data ROM or PHROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">clear carry flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP2" class="function-link"><span class="ACME-function-syntax">postReadByte</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">ALWAYS branch</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">updateACIATape</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f596</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with reading or writing to tape</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP6" class="function-link"><span class="ACME-function-syntax">acia6850StatusRegister</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">ACIA status register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save A on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #2                                              </span><span class="ACME-comment-syntax">clear all but bit 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP1" class="function-link"><span class="ACME-function-syntax">readByteFromTape</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">if (transmit data register full,</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">i.e. not ready to send) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(read from tape)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeSendingFlag</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">check we are sending to tape</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP1" class="function-link"><span class="ACME-function-syntax">readByteFromTape</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">if (not sending to tape) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (read from tape)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">send a byte to tape</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsCharacterJustReadOrCharToWrite</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">get character to send</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP6" class="function-link"><span class="ACME-function-syntax">acia6850DataRegister</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">ACIA transmit data register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">read a byte from tape</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readByteFromTape</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f5a9</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP6" class="function-link"><span class="ACME-function-syntax">acia6850DataRegister</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">read ACIA receive data register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} shift bit 2 to carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} (data carrier detect)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through</span>
</pre>
<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. Process byte after being read from tape or ROMFS. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> This is called from the 100Hz interrupt routine. It updates the read progress state as</span>
<span class="ACME-plain-syntax"> needed, and stores the byte for later processing in .readBlockHeader and</span>
<span class="ACME-plain-syntax"> .readTapeBlockHeader.</span>
<span class="ACME-plain-syntax"> See .</span><a href="S-s19.html#SP18" class="internal">readBlockHeader</a><span class="ACME-plain-syntax">.</span>
<span class="ACME-plain-syntax"> See .</span><a href="S-s19.html#SP17" class="internal">readTapeBlockHeader</a><span class="ACME-plain-syntax">.</span>

<span class="ACME-plain-syntax"> The progress in reading a block is tracked by a progress byte (0-5):</span>

<span class="ACME-plain-syntax"> See .</span><a href="S-s2.html#SP11" class="internal">fsReadProgressState</a>

<span class="ACME-plain-syntax">     0 - exit</span>
<span class="ACME-plain-syntax">     1 - looking for carrier tone</span>
<span class="ACME-plain-syntax">     2 - found carrier tone, waiting for sync byte $2A</span>
<span class="ACME-plain-syntax">     3 - found sync byte $2A, now reading header</span>
<span class="ACME-plain-syntax">     4 - have read the header with non-zero block data length, now reading actual block data</span>
<span class="ACME-plain-syntax">     5 - finished reading data in block</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       Y = byte just read</span>
<span class="ACME-plain-syntax">       Carry set if it's the tape filing system and 'data carrier detect' bit is set</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">postReadByte</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="ACME-function-syntax">postReadByte</span></span>:<br/><a href="S-s19.html#SP1">&#167;1</a><br/>Chapter 2: Memory Layout and Constants - <a href="S-s2.html#SP11">&#167;11</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f5b0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsReadProgressState</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read progress state</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">exit31</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (.fsReadProgressState = 0) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X-1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP3" class="function-link"><span class="ACME-function-syntax">fsReadProgress2FoundCarrierTone</span></a><span class="ACME-plain-syntax">                </span><span class="ACME-comment-syntax">if (.fsReadProgressState &gt; 1) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with progress state = 1 (looking for carrier tone)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">exit31</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (reading from ROM OR carrier</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">tone from cassette not detected)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #2                                              </span><span class="ACME-comment-syntax">Y=2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">storeTapeProgress</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">ALWAYS branch (store progress and</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">return)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3. fsReadProgress2FoundCarrierTone. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">fsReadProgress2FoundCarrierTone</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="ACME-function-syntax">fsReadProgress2FoundCarrierTone</span></span>:<br/><a href="S-s19.html#SP2">&#167;2</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f5bd</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X-1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP4" class="function-link"><span class="ACME-function-syntax">fsReadProgress3FoundSyncByte</span></a><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">if (.fsReadProgressState &gt; 2) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with progress state = 2 (found carrier tone, waiting for it to finish)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">exit31</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (carrier tone from cassette</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">still detected) then branch (exit)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=Y=byte read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP11" class="function-link"><span class="ACME-function-syntax">zeroChecksumAndFSFlag</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">initialise CRC checksum to zero</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">Y=3</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP9" class="function-link"><span class="ACME-function-syntax">fsSynchronisationByte</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">check for the sync byte $2A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">storeTapeProgress</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">if (found sync byte) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(store state and return)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">sync byte not found, revert back to progress state 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP9" class="function-link"><span class="ACME-function-syntax">flipRelayOffAndOnThenSetToReadFromTape</span></a><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">control cassette system</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">Y=1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">storeTapeProgress</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">ALWAYS branch</span>
</pre>
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. fsReadProgress3FoundSyncByte. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">fsReadProgress3FoundSyncByte</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="ACME-function-syntax">fsReadProgress3FoundSyncByte</span></span>:<br/><a href="S-s19.html#SP3">&#167;3</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f5d3</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X-1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP5" class="function-link"><span class="ACME-function-syntax">fsReadProgress4FoundBlockData</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">if (.fsReadProgressState &gt; 3) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with progress state = 3 (found sync byte $2A, reading block header)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (carrier detected) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsCharacterJustReadOrCharToWrite</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">store byte just read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">exit31</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (zero) then branch (exit)</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$80</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">A=$80</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsGotACharacterToReadOrWriteFlag</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">note that we have just read a byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">exit31</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">ALWAYS branch (exit)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5. fsReadProgress4FoundBlockData. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">fsReadProgress4FoundBlockData</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="ACME-function-syntax">fsReadProgress4FoundBlockData</span></span>:<br/><a href="S-s19.html#SP4">&#167;4</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f5e2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X-1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">fsReadProgress5FinishedReadingBlockData</span></a><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">if (.fsReadProgressState &gt; 4) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with progress state = 4 (found non-zero length block, reading block data)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">if carrier detected then reset progress to zero</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">resetACIAAndResetProgress</span></a><span class="ACME-plain-syntax">                      </span><span class="ACME-comment-syntax">if (carry set) then branch (reset</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">and return)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=Y=byte just read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP20" class="function-link"><span class="ACME-function-syntax">updateCRC</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">perform CRC</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsTempStorage</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">get length of block read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsTempStorage</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">increment length of block read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsCharacterJustReadOrCharToWrite</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">check if bit 7 set (meaning</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">searching, not loading)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP5" class="function-link"><span class="ACME-function-syntax">checkForEndOfBlock</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">if (searching) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">send byte to second processor if needed, or store byte in regular memory</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP19" class="function-link"><span class="ACME-function-syntax">checkLoadAddressIsForSecondProcessor</span></a><span class="ACME-plain-syntax">           </span><span class="ACME-comment-syntax">check load address is ok</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">also puts value of A (the byte</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">just read) into X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (load address is not for second</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">processor) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP27" class="function-link"><span class="ACME-function-syntax">tubeULADataRegister3</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">Write byte to Tube. This triggers</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">an NMI on the co-processor.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP5" class="function-link"><span class="ACME-function-syntax">checkForEndOfBlock</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">ALWAYS branch</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=X restore value</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">loadAddressLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">store byte at current load address</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">checkForEndOfBlock</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f600</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=Y+1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockLengthLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">block length</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">exit31</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (not equal) then branch (exit)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">reached end of block data</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">A=1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsTempStorage</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">loop counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #5                                              </span><span class="ACME-comment-syntax">Y=5</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">storeTapeProgress</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">ALWAYS branch (store progress and</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">return)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6. fsReadProgress5FinishedReadingBlockData. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">fsReadProgress5FinishedReadingBlockData</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="ACME-function-syntax">fsReadProgress5FinishedReadingBlockData</span></span>:<br/><a href="S-s19.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f60e</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">this first section reads two more bytes (one byte at a time) by using .fsTempStorage</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">(which was initialised to 1 on the previous progress state above) as a loop counter.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=Y=byte read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP20" class="function-link"><span class="ACME-function-syntax">updateCRC</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">update CRC</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsTempStorage</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">decrement loop counter (1,0)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP6" class="function-link"><span class="ACME-function-syntax">exit31</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">exit if loop is not done</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">resetACIAAndResetProgress</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="ACME-function-syntax">resetACIAAndResetProgress</span></span>:<br/><a href="S-s19.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f616</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP7" class="function-link"><span class="ACME-function-syntax">resetACIA</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">reset ACIA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">Y=0</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">storeTapeProgress</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="ACME-function-syntax">storeTapeProgress</span></span>:<br/><a href="S-s19.html#SP2">&#167;2</a>, <a href="S-s19.html#SP3">&#167;3</a>, <a href="S-s19.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f61b</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsReadProgressState</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">progress flag</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit31</span><button class="popup" onclick="togglePopup('usagePopup9')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup9">Usage of <span class="code-font"><span class="ACME-function-syntax">exit31</span></span>:<br/><a href="S-s19.html#SP2">&#167;2</a>, <a href="S-s19.html#SP3">&#167;3</a>, <a href="S-s19.html#SP4">&#167;4</a>, <a href="S-s19.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f61d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP7" class="paragraph-anchor"></a><b>&#167;7. Check for EOF on an open file. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       X = file handle</span>
<span class="ACME-plain-syntax"> On Exit:</span>
<span class="ACME-plain-syntax">       Preserves A,Y</span>
<span class="ACME-plain-syntax">       X is 0 if EOF reached</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">checkEOFEntryPoint</span><button class="popup" onclick="togglePopup('usagePopup10')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup10">Usage of <span class="code-font"><span class="ACME-function-syntax">checkEOFEntryPoint</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP7">&#167;7</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f61e</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save A on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save Y on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} Y=X=file handle</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">A=3 (meaning check for file being</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">open for read or write)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP17" class="function-link"><span class="ACME-function-syntax">checkFileIsOpen</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">confirm file is open (otherwise</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">BRK with 'Channel' error)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsStatusByte</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">tape / ROM FS status byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%01000000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">mask for just the EOF flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP8" class="paragraph-anchor"></a><b>&#167;8. searchForFile. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">searchForFile</span><button class="popup" onclick="togglePopup('usagePopup11')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup11">Usage of <span class="code-font"><span class="ACME-function-syntax">searchForFile</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP9">&#167;9</a>, <a href="S-s18.html#SP29">&#167;29</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f631</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberLow</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">} reset current block number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberHigh</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">searchForSpecifiedBlock</span><button class="popup" onclick="togglePopup('usagePopup12')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup12">Usage of <span class="code-font"><span class="ACME-function-syntax">searchForSpecifiedBlock</span></span>:<br/><a href="S-s19.html#SP14">&#167;14</a><br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP14">&#167;14</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f637</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberLow</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">current block number (low byte)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save A on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">nextBlockNumberLow</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">save as next block number (low byte)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberHigh</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">current block number (high byte)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save A on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">nextBlockNumberHigh</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">save as next block number (high byte)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s20.html#SP16" class="function-link"><span class="ACME-function-syntax">safePrintFollowingMessage</span></a><span class="ACME-plain-syntax">                      </span><span class="ACME-comment-syntax">print message following call</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!text</span><span class="ACME-plain-syntax"> </span><span class="ACME-string-syntax">"Searching"</span><span class="ACME-plain-syntax">                                   </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!text</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP2" class="function-link"><span class="ACME-function-syntax">charRETURN</span></a><span class="ACME-plain-syntax">,0                                 </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">A=$FF (Meaning 'Must match filename</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">and block number')</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s18.html#SP25" class="function-link"><span class="ACME-function-syntax">searchForBlockCheckFilingSystem</span></a><span class="ACME-plain-syntax">                </span><span class="ACME-comment-syntax">read data from tape filing</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">system/ROMFS</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberHigh</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">current block number high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberLow</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">current block number low</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">nextBlockNumberLow</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">next block number low</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">nextBlockNumberHigh</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">next block number high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberLow</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">zero current block number low</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberHigh</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">zero current block number high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">checksumIsValidFlag</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">checksum result</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #(.</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsFilename</span></a><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">1) </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP15" class="function-link"><span class="ACME-function-syntax">vduVariablesStart</span></a><span class="ACME-plain-syntax">           </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP13" class="function-link"><span class="ACME-function-syntax">copyToSoughtFilename</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">copy filename from .fsFilename to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">.filenameToSearchFor</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">tapeOrROMSwitch</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">filing system flag 0=tape filing</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">system; 2=ROMFS</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP9" class="function-link"><span class="ACME-function-syntax">setBlockFlagsAndExit</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">if (tape filing system active) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVS</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP9" class="function-link"><span class="ACME-function-syntax">setBlockFlagsAndExit</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">if (V set) then branch</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">fileNotFoundError</span><button class="popup" onclick="togglePopup('usagePopup13')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup13">Usage of <span class="code-font"><span class="ACME-function-syntax">fileNotFoundError</span></span>:<br/><a href="S-s19.html#SP11">&#167;11</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f674</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BRK</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$D6</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">Error number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!text</span><span class="ACME-plain-syntax"> </span><span class="ACME-string-syntax">"File not found"</span><span class="ACME-plain-syntax">,0                            </span>
</pre>
<p class="commentary firstcommentary"><a id="SP9" class="paragraph-anchor"></a><b>&#167;9. setBlockFlagsAndExit. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setBlockFlagsAndExit</span><button class="popup" onclick="togglePopup('usagePopup14')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup14">Usage of <span class="code-font"><span class="ACME-function-syntax">setBlockFlagsAndExit</span></span>:<br/><a href="S-s19.html#SP8">&#167;8</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f685</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">Y=$FF</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsLastBlockReadFlagsCopy</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">copy of last read block flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP10" class="paragraph-anchor"></a><b>&#167;10. Close a SPOOL / EXEC file. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">closeSpoolOrExecFile</span><button class="popup" onclick="togglePopup('usagePopup15')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup15">Usage of <span class="code-font"><span class="ACME-function-syntax">closeSpoolOrExecFile</span></span>:<br/>Chapter 14: Star commands - <a href="S-s14.html#SP6">&#167;6</a><br/>Chapter 20: Filing System Messaging and Error Reporting - <a href="S-s20.html#SP14">&#167;14</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f68b</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">A=0, Z=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP11" class="paragraph-anchor"></a><b>&#167;11. Close EXEC file and optionally open a new EXEC file. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = 0</span>
<span class="ACME-plain-syntax">       Z = 0 means close any open EXEC file.</span>
<span class="ACME-plain-syntax">       Z = 1 means open the exec file whose filename is in address XY.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">closeAndOptionallyOpenANewEXECFile</span><button class="popup" onclick="togglePopup('usagePopup16')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup16">Usage of <span class="code-font"><span class="ACME-function-syntax">closeAndOptionallyOpenANewEXECFile</span></span>:<br/>Chapter 12: Command Line Interpreter (star commands) - <a href="S-s12.html#SP4">&#167;4</a><br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP4">&#167;4</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f68d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempWorkspaceE6</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">.tempWorkspaceE6 = Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">execFileHandle</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">file handle of EXEC file to be closed</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">execFileHandle</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">record EXEC file closed (A=0)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (closing an exec file) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s24.html#SP6" class="function-link"><span class="ACME-function-syntax">OSFIND</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">close EXEC file (A=0; Y=file handle)</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempWorkspaceE6</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">Y = original Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (zero flag set on entry) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$40</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">A is value for opening an input file</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s24.html#SP6" class="function-link"><span class="ACME-function-syntax">OSFIND</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">open an EXEC file</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP8" class="function-link"><span class="ACME-function-syntax">fileNotFoundError</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">If (Y ===0) then branch ('File not</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">found')</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">execFileHandle</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">store EXEC file handle</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP12" class="paragraph-anchor"></a><b>&#167;12. bgetReadBlockAndHeader. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">bgetReadBlockAndHeader</span><button class="popup" onclick="togglePopup('usagePopup17')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup17">Usage of <span class="code-font"><span class="ACME-function-syntax">bgetReadBlockAndHeader</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP33">&#167;33</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f6ac</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #(.</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">bgetFilename</span></a><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">1) </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP15" class="function-link"><span class="ACME-function-syntax">vduVariablesStart</span></a><span class="ACME-plain-syntax">         </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP13" class="function-link"><span class="ACME-function-syntax">copyToSoughtFilename</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">copy filename from .bgetFilename to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">.filenameToSearchFor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP18" class="function-link"><span class="ACME-function-syntax">readBlockHeader</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">read block header. On exit V is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">clear for last block of ROMFS.</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">checkLockedFlag</span><button class="popup" onclick="togglePopup('usagePopup18')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup18">Usage of <span class="code-font"><span class="ACME-function-syntax">checkLockedFlag</span></span>:<br/><a href="S-s19.html#SP14">&#167;14</a><br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP29">&#167;29</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f6b4</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockFlagByte</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">block flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">move bit 0 into carry to check for a</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">'locked' file</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP13" class="function-link"><span class="ACME-function-syntax">setLoadAddressAndLoadBlock</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">if (not locked) then branch (skip</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">next instruction)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s18.html#SP11" class="function-link"><span class="ACME-function-syntax">fileLocked</span></a><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">'locked' file routine</span>
</pre>
<p class="commentary firstcommentary"><a id="SP13" class="paragraph-anchor"></a><b>&#167;13. Set Load Address and Load Block. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setLoadAddressAndLoadBlock</span><button class="popup" onclick="togglePopup('usagePopup19')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup19">Usage of <span class="code-font"><span class="ACME-function-syntax">setLoadAddressAndLoadBlock</span></span>:<br/><a href="S-s19.html#SP12">&#167;12</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f6bd</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">nextBGETBlockLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">Expected BGET file block number low</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberLow</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">current block number low</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">nextBGETBlockHigh</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">expected BGET file block number high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentBlockNumberHigh</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">current block number high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #&lt;.</span><a href="S-s2.html#SP21" class="function-link"><span class="ACME-function-syntax">tapeOrRS423InputBuffer</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">loadAddressLow</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #&gt;.</span><a href="S-s2.html#SP21" class="function-link"><span class="ACME-function-syntax">tapeOrRS423InputBuffer</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">loadAddressMid1</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">} set load address to $FFFF0A00</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">} (i.e. .tapeOrRS423InputBuffer)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">loadAddressMid2</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">loadAddressHigh</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP21" class="function-link"><span class="ACME-function-syntax">setStateForLoadingBlockDataOrReset</span></a><span class="ACME-plain-syntax">             </span><span class="ACME-comment-syntax">set progress to read block data</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s20.html#SP12" class="function-link"><span class="ACME-function-syntax">loadBlock</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">load block from tape</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP14" class="function-link"><span class="ACME-function-syntax">searchForBlock</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (non zero) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP21" class="function-link"><span class="ACME-function-syntax">tapeOrRS423InputBuffer</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">get last character from input buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">lastCharacterOfCurrentlyResidentBlock</span></a><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">last character currently resident</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">block</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP10" class="function-link"><span class="ACME-function-syntax">incrementBlockNumbers</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">inc. current block number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">nextBGETBlockLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">expected BGET file block number low</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">nextBGETBlockHigh</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">expected BGET file block number high</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #2                                              </span><span class="ACME-comment-syntax">X = loop counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockLengthLow</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">read bytes from block flag/block</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">length</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">tapeInputCurrentBlockSizeLow</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">store into current values of above</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X-1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">until X=-1 ($FF)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">blockFlagOfCurrentlyResidentBlock</span></a><span class="ACME-plain-syntax">              </span><span class="ACME-comment-syntax">block flag of currently resident</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">block</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not last block) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(don't print newline)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s18.html#SP13" class="function-link"><span class="ACME-function-syntax">printReturnSafely</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">print newline if needed</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP2" class="function-link"><span class="ACME-function-syntax">cancelTapeOperationAndMotor</span></a><span class="ACME-plain-syntax">                    </span>
</pre>
<p class="commentary firstcommentary"><a id="SP14" class="paragraph-anchor"></a><b>&#167;14. searchForBlock. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">searchForBlock</span><button class="popup" onclick="togglePopup('usagePopup20')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup20">Usage of <span class="code-font"><span class="ACME-function-syntax">searchForBlock</span></span>:<br/><a href="S-s19.html#SP13">&#167;13</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f702</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP8" class="function-link"><span class="ACME-function-syntax">searchForSpecifiedBlock</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">search for a specified block</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP12" class="function-link"><span class="ACME-function-syntax">checkLockedFlag</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">ALWAYS branch (check for locked</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">condition)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP15" class="paragraph-anchor"></a><b>&#167;15. checkForROMBlockMarker. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">checkForROMBlockMarker</span><button class="popup" onclick="togglePopup('usagePopup21')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup21">Usage of <span class="code-font"><span class="ACME-function-syntax">checkForROMBlockMarker</span></span>:<br/><a href="S-s19.html#SP18">&#167;18</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f707</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP9" class="function-link"><span class="ACME-function-syntax">fsSynchronisationByte</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">check for synchronising byte $2A (at</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">start of first block)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP17" class="function-link"><span class="ACME-function-syntax">startOfBlock</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">if (found synchronising byte for</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">first block) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP9" class="function-link"><span class="ACME-function-syntax">romFSMiddleBlockHeaderByte</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">check for header byte for a middle</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">block</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP16" class="function-link"><span class="ACME-function-syntax">clearCatalogueStatusBadROM</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">if (middle block header not found)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (error 'Bad ROM')</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockNumberLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">block number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockNumberHigh</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">block number high</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">X=$FF</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s10.html#SP2" class="function-link"><span class="ACME-function-syntax">allBitsSet</span></a><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">set N and V flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP17" class="function-link"><span class="ACME-function-syntax">clearChecksumTapeProgress</span></a><span class="ACME-plain-syntax">                      </span><span class="ACME-comment-syntax">ALWAYS branch</span>
</pre>
<p class="commentary firstcommentary"><a id="SP16" class="paragraph-anchor"></a><b>&#167;16. clearCatalogueStatusBadROM. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">clearCatalogueStatusBadROM</span><button class="popup" onclick="togglePopup('usagePopup22')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup22">Usage of <span class="code-font"><span class="ACME-function-syntax">clearCatalogueStatusBadROM</span></span>:<br/><a href="S-s19.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f71e</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%11110111</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s18.html#SP22" class="function-link"><span class="ACME-function-syntax">clearTapeStatusBits</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">} clear current catalogue status</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">[this could just call</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax"> JSR .clearCatalogueStatus</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax"> instead of the LDA/JSR instructions</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax"> above, for a 2 byte saving]</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">badROMError</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f723</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BRK</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">cause error</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$D7</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">error number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!text</span><span class="ACME-plain-syntax"> </span><span class="ACME-string-syntax">"Bad ROM"</span><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">message</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">0</span><span class="ACME-plain-syntax">                                             </span><span class="ACME-comment-syntax">terminator</span>
</pre>
<p class="commentary firstcommentary"><a id="SP17" class="paragraph-anchor"></a><b>&#167;17. readTapeBlockHeader. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readTapeBlockHeader</span><button class="popup" onclick="togglePopup('usagePopup23')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup23">Usage of <span class="code-font"><span class="ACME-function-syntax">readTapeBlockHeader</span></span>:<br/><a href="S-s19.html#SP18">&#167;18</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f72d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP15" class="function-link"><span class="ACME-function-syntax">storeFileHandleAndMotorOn</span></a><span class="ACME-plain-syntax">                      </span><span class="ACME-comment-syntax">switch Motor on</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">A=1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsReadProgressState</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">start the read progress state</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP9" class="function-link"><span class="ACME-function-syntax">flipRelayOffAndOnThenSetToReadFromTape</span></a><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">control serial system</span>

<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s20.html#SP10" class="function-link"><span class="ACME-function-syntax">checkForEscapeDuringCassetteOperation</span></a><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">confirm ESC not set and tape filing</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">system not executing</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">A=3</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsReadProgressState</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">progress flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">back until .fsReadProgressState=3</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">startOfBlock</span><button class="popup" onclick="togglePopup('usagePopup24')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup24">Usage of <span class="code-font"><span class="ACME-function-syntax">startOfBlock</span></span>:<br/><a href="S-s19.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f742</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">Y=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP12" class="function-link"><span class="ACME-function-syntax">setChecksumBytesToY</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">zero checksum bytes</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">read filename</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP19" class="function-link"><span class="ACME-function-syntax">readByteFromTapeOrROM</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">get character from file and do CRC</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVC</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP17" class="function-link"><span class="ACME-function-syntax">reachedEndOfHeader</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">if (V clear) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsFilename</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">store</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">or if A=0 then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=Y+1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPY</span><span class="ACME-plain-syntax"> #11                                             </span><span class="ACME-comment-syntax">check Y against 11</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (Y != 11) then branch (go back</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">for next character)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=10</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">read rest of header</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #12                                             </span><span class="ACME-comment-syntax">X=loop counter (from 12 to 31) to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">read rest of header</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP19" class="function-link"><span class="ACME-function-syntax">readByteFromTapeOrROM</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">get character from file and do CRC</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVC</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP17" class="function-link"><span class="ACME-function-syntax">reachedEndOfHeader</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">if (V clear) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsFilename</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">store byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X+1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPX</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$1F</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">check X for 31</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (X is not 31) then loop back</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">reachedEndOfHeader</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f766</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} X=Y=length of filename</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">A=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsFilename</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">store terminator</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumLow</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumHigh</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">} Check if the CRC value is zero</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">checksumIsValidFlag</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">Checksum result is zero if valid</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">clearChecksumTapeProgress</span><button class="popup" onclick="togglePopup('usagePopup25')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup25">Usage of <span class="code-font"><span class="ACME-function-syntax">clearChecksumTapeProgress</span></span>:<br/><a href="S-s19.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f773</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP11" class="function-link"><span class="ACME-function-syntax">zeroChecksumAndFSFlag</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">reset checksum etc</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsReadProgressState</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">reset progress (Y=0)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=X=length of filename</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP20" class="function-link"><span class="ACME-function-syntax">exit32</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">The tape filename is always non-zero</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">in length so:</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">ALWAYS branch (exit)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">[In which case, RTS would be shorter]</span>
</pre>
<p class="commentary firstcommentary"><a id="SP18" class="paragraph-anchor"></a><b>&#167;18. Read block header. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Exit:</span>
<span class="ACME-plain-syntax">       V = clear if final block</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readBlockHeader</span><button class="popup" onclick="togglePopup('usagePopup26')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup26">Usage of <span class="code-font"><span class="ACME-function-syntax">readBlockHeader</span></span>:<br/><a href="S-s19.html#SP12">&#167;12</a><br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP12">&#167;12</a>, <a href="S-s18.html#SP26">&#167;26</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f77b</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">tapeOrROMSwitch</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">filing system flag 0=tape; 2=ROMFS</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP17" class="function-link"><span class="ACME-function-syntax">readTapeBlockHeader</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">if (tape filing system active) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Read ROM file header</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">See NAUG Section 17.5.6, Page 317 for ROM data format</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP20" class="function-link"><span class="ACME-function-syntax">readByteFromROMFSorPHROM</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">read ROMFS data ROM or PHROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP9" class="function-link"><span class="ACME-function-syntax">romFSFinalBlockHeaderByte</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">check for ROM file terminator</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP15" class="function-link"><span class="ACME-function-syntax">checkForROMBlockMarker</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">if (not terminator) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">ROM file terminator found</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00001000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">A=isolating bit 3 (catalogue status)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsStatusByte</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">check catalogue status</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (clear) then branch (skip next</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">instruction)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s18.html#SP13" class="function-link"><span class="ACME-function-syntax">saveFlagsPrintCR</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">print CR safely</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP19" class="function-link"><span class="ACME-function-syntax">readByteFromROMOrPHROM</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">get byte from data ROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (carry clear) then branch (loop</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">back and try again)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLV</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">clear overflow flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP19" class="paragraph-anchor"></a><b>&#167;19. Read byte from tape or ROM. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readByteFromTapeOrROM</span><button class="popup" onclick="togglePopup('usagePopup27')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup27">Usage of <span class="code-font"><span class="ACME-function-syntax">readByteFromTapeOrROM</span></span>:<br/><a href="S-s19.html#SP17">&#167;17</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f797</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">tapeOrROMSwitch</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">filing system flag 0=tape; 2=ROMFS</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (tape filing system active) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with ROMFS read byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} save X and Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP20" class="function-link"><span class="ACME-function-syntax">readByteFromROMFSorPHROM</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">read ROMFS data ROM or PHROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsCharacterJustReadOrCharToWrite</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">store character just read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">Top bit set</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsGotACharacterToReadOrWriteFlag</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">note that we have just read a byte</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">set 'flag' to $FF to avoid waiting</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">for</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">byte to be read (c.f. from tape)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} restore X and Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP26" class="function-link"><span class="ACME-function-syntax">waitForByteToReadOrWrite</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">check for Escape and loop till bit 7</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">of FS buffer flag=1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP20" class="paragraph-anchor"></a><b>&#167;20. Update CRC. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> A cyclic redundancy check is updated one byte at a time.</span>

<span class="ACME-plain-syntax"> Pseudo-code is as follows. HL = high and low bytes of the CRC. A = byte on input.</span>

<span class="ACME-plain-syntax">   H = A EOR H</span>
<span class="ACME-plain-syntax">   FOR X = 1 TO 8</span>
<span class="ACME-plain-syntax">       Carry=bit 7 of H</span>
<span class="ACME-plain-syntax">       IF (Carry = 1) THEN HL=HL EOR $0810</span>
<span class="ACME-plain-syntax">       HL=(HL*2 + Carry) AND $FFFF</span>
<span class="ACME-plain-syntax">   NEXT X</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = byte just written or read</span>
<span class="ACME-plain-syntax">       Preserves A, X and Y</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">updateCRC</span><button class="popup" onclick="togglePopup('usagePopup28')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup28">Usage of <span class="code-font"><span class="ACME-function-syntax">updateCRC</span></span>:<br/><a href="S-s19.html#SP5">&#167;5</a>, <a href="S-s19.html#SP6">&#167;6</a>, <a href="S-s19.html#SP24">&#167;24</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f7b0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save A on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} Set top bit of CRC bit counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeCRCBitCounter</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">} This acts as a loop counter</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumHigh</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumHigh</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">} H = A EOR H</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumHigh</span></a><span class="ACME-plain-syntax">                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Carry = bit 7 (A = A * 2)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A = A / 2 = H</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$08</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumHigh</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumLow</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">} HL=HL EOR $0810</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$10</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumLow</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry flag</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumLow</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumHigh</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">} HL=(HL*2 + Carry) AND &amp;FFFF</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeCRCBitCounter</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">shift loop counter right</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (eight bits not processed) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit32</span><button class="popup" onclick="togglePopup('usagePopup29')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup29">Usage of <span class="code-font"><span class="ACME-function-syntax">exit32</span></span>:<br/><a href="S-s19.html#SP17">&#167;17</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f7d4</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP21" class="paragraph-anchor"></a><b>&#167;21. Set state ready for loading block data (or reset). </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Set the character just read to zero, and the progress state to 4.</span>
<span class="ACME-plain-syntax"> Together this signifies we are ready to load block data.</span>
<span class="ACME-plain-syntax"> If V is clear, then we instead reset to progress state zero.</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       If V clear, then reset to state zero</span>
<span class="ACME-plain-syntax">       otherwise set to state 4, ready to read the block data bytes</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setStateForLoadingBlockDataOrReset</span><button class="popup" onclick="togglePopup('usagePopup30')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup30">Usage of <span class="code-font"><span class="ACME-function-syntax">setStateForLoadingBlockDataOrReset</span></span>:<br/><a href="S-s19.html#SP13">&#167;13</a><br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP12">&#167;12</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f7d5</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">A=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP22" class="paragraph-anchor"></a><b>&#167;22. Set state ready for loading block data or searching (or reset state). </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Store the character just read. If all is well (V set and non-zero block length), then</span>
<span class="ACME-plain-syntax"> progress state is set to 4. Otherwise we revert back to progress state zero.</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A is $FF when searching, $00 when loading</span>
<span class="ACME-plain-syntax">       V clear means reset progress state to zero</span>
<span class="ACME-plain-syntax">       .fsBlockLengthLow/High holds the block length</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setCharAThenProgressState4OrReset</span><button class="popup" onclick="togglePopup('usagePopup31')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup31">Usage of <span class="code-font"><span class="ACME-function-syntax">setCharAThenProgressState4OrReset</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP27">&#167;27</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f7d7</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsCharacterJustReadOrCharToWrite</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">store character just read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">X=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsTempStorage</span></a><span class="ACME-plain-syntax">                                  </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockLengthLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">block length</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockLengthHigh</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">block length high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (block length is zero) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">X=4 (block length not zero)</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsReadProgressState</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">save progress flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP23" class="paragraph-anchor"></a><b>&#167;23. Save a block to tape. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> When saving to tape, we record a five second delay before the first block, then a delay</span>
<span class="ACME-plain-syntax"> specified by the interblock gap for all subsequent blocks. After all blocks are recorded</span>
<span class="ACME-plain-syntax"> there is a further five second delay.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">saveABlockToTape</span><button class="popup" onclick="togglePopup('usagePopup32')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup32">Usage of <span class="code-font"><span class="ACME-function-syntax">saveABlockToTape</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP18">&#167;18</a>, <a href="S-s18.html#SP32">&#167;32</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f7ec</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">X=loop counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">A=value to store</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsSpareByteA</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">clear the four spare bytes of file</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">system block</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X-1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockNumberLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">block number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockNumberHigh</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">block number high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP23" class="function-link"><span class="ACME-function-syntax">waitForInterblockGap</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">if (block number is not zero) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP27" class="function-link"><span class="ACME-function-syntax">waitFiveSeconds</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">generate a 5 second delay</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">ALWAYS branch</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">waitForInterblockGap</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f804</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP28" class="function-link"><span class="ACME-function-syntax">generateInterBlockGapDelay</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">generate delay set by interblock gap</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">initialise and save value $2A to tape</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP9" class="function-link"><span class="ACME-function-syntax">fsSynchronisationByte</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">A=synchronisation byte (byte to save</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to tape)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsCharacterJustReadOrCharToWrite</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">store character to write</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP11" class="function-link"><span class="ACME-function-syntax">zeroChecksumAndFSFlag</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">initialise checksum and file system</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">buffer flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP8" class="function-link"><span class="ACME-function-syntax">activateRequestToSend</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">request send to tape</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP26" class="function-link"><span class="ACME-function-syntax">waitForByteToReadOrWrite</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">wait for byte to be saved to tape</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=Y-1</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">save filename</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=Y+1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">filenameToSearchFor</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">move sought filename</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsFilename</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">into filename block</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP24" class="function-link"><span class="ACME-function-syntax">saveByteAToTapeAndUpdateCRC</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">transfer byte to tape filing system</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">and do CRC</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (filename not yet complete) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (do it again)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">save rest of header:</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">  load address      (4 bytes)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">  execution address (4 bytes)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">  block number      (2 bytes)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">  block length      (2 bytes)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">  block flag byte   (1 byte)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">  spare bytes       (4 bytes)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsLoadAddressLow</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsFilename</span></a><span class="ACME-plain-syntax">                </span><span class="ACME-comment-syntax">X=offset to load address</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsFilename</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">get filename byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP24" class="function-link"><span class="ACME-function-syntax">saveByteAToTapeAndUpdateCRC</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">transfer byte to tape filing system</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">and do CRC</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=X+1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsChecksumLow</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsFilename</span></a><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">until X reaches the end of the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">header block (just before the start</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">of the two checksum bytes)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP25" class="function-link"><span class="ACME-function-syntax">saveChecksumToTape</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">save checksum to TAPE reset buffer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockLengthLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">block length</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockLengthHigh</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">block length high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP23" class="function-link"><span class="ACME-function-syntax">saveFinalTwoBytes</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">if (block length is zero) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">Y=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP12" class="function-link"><span class="ACME-function-syntax">setChecksumBytesToY</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">zero checksum bytes</span>

<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeSaveStartAddressLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">get a data byte to save</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP19" class="function-link"><span class="ACME-function-syntax">checkLoadAddressIsForSecondProcessor</span></a><span class="ACME-plain-syntax">           </span><span class="ACME-comment-syntax">check if load address is from second</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not from second processor) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP27" class="function-link"><span class="ACME-function-syntax">tubeULADataRegister3</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">read byte from second processor</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP24" class="function-link"><span class="ACME-function-syntax">saveByteAToTapeAndUpdateCRC</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">transfer byte to tape filing system</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">and do CRC</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=Y+1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockLengthLow</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">check block length</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (block not done yet) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(loop back)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP25" class="function-link"><span class="ACME-function-syntax">saveChecksumToTape</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">save checksum to TAPE</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">saveFinalTwoBytes</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f855</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP26" class="function-link"><span class="ACME-function-syntax">waitForByteToReadOrWrite</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">save byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP26" class="function-link"><span class="ACME-function-syntax">waitForByteToReadOrWrite</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">save byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP7" class="function-link"><span class="ACME-function-syntax">resetACIA</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">reset ACIA</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">A=1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP29" class="function-link"><span class="ACME-function-syntax">generateDelay</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">generate 0.1 second delay</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s20.html#SP2" class="function-link"><span class="ACME-function-syntax">updateBlockFlagAndDisplayProgress</span></a><span class="ACME-plain-syntax">              </span><span class="ACME-comment-syntax">update block flag, PRINT filename</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(and address if reqd)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsBlockFlagByte</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">block flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (this is NOT last block) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP27" class="function-link"><span class="ACME-function-syntax">waitFiveSeconds</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">generate a 5 second delay</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s18.html#SP13" class="function-link"><span class="ACME-function-syntax">beepCancelAndPrintReturn</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">sound bell and cancel</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP24" class="paragraph-anchor"></a><b>&#167;24. saveByteAToTapeAndUpdateCRC. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">saveByteAToTapeAndUpdateCRC</span><button class="popup" onclick="togglePopup('usagePopup33')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup33">Usage of <span class="code-font"><span class="ACME-function-syntax">saveByteAToTapeAndUpdateCRC</span></span>:<br/><a href="S-s19.html#SP23">&#167;23</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f875</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP26" class="function-link"><span class="ACME-function-syntax">saveByteAToTape</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">save byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP20" class="function-link"><span class="ACME-function-syntax">updateCRC</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">update CRC</span>
</pre>
<p class="commentary firstcommentary"><a id="SP25" class="paragraph-anchor"></a><b>&#167;25. saveChecksumToTape. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">saveChecksumToTape</span><button class="popup" onclick="togglePopup('usagePopup34')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup34">Usage of <span class="code-font"><span class="ACME-function-syntax">saveChecksumToTape</span></span>:<br/><a href="S-s19.html#SP23">&#167;23</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f87b</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumHigh</span></a><span class="ACME-plain-syntax">                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP26" class="function-link"><span class="ACME-function-syntax">saveByteAToTape</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">save byte to buffer, transfer to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">tape filing system and reset flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeChecksumLow</span></a><span class="ACME-plain-syntax">                                </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP26" class="paragraph-anchor"></a><b>&#167;26. Save a byte to tape. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = character to write</span>
<span class="ACME-plain-syntax"> On Exit:</span>
<span class="ACME-plain-syntax">       A is preserved</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">saveByteAToTape</span><button class="popup" onclick="togglePopup('usagePopup35')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup35">Usage of <span class="code-font"><span class="ACME-function-syntax">saveByteAToTape</span></span>:<br/><a href="S-s19.html#SP24">&#167;24</a>, <a href="S-s19.html#SP25">&#167;25</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f882</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsCharacterJustReadOrCharToWrite</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">store character to write</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">waitForByteToReadOrWrite</span><button class="popup" onclick="togglePopup('usagePopup36')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup36">Usage of <span class="code-font"><span class="ACME-function-syntax">waitForByteToReadOrWrite</span></span>:<br/><a href="S-s19.html#SP19">&#167;19</a>, <a href="S-s19.html#SP23">&#167;23</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f884</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s20.html#SP10" class="function-link"><span class="ACME-function-syntax">checkForEscapeDuringCassetteOperation</span></a><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">confirm ESC not set and tape filing</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">system not executing</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsGotACharacterToReadOrWriteFlag</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">check if we have read / written a</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP26" class="function-link"><span class="ACME-function-syntax">waitForByteToReadOrWrite</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">loop back until we have read /</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">written a byte</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">byte is now read / written</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">A=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsGotACharacterToReadOrWriteFlag</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">clear flag, we no longer have a byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">fsCharacterJustReadOrCharToWrite</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">get character just read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP27" class="paragraph-anchor"></a><b>&#167;27. waitFiveSeconds. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">waitFiveSeconds</span><button class="popup" onclick="togglePopup('usagePopup37')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup37">Usage of <span class="code-font"><span class="ACME-function-syntax">waitFiveSeconds</span></span>:<br/><a href="S-s19.html#SP23">&#167;23</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f892</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #50                                             </span><span class="ACME-comment-syntax">Set A for 50 tenths of a second</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">delay</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP29" class="function-link"><span class="ACME-function-syntax">generateDelay</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">ALWAYS branch. generate delay</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">100ms * A (= 5 seconds)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP28" class="paragraph-anchor"></a><b>&#167;28. Delay for the (temporary) interblock gap time. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">generateInterBlockGapDelay</span><button class="popup" onclick="togglePopup('usagePopup38')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup38">Usage of <span class="code-font"><span class="ACME-function-syntax">generateInterBlockGapDelay</span></span>:<br/><a href="S-s19.html#SP23">&#167;23</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f896</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeInterBlockGap</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">get current interblock flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP29" class="paragraph-anchor"></a><b>&#167;29. Wait for A/10 seconds, or until ESCAPE is pressed. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = amount of delay in 10ths of a second</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">generateDelay</span><button class="popup" onclick="togglePopup('usagePopup39')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup39">Usage of <span class="code-font"><span class="ACME-function-syntax">generateDelay</span></span>:<br/><a href="S-s19.html#SP23">&#167;23</a>, <a href="S-s19.html#SP27">&#167;27</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f898</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #5                                              </span><span class="ACME-comment-syntax">X=loop counter</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">delayLoop</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $f89a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">verticalSyncCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">set vsync counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s20.html#SP10" class="function-link"><span class="ACME-function-syntax">checkForEscapeDuringCassetteOperation</span></a><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">check for ESCAPE</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">verticalSyncCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">check vsync counter (decremented 50</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">times a second)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not negative) then branch back</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X--</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP29" class="function-link"><span class="ACME-function-syntax">delayLoop</span></a><span class="ACME-plain-syntax">                                      </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="S-s18.html">&#10094;</a></li><li class="progresssection"><a href="S-s1.html">1</a></li><li class="progresssection"><a href="S-s2.html">2</a></li><li class="progresssection"><a href="S-s3.html">3</a></li><li class="progresssection"><a href="S-s4.html">4</a></li><li class="progresssection"><a href="S-s5.html">5</a></li><li class="progresssection"><a href="S-s6.html">6</a></li><li class="progresssection"><a href="S-s7.html">7</a></li><li class="progresssection"><a href="S-s8.html">8</a></li><li class="progresssection"><a href="S-s9.html">9</a></li><li class="progresssection"><a href="S-s10.html">10</a></li><li class="progresssection"><a href="S-s11.html">11</a></li><li class="progresssection"><a href="S-s12.html">12</a></li><li class="progresssection"><a href="S-s13.html">13</a></li><li class="progresssection"><a href="S-s14.html">14</a></li><li class="progresssection"><a href="S-s15.html">15</a></li><li class="progresssection"><a href="S-s16.html">16</a></li><li class="progresssection"><a href="S-s17.html">17</a></li><li class="progresssection"><a href="S-s18.html">18</a></li><li class="progresscurrent">19</li><li class="progresssection"><a href="S-s20.html">20</a></li><li class="progresssection"><a href="S-s21.html">21</a></li><li class="progresssection"><a href="S-s22.html">22</a></li><li class="progresssection"><a href="S-s23.html">23</a></li><li class="progresssection"><a href="S-s24.html">24</a></li><li class="progresssection"><a href="S-s25.html">25</a></li><li class="progresssection"><a href="S-s26.html">26</a></li><li class="progressnext"><a href="S-s20.html">&#10095;</a></li></ul></div>
</nav><!--End of weave-->

		</main>
	</body>
</html>

