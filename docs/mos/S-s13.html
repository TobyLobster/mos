<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Chapter 13: Writing characters; printer; buffers</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Carousel.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/ACME-Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<p>BBC Computer 32K</p>
<h1>*CAT</h1>
<ul><li><a href="../index.html">&#x21A9; home</a></li><li><a href="index.html"><span class="selectedlink">contents</span></a></li>
<li><a href="S-s1.html">introduction</a></li>
<li><a href="S-s2.html">constants</a></li>
<li><a href="S-s3.html">memory-mapped i/o</a></li>
<li><a href="S-s4.html"><b>$C000</b>: chapter 4</a></li>
<li><a href="S-s5.html"><b>$C4C0</b>: chapter 5</a></li>
<li><a href="S-s6.html"><b>$CB1D</b>: chapter 6</a></li>
<li><a href="S-s7.html"><b>$CCF8</b>: chapter 7</a></li>
<li><a href="S-s8.html"><b>$D060</b>: chapter 8</a></li>
<li><a href="S-s9.html"><b>$D7C2</b>: chapter 9</a></li>
<li><a href="S-s10.html"><b>$D940</b>: chapter 10</a></li>
<li><a href="S-s11.html"><b>$DC1C</b>: chapter 11</a></li>
<li><a href="S-s12.html"><b>$DEC5</b>: chapter 12</a></li>
<li><span class="unlink"><b>$E0A4</b>: chapter 13</span></li>
<li><a href="S-s14.html"><b>$E20E</b>: chapter 14</a></li>
<li><a href="S-s15.html"><b>$E5B3</b>: chapter 15</a></li>
<li><a href="S-s16.html"><b>$EB03</b>: chapter 16</a></li>
<li><a href="S-s17.html"><b>$EEDA</b>: chapter 17</a></li>
<li><a href="S-s18.html"><b>$F135</b>: chapter 18</a></li>
<li><a href="S-s19.html"><b>$F588</b>: chapter 19</a></li>
<li><a href="S-s20.html"><b>$F8A9</b>: chapter 20</a></li>
<li><a href="S-s21.html"><b>$FAE8</b>: chapter 21</a></li>
<li><a href="S-s22.html"><b>$FC00</b>: chapter 22</a></li>
<li><a href="S-s23.html"><b>$FF00</b>: chapter 23</a></li>
<li><a href="S-s24.html"><b>$FFA7</b>: chapter 24</a></li>
<li><a href="S-s25.html">appendix</a></li>
<li><a href="S-s26.html">index</a></li>

</ul>
		</nav>
		<main role="main">
		<!--Weave of 'Chapter 13: Writing characters; printer; buffers' generated by Inweb-->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">MOS 1.20</a></li><li><b>Chapter 13: Writing characters; printer; buffers</b></li></ul></div>
<p class="purpose">OSBYTE 123, 156; OSWRCH entry point; Econet / User printer routines; Flush buffers; Count or purge buffer (CNPV); Append to buffer - 362 bytes (2.2%)</p>

<ul class="toc"><li><a href="S-s13.html#SP1">&#167;1. OSWRCH - write character</a></li><li><a href="S-s13.html#SP2">&#167;2. On Entry:</a></li><li><a href="S-s13.html#SP3">&#167;3. openPrinterChannel</a></li><li><a href="S-s13.html#SP4">&#167;4. checkForSerialPrinter</a></li><li><a href="S-s13.html#SP5">&#167;5. OSBYTE 156 - Update ACIA Control Register and OS Copy</a></li><li><a href="S-s13.html#SP6">&#167;6. userPrinter</a></li><li><a href="S-s13.html#SP7">&#167;7. OSBYTE 123 - Warn OS about printer going dormant</a></li><li><a href="S-s13.html#SP8">&#167;8. printerServiceCallIfNotEmpty</a></li><li><a href="S-s13.html#SP9">&#167;9. printerServiceCall</a></li><li><a href="S-s13.html#SP10">&#167;10. Flushes the given buffer</a></li><li><a href="S-s13.html#SP11">&#167;11. Count or Purge Buffer (CNPV) - Default Entry Point</a></li><li><a href="S-s13.html#SP12">&#167;12. Adds a byte to a buffer.</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. OSWRCH - write character. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> This is the main entry point for writing characters to the display and/or to other devices</span>
<span class="ACME-plain-syntax"> such as ECONET, a printer, RS-423 or to a file.</span>

<span class="ACME-plain-syntax"> Note: the .characterDestinationsAvailableFlags has the following bits:</span>

<span class="ACME-plain-syntax">   bit 0 - enable RS-423 driver</span>
<span class="ACME-plain-syntax">   bit 1 - disable VDU driver</span>
<span class="ACME-plain-syntax">   bit 2 - disable printer driver</span>
<span class="ACME-plain-syntax">   bit 3 - enable printer, independent of VDU 2/3 (=CTRL B/C)</span>
<span class="ACME-plain-syntax">   bit 4 - disable SPOOLed output</span>
<span class="ACME-plain-syntax">   bit 5 - not used, zero</span>
<span class="ACME-plain-syntax">   bit 6 - disable printer driver (unless preceded by VDU 1)</span>
<span class="ACME-plain-syntax">   bit 7 - not used, zero</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = character to write</span>
<span class="ACME-plain-syntax"> On Exit:</span>
<span class="ACME-plain-syntax">       A, X, Y are preserved</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">oswrchEntryPoint</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="ACME-function-syntax">oswrchEntryPoint</span></span>:<br/>Chapter 10: Resets - <a href="S-s10.html#SP1">&#167;1</a><br/>Chapter 24: OS entry points; Tube; FRED; JIM; SHEILA - <a href="S-s24.html#SP6">&#167;6</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e0a4</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} store A,X,Y registers</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TSX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X = stack pointer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP12" class="function-link"><span class="ACME-function-syntax">stackPage</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">3</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">peek into stack to get A value back</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push A again</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">econetWriteCharacterInterceptionFlag</span></a><span class="ACME-plain-syntax">           </span><span class="ACME-comment-syntax">check OSWRCH interception flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP1" class="function-link"><span class="ACME-function-syntax">skipEconetProcessing</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">if (not set) then branch (skip</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">Econet)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">pass character to Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">A=4 for OSWRCH service call</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP34" class="function-link"><span class="ACME-function-syntax">netvJumper</span></a><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">call NETV code</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP1" class="function-link"><span class="ACME-function-syntax">oswrchFinishUp</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (claimed) then branch (finish up</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">and exit)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">skipEconetProcessing</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e0bb</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">prepare to not send this to printer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #2                                              </span><span class="ACME-comment-syntax">check output destination</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">characterDestinationsAvailableFlags</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">is VDU driver disabled?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP1" class="function-link"><span class="ACME-function-syntax">skipVDUOutput</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">yes, skip past VDU driver</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">pull character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s5.html#SP2" class="function-link"><span class="ACME-function-syntax">vduChrEntryPoint</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">call VDU driver</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">on exit, C=1 if character to be sent</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to printer</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">skipVDUOutput</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e0c8</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #8                                              </span><span class="ACME-comment-syntax">check output destination</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">characterDestinationsAvailableFlags</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">is printer separately enabled?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP1" class="function-link"><span class="ACME-function-syntax">printerEnabled</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">yes, jump to call printer driver</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP1" class="function-link"><span class="ACME-function-syntax">printerDisabled</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">carry clear, don't sent to printer</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">printerEnabled</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e0d1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">pull character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP2" class="function-link"><span class="ACME-function-syntax">sendCharacterToPrinter</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">call printer driver</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">printerDisabled</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e0d6</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">characterDestinationsAvailableFlags</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">check output destination</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">check RS-423 output bit</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP1" class="function-link"><span class="ACME-function-syntax">skipRS423Output</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">if (RS-423 output is disabled) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (skip past serial output)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Check for timeout</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423TimeoutCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">get RS-423 timout counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrease counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP1" class="function-link"><span class="ACME-function-syntax">skipRS423Output</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">if (timed out) then branch (skip</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">past serial code)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">RS-423 output</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">pull character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save IRQs</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable IRQs</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberRS423Output</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">X=RS-423 output buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP22" class="function-link"><span class="ACME-function-syntax">osbyte152EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">examine RS-423 output buffer to see</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">if it's empty</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">buffer is not empty, jump to send</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP4" class="function-link"><span class="ACME-function-syntax">clearBusyFlagAndSetRS423Active</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">set RS-423 Active</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberRS423Output</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">X=RS-423 output buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP12" class="function-link"><span class="ACME-function-syntax">addByteToBuffer</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">send character to RS-423 output</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">restore IRQs</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">skipRS423Output</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e0f7</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$10</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">check output destination</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">characterDestinationsAvailableFlags</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">check SPOOL output</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP1" class="function-link"><span class="ACME-function-syntax">oswrchFinishUp</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (SPOOL output disabled) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (skip past SPOOL output)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">spoolFileHandle</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">get SPOOL file handle</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP1" class="function-link"><span class="ACME-function-syntax">oswrchFinishUp</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (not open) then branch (skip past</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">SPOOL output)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">pull character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeCritical</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">} Set tape critical flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s24.html#SP6" class="function-link"><span class="ACME-function-syntax">OSBPUT</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">write character to SPOOL channel</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(A=character to write, Y=file handle)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tapeCritical</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">clear tape critical flag</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">oswrchFinishUp</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e10d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} restore A,X,Y registers</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. On Entry:. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">       A=character to print</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">sendCharacterToPrinter</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="ACME-function-syntax">sendCharacterToPrinter</span></span>:<br/><a href="S-s13.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e114</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">characterDestinationsAvailableFlags</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">check for bit 6 set</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVS</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP2" class="function-link"><span class="ACME-function-syntax">exit16</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (printer is disabled) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerIgnoreCharacter</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">compare character against printer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">ignore character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP2" class="function-link"><span class="ACME-function-syntax">exit16</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (the same) then branch (exit)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">sendValidByteToPrinter</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="ACME-function-syntax">sendValidByteToPrinter</span></span>:<br/>Chapter 5: VDU and OSWORD routines - <a href="S-s5.html#SP6">&#167;6</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e11e</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags (including IRQ flag)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">store byte to send in X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00000100</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">characterDestinationsAvailableFlags</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">} check bit 2 'disable printer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} driver'</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP2" class="function-link"><span class="ACME-function-syntax">pullAndExit14</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">if (printer is disabled) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(pull flags and exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">restore byte to send to A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberPrinter</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">X=printer buffer number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP12" class="function-link"><span class="ACME-function-syntax">addByteToBuffer</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">put character in printer buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP2" class="function-link"><span class="ACME-function-syntax">pullAndExit14</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">if (carry set, i.e. unsuccessful)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (pull flags and exit)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerBufferEmptyFlag</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">check buffer empty flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP2" class="function-link"><span class="ACME-function-syntax">pullAndExit14</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">if (printer buffer is not empty)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (pull flags and exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP3" class="function-link"><span class="ACME-function-syntax">openPrinterChannel</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">open printer channel</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">pullAndExit14</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e138</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">restore flags (including IRQ flag)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit16</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e139</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3. openPrinterChannel. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">openPrinterChannel</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="ACME-function-syntax">openPrinterChannel</span></span>:<br/><a href="S-s13.html#SP2">&#167;2</a><br/>Chapter 11: Interrupt processing - <a href="S-s11.html#SP14">&#167;14</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e13a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerDestination</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">check printer destination</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP10" class="function-link"><span class="ACME-function-syntax">flushBufferX</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">if (zero) then branch (clear printer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">buffer and exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP4" class="function-link"><span class="ACME-function-syntax">checkForSerialPrinter</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">} if (parallel printer not selected)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} then branch (check for serial</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} printer)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with parallel printer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read a byte from the printer buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerBufferEmptyFlag</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">rotate carry into bit 7 of the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">printer buffer empty flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP5" class="function-link"><span class="ACME-function-syntax">exit17</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (printer buffer empty) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (return)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">To send data to the parallel printer:</span>
<span class="ACME-plain-syntax">    </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">1. Enable the User VIA interrupt '1'. The printer will trigger an IRQ when it is ready</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">   for another character.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">2. Write the byte to send to .userVIARegisterA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">3. Set bits 1-3 of the userVIAPeripheralControlRegister to %110</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">4. Set bits 1-3 of the userVIAPeripheralControlRegister to %111</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">This sends a 'STROBE' signal to advise the printer that valid data is waiting.</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%10000010</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">enable interrupt 1 of the user VIA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP24" class="function-link"><span class="ACME-function-syntax">userVIAInterruptEnableRegister</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">this is triggered by the printer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">when it is ready to receive a new</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">character</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP21" class="function-link"><span class="ACME-function-syntax">userVIARegisterA</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">pass byte to the Centronics port</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP22" class="function-link"><span class="ACME-function-syntax">userVIAPeripheralControlRegister</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%11110001</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00001100</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">} pulse CA2 line to generate</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP22" class="function-link"><span class="ACME-function-syntax">userVIAPeripheralControlRegister</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">} STROBE signal to advise printer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00001110</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">} that valid data is waiting</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP22" class="function-link"><span class="ACME-function-syntax">userVIAPeripheralControlRegister</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP5" class="function-link"><span class="ACME-function-syntax">exit17</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">ALWAYS branch (return)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">[this could just be an RTS, saving</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">one byte]</span>
</pre>
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. checkForSerialPrinter. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">checkForSerialPrinter</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="ACME-function-syntax">checkForSerialPrinter</span></span>:<br/><a href="S-s13.html#SP3">&#167;3</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e164</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #2                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP6" class="function-link"><span class="ACME-function-syntax">userPrinter</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">} if (serial printer is NOT</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} selected) then branch (check for</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} user printer)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with serial printer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423TimeoutCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP10" class="function-link"><span class="ACME-function-syntax">flushBufferX</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">} if (timeout counter is timed out)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} then branch (to flush the buffer)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerBufferEmptyFlag</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">clear printer buffer empty flag</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">clearBusyFlagAndSetRS423Active</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="ACME-function-syntax">clearBusyFlagAndSetRS423Active</span></span>:<br/><a href="S-s13.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e170</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423ReadyFlag</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">clear RS-423 busy flag</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setRS423Active</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="ACME-function-syntax">setRS423Active</span></span>:<br/>Chapter 14: Star commands - <a href="S-s14.html#SP34">&#167;34</a><br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP12">&#167;12</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e173</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s15.html#SP19" class="function-link"><span class="ACME-function-syntax">getRS423InputBufferFreeBytes</span></a><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP5" class="function-link"><span class="ACME-function-syntax">exit17</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">} if (free space in buffer is low)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} then branch (return)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00100000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">set bit 5 on ACIA control register</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">set 'Request To Send' low (meaning</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">Active)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">writeToACIARequestToSend</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="ACME-function-syntax">writeToACIARequestToSend</span></span>:<br/>Chapter 11: Interrupt processing - <a href="S-s11.html#SP4">&#167;4</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e17a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%10011111</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">Mask for setting bits 5 and 6</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">This writes the 'Request To Send'</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">value.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5. OSBYTE 156 - Update ACIA Control Register and OS Copy. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> write (current value AND Y) EOR X</span>
<span class="ACME-plain-syntax"> Preserves Y and flags</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">osbyte156EntryPoint</span><button class="popup" onclick="togglePopup('usagePopup9')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup9">Usage of <span class="code-font"><span class="ACME-function-syntax">osbyte156EntryPoint</span></span>:<br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e17c</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempStoreFA</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">.tempStoreFA=X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423ControlRegisterCopy</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">A=old value AND Y EOR X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempStoreFA</span></a><span class="ACME-plain-syntax">                                    </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423ControlRegisterCopy</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">get old value in X</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">storeACIAAndPull</span><button class="popup" onclick="togglePopup('usagePopup10')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup10">Usage of <span class="code-font"><span class="ACME-function-syntax">storeACIAAndPull</span></span>:<br/>Chapter 21: More Low Level Tape Operations - <a href="S-s21.html#SP3">&#167;3</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e189</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423ControlRegisterCopy</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">put new value in</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP5" class="function-link"><span class="ACME-function-syntax">acia6850ControlRegister</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">and store to ACIA control register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit17</span><button class="popup" onclick="togglePopup('usagePopup11')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup11">Usage of <span class="code-font"><span class="ACME-function-syntax">exit17</span></span>:<br/><a href="S-s13.html#SP3">&#167;3</a>, <a href="S-s13.html#SP4">&#167;4</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e190</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6. userPrinter. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">userPrinter</span><button class="popup" onclick="togglePopup('usagePopup12')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup12">Usage of <span class="code-font"><span class="ACME-function-syntax">userPrinter</span></span>:<br/><a href="S-s13.html#SP4">&#167;4</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e191</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">clear carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">A = 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP9" class="function-link"><span class="ACME-function-syntax">printerServiceCall</span></a><span class="ACME-plain-syntax">                             </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP7" class="paragraph-anchor"></a><b>&#167;7. OSBYTE 123 - Warn OS about printer going dormant. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> This call is used by the User Print Routine to indicate to the MOS that it has finished</span>
<span class="ACME-plain-syntax"> its task (The User Print Routine is selected by *FX 5,3).</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">osbyte123EntryPoint</span><button class="popup" onclick="togglePopup('usagePopup13')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup13">Usage of <span class="code-font"><span class="ACME-function-syntax">osbyte123EntryPoint</span></span>:<br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e197</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerBufferEmptyFlag</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">mark printer buffer empty (clear top</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">bit)</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP8" class="paragraph-anchor"></a><b>&#167;8. printerServiceCallIfNotEmpty. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Signal to the printer that there's at least one character in the printer buffer, at a</span>
<span class="ACME-plain-syntax"> rate of 100Hz until the printer driver deals with it.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">printerServiceCallIfNotEmpty</span><button class="popup" onclick="togglePopup('usagePopup14')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup14">Usage of <span class="code-font"><span class="ACME-function-syntax">printerServiceCallIfNotEmpty</span></span>:<br/>Chapter 11: Interrupt processing - <a href="S-s11.html#SP16">&#167;16</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e19b</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerBufferEmptyFlag</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">check printer buffer empty flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (buffer is empty) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">A=0 (100Hz update when printer is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">active and buffer is not empty)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP9" class="paragraph-anchor"></a><b>&#167;9. printerServiceCall. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Econet / User printer routines</span>

<span class="ACME-plain-syntax"> See NAUG Section 24.2.4, Page 424 for more detail on reason codes</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = reason code</span>
<span class="ACME-plain-syntax">           0 means 100Hz update</span>
<span class="ACME-plain-syntax">           1 means become active, since printer buffer is no longer empty</span>
<span class="ACME-plain-syntax">           2 means VDU 2 happened (disable printer output)</span>
<span class="ACME-plain-syntax">           3 means VDU 3 happened (enable printer output)</span>
<span class="ACME-plain-syntax">           5 means select new printer driver (entry via OSBYTE 5 to .selectPrinterType)</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">printerServiceCall</span><button class="popup" onclick="togglePopup('usagePopup15')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup15">Usage of <span class="code-font"><span class="ACME-function-syntax">printerServiceCall</span></span>:<br/><a href="S-s13.html#SP6">&#167;6</a><br/>Chapter 5: VDU and OSWORD routines - <a href="S-s5.html#SP13">&#167;13</a>, <a href="S-s5.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e1a2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberPrinter</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">X=printer buffer number</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">selectPrinterType</span><button class="popup" onclick="togglePopup('usagePopup16')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup16">Usage of <span class="code-font"><span class="ACME-function-syntax">selectPrinterType</span></span>:<br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP46">&#167;46</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e1a4</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerDestination</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">Y=printer destination (*FX 5 value)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP34" class="function-link"><span class="ACME-function-syntax">netvJumper</span></a><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">let network have a look (should</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">respond if Y=4 for net printer)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> (.</span><a href="S-s2.html#SP13" class="function-link"><span class="ACME-function-syntax">vectorUPTV</span></a><span class="ACME-plain-syntax">)                                   </span><span class="ACME-comment-syntax">let user printer routine have a look</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(can respond if Y=3, or 5-255 for</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">user printer)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP10" class="paragraph-anchor"></a><b>&#167;10. Flushes the given buffer. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> For buffer numbers, see .</span><a href="S-s2.html#SP4" class="internal">bufferNumberKeyboard</a><span class="ACME-plain-syntax">.</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       X=buffer number</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">flushBufferX</span><button class="popup" onclick="togglePopup('usagePopup17')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup17">Usage of <span class="code-font"><span class="ACME-function-syntax">flushBufferX</span></span>:<br/><a href="S-s13.html#SP3">&#167;3</a>, <a href="S-s13.html#SP4">&#167;4</a><br/>Chapter 17: Keyboard processing - <a href="S-s17.html#SP26">&#167;26</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e1ad</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">clear carry</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">flushSoundBufferX</span><button class="popup" onclick="togglePopup('usagePopup18')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup18">Usage of <span class="code-font"><span class="ACME-function-syntax">flushSoundBufferX</span></span>:<br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP31">&#167;31</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e1ae</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP10" class="function-link"><span class="ACME-function-syntax">flushNonSoundBufferX</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">if (carry set on entry) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s15.html#SP52" class="function-link"><span class="ACME-function-syntax">bufferTypeAndSerialBaudRatesTable</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">carry clear so get byte from table</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP10" class="function-link"><span class="ACME-function-syntax">flushNonSoundBufferX</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">if (not sound buffer) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP9" class="function-link"><span class="ACME-function-syntax">clearSoundChannelBuffer</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">clear sound buffer</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">flushNonSoundBufferX</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e1bb</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">bufferEmptyFlags</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">rotate buffer flag to show buffer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">empty</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPX</span><span class="ACME-plain-syntax"> #2                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP10" class="function-link"><span class="ACME-function-syntax">skipInputBufferHandling</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">if (X &gt; 1) then branch (it's not an</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">input buffer)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">this is an input buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">softKeyStringLength</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">reset length of the *KEY string</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">currently being decoded (to stop</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">decoding a soft key, which would</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">otherwise add more characters into</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">the input buffer)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">twosComplimentOfNumberOfBytesInVDUQueue</span></a><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">reset length of VDU queue</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">skipInputBufferHandling</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e1cb</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s15.html#SP18" class="function-link"><span class="ACME-function-syntax">purgeBuffer</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">purge buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">restore flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">restore A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP11" class="paragraph-anchor"></a><b>&#167;11. Count or Purge Buffer (CNPV) - Default Entry Point. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       X = buffer to access</span>
<span class="ACME-plain-syntax">       if V set then purge buffer (else count buffer)</span>
<span class="ACME-plain-syntax">       for count buffer: if C set then get bytes free</span>
<span class="ACME-plain-syntax">                                  else get bytes used</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">cnpEntryPoint</span><button class="popup" onclick="togglePopup('usagePopup19')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup19">Usage of <span class="code-font"><span class="ACME-function-syntax">cnpEntryPoint</span></span>:<br/>Chapter 10: Resets - <a href="S-s10.html#SP1">&#167;1</a><br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP18">&#167;18</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e1d1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVC</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP11" class="function-link"><span class="ACME-function-syntax">countBuffer</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">if (V clear) then branch (count</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">buffer)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">bufferStartIndices</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">purge buffer by setting</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">bufferEndIndices</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">end of buffer = start of buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">countBuffer</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e1da</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">bufferEndIndices</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">get end of buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">bufferStartIndices</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">subtract start of buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (carry set) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP20" class="function-link"><span class="ACME-function-syntax">emptyBufferStartOffset</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">subtract buffer start offset (i.e.</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">add buffer length)</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">pull flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (carry clear) then branch (to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">tidy up and exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">clear carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP20" class="function-link"><span class="ACME-function-syntax">emptyBufferStartOffset</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">adc to get bytes used</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">and invert to get space left</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">Y=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP12" class="paragraph-anchor"></a><b>&#167;12. Adds a byte to a buffer.. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On failure (e.g. the buffer is full), flash the keyboard lights and keep trying</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = byte to write</span>
<span class="ACME-plain-syntax">       X = buffer to write into</span>

<span class="ACME-plain-syntax"> On Exit:</span>
<span class="ACME-plain-syntax">       Carry clear if successful</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">addByteToBuffer</span><button class="popup" onclick="togglePopup('usagePopup20')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup20">Usage of <span class="code-font"><span class="ACME-function-syntax">addByteToBuffer</span></span>:<br/><a href="S-s13.html#SP1">&#167;1</a>, <a href="S-s13.html#SP2">&#167;2</a><br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP31">&#167;31</a>, <a href="S-s15.html#SP34">&#167;34</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e1f8</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">prevent interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP27" class="function-link"><span class="ACME-function-syntax">insJumper</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">enter a byte in buffer X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP12" class="function-link"><span class="ACME-function-syntax">exit18</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (successful) then branch (exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s15.html#SP57" class="function-link"><span class="ACME-function-syntax">turnOnKeyboardLightsAndTestEscape</span></a><span class="ACME-plain-syntax">              </span><span class="ACME-comment-syntax">switch on both keyboard lights</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s17.html#SP2" class="function-link"><span class="ACME-function-syntax">keyboardIndicators</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">switch off unselected LEDs</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">recall A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">recall flags</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP12" class="function-link"><span class="ACME-function-syntax">exit18</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (return is -ve, i.e. Escape</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">pressed) then branch (exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">allow interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP12" class="function-link"><span class="ACME-function-syntax">addByteToBuffer</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">if (byte didn't enter buffer) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (go back and try again)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit18</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $e20d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="S-s12.html">&#10094;</a></li><li class="progresssection"><a href="S-s1.html">1</a></li><li class="progresssection"><a href="S-s2.html">2</a></li><li class="progresssection"><a href="S-s3.html">3</a></li><li class="progresssection"><a href="S-s4.html">4</a></li><li class="progresssection"><a href="S-s5.html">5</a></li><li class="progresssection"><a href="S-s6.html">6</a></li><li class="progresssection"><a href="S-s7.html">7</a></li><li class="progresssection"><a href="S-s8.html">8</a></li><li class="progresssection"><a href="S-s9.html">9</a></li><li class="progresssection"><a href="S-s10.html">10</a></li><li class="progresssection"><a href="S-s11.html">11</a></li><li class="progresssection"><a href="S-s12.html">12</a></li><li class="progresscurrent">13</li><li class="progresssection"><a href="S-s14.html">14</a></li><li class="progresssection"><a href="S-s15.html">15</a></li><li class="progresssection"><a href="S-s16.html">16</a></li><li class="progresssection"><a href="S-s17.html">17</a></li><li class="progresssection"><a href="S-s18.html">18</a></li><li class="progresssection"><a href="S-s19.html">19</a></li><li class="progresssection"><a href="S-s20.html">20</a></li><li class="progresssection"><a href="S-s21.html">21</a></li><li class="progresssection"><a href="S-s22.html">22</a></li><li class="progresssection"><a href="S-s23.html">23</a></li><li class="progresssection"><a href="S-s24.html">24</a></li><li class="progresssection"><a href="S-s25.html">25</a></li><li class="progresssection"><a href="S-s26.html">26</a></li><li class="progressnext"><a href="S-s14.html">&#10095;</a></li></ul></div>
</nav><!--End of weave-->

		</main>
	</body>
</html>

