<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Chapter 16: Sound and Speech</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Carousel.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/ACME-Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<p>BBC Computer 32K</p>
<h1>*CAT</h1>
<ul><li><a href="../index.html">&#x21A9; home</a></li><li><a href="index.html"><span class="selectedlink">contents</span></a></li>
<li><a href="S-s1.html">introduction</a></li>
<li><a href="S-s2.html">constants</a></li>
<li><a href="S-s3.html">memory-mapped i/o</a></li>
<li><a href="S-s4.html"><b>$C000</b>: chapter 4</a></li>
<li><a href="S-s5.html"><b>$C4C0</b>: chapter 5</a></li>
<li><a href="S-s6.html"><b>$CB1D</b>: chapter 6</a></li>
<li><a href="S-s7.html"><b>$CCF8</b>: chapter 7</a></li>
<li><a href="S-s8.html"><b>$D060</b>: chapter 8</a></li>
<li><a href="S-s9.html"><b>$D7C2</b>: chapter 9</a></li>
<li><a href="S-s10.html"><b>$D940</b>: chapter 10</a></li>
<li><a href="S-s11.html"><b>$DC1C</b>: chapter 11</a></li>
<li><a href="S-s12.html"><b>$DEC5</b>: chapter 12</a></li>
<li><a href="S-s13.html"><b>$E0A4</b>: chapter 13</a></li>
<li><a href="S-s14.html"><b>$E20E</b>: chapter 14</a></li>
<li><a href="S-s15.html"><b>$E5B3</b>: chapter 15</a></li>
<li><span class="unlink"><b>$EB03</b>: chapter 16</span></li>
<li><a href="S-s17.html"><b>$EEDA</b>: chapter 17</a></li>
<li><a href="S-s18.html"><b>$F135</b>: chapter 18</a></li>
<li><a href="S-s19.html"><b>$F588</b>: chapter 19</a></li>
<li><a href="S-s20.html"><b>$F8A9</b>: chapter 20</a></li>
<li><a href="S-s21.html"><b>$FAE8</b>: chapter 21</a></li>
<li><a href="S-s22.html"><b>$FC00</b>: chapter 22</a></li>
<li><a href="S-s23.html"><b>$FF00</b>: chapter 23</a></li>
<li><a href="S-s24.html"><b>$FFA7</b>: chapter 24</a></li>
<li><a href="S-s25.html">appendix</a></li>
<li><a href="S-s26.html">index</a></li>

</ul>
		</nav>
		<main role="main">
		<!--Weave of 'Chapter 16: Sound and Speech' generated by Inweb-->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">MOS 1.20</a></li><li><b>Chapter 16: Sound and Speech</b></li></ul></div>
<p class="purpose">OSBYTE 158, 159; Sound and speech interrupt processing; ROM/PHROM read byte - 983 bytes (5.9%)</p>

<ul class="toc"><li><a href="S-s16.html#SP1">&#167;1. Introduction</a></li><li><a href="S-s16.html#SP2">&#167;2. Silence a sound channel</a></li><li><a href="S-s16.html#SP3">&#167;3. Set volume for channel X</a></li><li><a href="S-s16.html#SP4">&#167;4. soundParameterTable</a></li><li><a href="S-s16.html#SP5">&#167;5. skipToNextChannelLocal</a></li><li><a href="S-s16.html#SP6">&#167;6. Update sounds in the 100Hz timer interrupt</a></li><li><a href="S-s16.html#SP7">&#167;7. clearSoundChannels</a></li><li><a href="S-s16.html#SP8">&#167;8. checkForNextSoundToPlay</a></li><li><a href="S-s16.html#SP9">&#167;9. clearSoundChannelBuffer</a></li><li><a href="S-s16.html#SP10">&#167;10. syncSoundBufferEmpty</a></li><li><a href="S-s16.html#SP11">&#167;11. silenceNonEnvelopeSound</a></li><li><a href="S-s16.html#SP12">&#167;12. syncSounds</a></li><li><a href="S-s16.html#SP13">&#167;13. setPitch</a></li><li><a href="S-s16.html#SP14">&#167;14. Set the pitch of a sound</a></li><li><a href="S-s16.html#SP15">&#167;15. Read the next sound from the SOUND buffer and act on it</a></li><li><a href="S-s16.html#SP16">&#167;16. Pitch tables</a></li><li><a href="S-s16.html#SP17">&#167;17. pitchLookupTableHigh</a></li><li><a href="S-s16.html#SP18">&#167;18. PHROM numbers are $F0-$FF</a></li><li><a href="S-s16.html#SP19">&#167;19. readByteFromROMOrPHROM</a></li><li><a href="S-s16.html#SP20">&#167;20. readByteFromROMFSorPHROM</a></li><li><a href="S-s16.html#SP21">&#167;21. readByteFromPHROM</a></li><li><a href="S-s16.html#SP22">&#167;22. OSBYTE 158 - Read byte from speech processor</a></li><li><a href="S-s16.html#SP23">&#167;23. writeLoadAddressCommandToSpeechProcessor</a></li><li><a href="S-s16.html#SP24">&#167;24. OSBYTE 159 - Write to speech processor</a></li><li><a href="S-s16.html#SP25">&#167;25. Read or write to the Speech processor</a></li><li><a href="S-s16.html#SP26">&#167;26. setROMOrPHROMAddress</a></li><li><a href="S-s16.html#SP27">&#167;27. Send the given address to the Speech Processor</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. Introduction. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> The sound chip has three channels that produce square waves tones, and one noise channel.</span>
<span class="ACME-plain-syntax"> The OS enhances this basic functionality with OSWORD 7 - Make a sound, and OSWORD 8 -</span>
<span class="ACME-plain-syntax"> Define an envelope. These correspond to the BASIC commands SOUND and ENVELOPE. The SOUND</span>
<span class="ACME-plain-syntax"> command simplifies the process of playing regular notes and noises, and adds the ability</span>
<span class="ACME-plain-syntax"> to store a queue of notes to play in advance. The ENVELOPE command allows a wide variety</span>
<span class="ACME-plain-syntax"> of sound effects to be played by varying the pitch and amplitude of a sound every 100th</span>
<span class="ACME-plain-syntax"> of a second as it plays.</span>
<span class="ACME-plain-syntax"> See .</span><a href="S-s15.html#SP31" class="internal">osword7EntryPoint</a><span class="ACME-plain-syntax">.</span>
<span class="ACME-plain-syntax"> See .</span><a href="S-s15.html#SP36" class="internal">osword8EntryPoint</a><span class="ACME-plain-syntax">.</span>

<span class="ACME-plain-syntax"> Sound durations are specified in 1/20ths of a second allowing a single byte to sustain a</span>
<span class="ACME-plain-syntax"> long note up to 12.75 seconds.</span>

<span class="ACME-plain-syntax"> In addition sound is produced by VDU 7 BELL - a surprisingly accurately pitched Treble C.</span>
<span class="ACME-plain-syntax"> See .</span><a href="S-s15.html#SP33" class="internal">vdu7EntryPoint</a><span class="ACME-plain-syntax">.</span>

<span class="ACME-plain-syntax"> Finally, a percussive sound can (in extremis) be produced by setting and resetting the</span>
<span class="ACME-plain-syntax"> cassette relay. See .</span><a href="S-s15.html#SP7" class="internal">osbyte137EntryPoint</a><span class="ACME-plain-syntax">. This is a mechanically generated sound, not</span>
<span class="ACME-plain-syntax"> produced via the internal loudspeaker.</span>

<span class="ACME-plain-syntax"> Many games such as Arcadians (Aardvark, 1983) and Zalaga (Acornsoft, 1982) that sought to</span>
<span class="ACME-plain-syntax"> emulate arcade games used the sound capabilities to create 'musical stings' and other</span>
<span class="ACME-plain-syntax"> effects.</span>
</pre>
<p class="center-p"><audio controls>
<source src="arcadians.mp3" type="audio/mpeg">
Your browser does not support the audio element.
</audio>
</p>

<p class="center-p"><audio controls>
<source src="zalaga1.mp3" type="audio/mpeg">
Your browser does not support the audio element.
</audio>
</p>

<p class="center-p"><audio controls>
<source src="zalaga2.mp3" type="audio/mpeg">
Your browser does not support the audio element.
</audio>
</p>

<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. Silence a sound channel. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       X = buffer number (4-7) for channel (0-3)</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">silenceChannelX</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="ACME-function-syntax">silenceChannelX</span></span>:<br/><a href="S-s16.html#SP9">&#167;9</a>, <a href="S-s16.html#SP11">&#167;11</a>, <a href="S-s16.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb03</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">mark end of release phase</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PhaseCounter</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">to channel X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$C0</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">code for zero volume</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3. Set volume for channel X. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = volume, where $3F (loudest) to $C0 (silent) - see table below</span>
<span class="ACME-plain-syntax">       X = buffer number (4-7) for channel (0-3)</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setChannelXVolume</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="ACME-function-syntax">setChannelXVolume</span></span>:<br/><a href="S-s16.html#SP6">&#167;6</a>, <a href="S-s16.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb0a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Volume</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">store A to give basic sound level</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">soundDisableFlag</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">get sound output/enable flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (sound enabled) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$C0</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">code for zero volume</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">we now convert the input volume into the value required to write to the sound chip</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$40</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">subtract $40</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} divide by 8</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$0F</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">invert bits 0-3</span>

<span class="ACME-comment-syntax">    BASIC SOUND   volume on entry     accumulator</span>
<span class="ACME-comment-syntax">    volume        .channel0Volume     result now</span>
<span class="ACME-comment-syntax">     -15                $3F              $10          loudest</span>
<span class="ACME-comment-syntax">     -14                $37              $11</span>
<span class="ACME-comment-syntax">     -13                $2F              $12</span>
<span class="ACME-comment-syntax">     -12                $27              $13</span>
<span class="ACME-comment-syntax">     -11                $1F              $14</span>
<span class="ACME-comment-syntax">     -10                $17              $15</span>
<span class="ACME-comment-syntax">      -9                $0F              $16</span>
<span class="ACME-comment-syntax">      -8                $07              $17</span>
<span class="ACME-comment-syntax">      -7                $FF              $18</span>
<span class="ACME-comment-syntax">      -6                $F7              $19</span>
<span class="ACME-comment-syntax">      -5                $EF              $1A</span>
<span class="ACME-comment-syntax">      -4                $E7              $1B</span>
<span class="ACME-comment-syntax">      -3                $DF              $1C</span>
<span class="ACME-comment-syntax">      -2                $D7              $1D</span>
<span class="ACME-comment-syntax">      -1                $CF              $1E</span>
<span class="ACME-comment-syntax">       0                $C7              $1F          silent</span>
<span class="ACME-comment-syntax">       -                $C0              $1F          silent</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP4" class="function-link"><span class="ACME-function-syntax">soundParameterTable</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">get encoded value for channel into</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">top nybble</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$10</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">ensure bit 4 set (set volume)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">sendToSoundChip</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="ACME-function-syntax">sendToSoundChip</span></span>:<br/><a href="S-s16.html#SP14">&#167;14</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb21</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">sendToSoundChipFlagsAreadyPushed</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="ACME-function-syntax">sendToSoundChipFlagsAreadyPushed</span></span>:<br/><a href="S-s16.html#SP14">&#167;14</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb22</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP13" class="function-link"><span class="ACME-function-syntax">systemVIADataDirectionRegisterA</span></a><span class="ACME-plain-syntax">                </span><span class="ACME-comment-syntax">} set data direction to all outputs</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP20" class="function-link"><span class="ACME-function-syntax">systemVIARegisterANoHandshake</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">send data byte to sound chip</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP10" class="function-link"><span class="ACME-function-syntax">systemVIARegisterB</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">set the write enable line low</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(active)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to let the sound chip know there</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">is data</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #2                                              </span><span class="ACME-comment-syntax">Y = loop counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">execute a short delay (this is to</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">keep the write enable line low for</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">at least 8 us, 16 cycles. This is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">required by the sound chip hardware)</span>
<span class="ACME-plain-syntax">                                                        </span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">[An alternative to this loop that</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">takes the same number of cycles, but</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">is two bytes shorter would be to JSR</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to an (existing) RTS instruction.]</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #8                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP10" class="function-link"><span class="ACME-function-syntax">systemVIARegisterB</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">} pull the write enable line high</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} (inactive)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">Y = loop counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">execute another short delay loop</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">[it's longer this time for some</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">reason? It seems like this loop is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">not needed at all to me.]</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. soundParameterTable. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Table to convert channel number to the bits required by the chip</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">soundParameterTable</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="ACME-function-syntax">soundParameterTable</span></span>:<br/><a href="S-s16.html#SP3">&#167;3</a>, <a href="S-s16.html#SP13">&#167;13</a>, <a href="S-s16.html#SP14">&#167;14</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb40</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$E0</span><span class="ACME-plain-syntax">,</span><span class="ACME-constant-syntax">$C0</span><span class="ACME-plain-syntax">,</span><span class="ACME-constant-syntax">$A0</span><span class="ACME-plain-syntax">,</span><span class="ACME-constant-syntax">$80</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5. skipToNextChannelLocal. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">skipToNextChannelLocal</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="ACME-function-syntax">skipToNextChannelLocal</span></span>:<br/><a href="S-s16.html#SP6">&#167;6</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb44</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">skipToNextChannel</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">go to next channel</span>
</pre>
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6. Update sounds in the 100Hz timer interrupt. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">processSoundInterrupt</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="ACME-function-syntax">processSoundInterrupt</span></span>:<br/>Chapter 11: Interrupt processing - <a href="S-s11.html#SP16">&#167;16</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb47</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">numberOfSoundChannelsOnHold</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">zero number of channels on hold for</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">sync</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundSyncCount</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">get sync count</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (this is not zero) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">numberOfSoundChannelsOnHold</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">number of channels on hold for sync</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">= 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundSyncCount</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">number of channels required for sync</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">= 255</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #8                                              </span><span class="ACME-comment-syntax">set loop counter (X = buffer number</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">4-7, corresponding to the channel</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">number 0-3)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">processSoundChannelLoop</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb59</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">loop counter (X=7,6,5,4)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Occupancy</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">get (sound queue occupancy)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP5" class="function-link"><span class="ACME-function-syntax">skipToNextChannelLocal</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">if (nothing playing on this channel)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (check next channel)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">bufferEmptyFlags</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">get buffer empty flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">chooseNextSound</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">if (negative, i.e. buffer empty)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (choose the next sound</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to play)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Duration</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">get duration remaining</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">continueExistingSound</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">if (duration remaining &gt; 0) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (continue processing current</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">sound)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">chooseNextSound</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb69</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP8" class="function-link"><span class="ACME-function-syntax">checkForNextSoundToPlay</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">check and pick up new sound if</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">required</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">continueExistingSound</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb6c</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Duration</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">get duration of current sound</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">skipUpdateOfCurrentSound</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">if (duration is zero) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(skip update)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">check for $FF duration (infinite</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">duration)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">notAtEndOfCurrentSoundDuration</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">if (infinite duration) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(not at end of current sound)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">decrement 20Hz counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Countdown20Hz</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">  </span><span class="ACME-comment-syntax">decrement 10 mS count</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">notAtEndOfCurrentSoundDuration</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">if (counter not reached zero) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (not at end of current sound)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">reset 20Hz counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #5                                              </span><span class="ACME-comment-syntax">reset to 5</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Countdown20Hz</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">  </span><span class="ACME-comment-syntax">to give 50 mSec delay</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">decrement duration at 20Hz</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Duration</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">and decrement main counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">notAtEndOfCurrentSoundDuration</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">if (duration is non-zero) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (not at end of current sound)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">skipUpdateOfCurrentSound</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb84</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP8" class="function-link"><span class="ACME-function-syntax">checkForNextSoundToPlay</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">check and get new sound</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">notAtEndOfCurrentSoundDuration</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eb87</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0StepCountdownProgress</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">  </span><span class="ACME-comment-syntax">check the step progress</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                                       </span><span class="ACME-comment-syntax">if (step progress counter is</span>
<span class="ACME-plain-syntax">                                                                </span><span class="ACME-comment-syntax">zero) then branch (don't</span>
<span class="ACME-plain-syntax">                                                                </span><span class="ACME-comment-syntax">decrement step progress)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0StepCountdownProgress</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">  </span><span class="ACME-comment-syntax">decrement step progress</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP5" class="function-link"><span class="ACME-function-syntax">skipToNextChannelLocal</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (step progress counter is</span>
<span class="ACME-plain-syntax">                                                                </span><span class="ACME-comment-syntax">zero) then branch (check</span>
<span class="ACME-plain-syntax">                                                                </span><span class="ACME-comment-syntax">next channel)</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0EnvelopeOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">get envelope data offset</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">check for no envelope active on this</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">channel</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP5" class="function-link"><span class="ACME-function-syntax">skipToNextChannelLocal</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">if (no envelope active) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(check next channel)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP20" class="function-link"><span class="ACME-function-syntax">envelopeBuffer</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">get step length (first byte of</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">envelope data)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%01111111</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">clear the repeat bit</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0StepCountdownProgress</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">  </span><span class="ACME-comment-syntax">store it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PhaseCounter</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">get current phase in ADSR</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">check for release phase complete</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">adjustEnvelopePitch</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">if (release phase completed) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">set target amplitude for new phase</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PhaseCounter</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">start new step by getting current</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">phase</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0EnvelopeOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">add it to envelope offset</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">transfer to Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP20" class="function-link"><span class="ACME-function-syntax">envelopeBuffer</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">11</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">and get target value at end of</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">current phase</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$3F</span><span class="ACME-plain-syntax">                                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">targetAmplitude</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">store modified number as current</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">target amplitude</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">set amplitude step for new phase</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP20" class="function-link"><span class="ACME-function-syntax">envelopeBuffer</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">7</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">get change of amplitude for current</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">phase</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">currentAmplitudeStep</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">store as current amplitude step</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">change</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">calculate updated volume</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Volume</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">get current volume level</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">clear carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">currentAmplitudeStep</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">add current amplitude step change</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVC</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">skipToggleBits</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (no overflow) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">carry = bit 7. If new amplitude is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">negative (relatively quiet) then set</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">the maximum volume</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$3F</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">A=$3F (loudest volume)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">skipToggleBits</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (carry set) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">toggle bits (A=$C0, silent)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">skipToggleBits</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ebcf</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Volume</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">store in current volume</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Volume</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">} take the EOR of bits 6 and 7</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">updateAmplitude</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">if (bits 6 and 7 of volume are</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">equal) then branch (to update</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">amplitude)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$3F</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">} if (carry clear) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} (A=$3F); otherwise A=$C0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Volume</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">this is stored in current volume</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">updateAmplitude</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ebe1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">currentAmplitudeStep</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">decrement amplitude change per step</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Volume</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">get volume again</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">targetAmplitude</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">subtract target value</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">currentAmplitudeStep</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">check against step value: a negative</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">result indicates correct trend</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">so jump to next part</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">enter new amplitude phase</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">targetAmplitude</span></a><span class="ACME-plain-syntax">                                </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Volume</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">set target amplitude</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PhaseCounter</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">increment phase counter</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get the old volume level</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Volume</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">and compare with the new volume</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$F8</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">mask out lower bits</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">adjustEnvelopePitch</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">if (they are the same) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(volume doesn't need changing)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Volume</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP3" class="function-link"><span class="ACME-function-syntax">setChannelXVolume</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">} set new volume level</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">adjustEnvelopePitch</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ec07</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Section</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">get current pitch section (0-2)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">check if we have reached section 3</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">skipToNextChannel</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">if (current section is 3) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (skip rest of loop as all</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">sections are finished)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0SectionCountdownProgress</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">check progress within</span>
<span class="ACME-plain-syntax">                                                                    </span><span class="ACME-comment-syntax">current pitch section</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">countdownTimerNotFinished</span></a><span class="ACME-plain-syntax">                      </span><span class="ACME-comment-syntax">if (countdown timer is not yet zero)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">increment pitch section</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Section</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">implement a section change</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Section</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">check if it's complete</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #3                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not complete) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">reached end of all three pitch sections</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0EnvelopeOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP20" class="function-link"><span class="ACME-function-syntax">envelopeBuffer</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">} get first envelope byte (top bit =</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} repeat pitch envelope)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">skipToNextChannel</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">if (negative, i.e. don't repeat</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">pitch envelope) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PitchOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">} reset to first pitch section</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Section</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Section</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">get number of steps in new section</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0EnvelopeOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax"> </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP20" class="function-link"><span class="ACME-function-syntax">envelopeBuffer</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">4</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">get envelope byte at offset 4</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(number of steps in first pitch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">section)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0SectionCountdownProgress</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">skipToNextChannel</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">if (zero) then branch (skip forwards)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">countdownTimerNotFinished</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ec3d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0SectionCountdownProgress</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">decrement countdown timer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0EnvelopeOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">get rate of pitch change</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Section</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">add section number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP20" class="function-link"><span class="ACME-function-syntax">envelopeBuffer</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">1</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">get envelope byte 1+section (current</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">change of pitch)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PitchOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">add to current pitch offset</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PitchOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">save updated pitch offset</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0BasePitch</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">add base pitch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP13" class="function-link"><span class="ACME-function-syntax">setPitch</span></a><span class="ACME-plain-syntax">                                       </span><span class="ACME-comment-syntax">set new pitch</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">skipToNextChannel</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="ACME-function-syntax">skipToNextChannel</span></span>:<br/><a href="S-s16.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ec59</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPX</span><span class="ACME-plain-syntax"> #4                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (X=4, i.e. last channel) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (return)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">processSoundChannelLoop</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">do loop again</span>
</pre>
<p class="commentary firstcommentary"><a id="SP7" class="paragraph-anchor"></a><b>&#167;7. clearSoundChannels. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">clearSoundChannels</span><button class="popup" onclick="togglePopup('usagePopup9')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup9">Usage of <span class="code-font"><span class="ACME-function-syntax">clearSoundChannels</span></span>:<br/>Chapter 10: Resets - <a href="S-s10.html#SP14">&#167;14</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ec60</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #8                                              </span><span class="ACME-comment-syntax">X=8, loop counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} Loop from X=7 to X=4 inclusive</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP9" class="function-link"><span class="ACME-function-syntax">clearSoundChannelBuffer</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">} clearing each sound buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPX</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP8" class="paragraph-anchor"></a><b>&#167;8. checkForNextSoundToPlay. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">checkForNextSoundToPlay</span><button class="popup" onclick="togglePopup('usagePopup10')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup10">Usage of <span class="code-font"><span class="ACME-function-syntax">checkForNextSoundToPlay</span></span>:<br/><a href="S-s16.html#SP6">&#167;6</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ec6b</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PhaseCounter</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">get current phase counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">is it 'release complete' state</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (release complete) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">mark release in progress</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PhaseCounter</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">store it</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">bufferEmptyFlags</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">check buffer empty flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP8" class="function-link"><span class="ACME-function-syntax">skipResetAsBufferIsNotEmpty</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">if (buffer not empty) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">mark buffer not empty</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">bufferEmptyFlags</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">an store it</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">Y = loop counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0SyncFlag</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">1</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">zero sync bytes</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">until Y=0</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Duration</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">zero duration count</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundSyncCount</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">reset sync count to $FF (no sync)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">skipResetAsBufferIsNotEmpty</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ec90</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0SyncFlag</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">get synchronising flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP12" class="function-link"><span class="ACME-function-syntax">syncSounds</span></a><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">if (it's zero) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">numberOfSoundChannelsOnHold</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">get number of channels on hold</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP11" class="function-link"><span class="ACME-function-syntax">silenceNonEnvelopeSound</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">if (it's zero) then branch (silence</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">sound)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0SyncFlag</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">zero synchronising flag</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readNextSoundFromBufferAndProcessLocal</span><button class="popup" onclick="togglePopup('usagePopup11')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup11">Usage of <span class="code-font"><span class="ACME-function-syntax">readNextSoundFromBufferAndProcessLocal</span></span>:<br/><a href="S-s16.html#SP12">&#167;12</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ec9f</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP15" class="function-link"><span class="ACME-function-syntax">readNextSoundFromBufferAndProcess</span></a><span class="ACME-plain-syntax">              </span>
</pre>
<p class="commentary firstcommentary"><a id="SP9" class="paragraph-anchor"></a><b>&#167;9. clearSoundChannelBuffer. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">clearSoundChannelBuffer</span><button class="popup" onclick="togglePopup('usagePopup12')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup12">Usage of <span class="code-font"><span class="ACME-function-syntax">clearSoundChannelBuffer</span></span>:<br/><a href="S-s16.html#SP7">&#167;7</a><br/>Chapter 13: Writing characters; printer; buffers - <a href="S-s13.html#SP10">&#167;10</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eca2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP2" class="function-link"><span class="ACME-function-syntax">silenceChannelX</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">silence the channel</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=0 A=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Duration</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">zero main count</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">bufferEmptyFlags</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">mark buffer not empty</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Occupancy</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">mark channel dormant</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">Y=loop counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0SyncFlag</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} zero sync flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundSyncCount</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">reset sync to $FF (no sync)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP13" class="function-link"><span class="ACME-function-syntax">setPitchChanged</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">ALWAYS branch</span>
</pre>
<p class="commentary firstcommentary"><a id="SP10" class="paragraph-anchor"></a><b>&#167;10. syncSoundBufferEmpty. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">syncSoundBufferEmpty</span><button class="popup" onclick="togglePopup('usagePopup13')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup13">Usage of <span class="code-font"><span class="ACME-function-syntax">syncSoundBufferEmpty</span></span>:<br/><a href="S-s16.html#SP12">&#167;12</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ecbc</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">and disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PhaseCounter</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">get ADSR phase counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">check for end of release phase</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not end of release phase) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP22" class="function-link"><span class="ACME-function-syntax">osbyte152EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">examine buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not empty, i.e. there's another</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">sound to play) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Occupancy</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">} mark channel as silent</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP11" class="paragraph-anchor"></a><b>&#167;11. silenceNonEnvelopeSound. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">silenceNonEnvelopeSound</span><button class="popup" onclick="togglePopup('usagePopup14')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup14">Usage of <span class="code-font"><span class="ACME-function-syntax">silenceNonEnvelopeSound</span></span>:<br/><a href="S-s16.html#SP8">&#167;8</a>, <a href="S-s16.html#SP12">&#167;12</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ecd0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0EnvelopeOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">this value is $FF if no envelope is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">defined</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP11" class="function-link"><span class="ACME-function-syntax">exit25</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (envelope defined) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP2" class="function-link"><span class="ACME-function-syntax">silenceChannelX</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">silence channel</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit25</span><button class="popup" onclick="togglePopup('usagePopup15')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup15">Usage of <span class="code-font"><span class="ACME-function-syntax">exit25</span></span>:<br/><a href="S-s16.html#SP13">&#167;13</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ecda</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP12" class="paragraph-anchor"></a><b>&#167;12. syncSounds. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">syncSounds</span><button class="popup" onclick="togglePopup('usagePopup16')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup16">Usage of <span class="code-font"><span class="ACME-function-syntax">syncSounds</span></span>:<br/><a href="S-s16.html#SP8">&#167;8</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ecdb</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP22" class="function-link"><span class="ACME-function-syntax">osbyte152EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">examine next byte in buffer (sets</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">carry if buffer empty)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP10" class="function-link"><span class="ACME-function-syntax">syncSoundBufferEmpty</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">if (buffer empty) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">get just bits 0 and 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP8" class="function-link"><span class="ACME-function-syntax">readNextSoundFromBufferAndProcessLocal</span></a><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">if (zero) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundSyncCount</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">get synchronising count</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (zero, i.e. nothing to sync) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0SyncFlag</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">set sync flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundSyncCount</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">check bit 7 is clear</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">++</span><span class="ACME-plain-syntax">                                              </span><span class="ACME-comment-syntax">if (sync required) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP22" class="function-link"><span class="ACME-function-syntax">osbyte152EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">get first byte from buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">get just bits 0 and 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundSyncCount</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">store result</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">ALWAYS branch</span>

<span class="ACME-identifier-syntax">++</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundSyncCount</span></a><span class="ACME-plain-syntax">                                 </span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP11" class="function-link"><span class="ACME-function-syntax">silenceNonEnvelopeSound</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">silence the channel if envelope not</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">in use</span>
</pre>
<p class="commentary firstcommentary"><a id="SP13" class="paragraph-anchor"></a><b>&#167;13. setPitch. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setPitch</span><button class="popup" onclick="togglePopup('usagePopup17')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup17">Usage of <span class="code-font"><span class="ACME-function-syntax">setPitch</span></span>:<br/><a href="S-s16.html#SP6">&#167;6</a>, <a href="S-s16.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ed01</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Pitch</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">check against pitch value</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP11" class="function-link"><span class="ACME-function-syntax">exit25</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (pitch is equal) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(exit)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setPitchChanged</span><button class="popup" onclick="togglePopup('usagePopup18')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup18">Usage of <span class="code-font"><span class="ACME-function-syntax">setPitchChanged</span></span>:<br/><a href="S-s16.html#SP9">&#167;9</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ed06</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Pitch</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">store new pitch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">check for noise channel</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP14" class="function-link"><span class="ACME-function-syntax">setPitchNotNoise</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">if (X is not noise channel) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (not noise)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">setting noise</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$0F</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">noise value</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP4" class="function-link"><span class="ACME-function-syntax">soundParameterTable</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">convert to chip format, by adding</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">the value required for channel</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP14" class="function-link"><span class="ACME-function-syntax">localSendToSoundChipFlagsAreadyPushed</span></a><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">and pass to chip control routine</span>
</pre>
<p class="commentary firstcommentary"><a id="SP14" class="paragraph-anchor"></a><b>&#167;14. Set the pitch of a sound. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = pitch (0-255).</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setPitchNotNoise</span><button class="popup" onclick="togglePopup('usagePopup19')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup19">Usage of <span class="code-font"><span class="ACME-function-syntax">setPitchNotNoise</span></span>:<br/><a href="S-s16.html#SP13">&#167;13</a><br/>Chapter 2: Memory Layout and Constants - <a href="S-s2.html#SP19">&#167;19</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ed16</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">remember A = pitch (0-252)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #3                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">fractionalSemitones</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">store the fractional amount (0-3)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">between semitones</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">calculate the octave</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">octave</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A = original pitch value</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} divide by 4 (to get semitone count</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} 0-63)</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #12                                             </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP14" class="function-link"><span class="ACME-function-syntax">finishedGettingOctave</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">if (remainder is less than 12) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (we have found the right</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">octave)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">increment octave</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> #12                                             </span><span class="ACME-comment-syntax">subtract 12 for each octave</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not zero) then branch (loop back)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">at this point .soundPitchLow defines the Octave (0-5)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">A = the semitone within the octave</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">get the 10 bit pitch value for the note within the octave from the pitch lookup tables</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">finishedGettingOctave</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ed2f</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y = semitone within octave</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">get octave number into A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP16" class="function-link"><span class="ACME-function-syntax">pitchLookupTableLow</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">get semitone byte from first pitch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">table</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">store it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP17" class="function-link"><span class="ACME-function-syntax">pitchLookupTableHigh</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">get semitone byte from second pitch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">table</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push second table byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">keep two least significant bits only</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">save them</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">pull original second table byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} shift high nybble down into low</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} nybble</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundFractional</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">store it (amount to subtract for</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">each fraction (0-3) between</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">semitones)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">adjust for any eighth tones (0-3) between semitones</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">fractionalSemitones</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">loop counter (0-3)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">++</span><span class="ACME-plain-syntax">                                              </span>

<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundFractional</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">} soundFractional is subtracted from</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} A each time around the loop</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">decrement high byte of pitch as</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">needed</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrement loop counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not done) then branch (loop back)</span>

<span class="ACME-identifier-syntax">++</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">store result (low byte of pitch)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">halve the 10-bit pitch value (.soundPitchLow/High) for each octave</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">recall octave number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y = loop counter = octave number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">} halve soundVariableA/B</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not done yet) then branch (loop</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">back)</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Offset the pitch slightly depending on the channel. Perhaps to avoid</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">phase shift effects when two or more channels play the same pitch?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP13" class="function-link"><span class="ACME-function-syntax">soundPitchOffsetByChannelTable</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax"> </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchHigh</span></a><span class="ACME-plain-syntax">                                 </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">.soundPitchLow/High now holds the 10 bit pitch we want</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">we adjust to get the exact bytes to send to the sound chip</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$0F</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">frequency value (low four bits)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP4" class="function-link"><span class="ACME-function-syntax">soundParameterTable</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">convert to chip format, by adding</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">the value required for channel</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP3" class="function-link"><span class="ACME-function-syntax">sendToSoundChip</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">send first byte to sound chip</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">calculate the second byte to send</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to the sound chip</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">soundPitchHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">} divide by 4</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} shift byte right twice</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">now A holds the second byte we want to send to the sound chip</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">localSendToSoundChipFlagsAreadyPushed</span><button class="popup" onclick="togglePopup('usagePopup20')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup20">Usage of <span class="code-font"><span class="ACME-function-syntax">localSendToSoundChipFlagsAreadyPushed</span></span>:<br/><a href="S-s16.html#SP13">&#167;13</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ed95</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP3" class="function-link"><span class="ACME-function-syntax">sendToSoundChipFlagsAreadyPushed</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">send second byte to sound chip</span>
</pre>
<p class="commentary firstcommentary"><a id="SP15" class="paragraph-anchor"></a><b>&#167;15. Read the next sound from the SOUND buffer and act on it. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Each entry in the sound buffer is three bytes:</span>

<span class="ACME-plain-syntax">   byte 0: envelope-volume-hold-sync byte:</span>
<span class="ACME-plain-syntax">               bit 7     = 0 for an envelope number</span>
<span class="ACME-plain-syntax">               bits 3-6  = envelope number - 1 (0-3), or volume in range (15 to 0)</span>
<span class="ACME-plain-syntax">               bit 2     = h, the hold bit</span>
<span class="ACME-plain-syntax">               bits 0-1  = ss, the sync bits (0-3)</span>
<span class="ACME-plain-syntax">   byte 1: pitch</span>
<span class="ACME-plain-syntax">   byte 2: duration</span>

<span class="ACME-plain-syntax"> See .</span><a href="S-s15.html#SP31" class="internal">osword7EntryPoint</a><span class="ACME-plain-syntax"> where these bytes are added to the buffer.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readNextSoundFromBufferAndProcess</span><button class="popup" onclick="togglePopup('usagePopup21')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup21">Usage of <span class="code-font"><span class="ACME-function-syntax">readNextSoundFromBufferAndProcess</span></span>:<br/><a href="S-s16.html#SP8">&#167;8</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ed98</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read first byte from buffer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(envelope-volume-hold-sync byte)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">check hold bit</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">isolate the hold bit</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP15" class="function-link"><span class="ACME-function-syntax">playNewSound</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">if (hold not set) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">hold required</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0EnvelopeOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">get envelope offset</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">check if envelope is in use</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (envelope in use) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">no envelope in use, silence channel</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP2" class="function-link"><span class="ACME-function-syntax">silenceChannelX</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">so call to silence channel</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">get (and ignore) pitch byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">get the duration</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP15" class="function-link"><span class="ACME-function-syntax">setDurationAndExit</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">set duration, exit</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">playNewSound</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $edb7</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%11111000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">zero bits 0-2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">put bit 7 into carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (zero, envelope) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">extract and set volume</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} convert volume number into</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} an expected value for the</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$40</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">} volume routine</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP3" class="function-link"><span class="ACME-function-syntax">setChannelXVolume</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">and set volume</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">set no envelope in use</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">A=$FF</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">set envelope offset = envelope number * 16 (or $FF for no envelope)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0EnvelopeOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">get envelope number-1 *16 into A</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">restart the channel's 20Hz timer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #5                                              </span><span class="ACME-comment-syntax">set duration sub-counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Countdown20Hz</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">  </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">set phase 1, the start of the sound</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #1                                                      </span><span class="ACME-comment-syntax">set phase counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0StepCountdownProgress</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">  </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">reset section countdown, phase counter, and pitch offset</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                                          </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0SectionCountdownProgress</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">   </span><span class="ACME-comment-syntax">reset pitch section</span>
<span class="ACME-plain-syntax">                                                                    </span><span class="ACME-comment-syntax">countdown progress</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PhaseCounter</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">reset pitch phase</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0PitchOffset</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                </span><span class="ACME-comment-syntax">reset pitch offset</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">set section to $FF</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Section</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">        </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">store pitch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read pitch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0BasePitch</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">set it</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">read duration</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read duration</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">save duration</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">set pitch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0BasePitch</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">get back pitch value</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP13" class="function-link"><span class="ACME-function-syntax">setPitch</span></a><span class="ACME-plain-syntax">                                       </span><span class="ACME-comment-syntax">and set it</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">set duration</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back duration</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setDurationAndExit</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $edf7</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP19" class="function-link"><span class="ACME-function-syntax">channel0Duration</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberSound0</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">set duration</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP16" class="paragraph-anchor"></a><b>&#167;16. Pitch tables. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> These next two tables are used to convert the 8 bit pitch (0-255) of a sound value passed</span>
<span class="ACME-plain-syntax"> to the OS (e.g. via OSWORD 7, see .</span><a href="S-s15.html#SP31" class="internal">osword7EntryPoint</a><span class="ACME-plain-syntax">) into the 10-bit integer pitch value</span>
<span class="ACME-plain-syntax"> required by the sound chip.</span>

<span class="ACME-plain-syntax"> When given a 10 bit pitch value, the chip outputs a tone with frequency:</span>

<span class="ACME-plain-syntax">       frequency (in Hz) = 4,000,000 / (32 * pitch)</span>

<span class="ACME-plain-syntax"> The first table provides the lower 8 bits and the second table (bits 0-1) provide the two</span>
<span class="ACME-plain-syntax"> high bits:</span>

<span class="ACME-plain-syntax">        low byte      10 bit</span>
<span class="ACME-plain-syntax">        +bits 0,1     chip      actual      ideal</span>
<span class="ACME-plain-syntax"> note   high byte     pitch     frequency   frequency</span>
<span class="ACME-plain-syntax"> -------------------------------------------------------------------------</span>
<span class="ACME-plain-syntax">   B    $3F0       =  1008      124.01Hz    123.47Hz</span>
<span class="ACME-plain-syntax">   C    $3B7       =   951      131.44Hz    130.81Hz</span>
<span class="ACME-plain-syntax">   C#   $382       =   898      139.20Hz    138.59Hz</span>
<span class="ACME-plain-syntax">   D    $34F       =   847      147.58Hz    146.83Hz</span>
<span class="ACME-plain-syntax">   D#   $320       =   800      156.25Hz    155.56Hz</span>
<span class="ACME-plain-syntax">   E    $2F3       =   755      165.56Hz    164.81Hz</span>
<span class="ACME-plain-syntax">   F    $2C8       =   712      175.56Hz    174.61Hz</span>
<span class="ACME-plain-syntax">   F#   $2A0       =   672      186.01Hz    185.00Hz</span>
<span class="ACME-plain-syntax">   G    $27B       =   635      196.85Hz    196.00Hz</span>
<span class="ACME-plain-syntax">   G#   $257       =   599      208.68Hz    207.65Hz</span>
<span class="ACME-plain-syntax">   A    $235       =   565      221.24Hz    220.00Hz</span>
<span class="ACME-plain-syntax">   A#   $216       =   534      234.08Hz    233.08Hz</span>

<span class="ACME-plain-syntax"> The upper nybble (bits 4-7) of the .pitchLookupTableHigh stores the amount to reduce the</span>
<span class="ACME-plain-syntax"> 10 bit pitch value for each quarter (0-3) between two adjacent semitones. Bits 2-3 are</span>
<span class="ACME-plain-syntax"> unused.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">pitchLookupTableLow</span><button class="popup" onclick="togglePopup('usagePopup22')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup22">Usage of <span class="code-font"><span class="ACME-function-syntax">pitchLookupTableLow</span></span>:<br/><a href="S-s16.html#SP14">&#167;14</a>, <a href="S-s16.html#SP17">&#167;17</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $edfb</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$F0</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">B</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$B7</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">C</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$82</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">C#</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$4F</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">D</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$20</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">D#</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$F3</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">E</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$C8</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">F</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$A0</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">F#</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$7B</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">G</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$57</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">G#</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$35</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$16</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">A#</span>
</pre>
<p class="commentary firstcommentary"><a id="SP17" class="paragraph-anchor"></a><b>&#167;17. pitchLookupTableHigh. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">pitchLookupTableHigh</span><button class="popup" onclick="togglePopup('usagePopup23')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup23">Usage of <span class="code-font"><span class="ACME-function-syntax">pitchLookupTableHigh</span></span>:<br/><a href="S-s16.html#SP14">&#167;14</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee07</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$E7</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">B</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$D7</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">C</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$CB</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">C#</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$C3</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">D</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$B7</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">D#</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$AA</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">E</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$A2</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">F</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$9A</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">F#</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$92</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">G</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$8A</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">G#</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$82</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$7A</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">A#</span>

<span class="ACME-comment-syntax">[ More accurate values for these two tables would be as follows:</span>

<span class="ACME-comment-syntax">.pitchLookupTableLow</span>
<span class="ACME-comment-syntax">   !byte $F3                                           ; B</span>
<span class="ACME-comment-syntax">   !byte $BB                                           ; C</span>
<span class="ACME-comment-syntax">   !byte $85                                           ; C#</span>
<span class="ACME-comment-syntax">   !byte $52                                           ; D</span>
<span class="ACME-comment-syntax">   !byte $23                                           ; D#</span>
<span class="ACME-comment-syntax">   !byte $F5                                           ; E</span>
<span class="ACME-comment-syntax">   !byte $CB                                           ; F</span>
<span class="ACME-comment-syntax">   !byte $A3                                           ; F#</span>
<span class="ACME-comment-syntax">   !byte $7D                                           ; G</span>
<span class="ACME-comment-syntax">   !byte $59                                           ; G#</span>
<span class="ACME-comment-syntax">   !byte $37                                           ; A</span>
<span class="ACME-comment-syntax">   !byte $17                                           ; A#</span>

<span class="ACME-comment-syntax">.pitchLookupTableHigh</span>
<span class="ACME-comment-syntax">   !byte $E7                                           ; B</span>
<span class="ACME-comment-syntax">   !byte $D7                                           ; C</span>
<span class="ACME-comment-syntax">   !byte $DB                                           ; C#   &lt;-- this is the only</span>
<span class="ACME-comment-syntax">   !byte $C3                                           ; D        change to this table</span>
<span class="ACME-comment-syntax">   !byte $B7                                           ; D#</span>
<span class="ACME-comment-syntax">   !byte $AA                                           ; E</span>
<span class="ACME-comment-syntax">   !byte $A2                                           ; F</span>
<span class="ACME-comment-syntax">   !byte $9A                                           ; F#</span>
<span class="ACME-comment-syntax">   !byte $92                                           ; G</span>
<span class="ACME-comment-syntax">   !byte $8A                                           ; G#</span>
<span class="ACME-comment-syntax">   !byte $82                                           ; A</span>
<span class="ACME-comment-syntax">   !byte $7A                                           ; A#</span>
<span class="ACME-comment-syntax">]</span>
</pre>
<p class="commentary firstcommentary"><a id="SP18" class="paragraph-anchor"></a><b>&#167;18. PHROM numbers are $F0-$FF. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setInitialSpeechPHROMNumber</span><button class="popup" onclick="togglePopup('usagePopup24')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup24">Usage of <span class="code-font"><span class="ACME-function-syntax">setInitialSpeechPHROMNumber</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP25">&#167;25</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee13</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$EF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">first PHROM number is $F0 (A=$EF is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">one less since it will be</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">incremented before being accessed)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentSpeechPHROMOrROMNumber</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">store it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>

</pre>
<p class="commentary firstcommentary"><a id="SP19" class="paragraph-anchor"></a><b>&#167;19. readByteFromROMOrPHROM. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readByteFromROMOrPHROM</span><button class="popup" onclick="togglePopup('usagePopup25')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup25">Usage of <span class="code-font"><span class="ACME-function-syntax">readByteFromROMOrPHROM</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP25">&#167;25</a><br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP18">&#167;18</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee18</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP7" class="function-link"><span class="ACME-function-syntax">romServiceCallROMFilingSystemInitialize</span></a><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">X=paged ROM service call for ROM</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">filing system initialise</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentSpeechPHROMOrROMNumber</span></a><span class="ACME-plain-syntax">                  </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentSpeechPHROMOrROMNumber</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">get ROM number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP20" class="function-link"><span class="ACME-function-syntax">romServiceCall</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (non-negative, i.e. it's a Paged</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">ROM) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">PHROM found (top bit of ROM number set)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} set address pointer in PHROM to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} $0001</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP27" class="function-link"><span class="ACME-function-syntax">writeAddressAndROMNumberToSpeechProcessor</span></a><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">pass info to speech processor</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Check that we have a copyright string "(C)" in the PHROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">X = loop counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP21" class="function-link"><span class="ACME-function-syntax">readByteFromPHROM</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">read byte from PHROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s12.html#SP3" class="function-link"><span class="ACME-function-syntax">copyrightString</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">check if it's the copyright string</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP19" class="function-link"><span class="ACME-function-syntax">readByteFromROMOrPHROM</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">if (no match) then branch (try next</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">ROM)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrement loop counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">loop back until done</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$3E</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">ROM address is $003E, to read the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">'end of speech data' address (See</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">Speech User Guide, Page 27)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">set low byte of address</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readFromPHROM</span><button class="popup" onclick="togglePopup('usagePopup26')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup26">Usage of <span class="code-font"><span class="ACME-function-syntax">readFromPHROM</span></span>:<br/>Chapter 11: Interrupt processing - <a href="S-s11.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee3b</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP27" class="function-link"><span class="ACME-function-syntax">writeAddressAndROMNumberToSpeechProcessor</span></a><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">pass info to speech processor</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">X = loop counter (to read two bytes)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">loopNextByte</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee40</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP21" class="function-link"><span class="ACME-function-syntax">readByteFromPHROM</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">check for speech proc. etc.</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Store the byte read into .romAddressLow/High, reversing all the bits</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #8                                              </span><span class="ACME-comment-syntax">Y = loop counter Y (to read 8 bits)</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">shift byte from PHROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressHigh</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">rotate into memory, reversing order</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">of the bits</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">into .romAddressLow (X=255) and</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">.romAddressHigh (X=0)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">loop eight times</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">increment X to zero (first loop</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">iteration) or one (second loop</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">iteration)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP19" class="function-link"><span class="ACME-function-syntax">loopNextByte</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">if (X=0, first time around loop)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (loop back to read</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">another byte)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP27" class="function-link"><span class="ACME-function-syntax">writeAddressAndROMNumberToSpeechProcessor</span></a><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">ALWAYS branch</span>
</pre>
<p class="commentary firstcommentary"><a id="SP20" class="paragraph-anchor"></a><b>&#167;20. readByteFromROMFSorPHROM. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Read from ROM Filing System or Speech PHrase ROM</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readByteFromROMFSorPHROM</span><button class="popup" onclick="togglePopup('usagePopup27')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup27">Usage of <span class="code-font"><span class="ACME-function-syntax">readByteFromROMFSorPHROM</span></span>:<br/>Chapter 19: Low Level Tape Operations - <a href="S-s19.html#SP1">&#167;1</a>, <a href="S-s19.html#SP18">&#167;18</a>, <a href="S-s19.html#SP19">&#167;19</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee51</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP7" class="function-link"><span class="ACME-function-syntax">romServiceCallROMFilingSystemByteGet</span></a><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">X=paged ROM service call to get a</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">byte from the ROM filing system</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentSpeechPHROMOrROMNumber</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">check ROM / PHROM number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP21" class="function-link"><span class="ACME-function-syntax">readByteFromPHROM</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">if (ROM number is negative, i.e. a</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">PHROM) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$FF</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">Y=255</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">romServiceCall</span><button class="popup" onclick="togglePopup('usagePopup28')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup28">Usage of <span class="code-font"><span class="ACME-function-syntax">romServiceCall</span></span>:<br/><a href="S-s16.html#SP19">&#167;19</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee59</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">store flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s18.html#SP5" class="function-link"><span class="ACME-function-syntax">osbyte143EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">paged ROM service call</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">restore flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">if (A &gt;= 1, i.e. ROM service call</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">was not claimed) then set carry</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">[but carry seems to be unused]</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A = Y = byte read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP21" class="paragraph-anchor"></a><b>&#167;21. readByteFromPHROM. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readByteFromPHROM</span><button class="popup" onclick="togglePopup('usagePopup29')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup29">Usage of <span class="code-font"><span class="ACME-function-syntax">readByteFromPHROM</span></span>:<br/><a href="S-s16.html#SP19">&#167;19</a>, <a href="S-s16.html#SP20">&#167;20</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee62</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$10</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">Command code to ask speech processor</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to read a byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP24" class="function-link"><span class="ACME-function-syntax">osbyte159EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">call OSBYTE 159 - write command to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">speech processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">Y=0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP25" class="function-link"><span class="ACME-function-syntax">readWriteSpeechProcessorPushedFlags</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">ALWAYS branch (read speech processor)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP22" class="paragraph-anchor"></a><b>&#167;22. OSBYTE 158 - Read byte from speech processor. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">osbyte158EntryPoint</span><button class="popup" onclick="togglePopup('usagePopup30')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup30">Usage of <span class="code-font"><span class="ACME-function-syntax">osbyte158EntryPoint</span></span>:<br/>Chapter 11: Interrupt processing - <a href="S-s11.html#SP15">&#167;15</a>, <a href="S-s11.html#SP16">&#167;16</a><br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee6d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">Y=0 to set speech proc to read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP25" class="function-link"><span class="ACME-function-syntax">readWriteSpeechProcessor</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">ALWAYS branch</span>

<span class="ACME-comment-syntax">write A (a byte of an address) to speech processor as two nybbles</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">writeTwoNybblesOfAddressToSpeechProcessor</span><button class="popup" onclick="togglePopup('usagePopup31')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup31">Usage of <span class="code-font"><span class="ACME-function-syntax">writeTwoNybblesOfAddressToSpeechProcessor</span></span>:<br/><a href="S-s16.html#SP27">&#167;27</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee71</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP23" class="function-link"><span class="ACME-function-syntax">writeLoadAddressCommandToSpeechProcessor</span></a><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">to write to speech processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} bring upper nybble to lower nybble</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} by rotate right</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} 4 times</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP23" class="paragraph-anchor"></a><b>&#167;23. writeLoadAddressCommandToSpeechProcessor. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Write 'Load address' command to speech processor</span>
<span class="ACME-plain-syntax"> See Speech System Users Guide (Page 21)</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">writeLoadAddressCommandToSpeechProcessor</span><button class="popup" onclick="togglePopup('usagePopup32')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup32">Usage of <span class="code-font"><span class="ACME-function-syntax">writeLoadAddressCommandToSpeechProcessor</span></span>:<br/><a href="S-s16.html#SP22">&#167;22</a>, <a href="S-s16.html#SP27">&#167;27</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee7a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00001111</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">mask out top nybble</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%01000000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">set top bits: 'Load address' command</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">forming command for speech processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP24" class="paragraph-anchor"></a><b>&#167;24. OSBYTE 159 - Write to speech processor. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       Y = data or command</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">osbyte159EntryPoint</span><button class="popup" onclick="togglePopup('usagePopup33')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup33">Usage of <span class="code-font"><span class="ACME-function-syntax">osbyte159EntryPoint</span></span>:<br/><a href="S-s16.html#SP21">&#167;21</a><br/>Chapter 10: Resets - <a href="S-s10.html#SP16">&#167;16</a><br/>Chapter 11: Interrupt processing - <a href="S-s11.html#SP15">&#167;15</a><br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee7f</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">transfer data or command from Y to A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">to set speech proc to write</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP25" class="paragraph-anchor"></a><b>&#167;25. Read or write to the Speech processor. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> See 'Speech System Users Guide' for details, and data sheets for the chips:</span>

<span class="ACME-plain-syntax"> Speech processor is 'Texas Instruments TMS 5220 Voice Synthesis Processor'</span>
<span class="ACME-plain-syntax"> Speech data ROM  is 'Texas Instruments 16K TMS 6100'</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       Y = 0 to read from speech processor</span>
<span class="ACME-plain-syntax">       Y = 1 to write to speech processor</span>
<span class="ACME-plain-syntax">       A = value to write (speech op-code or data) if writing</span>

<span class="ACME-plain-syntax"> On Exit:</span>
<span class="ACME-plain-syntax">       Y = byte read (when reading)</span>
<span class="ACME-plain-syntax">       N flag set if top bit of Y is set</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readWriteSpeechProcessor</span><button class="popup" onclick="togglePopup('usagePopup34')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup34">Usage of <span class="code-font"><span class="ACME-function-syntax">readWriteSpeechProcessor</span></span>:<br/><a href="S-s16.html#SP22">&#167;22</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee82</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">remember flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readWriteSpeechProcessorPushedFlags</span><button class="popup" onclick="togglePopup('usagePopup35')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup35">Usage of <span class="code-font"><span class="ACME-function-syntax">readWriteSpeechProcessorPushedFlags</span></span>:<br/><a href="S-s16.html#SP21">&#167;21</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ee84</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">speechSystemPresentFlag</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">check for speech processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP25" class="function-link"><span class="ACME-function-syntax">speechProcessingDone</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">if (speech processor not found)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">read or write to the speech processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">remember A (value to write)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s17.html#SP22" class="function-link"><span class="ACME-function-syntax">speechDirectionTable</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">} set data direction to give 8</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP13" class="function-link"><span class="ACME-function-syntax">systemVIADataDirectionRegisterA</span></a><span class="ACME-plain-syntax">                </span><span class="ACME-comment-syntax">} bit input (Y=0) or output (Y=1)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">recall A (value to write)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">write byte (only has an effect if the data direction register is set for writing)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP20" class="function-link"><span class="ACME-function-syntax">systemVIARegisterANoHandshake</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">send value to speech chip</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s17.html#SP22" class="function-link"><span class="ACME-function-syntax">speechEnableTable</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">} enable speech read (Y=0)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP10" class="function-link"><span class="ACME-function-syntax">systemVIARegisterB</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">} or write (Y=1)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">loop to wait for enable read / write to take effect</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP10" class="function-link"><span class="ACME-function-syntax">systemVIARegisterB</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">check result</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">loop back until speech processor</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">reports ready (when bit 7 of Port</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">B is clear)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">read byte (only reads a valid value if the data direction register is set for reading)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP20" class="function-link"><span class="ACME-function-syntax">systemVIARegisterANoHandshake</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">read speech processor data</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">disable reading / writing speech</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">remember A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s17.html#SP22" class="function-link"><span class="ACME-function-syntax">speechDisableTable</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">} disable speech read (Y=0)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP10" class="function-link"><span class="ACME-function-syntax">systemVIARegisterB</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">} or write (Y=1)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">recall A</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">speechProcessingDone</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eeaa</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back flags (including restoring</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupts to what they were before)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y = value read from speech processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP26" class="paragraph-anchor"></a><b>&#167;26. setROMOrPHROMAddress. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">setROMOrPHROMAddress</span><button class="popup" onclick="togglePopup('usagePopup36')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup36">Usage of <span class="code-font"><span class="ACME-function-syntax">setROMOrPHROMAddress</span></span>:<br/>Chapter 18: Tape and ROM Filing systems - <a href="S-s18.html#SP26">&#167;26</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eead</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsSpareByteA</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">set ROM displacement pointer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">in .romAddressLow</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP16" class="function-link"><span class="ACME-function-syntax">fsSpareByteB</span></a><span class="ACME-plain-syntax">                                   </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">And .romAddressHigh</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentSpeechPHROMOrROMNumber</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">check PHROM / ROMFS number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP27" class="function-link"><span class="ACME-function-syntax">exit26</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (ROM is selected, not PHROM)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (return)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP27" class="paragraph-anchor"></a><b>&#167;27. Send the given address to the Speech Processor. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> The speech processor has a command where the CPU can send an address for the speech</span>
<span class="ACME-plain-syntax"> processor together with a ROM/PHROM number. Data is written to the speech processor a</span>
<span class="ACME-plain-syntax"> nybble at a time. Five nybbles are needed in total.</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       .romAddressLow/High contains the 14 bit address (to access anywhere in a 16K ROM)</span>
<span class="ACME-plain-syntax">       to send to the speech processor.</span>
<span class="ACME-plain-syntax">       .currentSpeechPHROMOrROMNumber contains the ROM/PHROM number (6 bits) to the speech</span>
<span class="ACME-plain-syntax">       processor.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">writeAddressAndROMNumberToSpeechProcessor</span><button class="popup" onclick="togglePopup('usagePopup37')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup37">Usage of <span class="code-font"><span class="ACME-function-syntax">writeAddressAndROMNumberToSpeechProcessor</span></span>:<br/><a href="S-s16.html#SP19">&#167;19</a><br/>Chapter 11: Interrupt processing - <a href="S-s11.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eebb</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">push flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">get ROM address low</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP22" class="function-link"><span class="ACME-function-syntax">writeTwoNybblesOfAddressToSpeechProcessor</span></a><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">pass it to speech processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentSpeechPHROMOrROMNumber</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempStoreFA</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">} .tempStoreFA = PHROM / ROM number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">get ROM address high</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempStoreFA</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">} replace the top two bits with the</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} lower two bits of the ROM/PHROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempStoreFA</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">} number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP22" class="function-link"><span class="ACME-function-syntax">writeTwoNybblesOfAddressToSpeechProcessor</span></a><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">pass byte to speech processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempStoreFA</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">.tempStoreFA has the remaining bits</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">of the ROM/PHROM number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP23" class="function-link"><span class="ACME-function-syntax">writeLoadAddressCommandToSpeechProcessor</span></a><span class="ACME-plain-syntax">       </span><span class="ACME-comment-syntax">pass lower nybble to speech processor</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLP</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">restore flags</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit26</span><button class="popup" onclick="togglePopup('usagePopup38')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup38">Usage of <span class="code-font"><span class="ACME-function-syntax">exit26</span></span>:<br/><a href="S-s16.html#SP26">&#167;26</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $eed9</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="S-s15.html">&#10094;</a></li><li class="progresssection"><a href="S-s1.html">1</a></li><li class="progresssection"><a href="S-s2.html">2</a></li><li class="progresssection"><a href="S-s3.html">3</a></li><li class="progresssection"><a href="S-s4.html">4</a></li><li class="progresssection"><a href="S-s5.html">5</a></li><li class="progresssection"><a href="S-s6.html">6</a></li><li class="progresssection"><a href="S-s7.html">7</a></li><li class="progresssection"><a href="S-s8.html">8</a></li><li class="progresssection"><a href="S-s9.html">9</a></li><li class="progresssection"><a href="S-s10.html">10</a></li><li class="progresssection"><a href="S-s11.html">11</a></li><li class="progresssection"><a href="S-s12.html">12</a></li><li class="progresssection"><a href="S-s13.html">13</a></li><li class="progresssection"><a href="S-s14.html">14</a></li><li class="progresssection"><a href="S-s15.html">15</a></li><li class="progresscurrent">16</li><li class="progresssection"><a href="S-s17.html">17</a></li><li class="progresssection"><a href="S-s18.html">18</a></li><li class="progresssection"><a href="S-s19.html">19</a></li><li class="progresssection"><a href="S-s20.html">20</a></li><li class="progresssection"><a href="S-s21.html">21</a></li><li class="progresssection"><a href="S-s22.html">22</a></li><li class="progresssection"><a href="S-s23.html">23</a></li><li class="progresssection"><a href="S-s24.html">24</a></li><li class="progresssection"><a href="S-s25.html">25</a></li><li class="progresssection"><a href="S-s26.html">26</a></li><li class="progressnext"><a href="S-s17.html">&#10095;</a></li></ul></div>
</nav><!--End of weave-->

		</main>
	</body>
</html>

