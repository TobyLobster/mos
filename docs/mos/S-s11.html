<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Chapter 11: Interrupt processing</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Carousel.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/ACME-Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<p>BBC Computer 32K</p>
<h1>*CAT</h1>
<ul><li><a href="../index.html">&#x21A9; home</a></li><li><a href="index.html"><span class="selectedlink">contents</span></a></li>
<li><a href="S-s1.html">introduction</a></li>
<li><a href="S-s2.html">constants</a></li>
<li><a href="S-s3.html">memory-mapped i/o</a></li>
<li><a href="S-s4.html"><b>$C000</b>: chapter 4</a></li>
<li><a href="S-s5.html"><b>$C4C0</b>: chapter 5</a></li>
<li><a href="S-s6.html"><b>$CB1D</b>: chapter 6</a></li>
<li><a href="S-s7.html"><b>$CCF8</b>: chapter 7</a></li>
<li><a href="S-s8.html"><b>$D060</b>: chapter 8</a></li>
<li><a href="S-s9.html"><b>$D7C2</b>: chapter 9</a></li>
<li><a href="S-s10.html"><b>$D940</b>: chapter 10</a></li>
<li><span class="unlink"><b>$DC1C</b>: chapter 11</span></li>
<li><a href="S-s12.html"><b>$DEC5</b>: chapter 12</a></li>
<li><a href="S-s13.html"><b>$E0A4</b>: chapter 13</a></li>
<li><a href="S-s14.html"><b>$E20E</b>: chapter 14</a></li>
<li><a href="S-s15.html"><b>$E5B3</b>: chapter 15</a></li>
<li><a href="S-s16.html"><b>$EB03</b>: chapter 16</a></li>
<li><a href="S-s17.html"><b>$EEDA</b>: chapter 17</a></li>
<li><a href="S-s18.html"><b>$F135</b>: chapter 18</a></li>
<li><a href="S-s19.html"><b>$F588</b>: chapter 19</a></li>
<li><a href="S-s20.html"><b>$F8A9</b>: chapter 20</a></li>
<li><a href="S-s21.html"><b>$FAE8</b>: chapter 21</a></li>
<li><a href="S-s22.html"><b>$FC00</b>: chapter 22</a></li>
<li><a href="S-s23.html"><b>$FF00</b>: chapter 23</a></li>
<li><a href="S-s24.html"><b>$FFA7</b>: chapter 24</a></li>
<li><a href="S-s25.html">appendix</a></li>
<li><a href="S-s26.html">index</a></li>

</ul>
		</nav>
		<main role="main">
		<!--Weave of 'Chapter 11: Interrupt processing' generated by Inweb-->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">MOS 1.20</a></li><li><b>Chapter 11: Interrupt processing</b></li></ul></div>
<p class="purpose">OSBYTE 17; IRQ entry point; BRK handler; IRQ1, IRQ2 handlers; Display string - 681 bytes (4.1%)</p>

<ul class="toc"><li><a href="S-s11.html#SP1">&#167;1. IRQ entry point</a></li><li><a href="S-s11.html#SP2">&#167;2. brkRoutine</a></li><li><a href="S-s11.html#SP3">&#167;3. Default BRK handler</a></li><li><a href="S-s11.html#SP4">&#167;4. rs423Handler</a></li><li><a href="S-s11.html#SP5">&#167;5. readFromRS423</a></li><li><a href="S-s11.html#SP6">&#167;6. IRQ1 default handler</a></li><li><a href="S-s11.html#SP7">&#167;7. irq1CheckACIA</a></li><li><a href="S-s11.html#SP8">&#167;8. rs423ErrorDetectedSetAY</a></li><li><a href="S-s11.html#SP9">&#167;9. rs423ErrorDetected</a></li><li><a href="S-s11.html#SP10">&#167;10. Send to RS-423 / Serial printer as needed</a></li><li><a href="S-s11.html#SP11">&#167;11. Service RS-423 interrupt</a></li><li><a href="S-s11.html#SP12">&#167;12. Unrecognised Interrupt</a></li><li><a href="S-s11.html#SP13">&#167;13. Check for System VIA interrupt</a></li><li><a href="S-s11.html#SP14">&#167;14. Check for User VIA interrupt</a></li><li><a href="S-s11.html#SP15">&#167;15. Check to see if the interrupt is a Speech interrupt and deal with it</a></li><li><a href="S-s11.html#SP16">&#167;16. IRQ1 Interrupt - 100Hz interrupt</a></li><li><a href="S-s11.html#SP17">&#167;17. IRQ1 Interrupt - Analogue to Digital Conversion (End of Conversion)</a></li><li><a href="S-s11.html#SP18">&#167;18. IRQ1 Interrupt - keyboard</a></li><li><a href="S-s11.html#SP19">&#167;19. restoreRegistersAndReturnFromInterrupt</a></li><li><a href="S-s11.html#SP20">&#167;20. Default IRQ2 handler - does nothing</a></li><li><a href="S-s11.html#SP21">&#167;21. OSBYTE 17 - Start ADC conversions</a></li><li><a href="S-s11.html#SP22">&#167;22. Display string on screen</a></li><li><a href="S-s11.html#SP23">&#167;23. printMessage</a></li><li><a href="S-s11.html#SP24">&#167;24. osbyte129Timed</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. IRQ entry point. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       The stack contains status register (flags); high and low bytes of previous program</span>
<span class="ACME-plain-syntax">       counter.</span>

<span class="ACME-plain-syntax"> IRQ and BRK causes execution here. If it was a BRK instruction we branch (see .</span><a href="S-s11.html#SP2" class="internal">brkRoutine</a><span class="ACME-plain-syntax">)</span>
<span class="ACME-plain-syntax"> otherwise we call (indirectly via IRQ1V) the default IRQ1 handler (see .</span><a href="S-s11.html#SP6" class="internal">irq1Handler</a><span class="ACME-plain-syntax">)</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irqEntryPoint</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="ACME-function-syntax">irqEntryPoint</span></span>:<br/>Chapter 24: OS entry points; Tube; FRED; JIM; SHEILA - <a href="S-s24.html#SP7">&#167;7</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dc1c</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">interruptAccumulator</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">save A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">read flags</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">store flags again</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00010000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">check BRK flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP2" class="function-link"><span class="ACME-function-syntax">brkRoutine</span></a><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">if (BRK flag set) then branch (to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">BRK handler)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> (.</span><a href="S-s2.html#SP13" class="function-link"><span class="ACME-function-syntax">vectorIRQ1V</span></a><span class="ACME-plain-syntax">)                                  </span><span class="ACME-comment-syntax">jump to the IRQ1 vector (by default</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">this will jump to .irq1Handler)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. brkRoutine. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">brkRoutine</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="ACME-function-syntax">brkRoutine</span></span>:<br/><a href="S-s11.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dc27</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} save X on stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TSX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get stack pointer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP12" class="function-link"><span class="ACME-function-syntax">stackPage</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">3</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">get program counter low</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLD</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">subtract 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">brkAddressLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">and store</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP12" class="function-link"><span class="ACME-function-syntax">stackPage</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">4</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">get high byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">subtract 1 if necessary</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">brkAddressHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">and store</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentlySelectedROM</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">get currently active ROM</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">romNumberActiveLastBRK</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">and store it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">stackPointerLastBRK</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">store stack pointer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP7" class="function-link"><span class="ACME-function-syntax">romServiceCallBreakInstruction</span></a><span class="ACME-plain-syntax">                </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s18.html#SP5" class="function-link"><span class="ACME-function-syntax">osbyte143EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">} issue ROM service call 6 (Break)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} to ROMs so they get a chance to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} respond.</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">at this point .brkAddressLow/High</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">points to the byte after the BRK</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">instruction.</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">ROMS may use BRK for their own</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">purposes</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">languageROMNumber</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">get current language</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s10.html#SP33" class="function-link"><span class="ACME-function-syntax">selectROM</span></a><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">and activate it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back original value of X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">interruptAccumulator</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">get back original value of A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">allow interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> (.</span><a href="S-s2.html#SP13" class="function-link"><span class="ACME-function-syntax">vectorBRKV</span></a><span class="ACME-plain-syntax">)                                   </span><span class="ACME-comment-syntax">and JUMP via BRKV (normally into</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">current language)</span>
</pre>
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3. Default BRK handler. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> This is the default BRK handler that is used at boot time. When BASIC or other language</span>
<span class="ACME-plain-syntax"> ROM starts it will set up it's own BRK handler instead.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">brkHandler</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="ACME-function-syntax">brkHandler</span></span>:<br/>Chapter 10: Resets - <a href="S-s10.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dc54</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">Y=0 to point to byte after BRK</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP23" class="function-link"><span class="ACME-function-syntax">printMessage</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">print message</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">startupMessageSuppressionAndBootOptions</span></a><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">} bit 0 set means: lock up machine</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} if !BOOT errors from DISC (because</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} e.g. no language found)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} rotate into carry</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (carry set) then branch (hang the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">machine!)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s24.html#SP6" class="function-link"><span class="ACME-function-syntax">OSNEWL</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">print two newlines</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s24.html#SP6" class="function-link"><span class="ACME-function-syntax">OSNEWL</span></a><span class="ACME-plain-syntax">                                         </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s10.html#SP25" class="function-link"><span class="ACME-function-syntax">setTapeFSAndFindLanguageROM</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">set tape filing system before</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">entering current language</span>
</pre>
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. rs423Handler. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">rs423Handler</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="ACME-function-syntax">rs423Handler</span></span>:<br/><a href="S-s11.html#SP10">&#167;10</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dc68</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423ReadyFlag</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">set RS-423 ready</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423ControlRegisterCopy</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">check bit 7 of current ACIA control</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">register (aka 'CR7' - ACIA</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupts enabled flag)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP4" class="function-link"><span class="ACME-function-syntax">rs423SetRequestToSendInactive</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">if (ACIA interrupts disabled) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s15.html#SP19" class="function-link"><span class="ACME-function-syntax">getRS423InputBufferFreeBytes</span></a><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">call subroutine to check if serial</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">buffer is full</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">set X to the value (zero) which will</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">clear bit 5 and 6 of ACIA control</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">register</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(aka 'CR5' and 'CR6' on the ACIA</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">6850 datasheet)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">which means set the 'Request To</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">Send' pin low and transmit interrupt</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">disabled.</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">this is the active state.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP4" class="function-link"><span class="ACME-function-syntax">rs423BufferSpaceOK</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">if (buffer has enough free space)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">rs423SetRequestToSendInactive</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="ACME-function-syntax">rs423SetRequestToSendInactive</span></span>:<br/><a href="S-s11.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dc78</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%01000000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">set X to value which will clear bit</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">5 and set bit 6 of ACIA control</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">register</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(aka CR5 and CR6 on the ACIA 6850</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">datasheet)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">which means set the 'Request To</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">Send' pin high and transmit</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupt disabled.</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">this is the inactive state.</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">rs423BufferSpaceOK</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dc7a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP4" class="function-link"><span class="ACME-function-syntax">writeToACIARequestToSend</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">write to 'Request To Send' value in</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">ACIA</span>
</pre>
<p class="commentary firstcommentary"><a id="SP5" class="paragraph-anchor"></a><b>&#167;5. readFromRS423. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">readFromRS423</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="ACME-function-syntax">readFromRS423</span></span>:<br/><a href="S-s11.html#SP11">&#167;11</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dc7d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP6" class="function-link"><span class="ACME-function-syntax">acia6850DataRegister</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">read serial data from ACIA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$3A</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">AND %0011 1010</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP9" class="function-link"><span class="ACME-function-syntax">rs423ErrorDetected</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">if (not zero) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423InputSuppressionFlag</span></a><span class="ACME-plain-syntax">                      </span><span class="ACME-comment-syntax">read RS-423 input suppression flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (RS-423 input suppressed) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (return)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP31" class="function-link"><span class="ACME-function-syntax">osbyte153EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">put byte in RS-423 input buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s15.html#SP19" class="function-link"><span class="ACME-function-syntax">getRS423InputBufferFreeBytes</span></a><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">count buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP4" class="function-link"><span class="ACME-function-syntax">rs423SetRequestToSendInactive</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">if (buffer is low on free space)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch back (to make 'Request</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">To Send' inactive)</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP6" class="paragraph-anchor"></a><b>&#167;6. IRQ1 default handler. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> When a hardware device generates an IRQ, this IRQ1 handler is executed (as the default</span>
<span class="ACME-plain-syntax"> handler, see .</span><a href="S-s11.html#SP1" class="internal">irqEntryPoint</a><span class="ACME-plain-syntax">). After saving registers and a suitable return address on</span>
<span class="ACME-plain-syntax"> the stack, we check three hardware devices in turn, to see what needs attention:</span>

<span class="ACME-plain-syntax">  1. Check for ACIA interrupt (see .</span><a href="S-s11.html#SP7" class="internal">irq1CheckACIA</a><span class="ACME-plain-syntax">)</span>
<span class="ACME-plain-syntax">       1a. updates RS-423 or Cassette then exit</span>
<span class="ACME-plain-syntax">  2. Check for System VIA interrupt (see .</span><a href="S-s11.html#SP13" class="internal">irq1CheckSystemVIA</a><span class="ACME-plain-syntax">)</span>
<span class="ACME-plain-syntax">       2a. If VSYNC then update:</span>
<span class="ACME-plain-syntax">               vsync counter</span>
<span class="ACME-plain-syntax">               RS-423 counter</span>
<span class="ACME-plain-syntax">               flashing colours</span>
<span class="ACME-plain-syntax">               then exit</span>
<span class="ACME-plain-syntax">       2b. If Timer 2 times out (Speech timer) (see .</span><a href="S-s11.html#SP15" class="internal">irq1CheckSystemVIASpeech</a><span class="ACME-plain-syntax">)</span>
<span class="ACME-plain-syntax">               update speech system (send speech data from speech buffer as needed)</span>
<span class="ACME-plain-syntax">               then exit</span>
<span class="ACME-plain-syntax">       2c. If Timer 1 times out (100Hz timer) (see .</span><a href="S-s11.html#SP16" class="internal">irq1CheckSystemVIA100HzTimer</a><span class="ACME-plain-syntax">)</span>
<span class="ACME-plain-syntax">           then update:</span>
<span class="ACME-plain-syntax">               the clock</span>
<span class="ACME-plain-syntax">               the countdown timer event</span>
<span class="ACME-plain-syntax">               the INKEY timeout counter</span>
<span class="ACME-plain-syntax">               sound</span>
<span class="ACME-plain-syntax">               speech</span>
<span class="ACME-plain-syntax">               ACIA</span>
<span class="ACME-plain-syntax">               printer</span>
<span class="ACME-plain-syntax">               keyboard</span>
<span class="ACME-plain-syntax">               ADC conversion</span>
<span class="ACME-plain-syntax">               then exit</span>
<span class="ACME-plain-syntax">  3. Check for User VIA interrupt (see .</span><a href="S-s11.html#SP14" class="internal">irq1CheckUserVIA</a><span class="ACME-plain-syntax">)</span>
<span class="ACME-plain-syntax">       3a. updates a parallel printer then exit</span>

<span class="ACME-plain-syntax">  Unrecognised interrupts are passed on to IRQ2V, allowing user code to process it.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irq1Handler</span><button class="popup" onclick="togglePopup('usagePopup7')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup7">Usage of <span class="code-font"><span class="ACME-function-syntax">irq1Handler</span></span>:<br/><a href="S-s11.html#SP1">&#167;1</a><br/>Chapter 10: Resets - <a href="S-s10.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dc93</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLD</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">clear decimal flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">interruptAccumulator</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} push original A,X,Y register onto</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #&gt;(.</span><a href="S-s11.html#SP19" class="function-link"><span class="ACME-function-syntax">restoreRegistersAndReturnFromInterrupt</span></a><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">1)   </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} push return address onto stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #&lt;(.</span><a href="S-s11.html#SP19" class="function-link"><span class="ACME-function-syntax">restoreRegistersAndReturnFromInterrupt</span></a><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">1)   </span><span class="ACME-comment-syntax">} RTS will now exit to</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} .restoreRegistersAndReturnFromInterrupt</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLV</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">clear V flag (meaning: check the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">ACIA generated the interrupt)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP7" class="paragraph-anchor"></a><b>&#167;7. irq1CheckACIA. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Check for ACIA Interrupt or Update ACIA</span>

<span class="ACME-plain-syntax"> Two modes of operation (V CLEAR and V SET)</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       V CLEAR means check that the ACIA generated the interrupt, and if so then update</span>
<span class="ACME-plain-syntax">               the RS-423 or cassette as needed</span>
<span class="ACME-plain-syntax">       V  SET  means just update the RS-423</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irq1CheckACIA</span><button class="popup" onclick="togglePopup('usagePopup8')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup8">Usage of <span class="code-font"><span class="ACME-function-syntax">irq1CheckACIA</span></span>:<br/><a href="S-s11.html#SP16">&#167;16</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dca2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP6" class="function-link"><span class="ACME-function-syntax">acia6850StatusRegister</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">get the ACIA status register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVS</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if ('V SET') then branch (don't</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">check the ACIA generated the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupt)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP13" class="function-link"><span class="ACME-function-syntax">irq1CheckSystemVIA</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">if (ACIA didn't generate the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupt) then branch (check the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">next thing)</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423TimeoutCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read RS-423 timeout counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrement it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423HasControl</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">if (timed out) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVS</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP10" class="function-link"><span class="ACME-function-syntax">exit13</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if ('V SET') then branch (return)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s19.html#SP1" class="function-link"><span class="ACME-function-syntax">updateACIA</span></a><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">update ACIA</span>
</pre>
<p class="commentary firstcommentary"><a id="SP8" class="paragraph-anchor"></a><b>&#167;8. rs423ErrorDetectedSetAY. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">rs423ErrorDetectedSetAY</span><button class="popup" onclick="togglePopup('usagePopup9')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup9">Usage of <span class="code-font"><span class="ACME-function-syntax">rs423ErrorDetectedSetAY</span></span>:<br/><a href="S-s11.html#SP11">&#167;11</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dcb3</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP6" class="function-link"><span class="ACME-function-syntax">acia6850DataRegister</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">read ACIA data</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP9" class="paragraph-anchor"></a><b>&#167;9. rs423ErrorDetected. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">rs423ErrorDetected</span><button class="popup" onclick="togglePopup('usagePopup10')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup10">Usage of <span class="code-font"><span class="ACME-function-syntax">rs423ErrorDetected</span></span>:<br/><a href="S-s11.html#SP5">&#167;5</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dcb8</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=status byte shifted right once</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=character received</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP5" class="function-link"><span class="ACME-function-syntax">eventRS423ErrorDetected</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">Y=7</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP25" class="function-link"><span class="ACME-function-syntax">eventEntryPoint</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">check and service EVENT 7 RS-423</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">error</span>
</pre>
<p class="commentary firstcommentary"><a id="SP10" class="paragraph-anchor"></a><b>&#167;10. Send to RS-423 / Serial printer as needed. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> If we have a non-empty RS-423 output buffer, then send the next byte, reset the RS-423</span>
<span class="ACME-plain-syntax"> timeout counter and exit.</span>

<span class="ACME-plain-syntax"> If we have a serial printer, update the printer buffer empty flag. If not empty then</span>
<span class="ACME-plain-syntax"> send the byte to the printer (and also reset the RS-423 timeout counter).</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">writeToACIA</span><button class="popup" onclick="togglePopup('usagePopup11')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup11">Usage of <span class="code-font"><span class="ACME-function-syntax">writeToACIA</span></span>:<br/><a href="S-s11.html#SP11">&#167;11</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dcbf</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberRS423Output</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">} read from RS-423 output buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (buffer isn't empty) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">forward</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">RS-423 buffer empty</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerDestination</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">read printer destination</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #2                                              </span><span class="ACME-comment-syntax">is it serial printer?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP4" class="function-link"><span class="ACME-function-syntax">rs423Handler</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">if (not a serial printer) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (it must be RS-423)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">serial printer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X=3 (.bufferNumberPrinter)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read printer buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerBufferEmptyFlag</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">update the empty flag (put carry</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">into bit 7)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP4" class="function-link"><span class="ACME-function-syntax">rs423Handler</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">if (printer buffer is empty) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP6" class="function-link"><span class="ACME-function-syntax">acia6850DataRegister</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">pass either printer or RS-423 data</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to ACIA</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$E7</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">} reset timeout counter to</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423TimeoutCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">} count up 25 vsyncs (0.5 seconds)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit13</span><button class="popup" onclick="togglePopup('usagePopup12')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup12">Usage of <span class="code-font"><span class="ACME-function-syntax">exit13</span></span>:<br/><a href="S-s11.html#SP7">&#167;7</a>, <a href="S-s11.html#SP11">&#167;11</a>, <a href="S-s11.html#SP12">&#167;12</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dcdd</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP11" class="paragraph-anchor"></a><b>&#167;11. Service RS-423 interrupt. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> See NAUG Section 8.4 - Serial system interrupts, Page 126</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = ACIA status byte</span>

<span class="ACME-plain-syntax">       Two modes of operation:</span>
<span class="ACME-plain-syntax">       V CLEAR - read from RS-423; handle DCD (Data Carrier Detect); write to RS-423;</span>
<span class="ACME-plain-syntax">                 handle unrecognised interrupt</span>
<span class="ACME-plain-syntax">       V SET   - handle DCD; write to RS-423</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">rs423HasControl</span><button class="popup" onclick="togglePopup('usagePopup13')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup13">Usage of <span class="code-font"><span class="ACME-function-syntax">rs423HasControl</span></span>:<br/><a href="S-s11.html#SP7">&#167;7</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dcde</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423IRQBitMask</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">AND with ACIA bit mask (normally $FF)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">shift right to put bit 0 of ACIA</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">status (receive interrupt) in carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not a receive interrupt) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (skip read)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVS</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (V SET mode) then branch (skip</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">read)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">rs423ControlRegisterCopy</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">read copy of ACIA control register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP5" class="function-link"><span class="ACME-function-syntax">readFromRS423</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">if (ACIA 6850 interrupts enabled)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">shift,  put bit 1 of ACIA status</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">into carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">rotate, put bit 2 of ACIA status</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">into carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCS</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP8" class="function-link"><span class="ACME-function-syntax">rs423ErrorDetectedSetAY</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">if (Data Carrier Detected interrupt)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP10" class="function-link"><span class="ACME-function-syntax">writeToACIA</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">if (ACIA status bit 1 is set) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (transmit interrupt)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVS</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP10" class="function-link"><span class="ACME-function-syntax">exit13</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (V SET mode) then branch (exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP12" class="paragraph-anchor"></a><b>&#167;12. Unrecognised Interrupt. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> When we have an interrupt that we don't understand, pass it to the ROMs to see if</span>
<span class="ACME-plain-syntax"> they can handle it. If not, then pass it on to the IRQ2 vector.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">unrecognisedInterrupt</span><button class="popup" onclick="togglePopup('usagePopup14')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup14">Usage of <span class="code-font"><span class="ACME-function-syntax">unrecognisedInterrupt</span></span>:<br/><a href="S-s11.html#SP14">&#167;14</a>, <a href="S-s11.html#SP18">&#167;18</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dcf3</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP7" class="function-link"><span class="ACME-function-syntax">romServiceCallUnrecognisedInterrupt</span></a><span class="ACME-plain-syntax">           </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s18.html#SP5" class="function-link"><span class="ACME-function-syntax">osbyte143EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">} issue paged ROM service call for</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} 'unrecognised interrupt'</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP10" class="function-link"><span class="ACME-function-syntax">exit13</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (a ROM recognises it) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(exit)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">otherwise remove address from stack</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">and restore Y, X, and A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">interruptAccumulator</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">.interruptAccumulator=A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> (.</span><a href="S-s2.html#SP13" class="function-link"><span class="ACME-function-syntax">vectorIRQ2V</span></a><span class="ACME-plain-syntax">)                                  </span><span class="ACME-comment-syntax">and offer to the user via IRQ2V</span>
</pre>
<p class="commentary firstcommentary"><a id="SP13" class="paragraph-anchor"></a><b>&#167;13. Check for System VIA interrupt. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Check if the System VIA triggered the interrupt and deal with it.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irq1CheckSystemVIA</span><button class="popup" onclick="togglePopup('usagePopup15')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup15">Usage of <span class="code-font"><span class="ACME-function-syntax">irq1CheckSystemVIA</span></span>:<br/><a href="S-s11.html#SP7">&#167;7</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dd06</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP19" class="function-link"><span class="ACME-function-syntax">systemVIAInterruptFlagRegister</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">read system VIA interrupt flag</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP14" class="function-link"><span class="ACME-function-syntax">irq1CheckUserVIA</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">if (the System VIA has not caused</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupt) then branch (try the next</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">thing)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">systemVIAIRQBitMask</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">mask with VIA bit mask (normally $FF)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP20" class="function-link"><span class="ACME-function-syntax">systemVIAInterruptEnableRegister</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">and interrupt enable register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} rotate right twice to check for</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} IRQ 1 (vsync)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP15" class="function-link"><span class="ACME-function-syntax">irq1CheckSystemVIASpeech</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">if (not vsync) then branch (to check</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">for speech)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">vsync interrupt</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">verticalSyncCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">decrement vertical sync counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423TimeoutCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">A = RS-423 Timeout counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (positive) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">rs423TimeoutCounter</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">increment counter</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">videoULAFlashingColourIntervalCount</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">load flash counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP13" class="function-link"><span class="ACME-function-syntax">doneFlashingColours</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">if (flashing system is not in use)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">videoULAFlashingColourIntervalCount</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">decrement counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP13" class="function-link"><span class="ACME-function-syntax">doneFlashingColours</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">if (not time for a colour to flash)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (to continue processing)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">ready to flash colour</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">videoULAFirstFlashingColourInterval</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">get mark period count in X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">videoULAVideoControlRegisterCopy</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">current Video ULA control setting in</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">shift bit 0 into C</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP13" class="function-link"><span class="ACME-function-syntax">restoreAndFlipBit</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">if (first colour is in effect) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">videoULASecondFlashingColourInterval</span></a><span class="ACME-plain-syntax">           </span><span class="ACME-comment-syntax">get second colour period count in X</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">restoreAndFlipBit</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dd34</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">restore bit</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #1                                              </span><span class="ACME-comment-syntax">and invert it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s15.html#SP59" class="function-link"><span class="ACME-function-syntax">setVideoULA</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">then set colour</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">videoULAFlashingColourIntervalCount</span></a><span class="ACME-plain-syntax">            </span><span class="ACME-comment-syntax">reset the count until the next flash</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">doneFlashingColours</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dd3d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP5" class="function-link"><span class="ACME-function-syntax">eventStartOfVSync</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">Y=event type: start of vsync</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP25" class="function-link"><span class="ACME-function-syntax">eventEntryPoint</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">call the event</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00000010</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">A=bit set to clear the vsync</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupt flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP17" class="function-link"><span class="ACME-function-syntax">storeToSystemVIAIFR</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">clear interrupt and exit</span>
</pre>
<p class="commentary firstcommentary"><a id="SP14" class="paragraph-anchor"></a><b>&#167;14. Check for User VIA interrupt. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Check if the User VIA triggered the interrupt and deal with it (check for parallel</span>
<span class="ACME-plain-syntax"> printer in particular).</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irq1CheckUserVIA</span><button class="popup" onclick="togglePopup('usagePopup16')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup16">Usage of <span class="code-font"><span class="ACME-function-syntax">irq1CheckUserVIA</span></span>:<br/><a href="S-s11.html#SP13">&#167;13</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dd47</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP23" class="function-link"><span class="ACME-function-syntax">userVIAInterruptFlagRegister</span></a><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">check User VIA interrupt flags</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP12" class="function-link"><span class="ACME-function-syntax">unrecognisedInterrupt</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">if (User VIA did not call interrupt)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">userVIAIRQBitMask</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP24" class="function-link"><span class="ACME-function-syntax">userVIAInterruptEnableRegister</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} check for User IRQ bit 1 set</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} (printer interrupt)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP12" class="function-link"><span class="ACME-function-syntax">unrecognisedInterrupt</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">if (not printer interrupt) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">printerDestination</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">get printer type</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrement</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP12" class="function-link"><span class="ACME-function-syntax">unrecognisedInterrupt</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">if (not a parallel printer) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with parallel printer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00000010</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">interrupt bit 1 (printer interrupt)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP23" class="function-link"><span class="ACME-function-syntax">userVIAInterruptFlagRegister</span></a><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">clear interrupt bit 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP24" class="function-link"><span class="ACME-function-syntax">userVIAInterruptEnableRegister</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">enable interrupt bit 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP4" class="function-link"><span class="ACME-function-syntax">bufferNumberPrinter</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP3" class="function-link"><span class="ACME-function-syntax">openPrinterChannel</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">} output data to parallel printer</span>
</pre>
<p class="commentary firstcommentary"><a id="SP15" class="paragraph-anchor"></a><b>&#167;15. Check to see if the interrupt is a Speech interrupt and deal with it. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> The speech processor chip has an internal 16 byte buffer to hold incoming data.</span>

<span class="ACME-plain-syntax"> When speaking, this buffer will run out every 50 milliseconds. When the buffer becomes</span>
<span class="ACME-plain-syntax"> half full, an interrupt occurs. In fact, a speech interrupt is generated when any of the</span>
<span class="ACME-plain-syntax"> following occur:</span>

<span class="ACME-plain-syntax">   (1) End of speech processing</span>
<span class="ACME-plain-syntax">   (2) Speech hardware is low on data (half full, i.e. 8 bytes or less), indicating more</span>
<span class="ACME-plain-syntax">       phrase data needs to be supplied for the Speak External command.</span>
<span class="ACME-plain-syntax">   (3) Speech hardware is empty of data, indicating the CPU failed to supply phrase data</span>
<span class="ACME-plain-syntax">       fast enough for the Speak External command.</span>
<span class="ACME-plain-syntax">   (4) At the start of a Speak External instruction, if speech hardware is not empty of data.</span>

<span class="ACME-plain-syntax"> We call .updateSpeech in the 100Hz interrupt to keep the speech hardware regularly supplied</span>
<span class="ACME-plain-syntax"> with data.</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       A = System VIA interrupt flag shifted right twice</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irq1CheckSystemVIASpeech</span><button class="popup" onclick="togglePopup('usagePopup17')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup17">Usage of <span class="code-font"><span class="ACME-function-syntax">irq1CheckSystemVIASpeech</span></span>:<br/><a href="S-s11.html#SP13">&#167;13</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dd69</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} rotate left twice to get back to</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} original interrupt flag register</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} alignment of bits</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">rotate left to get bit 5 into bit 6</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">rotate left to get bit 6 into bit 7</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP16" class="function-link"><span class="ACME-function-syntax">irq1CheckSystemVIA100HzTimer</span></a><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">if (bit 5 of system via IFR is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">clear, i.e. it's not timer 2, used</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">for the speech interrupt)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">deal with speech</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00100000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">} clear bit 5, the timer 2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">} interrupt</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP19" class="function-link"><span class="ACME-function-syntax">systemVIAInterruptFlagRegister</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP15" class="function-link"><span class="ACME-function-syntax">systemVIATimer2CounterHigh</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">clear Timer 2 (write to high byte)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">updateSpeech</span><button class="popup" onclick="togglePopup('usagePopup18')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup18">Usage of <span class="code-font"><span class="ACME-function-syntax">updateSpeech</span></span>:<br/><a href="S-s11.html#SP16">&#167;16</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dd79</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #8                                              </span><span class="ACME-comment-syntax">} loop counter (shifted right on</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempStoreFB</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">} each loop iteration)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">on each speech update we loop a maximum of 4 times to feed the speech chip with up to</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">4 bytes of new data from the CPU's speech buffer.</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">feedSpeechChipWithDataLoop</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dd7d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">check our speech buffer, see if there's more data</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP22" class="function-link"><span class="ACME-function-syntax">osbyte152EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">examine buffer status for buffer 8</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(the speech buffer), C set if buffer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">is empty, otherwise A is byte read.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">speechBufferEmptyFlag</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">shift carry into bit 7 - store as</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">the 'speech buffer empty' bit</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP15" class="function-link"><span class="ACME-function-syntax">exit14</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (top bit is set, i.e. set buffer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">is empty) then branch (return)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y = A = next byte to be removed</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">from speech buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">check if speech chip is ready?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP22" class="function-link"><span class="ACME-function-syntax">osbyte158EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read byte from speech chip</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP15" class="function-link"><span class="ACME-function-syntax">exit14</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">if (top bit set) then branch (exit)</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">read three bytes from the speech buffer: &lt;ROM number&gt; &lt;2 byte address&gt;</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read a byte from CPU's speech buffer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentSpeechPHROMOrROMNumber</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">store ROM number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read another byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">store ROM address</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP23" class="function-link"><span class="ACME-function-syntax">osbyte145EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read another byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">store ROM address</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentSpeechPHROMOrROMNumber</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">Y=ROM / PHROM number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP15" class="function-link"><span class="ACME-function-syntax">writeROMAddressToSpeechProcessor</span></a><span class="ACME-plain-syntax">               </span><span class="ACME-comment-syntax">if (current logical speech PHROM</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">or ROMFS Number is zero) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP15" class="function-link"><span class="ACME-function-syntax">writeCommandAndAddressToSpeechProcessor</span></a><span class="ACME-plain-syntax">        </span><span class="ACME-comment-syntax">if (+ve) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">currentSpeechPHROMOrROMNumber</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">check bit 6 of PHROM or ROM number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVS</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (PHROM or ROM number has bit 6</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">set) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP27" class="function-link"><span class="ACME-function-syntax">writeAddressAndROMNumberToSpeechProcessor</span></a><span class="ACME-plain-syntax">      </span><span class="ACME-comment-syntax">continue for more speech processing</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVC</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP15" class="function-link"><span class="ACME-function-syntax">enableOrDisableSpeech</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">ALWAYS branch</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">double ROM address</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressHigh</span></a><span class="ACME-plain-syntax">                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP19" class="function-link"><span class="ACME-function-syntax">readFromPHROM</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">and call .readFromPHROM</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">enableOrDisableSpeech</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ddb2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">speechSuppressionStatus</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">get speech enable/disable flag</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">whose values equate to speech</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">processor commands:</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">$50 = 'speak'; $20 = 'nop'</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP24" class="function-link"><span class="ACME-function-syntax">osbyte159EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">write to speech processor</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">writeCommandAndAddressToSpeechProcessor</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ddb8</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP24" class="function-link"><span class="ACME-function-syntax">osbyte159EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">write ROM number</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">writeROMAddressToSpeechProcessor</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ddbb</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">get address pointer in Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP24" class="function-link"><span class="ACME-function-syntax">osbyte159EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">write address to speech chip</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">romAddressHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">get address pointer high in Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP24" class="function-link"><span class="ACME-function-syntax">osbyte159EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">write address to speech chip</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">tempStoreFB</span></a><span class="ACME-plain-syntax">                                    </span><span class="ACME-comment-syntax">update loop counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP15" class="function-link"><span class="ACME-function-syntax">feedSpeechChipWithDataLoop</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">loop back</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">exit14</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ddc9</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP16" class="paragraph-anchor"></a><b>&#167;16. IRQ1 Interrupt - 100Hz interrupt. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irq1CheckSystemVIA100HzTimer</span><button class="popup" onclick="togglePopup('usagePopup19')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup19">Usage of <span class="code-font"><span class="ACME-function-syntax">irq1CheckSystemVIA100HzTimer</span></span>:<br/><a href="S-s11.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $ddca</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP17" class="function-link"><span class="ACME-function-syntax">irq1CheckSystemVIAADCEndConversion</span></a><span class="ACME-plain-syntax">             </span><span class="ACME-comment-syntax">bit 6 is in carry. if (there is no</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">bit 6 interrupt) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%01000000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP19" class="function-link"><span class="ACME-function-syntax">systemVIAInterruptFlagRegister</span></a><span class="ACME-plain-syntax">                 </span><span class="ACME-comment-syntax">} clear interrupt 6</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Update the 5 byte clock. There are 2 clock stores, at .timeClockA and .timeClockB. These</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">are updated by adding 1 to the current clock and storing the result in the other, the</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">direction of transfer being changed each time of update.  This ensures that at least</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">1 clock store is valid at any call as the current clock is only read.  Other methods</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">would cause inaccuracies if a clock was read whilst being updated.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">timeClockSwitch</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">get current system clock pointer (5</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">or 10)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">put old system clock pointer in X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$0F</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">invert bits so it toggles between 5</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">and 10</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">remember A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">put new system clock pointer in Y</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">timeClockA</span></a><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">1,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">get current system clock value</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">increment it (carry is set on the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">first iteration of the loop,</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">    thereafter carry is set as</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">needed based on this increment)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">timeClockA</span></a><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">1,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">store result in new copy</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrement X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (finished) then branch (loop ends)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrement Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">and go back and do next byte</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get back new clock pointer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">timeClockSwitch</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">and store back in clock pointer</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Update countdown interval timer. An EVENT is generated when it times out.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #5                                              </span><span class="ACME-comment-syntax">set loop counter</span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">countdownIntervalTimer</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">1</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">increment byte for countdown timer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (done updating timer bytes) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrement loop counter</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not finished looping) do it again</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP5" class="function-link"><span class="ACME-function-syntax">eventIntervalTimerCrossingZero</span></a><span class="ACME-plain-syntax">                </span><span class="ACME-comment-syntax">at this point all the interval timer</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">bytes are zero</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP25" class="function-link"><span class="ACME-function-syntax">eventEntryPoint</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">call EVENT 5 interval timer</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Update INKEY timeout. Used when reading a key within a time limit.</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">inkeyTimeoutCounterLow</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">get low byte of inkey countdown timer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (inkey timer is non-zero) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch forward</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">inkeyTimeoutCounterHigh</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">get high byte of inkey countdown</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">timer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">++</span><span class="ACME-plain-syntax">                                              </span><span class="ACME-comment-syntax">if (inkey timer is zero) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">forward</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">inkeyTimeoutCounterHigh</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">decrement high byte</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">inkeyTimeoutCounterLow</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">and decrement low byte</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Update sound.</span>
<span class="ACME-identifier-syntax">++</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">soundIsUpdatingFlag</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">check bit 7 of sound flag</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(this bit is set while processing</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">sound interrupt. check so we don't</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">try to process a second sound</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupt while still processing</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">the first)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (bit clear; still processing)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch (skip forward)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">soundIsUpdatingFlag</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">increment to 0 (to signify that</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">sound is being processed here)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">allow interrupts briefly</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP6" class="function-link"><span class="ACME-function-syntax">processSoundInterrupt</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">process sound</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">disable interrupts</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">soundIsUpdatingFlag</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">decrement 'sound is updating' flag</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">back to $FF (this signifies that we</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">are done processing the sound)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Update speech.</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">speechBufferEmptyFlag</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">check speech buffer empty flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BMI</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (speech buffer is empty) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (skip speech)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s16.html#SP22" class="function-link"><span class="ACME-function-syntax">osbyte158EntryPoint</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">read speech processor status register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">EOR</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%10100000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">flip two bits</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%01100000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">check</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (result &lt; $60) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP15" class="function-link"><span class="ACME-function-syntax">updateSpeech</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">process speech</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Update ACIA.</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s10.html#SP2" class="function-link"><span class="ACME-function-syntax">allBitsSet</span></a><span class="ACME-plain-syntax">                                     </span><span class="ACME-comment-syntax">set V flag</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP7" class="function-link"><span class="ACME-function-syntax">irq1CheckACIA</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">update ACIA</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Update keyboard.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">lastKeyPressedInternal</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">} check if a key is currently</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ORA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">firstKeyPressedInternal</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">} pressed</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">enableKeyboardInterruptProcessingFlag</span></a><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">ignore key presses if the flag</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">is zero</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (no key pressed or we should</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">ignore keys pressed) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(ignore keyboard)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SEC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">set carry</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s17.html#SP20" class="function-link"><span class="ACME-function-syntax">keyboardInterruptRoutine</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">handle keyboard interrupt</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Update printer.</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP8" class="function-link"><span class="ACME-function-syntax">printerServiceCallIfNotEmpty</span></a><span class="ACME-plain-syntax">                   </span><span class="ACME-comment-syntax">check for data in printer buffer</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Update ADC conversion.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BIT</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP26" class="function-link"><span class="ACME-function-syntax">adcDataStatusRegister</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">check ADC status register</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BVS</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP17" class="function-link"><span class="ACME-function-syntax">handleADCConversionEnds</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">if (bit 6 is set, i.e. ADC not</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">busy) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP17" class="paragraph-anchor"></a><b>&#167;17. IRQ1 Interrupt - Analogue to Digital Conversion (End of Conversion). </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> See .</span><a href="S-s11.html#SP21" class="internal">osbyte17EntryPoint</a>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irq1CheckSystemVIAADCEndConversion</span><button class="popup" onclick="togglePopup('usagePopup20')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup20">Usage of <span class="code-font"><span class="ACME-function-syntax">irq1CheckSystemVIAADCEndConversion</span></span>:<br/><a href="S-s11.html#SP16">&#167;16</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $de47</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">put original bit 4 from</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">.systemVIAInterruptFlagRegister into</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">bit 7 of A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP18" class="function-link"><span class="ACME-function-syntax">irq1CheckSystemVIAKeyboard</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">if (not an ADC conversion interrupt)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">then branch</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">handleADCConversionEnds</span><button class="popup" onclick="togglePopup('usagePopup21')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup21">Usage of <span class="code-font"><span class="ACME-function-syntax">handleADCConversionEnds</span></span>:<br/><a href="S-s11.html#SP16">&#167;16</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $de4a</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">adcCurrentChannel</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">get current ADC channel</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP17" class="function-link"><span class="ACME-function-syntax">clearInterrupt4</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">if (zero) then branch (clear</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">interrupt and exit)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP26" class="function-link"><span class="ACME-function-syntax">adcDataLowByte</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">read low data byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">lowByteLastByteFromADCChannel1</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">1</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">           </span><span class="ACME-comment-syntax">store it in memory</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP26" class="function-link"><span class="ACME-function-syntax">adcDataHighByte</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">get high data byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">highByteLastByteFromADCChannel1</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">1</span><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">          </span><span class="ACME-comment-syntax">and store it in high byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">adcLastChannelRead</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">store last ADC channel read</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP5" class="function-link"><span class="ACME-function-syntax">eventADCConversionComplete</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">handle event 3 conversion complete</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s14.html#SP25" class="function-link"><span class="ACME-function-syntax">eventEntryPoint</span></a><span class="ACME-plain-syntax">                                </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrement X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (X != 0) then branch forward</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">maximumADCChannelNumber</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">get highest ADC channel present</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP21" class="function-link"><span class="ACME-function-syntax">startADCConversion</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">start new conversion</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">clearInterrupt4</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $de6c</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00010000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">reset interrupt 4</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">storeToSystemVIAIFR</span><button class="popup" onclick="togglePopup('usagePopup22')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup22">Usage of <span class="code-font"><span class="ACME-function-syntax">storeToSystemVIAIFR</span></span>:<br/><a href="S-s11.html#SP13">&#167;13</a>, <a href="S-s11.html#SP18">&#167;18</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $de6e</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP19" class="function-link"><span class="ACME-function-syntax">systemVIAInterruptFlagRegister</span></a><span class="ACME-plain-syntax">                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP18" class="paragraph-anchor"></a><b>&#167;18. IRQ1 Interrupt - keyboard. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irq1CheckSystemVIAKeyboard</span><button class="popup" onclick="togglePopup('usagePopup23')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup23">Usage of <span class="code-font"><span class="ACME-function-syntax">irq1CheckSystemVIAKeyboard</span></span>:<br/><a href="S-s11.html#SP17">&#167;17</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $de72</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">get original bit 0 in bit 7 position</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not a keyboard interrupt) then</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">branch (skip keyboard processing)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s17.html#SP20" class="function-link"><span class="ACME-function-syntax">keyboardInterruptRoutine</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">scan keyboard</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00000001</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP17" class="function-link"><span class="ACME-function-syntax">storeToSystemVIAIFR</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">} reset interrupt 0 and return</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP12" class="function-link"><span class="ACME-function-syntax">unrecognisedInterrupt</span></a><span class="ACME-plain-syntax">                          </span>
</pre>
<p class="commentary firstcommentary"><a id="SP19" class="paragraph-anchor"></a><b>&#167;19. restoreRegistersAndReturnFromInterrupt. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">restoreRegistersAndReturnFromInterrupt</span><button class="popup" onclick="togglePopup('usagePopup24')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup24">Usage of <span class="code-font"><span class="ACME-function-syntax">restoreRegistersAndReturnFromInterrupt</span></span>:<br/><a href="S-s11.html#SP6">&#167;6</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $de82</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">restore AXY registers</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">interruptAccumulator</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">store A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP20" class="paragraph-anchor"></a><b>&#167;20. Default IRQ2 handler - does nothing. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">irq2Handler</span><button class="popup" onclick="togglePopup('usagePopup25')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup25">Usage of <span class="code-font"><span class="ACME-function-syntax">irq2Handler</span></span>:<br/>Chapter 10: Resets - <a href="S-s10.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $de89</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">interruptAccumulator</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">get back original value of A</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTI</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">return</span>
</pre>
<p class="commentary firstcommentary"><a id="SP21" class="paragraph-anchor"></a><b>&#167;21. OSBYTE 17 - Start ADC conversions. </b></p>

<p class="center-p"><img src="7002.png" alt="7002.png"></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Analogue to digital conversion is performed by the ADC 7002 chip. It has four channels</span>
<span class="ACME-plain-syntax"> of data that can be read. This is often used to read an analogue joystick. This starts</span>
<span class="ACME-plain-syntax"> the conversion happening. They will keep happening until OSBYTE 16 with X=0 is called.</span>

<span class="ACME-plain-syntax"> OSBYTE 16 selects the range of channels to convert (0-4). See .</span><a href="S-s15.html#SP15" class="internal">osbyte16EntryPoint</a><span class="ACME-plain-syntax">.</span>

<span class="ACME-plain-syntax"> OSBYTE 190 selects the ADC conversion type (8 or 12 bits). See .</span><a href="S-s2.html#SP14" class="internal">adcConversionType</a><span class="ACME-plain-syntax">.</span>
<span class="ACME-plain-syntax"> Twelve bit conversion is the default (which takes about 10ms). Eight bit conversions are</span>
<span class="ACME-plain-syntax"> faster at around 4ms.</span>

<span class="ACME-plain-syntax"> The ADC 7002 generates an interrupt when the conversion is complete, and the IRQ1 handler</span>
<span class="ACME-plain-syntax"> stores the two byte result (in .lowByteLastByteFromADCChannel1 and upwards). It also</span>
<span class="ACME-plain-syntax"> starts the next conversion. See .</span><a href="S-s11.html#SP17" class="internal">irq1CheckSystemVIAADCEndConversion</a><span class="ACME-plain-syntax">.</span>

<span class="ACME-plain-syntax"> OSBYTE 128 reads the latest converted ADC value (X=ADC channel 1-4). See .</span><a href="S-s15.html#SP20" class="internal">osbyte128EntryPoint</a><span class="ACME-plain-syntax">.</span>
<span class="ACME-plain-syntax"> OSBYTE 128 can also read the state of the fire buttons. (X=0). See .</span><a href="S-s15.html#SP20" class="internal">osbyte128EntryPoint</a><span class="ACME-plain-syntax">.</span>
<span class="ACME-plain-syntax"> These are encapsulated in the BASIC ADVAL command.</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       X = ADC channel number (1-4)</span>
<span class="ACME-plain-syntax">       Y = 0</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">osbyte17EntryPoint</span><button class="popup" onclick="togglePopup('usagePopup26')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup26">Usage of <span class="code-font"><span class="ACME-function-syntax">osbyte17EntryPoint</span></span>:<br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP1">&#167;1</a>, <a href="S-s15.html#SP15">&#167;15</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $de8c</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">adcLastChannelRead</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">set last channel to finish</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">conversion (to zero)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">startADCConversion</span><button class="popup" onclick="togglePopup('usagePopup27')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup27">Usage of <span class="code-font"><span class="ACME-function-syntax">startADCConversion</span></span>:<br/><a href="S-s11.html#SP17">&#167;17</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $de8f</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CPX</span><span class="ACME-plain-syntax"> #5                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BCC</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (X &lt; 5) then branch (skip forward)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">X=4 (maximum)</span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">adcCurrentChannel</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">store it as current ADC channel</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">adcConversionType</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">get conversion type</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">decrement</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=Y</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">%00001000</span><span class="ACME-plain-syntax">                                      </span><span class="ACME-comment-syntax">clear to zero except for bit 3 set</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">indicates a 12 bit conversion</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} add the ADC channel (1-4)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">adcCurrentChannel</span></a><span class="ACME-plain-syntax">                              </span><span class="ACME-comment-syntax">} then subtract one, effectively</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">SBC</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">} adding channel (0-3) into bits 0-2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP26" class="function-link"><span class="ACME-function-syntax">adcStartConversionRegister</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">store value to start ADC conversion</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP22" class="paragraph-anchor"></a><b>&#167;22. Display string on screen. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Display the boot message (e.g. 'BBC Computer 32K') and language ROM title (e.g. 'BASIC')</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       Y = offset from page of .vduBaseAddress to start of string -1</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">displayString</span><button class="popup" onclick="togglePopup('usagePopup28')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup28">Usage of <span class="code-font"><span class="ACME-function-syntax">displayString</span></span>:<br/>Chapter 10: Resets - <a href="S-s10.html#SP20">&#167;20</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $dea9</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #&gt;.</span><a href="S-s4.html#SP2" class="function-link"><span class="ACME-function-syntax">vduBaseAddress</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">Start of string area (high byte)</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">displayStringAY</span><button class="popup" onclick="togglePopup('usagePopup29')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup29">Usage of <span class="code-font"><span class="ACME-function-syntax">displayStringAY</span></span>:<br/>Chapter 10: Resets - <a href="S-s10.html#SP30">&#167;30</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $deab</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">displayStringAddressHigh</span></a><span class="ACME-plain-syntax">                       </span><span class="ACME-comment-syntax">store it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">Low byte is zero (we use Y to index</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">to correct string)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">displayStringAddressLow</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">store it and start loop</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">fall through...</span>
</pre>
<p class="commentary firstcommentary"><a id="SP23" class="paragraph-anchor"></a><b>&#167;23. printMessage. </b></p>

<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">printMessage</span><button class="popup" onclick="togglePopup('usagePopup30')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup30">Usage of <span class="code-font"><span class="ACME-function-syntax">printMessage</span></span>:<br/><a href="S-s11.html#SP3">&#167;3</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $deb1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">print character in string</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s2.html#SP11" class="function-link"><span class="ACME-function-syntax">displayStringAddressLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">pointed to by $FD/E</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s24.html#SP6" class="function-link"><span class="ACME-function-syntax">OSASCI</span></a><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">print it expanding Carriage returns</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">store A in X</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s11.html#SP23" class="function-link"><span class="ACME-function-syntax">printMessage</span></a><span class="ACME-plain-syntax">                                   </span><span class="ACME-comment-syntax">and loop again if not zero</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<p class="commentary firstcommentary"><a id="SP24" class="paragraph-anchor"></a><b>&#167;24. osbyte129Timed. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">       X/Y holds the time limit</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">osbyte129Timed</span><button class="popup" onclick="togglePopup('usagePopup31')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup31">Usage of <span class="code-font"><span class="ACME-function-syntax">osbyte129Timed</span></span>:<br/>Chapter 15: OSBYTE and OSWORD - <a href="S-s15.html#SP16">&#167;16</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $debb</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STX</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">inkeyTimeoutCounterLow</span></a><span class="ACME-plain-syntax">                         </span><span class="ACME-comment-syntax">store time in INKEY countdown timer</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s2.html#SP14" class="function-link"><span class="ACME-function-syntax">inkeyTimeoutCounterHigh</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">which is decremented every 10ms</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #255                                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s12.html#SP2" class="function-link"><span class="ACME-function-syntax">readCharacterTimed</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">ALWAYS branch</span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="S-s10.html">&#10094;</a></li><li class="progresssection"><a href="S-s1.html">1</a></li><li class="progresssection"><a href="S-s2.html">2</a></li><li class="progresssection"><a href="S-s3.html">3</a></li><li class="progresssection"><a href="S-s4.html">4</a></li><li class="progresssection"><a href="S-s5.html">5</a></li><li class="progresssection"><a href="S-s6.html">6</a></li><li class="progresssection"><a href="S-s7.html">7</a></li><li class="progresssection"><a href="S-s8.html">8</a></li><li class="progresssection"><a href="S-s9.html">9</a></li><li class="progresssection"><a href="S-s10.html">10</a></li><li class="progresscurrent">11</li><li class="progresssection"><a href="S-s12.html">12</a></li><li class="progresssection"><a href="S-s13.html">13</a></li><li class="progresssection"><a href="S-s14.html">14</a></li><li class="progresssection"><a href="S-s15.html">15</a></li><li class="progresssection"><a href="S-s16.html">16</a></li><li class="progresssection"><a href="S-s17.html">17</a></li><li class="progresssection"><a href="S-s18.html">18</a></li><li class="progresssection"><a href="S-s19.html">19</a></li><li class="progresssection"><a href="S-s20.html">20</a></li><li class="progresssection"><a href="S-s21.html">21</a></li><li class="progresssection"><a href="S-s22.html">22</a></li><li class="progresssection"><a href="S-s23.html">23</a></li><li class="progresssection"><a href="S-s24.html">24</a></li><li class="progresssection"><a href="S-s25.html">25</a></li><li class="progresssection"><a href="S-s26.html">26</a></li><li class="progressnext"><a href="S-s12.html">&#10095;</a></li></ul></div>
</nav><!--End of weave-->

		</main>
	</body>
</html>

